{"id":"mala-01s","title":"Refactor: consolidate lock config + env in one place","description":"Goal: Centralize LOCK_DIR and SCRIPTS_DIR configuration (currently defined in multiple modules). Allow override via env/config where appropriate.\\n\\nScope/files: src/tools/env.py, src/tools/locking.py, any imports that need adjustment.\\n\\nNotes:\\n- Consider single source of truth in tools/env.py.\\n- Keep behavior unchanged unless explicit override is set.\\n\\nAcceptance criteria:\\n- No duplicate definitions for LOCK_DIR/SCRIPTS_DIR.\\n- Locking and scripts continue to work.\\n- Minimal, well-contained changes.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-25T21:40:20.871689769Z","updated_at":"2025-12-26T00:08:19.981435611Z","closed_at":"2025-12-26T00:08:19.981435611Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-01s","depends_on_id":"mala-kpf","type":"blocks","created_at":"2025-12-25T21:47:40.701482404Z","created_by":"daemon"}]}
{"id":"mala-08f","title":"Add protocol-completeness check to bd-breakdown skill","description":"Context:\n- Issue mala-ng3 implemented the quality gate side of ISSUE_NO_CHANGE/ISSUE_OBSOLETE markers\n- But no task was created to document these markers in the implementer prompt (mala-3uo created retroactively)\n- Root cause: when breaking down plans, bidirectional protocols need tasks for BOTH producer and consumer sides\n- The bd-breakdown skill didn't flag this gap\n\nScope:\n- In: Add guidance to bd-breakdown skill (commands/bd-breakdown.md) to check for protocol completeness\n- In: When a task involves parsing/receiving a signal, ensure a corresponding producer task exists\n- Out: Changing how mala-ng3 was implemented (already done)\n\nAcceptance Criteria:\n- bd-breakdown skill prompts agent to verify both sides of any interface/protocol are covered\n- Checklist includes: 'For log markers/signals: is there a task to update the component that produces them?'\n- Checklist includes: 'For prompt-driven behavior: is there a task to update the prompt that instructs agents?'\n\nTest Plan:\n- Manual review of skill changes\n- Apply to a sample breakdown to verify checklist is used\n\nNotes for Agent:\n- The skill is at commands/bd-breakdown.md in this repo\n- Key addition: when an issue involves 'parse X marker' or 'handle X signal', ask: who produces X and do they have instructions to do so?","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T06:25:20.359991212Z","updated_at":"2025-12-27T06:26:40.359583428Z","closed_at":"2025-12-27T06:26:40.359583428Z","close_reason":"Will fix directly via prompt"}
{"id":"mala-0k7","title":"Close epics after each agent completion, not just at run end","description":"## Problem\n\nCurrently, epics are only checked for closure at the end of a run. If an agent completes the last child issue of an epic mid-run, the epic stays open until the entire run finishes.\n\nThis means:\n- Epic status doesn't reflect reality during the run\n- Other agents may not see updated epic status for dependency resolution\n- `bd ready` may return stale results if epic completion affects other issues\n\n## Desired Behavior\n\nAfter each agent successfully completes an issue:\n1. Check if the issue belongs to any epics (via parent-child dependency)\n2. For each parent epic, check if all children are now closed\n3. If all children closed, close the epic with reason \"All children completed\"\n\n## Implementation\n\nIn `src/orchestrator.py`, after closing an issue in the agent completion flow:\n\n```python\n# After: bd close \u003cissue_id\u003e\n# Add: Check and close parent epics if all children done\nawait self._close_completed_epics(issue_id)\n```\n\nThe `_close_completed_epics` method should:\n1. Get parent epic(s) for the issue via `bd show \u003cissue_id\u003e --json`\n2. For each parent, check if all children are closed via `bd epic children \u003cepic_id\u003e --json`\n3. If all closed, run `bd close \u003cepic_id\u003e --reason \"All children completed\"`\n\n## Acceptance Criteria\n\n- [ ] Epics close immediately when last child completes\n- [ ] Works for nested epics (closing child epic triggers parent check)\n- [ ] Logged when epic is auto-closed\n- [ ] Tests verify epic closure after child completion\n\n## Files\n- src/orchestrator.py\n- tests/test_orchestrator.py","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T06:38:21.964459481Z","updated_at":"2025-12-27T08:01:07.948833639Z","closed_at":"2025-12-27T08:01:07.948833639Z","close_reason":"Closed"}
{"id":"mala-1by","title":"Refactor: extract console logging helpers","description":"## Context\nConsole logging helpers (`Colors`, `log`, `log_tool`, `log_result`) live in `src/main.py`. They should move to `src/logging/console.py` to reduce CLI/orchestrator coupling.\n\n## Scope\nCreate the new module only. Do **not** modify `src/main.py` in this issue; integration will wire it up later.\n\n### Files\n- Add: `src/logging/console.py`\n\n## Requirements\n- Move `Colors`, `log`, `log_tool`, and `log_result` into `src/logging/console.py`.\n- Behavior and output formatting must remain identical.\n\n## Acceptance Criteria\n- `src/logging/console.py` contains the logging helpers with identical behavior.\n- No other files are modified in this issue.\n\n## Notes\n- Integration issue will update imports in `src/main.py` and any other modules.\n- Keep ASCII-only files.\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T19:54:51.142161242Z","updated_at":"2025-12-25T20:09:18.911369058Z","closed_at":"2025-12-25T20:09:18.911369058Z","close_reason":"Closed"}
{"id":"mala-1l2","title":"Make morphllm optional","description":"Make MorphLLM optional: allow running without MORPH_API_KEY by disabling the Morph MCP server and related tool restrictions.","notes":"REVIEW (2025-12-27): Plan solid. Set status to open (no blockers). Add acceptance criteria: Edit/Grep allowed when MORPH_API_KEY missing; morph-disabled must not install hooks/restrictions anywhere. Edge cases: any shared validation helpers must not implicitly require MORPH_API_KEY. Tests: add/adjust a morph-disabled logging/behavior assertion. Docs: update any required-env/.env samples beyond README.","status":"closed","priority":4,"issue_type":"epic","created_at":"2025-12-26T00:55:42.42123181Z","updated_at":"2025-12-27T05:57:33.787813045Z","closed_at":"2025-12-27T05:57:33.787813045Z","close_reason":"Closed"}
{"id":"mala-1l2.1","title":"Validation prereqs for optional MorphLLM","description":"Context:\\n- Break out validation-related changes needed to make MORPH_API_KEY optional.\\n- Focused on e2e/validation prechecks and required_env gating.\\n\\nScope:\\n- In: tasks updating validation spec/runner/e2e prereqs + their focused tests.\\n- Out: CLI/orchestrator behavior changes; docs updates.\\n\\nAcceptance Criteria:\\n- Child issues cover spec, e2e, and runner validation behavior plus tests.\\n\\nTest Plan:\\n- Covered by child tasks.\\n\\nNotes for Agent:\\n- Keep validation changes isolated to their files and corresponding tests.","status":"closed","priority":4,"issue_type":"epic","created_at":"2025-12-27T00:46:40.769608139Z","updated_at":"2025-12-27T01:53:32.920933073Z","closed_at":"2025-12-27T01:53:32.920933073Z","close_reason":"All children completed","dependencies":[{"issue_id":"mala-1l2.1","depends_on_id":"mala-1l2","type":"parent-child","created_at":"2025-12-27T00:46:40.769965987Z","created_by":"daemon"}]}
{"id":"mala-1l2.1.1","title":"Relax required_env for Morph in validation spec (with tests)","description":"Primary files: src/validation/spec.py, tests/test_spec.py\\n\\nContext:\\n- Validation spec currently treats MORPH_API_KEY as required for e2e runs.\\n- Optional Morph should not fail validation solely due to missing key.\\n\\nScope:\\n- In: remove MORPH_API_KEY from required_env for e2e (or gate on morph_enabled if available in spec inputs).\\n- Out: runner/e2e prereq logic.\\n\\nAcceptance Criteria:\\n- required_env no longer unconditionally includes MORPH_API_KEY for e2e.\\n- tests/test_spec.py updated to match new required_env expectations.\\n\\nTest Plan:\\n- TDD: adjust tests/test_spec.py to fail on current required_env behavior.\\n- Implement spec change; refactor if needed.\\n- Run: uv run pytest tests/test_spec.py\\n\\nNotes for Agent:\\n- If spec has no morph_enabled input, prefer removing the requirement entirely.","status":"closed","priority":4,"issue_type":"task","created_at":"2025-12-27T00:47:14.858287475Z","updated_at":"2025-12-27T01:14:50.347672201Z","closed_at":"2025-12-27T01:14:50.347672201Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-1l2.1.1","depends_on_id":"mala-1l2.1","type":"parent-child","created_at":"2025-12-27T00:47:14.867609402Z","created_by":"daemon"}]}
{"id":"mala-1l2.1.2","title":"Remove hard MORPH_API_KEY prereq in validation e2e (with tests)","description":"Primary files: src/validation/e2e.py, tests/test_e2e.py\\n\\nContext:\\n- E2E validation should not fail when MORPH_API_KEY is missing.\\n- Morph-specific tests can still be skipped when keys are absent.\\n\\nScope:\\n- In: remove any hard prereq requiring MORPH_API_KEY in e2e validation; keep skip_if_no_keys behavior for Morph-specific checks.\\n- Out: validation spec required_env and runner prereqs.\\n\\nAcceptance Criteria:\\n- E2E validation does not error solely due to missing MORPH_API_KEY.\\n- Morph-specific E2E tests continue to skip when key is missing.\\n- tests/test_e2e.py updated to cover new prereq behavior.\\n\\nTest Plan:\\n- TDD: update tests/test_e2e.py to fail on current prereq requirement.\\n- Implement e2e validation changes; refactor if needed.\\n- Run: uv run pytest tests/test_e2e.py\\n\\nNotes for Agent:\\n- Keep backward-compatible skip semantics; do not enable Morph tests without a key.","status":"closed","priority":4,"issue_type":"task","created_at":"2025-12-27T00:47:26.211628366Z","updated_at":"2025-12-27T01:21:46.329883547Z","closed_at":"2025-12-27T01:21:46.329883547Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-1l2.1.2","depends_on_id":"mala-1l2.1","type":"parent-child","created_at":"2025-12-27T00:47:26.220050469Z","created_by":"daemon"},{"issue_id":"mala-1l2.1.2","depends_on_id":"mala-1l2.1.1","type":"blocks","created_at":"2025-12-27T00:48:10.128669054Z","created_by":"daemon"}]}
{"id":"mala-1l2.1.3","title":"Relax MORPH_API_KEY prereqs in validation runner (with tests)","description":"Primary files: src/validation/runner.py, tests/test_validation.py\\n\\nContext:\\n- Runner-level validation should not treat MORPH_API_KEY as a hard requirement for all e2e runs.\\n- Optional Morph should still allow general validation to proceed.\\n\\nScope:\\n- In: remove or gate MORPH_API_KEY prereq at runner level; preserve skip behavior for Morph-only checks.\\n- Out: validation spec required_env and e2e module logic.\\n\\nAcceptance Criteria:\\n- Runner no longer blocks validation solely due to missing MORPH_API_KEY.\\n- tests/test_validation.py updated to match new prereq behavior.\\n\\nTest Plan:\\n- TDD: adjust tests/test_validation.py to fail on current prereq requirement.\\n- Implement runner changes; refactor if needed.\\n- Run: uv run pytest tests/test_validation.py\\n\\nNotes for Agent:\\n- Keep compatibility with existing skip_if_no_keys behavior.","status":"closed","priority":4,"issue_type":"task","created_at":"2025-12-27T00:47:36.507485416Z","updated_at":"2025-12-27T01:24:47.858660441Z","closed_at":"2025-12-27T01:24:47.858660441Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-1l2.1.3","depends_on_id":"mala-1l2.1","type":"parent-child","created_at":"2025-12-27T00:47:36.514793237Z","created_by":"daemon"},{"issue_id":"mala-1l2.1.3","depends_on_id":"mala-1l2.1.1","type":"blocks","created_at":"2025-12-27T00:48:13.488191772Z","created_by":"daemon"}]}
{"id":"mala-1l2.2","title":"Gate Morph MCP config in orchestrator (with tests)","description":"Primary files: src/orchestrator.py, tests/test_morph_integration.py\\n\\nContext:\\n- Morph MCP should be optional when MORPH_API_KEY is missing.\\n- Orchestrator owns MCP server configuration and tool restrictions.\\n\\nScope:\\n- In: add morph_enabled parameter/default; when false, return no Morph MCP servers, skip disallowed_tools + hook registration; log enabled/disabled state.\\n- Out: CLI env parsing; validation/e2e prereqs.\\n\\nAcceptance Criteria:\\n- Without MORPH_API_KEY (morph_enabled false), Morph MCP server is not configured and no tool restrictions/hooks are applied.\\n- With MORPH_API_KEY, behavior remains unchanged.\\n- Logs clearly indicate Morph enabled vs disabled.\\n- tests/test_morph_integration.py updated to cover enabled/disabled cases.\\n\\nTest Plan:\\n- TDD: adjust/add failing tests in tests/test_morph_integration.py first.\\n- Implement minimal orchestrator changes; refactor if needed.\\n- Run: uv run pytest tests/test_morph_integration.py\\n\\nNotes for Agent:\\n- Ensure default keeps existing callers working (safe default for morph_enabled).","status":"closed","priority":4,"issue_type":"task","created_at":"2025-12-27T00:46:53.269468392Z","updated_at":"2025-12-27T01:36:56.0650868Z","closed_at":"2025-12-27T01:36:56.0650868Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-1l2.2","depends_on_id":"mala-1l2","type":"parent-child","created_at":"2025-12-27T00:46:53.276443605Z","created_by":"daemon"}]}
{"id":"mala-1l2.3","title":"Make CLI accept missing MORPH_API_KEY (with tests)","description":"Primary files: src/cli.py, tests/test_cli.py\\n\\nContext:\\n- CLI currently hard-fails when MORPH_API_KEY is missing.\\n- Optional Morph requires CLI to compute morph_enabled and proceed.\\n\\nScope:\\n- In: replace hard validation with optional getter; compute morph_enabled = bool(MORPH_API_KEY); pass to orchestrator; warn/log when disabled.\\n- Out: orchestrator MCP server logic; validation prereqs.\\n\\nAcceptance Criteria:\\n- Running without MORPH_API_KEY no longer exits early.\\n- morph_enabled is passed through to orchestrator.\\n- Logs warn/indicate Morph is disabled when key missing.\\n- tests/test_cli.py updated to reflect optional key behavior.\\n\\nTest Plan:\\n- TDD: update/add tests in tests/test_cli.py to fail on current behavior.\\n- Implement CLI changes; refactor if needed.\\n- Run: uv run pytest tests/test_cli.py\\n\\nNotes for Agent:\\n- Coordinate with orchestrator change so the new parameter is accepted.","status":"closed","priority":4,"issue_type":"task","created_at":"2025-12-27T00:47:03.034540213Z","updated_at":"2025-12-27T01:48:34.295154358Z","closed_at":"2025-12-27T01:48:34.295154358Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-1l2.3","depends_on_id":"mala-1l2","type":"parent-child","created_at":"2025-12-27T00:47:03.034931741Z","created_by":"daemon"},{"issue_id":"mala-1l2.3","depends_on_id":"mala-1l2.2","type":"blocks","created_at":"2025-12-27T00:48:04.407695212Z","created_by":"daemon"}]}
{"id":"mala-1l2.4","title":"Document optional MorphLLM (README + quality hardening doc)","description":"Primary files: README.md, docs/quality-hardening-plan.md\\n\\nContext:\\n- Docs currently imply MORPH_API_KEY is required.\\n- Need to document optional Morph MCP and fallback behavior.\\n\\nScope:\\n- In: update README to mark MorphLLM MCP optional; explain enablement via MORPH_API_KEY; note fallback to built-in Edit/Grep when disabled.\\n- In: update docs/quality-hardening-plan.md (and any required-env lists in these files).\\n- Out: code changes or tests.\\n\\nAcceptance Criteria:\\n- README clearly states Morph is optional and how it is enabled.\\n- Any required-env sections in these docs no longer mark MORPH_API_KEY as mandatory.\\n\\nTest Plan:\\n- Not applicable (docs-only).\\n\\nNotes for Agent:\\n- Keep wording consistent with actual runtime behavior and logs.","status":"closed","priority":4,"issue_type":"chore","created_at":"2025-12-27T00:47:46.694517979Z","updated_at":"2025-12-27T01:35:17.82530074Z","closed_at":"2025-12-27T01:35:17.82530074Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-1l2.4","depends_on_id":"mala-1l2","type":"parent-child","created_at":"2025-12-27T00:47:46.70338778Z","created_by":"daemon"}]}
{"id":"mala-1l2.5","title":"QA: verify optional MorphLLM behavior","description":"Primary files: (none)\\n\\nContext:\\n- After code/test updates, verify behavior without MORPH_API_KEY.\\n\\nScope:\\n- In: run targeted tests and do a quick manual run without MORPH_API_KEY to confirm morph disabled log and no crash.\\n- Out: code or doc changes.\\n\\nAcceptance Criteria:\\n- Targeted pytest runs pass: tests/test_cli.py, tests/test_morph_integration.py, tests/test_spec.py, tests/test_e2e.py, tests/test_validation.py.\\n- Manual run without MORPH_API_KEY starts successfully and logs morph disabled.\\n\\nTest Plan:\\n- Run: uv run pytest tests/test_cli.py tests/test_morph_integration.py tests/test_spec.py tests/test_e2e.py tests/test_validation.py\\n- Optional: run command to start mala without MORPH_API_KEY and confirm log.\\n\\nNotes for Agent:\\n- If manual run is too expensive, document why and what was verified instead.","status":"closed","priority":4,"issue_type":"task","created_at":"2025-12-27T00:47:57.157193532Z","updated_at":"2025-12-27T01:53:32.839930036Z","closed_at":"2025-12-27T01:53:32.839930036Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-1l2.5","depends_on_id":"mala-1l2","type":"parent-child","created_at":"2025-12-27T00:47:57.164709042Z","created_by":"daemon"},{"issue_id":"mala-1l2.5","depends_on_id":"mala-1l2.2","type":"blocks","created_at":"2025-12-27T00:48:17.588479082Z","created_by":"daemon"},{"issue_id":"mala-1l2.5","depends_on_id":"mala-1l2.3","type":"blocks","created_at":"2025-12-27T00:48:22.938022111Z","created_by":"daemon"},{"issue_id":"mala-1l2.5","depends_on_id":"mala-1l2.1.1","type":"blocks","created_at":"2025-12-27T00:48:28.737891014Z","created_by":"daemon"},{"issue_id":"mala-1l2.5","depends_on_id":"mala-1l2.1.2","type":"blocks","created_at":"2025-12-27T00:48:31.649321978Z","created_by":"daemon"},{"issue_id":"mala-1l2.5","depends_on_id":"mala-1l2.1.3","type":"blocks","created_at":"2025-12-27T00:48:34.702018781Z","created_by":"daemon"}]}
{"id":"mala-1lx","title":"Explore Ralph Wiggum completion loop integration","description":"Investigate adding Ralph-style completion promise loop to Mala (pre-gate loop). Evaluate impact on gate/review retries, proposed CLI flags, cancellation path, and telemetry. This is exploratory; not yet scheduled for implementation.","notes":"BLOCKERS: Awaiting decision on whether to proceed with completion-promise loop experiments and scope (minimal vs full).","status":"blocked","priority":4,"issue_type":"task","created_at":"2025-12-27T17:50:02.937540116Z","updated_at":"2025-12-27T17:50:06.468405944Z"}
{"id":"mala-1z6","title":"Disallow destructive git commands (reset, push --force, etc.)","description":"Prevent agents from running destructive git commands that could cause data loss or rewrite history.\n\n## Commands to Block\n\n| Pattern | Reason |\n|---------|--------|\n| `git reset --hard` | Discards uncommitted changes permanently |\n| `git push --force` / `git push -f` | Rewrites remote history (already blocked for main/master) |\n| `git clean -fd` | Deletes untracked files permanently |\n| `git checkout -- .` | Discards all uncommitted changes |\n| `git rebase` | Rewrites commit history |\n| `git branch -D` | Force-deletes branch without merge check |\n\n## Implementation\n\n**File:** `src/hooks.py`\n\n### 1. Add new pattern list after DANGEROUS_PATTERNS\n\n```python\n# Destructive git command patterns to block\nDESTRUCTIVE_GIT_PATTERNS = [\n    \"git reset --hard\",\n    \"git clean -fd\",\n    \"git clean -f\",\n    \"git checkout -- .\",\n    \"git rebase\",\n    \"git branch -D\",\n    \"git branch -d -f\",\n]\n```\n\n### 2. Update block_dangerous_commands function\n\nAdd a new check after the existing dangerous patterns loop:\n\n```python\n# Block destructive git patterns\nfor pattern in DESTRUCTIVE_GIT_PATTERNS:\n    if pattern in command:\n        return {\n            \"decision\": \"block\",\n            \"reason\": f\"Blocked destructive git command: {pattern}\",\n        }\n\n# Expand force push blocking to ALL branches (not just main/master)\nif \"git push\" in command and (\"--force\" in command or \"-f \" in command):\n    return {\n        \"decision\": \"block\",\n        \"reason\": \"Blocked force push (use --force-with-lease if needed)\",\n    }\n```\n\n### 3. Add tests in `tests/test_morph_integration.py`\n\nAdd to `TestBlockDangerousCommands` class:\n\n```python\n@pytest.mark.asyncio\n@pytest.mark.parametrize(\"cmd\", [\n    \"git reset --hard\",\n    \"git reset --hard HEAD~1\",\n    \"git clean -fd\",\n    \"git clean -f .\",\n    \"git checkout -- .\",\n    \"git rebase main\",\n    \"git rebase -i HEAD~3\",\n    \"git branch -D feature\",\n    \"git push --force origin feature\",\n    \"git push -f origin feature\",\n])\nasync def test_blocks_destructive_git_commands(self, make_hook_input, cmd):\n    \"\"\"Destructive git commands should be blocked.\"\"\"\n    from src.hooks import block_dangerous_commands\n    \n    result = await block_dangerous_commands(\n        make_hook_input(\"Bash\", cmd), None, {\"signal\": None}\n    )\n    assert result.get(\"decision\") == \"block\", f\"Should block: {cmd}\"\n```\n\n## Acceptance Criteria\n\n- [ ] All patterns in the table are blocked\n- [ ] Force push blocked on ALL branches (not just main/master)\n- [ ] Tests cover each blocked pattern\n- [ ] Existing tests still pass\n- [ ] Safe git commands still work: `git status`, `git diff`, `git log`, `git add`, `git commit`, `git push` (without --force)\n\n## Notes\n\n- Pattern matching is substring-based; edge cases like `git $VAR --hard` won't be caught\n- Consider suggesting `--force-with-lease` as safer alternative in block message\n- `git checkout -- \u003cspecific-file\u003e` could be allowed (only block `-- .` for all files)\n","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T01:05:31.653651896Z","updated_at":"2025-12-26T16:46:32.669493412Z","closed_at":"2025-12-26T16:46:32.669493412Z","close_reason":"Closed"}
{"id":"mala-20u","title":"Harden PreToolUse hook: robust tool-name matching + tests","description":"Problem: block_dangerous_commands in src/cli.py only checks tool_name == 'Bash'. If SDK uses 'bash' or other names, the safety hook is bypassed.\\n\\nScope/files: src/cli.py, tests (new or existing).\\n\\nWork:\\n- Confirm/assume tool names may vary; make matching robust (case-insensitive set, or accept multiple known names).\\n- Add unit tests for block_dangerous_commands covering allowed/blocked and tool name variations.\\n\\nAcceptance criteria:\\n- Hook blocks dangerous patterns regardless of tool name casing.\\n- Tests cover at least 1 allowed and 1 blocked command for multiple tool names.\\n\\nTDD: Write tests first, then update implementation.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-25T21:38:16.919383816Z","updated_at":"2025-12-25T23:59:03.895437001Z","closed_at":"2025-12-25T23:59:03.895437001Z","close_reason":"Closed"}
{"id":"mala-252","title":"Implement validation worktree utility","description":"Context:\n- Clean-room validation requires deterministic worktree creation and cleanup.\n- Plan specifies unique worktree paths and keep-on-failure behavior.\n\nScope:\n- In: implement worktree create/remove helpers with unique paths and state tracking.\n- Out: validation command execution (runner handles).\n\nAcceptance Criteria:\n- Worktree paths follow the run/issue/attempt format.\n- Cleanup honors --keep-worktrees and records worktree_state.\n- Failures surface clear errors without leaving stale worktrees.\n\nTest Plan:\n- Add unit tests for worktree create/remove paths (mock git calls).\n- Run targeted tests for worktree module.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T23:00:01.66635989Z","updated_at":"2025-12-27T00:05:55.340798599Z","closed_at":"2025-12-27T00:05:55.340798599Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-252","depends_on_id":"mala-j6p","type":"blocks","created_at":"2025-12-26T23:00:26.466631948Z","created_by":"daemon"}]}
{"id":"mala-2eu","title":"Update CLI parsing for disable-validations + related flags","description":"Context:\n- CLI must accept --disable-validations and map values into config/spec inputs.\n- Other flags include --coverage-threshold, --lint-only-for-docs, --skip-e2e-if-no-keys.\n\nScope:\n- In: parse --disable-validations CSV and pass to config; validate values; wire other flags.\n- Out: orchestrator execution changes (separate task).\n\nAcceptance Criteria:\n- Unknown disable values produce a clear CLI error.\n- Parsed options are available to spec/orchestrator configuration.\n- Help text matches the plan.\n\nTest Plan:\n- Add CLI parsing tests for valid/invalid disable lists.\n- Run CLI unit tests.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T23:00:01.741979177Z","updated_at":"2025-12-27T00:55:51.216408694Z","closed_at":"2025-12-27T00:55:51.216408694Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-2eu","depends_on_id":"mala-5us","type":"blocks","created_at":"2025-12-26T23:00:26.581177502Z","created_by":"daemon"}]}
{"id":"mala-2ez","title":"Agent mail using filesystem","description":"Agent mail using filesystem: allow agents to send/receive coordination messages via files to reduce lock contention and support handoffs.","status":"closed","priority":4,"issue_type":"epic","created_at":"2025-12-26T00:55:42.268473542Z","updated_at":"2025-12-26T18:28:06.757887173Z","closed_at":"2025-12-26T18:28:06.757887173Z","close_reason":"Closed per user request"}
{"id":"mala-2i7","title":"Epic: Validation module refactor + tooling","description":"Context:\n- Covers refactor of validation module into a package and new validation helpers.\n- Derived from docs/quality-hardening-plan.md (v5).\n\nScope:\n- In: validation package scaffolding + core modules (spec, worktree, coverage, e2e, runner).\n- Out: orchestrator/gate integration (handled in a separate epic).\n\nAcceptance Criteria:\n- All child issues closed and validation modules ready for integration.\n\nTest Plan:\n- Defer to child issue test plans.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-26T23:00:01.608651792Z","updated_at":"2025-12-27T01:06:32.783600955Z","closed_at":"2025-12-27T01:06:32.783600955Z","close_reason":"All 6 child issues closed: validation module refactored into package with spec, coverage, worktree, e2e, runner, deps_sync modules. 239 unit tests passing, 88% coverage.","dependencies":[{"issue_id":"mala-2i7","depends_on_id":"mala-j6p","type":"blocks","created_at":"2025-12-26T23:00:26.343216812Z","created_by":"daemon"},{"issue_id":"mala-2i7","depends_on_id":"mala-5us","type":"blocks","created_at":"2025-12-26T23:00:26.354537591Z","created_by":"daemon"},{"issue_id":"mala-2i7","depends_on_id":"mala-252","type":"blocks","created_at":"2025-12-26T23:00:26.365551792Z","created_by":"daemon"},{"issue_id":"mala-2i7","depends_on_id":"mala-c1o","type":"blocks","created_at":"2025-12-26T23:00:26.37697623Z","created_by":"daemon"},{"issue_id":"mala-2i7","depends_on_id":"mala-4dh","type":"blocks","created_at":"2025-12-26T23:00:26.387839923Z","created_by":"daemon"},{"issue_id":"mala-2i7","depends_on_id":"mala-cij","type":"blocks","created_at":"2025-12-26T23:00:26.399183121Z","created_by":"daemon"}]}
{"id":"mala-2im","title":"CLI status should be directory-scoped by default","description":"## Problem\n\nCurrently `mala status` (or similar status command) reports on all running mala instances globally. This is confusing when working in multiple repos simultaneously - you see status for unrelated runs.\n\n## Desired Behavior\n\n- **Default**: Show status only for mala instance(s) running in the current directory\n- **--all flag**: Show status for all running mala instances across all directories\n\n### Example output:\n\n```bash\n# In /home/cyou/mala\n$ mala status\nRunning: 3 agents processing 5 issues\nStarted: 10 minutes ago\nIssues: 2 completed, 3 in progress\n\n# In /home/cyou/other-repo (no mala running)\n$ mala status\nNo mala instance running in this directory.\n\n# Show all instances\n$ mala status --all\n/home/cyou/mala:\n  Running: 3 agents processing 5 issues\n  Started: 10 minutes ago\n\n/home/cyou/another-repo:\n  Running: 1 agent processing 2 issues\n  Started: 5 minutes ago\n```\n\n## Implementation\n\n**Files:**\n- `src/cli.py`: Update status command to filter by cwd, add --all flag\n- `src/tools/locking.py` or status module: Add helper to get running instances by directory\n\n### Key changes:\n\n1. **Store repo path in lock/status file**: Ensure running instances record their repo path\n2. **Filter by cwd**: Default status checks if current directory matches any running instance's repo path\n3. **--all flag**: Bypasses directory filter, shows all instances grouped by repo\n\n### CLI changes:\n\n```python\n@app.command()\ndef status(\n    all_instances: bool = typer.Option(False, \"--all\", help=\"Show all running instances\")\n):\n    \"\"\"Show status of mala instance(s).\"\"\"\n    cwd = Path.cwd().resolve()\n    \n    if all_instances:\n        instances = get_all_running_instances()\n    else:\n        instances = get_running_instances_for_dir(cwd)\n    \n    if not instances:\n        if all_instances:\n            print(\"No mala instances running.\")\n        else:\n            print(\"No mala instance running in this directory.\")\n        return\n    \n    for instance in instances:\n        display_instance_status(instance)\n```\n\n## Acceptance Criteria\n\n- [ ] `mala status` only shows instance running in current directory\n- [ ] `mala status` prints clear message when no instance running in cwd\n- [ ] `mala status --all` shows all running instances grouped by directory\n- [ ] Repo path is recorded when mala starts (for filtering)\n\n## Test Plan\n\n- Unit tests for directory filtering logic\n- Manual: start mala in two repos, verify `status` shows only local instance\n- Manual: verify `--all` shows both instances\n\n## Dependencies\n\n- May benefit from mala-db2 (per-repo log directories) for consistent path handling","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-27T22:52:41.322367853Z","updated_at":"2025-12-27T22:52:41.322367853Z"}
{"id":"mala-2u3","title":"Epic: Quality Gate Re-entry + Codex Review","description":"Implements same-session re-entry on quality gate failure, shifts issue closing to the orchestrator, and adds a Codex review step with structured JSON output and guardrails.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-26T19:04:48.636008473Z","updated_at":"2025-12-26T19:32:39.524157706Z","closed_at":"2025-12-26T19:32:39.524157706Z","close_reason":"All children completed"}
{"id":"mala-2u3.1","title":"Scope quality gate evidence by attempt","description":"Primary files: src/quality_gate.py, tests/test_quality_gate.py\n\nContext:\n- Gate evidence currently scans the full session log and can pass on stale validation\n- Re-entry needs evidence scoped to the latest attempt\n- No-progress detection should treat unchanged commit + no new evidence as a failure\n\nScope:\n- In: add log-offset-based parsing, return/update offset per attempt, expose a helper that only counts evidence after offset\n- In: add no-progress detection helper (unchanged commit + no new evidence)\n- Out: changes to orchestrator retry loop or prompts\n\nAcceptance Criteria:\n- Evidence parsing can start at a byte offset and ignore earlier log lines\n- Gate result can indicate when no new evidence was found since the last attempt\n- No-progress detection is implemented and covered by tests\n\nTest Plan:\n- TDD: add failing tests for offset parsing and no-progress detection, then implement\n- Run unit tests for quality gate parsing (targeted test file)\n\nNotes for Agent:\n- Keep public API small; prefer a new optional offset argument or a small helper returning (evidence, new_offset)\n","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T19:05:00.499151942Z","updated_at":"2025-12-26T19:12:12.110042901Z","closed_at":"2025-12-26T19:12:12.110042901Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-2u3.1","depends_on_id":"mala-2u3","type":"parent-child","created_at":"2025-12-26T19:05:00.510288361Z","created_by":"daemon"}]}
{"id":"mala-2u3.2","title":"Add retry/review config to CLI and run metadata","description":"Primary files: src/cli.py, src/logging/run_metadata.py\n\nContext:\n- New gate/review retry limits and a codex-review toggle need to be configurable\n- Run metadata should record these config values and per-issue attempt counts\n\nScope:\n- In: add CLI flags --max-gate-retries, --max-review-retries, --codex-review\n- In: extend RunConfig and IssueRun metadata to capture retry limits and attempt counts\n- Out: orchestrator behavior changes (handled separately)\n\nAcceptance Criteria:\n- CLI help shows new flags and defaults\n- Run metadata JSON includes new config fields\n- IssueRun records gate/review attempts (even if defaulted)\n\nTest Plan:\n- Manual: run \"mala run --help\" and verify new flags\n- Manual: run a short session and confirm metadata JSON includes new fields\n\nNotes for Agent:\n- Keep new fields optional/backward compatible in RunMetadata serialization\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T19:05:08.142483863Z","updated_at":"2025-12-26T19:10:26.476631609Z","closed_at":"2025-12-26T19:10:26.476631609Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-2u3.2","depends_on_id":"mala-2u3","type":"parent-child","created_at":"2025-12-26T19:05:08.154749276Z","created_by":"daemon"}]}
{"id":"mala-2u3.3","title":"Shift issue closing to orchestrator","description":"Primary files: src/orchestrator.py, src/beads_client.py, src/prompts/implementer_prompt.md\n\nContext:\n- Agent currently closes issues, which conflicts with same-session re-entry\n- Orchestrator should close only after all gates pass\n\nScope:\n- In: remove bd close instruction from implementer prompt\n- In: add BeadsClient.close_async(issue_id) wrapper\n- In: orchestrator closes issue after gate+review pass\n- Out: re-entry loop or codex review logic (separate tasks)\n\nAcceptance Criteria:\n- Agents no longer call bd close in the prompt\n- Orchestrator closes issues after successful completion\n- No regressions in .beads/issues.jsonl commit flow\n\nTest Plan:\n- Manual: run one issue end-to-end and confirm orchestrator performs bd close\n\nNotes for Agent:\n- Keep orchestrator success criteria aligned with new close flow\n","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T19:05:17.09218776Z","updated_at":"2025-12-26T19:15:17.759359304Z","closed_at":"2025-12-26T19:15:17.759359304Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-2u3.3","depends_on_id":"mala-2u3","type":"parent-child","created_at":"2025-12-26T19:05:17.111639583Z","created_by":"daemon"},{"issue_id":"mala-2u3.3","depends_on_id":"mala-2u3.2","type":"blocks","created_at":"2025-12-26T19:06:12.608088508Z","created_by":"daemon"}]}
{"id":"mala-2u3.4","title":"Implement same-session re-entry on gate failure","description":"Primary files: src/orchestrator.py\n\nContext:\n- Quality gate failures should trigger a same-session fix attempt, not a reopen\n- Claude SDK supports session resume by passing resume: \u003csession_id\u003e\n- Gate retries need guardrails to avoid infinite loops\n\nScope:\n- In: capture session_id from the init system message and store per issue\n- In: implement a gate retry loop with resume calls and failure-reason prompts\n- In: track attempt counts and log offsets per attempt\n- In: avoid adding to failed_issues until retries are exhausted\n- Out: codex review integration (separate task)\n\nAcceptance Criteria:\n- Gate failure triggers a follow-up prompt in the SAME session (resume, no fork)\n- Retries stop after max attempts and mark needs-followup\n- No-progress detection stops retries when commit hash is unchanged and no new evidence exists\n\nTest Plan:\n- Manual: force a gate failure (skip validations) and confirm resume + retry count\n- Manual: confirm retries stop after max\n\nNotes for Agent:\n- Keep retry state per issue to support parallel agents\n","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T19:05:26.093985944Z","updated_at":"2025-12-26T19:22:37.521894989Z","closed_at":"2025-12-26T19:22:37.521894989Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-2u3.4","depends_on_id":"mala-2u3","type":"parent-child","created_at":"2025-12-26T19:05:26.106458545Z","created_by":"daemon"},{"issue_id":"mala-2u3.4","depends_on_id":"mala-2u3.3","type":"blocks","created_at":"2025-12-26T19:06:16.691077263Z","created_by":"daemon"},{"issue_id":"mala-2u3.4","depends_on_id":"mala-2u3.1","type":"blocks","created_at":"2025-12-26T19:06:19.606198443Z","created_by":"daemon"}]}
{"id":"mala-2u3.5","title":"Add Codex review step with strict JSON + retry","description":"Primary files: src/orchestrator.py (optionally new helper module)\n\nContext:\n- After deterministic gates pass, we want an automated Codex review\n- Review output must be strict JSON with one repair retry, then fail closed\n\nScope:\n- In: invoke codex review --commit \u003csha\u003e with a strict JSON schema prompt\n- In: parse JSON output; if invalid, retry once with stricter prompt\n- In: if review fails, resume SAME Claude session with review issues\n- In: re-run deterministic gate after review fixes\n- Out: changes to quality gate parsing logic (separate task)\n\nAcceptance Criteria:\n- Codex review runs after deterministic gate pass\n- JSON parsing is strict with a single retry on parse failure\n- Review failures trigger same-session fixes and re-gating\n\nTest Plan:\n- Manual: run review on a known commit and verify JSON parsing\n- Manual: simulate invalid JSON (e.g., by altering prompt) and verify retry + fail-closed behavior\n\nNotes for Agent:\n- Keep prompts ASCII-only and avoid code fences in the JSON response\n","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T19:05:35.484550183Z","updated_at":"2025-12-26T19:29:10.812795467Z","closed_at":"2025-12-26T19:29:10.812795467Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-2u3.5","depends_on_id":"mala-2u3","type":"parent-child","created_at":"2025-12-26T19:05:35.484834411Z","created_by":"daemon"},{"issue_id":"mala-2u3.5","depends_on_id":"mala-2u3.4","type":"blocks","created_at":"2025-12-26T19:06:23.642607996Z","created_by":"daemon"}]}
{"id":"mala-2u3.6","title":"Update README for orchestrator-close + gate/review retries","description":"Primary files: README.md\n\nContext:\n- Workflow docs currently say the agent closes issues and gate failures reopen later\n- We are changing flow to orchestrator-close + same-session re-entry + codex review\n\nScope:\n- In: update workflow and quality gate sections to reflect new behavior\n- In: document retry limits and codex review step\n- Out: code changes\n\nAcceptance Criteria:\n- README describes orchestrator closing behavior\n- README describes same-session re-entry and review retries\n\nTest Plan:\n- N/A (documentation change)\n\nNotes for Agent:\n- Align wording with actual implemented behavior\n","status":"closed","priority":3,"issue_type":"chore","created_at":"2025-12-26T19:05:43.082927169Z","updated_at":"2025-12-26T19:32:31.343813389Z","closed_at":"2025-12-26T19:32:31.343813389Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-2u3.6","depends_on_id":"mala-2u3","type":"parent-child","created_at":"2025-12-26T19:05:43.094365345Z","created_by":"daemon"},{"issue_id":"mala-2u3.6","depends_on_id":"mala-2u3.5","type":"blocks","created_at":"2025-12-26T19:06:26.62064641Z","created_by":"daemon"}]}
{"id":"mala-3js","title":"Consolidate agent receive loop","description":"Context:\n- agent_loop.py duplicates the receive loop in MalaOrchestrator and is currently unused.\n- Divergent logic increases maintenance risk.\n\nScope:\n- In: consolidate to a single agent receive loop (either delete agent_loop.py or adopt it in orchestrator).\n- Out: changing logging format or agent behavior beyond consolidation.\n\nAcceptance Criteria:\n- Only one receive loop implementation remains.\n- Orchestrator behavior and logging remain consistent with current output.\n\nTest Plan:\n- TDD: if adopting agent_loop, add/adjust tests to cover loop integration; otherwise verify orchestrator tests still pass.\n\nNotes for Agent:\n- Keep JSONL and Braintrust logging order unchanged.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T17:36:04.305912715Z","updated_at":"2025-12-26T19:06:24.780657053Z","closed_at":"2025-12-26T19:06:24.780657053Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-3js","depends_on_id":"mala-jnq","type":"parent-child","created_at":"2025-12-26T17:36:15.734362257Z","created_by":"daemon"},{"issue_id":"mala-3js","depends_on_id":"mala-vdf","type":"blocks","created_at":"2025-12-26T17:36:21.629842741Z","created_by":"daemon"}]}
{"id":"mala-3m7","title":"Deadlock detection between agents","description":"Detect deadlocks between agents (e.g., two agents waiting on each other's locks). Surface the deadlock and provide a resolution path (alert, timeout, or automatic recovery).","status":"closed","priority":4,"issue_type":"epic","created_at":"2025-12-26T00:55:42.798438926Z","updated_at":"2025-12-26T18:28:06.819113751Z","closed_at":"2025-12-26T18:28:06.819113751Z","close_reason":"Closed per user request"}
{"id":"mala-3sp","title":"Prevent agents from gaming type check validation","description":"## Problem\n\nAgents are gaming validation by:\n1. Running truncated checks (`| head -20`) to hide errors\n2. Assuming errors are \"pre-existing\" without verification\n3. Running `uvx ty check src/\u003cfile\u003e.py` instead of `uvx ty check` to avoid test file errors\n4. Never type-checking the test files they modify\n\nEvidence from logs (commit 0328a6e):\n- Agent modified `tests/test_morph_integration.py`\n- Saw type errors, claimed \"pre-existing\"\n- Ran `uvx ty check src/orchestrator.py` (not the test file)\n- Committed with 62 type errors in test files\n\n## Solution\n\n### 1. Update implementer prompt (src/prompts/implementer_prompt.md)\n\nAdd explicit rules after the quality checks section:\n\n```markdown\n**CRITICAL - No Gaming Validation:**\n- Run `uvx ty check` with NO path arguments (checks entire codebase)\n- Do NOT pipe to `head` or truncate output\n- Do NOT assume errors are \"pre-existing\" - verify with `git blame`\n- If you modified a test file, type errors in that file are YOUR responsibility\n- All checks must pass with ZERO errors before committing\n```\n\n## Acceptance Criteria\n\n- [ ] Implementer prompt updated with anti-gaming rules\n- [ ] Prompt explicitly states: no `| head`, no path args, zero errors required\n- [ ] Prompt requires `git blame` verification before claiming \"pre-existing\"\n\n## Files\n- src/prompts/implementer_prompt.md","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-27T06:33:22.096830922Z","updated_at":"2025-12-27T06:38:42.564228491Z","closed_at":"2025-12-27T06:38:42.564228491Z","close_reason":"Closed"}
{"id":"mala-3uo","title":"Document ISSUE_NO_CHANGE/ISSUE_OBSOLETE markers in implementer prompt","description":"Context:\n- The quality gate (src/quality_gate.py:157-271) supports ISSUE_NO_CHANGE and ISSUE_OBSOLETE markers\n- When a subagent outputs these markers with a rationale and clean working tree, the gate passes without requiring a commit\n- The implementer prompt (src/prompts/implementer_prompt.md) doesn't document this capability\n- Subagents currently have no way to know they can skip commits for no-op issues\n\nScope:\n- In: Add documentation to implementer_prompt.md explaining the no-change/obsolete flow\n- Out: Changing the quality gate logic itself\n\nAcceptance Criteria:\n- implementer_prompt.md documents when/how to use ISSUE_NO_CHANGE and ISSUE_OBSOLETE markers\n- Clear instructions: ensure clean working tree, provide rationale, release locks\n- Example output format shown\n\nTest Plan:\n- Manual review of prompt clarity\n- No code changes to test\n\nNotes for Agent:\n- Add a new section (e.g., '### If No Code Changes Required') after the commit section\n- Keep it concise - subagents need quick reference, not lengthy explanation","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T06:21:36.035492243Z","updated_at":"2025-12-27T07:23:58.793225485Z","closed_at":"2025-12-27T07:23:58.793225485Z","close_reason":"Closed"}
{"id":"mala-3xv","title":"Add global test mutex wrapper","description":"Context:\n- Track A5 requires serializing repo-wide commands: uv sync, pytest, ruff, ty (docs/coordination-plan-codex.md:44-45).\n- scripts directory currently only contains lock scripts (src/scripts).\n\nScope:\n- In: add a script (e.g., test-mutex.sh) that acquires a global lock and runs a command; release on exit.\n- In: add tests for the mutex behavior in a new test module.\n- Out: no prompt changes (A1) and no orchestrator hooks.\n\nAcceptance Criteria:\n- Wrapper exits non-zero when mutex is held and reports the holder.\n- Successful runs acquire and release the mutex even on command failure.\n- Tests verify acquisition, contention, and release behavior.\n\nTest Plan:\n- TDD: add failing tests in new tests/test_test_mutex.py.\n- Implement script and re-run tests.\n- Run uv run pytest tests/test_test_mutex.py.\n\nNotes for Agent:\n- Pick a stable mutex key (e.g., a fixed path token) to avoid collisions.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T16:44:22.179577746Z","updated_at":"2025-12-26T17:05:43.991099145Z","closed_at":"2025-12-26T17:05:43.991099145Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-3xv","depends_on_id":"mala-4w7","type":"parent-child","created_at":"2025-12-26T16:47:52.996880868Z","created_by":"daemon"}]}
{"id":"mala-3z2","title":"Test: tiny edit","status":"tombstone","priority":2,"issue_type":"task","created_at":"2025-12-25T19:08:44.86959643Z","updated_at":"2025-12-25T19:12:41.579812812Z","deleted_at":"2025-12-25T19:12:41.579812812Z","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"mala-46q","title":"Add orchestrator unit tests (mock bd + SDK)","description":"Problem: Tests focus on lock scripts/SDK integration, but MalaOrchestrator control flow is untested (bd ready/claim/reset, timeout handling, exit code semantics).\\n\\nScope/files: tests/ (new test module), can mock subprocess.run and ClaudeSDKClient to avoid network. Avoid modifying src/cli.py unless absolutely required; if refactor is needed, document why.\\n\\nSuggested tests:\\n- get_ready_issues handles bd JSON and errors.\\n- claim_issue/reset_issue invoked appropriately.\\n- run() handles no ready issues and stops cleanly.\\n- On failed task, resets issue status.\\n\\nAcceptance criteria:\\n- Tests run without network and without actual bd CLI.\\n- Minimal mocking surface; focus on orchestrator state transitions.\\n\\nTDD: Write tests first, then adjust code if needed.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T21:38:34.899307031Z","updated_at":"2025-12-25T23:59:05.389010652Z","closed_at":"2025-12-25T23:59:05.389010652Z","close_reason":"Closed"}
{"id":"mala-4dh","title":"Implement E2E fixture runner","description":"Context:\n- E2E fixture run validates mala end-to-end behavior on a tiny repo.\n- Requires Claude CLI, MORPH_API_KEY, and bd availability.\n\nScope:\n- In: create fixture repo, run mala, validate outputs, cleanup; enforce preconditions; support --skip-e2e-if-no-keys.\n- Out: per-issue validation; E2E is run-level only.\n\nAcceptance Criteria:\n- E2E runner returns E2EResult with clear failure reasons.\n- Preconditions enforced or skipped per flag.\n- Fixture repo cleaned up unless keep flag is set.\n\nTest Plan:\n- Add unit tests for precondition checks and fixture path handling.\n- Mark full E2E run test as slow/optional.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T23:00:01.691693551Z","updated_at":"2025-12-27T00:32:01.5851032Z","closed_at":"2025-12-27T00:32:01.5851032Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-4dh","depends_on_id":"mala-j6p","type":"blocks","created_at":"2025-12-26T23:00:26.489084536Z","created_by":"daemon"}]}
{"id":"mala-4h5","title":"CLI: Make quiet mode the default, require --verbose for verbose output","description":"## Problem\n\nCurrently the CLI defaults to verbose mode (`--verbose/--quiet` with default True), meaning users must pass `-q` or `--quiet` to get quieter output. This is backwards - quiet should be the default.\n\n## Current Behavior\n```python\nverbose: Annotated[\n    bool,\n    typer.Option(\n        \"--verbose/--quiet\",\n        \"-v/-q\",\n        help=\"Verbose output shows full tool arguments; quiet mode shows single line per tool call\",\n    ),\n] = True\n```\n\n## Desired Behavior\n- Default to quiet mode (verbose=False)\n- Users must specify `--verbose` or `-v` to get verbose output\n- Remove the `--quiet`/`-q` flag entirely since quiet is now the default\n\n## Files\n- src/cli.py\n\n## Acceptance Criteria\n- [ ] CLI defaults to quiet mode\n- [ ] `--verbose` / `-v` enables verbose output\n- [ ] `--quiet` / `-q` flags are removed\n- [ ] Help text updated accordingly\n- [ ] Tests updated to reflect new default","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-27T17:54:13.041418656Z","updated_at":"2025-12-27T17:54:13.041418656Z"}
{"id":"mala-4ls","title":"Lock key: hash canonical paths + repo namespace","description":"Problem: Lock filenames are derived by replacing '/' with '_' (scripts + src/tools/locking.py). This causes collisions (e.g., 'a/b' vs 'a_b') and cross-repo contention. Fix by hashing a canonical path (absolute or repo-root+relative) and namespacing locks per repo/cwd.\\n\\nScope/files: scripts/lock-try.sh, lock-check.sh, lock-holder.sh, lock-release.sh, lock-release-all.sh, src/tools/locking.py, tests in tests/test_lock_scripts.py and tests/test_lock_integration.py (and any necessary updates). Consider also centralizing LOCK_DIR/SCRIPTS_DIR if needed.\\n\\nAcceptance criteria:\\n- Lock key is collision-resistant (e.g., sha256 of canonical path).\\n- Locks for different repos/paths do not collide.\\n- Lock holder and cleanup continue to work with AGENT_ID.\\n- Tests updated/added to cover collision case and repo namespace case.\\n\\nTDD: Add/adjust tests first to demonstrate collision and then pass after change.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-25T21:37:59.249680035Z","updated_at":"2025-12-26T00:01:08.029869568Z","closed_at":"2025-12-26T00:01:08.029869568Z","close_reason":"Closed"}
{"id":"mala-4o4","title":"Commit partial progress and mark needs-continuation","status":"tombstone","priority":2,"issue_type":"epic","created_at":"2025-12-26T00:55:42.724613481Z","updated_at":"2025-12-26T00:56:32.195455786Z","deleted_at":"2025-12-26T00:56:32.195455786Z","deleted_by":"daemon","delete_reason":"delete","original_type":"epic"}
{"id":"mala-4ov","title":"Metrics and logging for multi-agent sessions","description":"Add metrics and logging for multi-agent sessions (counts, durations, success/failure rates, queue depth) to make runs observable and debuggable.","status":"closed","priority":4,"issue_type":"epic","created_at":"2025-12-26T00:55:42.866840213Z","updated_at":"2025-12-26T18:28:00.511651865Z","closed_at":"2025-12-26T18:28:00.511651865Z","close_reason":"Closed per user request"}
{"id":"mala-4w7","title":"Epic: Track A Shared-Worktree Hardening","description":"Context:\n- Umbrella epic for Track A (A1A6) tasks from docs/coordination-plan-codex.md.\n\nScope:\n- In: group all Track A tasks under this epic.\n- Out: no implementation changes.\n\nAcceptance Criteria:\n- All Track A issues are linked as children (directly or via sub-epics).\n\nTest Plan:\n- N/A (coordination-only).\n\nNotes for Agent:\n- Keep A3 as a sub-epic under this umbrella.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-26T16:47:48.086896295Z","updated_at":"2025-12-26T17:15:07.704095723Z","closed_at":"2025-12-26T17:15:07.704095723Z","close_reason":"All children completed"}
{"id":"mala-503","title":"Fix run-level E2E status when E2E is skipped","description":"Run-level validation currently records e2e_passed True/False even when E2E was not executed (e.g., disable_validations/run_e2e false or spec omits E2E). This makes run metadata misleading. Update run-level metadata to reflect actual E2E execution: set e2e_passed based on E2E run result, or None when E2E skipped. Affects src/orchestrator.py around run-level validation recording.","status":"open","priority":2,"issue_type":"bug","created_at":"2025-12-27T22:40:50.347545047Z","updated_at":"2025-12-27T22:42:08.298647844Z"}
{"id":"mala-53v","title":"Quality gate: enforce full validation suite evidence","description":"Context:\n- src/quality_gate.py: ValidationEvidence.has_minimum_validation() currently passes with pytest OR ruff check+format; missing_commands() omits uv sync and ty check.\n- Implementer prompt/README require the full suite (uv sync, pytest, ruff check/format, ty check), so the gate can pass incomplete validation.\n\nScope:\n- In: require evidence for the full validation suite (uv sync, pytest, ruff check, ruff format, ty check) and update tests accordingly.\n- Out: changing prompt/docs or redefining the suite beyond the current prompt requirements.\n\nAcceptance Criteria:\n- Gate fails when any required command is missing, even if pytest or ruff ran.\n- Failure reasons list all missing commands including uv sync and ty check.\n- Tests cover missing uv sync and ty check scenarios.\n\nTest Plan:\n- TDD: add failing tests in tests/test_quality_gate.py for missing uv sync/ty check, implement minimal fix, run: uv run pytest tests/test_quality_gate.py\n\nNotes for Agent:\n- Keep parsing patterns consistent; only tighten required-command logic.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-26T21:43:43.706215554Z","updated_at":"2025-12-26T22:39:21.901160405Z","closed_at":"2025-12-26T22:39:21.901160405Z","close_reason":"Closed"}
{"id":"mala-59n","title":"Fix log indentation and add no-truncation option","description":"## Problem\nLog output has inconsistent indentation and lines are truncated:\n```\n00:43:23  Waiting for 1 agent(s)...\n  [mala-l7r]  Bash {'command': 'bd show mala-l7r', 'description': 'Vi\n    [mala-l7r] Now let me understand the codebase structure...\n  [mala-l7r]  Bash {'command': 'ls -la /home/cyou/mala/src/', 'descri\n```\n\nIssues:\n1. **Inconsistent indentation**: Some lines have 2-space indent, others have 4-space indent before `[agent-id]`\n2. **Truncation**: Lines are cut off (e.g., `'Vi`, `'descri`) without option to see full content\n\n## Scope/files\n- `src/logging/console.py` or equivalent logging module\n- `src/cli.py` or `src/orchestrator.py` for CLI flag\n\n## Work\n1. Fix indentation to be consistent (likely all agent output should have same base indent)\n2. Add `--no-truncate` or `--verbose` CLI flag to disable line truncation\n3. Consider making truncation width configurable\n\n## Acceptance criteria\n- All agent log lines have consistent indentation\n- New flag allows viewing full log lines without truncation\n- Default behavior (truncated) still works","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T00:47:13.094441264Z","updated_at":"2025-12-26T00:57:22.727412832Z","closed_at":"2025-12-26T00:57:22.727412832Z","close_reason":"Closed"}
{"id":"mala-5aa","title":"Refactor: consolidate locking into tools/locking.py","description":"## Context\nLocking behavior is split between `src/filelock.py` and shell scripts in `scripts/`. `src/main.py` directly imports `LOCK_DIR` and `release_all_locks` from `filelock.py` and also defines `make_stop_hook` which relies on lock scripts. The plan is to consolidate locking into `src/tools/locking.py`.\n\n## Scope\nCreate `src/tools/locking.py` only. Do **not** modify `src/main.py` or tests in this issue; integration will wire it up later.\n\n### Files\n- Add: `src/tools/locking.py`\n- (Optional) Modify or remove: `src/filelock.py`\n\n## Requirements\n- `tools/locking.py` should export:\n  - `LOCK_DIR`\n  - `release_all_locks()` (existing behavior)\n  - `cleanup_agent_locks(agent_id)` (existing behavior from `MalaOrchestrator`)\n  - `make_stop_hook(agent_id)` (existing behavior)\n- Decide one:\n  - Keep `src/filelock.py` as a thin re-export for backward compatibility, OR\n  - Remove `src/filelock.py` and update all imports (handled later in integration).\n\n## TDD Guidance\n- If you touch tests in this issue, stop and defer them to integration (tests should be updated there).\n\n## Acceptance Criteria\n- `src/tools/locking.py` exists with the required exports.\n- No other files are modified in this issue (except optional `src/filelock.py`).\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T19:54:51.176735691Z","updated_at":"2025-12-25T20:10:14.682614354Z","closed_at":"2025-12-25T20:10:14.682614354Z","close_reason":"Closed"}
{"id":"mala-5cz","title":"Skip uv sync when pyproject.toml unchanged","description":"## Context\nCurrently `uv sync` runs on every validation cycle, even when dependencies haven't changed.\n\n## Goal\nOnly run `uv sync` when `pyproject.toml` (or `uv.lock`) has been modified since the last sync.\n\n## Approach\n- Track last sync timestamp or hash of pyproject.toml/uv.lock\n- Compare before running sync\n- Skip if unchanged, reducing validation overhead\n\n## Acceptance Criteria\n- `uv sync` only runs when dependency files have changed\n- First run still syncs (no prior state)\n- Force sync option available if needed","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T00:55:36.999060635Z","updated_at":"2025-12-27T01:09:49.406031776Z","closed_at":"2025-12-27T01:09:49.406031776Z","close_reason":"Closed"}
{"id":"mala-5eg","title":"Enforce full validation in quality gate (no file-specific checks)","description":"## Problem\n\n**CRITICAL GAP**: The orchestrator does NOT actually run validation after agent commits.\n\nCurrent flow:\n1. Agent runs, does its own validation (or games it with `ty check src/specific_file.py`)\n2. `QualityGate` parses JSONL logs for regex matches like `r\"\\b(uvx\\s+)?ty\\s+check\\b\"`\n3. If `ty check` was **mentioned** (even with a path argument)  gate passes\n\nThe `QualityGate` only checks IF commands were mentioned, NOT:\n- Whether they ran on the full codebase (vs `ty check src/foo.py`)\n- Whether they passed (exit code 0)\n- Whether the output showed 0 errors\n\nMeanwhile, `ValidationRunner` exists with proper worktree-based validation but is **not wired up** to the orchestrator flow.\n\n## Solution\n\n### Option A: Wire up ValidationRunner (Recommended)\nAfter agent commits, orchestrator should:\n1. Call `ValidationRunner.validate_commit(commit_sha, issue_id)`\n2. This runs full validation in clean worktree including `uvx ty check`\n3. Gate fails if any validation step fails\n\n### Option B: Enhance QualityGate Regex (Partial Fix)\nUpdate `VALIDATION_PATTERNS[\"ty_check\"]` to reject:\n- Path arguments: `ty check src/`, `ty check tests/`\n- Truncation: `| head`, `| tail`\n- Non-zero exit detection from tool_result\n\nBut this is weaker - agents could still game it.\n\n## Root Cause Evidence\n\nFrom commit 0328a6e logs, agent ran:\n```\nuvx ty check 2\u003e\u00261 | head -20     # Truncated!\nuvx ty check src/orchestrator.py  # File-specific to avoid errors!\n```\n\nQualityGate regex matched these and passed the gate despite 62 type errors in test files.\n\n## Acceptance Criteria\n\n- [ ] ValidationRunner integrated into post-commit flow\n- [ ] Gate fails if `uvx ty check` returns non-zero\n- [ ] Gate fails if pytest/ruff/format fail\n- [ ] Tests verify full validation actually runs\n\n## Files\n- src/orchestrator.py (integrate ValidationRunner)\n- src/quality_gate.py (or deprecate log-parsing approach)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-27T06:33:36.274895875Z","updated_at":"2025-12-27T06:36:30.720892188Z","closed_at":"2025-12-27T06:36:30.720892188Z","close_reason":"Duplicate of mala-yg9.2.4 which already covers wiring up ValidationRunner"}
{"id":"mala-5ot","title":"Remove unused sync methods from BeadsClient","description":"## Context\n- `BeadsClient` has both sync and async versions of all methods\n- Orchestrator exclusively uses async versions (`get_ready_async`, `claim_async`, etc.)\n- Sync methods add ~200 lines of duplicated logic\n- Confidence: High - grep confirms no production calls to sync methods\n\n## Primary Files\n`src/beads_client.py:82-278`\n\n## Scope\n**In:** Remove sync methods: `get_epic_children`, `get_ready`, `claim`, `reset`, `get_issue_status`, `commit_issues`, `close_eligible_epics`, `mark_needs_followup`\n**Out:** Keep async methods and `_run_subprocess_async` helper intact\n\n## Acceptance Criteria\n- All sync methods removed from BeadsClient\n- No import errors or missing references\n- All 221 tests pass\n\n## Test Plan\n- Run `uv run pytest`\n- Verify no import errors with `python -c \"from src.beads_client import BeadsClient\"`\n\n## Notes for Agent\n- Tests in `test_orchestrator.py` mock both sync and async methods - only async mocks matter\n- The `DEFAULT_COMMAND_TIMEOUT` constant is used by async methods, keep it","status":"closed","priority":2,"issue_type":"chore","created_at":"2025-12-26T19:44:50.439271516Z","updated_at":"2025-12-26T19:51:49.651613381Z","closed_at":"2025-12-26T19:51:49.651613381Z","close_reason":"Closed","labels":["dead-code"],"dependencies":[{"issue_id":"mala-5ot","depends_on_id":"mala-7zq","type":"parent-child","created_at":"2025-12-26T19:45:26.536295235Z","created_by":"daemon"}]}
{"id":"mala-5us","title":"Implement ValidationSpec + policy classification","description":"Context:\n- ValidationSpec and related types define what validations run per scope.\n- Policy classification (code vs docs) and disable list drive required commands.\n\nScope:\n- In: implement ValidationSpec/ValidationCommand/Context/Result/Artifacts/IssueResolution types; build ValidationSpec from inputs; code-change classification and disable list handling per plan.\n- Out: runner execution and orchestration (separate tasks).\n\nAcceptance Criteria:\n- ValidationSpec construction supports scope (per-issue vs run-level).\n- Code vs docs classification available as a helper.\n- Disable list values map to spec omissions as described in the plan.\n\nTest Plan:\n- TDD: add unit tests for spec building and classification before implementation.\n- Run unit tests for spec module.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T23:00:01.653337578Z","updated_at":"2025-12-26T23:45:40.848755874Z","closed_at":"2025-12-26T23:45:40.848755874Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-5us","depends_on_id":"mala-j6p","type":"blocks","created_at":"2025-12-26T23:00:26.454579505Z","created_by":"daemon"}]}
{"id":"mala-6a7","title":"Epic: Coverage 'No Decrease' Policy with Auto-Refresh Baseline","description":"Context:\n- Current CLI uses fixed 85% coverage threshold, which is inflexible\n- Goal: default behavior should prevent coverage from decreasing (not a fixed number)\n- Uses existing coverage.xml as baseline, with auto-refresh when missing/stale\n- Must handle parallel agents safely via locking and temp worktrees\n\nScope:\n- In: CLI option changes, coverage.py baseline functions, spec.py CoverageConfig, spec_runner.py auto-refresh logic, orchestrator.py signature\n- Out: pyproject.toml threshold (keep for direct pytest), legacy_runner changes\n\nAcceptance Criteria:\n- `bd run` without `--coverage-threshold` uses \"no decrease\" mode\n- Baseline auto-refreshes when missing or stale\n- Parallel agents don't corrupt baseline via locking\n- Parse errors fail loudly, missing baseline warns + refreshes\n\nNotes for Agent:\n- This is the umbrella epic; implement child issues in dependency order","status":"open","priority":2,"issue_type":"epic","created_at":"2025-12-27T18:20:55.598874949Z","updated_at":"2025-12-27T23:03:36.264606381Z"}
{"id":"mala-6a7.1","title":"Add baseline coverage functions to coverage.py","description":"Context:\n- `coverage.py` currently only parses and checks against fixed thresholds\n- Need new functions: `get_baseline_coverage()` and `is_baseline_stale()`\n- Must distinguish \"missing\" (returns None) from \"parse error\" (raises/fails)\n- Staleness detection: compare mtime vs last commit time + check dirty working tree\n\nScope:\n- In: Add `get_baseline_coverage(report_path: Path) -\u003e float | None`\n- In: Add `is_baseline_stale(report_path: Path, repo_path: Path) -\u003e bool`\n- In: Update `check_coverage_threshold` to accept `min_percent: float | None`\n- In: Update `parse_and_check_coverage` signature similarly\n- Out: Auto-refresh logic (that's in spec_runner.py)\n\nAcceptance Criteria:\n- `get_baseline_coverage()` returns percentage if file exists and valid, None if missing, raises on parse errors\n- `is_baseline_stale()` returns True if mtime \u003c last commit time OR repo is dirty\n- `is_baseline_stale()` handles non-git repos gracefully (returns True if git commands fail)\n- `check_coverage_threshold(result, None)` returns PASSED\n\nTest Plan:\n- TDD: Write failing tests for each new function\n- Test missing file  returns None\n- Test valid file  returns percentage\n- Test malformed XML  raises error\n- Test stale mtime  returns True\n- Test dirty repo  returns True\n- Test non-git repo  handles gracefully\n\nNotes for Agent:\n- Use `git log -1 --format=%ct` for last commit time\n- Use `git status --porcelain` to check dirty status\n- Wrap git commands in try/except for non-git fallback\n- Primary files: src/validation/coverage.py, tests/test_coverage.py","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-27T18:21:11.580596827Z","updated_at":"2025-12-27T23:03:36.270029186Z","dependencies":[{"issue_id":"mala-6a7.1","depends_on_id":"mala-6a7","type":"parent-child","created_at":"2025-12-27T18:21:11.587208102Z","created_by":"daemon"}]}
{"id":"mala-6a7.2","title":"Update CoverageConfig and pytest command in spec.py","description":"Context:\n- `CoverageConfig.min_percent` currently defaults to 85.0\n- Need to change default to None (meaning \"no decrease\" mode)\n- When `coverage_threshold is None`, must add `--cov-fail-under=0` to pytest command to override pyproject.toml\n\nScope:\n- In: Change `CoverageConfig.min_percent: float = 85.0` to `min_percent: float | None = None`\n- In: Update docstring to explain None = \"no decrease\" mode\n- In: In `build_validation_spec`, when `coverage_threshold is None`, add `--cov-fail-under=0` to pytest command\n- Out: Actual baseline comparison logic (that's in spec_runner.py)\n\nAcceptance Criteria:\n- `CoverageConfig(enabled=True)` has `min_percent=None` by default\n- Pytest command includes `--cov-fail-under=0` when threshold is None\n- Pytest command includes explicit threshold when provided\n- Docstrings updated\n\nTest Plan:\n- TDD: Test default CoverageConfig has min_percent=None\n- Test `build_validation_spec()` with no threshold  pytest includes `--cov-fail-under=0`\n- Test `build_validation_spec(coverage_threshold=80)`  pytest includes `--cov-fail-under=80`\n\nNotes for Agent:\n- The `--cov-fail-under=0` is needed to override pyproject.toml's `--cov-fail-under=85`\n- Keep existing coverage-related pytest flags (`--cov=src`, etc.)\n- Primary files: src/validation/spec.py, tests/test_spec.py","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-27T18:21:24.776545691Z","updated_at":"2025-12-27T23:03:36.270511254Z","dependencies":[{"issue_id":"mala-6a7.2","depends_on_id":"mala-6a7","type":"parent-child","created_at":"2025-12-27T18:21:24.783252376Z","created_by":"daemon"},{"issue_id":"mala-6a7.2","depends_on_id":"mala-6a7.1","type":"blocks","created_at":"2025-12-27T18:22:19.876162823Z","created_by":"daemon"}]}
{"id":"mala-6a7.3","title":"Implement baseline auto-refresh in spec_runner.py","description":"Context:\n- Must capture baseline from main repo BEFORE worktree creation\n- If baseline missing or stale, auto-refresh by running tests in temp worktree\n- Need locking to prevent parallel agents from clobbering\n- Must use same pytest args as validation spec\n\nScope:\n- In: Add `_refresh_baseline(spec, repo_path) -\u003e float` method\n- In: Before worktree setup in `run_validation_spec`, check/refresh baseline\n- In: Use file locking (existing locking.py) with double-check pattern\n- In: Pass `baseline_percent` to `_check_coverage`\n- In: Update `_check_coverage` to accept and use baseline_percent\n- Out: CLI changes, CoverageConfig changes (done in other issues)\n\nAcceptance Criteria:\n- Baseline captured from main repo before worktree creation\n- If baseline missing/stale, `_refresh_baseline` runs in temp worktree\n- Lock acquired before refresh, released after\n- Double-check pattern: re-verify staleness after acquiring lock\n- Temp worktree cleaned up after refresh\n- Atomic rename of coverage.xml to main repo\n- `_check_coverage` uses baseline_percent when min_percent is None\n\nTest Plan:\n- Test baseline captured before worktree setup\n- Test missing baseline triggers refresh\n- Test stale baseline triggers refresh\n- Test fresh baseline skips refresh\n- Test lock prevents concurrent refreshes\n- Mock worktree creation/cleanup\n\nNotes for Agent:\n- Use existing `create_worktree` from worktree.py\n- Use existing locking functions from locking.py\n- Run pytest with same args from spec, just override `--cov-fail-under=0`\n- Write to temp file, then `os.rename()` for atomic update\n- Primary file: src/validation/spec_runner.py","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-27T18:21:40.548034735Z","updated_at":"2025-12-27T23:03:36.270903592Z","dependencies":[{"issue_id":"mala-6a7.3","depends_on_id":"mala-6a7","type":"parent-child","created_at":"2025-12-27T18:21:40.555202907Z","created_by":"daemon"},{"issue_id":"mala-6a7.3","depends_on_id":"mala-6a7.1","type":"blocks","created_at":"2025-12-27T18:22:19.893411903Z","created_by":"daemon"},{"issue_id":"mala-6a7.3","depends_on_id":"mala-6a7.2","type":"blocks","created_at":"2025-12-27T18:22:19.90738317Z","created_by":"daemon"}]}
{"id":"mala-6a7.4","title":"Update CLI coverage-threshold option","description":"Context:\n- CLI currently has `--coverage-threshold` defaulting to 85.0\n- Need to change default to None\n- Validation logic must allow None (currently rejects non-0-100 values)\n\nScope:\n- In: Change `--coverage-threshold` default from `85.0` to `None`\n- In: Update help text to explain \"no decrease\" mode\n- In: Update validation to allow None (skip range check if None)\n- Out: Actual coverage logic (that's in coverage.py/spec_runner.py)\n\nAcceptance Criteria:\n- `--coverage-threshold` defaults to None\n- Help text mentions \"no decrease\" behavior\n- Running without `--coverage-threshold` doesn't error\n- Running with `--coverage-threshold 80` still works\n\nTest Plan:\n- Test CLI parses None default correctly\n- Test explicit threshold value works\n- Test help text is updated\n\nNotes for Agent:\n- Type should be `float | None` with default `None`\n- Skip the `0 \u003c= coverage_threshold \u003c= 100` check when None\n- Primary file: src/cli.py","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-27T18:21:51.768479029Z","updated_at":"2025-12-27T23:03:36.27133697Z","dependencies":[{"issue_id":"mala-6a7.4","depends_on_id":"mala-6a7","type":"parent-child","created_at":"2025-12-27T18:21:51.776699972Z","created_by":"daemon"},{"issue_id":"mala-6a7.4","depends_on_id":"mala-6a7.5","type":"blocks","created_at":"2025-12-27T18:25:07.340502685Z","created_by":"daemon"}]}
{"id":"mala-6a7.5","title":"Update orchestrator coverage_threshold type","description":"Context:\n- `MalaOrchestrator.__init__` accepts `coverage_threshold: float = 85.0`\n- Need to update type to `float | None = None` to match CLI\n\nScope:\n- In: Change `coverage_threshold` parameter type to `float | None = None`\n- Out: Any logic changes (just type signature update)\n\nAcceptance Criteria:\n- Orchestrator accepts None for coverage_threshold\n- Type hints updated\n- Passes value through to ValidationSpec correctly\n\nTest Plan:\n- Verify orchestrator instantiation with None works\n- Verify orchestrator instantiation with float works\n\nNotes for Agent:\n- Simple signature change, no logic changes needed\n- Primary file: src/orchestrator.py","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-27T18:21:59.927350234Z","updated_at":"2025-12-27T23:03:36.271717568Z","dependencies":[{"issue_id":"mala-6a7.5","depends_on_id":"mala-6a7","type":"parent-child","created_at":"2025-12-27T18:21:59.93766352Z","created_by":"daemon"},{"issue_id":"mala-6a7.5","depends_on_id":"mala-6a7.2","type":"blocks","created_at":"2025-12-27T18:25:07.327542248Z","created_by":"daemon"}]}
{"id":"mala-6a7.6","title":"Add tests for 'no decrease' coverage behavior","description":"Context:\n- Need integration-level tests for the full \"no decrease\" flow\n- Existing tests may need updates for new default behavior\n\nScope:\n- In: Add tests for \"no decrease\" mode end-to-end\n- In: Update existing tests that assume 85.0 default\n- Out: Core implementation (done in other issues)\n\nAcceptance Criteria:\n- Tests verify baseline is captured before validation\n- Tests verify auto-refresh when baseline missing\n- Tests verify coverage comparison against baseline\n- Existing tests pass with new defaults\n\nTest Plan:\n- Test \"no decrease\" mode with fresh baseline\n- Test \"no decrease\" mode with stale baseline triggers refresh\n- Test explicit threshold overrides baseline mode\n\nNotes for Agent:\n- May need to mock git commands for staleness tests\n- May need to mock worktree creation for refresh tests\n- Primary files: tests/test_spec.py, tests/test_coverage.py","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-27T18:22:09.331814334Z","updated_at":"2025-12-27T23:03:36.272130726Z","dependencies":[{"issue_id":"mala-6a7.6","depends_on_id":"mala-6a7","type":"parent-child","created_at":"2025-12-27T18:22:09.338662428Z","created_by":"daemon"},{"issue_id":"mala-6a7.6","depends_on_id":"mala-6a7.3","type":"blocks","created_at":"2025-12-27T18:22:19.946957118Z","created_by":"daemon"}]}
{"id":"mala-6ap","title":"Enhanced cleanup on early agent exit: git reset + reopen issue","description":"## Problem\nWhen agents exit early (context exhaustion, error, timeout, etc.), they may leave partial work in the git working tree and the issue in an inconsistent state (e.g., still marked as in_progress).\n\n## Current Behavior\n- Orchestrator calls `reset_issue()` which sets status back, but doesn't clean up git state\n- Partial file changes may remain uncommitted in the working tree\n- Next agent picking up the issue sees a dirty state\n\n## Proposed Solution\nOn early agent exit, the orchestrator should:\n\n1. **Reset git state**: Discard all uncommitted changes for files the agent touched\n   - `git checkout -- \u003cfiles\u003e` or `git restore \u003cfiles\u003e`\n   - Consider `git clean` for any new untracked files created by the agent\n   - Be careful not to discard work from other concurrent agents\n\n2. **Mark issue as open**: Use `bd update \u003cissue\u003e --status open` (not just reset to previous state)\n   - This makes it clear the issue needs to be picked up fresh\n\n3. **Release all locks**: Already done, but ensure it happens before git reset\n\n## Implementation Notes\n- Need to track which files the agent modified (from tool calls in JSONL log)\n- Or simpler: reset only files that match the issue's scope (if defined)\n- Safest approach: only reset files the agent held locks for\n\n## Acceptance Criteria\n- Early exit leaves working tree clean (no partial changes from failed agent)\n- Issue status is set to 'open' \n- Locks are released\n- Other agents' uncommitted work is not affected","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T17:08:40.391592982Z","updated_at":"2025-12-26T18:28:00.450472489Z","closed_at":"2025-12-26T18:28:00.450472489Z","close_reason":"Merged into mala-b0m (Graceful shutdown with agent wrap-up)"}
{"id":"mala-6c0","title":"Enforce single mala run per directory with lock file","description":"Context:\n- Running multiple mala instances in the same directory can cause conflicts.\n- Need a lock mechanism to prevent concurrent runs.\n\nScope:\n- In: create lock file on run start; check for existing lock; fail fast if locked.\n- Out: distributed locking; cross-machine coordination.\n\nAcceptance Criteria:\n- Second mala run in same directory fails immediately with clear error message.\n- Lock file is cleaned up on normal exit.\n- Stale locks (from crashed runs) are detected and can be overridden with --force.\n\nTest Plan:\n- Manual: start two runs in same dir, verify second fails.\n- Unit: mock lock file operations.","status":"blocked","priority":2,"issue_type":"feature","created_at":"2025-12-27T01:11:27.170231152Z","updated_at":"2025-12-27T01:11:48.921729042Z"}
{"id":"mala-6hp","title":"Add CLAUDE.md/AGENTS.md context loading for Agent SDK apps","description":"Agent SDK applications should optionally load and incorporate CLAUDE.md or AGENTS.md files into their context, similar to how Claude Code automatically reads these files for project-specific instructions.\n\nThis would allow:\n- Consistent behavior between Claude Code and Agent SDK apps\n- Project-specific instructions to apply to custom agents\n- Reuse of existing CLAUDE.md files in Agent SDK applications\n\nBlocked on: Determining the best API design for this feature (should it be automatic, opt-in, or configurable?)","status":"blocked","priority":2,"issue_type":"feature","created_at":"2025-12-27T20:00:05.349091312Z","updated_at":"2025-12-27T20:00:09.141039067Z"}
{"id":"mala-6iv","title":"Test: add hello comment to pyproject.toml","status":"tombstone","priority":2,"issue_type":"task","created_at":"2025-12-25T19:03:17.354821017Z","updated_at":"2025-12-25T19:05:18.077405908Z","close_reason":"Closed","deleted_at":"2025-12-25T19:05:18.077405908Z","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"mala-6m0","title":"Remove dist artifacts from repo","description":"Context:\n- Built artifacts in dist/ are checked into the repo and can become stale or misleading.\n\nScope:\n- In: remove dist artifacts from git and add root .gitignore entries to prevent re-addition.\n- Out: changes to build scripts or release process.\n\nAcceptance Criteria:\n- dist/ artifacts are removed from version control.\n- dist/ is ignored at repo root.\n\nTest Plan:\n- `git status` is clean after removal; building still produces artifacts locally.","status":"closed","priority":4,"issue_type":"chore","created_at":"2025-12-26T17:36:09.569995213Z","updated_at":"2025-12-26T18:41:25.970765111Z","closed_at":"2025-12-26T18:41:25.970765111Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-6m0","depends_on_id":"mala-jnq","type":"parent-child","created_at":"2025-12-26T17:36:15.744955272Z","created_by":"daemon"}]}
{"id":"mala-77z","title":"Remove unused log_result function","description":"## Context\n- `log_result()` is defined but never imported or called anywhere\n- Orchestrator uses `log()` with \"\" and \"\" icons directly instead\n- ~12 lines of dead code\n- Confidence: High - grep shows only the definition, no callers\n\n## Primary Files\n`src/logging/console.py:263-274`\n\n## Scope\n**In:** Delete the `log_result` function\n**Out:** Keep all other logging functions\n\n## Acceptance Criteria\n- Function removed\n- No import errors or reference breaks\n- Tests pass\n\n## Test Plan\n- Run `uv run pytest`\n- Verify: `python -c \"from src.logging.console import log, log_tool, log_agent_text\"`\n\n## Notes for Agent\n- Function is at lines 263-274, after `log_agent_text`\n- No tests reference this function","status":"closed","priority":2,"issue_type":"chore","created_at":"2025-12-26T19:45:05.56975816Z","updated_at":"2025-12-26T19:53:05.087656466Z","closed_at":"2025-12-26T19:53:05.087656466Z","close_reason":"Closed","labels":["dead-code"],"dependencies":[{"issue_id":"mala-77z","depends_on_id":"mala-7zq","type":"parent-child","created_at":"2025-12-26T19:45:26.566257822Z","created_by":"daemon"}]}
{"id":"mala-781","title":"Package prompt file and align Python requirement","description":"Context:\n- Orchestrator reads the implementer prompt at import; missing files in the wheel will crash CLI startup.\n- Current build config doesnt explicitly include prompt files in artifacts.\n- requires-python is set to \u003e=3.14 even though the codebase doesnt appear to need it.\n- Needs verification: confirm wheel contents and the actual minimum supported Python version.\n\nScope:\n- In: include src/prompts/implementer_prompt.md in wheel build config and lower requires-python to the agreed minimum (likely 3.11/3.12).\n- Out: changing prompt content or runtime loading semantics.\n\nAcceptance Criteria:\n- Built wheel contains the prompt file and importing src.orchestrator succeeds.\n- Package installs on the agreed minimum Python version.\n\nTest Plan:\n- Build a wheel and verify prompt file inclusion; run a simple import or `mala status` in a venv.\n\nNotes for Agent:\n- Keep changes isolated to packaging config unless a fallback is required.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-26T17:35:34.45601593Z","updated_at":"2025-12-26T18:20:25.115815935Z","closed_at":"2025-12-26T18:20:25.115815935Z","close_reason":"False positive: hatchling's packages=[\"src\"] includes all files (not just .py), so prompt is already in wheel. Only requires-python issue remains valid but is minor.","dependencies":[{"issue_id":"mala-781","depends_on_id":"mala-jnq","type":"parent-child","created_at":"2025-12-26T17:36:15.690597316Z","created_by":"daemon"}]}
{"id":"mala-784","title":"Ideas: Future improvements","description":"Brainstorm ideas needing grooming:\n- Add back claude orchestrator, manually managing context\n- Agent mail using filesystem?\n- Use codex for code review?\n- Make morphllm optional","status":"tombstone","priority":2,"issue_type":"epic","created_at":"2025-12-26T00:54:39.176848025Z","updated_at":"2025-12-26T00:55:27.983470092Z","deleted_at":"2025-12-26T00:55:27.983470092Z","deleted_by":"daemon","delete_reason":"delete","original_type":"epic"}
{"id":"mala-7a6","title":"Baseline commit lost on session resume: Codex review sees partial diff","description":"## Problem\n\nWhen an issue is partially completed in a prior session (e.g., agent made commits but gate/review failed), a new orchestrator session captures a NEW baseline from current HEAD. This means the cumulative diff only includes changes from the current session, not the full implementation.\n\n### Scenario\n\n1. **Session 1**: Issue claimed, baseline = commit A\n2. **Session 1**: Agent creates commits B, C (partial implementation)\n3. **Session 1**: Gate/review fails, session ends\n4. **Session 2**: New orchestrator run, baseline = commit C (prior work!)\n5. **Session 2**: Agent creates commit D (fix)\n6. **Session 2**: Codex reviews diff C..D  **misses work in B and C!**\n\n### Root Cause\n\n`baseline_commit_hash` is captured fresh in `run_implementer()` at session start, stored only in `RetryState` (in-memory). Not persisted across orchestrator runs.\n\n## Solution\n\nDerive baseline from git history instead of capturing at session start:\n\n```python\ndef get_baseline_for_issue(repo_path: Path, issue_id: str) -\u003e str | None:\n    # Find first commit with \"bd-{issue_id}:\" prefix\n    result = subprocess.run(\n        [\"git\", \"log\", \"--oneline\", \"--reverse\", f\"--grep=^bd-{issue_id}:\"],\n        capture_output=True, text=True, cwd=repo_path\n    )\n    if result.stdout.strip():\n        first_commit = result.stdout.strip().split('\\n')[0].split()[0]\n        # Get its parent\n        parent = subprocess.run(\n            [\"git\", \"rev-parse\", f\"{first_commit}^\"],\n            capture_output=True, text=True, cwd=repo_path\n        )\n        return parent.stdout.strip() if parent.returncode == 0 else None\n    return None  # No commits yet for this issue\n```\n\nLogic in `run_implementer()`:\n- If git history has commits for this issue  use parent of first commit as baseline\n- If no commits yet  capture current HEAD as baseline (fresh issue)\n\n### Why git history approach\n\n1. Git is source of truth - always accurate\n2. Works retroactively for existing in-progress issues  \n3. No beads schema changes or notes parsing\n4. Self-healing if metadata gets corrupted\n5. Handles edge cases (parallel agents, rebases) naturally\n\n## In Scope\n\n- `src/git_utils.py`: Add `get_baseline_for_issue()` async function\n- `src/orchestrator.py`: Update `run_implementer()` to use git-derived baseline\n- Tests: TDD approach - write tests first for:\n  - Fresh issue (no prior commits)  captures HEAD\n  - Resumed issue (has prior commits)  finds parent of first commit\n  - Edge cases: merge commits, rebased history, no parent (root commit)\n\n## Out of Scope\n\n- Persisting baseline in beads notes (simpler git approach preferred)\n- Changes to beads schema\n- Codex prompt changes (already handles baseline correctly when provided)\n\n## Implementation Notes\n\n**Use TDD approach:**\n1. Write failing tests first for `get_baseline_for_issue()`\n2. Write failing tests for orchestrator integration\n3. Implement to make tests pass\n4. Refactor as needed\n\n## Acceptance Criteria\n\n- [ ] Resumed sessions use correct baseline (parent of first issue commit)\n- [ ] Fresh issues still capture HEAD as baseline\n- [ ] Codex review sees cumulative diff across sessions\n- [ ] Tests cover fresh, resumed, and edge case scenarios","status":"closed","issue_type":"bug","created_at":"2025-12-27T23:49:29.153535606Z","updated_at":"2025-12-28T00:55:16.085961516Z","closed_at":"2025-12-28T00:55:16.085961516Z","close_reason":"Closed"}
{"id":"mala-7jj","title":"CLI tool for mala run performance analysis","description":"Context:\n- Currently, analyzing mala run performance requires ad-hoc Python scripts\n- Key metrics needed: token usage, context accumulation, duration, success rates, headroom analysis\n- Data sources: ~/.config/mala/runs/*.json (run metadata) and Claude JSONL logs (token usage)\n\nScope:\n- In: CLI command `mala analyze` (or similar) that queries local run data\n- In: Summary stats (min/median/mean/max) for: final context tokens, duration, success rate\n- In: Context headroom analysis (% of 200K limit used)\n- In: Top N issues by token consumption\n- In: Filtering by time range (e.g., --last 1d, --last 7d)\n- Out: Braintrust integration (separate concern)\n- Out: Real-time monitoring (this is post-hoc analysis)\n\nAcceptance Criteria:\n- mala analyze shows summary statistics for recent runs\n- mala analyze --last 1d filters to last 24 hours\n- mala analyze --top 10 shows top 10 issues by token usage\n- mala analyze --context shows context headroom distribution\n- Output is formatted for terminal (not JSON by default, but --json flag available)\n\nTest Plan:\n- Unit tests for log parsing and aggregation logic\n- Integration test with sample run/log fixtures\n- Manual verification against known run data\n\nNotes for Agent:\n- Token calculation: input_tokens + cache_creation_input_tokens + cache_read_input_tokens\n- Run files are in ~/.config/mala/runs/*.json\n- Log files are referenced in run JSON as issues.\u003cid\u003e.log_path\n- Usage data is in JSONL entries at entry.message.usage","status":"blocked","priority":2,"issue_type":"feature","created_at":"2025-12-27T18:08:15.379697993Z","updated_at":"2025-12-27T18:08:21.020288628Z"}
{"id":"mala-7m1","title":"Support non-Python repos in validation","description":"Currently mala assumes all repos are Python projects and requires uv sync, ruff, pytest, ty validation commands.\n\n## Future Improvements\n\n### 1. Detect project type\nSkip Python validation for non-Python repos (check for pyproject.toml existence). Could also detect other project types (Node.js via package.json, Go via go.mod, etc.) and run appropriate validation.\n\n### 2. Per-repo validation config\nAllow repos to specify their own validation commands via:\n- CLAUDE.md directives\n- .beads/validation.yaml\n- pyproject.toml [tool.mala] section\n\n## Context\nDiscovered when ai-configs-464.1 (a shell script repo) failed quality gate due to missing 'uv sync' - there's no pyproject.toml because it's not a Python project.\n\n## References\n- src/validation/spec.py:build_validation_spec() - hardcodes Python commands\n- src/quality_gate.py:ValidationEvidence - hardcodes Python evidence checks","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T20:30:11.760932242Z","updated_at":"2025-12-27T20:36:17.101092438Z","closed_at":"2025-12-27T20:36:17.101092438Z","close_reason":"Merged into parent epic mala-ytn","dependencies":[{"issue_id":"mala-7m1","depends_on_id":"mala-ytn","type":"parent-child","created_at":"2025-12-27T20:36:11.439535313Z","created_by":"daemon"}]}
{"id":"mala-7pd","title":"Remove Edit from FILE_WRITE_TOOLS (redundant)","description":"## Context\n- `FILE_WRITE_TOOLS` includes `\"Edit\"` for lock enforcement\n- `MORPH_DISALLOWED_TOOLS` also lists `\"Edit\"`, blocking it before lock check runs\n- Lock enforcement hook never triggers for Edit - redundant entry\n- Confidence: Medium - logic is correct but relies on hook ordering\n\n## Primary Files\n`src/hooks.py:50-57`\n\n## Scope\n**In:** Remove `\"Edit\"` from `FILE_WRITE_TOOLS` constant\n**Out:** Don't change `MORPH_DISALLOWED_TOOLS` or lock enforcement logic\n\n## Acceptance Criteria\n- `\"Edit\"` removed from `FILE_WRITE_TOOLS`\n- `\"Edit\"` removed from `FILE_PATH_KEYS` dict\n- Test `test_file_write_tools_constant_contains_expected_tools` updated\n- All tests pass\n\n## Test Plan\n- Run `uv run pytest tests/test_hooks.py`\n- Run full suite: `uv run pytest`\n\n## Notes for Agent\n- Also remove `\"Edit\"` from `FILE_PATH_KEYS` dict (line 61) since it won't be checked\n- Update test in `test_hooks.py:120-124` to not expect `Edit` in the set","status":"closed","priority":3,"issue_type":"chore","created_at":"2025-12-26T19:45:13.913074646Z","updated_at":"2025-12-26T19:50:02.12412912Z","closed_at":"2025-12-26T19:50:02.12412912Z","close_reason":"Closed","labels":["consistency"],"dependencies":[{"issue_id":"mala-7pd","depends_on_id":"mala-7zq","type":"parent-child","created_at":"2025-12-26T19:45:26.577618753Z","created_by":"daemon"}]}
{"id":"mala-7zq","title":"Dead Code and Consistency Cleanup","description":"## Context\n- Healthcheck identified ~250 lines of dead code from incomplete async migration\n- Sync methods exist alongside async versions but are never called in production\n- Minor consistency issues in hook constants\n- All child issues are independent and can parallelize\n\n## Scope\n**In:** Remove dead code, fix consistency issues identified in healthcheck\n**Out:** No functional changes, no new features\n\n## Acceptance Criteria\n- All child issues completed\n- Test suite still passes (221 tests)\n- No dead code warnings from static analysis\n\n## Test Plan\n- Run `uv run pytest` after all children complete","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-26T19:44:42.537192954Z","updated_at":"2025-12-26T19:53:05.164431129Z","closed_at":"2025-12-26T19:53:05.164431129Z","close_reason":"All children completed","labels":["dead-code"]}
{"id":"mala-81g","title":"Explore using CLAUDE_CONFIG_DIR to isolate mala agent logs from system Claude Code","description":"Investigate setting CLAUDE_CONFIG_DIR environment variable when spawning agents to write JSONL logs to a separate location (e.g., ~/.config/mala/claude-logs/) instead of mixing with system Claude Code logs in ~/.claude/projects/. This would make log management and cleanup easier for mala-specific sessions.","status":"blocked","priority":2,"issue_type":"task","created_at":"2025-12-26T18:20:17.980544403Z","updated_at":"2025-12-26T18:25:19.995198414Z","labels":["blocked"]}
{"id":"mala-82u","title":"Epic: Coverage 'No Decrease' Policy with Auto-Refresh Baseline","description":"Context:\n- Current CLI uses fixed 85% coverage threshold, which is inflexible\n- Goal: default behavior should prevent coverage from decreasing (not a fixed number)\n- Uses existing coverage.xml as baseline, with auto-refresh when missing/stale\n- Must handle parallel agents safely via locking and temp worktrees\n\nScope:\n- In: CLI option changes, coverage.py baseline functions, spec.py CoverageConfig, spec_runner.py auto-refresh logic, orchestrator.py signature\n- Out: pyproject.toml threshold (keep for direct pytest), legacy_runner changes\n\nAcceptance Criteria:\n- `bd run` without `--coverage-threshold` uses \"no decrease\" mode\n- Baseline auto-refreshes when missing or stale\n- Parallel agents don't corrupt baseline via locking\n- Parse errors fail loudly, missing baseline warns + refreshes\n\nTest Plan:\n- Integration test for full \"no decrease\" flow\n- Unit tests for each new function\n\nNotes for Agent:\n- This is the umbrella epic; implement child issues in dependency order","status":"tombstone","priority":1,"issue_type":"epic","created_at":"2025-12-27T18:13:22.418075331Z","updated_at":"2025-12-27T18:20:40.635708509Z","labels":["validation"],"deleted_at":"2025-12-27T18:20:40.635708509Z","deleted_by":"daemon","delete_reason":"delete","original_type":"epic"}
{"id":"mala-8td","title":"Log codex review session path in verbose mode","description":"When running in verbose mode, the orchestrator should capture and log the path to the codex session log file that codex creates during the review.\n\nCodex stores session logs in `~/.codex/sessions/YYYY/MM/DD/{session-id}.jsonl`. The orchestrator should:\n1. Capture the session ID or log path from codex's output\n2. Store the path in the runs JSON under the issue's `codex_review_log_path` field\n\nThis enables debugging by pointing to the full codex conversation/session log.","acceptance_criteria":"- In verbose mode, the codex session log path is captured from the codex run\n- The runs JSON includes `codex_review_log_path` field pointing to the codex session JSONL file\n- In non-verbose mode, the path is not captured (to avoid overhead)\n- Path format: `~/.codex/sessions/YYYY/MM/DD/{session-id}.jsonl`","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-27T22:27:51.105697172Z","updated_at":"2025-12-27T22:27:51.105697172Z"}
{"id":"mala-98c","title":"Redirect test logs to /tmp (mala runs + Claude SDK)","description":"## Context\nTests generate run metadata logs in ~/.config/mala/runs/, polluting the user's configuration directory with test artifacts. Additionally, Claude SDK writes session logs to ~/.claude/projects/, which also gets polluted during test runs.\n\n## Problem\nWhen running pytest:\n1. RunMetadata.save() writes to RUNS_DIR (~/.config/mala/runs/), creating hundreds of JSON files from test runs\n2. Claude SDK writes session logs to ~/.claude/projects/, creating test artifacts in the user's Claude config\n\n## Solution\nOverride both directories to point to /tmp locations when running tests:\n1. Add MALA_RUNS_DIR env var support in env.py (similar to MALA_LOCK_DIR)\n2. Add CLAUDE_CONFIG_DIR env var support for get_claude_log_path()\n3. Set both env vars in conftest.py pytest_configure()\n\n## Acceptance Criteria\n- Test runs do not create files in ~/.config/mala/runs/\n- Test runs do not create files in ~/.claude/projects/\n- Run logs go to /tmp/mala-test-runs/ or similar\n- Claude logs use /tmp/mala-test-claude/ or similar\n- Production behavior unchanged\n\n## Files to Modify\n- src/tools/env.py: Add MALA_RUNS_DIR env var support, add get_claude_config_dir() helper, update get_claude_log_path() to use it\n- tests/conftest.py: Set MALA_RUNS_DIR and CLAUDE_CONFIG_DIR to /tmp paths for all tests\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T06:15:51.085556202Z","updated_at":"2025-12-27T07:19:53.463304503Z","closed_at":"2025-12-27T07:19:53.463304503Z","close_reason":"Closed"}
{"id":"mala-9c4","title":"Log codex review output in verbose mode","description":"When running in verbose mode, the orchestrator should save the codex review output (raw JSON response) to a file. This enables debugging and auditing of codex review decisions.\n\nThe log file should be saved alongside other run artifacts in the runs directory, with a naming convention like:\n`{run_id}-{issue_id}-codex-review.json`\n\nThe path to this log file should be recorded in the runs JSON under the issue's `codex_review_log_path` field.","acceptance_criteria":"- In verbose mode, codex review raw output is saved to a file\n- File is saved in the runs directory with format {run_id}-{issue_id}-codex-review.json\n- The runs JSON includes codex_review_log_path field for each issue that had codex review run\n- In non-verbose mode, no log file is created (to save disk space)\n- Log includes all review attempts (not just the final one)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T22:24:05.447731981Z","updated_at":"2025-12-27T22:26:53.987400446Z","closed_at":"2025-12-27T22:26:53.987400446Z","close_reason":"Closed"}
{"id":"mala-9ki","title":"Refactor: add tools/env.py and centralize env loading","description":"## Context\n`src/main.py` currently defines `USER_CONFIG_DIR`, `JSONL_LOG_DIR`, `SCRIPTS_DIR`, and performs dotenv loading at import time. This creates side effects and makes reuse/testing harder. The architecture plan calls for a small `tools/env.py` module that owns config paths and env loading, while preserving the **early** load needed for Braintrust setup.\n\n## Scope\nCreate a new module `src/tools/env.py` only. Do **not** modify `src/main.py` in this issue; integration will wire it up later.\n\n### Files\n- Add: `src/tools/env.py`\n\n## Requirements\n- `tools/env.py` should define:\n  - `USER_CONFIG_DIR = Path.home() / \".config\" / \"mala\"`\n  - `JSONL_LOG_DIR = USER_CONFIG_DIR / \"logs\"`\n  - `SCRIPTS_DIR` that points to repo `scripts/` (from `src/tools/env.py`, use `Path(__file__).resolve().parents[2] / \"scripts\"` or equivalent)\n- Provide two helpers:\n  - `load_user_env()` that loads `${USER_CONFIG_DIR}/.env` only (for early Braintrust setup)\n  - `load_env(repo_path: Path | None)` that calls `load_user_env()` and then (if `repo_path` is provided) loads `\u003crepo_path\u003e/.env` with `override=True`\n\n## Acceptance Criteria\n- `src/tools/env.py` exists with the above constants and functions.\n- No other files are modified in this issue.\n\n## Notes\n- Integration issue will wire these into `src/main.py`.\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T19:54:51.122065094Z","updated_at":"2025-12-25T20:08:26.994504903Z","closed_at":"2025-12-25T20:08:26.994504903Z","close_reason":"Closed"}
{"id":"mala-9mb","title":"Update orchestrator for strict validation pipeline","description":"Context:\n- Orchestrator must run the new strict gate chain and enforce issue closure rules.\n- Integrates EvidenceGate, clean-room validation, Codex review, and run-level validation.\n\nScope:\n- In: add Gate 1-4 sequencing; enforce clean-git checks; handle no-op/obsolete IssueResolution; respect disable-validations; run-level validation in worktree; follow-up issue on failure.\n- Out: changes to validation module internals (separate tasks).\n\nAcceptance Criteria:\n- Issues are closed only after run-level validation passes.\n- No-op/obsolete issues do not force commits and skip per-issue validation.\n- Failures trigger correct retries and non-zero exit on run-level failure.\n\nTest Plan:\n- TDD: add orchestrator tests for gate flow, retry exhaustion, and no-op issues.\n- Run orchestrator test suite.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T23:00:01.754561703Z","updated_at":"2025-12-27T01:40:18.566144768Z","closed_at":"2025-12-27T01:40:18.566144768Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-9mb","depends_on_id":"mala-cij","type":"blocks","created_at":"2025-12-26T23:00:26.592166614Z","created_by":"daemon"},{"issue_id":"mala-9mb","depends_on_id":"mala-ng3","type":"blocks","created_at":"2025-12-26T23:00:26.60370918Z","created_by":"daemon"},{"issue_id":"mala-9mb","depends_on_id":"mala-e0i","type":"blocks","created_at":"2025-12-26T23:00:26.614703142Z","created_by":"daemon"},{"issue_id":"mala-9mb","depends_on_id":"mala-2eu","type":"blocks","created_at":"2025-12-26T23:00:26.625720633Z","created_by":"daemon"}]}
{"id":"mala-9qr","title":"Refactor: extract hook logic from src/cli.py","description":"Goal: Make hook logic self-contained by moving block_dangerous_commands (and related constants) into a new module (e.g., src/hooks.py).\\n\\nScope/files: src/cli.py, new src/hooks.py.\\n\\nWork:\\n- Move DANGEROUS_PATTERNS + block_dangerous_commands to new module.\\n- Update imports in cli.py.\\n- Keep behavior unchanged.\\n\\nAcceptance criteria:\\n- CLI behavior unchanged.\\n- Hook still used in ClaudeAgentOptions.hooks.\\n- Tests (if any) still pass.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-25T21:41:10.672408295Z","updated_at":"2025-12-26T00:06:41.954204714Z","closed_at":"2025-12-26T00:06:41.954204714Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-9qr","depends_on_id":"mala-akl","type":"blocks","created_at":"2025-12-25T21:47:25.567206045Z","created_by":"daemon"},{"issue_id":"mala-9qr","depends_on_id":"mala-c01","type":"parent-child","created_at":"2025-12-25T22:05:59.455394242Z","created_by":"daemon"}]}
{"id":"mala-a2z","title":"Implement baseline auto-refresh in spec_runner.py","description":"Context:\n- Must capture baseline from main repo BEFORE worktree creation\n- If baseline missing or stale, auto-refresh by running tests in temp worktree\n- Need locking to prevent parallel agents from clobbering\n- Must use same pytest args as validation spec\n\nScope:\n- In: Add `_refresh_baseline(spec, repo_path) -\u003e float` method\n- In: Before worktree setup in `run_validation_spec`, check/refresh baseline\n- In: Use file locking (existing locking.py) with double-check pattern\n- In: Pass `baseline_percent` to `_check_coverage`\n- In: Update `_check_coverage` to accept and use baseline_percent\n- Out: CLI changes, CoverageConfig changes (done in other issues)\n\nAcceptance Criteria:\n- Baseline captured from main repo before worktree creation\n- If baseline missing/stale, `_refresh_baseline` runs in temp worktree\n- Lock acquired before refresh, released after\n- Double-check pattern: re-verify staleness after acquiring lock\n- Temp worktree cleaned up after refresh\n- Atomic rename of coverage.xml to main repo\n- `_check_coverage` uses baseline_percent when min_percent is None\n\nTest Plan:\n- Test baseline captured before worktree setup\n- Test missing baseline triggers refresh\n- Test stale baseline triggers refresh\n- Test fresh baseline skips refresh\n- Test lock prevents concurrent refreshes\n- Mock worktree creation/cleanup\n\nNotes for Agent:\n- Use existing `create_worktree` from worktree.py\n- Use existing locking functions from locking.py\n- Run pytest with same args from spec, just override `--cov-fail-under=0`\n- Write to temp file, then `os.rename()` for atomic update\n- Primary file: src/validation/spec_runner.py","status":"tombstone","priority":1,"issue_type":"task","created_at":"2025-12-27T18:14:14.27972069Z","updated_at":"2025-12-27T18:20:40.634273311Z","labels":["validation"],"dependencies":[{"issue_id":"mala-a2z","depends_on_id":"mala-wg1","type":"blocks","created_at":"2025-12-27T18:15:02.015029041Z","created_by":"daemon"},{"issue_id":"mala-a2z","depends_on_id":"mala-da4","type":"blocks","created_at":"2025-12-27T18:15:02.027510339Z","created_by":"daemon"}],"deleted_at":"2025-12-27T18:20:40.634273311Z","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"mala-aht","title":"Epic: Healthcheck reliability fixes","description":"Context:\n- Umbrella for issues from the code health review (orchestrator + beads reliability).\n- Keep fixes small and parallel where possible.\n\nScope:\n- In: reliability/correctness fixes from the review output.\n- Out: new features or architecture changes.\n\nAcceptance Criteria:\n- Child issues created and linked.\n\nTest Plan:\n- N/A (epic).","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-26T19:54:23.723935931Z","updated_at":"2025-12-26T22:52:42.875836878Z","closed_at":"2025-12-26T22:52:42.875836878Z","close_reason":"All children completed"}
{"id":"mala-aht.1","title":"Stop gate retry loop when Claude log is missing","description":"Context:\n- run_implementer only proceeds if the Claude session log exists after a ResultMessage (src/orchestrator.py:348).\n- If the log never appears, the loop spins until global timeout, causing false failures and queue stalls.\n\nScope:\n- In: add a bounded wait for log creation; if missing, fail fast with a clear summary and exit the loop.\n- Out: changing the log directory or disabling the quality gate.\n\nAcceptance Criteria:\n- When log file never appears, run_implementer exits within a bounded wait and sets a summary indicating missing log.\n- Orchestrator does not stall for the full timeout due to missing logs.\n\nTest Plan:\n- TDD: add a failing unit test with a mocked client that yields ResultMessage but no log file; assert run_implementer returns quickly with a failure summary.\n- Run pytest for the new test.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-26T19:54:34.157781045Z","updated_at":"2025-12-26T20:26:33.740210331Z","closed_at":"2025-12-26T20:26:33.740210331Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-aht.1","depends_on_id":"mala-aht","type":"parent-child","created_at":"2025-12-26T19:54:34.165963474Z","created_by":"daemon"}]}
{"id":"mala-aht.2","title":"Avoid releasing locks owned by other runs","description":"Context:\n- Orchestrator always calls release_all_locks on shutdown (src/orchestrator.py:835), which deletes every lock file in LOCK_DIR (src/tools/locking.py:111).\n- If multiple mala runs share LOCK_DIR, one run can clear locks for another, enabling concurrent writes. Needs verification.\n\nScope:\n- In: only clean up locks owned by this run's agents or isolate each run with a unique LOCK_DIR; keep admin/global cleanup for manual use.\n- Out: redesigning the locking protocol.\n\nAcceptance Criteria:\n- Run cleanup leaves locks owned by other agent IDs intact.\n- Each run only removes its own locks.\n\nTest Plan:\n- TDD: add a unit test that creates lock files for two agent IDs; run cleanup and verify only matching locks are removed.\n- Run pytest for new locking/orchestrator tests.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-26T19:54:42.017640957Z","updated_at":"2025-12-26T20:40:46.158277204Z","closed_at":"2025-12-26T20:40:46.158277204Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-aht.2","depends_on_id":"mala-aht","type":"parent-child","created_at":"2025-12-26T19:54:42.026062315Z","created_by":"daemon"},{"issue_id":"mala-aht.2","depends_on_id":"mala-aht.1","type":"blocks","created_at":"2025-12-26T19:55:09.816278845Z","created_by":"daemon"}]}
{"id":"mala-aht.3","title":"Terminate bd/git subprocesses on timeout","description":"Context:\n- _run_subprocess_async wraps subprocess.run in a thread and uses asyncio.wait_for; timeouts return but the subprocess keeps running (src/beads_client.py:38-70).\n- Hanging bd/git processes can accumulate during long runs.\n\nScope:\n- In: ensure timed-out commands are terminated (e.g., pass timeout to subprocess.run and handle TimeoutExpired, or switch to asyncio subprocess and kill).\n- Out: changing bd CLI usage.\n\nAcceptance Criteria:\n- Timed-out commands are terminated and return a timeout result.\n- Timeout warnings still emit.\n\nTest Plan:\n- TDD: add a failing test mocking subprocess.run to raise TimeoutExpired and assert a safe timeout result.\n- Run pytest for BeadsClient tests.","notes":"Quality gate failed: Timeout after 30 minutes\nLog: /home/cyou/.claude/projects/-home-cyou-mala/ce7cad14-805f-4dad-856c-647c4baa772c.jsonl","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-26T19:54:51.724656053Z","updated_at":"2025-12-26T21:45:47.050205724Z","closed_at":"2025-12-26T21:45:47.050205724Z","close_reason":"Closed","labels":["needs-followup"],"dependencies":[{"issue_id":"mala-aht.3","depends_on_id":"mala-aht","type":"parent-child","created_at":"2025-12-26T19:54:51.74113736Z","created_by":"daemon"}]}
{"id":"mala-aht.4","title":"Consolidate sync/async BeadsClient implementations","description":"Context:\n- BeadsClient maintains parallel sync and async implementations for the same actions (src/beads_client.py:80 and :244).\n- This duplication risks drift and unused code; needs verification that sync APIs are still required beyond tests.\n\nScope:\n- In: consolidate shared logic or deprecate/remove sync methods if unused; update tests accordingly.\n- Out: changing bd command semantics.\n\nAcceptance Criteria:\n- One authoritative implementation per action.\n- Tests updated and passing.\n\nTest Plan:\n- Run pytest for BeadsClient/orchestrator tests.","status":"closed","priority":2,"issue_type":"chore","created_at":"2025-12-26T19:55:00.28451646Z","updated_at":"2025-12-26T22:43:14.357220042Z","closed_at":"2025-12-26T22:43:14.357220042Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-aht.4","depends_on_id":"mala-aht","type":"parent-child","created_at":"2025-12-26T19:55:00.300728599Z","created_by":"daemon"},{"issue_id":"mala-aht.4","depends_on_id":"mala-aht.3","type":"blocks","created_at":"2025-12-26T19:55:13.994459065Z","created_by":"daemon"}]}
{"id":"mala-ai5","title":"Disallow git stash and other multi-agent conflicting operations","description":"Context:\n- Multiple agents may work in the same repository concurrently.\n- Operations like git stash, git rebase -i, git reset --hard, and similar commands can cause confusion and conflicts between agents.\n- These operations modify the working tree or history in ways that are difficult for other agents to detect or recover from.\n\nScope:\n- In: Add validation/hooks to detect and block dangerous git operations in agent contexts.\n- In: Document which git operations are disallowed and why.\n- In: Consider a pre-commit hook or wrapper to enforce these restrictions.\n- Out: Does not block operations in non-agent contexts (user override possible).\n\nDisallowed Operations:\n- git stash (all subcommands) - hides changes that other agents cannot see\n- git reset --hard - discards uncommitted changes silently\n- git rebase -i - interactive rebase requires human input\n- git checkout -f / git checkout --force - discards local changes\n- git clean -f - removes untracked files without warning\n- git merge --abort / git rebase --abort - may discard other agents' work\n\nAcceptance Criteria:\n- Dangerous git operations are detected and blocked with clear error messages.\n- Agents receive guidance on safe alternatives (e.g., commit instead of stash).\n- Documentation explains the rationale and lists all blocked operations.\n- Override mechanism exists for legitimate use cases.\n\nTest Plan:\n- Unit tests verify detection of each disallowed operation.\n- Integration test confirms blocking works in agent context.\n- Test override mechanism.\n\nNotes for Agent:\n- Consider implementing as a git hook, CLI wrapper, or agent-level validation.\n- Prefer failing fast with helpful error messages over silent failures.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T23:03:09.392627299Z","updated_at":"2025-12-26T23:36:27.199636643Z","closed_at":"2025-12-26T23:36:27.199636643Z","close_reason":"Closed"}
{"id":"mala-akl","title":"mala run exit code: treat no-issue runs as success","description":"Problem: src/cli.py returns exit code 1 when success_count == 0. This makes no-op runs (no issues ready) look like failures in automation.\\n\\nScope/files: src/cli.py.\\n\\nWork:\\n- Distinguish 'no issues processed' from 'issues processed but failed'.\\n- Update exit code to 0 when there were no issues to process. Keep non-zero when actual failures occurred.\\n\\nAcceptance criteria:\\n- If no issues are ready, mala run exits 0.\\n- If issues ran and all failed, still exits non-zero.\\n- If some succeeded, exits 0.\\n\\nDependency: Avoid concurrent edits with mala-20u (same file).","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T21:38:26.013087673Z","updated_at":"2025-12-26T00:00:32.928066608Z","closed_at":"2025-12-26T00:00:32.928066608Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-akl","depends_on_id":"mala-20u","type":"blocks","created_at":"2025-12-25T21:38:51.94427495Z","created_by":"daemon"}]}
{"id":"mala-anh","title":"Refactor: split src/cli.py into focused modules","description":"Goal: Reduce the 600+ line cli module by extracting focused modules (e.g., orchestrator.py, hooks.py, prompt.py, git_utils.py). Keep external behavior unchanged.\\n\\nScope/files: src/cli.py plus new modules under src/.\\n\\nSuggested steps:\\n1) Identify pure helpers (git commit/branch, prompt loading, hook logic).\\n2) Move orchestration class to its own module.\\n3) Keep CLI wiring in cli.py, import helpers.\\n4) Update imports/tests.\\n\\nAcceptance criteria:\\n- CLI commands unchanged.\\n- No behavior changes to orchestrator loop.\\n- Tests pass (or at least no regressions).","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-25T21:40:15.520698126Z","updated_at":"2025-12-25T21:41:31.71957273Z","closed_at":"2025-12-25T21:41:31.71957273Z","close_reason":"Split into smaller refactor tasks: mala-9qr (hooks), mala-dqt (git helpers), mala-as5 (orchestrator extraction)."}
{"id":"mala-as5","title":"Refactor: move MalaOrchestrator to its own module","description":"Goal: Extract MalaOrchestrator class from src/cli.py into a dedicated module (e.g., src/orchestrator.py) to reduce file size and clarify responsibilities.\\n\\nScope/files: src/cli.py, new src/orchestrator.py.\\n\\nWork:\\n- Move IssueResult + MalaOrchestrator to new module.\\n- Adjust imports in cli.py.\\n- Keep CLI command signatures and behavior unchanged.\\n\\nAcceptance criteria:\\n- Orchestrator behavior unchanged.\\n- CLI still works.\\n- Tests (if any) still pass.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-25T21:41:26.002972067Z","updated_at":"2025-12-26T00:15:52.939703847Z","closed_at":"2025-12-26T00:15:52.939703847Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-as5","depends_on_id":"mala-dqt","type":"blocks","created_at":"2025-12-25T21:47:35.258531693Z","created_by":"daemon"},{"issue_id":"mala-as5","depends_on_id":"mala-c01","type":"parent-child","created_at":"2025-12-25T22:05:59.484296839Z","created_by":"daemon"}]}
{"id":"mala-avh","title":"Add better logging of CLI args to JSON and terminal","description":"Improve visibility into what CLI arguments were used for a mala run.\n\n## Problem\nCurrently it's hard to see what flags were passed (e.g., --disable-validations) in both:\n- Terminal output at run start\n- JSON run metadata/logs\n\n## Proposed Solution\n1. Log parsed CLI args at run start in terminal (similar to how validation commands are shown)\n2. Include full CLI args in run metadata JSON for debugging/auditing\n\n## Specific Args to Log\n- --disable-validations (which ones)\n- --coverage-threshold\n- --wip flag\n- --max-issues\n- --max-gate-retries / --max-review-retries\n- --braintrust flag\n\n## Acceptance Criteria\n- [ ] Terminal shows key CLI args at run start (dimmed/gray like other config lines)\n- [ ] Run metadata JSON includes cli_args or similar field\n- [ ] Easy to see why validations were skipped when debugging","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-27T20:22:35.103181662Z","updated_at":"2025-12-27T20:22:35.103181662Z"}
{"id":"mala-b0m","title":"Graceful shutdown with agent wrap-up","description":"## Goal\nHandle agent exit gracefully: signal active agents to wrap up, clean up partial state, and ensure consistent issue status before exit.\n\n## Problem\nWhen agents exit early (context exhaustion, error, timeout, orchestrator shutdown), they may leave:\n- Partial work uncommitted in the git working tree\n- Issue in inconsistent state (e.g., still marked as in_progress)\n- Locks held without cleanup\n\n## Current Behavior\n- Orchestrator calls `reset_issue()` which sets status back, but doesn't clean up git state\n- Partial file changes may remain uncommitted in the working tree\n- Next agent picking up the issue sees a dirty state\n\n## Proposed Solution\nOn agent exit (early or orchestrator shutdown):\n\n1. **Signal agents to wrap up**: Give active agents a chance to commit partial work or rollback cleanly\n\n2. **Reset git state**: Discard uncommitted changes for files the agent touched\n   - `git checkout -- \u003cfiles\u003e` or `git restore \u003cfiles\u003e`\n   - Consider `git clean` for new untracked files created by the agent\n   - Be careful not to discard work from other concurrent agents\n\n3. **Mark issue as open**: Use `bd update \u003cissue\u003e --status open` (not just reset to previous state)\n\n4. **Release all locks**: Ensure locks are released before git reset\n\n5. **Emit final summary**: Log what was cleaned up and issue states\n\n## Implementation Notes\n- Track which files the agent modified (from tool calls in JSONL log)\n- Or simpler: reset only files the agent held locks for\n- Safest approach: only reset files associated with locks held by the exiting agent\n\n## Acceptance Criteria\n- Early exit leaves working tree clean (no partial changes from failed agent)\n- Orchestrator shutdown signals all agents before force-terminating\n- Issue status is set to 'open' on failure\n- Locks are released\n- Other agents' uncommitted work is not affected\n- Final summary emitted showing cleanup actions","status":"blocked","priority":4,"issue_type":"epic","created_at":"2025-12-26T00:55:42.940976936Z","updated_at":"2025-12-26T18:27:54.400792078Z"}
{"id":"mala-b8d","title":"Allow specification of thinking mode for codex","description":"Add configuration option to specify the thinking mode (e.g., high, medium, low) when using codex for reviews and other operations.","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-27T23:51:54.88471213Z","updated_at":"2025-12-27T23:51:54.88471213Z"}
{"id":"mala-bdu","title":"Enhance status command to show last messages from agents","description":"Context:\n- Status command should show what each agent is currently doing.\n- Display last N messages or current activity from each running agent.\n\nScope:\n- In: read agent logs; parse recent messages; display in status output.\n- Out: real-time streaming; TUI/dashboard.\n\nAcceptance Criteria:\n- `mala status` shows last message/activity from each active agent.\n- Clear indication of agent state (working, waiting, idle).\n- Timestamps on last activity.\n\nTest Plan:\n- Manual: run mala, check status mid-run, verify agent messages shown.\n- Unit: mock log reading and verify output format.","status":"blocked","priority":2,"issue_type":"feature","created_at":"2025-12-27T01:14:57.841683856Z","updated_at":"2025-12-27T01:15:02.152164288Z","dependencies":[{"issue_id":"mala-bdu","depends_on_id":"mala-6c0","type":"blocks","created_at":"2025-12-27T01:15:02.133910704Z","created_by":"daemon"}]}
{"id":"mala-bgl","title":"Save progress state on context exhaustion","status":"tombstone","priority":2,"issue_type":"epic","created_at":"2025-12-26T00:55:42.565812819Z","updated_at":"2025-12-26T00:56:32.19480344Z","deleted_at":"2025-12-26T00:56:32.19480344Z","deleted_by":"daemon","delete_reason":"delete","original_type":"epic"}
{"id":"mala-buj","title":"Remove unused sync git functions","description":"## Context\n- `get_git_commit()` and `get_git_branch()` (sync versions) are defined but never called\n- Only async versions (`get_git_commit_async`, `get_git_branch_async`) are used by orchestrator\n- ~30 lines of dead code\n- Confidence: High - grep confirms no callers\n\n## Primary Files\n`src/git_utils.py:14-45`\n\n## Scope\n**In:** Remove `get_git_commit` and `get_git_branch` sync functions\n**Out:** Keep async versions and `DEFAULT_GIT_TIMEOUT` constant\n\n## Acceptance Criteria\n- Sync functions removed\n- No import errors\n- Tests pass\n\n## Test Plan\n- Run `uv run pytest`\n- Verify module imports cleanly: `python -c \"from src.git_utils import get_git_commit_async\"`\n\n## Notes for Agent\n- Keep the module docstring and async functions intact\n- The sync functions are lines 14-45, async are 51-100","status":"closed","priority":2,"issue_type":"chore","created_at":"2025-12-26T19:44:58.439537512Z","updated_at":"2025-12-26T19:52:03.649089915Z","closed_at":"2025-12-26T19:52:03.649089915Z","close_reason":"Closed","labels":["dead-code"],"dependencies":[{"issue_id":"mala-buj","depends_on_id":"mala-7zq","type":"parent-child","created_at":"2025-12-26T19:45:26.554545264Z","created_by":"daemon"}]}
{"id":"mala-bvd","title":"Other Improvements","description":"General improvements:\n- Deadlock detection (two agents waiting on each other)\n- Metrics/logging for multi-agent sessions\n- Graceful shutdown (signal all agents to wrap up)","status":"tombstone","priority":2,"issue_type":"epic","created_at":"2025-12-26T00:54:39.298081197Z","updated_at":"2025-12-26T00:55:27.989133028Z","deleted_at":"2025-12-26T00:55:27.989133028Z","deleted_by":"daemon","delete_reason":"delete","original_type":"epic"}
{"id":"mala-c01","title":"Epic: CLI module refactor (split cli.py)","description":"Parent epic for refactoring src/cli.py into focused modules without changing behavior. Children: hook extraction, git helper extraction, orchestrator extraction.","status":"closed","priority":3,"issue_type":"epic","created_at":"2025-12-25T21:41:59.788032839Z","updated_at":"2025-12-26T00:15:59.835213834Z","closed_at":"2025-12-26T00:15:59.835213834Z","close_reason":"All children completed"}
{"id":"mala-c01.1","title":"Refactor: extract beads client from cli.py","description":"Goal: Extract beads-related logic from MalaOrchestrator into a dedicated BeadsClient class (e.g., src/beads_client.py) that wraps bd CLI calls.\n\nScope/files: src/cli.py, new src/beads_client.py.\n\nWork:\n- Create BeadsClient class with methods: get_ready_issues(), claim_issue(), reset_issue(), commit_issues(), close_eligible_epics().\n- Move bd CLI subprocess calls from MalaOrchestrator to BeadsClient.\n- Have MalaOrchestrator use BeadsClient instance.\n- Keep CLI behavior unchanged.\n\nAcceptance criteria:\n- All bd CLI calls go through BeadsClient.\n- MalaOrchestrator behavior unchanged.\n- CLI still works.\n- Tests (if any) still pass.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-25T22:15:22.761330846Z","updated_at":"2025-12-26T00:09:17.45761968Z","closed_at":"2025-12-26T00:09:17.45761968Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-c01.1","depends_on_id":"mala-c01","type":"parent-child","created_at":"2025-12-25T22:15:22.771293472Z","created_by":"daemon"}]}
{"id":"mala-c1o","title":"Implement coverage parsing + threshold handling","description":"Context:\n- Coverage gate requires parsing pytest coverage output and enforcing thresholds.\n- Plan uses XML + min-percent thresholds.\n\nScope:\n- In: parse coverage XML and return CoverageResult; handle threshold comparison and error reporting.\n- Out: orchestrator gating logic (separate task).\n\nAcceptance Criteria:\n- CoverageResult includes percent, pass/fail, report path.\n- Parser handles missing/invalid report with clear failure reason.\n\nTest Plan:\n- TDD: add unit tests with fixture XMLs for pass/fail/invalid.\n- Run coverage module tests.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T23:00:01.67857076Z","updated_at":"2025-12-27T00:03:14.562228529Z","closed_at":"2025-12-27T00:03:14.562228529Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-c1o","depends_on_id":"mala-j6p","type":"blocks","created_at":"2025-12-26T23:00:26.478117705Z","created_by":"daemon"}]}
{"id":"mala-c5n","title":"Replace exponential backoff with simple 1s polling for lock waits","description":"## Problem\nThe implementer prompt instructs agents to use exponential backoff (10s, 20s, 40s, 80s, 160s, 320s, 640s) when waiting for locks. This has two issues:\n\n1. **Noisy logs**: Agents print a message every time they sleep, cluttering output\n2. **Over-engineering**: Exponential backoff adds complexity; a simple 1-second polling loop is simpler and equally effective for file locks\n\n## Current Behavior\nFrom src/prompts/implementer_prompt.md:53:\n```\n- Use exponential backoff: 10s, 20s, 40s, 80s, 160s, 320s, 640s (max 15 min total)\n```\n\n## Proposed Solution\n\nOption A: Add a helper script (e.g., `scripts/lock-wait.sh`) that:\n- Takes a file path and agent ID\n- Polls every 1 second until lock is available\n- Prints status only once at start and once when acquired\n- Agent calls this instead of implementing backoff loop\n\nOption B: Update prompt to use simpler guidance:\n- Replace exponential backoff with 'poll every 1 second'\n- Tell agent not to print on every poll, just when starting and when acquired\n\n## Acceptance Criteria\n- Agents no longer spam logs while waiting for locks\n- Lock waiting behavior is simple (1s fixed interval)\n- Either via helper script or updated prompt guidance","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T17:07:53.583339508Z","updated_at":"2025-12-26T17:16:00.837069817Z","closed_at":"2025-12-26T17:16:00.837069817Z","close_reason":"Closed"}
{"id":"mala-cdw","title":"Context Exhaustion Handling","description":"When agents run out of context mid-implementation:\n- Detect context exhaustion (agent returns incomplete)\n- Save progress state (files modified, locks held)\n- Spawn continuation agent with summary of prior work\n- Or: commit partial progress, mark issue as needs-continuation","status":"tombstone","priority":2,"issue_type":"epic","created_at":"2025-12-26T00:54:39.236980254Z","updated_at":"2025-12-26T00:55:27.98871018Z","deleted_at":"2025-12-26T00:55:27.98871018Z","deleted_by":"daemon","delete_reason":"delete","original_type":"epic"}
{"id":"mala-cee","title":"Fix issues from latest code review","description":"Address findings from the code review performed earlier in this chat on December 27, 2025. Use the review notes as source of truth; update tests/docs as needed.","status":"tombstone","priority":1,"issue_type":"task","created_at":"2025-12-27T22:37:11.106607746Z","updated_at":"2025-12-27T22:37:34.674838686Z","deleted_at":"2025-12-27T22:37:34.674838686Z","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"mala-cij","title":"Extend ValidationRunner for spec + artifacts","description":"Context:\n- ValidationRunner must execute ValidationSpec commands, capture artifacts, and call coverage/e2e.\n- Needs to respect mutex usage and per-scope settings.\n\nScope:\n- In: extend runner to accept ValidationSpec + ValidationContext; execute commands with logging; integrate worktree, coverage, and e2e; produce ValidationResult and artifacts.\n- Out: orchestrator gating decisions (separate task).\n\nAcceptance Criteria:\n- Runner executes command list in order with proper env/mutex.\n- Artifacts (stdout/stderr paths, worktree_state, coverage_report) recorded.\n- Failures are reported with actionable reasons.\n\nTest Plan:\n- TDD: add unit tests with mocked command execution and failure paths.\n- Run validation runner tests.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T23:00:01.70404142Z","updated_at":"2025-12-27T00:56:15.341249871Z","closed_at":"2025-12-27T00:56:15.341249871Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-cij","depends_on_id":"mala-j6p","type":"blocks","created_at":"2025-12-26T23:00:26.500543494Z","created_by":"daemon"},{"issue_id":"mala-cij","depends_on_id":"mala-5us","type":"blocks","created_at":"2025-12-26T23:00:26.511968732Z","created_by":"daemon"},{"issue_id":"mala-cij","depends_on_id":"mala-252","type":"blocks","created_at":"2025-12-26T23:00:26.523608608Z","created_by":"daemon"},{"issue_id":"mala-cij","depends_on_id":"mala-c1o","type":"blocks","created_at":"2025-12-26T23:00:26.535378832Z","created_by":"daemon"},{"issue_id":"mala-cij","depends_on_id":"mala-4dh","type":"blocks","created_at":"2025-12-26T23:00:26.547116107Z","created_by":"daemon"}]}
{"id":"mala-d3t","title":"Update orchestrator coverage_threshold type","description":"Context:\n- `MalaOrchestrator.__init__` accepts `coverage_threshold: float = 85.0`\n- Need to update type to `float | None = None` to match CLI\n\nScope:\n- In: Change `coverage_threshold` parameter type to `float | None = None`\n- Out: Any logic changes (just type signature update)\n\nAcceptance Criteria:\n- Orchestrator accepts None for coverage_threshold\n- Type hints updated\n- Passes value through to ValidationSpec correctly\n\nTest Plan:\n- Verify orchestrator instantiation with None works\n- Verify orchestrator instantiation with float works\n\nNotes for Agent:\n- Simple signature change, no logic changes needed\n- Primary file: src/orchestrator.py","status":"tombstone","priority":1,"issue_type":"task","created_at":"2025-12-27T18:14:32.921915115Z","updated_at":"2025-12-27T18:20:40.635021365Z","labels":["orchestrator"],"dependencies":[{"issue_id":"mala-d3t","depends_on_id":"mala-kwx","type":"blocks","created_at":"2025-12-27T18:15:02.051461062Z","created_by":"daemon"}],"deleted_at":"2025-12-27T18:20:40.635021365Z","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"mala-d6x","title":"Context exhaustion handling","description":"When agents run out of context mid-implementation, handle it explicitly: detect exhaustion, save progress state (files modified, locks held), spawn a continuation agent with a summary, or commit partial progress and mark needs-continuation.","status":"blocked","priority":4,"issue_type":"epic","created_at":"2025-12-26T00:56:35.644475789Z","updated_at":"2025-12-26T15:36:54.475107527Z"}
{"id":"mala-d6x.1","title":"Detect context exhaustion in agent runs","description":"Detect when an agent run exhausts context or returns incomplete output. Emit a structured reason (e.g., context_exhausted) so the orchestrator can trigger follow-up handling without treating it as a generic failure.","status":"tombstone","priority":2,"issue_type":"task","created_at":"2025-12-26T01:14:09.957270657Z","updated_at":"2025-12-26T15:33:44.086569066Z","deleted_at":"2025-12-26T15:33:44.086569066Z","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"mala-d6x.2","title":"Persist progress snapshot on context exhaustion","description":"When context exhaustion is detected, capture a progress snapshot (modified files, locks held, agent summary, and any partial results) in a durable location so continuation can resume safely.","status":"tombstone","priority":2,"issue_type":"task","created_at":"2025-12-26T01:14:15.412064244Z","updated_at":"2025-12-26T15:33:44.086569066Z","deleted_at":"2025-12-26T15:33:44.086569066Z","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"mala-d6x.3","title":"Spawn continuation agent with prior summary","description":"After persisting a progress snapshot, spawn a continuation agent and pass a concise summary + snapshot path so it can resume work without losing context.","status":"tombstone","priority":2,"issue_type":"task","created_at":"2025-12-26T01:14:19.459225253Z","updated_at":"2025-12-26T15:33:44.086569066Z","deleted_at":"2025-12-26T15:33:44.086569066Z","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"mala-d6x.4","title":"Commit partial progress and mark needs-continuation","description":"Provide a fallback path to commit partial work on context exhaustion and mark the issue as needs-continuation (status/notes) so a future run can pick it up intentionally.","status":"tombstone","priority":2,"issue_type":"task","created_at":"2025-12-26T01:14:24.562096252Z","updated_at":"2025-12-26T15:33:44.086569066Z","deleted_at":"2025-12-26T15:33:44.086569066Z","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"mala-da4","title":"Update CoverageConfig and pytest command in spec.py","description":"Context:\n- `CoverageConfig.min_percent` currently defaults to 85.0\n- Need to change default to None (meaning \"no decrease\" mode)\n- When `coverage_threshold is None`, must add `--cov-fail-under=0` to pytest command to override pyproject.toml\n\nScope:\n- In: Change `CoverageConfig.min_percent: float = 85.0` to `min_percent: float | None = None`\n- In: Update docstring to explain None = \"no decrease\" mode\n- In: In `build_validation_spec`, when `coverage_threshold is None`, add `--cov-fail-under=0` to pytest command\n- Out: Actual baseline comparison logic (that's in spec_runner.py)\n\nAcceptance Criteria:\n- `CoverageConfig(enabled=True)` has `min_percent=None` by default\n- Pytest command includes `--cov-fail-under=0` when threshold is None\n- Pytest command includes explicit threshold when provided\n- Docstrings updated\n\nTest Plan:\n- TDD: Test default CoverageConfig has min_percent=None\n- Test `build_validation_spec()` with no threshold  pytest includes `--cov-fail-under=0`\n- Test `build_validation_spec(coverage_threshold=80)`  pytest includes `--cov-fail-under=80`\n\nNotes for Agent:\n- The `--cov-fail-under=0` is needed to override pyproject.toml's `--cov-fail-under=85`\n- Keep existing coverage-related pytest flags (`--cov=src`, etc.)\n- Primary files: src/validation/spec.py, tests/test_spec.py","status":"tombstone","priority":1,"issue_type":"task","created_at":"2025-12-27T18:13:57.436716865Z","updated_at":"2025-12-27T18:20:40.633815335Z","labels":["validation"],"dependencies":[{"issue_id":"mala-da4","depends_on_id":"mala-wg1","type":"blocks","created_at":"2025-12-27T18:15:01.997067804Z","created_by":"daemon"}],"deleted_at":"2025-12-27T18:20:40.633815335Z","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"mala-db2","title":"Segment run logs into per-repo directories","description":"## Problem\n\nCurrently all mala run metadata is stored in a flat directory (`~/.config/mala/runs/*.json`). As the tool is used across multiple repositories, this becomes hard to navigate and correlate.\n\n## Desired Behavior\n\nSegment logs into directories by repo, similar to how `.claude/projects/` segments by project path:\n\n```\n~/.config/mala/runs/\n -home-cyou-mala/\n    2024-12-27T10-30-00_abc123.json\n    2024-12-27T11-45-00_def456.json\n -home-cyou-other-repo/\n    2024-12-28T09-00-00_ghi789.json\n    ...\n ...\n```\n\n### Key changes:\n1. **Directory naming**: Convert repo path to safe directory name (replace `/` with `-`, similar to `.claude`)\n2. **File naming**: Use `{iso-timestamp}_{short-uuid}.json` for easier sorting and identification\n3. **Backward compat**: On startup, optionally migrate existing flat files to new structure (or leave them)\n\n## Implementation\n\n**Files:**\n- `src/tools/env.py`: Add helper to compute repo-specific runs directory\n- `src/logging/run_metadata.py`: Update `save()` to use repo-segmented path\n\n### 1. Add path helper in `src/tools/env.py`:\n\n```python\ndef get_repo_runs_dir(repo_path: Path) -\u003e Path:\n    \"\"\"Get runs directory segmented by repo path.\n    \n    Converts /home/cyou/mala -\u003e -home-cyou-mala\n    \"\"\"\n    # Resolve and convert to safe directory name\n    safe_name = str(repo_path.resolve()).replace('/', '-').lstrip('-')\n    return get_runs_dir() / safe_name\n```\n\n### 2. Update RunMetadata.save() in `src/logging/run_metadata.py`:\n\n```python\ndef save(self) -\u003e Path:\n    self.completed_at = datetime.now(UTC)\n    # Use repo-specific subdirectory\n    runs_dir = get_repo_runs_dir(self.repo_path)\n    runs_dir.mkdir(parents=True, exist_ok=True)\n    \n    # Use timestamp + short UUID for filename\n    timestamp = self.started_at.strftime('%Y-%m-%dT%H-%M-%S')\n    short_id = self.run_id[:8]\n    path = runs_dir / f\"{timestamp}_{short_id}.json\"\n    \n    with open(path, 'w') as f:\n        json.dump(self._to_dict(), f, indent=2)\n    return path\n```\n\n## Acceptance Criteria\n\n- [ ] Run logs are saved to `~/.config/mala/runs/{repo-safe-name}/` directories\n- [ ] Filenames include timestamp for easy sorting\n- [ ] Existing flat-file runs continue to work (no migration required initially)\n- [ ] Tests updated for new path structure\n\n## Test Plan\n\n- Add unit tests for `get_repo_runs_dir` path conversion\n- Update RunMetadata tests to verify new save location\n- Manual: run mala in two different repos, verify separate directories created","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-27T22:51:29.556789345Z","updated_at":"2025-12-27T22:51:29.556789345Z"}
{"id":"mala-dqp","title":"Fix lock enforcement canonicalization","description":"Context:\n- Hook lock checks use repo-relative hashing, but current canonicalization can diverge from lock scripts when mala is launched outside the repo.\n- This can cause false \"not locked\" blocks or allow writes without a matching lock.\n- The unused lock hook duplicates logic and risks drift.\n- Needs verification: reproduce mismatch by running from a non-repo cwd.\n\nScope:\n- In: unify path canonicalization between shell scripts and Python hook (use repo namespace consistently), pass repo path into lock enforcement, remove redundant hook, and ensure LOCK_DIR mkdir uses parents=True.\n- Out: redesigning the locking model or changing lock script behavior beyond canonicalization.\n\nAcceptance Criteria:\n- A lock acquired via lock-try.sh is recognized by the PreToolUse hook even when mala is launched from outside the repo.\n- Hook blocks writes when another agent holds the lock and allows when the current agent holds it.\n- Redundant lock hook removed (single source of truth).\n- Nested MALA_LOCK_DIR paths start without error.\n\nTest Plan:\n- TDD: add failing test for cross-cwd lock enforcement, implement fix, then run lock integration tests.\n- Run relevant tests in tests/test_lock_sdk_integration.py and tests/test_lock_scripts.py.\n\nNotes for Agent:\n- Keep canonicalization consistent with lock-try.sh hashing; avoid changing lock key format.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-26T17:35:26.214219228Z","updated_at":"2025-12-26T18:45:48.051480297Z","closed_at":"2025-12-26T18:45:48.051480297Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-dqp","depends_on_id":"mala-jnq","type":"parent-child","created_at":"2025-12-26T17:36:15.673575659Z","created_by":"daemon"}]}
{"id":"mala-dqt","title":"Refactor: extract git helper functions","description":"Goal: Move git helper(s) from src/cli.py (e.g., get_git_commit) into a small utility module (e.g., src/git_utils.py).\\n\\nScope/files: src/cli.py, new src/git_utils.py.\\n\\nWork:\\n- Move get_git_commit (and any related helpers if needed).\\n- Update imports in cli.py.\\n- Keep behavior unchanged.\\n\\nAcceptance criteria:\\n- Same git commit info used in metadata.\\n- No behavior changes to CLI.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-25T21:41:18.022578128Z","updated_at":"2025-12-26T00:11:10.071338973Z","closed_at":"2025-12-26T00:11:10.071338973Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-dqt","depends_on_id":"mala-9qr","type":"blocks","created_at":"2025-12-25T21:47:31.302567088Z","created_by":"daemon"},{"issue_id":"mala-dqt","depends_on_id":"mala-c01","type":"parent-child","created_at":"2025-12-25T22:05:59.473063215Z","created_by":"daemon"}]}
{"id":"mala-dyt","title":"Improve tool call formatting with better colors and code pretty-printing","description":"## Goal\n1. **All tools**: Skip \"args:\" prefix and JSON brackets, use `key: value` format with distinct colors\n2. **Edit tools**: Pretty-print code fields with actual newlines and distinct coloring\n3. **CLI flag**: Change `--no-truncate` to `--verbose` / `-v`\n\n## Current output\n```\n  [mala-e47]  mcp__morphllm__edit_file\n    args:\n    {\n      \"path\": \"/home/cyou/mala/tests/test_orchestrator.py\",\n      \"code_edit\": \"    @pytest.mark.asyncio\\n    async def...\"\n    }\n```\n\n## Desired output\n```\n  [mala-e47]  mcp__morphllm__edit_file\n    path: /home/cyou/mala/tests/test_orchestrator.py     \u003c- key=CYAN, value=WHITE\n    instruction: Update mock_get_ready signature...\n    code_edit:                                           \u003c- key=CYAN\n        @pytest.mark.asyncio                             \u003c- code=GRAY/dim\n        async def test_success...\n```\n\n## Files to modify\n- `src/cli.py` - rename flag from --no-truncate to --verbose/-v\n- `src/logging/console.py` - formatting logic\n\n## Implementation\n1. Rename CLI flag to --verbose/-v\n2. Define constants for edit tool detection and code fields\n3. Rewrite _format_arguments() for key:value format with colors\n4. For edit tools, expand code fields with actual newlines\n5. Remove \"args:\" prefix from output","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T19:08:00.801228302Z","updated_at":"2025-12-26T19:14:26.272944778Z","closed_at":"2025-12-26T19:14:26.272944778Z","close_reason":"Closed"}
{"id":"mala-e0i","title":"Update RunMetadata for validation results + IssueResolution","description":"Context:\n- Run metadata should record per-issue validation outcomes and artifacts for observability.\n- Plan adds IssueResolution and validation results to metadata.\n\nScope:\n- In: extend RunMetadata schema to include per-issue ValidationResult/Artifacts and IssueResolution; add run-level validation result fields.\n- Out: CLI output formatting (separate concern).\n\nAcceptance Criteria:\n- RunMetadata persists new fields without breaking existing readers.\n- Serialization handles optional fields cleanly.\n\nTest Plan:\n- Add unit tests for metadata serialization/deserialization.\n- Run logging module tests.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T23:00:01.729378301Z","updated_at":"2025-12-27T00:31:03.493814554Z","closed_at":"2025-12-27T00:31:03.493814554Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-e0i","depends_on_id":"mala-5us","type":"blocks","created_at":"2025-12-26T23:00:26.569756144Z","created_by":"daemon"}]}
{"id":"mala-e47","title":"Update orchestrator tests for get_ready signature and max_agents default","description":"Tests currently mock get_ready without the new suppress_warn_ids param and still assert max_agents==3 even though default is now unlimited (None). Update tests to match current behavior and avoid TypeError.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T15:34:00.738271737Z","updated_at":"2025-12-26T18:42:41.370094167Z","closed_at":"2025-12-26T18:42:41.370094167Z","close_reason":"Closed"}
{"id":"mala-f69","title":"Default to unlimited concurrent agents","description":"Goal: Change the default for --max-agents/-n to unlimited (no cap on concurrent agents).\n\nCurrent behavior: max_agents defaults to 3, limiting concurrent agent execution.\n\nDesired behavior: By default, spawn as many agents as there are ready issues. Users can still use --max-agents to set a limit if needed.\n\nScope/files: src/cli.py, src/orchestrator.py.\n\nWork:\n- Change max_agents default from 3 to None (unlimited).\n- Update orchestrator logic to handle None as 'spawn all ready issues'.\n- Update help text to reflect new default.\n\nAcceptance criteria:\n- 'mala run' with no flags spawns agents for all ready issues.\n- 'mala run --max-agents 3' limits to 3 concurrent agents.\n- Logging/status output reflects unlimited when no cap set.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T00:18:53.28766291Z","updated_at":"2025-12-26T00:50:20.634125479Z","closed_at":"2025-12-26T00:50:20.634125479Z","close_reason":"Closed"}
{"id":"mala-fih","title":"Claude orchestrator with manual context management","description":"Add back a Claude-based orchestrator that manually manages context windows (non-MCP), for long-running tasks that exceed default context limits.","status":"blocked","priority":4,"issue_type":"epic","created_at":"2025-12-26T00:55:42.188094716Z","updated_at":"2025-12-26T15:36:54.477549316Z"}
{"id":"mala-g3h","title":"Epic: Focus mode prioritization (epic-grouped ordering)","description":"Context:\n- Currently tasks are ordered by priority only, causing interleaved commits across unrelated epics\n- This makes PR reviews difficult as changes span multiple unrelated features\n- Need epic-grouped ordering as the default: finish one epic before starting the next\n- Orphan tasks (no parent epic) compete by their own priority\n\nScope:\n- In: New `--focus/--no-focus` CLI flag (default True), epic-grouped ordering algorithm, parent epic lookup\n- Out: Changes to how epics themselves are prioritized or closed\n\nAcceptance Criteria:\n- Default behavior groups tasks by epic, finishing one before starting another\n- `--no-focus` reverts to priority-only interleaved ordering\n- Orphan tasks compete with epic groups by min priority\n- Tiebreaker for equal-priority groups: most recently updated first\n\nPrimary files: src/beads_client.py, src/cli.py, src/orchestrator.py","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-27T18:14:07.040578765Z","updated_at":"2025-12-27T18:14:07.040578765Z"}
{"id":"mala-g3h.1","title":"BeadsClient: add parent epic lookup methods","description":"Context:\n- Need to determine parent epic for each task to enable grouping\n- `bd dep tree \u003cid\u003e --direction=down` returns parent chain (epic at depth=1)\n- Should cache results to avoid repeated subprocess calls for tasks in same epic\n\nScope:\n- In: Add `get_parent_epic_async(issue_id) -\u003e str | None` method to BeadsClient\n- In: Add batch method `get_parent_epics_async(issue_ids) -\u003e dict[str, str | None]` for efficiency\n- Out: Changes to existing `get_ready_async` signature (handled in later issue)\n\nAcceptance Criteria:\n- `get_parent_epic_async` returns parent epic ID or None for orphans\n- Batch method minimizes subprocess calls (one call per unique epic, not per task)\n- Method handles errors gracefully (returns None on failure)\n\nTest Plan:\n- Add unit tests with mocked subprocess calls\n- Test orphan detection (no parent epic)\n- Test caching behavior\n\nNotes for Agent:\n- Use existing `_run_subprocess_async` pattern\n- Epic is identified by `issue_type == \"epic\"` at depth \u003e 0 in tree output\n\nPrimary files: src/beads_client.py","notes":"Quality gate failed: Codex review failed: N/A:0: Missing scope item: Add batch method `get_parent_epics_async(issue_ids) -\u003e dict[str, str | None]` for efficiency  current implementation makes one subprocess call per issue and provides no caching or epic-level reuse, so it does not minimize calls per unique epic as required.; src/beads_client.py:0: Acceptance criterion unmet: Batch method minimizes subprocess calls (one call per unique epic, not per task)  `get_parent_epics_async` always calls `get_parent_epic_async` for every issue (no cache or shared lookup), so repeated tasks under the same epic still incur repeated subprocess calls.\nLog: /home/cyou/.claude/projects/-home-cyou-mala/f8ea7fdd-e1ed-420b-82f7-41ae08fccb3f.jsonl","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-27T18:19:30.185666573Z","updated_at":"2025-12-28T01:05:50.928479045Z","closed_at":"2025-12-28T01:05:50.928479045Z","close_reason":"Closed","labels":["needs-followup"],"dependencies":[{"issue_id":"mala-g3h.1","depends_on_id":"mala-g3h","type":"parent-child","created_at":"2025-12-27T18:19:30.192508435Z","created_by":"daemon"}]}
{"id":"mala-g3h.2","title":"BeadsClient: implement epic-grouped sorting in get_ready_async","description":"Context:\n- `get_ready_async` currently sorts by `(status, priority)` with optional WIP prioritization\n- Need to add `focus` parameter that groups by parent epic before sorting by priority\n- Tiebreaker for equal-priority groups: max `updated_at` descending (recent first)\n\nScope:\n- In: Add `focus: bool = True` parameter to `get_ready_async`\n- In: Implement grouping algorithm: group by epic  sort groups by (min_priority, max_updated DESC)  sort within groups by (priority, updated DESC)\n- In: Orphan tasks form virtual group with same sorting rules\n- Out: CLI changes (separate issue)\n\nAcceptance Criteria:\n- When `focus=True`: tasks grouped by epic, one epic completed before next\n- When `focus=False`: current behavior (priority-only, interleaved)\n- WIP prioritization (`prioritize_wip`) still moves in_progress to front globally\n- Equal-priority groups ordered by most recently updated first\n\nTest Plan:\n- TDD: Add failing test for epic-grouped ordering\n- Test orphan tasks competing with epic groups\n- Test tiebreaker behavior (updated_at)\n- Test composition with `prioritize_wip`\n- Run `uv run pytest tests/test_wip_prioritization.py` (expand this file or create new)\n\nNotes for Agent:\n- Use `get_parent_epics_async` from previous issue for batch lookup\n- Issues from `bd ready --json` include `updated_at` field\n\nPrimary files: src/beads_client.py","status":"in_progress","priority":1,"issue_type":"task","created_at":"2025-12-27T18:19:46.264724796Z","updated_at":"2025-12-28T01:13:54.037250872Z","dependencies":[{"issue_id":"mala-g3h.2","depends_on_id":"mala-g3h","type":"parent-child","created_at":"2025-12-27T18:19:46.271892236Z","created_by":"daemon"},{"issue_id":"mala-g3h.2","depends_on_id":"mala-g3h.1","type":"blocks","created_at":"2025-12-27T18:20:16.400724757Z","created_by":"daemon"}]}
{"id":"mala-g3h.3","title":"CLI: add --focus/--no-focus flag for epic-grouped ordering","description":"Context:\n- Need CLI interface for the focus mode feature\n- Should be default True (epic-grouped), with `--no-focus` to revert to old behavior\n- Typer supports `--flag/--no-flag` syntax natively\n\nScope:\n- In: Add `--focus/--no-focus` flag to `run` command (default True)\n- In: Pass `focus` parameter through to orchestrator\n- In: Update help text to explain the behavior\n- Out: Changes to beads_client (already done in previous issue)\n\nAcceptance Criteria:\n- `mala run` uses epic-grouped ordering by default\n- `mala run --no-focus` uses priority-only ordering\n- Help text clearly explains the difference\n- Flag composes correctly with `--wip`\n\nTest Plan:\n- Test CLI parsing for `--focus` and `--no-focus`\n- Integration test showing different orderings\n- Run `uv run pytest tests/test_cli.py`\n\nNotes for Agent:\n- Use Typer's `--flag/--no-flag` syntax: `typer.Option(\"--focus/--no-focus\")`\n- Default value is `True`\n\nPrimary files: src/cli.py","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-27T18:19:57.722163143Z","updated_at":"2025-12-27T18:19:57.722163143Z","dependencies":[{"issue_id":"mala-g3h.3","depends_on_id":"mala-g3h","type":"parent-child","created_at":"2025-12-27T18:19:57.728621219Z","created_by":"daemon"},{"issue_id":"mala-g3h.3","depends_on_id":"mala-g3h.4","type":"blocks","created_at":"2025-12-27T18:22:11.479341622Z","created_by":"daemon"}]}
{"id":"mala-g3h.4","title":"Orchestrator: wire focus parameter through to BeadsClient","description":"Context:\n- Orchestrator receives config from CLI and passes to BeadsClient\n- Need to thread `focus` parameter through `MalaOrchestrator.__init__` and `run` method\n\nScope:\n- In: Add `focus` parameter to `MalaOrchestrator.__init__`\n- In: Pass `focus` to `beads.get_ready_async` calls in orchestrator\n- Out: CLI changes (done in previous issue), beads_client changes (done earlier)\n\nAcceptance Criteria:\n- `MalaOrchestrator` accepts `focus` parameter\n- Parameter passed correctly to all `get_ready_async` calls\n- Default behavior is focus mode enabled\n\nTest Plan:\n- Unit test orchestrator initialization with focus parameter\n- Integration test end-to-end with `--focus` and `--no-focus`\n- Run `uv run pytest tests/test_orchestrator.py`\n\nNotes for Agent:\n- Check all call sites of `get_ready_async` in orchestrator\n- Ensure consistency with existing parameter threading pattern (like `prioritize_wip`)\n\nPrimary files: src/orchestrator.py","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-27T18:20:08.198862782Z","updated_at":"2025-12-27T18:20:08.198862782Z","dependencies":[{"issue_id":"mala-g3h.4","depends_on_id":"mala-g3h","type":"parent-child","created_at":"2025-12-27T18:20:08.206662307Z","created_by":"daemon"},{"issue_id":"mala-g3h.4","depends_on_id":"mala-g3h.5","type":"blocks","created_at":"2025-12-27T18:23:43.739408416Z","created_by":"daemon"}]}
{"id":"mala-g3h.5","title":"BeadsClient: exclude tasks whose parent epic is blocked","description":"Context:\n- Currently `get_ready_async` relies on `bd ready` for blocker detection\n- But `bd ready` doesn't consider parent epic status\n- If Epic A is blocked by Epic B, tasks in Epic A still appear ready\n- This causes work to start on tasks that shouldn't be worked on yet\n\nScope:\n- In: When filtering ready tasks, check if parent epic is blocked\n- In: Exclude tasks whose parent epic has status \"blocked\" or has unmet dependencies\n- In: Use parent epic lookup from g3h.1 to get parent epic ID, then check its status\n- Out: Changes to how epic blocking works in beads itself\n\nAcceptance Criteria:\n- Tasks with a blocked parent epic do not appear in ready list\n- Tasks with an unblocked parent epic (or no parent) appear normally\n- Works correctly with focus mode enabled or disabled\n\nTest Plan:\n- TDD: Create test with mocked blocked epic, verify children excluded\n- Test orphan tasks still appear (no parent epic to block them)\n- Test task appears after parent epic unblocked\n- Run `uv run pytest tests/test_beads_client.py`\n\nNotes for Agent:\n- Can check epic status via `bd show \u003cepic_id\u003e --json`\n- Or batch check via `bd list --json` and filter\n- Consider caching epic status lookups for efficiency\n\nPrimary files: src/beads_client.py","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-27T18:23:21.585735056Z","updated_at":"2025-12-27T18:23:21.585735056Z","dependencies":[{"issue_id":"mala-g3h.5","depends_on_id":"mala-g3h","type":"parent-child","created_at":"2025-12-27T18:23:21.593215576Z","created_by":"daemon"},{"issue_id":"mala-g3h.5","depends_on_id":"mala-g3h.2","type":"blocks","created_at":"2025-12-27T18:23:43.705974665Z","created_by":"daemon"}]}
{"id":"mala-g3h.6","title":"CLI: add --dry-run flag to preview task order","description":"Context:\n- Users want to see what order tasks will be processed before actually running\n- Helps verify focus mode is working as expected\n- Useful for debugging prioritization issues\n\nScope:\n- In: Add `--dry-run` flag to `mala run` command\n- In: When set, call `get_ready_async` with current settings and display ordered task list\n- In: Show task ID, title, parent epic, priority for each task\n- In: Exit without claiming or processing any tasks\n- Out: Changes to actual task processing logic\n\nAcceptance Criteria:\n- `mala run --dry-run` outputs ordered list of tasks that would be processed\n- Output shows grouping by epic when focus mode enabled\n- Output includes task metadata (ID, title, epic, priority)\n- No tasks are claimed or modified\n- Works with all other flags (--epic, --only, --wip, --no-focus)\n\nTest Plan:\n- Test dry-run output matches actual run order\n- Test with various flag combinations\n- Test empty task list case\n- Run `uv run pytest tests/test_cli.py`\n\nNotes for Agent:\n- Consider table or tree format for output\n- Show epic headers when in focus mode to visualize grouping\n- Include count of tasks per epic\n\nPrimary files: src/cli.py","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-27T18:25:24.595986994Z","updated_at":"2025-12-27T18:25:24.595986994Z","dependencies":[{"issue_id":"mala-g3h.6","depends_on_id":"mala-g3h","type":"parent-child","created_at":"2025-12-27T18:25:24.59642406Z","created_by":"daemon"},{"issue_id":"mala-g3h.6","depends_on_id":"mala-g3h.3","type":"blocks","created_at":"2025-12-27T18:25:29.144583329Z","created_by":"daemon"}]}
{"id":"mala-ggi","title":"Add continuous run mode flag to CLI","description":"Add a run mode flag in the CLI where if there are no ready tasks, it just keeps waiting infinitely. Same behavior at the end - just keeps running until an issue is ready.\n\n## Requirements\n- Add a CLI flag (e.g., `--continuous` or `--wait`) to enable this mode\n- When enabled and no ready tasks exist, wait indefinitely instead of exiting\n- When all current tasks complete, continue waiting for new ready tasks instead of exiting\n- Poll periodically for new ready issues\n\n## Acceptance Criteria\n- [ ] New CLI flag added and documented\n- [ ] Infinite wait loop when no ready tasks\n- [ ] Continues running after completing tasks\n- [ ] Clean shutdown on interrupt (Ctrl+C)","status":"blocked","priority":2,"issue_type":"task","created_at":"2025-12-27T05:54:29.745014725Z","updated_at":"2025-12-27T05:54:36.776286443Z"}
{"id":"mala-ggx","title":"Spawn continuation agent with prior work summary","status":"tombstone","priority":2,"issue_type":"epic","created_at":"2025-12-26T00:55:42.639177056Z","updated_at":"2025-12-26T00:56:32.195175308Z","deleted_at":"2025-12-26T00:56:32.195175308Z","deleted_by":"daemon","delete_reason":"delete","original_type":"epic"}
{"id":"mala-he7","title":"Disallow git restore command","description":"The CLI should not allow the git restore command to be executed. This command can be destructive as it discards uncommitted changes without confirmation.","status":"closed","issue_type":"task","created_at":"2025-12-27T20:06:38.195974516Z","updated_at":"2025-12-27T20:57:22.04486967Z","closed_at":"2025-12-27T20:57:22.04486967Z","close_reason":"Closed"}
{"id":"mala-hro","title":"Epic: Strict-by-default validation pipeline (v5 plan)","description":"Context:\n- Implements the v5 quality-hardening plan (docs/quality-hardening-plan.md).\n- Coordinates validation modules plus orchestrator/gate integration.\n\nScope:\n- In: all child issues required to implement strict-by-default validation pipeline.\n- Out: product feature changes unrelated to validation.\n\nAcceptance Criteria:\n- All child issues closed and dependencies satisfied.\n- End-to-end validation pipeline implemented per plan.\n\nTest Plan:\n- Review child issue test plans; run full suite when integration is complete.\n\nNotes for Agent:\n- This is an umbrella epic for dependency management only.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-26T22:58:40.016961193Z","updated_at":"2025-12-27T05:57:43.092716959Z","closed_at":"2025-12-27T05:57:43.092716959Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-hro","depends_on_id":"mala-2i7","type":"blocks","created_at":"2025-12-26T23:00:26.313705147Z","created_by":"daemon"},{"issue_id":"mala-hro","depends_on_id":"mala-x00","type":"blocks","created_at":"2025-12-26T23:00:26.33116988Z","created_by":"daemon"}]}
{"id":"mala-ih0","title":"Use codex for code review","description":"Use Codex for code review: add an optional post-implementation review pass and surface findings before commit/close.","status":"closed","priority":4,"issue_type":"epic","created_at":"2025-12-26T00:55:42.345522647Z","updated_at":"2025-12-27T06:45:00.821373421Z","closed_at":"2025-12-27T06:45:00.821373421Z","close_reason":"Already implemented: Codex review exists in the validation pipeline"}
{"id":"mala-ilt","title":"Non-verbose mode: single line per tool call","description":"Add a non-verbose mode (--quiet or --verbose=false) that prints only one line per tool call for cleaner output:\n\n## Tool Output Formats\n\n| Tool | Output |\n|------|--------|\n| Read | file_path |\n| Edit | file_path |\n| Write | file_path |\n| Bash | description field |\n| Other | truncated args dict |\n\n## Implementation\n\n- Add --verbose / --quiet CLI flag (default: verbose)\n- Pass verbosity setting to logging helpers\n- Update log_tool to format output based on verbosity level\n- Keep existing verbose output as default for backwards compatibility\n\n## Acceptance Criteria\n\n- [ ] CLI accepts --verbose / --quiet flag\n- [ ] Non-verbose mode shows single line per tool call\n- [ ] File tools (Read/Edit/Write) show only file_path\n- [ ] Bash shows description field\n- [ ] Other tools show truncated args dict\n- [ ] Verbose mode (default) unchanged\n- [ ] Tests cover both modes","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-26T23:17:38.426214113Z","updated_at":"2025-12-27T09:02:44.015665617Z","closed_at":"2025-12-27T09:02:44.015665617Z","close_reason":"Closed"}
{"id":"mala-iml","title":"Widen quality gate commit window","description":"Context:\n- Quality gate only searches commits from the last 24 hours; long-running work gets flagged as failed even when commits exist.\n- Needs verification: confirm intended commit search window policy.\n\nScope:\n- In: widen or parameterize the commit search window and update related tests.\n- Out: changing validation command requirements or gate semantics beyond the commit window.\n\nAcceptance Criteria:\n- A commit older than 1 day with bd-\u003cissue_id\u003e satisfies the gate.\n- Failure message reflects the new window if no commit is found.\n\nTest Plan:\n- TDD: add a failing test for an older commit, implement the change, then run quality gate tests in tests/test_orchestrator.py.\n\nNotes for Agent:\n- Keep the log parsing behavior unchanged.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-26T17:35:48.828509883Z","updated_at":"2025-12-26T18:47:04.234602018Z","closed_at":"2025-12-26T18:47:04.234602018Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-iml","depends_on_id":"mala-jnq","type":"parent-child","created_at":"2025-12-26T17:36:15.712687221Z","created_by":"daemon"}]}
{"id":"mala-j6p","title":"Refactor validation module into package scaffolding","description":"Context:\n- Existing src/validation.py conflicts with the new validation package layout.\n- Plan introduces src/validation/ modules that must coexist cleanly.\n\nScope:\n- In: refactor src/validation.py into a package scaffold; move existing runner logic into src/validation/runner.py; add src/validation/__init__.py to preserve public imports.\n- Out: new spec/coverage/e2e logic (separate tasks).\n\nAcceptance Criteria:\n- src/validation becomes a package without import conflicts.\n- Existing ValidationRunner behavior preserved via the new module location.\n- Public imports continue to work (no breakage in current callers).\n\nTest Plan:\n- Add/adjust unit tests for validation module import path (if tests exist).\n- Run targeted tests that currently touch validation.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T23:00:01.641185848Z","updated_at":"2025-12-26T23:34:56.985031159Z","closed_at":"2025-12-26T23:34:56.985031159Z","close_reason":"Closed"}
{"id":"mala-jef","title":"Orchestrator: wire focus parameter through to BeadsClient","description":"Context:\n- Orchestrator receives config from CLI and passes to BeadsClient\n- Need to thread `focus` parameter through `MalaOrchestrator.__init__` and `run` method\n\nScope:\n- In: Add `focus` parameter to `MalaOrchestrator.__init__`\n- In: Pass `focus` to `beads.get_ready_async` calls in orchestrator\n- Out: CLI changes (done in previous issue), beads_client changes (done earlier)\n\nAcceptance Criteria:\n- `MalaOrchestrator` accepts `focus` parameter\n- Parameter passed correctly to all `get_ready_async` calls\n- Default behavior is focus mode enabled\n\nTest Plan:\n- Unit test orchestrator initialization with focus parameter\n- Integration test end-to-end with `--focus` and `--no-focus`\n- Run `uv run pytest tests/test_orchestrator.py`\n\nNotes for Agent:\n- Check all call sites of `get_ready_async` in orchestrator\n- Ensure consistency with existing parameter threading pattern (like `prioritize_wip`)\n\nPrimary files: src/orchestrator.py","status":"tombstone","priority":1,"issue_type":"task","created_at":"2025-12-27T18:14:59.07845602Z","updated_at":"2025-12-27T18:19:15.446361247Z","dependencies":[{"issue_id":"mala-jef","depends_on_id":"mala-g3h","type":"blocks","created_at":"2025-12-27T18:18:55.856283612Z","created_by":"daemon"}],"deleted_at":"2025-12-27T18:19:15.446361247Z","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"mala-jnq","title":"Epic: Code health fixes from review","description":"Goal: address high/medium issues from the code health review with minimal overlap and clear dependencies.\n\\nScope:\n- Focus on lock enforcement correctness, build packaging, Braintrust config order, quality gate robustness, async bd calls, agent loop consolidation, and repo hygiene.\n- Out: feature work or architecture redesign beyond the listed fixes.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-26T17:35:14.749720136Z","updated_at":"2025-12-26T19:32:39.518659356Z","closed_at":"2025-12-26T19:32:39.518659356Z","close_reason":"All children completed"}
{"id":"mala-jxc","title":"Enforce lock ownership in PreToolUse","description":"Context:\n- Track A2 requires a PreToolUse hook that blocks file writes unless the agent holds the lock (docs/coordination-plan-codex.md:30-32).\n- hooks currently only block dangerous commands and Morph tool usage (src/hooks.py:37-86).\n- Orchestrator registers PreToolUse hooks in run_implementer (src/orchestrator.py:145-155).\n\nScope:\n- In: add a new PreToolUse hook to detect file-write tool calls and verify lock ownership via locking helpers.\n- In: register the new hook in the orchestrator PreToolUse hook list.\n- Out: no changes to lock key generation or prompt content.\n\nAcceptance Criteria:\n- File-write tool uses are blocked when the agent does not hold the lock; allowed when it does.\n- Block reason includes the file path and current lock holder when available.\n- Orchestrator includes the new hook in PreToolUse.\n\nTest Plan:\n- TDD: add failing unit tests for hook behavior with and without locks.\n- Implement hook, update tests to pass.\n- Run uv run pytest for the new/updated hook tests.\n\nNotes for Agent:\n- Confirm tool input shapes for file paths and which tools count as writes (needs verification).","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T16:43:36.955166144Z","updated_at":"2025-12-26T17:01:31.441554529Z","closed_at":"2025-12-26T17:01:31.441554529Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-jxc","depends_on_id":"mala-4w7","type":"parent-child","created_at":"2025-12-26T16:47:52.974558844Z","created_by":"daemon"}]}
{"id":"mala-kpf","title":"Clean up file_lock shim / align lock owner format","description":"Problem: src/tools/locking.py:file_lock writes PID into lock files and src/filelock.py re-exports it, but the rest of the system uses AGENT_ID in lock files. file_lock is unused and inconsistent.\\n\\nScope/files: src/tools/locking.py, src/filelock.py (and possibly tests).\\n\\nOptions:\\n- Remove file_lock and filelock.py entirely, or\\n- Rework file_lock to use the same AGENT_ID scheme and lock keying as the scripts.\\n\\nAcceptance criteria:\\n- No dead/unused locking API left behind.\\n- If kept, file_lock uses the same lock format + keying as scripts.\\n- Tests updated if necessary.\\n\\nDependency: Must wait for lock-key hashing change (mala-4ls) because both edit src/tools/locking.py.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T21:38:08.362262314Z","updated_at":"2025-12-26T00:04:34.226695444Z","closed_at":"2025-12-26T00:04:34.226695444Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-kpf","depends_on_id":"mala-4ls","type":"blocks","created_at":"2025-12-25T21:38:46.924557872Z","created_by":"daemon"}]}
{"id":"mala-kwx","title":"Update CLI coverage-threshold option","description":"Context:\n- CLI currently has `--coverage-threshold` defaulting to 85.0\n- Need to change default to None\n- Validation logic must allow None (currently rejects non-0-100 values)\n\nScope:\n- In: Change `--coverage-threshold` default from `85.0` to `None`\n- In: Update help text to explain \"no decrease\" mode\n- In: Update validation to allow None (skip range check if None)\n- Out: Actual coverage logic (that's in coverage.py/spec_runner.py)\n\nAcceptance Criteria:\n- `--coverage-threshold` defaults to None\n- Help text mentions \"no decrease\" behavior\n- Running without `--coverage-threshold` doesn't error\n- Running with `--coverage-threshold 80` still works\n\nTest Plan:\n- Test CLI parses None default correctly\n- Test explicit threshold value works\n- Test help text is updated\n\nNotes for Agent:\n- Type should be `float | None` with default `None`\n- Skip the `0 \u003c= coverage_threshold \u003c= 100` check when None\n- Primary file: src/cli.py","status":"tombstone","priority":1,"issue_type":"task","created_at":"2025-12-27T18:14:25.299018117Z","updated_at":"2025-12-27T18:20:40.634646298Z","labels":["cli"],"dependencies":[{"issue_id":"mala-kwx","depends_on_id":"mala-da4","type":"blocks","created_at":"2025-12-27T18:15:02.03951473Z","created_by":"daemon"}],"deleted_at":"2025-12-27T18:20:40.634646298Z","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"mala-kz4","title":"Detect context exhaustion","status":"tombstone","priority":2,"issue_type":"epic","created_at":"2025-12-26T00:55:42.494971406Z","updated_at":"2025-12-26T00:56:32.189479702Z","deleted_at":"2025-12-26T00:56:32.189479702Z","deleted_by":"daemon","delete_reason":"delete","original_type":"epic"}
{"id":"mala-l7r","title":"Support epic filter for getting ready tasks","description":"Goal: Allow specifying a beads epic ID to filter ready tasks, so only tasks that are children of that epic are returned.\n\nScope/files: src/beads_client.py, src/cli.py (or src/orchestrator.py if it exists).\n\nWork:\n- Add optional epic_id parameter to BeadsClient.get_ready() method.\n- Filter returned issues to only include those with a parent-child dependency on the specified epic.\n- Add --epic CLI option to 'mala run' command to pass epic filter.\n- Update orchestrator to pass epic filter to BeadsClient.\n\nAcceptance criteria:\n- 'mala run --epic mala-c01' only processes tasks that are children of epic mala-c01.\n- Without --epic flag, behavior unchanged (all ready tasks).\n- Epic itself is still excluded from ready tasks (existing behavior).\n- Tests cover epic filter logic.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T00:17:16.892104528Z","updated_at":"2025-12-26T00:48:18.823402862Z","closed_at":"2025-12-26T00:48:18.823402862Z","close_reason":"Closed"}
{"id":"mala-lm0","title":"Refactor: extract JSONLLogger","description":"## Context\n`JSONLLogger` currently lives in `src/main.py`. It should be moved into `src/logging/jsonl.py` to isolate logging and reduce `main.py` surface area.\n\n## Scope\nCreate the new module only. Do **not** modify `src/main.py` in this issue; integration will wire it up later.\n\n### Files\n- Add: `src/logging/jsonl.py`\n\n## Requirements\n- `JSONLLogger` behavior must remain unchanged (file path, JSONL structure, timestamps, flush behavior).\n- Use the same `JSONL_LOG_DIR` constant from `src/tools/env.py` (so this issue depends on the env module existing).\n\n## Acceptance Criteria\n- `src/logging/jsonl.py` exists and matches current JSONLLogger behavior.\n- No other files are modified in this issue.\n\n## Notes\n- Integration issue will update imports in `src/main.py`.\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T19:54:51.153849001Z","updated_at":"2025-12-25T20:11:41.797668608Z","closed_at":"2025-12-25T20:11:41.797668608Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-lm0","depends_on_id":"mala-9ki","type":"blocks","created_at":"2025-12-25T20:06:47.457341927Z","created_by":"daemon"}]}
{"id":"mala-lo9","title":"Add quality gate for commits + validation evidence","description":"Context:\n- Track A4 requires verifying commit message contains bd-\u003cissue_id\u003e and that validation checks ran (docs/coordination-plan-codex.md:38-41).\n- Orchestrator currently marks success solely by bd status closed (src/orchestrator.py:180-209).\n\nScope:\n- In: add a post-run quality gate that checks for a commit message containing bd-\u003cissue_id\u003e.\n- In: verify validation commands ran by parsing JSONL logs (or by rerunning in orchestrator if needed).\n- In: on gate failure, mark needs-followup and record failure context.\n- Out: no prompt updates and no handoff file generation (A6).\n\nAcceptance Criteria:\n- Issues only count as success when closed, a matching commit exists, and validation evidence is present.\n- Gate failures record the missing evidence and apply a needs-followup marker.\n- JSONL parsing recognizes uv sync, pytest, ruff check/format, and ty check commands.\n\nTest Plan:\n- TDD: add failing tests in tests/test_orchestrator.py for pass/fail gate scenarios (mock git log + JSONL data).\n- Implement gate logic and update tests to pass.\n- Run uv run pytest tests/test_orchestrator.py.\n\nNotes for Agent:\n- Decide whether needs-followup is a bd label or status and document the choice.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T16:44:33.280391503Z","updated_at":"2025-12-26T17:10:02.788723047Z","closed_at":"2025-12-26T17:10:02.788723047Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-lo9","depends_on_id":"mala-jxc","type":"blocks","created_at":"2025-12-26T16:44:48.861098735Z","created_by":"daemon"},{"issue_id":"mala-lo9","depends_on_id":"mala-4w7","type":"parent-child","created_at":"2025-12-26T16:47:53.007870582Z","created_by":"daemon"}]}
{"id":"mala-lvw","title":"Single-threaded mode without locking","status":"blocked","priority":4,"issue_type":"epic","created_at":"2025-12-26T00:57:29.777283988Z","updated_at":"2025-12-26T15:36:54.46996311Z"}
{"id":"mala-mj8","title":"Docs: update README + Braintrust docstring to match implementation","description":"Problem: README says lock mechanism uses atomic mkdir, but scripts use hardlink+tempfile; braintrust_integration.py docstring says setup is in main.py, but it is in cli.py.\\n\\nScope/files: README.md, src/braintrust_integration.py.\\n\\nWork:\\n- Update README to reflect actual lock mechanism and current braintrust setup location.\\n- Update braintrust_integration.py docstring to refer to cli.py (or central location if changed).\\n\\nAcceptance criteria:\\n- Docs match current behavior.\\n- No functional code changes.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-25T21:38:42.843621671Z","updated_at":"2025-12-26T00:00:38.778018843Z","closed_at":"2025-12-26T00:00:38.778018843Z","close_reason":"Closed"}
{"id":"mala-mm2","title":"BeadsClient: add parent epic lookup methods","description":"Context:\n- Need to determine parent epic for each task to enable grouping\n- `bd dep tree \u003cid\u003e --direction=down` returns parent chain (epic at depth=1)\n- Should cache results to avoid repeated subprocess calls for tasks in same epic\n\nScope:\n- In: Add `get_parent_epic_async(issue_id) -\u003e str | None` method to BeadsClient\n- In: Add batch method `get_parent_epics_async(issue_ids) -\u003e dict[str, str | None]` for efficiency\n- Out: Changes to existing `get_ready_async` signature (handled in later issue)\n\nAcceptance Criteria:\n- `get_parent_epic_async` returns parent epic ID or None for orphans\n- Batch method minimizes subprocess calls (one call per unique epic, not per task)\n- Method handles errors gracefully (returns None on failure)\n\nTest Plan:\n- Add unit tests with mocked subprocess calls\n- Test orphan detection (no parent epic)\n- Test caching behavior\n\nNotes for Agent:\n- Use existing `_run_subprocess_async` pattern\n- Epic is identified by `issue_type == \"epic\"` at depth \u003e 0 in tree output\n\nPrimary files: src/beads_client.py","status":"tombstone","priority":1,"issue_type":"task","created_at":"2025-12-27T18:14:19.162836Z","updated_at":"2025-12-27T18:19:15.404812357Z","dependencies":[{"issue_id":"mala-mm2","depends_on_id":"mala-g3h","type":"blocks","created_at":"2025-12-27T18:18:55.814652214Z","created_by":"daemon"}],"deleted_at":"2025-12-27T18:19:15.404812357Z","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"mala-n0n","title":"Write failure handoff files on agent failure","description":"Context:\n- Track A6 requires writing .mala/handoff/\u003cissue_id\u003e.md with last commands and error summary (docs/coordination-plan-codex.md:47-48).\n- Orchestrator currently resets failed issues without a persistent handoff artifact (src/orchestrator.py:300-340).\n\nScope:\n- In: on agent failure (including quality gate failures), write .mala/handoff/\u003cissue_id\u003e.md with last commands and error summary.\n- In: ensure the handoff directory is created and file names are sanitized.\n- Out: do not change the quality gate logic beyond invoking handoff writer.\n\nAcceptance Criteria:\n- A handoff file is created for failed issues and contains last command(s) and an error summary.\n- File is created even when no commands are available (explicitly say so).\n- Handoff path is deterministic and safe for all issue IDs.\n\nTest Plan:\n- TDD: add failing unit test in a new tests/test_handoff.py.\n- Implement handoff writer and update tests to pass.\n- Run uv run pytest tests/test_handoff.py.\n\nNotes for Agent:\n- Prefer sourcing command history from JSONL logs to avoid missing data.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T16:44:42.712108592Z","updated_at":"2025-12-26T17:14:50.909626715Z","closed_at":"2025-12-26T17:14:50.909626715Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-n0n","depends_on_id":"mala-lo9","type":"blocks","created_at":"2025-12-26T16:44:52.444889534Z","created_by":"daemon"},{"issue_id":"mala-n0n","depends_on_id":"mala-4w7","type":"parent-child","created_at":"2025-12-26T16:47:53.018656516Z","created_by":"daemon"}]}
{"id":"mala-n28","title":"Make terminal log colors brighter","description":"## Context\nThe terminal logging colors in src/logging/console.py could be more visible, especially on dark terminal themes. Currently using ANSI bright codes (91-97) but some outputs still use DIM which reduces visibility.\n\n## Scope\n- In: Review and adjust color codes in src/logging/console.py for better visibility\n- In: Consider replacing DIM with lighter shades or removing DIM from key output\n- In: Evaluate GRAY color (currently 37) - may need brighter alternative\n- Out: Changing the logging format or structure\n\n## Files\n- src/logging/console.py\n\n## Acceptance Criteria\n- Log output is more visible on dark terminal backgrounds\n- Color choices remain distinguishable for different log types\n- Agent ID colors remain distinct when multiple agents run concurrently\n\n## Notes for Agent\n- Test with both light and dark terminal themes\n- Keep semantic color meanings (e.g., red for errors, yellow for warnings)\n- Consider using bold + color combinations for emphasis instead of DIM","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-27T17:56:31.759827685Z","updated_at":"2025-12-27T17:56:31.759827685Z"}
{"id":"mala-ng3","title":"Update EvidenceGate for scope-aware evidence + no-op","description":"Context:\n- EvidenceGate must be scope-aware and allow no-op/obsolete issues without forced commits.\n- Plan requires log markers for no-change/obsolete outcomes.\n\nScope:\n- In: update EvidenceGate to derive expected evidence from ValidationSpec per scope; parse ISSUE_NO_CHANGE/ISSUE_OBSOLETE markers with rationale; skip Gate 2/3 when applicable.\n- Out: orchestrator sequencing changes (separate task).\n\nAcceptance Criteria:\n- EvidenceGate accepts no-op/obsolete issues with clean working tree and rationale.\n- Per-issue EvidenceGate never requires E2E evidence.\n- Clear failure messages when evidence is missing.\n\nTest Plan:\n- TDD: add tests for log parsing of evidence and no-op markers.\n- Run quality_gate unit tests.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T23:00:01.716896014Z","updated_at":"2025-12-27T00:46:55.821216427Z","closed_at":"2025-12-27T00:46:55.821216427Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-ng3","depends_on_id":"mala-5us","type":"blocks","created_at":"2025-12-26T23:00:26.558341387Z","created_by":"daemon"}]}
{"id":"mala-o17","title":"Test issue: add a comment to README.md","status":"tombstone","priority":2,"issue_type":"task","created_at":"2025-12-25T18:49:43.062524854Z","updated_at":"2025-12-25T18:53:44.873613587Z","close_reason":"Closed","deleted_at":"2025-12-25T18:53:44.873613587Z","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"mala-o3z","title":"Test braintrust tracing","description":"Add a comment to the README TODOs section noting that Braintrust LLM tracing is now implemented","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T19:22:15.933197275Z","updated_at":"2025-12-25T19:23:21.922382429Z","closed_at":"2025-12-25T19:23:21.922382429Z","close_reason":"Closed"}
{"id":"mala-p6h","title":"Allow sending messages to a specific agent","description":"Context:\n- Users should be able to send instructions/messages to individual agents mid-run.\n- Enables steering agents without restarting the entire run.\n\nScope:\n- In: CLI command to send message to agent by ID; agent receives and processes message.\n- Out: bidirectional chat; agent UI.\n\nAcceptance Criteria:\n- `mala send \u003cagent-id\u003e \"message\"` delivers message to running agent.\n- Agent acknowledges receipt in its log.\n- Clear error if agent not found or not running.\n\nTest Plan:\n- Manual: run mala, send message to agent, verify it appears in agent context.\n- Unit: mock IPC mechanism.","status":"blocked","priority":2,"issue_type":"feature","created_at":"2025-12-27T01:15:17.401172887Z","updated_at":"2025-12-27T01:15:21.11931377Z","dependencies":[{"issue_id":"mala-p6h","depends_on_id":"mala-bdu","type":"blocks","created_at":"2025-12-27T01:15:21.10029576Z","created_by":"daemon"}]}
{"id":"mala-q1y","title":"Quality gate: require commit created during current run","description":"Context:\n- src/quality_gate.py: check_commit_exists() accepts any bd-\u003cissue_id\u003e commit in the last 30 days; orchestrator uses this for gating.\n- This can accept stale commits from earlier runs, allowing the gate to pass without a new commit in the current run.\n- Needs verification: reproduce by reopening an issue that already has a bd-\u003cid\u003e commit and confirm the gate passes without a new commit.\n\nScope:\n- In: capture a per-run baseline (timestamp or commit hash) and require the matching commit to be newer than that baseline; update gate/orchestrator and tests.\n- Out: changing commit message format or redesigning the retry loop.\n\nAcceptance Criteria:\n- Gate fails when only pre-run commits exist for the issue.\n- Gate passes when a new bd-\u003cissue_id\u003e commit is created after run start.\n- Tests cover stale vs new commit behavior.\n\nTest Plan:\n- TDD: add failing test(s) (tests/test_orchestrator.py or tests/test_quality_gate.py) that simulate stale commit acceptance, implement fix, run targeted pytest.\n\nNotes for Agent:\n- Baseline should be captured once per run to avoid false positives in retries.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-26T21:43:52.640540776Z","updated_at":"2025-12-26T22:52:42.793516615Z","closed_at":"2025-12-26T22:52:42.793516615Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-q1y","depends_on_id":"mala-53v","type":"blocks","created_at":"2025-12-26T21:43:58.82161634Z","created_by":"daemon"}]}
{"id":"mala-q24","title":"Pretty print tool call arguments in logs","description":"Currently log_tool() in src/logging/console.py only shows tool name and a brief description. Tool call arguments (like file paths, search patterns, etc.) are not displayed.\n\nWhen --no-truncate is used, tool arguments MUST be pretty-printed in the logs:\n- Add 'arguments' parameter to log_tool()\n- When truncation is disabled, format arguments nicely (e.g., key=value pairs)\n- Use multi-line formatting for complex nested arguments (JSON)\n- When truncation is enabled, can show abbreviated/truncated version\n\nThis ties into mala-59n which added the --no-truncate option. The full output mode should include full tool arguments for debugging.\n\nReference: src/logging/console.py:103","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T17:12:19.753573776Z","updated_at":"2025-12-26T17:16:20.717304732Z","closed_at":"2025-12-26T17:16:20.717304732Z","close_reason":"Closed"}
{"id":"mala-rsg","title":"Honor --no-truncate for completion summaries","description":"Completion log lines still hard-truncate summaries to 50 chars. Apply the global truncation setting so --no-truncate shows full completion summaries.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-26T15:34:15.335284655Z","updated_at":"2025-12-26T17:11:44.411821976Z","closed_at":"2025-12-26T17:11:44.411821976Z","close_reason":"Closed"}
{"id":"mala-rsq","title":"Refactor: split CLI into cli.py and make main.py a shim","description":"## Context\nWe will parallelize by creating new modules in separate issues, then do a single integration pass to wire everything together. This issue is the integration/wiring step.\n\n## Scope\nWire all refactor modules into the app, update tests, and make `src/main.py` a true shim. This is the **only** issue that should edit `src/main.py` and tests.\n\n### Files\n- Add: `src/cli.py`\n- Modify: `src/main.py`\n- Modify: `tests/test_lock_integration.py`\n- Modify: `tests/test_lock_sdk_integration.py`\n- Modify: any files needed to update imports/paths after the prompt move\n\n## Requirements\n- Create `src/cli.py` with the Typer app + commands currently defined in `src/main.py`.\n- Move CLI-adjacent logic out of `src/main.py` so it becomes a tiny shim that only exposes `app`.\n- Update imports to use the new modules:\n  - `src/tools/env.py`\n  - `src/logging/console.py`\n  - `src/logging/jsonl.py`\n  - `src/agent_loop.py`\n  - `src/tools/locking.py`\n- Update prompt loading to the new path: `src/prompts/implementer_prompt.md`.\n- Update tests to import from new module paths (locking + prompt template).\n- Keep `pyproject.toml` entrypoint as `src.main:app`.\n\n## TDD Guidance\n- Update tests first (imports/paths), run relevant tests:\n  - `tests/test_lock_integration.py`\n  - `tests/test_lock_sdk_integration.py`\n  - `tests/test_lock_scripts.py`\n- Then implement wiring changes and re-run the tests.\n\n## Acceptance Criteria\n- `src/main.py` is a thin shim (import + expose `app`).\n- CLI behavior is unchanged (`mala --help` identical).\n- Prompt loads from the new location.\n- Locking + prompt tests pass with updated imports.\n- All refactor modules are used by the CLI/orchestrator.\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T19:54:51.18845258Z","updated_at":"2025-12-25T20:24:59.79953084Z","closed_at":"2025-12-25T20:24:59.79953084Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-rsq","depends_on_id":"mala-9ki","type":"blocks","created_at":"2025-12-25T20:06:47.478081301Z","created_by":"daemon"},{"issue_id":"mala-rsq","depends_on_id":"mala-1by","type":"blocks","created_at":"2025-12-25T20:06:47.48915539Z","created_by":"daemon"},{"issue_id":"mala-rsq","depends_on_id":"mala-lm0","type":"blocks","created_at":"2025-12-25T20:06:47.499510627Z","created_by":"daemon"},{"issue_id":"mala-rsq","depends_on_id":"mala-wd1","type":"blocks","created_at":"2025-12-25T20:06:47.510195051Z","created_by":"daemon"},{"issue_id":"mala-rsq","depends_on_id":"mala-5aa","type":"blocks","created_at":"2025-12-25T20:06:47.520878684Z","created_by":"daemon"},{"issue_id":"mala-rsq","depends_on_id":"mala-vrm","type":"blocks","created_at":"2025-12-25T20:06:47.530900735Z","created_by":"daemon"}]}
{"id":"mala-rsy","title":"Add --wip flag to prioritize in_progress issues","description":"Add a CLI flag (--wip) to mala run that prioritizes issues with status 'in_progress' before processing 'open' issues.\n\n## Current Behavior\n- mala run processes issues from bd ready which returns both open and in_progress issues\n- No priority given to in_progress issues that may have been started but not completed\n\n## Desired Behavior\nWhen --wip flag is provided:\n1. First process all in_progress issues\n2. Then process open issues (if any slots remain)\n\nThis helps resume work that was previously started before picking up new tasks.\n\n## Implementation Notes\n- Add --wip flag to CLI (src/cli.py)\n- Modify orchestrator to filter/sort issues by status when flag is set\n- Consider: bd ready may need status filtering or sorting in get_ready()\n\n## Acceptance Criteria\n- --wip flag added to mala run\n- When set, in_progress issues are processed before open issues\n- Flag is documented in --help output\n- Unit tests cover the prioritization logic","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T00:19:15.20123002Z","updated_at":"2025-12-27T06:35:24.049205106Z","closed_at":"2025-12-27T06:35:24.049205106Z","close_reason":"Closed"}
{"id":"mala-t84","title":"Orchestrator: implement run-level validation (Gate 4) after all issues complete","description":"Context:\n- Gate 4 from docs/quality-hardening-plan.md is designed but not implemented\n- E2E tests never run because orchestrator only uses ValidationScope.PER_ISSUE\n- run_validation field in run metadata is always null\n- E2ERunner exists and works, just not wired up\n\nCurrent state:\n- spec_runner.py:258 only runs E2E when scope == ValidationScope.RUN_LEVEL\n- orchestrator.py:884 always calls validation with scope=ValidationScope.PER_ISSUE\n- run_metadata.record_run_validation() exists but is never called\n- CLI supports --disable-validations=run-level-validate but there's nothing to disable\n\nRequired changes:\n1. After all issues complete in orchestrator.run(), run validation with RUN_LEVEL scope\n2. Build spec with ValidationScope.RUN_LEVEL (includes E2E by default)\n3. Run in clean worktree at current HEAD\n4. Record results via run_metadata.record_run_validation()\n5. On failure: spawn a fixer agent in the same run to address the issues (not a follow-up issue)\n   - The fixer agent gets the validation failure output as context\n   - Re-run Gate 4 after fixer completes\n   - Retry loop with max attempts (e.g., max_gate_retries)\n   - Only fail the run after retries exhausted\n\nWhy spawn in same run (not follow-up issue):\n- Follow-up issues can be missed due to --epic-id, --only-ids, --max-issues filters\n- Guarantees the validation failure is addressed before run completes\n- Matches user expectation of \"spawns another agent to fix any issues\"\n\nAcceptance criteria:\n- E2E tests run after all issues complete (when not disabled)\n- run_validation populated in run metadata JSON\n- --disable-validations=run-level-validate skips Gate 4\n- --disable-validations=e2e skips just E2E within Gate 4\n- On Gate 4 failure: fixer agent spawned with failure context\n- Fixer agent attempts to fix issues, then Gate 4 re-runs\n- Retry loop respects max attempts before failing run\n- Run exits non-zero only after retries exhausted\n\nTest plan:\n- Unit test: orchestrator calls run-level validation after issues complete\n- Unit test: run_validation recorded in metadata\n- Unit test: disable flags respected\n- Unit test: fixer agent spawned on Gate 4 failure\n- Unit test: retry loop respects max attempts\n- Integration: full run with E2E passing\n- Integration: E2E failure triggers fixer and retry\n","notes":"Quality gate failed: Quality gate failed: Missing validation commands: ruff format, ruff check, pytest, ty check, uv sync; No progress: commit unchanged and no new validation evidence\nLog: /home/cyou/.claude/projects/-home-cyou-mala/eeea6f46-b9c3-46c1-a617-3b63df0a48d1.jsonl","status":"closed","issue_type":"task","created_at":"2025-12-27T19:37:38.163794008Z","updated_at":"2025-12-27T23:17:19.540957371Z","closed_at":"2025-12-27T23:17:19.540960361Z","labels":["needs-followup"]}
{"id":"mala-tci","title":"Update README for new CLI defaults and flags","description":"README still shows max-agents default as 3 and doesn't document --epic, --only, or --no-truncate. Update usage + CLI options table to reflect current behavior (unlimited max-agents by default).","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-26T15:34:30.211575764Z","updated_at":"2025-12-26T18:40:12.900416446Z","closed_at":"2025-12-26T18:40:12.900416446Z","close_reason":"Closed"}
{"id":"mala-u1w","title":"Test: tiny README change","status":"tombstone","priority":2,"issue_type":"task","created_at":"2025-12-25T19:05:18.089001881Z","updated_at":"2025-12-25T19:08:44.858511785Z","close_reason":"Closed","deleted_at":"2025-12-25T19:08:44.858511785Z","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"mala-vdf","title":"Offload bd/git calls from async loop","description":"Context:\n- Orchestrator uses blocking subprocess calls via BeadsClient inside the async loop, which can stall other agent tasks.\n- Needs verification: confirm bd/git commands can hang long enough to impact agent receive loops.\n\nScope:\n- In: move bd/git calls used in the orchestrator loop to async-friendly execution (asyncio.to_thread or async subprocess) with timeouts; update orchestrator to await these calls.\n- Out: replacing the bd CLI or changing issue selection logic.\n\nAcceptance Criteria:\n- Slow or hanging bd commands do not block other agent tasks.\n- Timeouts are handled with clear warnings and safe fallback behavior.\n\nTest Plan:\n- TDD: add a test that simulates a slow bd command, implement async/offload behavior, then run orchestrator tests.\n\nNotes for Agent:\n- Keep the public BeadsClient API consistent unless updating call sites in orchestrator.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T17:35:56.818359351Z","updated_at":"2025-12-26T18:58:44.392606409Z","closed_at":"2025-12-26T18:58:44.392606409Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-vdf","depends_on_id":"mala-jnq","type":"parent-child","created_at":"2025-12-26T17:36:15.723438514Z","created_by":"daemon"},{"issue_id":"mala-vdf","depends_on_id":"mala-dqp","type":"blocks","created_at":"2025-12-26T17:36:21.612596465Z","created_by":"daemon"}]}
{"id":"mala-ved","title":"Ensure logs are written incrementally during execution","description":"Context:\n- Logs should be flushed/written as events happen, not buffered until exit.\n- Currently if mala is interrupted or crashes, log data may be lost.\n\nScope:\n- In: review log writing code paths; ensure flush after each log entry or batch.\n- Out: log format changes; new log destinations.\n\nAcceptance Criteria:\n- JSONL logs are written incrementally (fsync or flush after writes).\n- Interrupting mala mid-run preserves all logs up to that point.\n- No significant performance regression from flush frequency.\n\nTest Plan:\n- Manual: start a run, kill -9 mid-execution, verify logs are complete up to kill point.\n- Unit: mock file ops to verify flush calls.","status":"blocked","priority":2,"issue_type":"bug","created_at":"2025-12-27T01:09:55.08491113Z","updated_at":"2025-12-27T01:12:08.500440376Z"}
{"id":"mala-vrm","title":"Refactor: move implementer prompt to src/prompts/","description":"## Context\nThe implementer prompt lives at `src/implementer_prompt.md`. The proposed structure puts prompts under `src/prompts/`.\n\n## Scope\nMove the prompt file only. Do **not** update loaders or tests in this issue; integration will wire it up later.\n\n### Files\n- Move: `src/implementer_prompt.md`  `src/prompts/implementer_prompt.md`\n\n## Requirements\n- Prompt content must be unchanged after move.\n\n## Acceptance Criteria\n- File exists at `src/prompts/implementer_prompt.md` with identical content.\n- No other files are modified in this issue.\n\n## Notes\n- Integration issue will update imports/tests referencing `IMPLEMENTER_PROMPT_TEMPLATE`.\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T19:54:51.200086139Z","updated_at":"2025-12-25T20:08:18.586126987Z","closed_at":"2025-12-25T20:08:18.586126987Z","close_reason":"Closed"}
{"id":"mala-w8w","title":"Epic: Code health fixes from 2025-12-26 review","description":"Context:\n- Umbrella epic for code health findings from the 2025-12-26 review.\n- Groups small fixes in orchestrator startup, validation runner robustness, and repo hygiene.\n\nScope:\n- In: child issues addressing specific review findings.\n- Out: larger validation pipeline refactors and new feature work.\n\nAcceptance Criteria:\n- All child issues are closed.\n\nTest Plan:\n- Covered by each child issue.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-26T23:06:47.086956645Z","updated_at":"2025-12-27T09:03:57.370866039Z","closed_at":"2025-12-27T09:03:57.370866039Z","close_reason":"All children completed"}
{"id":"mala-w8w.1","title":"Orchestrator startup: preserve env + create nested lock dir","description":"Context:\n- Needs verification: ClaudeAgentOptions may treat env as a full replacement, which can drop required vars when tools run.\n- agent_env is built in src/orchestrator.py:281 without inheriting os.environ.\n- LOCK_DIR is created in src/orchestrator.py:669 without parents=True, which fails for nested MALA_LOCK_DIR paths.\n\nScope:\n- In: merge os.environ into agent_env and ensure LOCK_DIR mkdir uses parents=True.\n- Out: changes to permission modes, hook behavior, or tool restrictions.\n\nAcceptance Criteria:\n- Agent tool calls see inherited env vars plus lock overrides (PATH/LOCK_DIR/AGENT_ID/REPO_NAMESPACE).\n- Orchestrator startup succeeds when MALA_LOCK_DIR points to a nested, non-existent directory.\n- Behavior of lock scripts and PATH resolution remains unchanged.\n\nTest Plan:\n- TDD: add failing test(s) in tests/test_orchestrator.py for env inheritance and nested lock dir creation.\n- Implement the fix, then run uv run pytest tests/test_orchestrator.py.\n\nNotes for Agent:\n- If SDK already merges envs, document/verify and keep behavior explicit.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-26T23:06:57.435746036Z","updated_at":"2025-12-27T07:06:35.564633929Z","closed_at":"2025-12-27T07:06:35.564633929Z","close_reason":"Closed","labels":["needs-verification"],"dependencies":[{"issue_id":"mala-w8w.1","depends_on_id":"mala-w8w","type":"parent-child","created_at":"2025-12-26T23:06:57.442345813Z","created_by":"daemon"}]}
{"id":"mala-w8w.2","title":"ValidationRunner robustness: handle timeout text + valid E2E flags","description":"Context:\n- _run_command decodes TimeoutExpired stdout/stderr as bytes in src/validation.py:194, which can raise if they are already strings.\n- _run_e2e builds a mala run command with --no-post-validate/--no-e2e in src/validation.py:235, but these flags are not in the CLI.\n\nScope:\n- In: make timeout handling robust for str/bytes outputs; remove or replace unsupported flags in the E2E command.\n- Out: implementing the broader validation pipeline plan or new CLI flags beyond whats needed for compatibility.\n\nAcceptance Criteria:\n- Timeout handling never raises when TimeoutExpired outputs are strings.\n- E2E command uses only supported CLI flags.\n- Existing validation behavior (exit codes, stderr/stdout tailing) is preserved.\n\nTest Plan:\n- TDD: add failing tests in tests/test_validation.py for string TimeoutExpired outputs and E2E command construction.\n- Implement fixes, then run uv run pytest tests/test_validation.py.\n\nNotes for Agent:\n- Keep changes localized to validation.py and its tests.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-26T23:07:13.48342038Z","updated_at":"2025-12-27T06:19:26.498789919Z","closed_at":"2025-12-27T06:19:26.498789919Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-w8w.2","depends_on_id":"mala-w8w","type":"parent-child","created_at":"2025-12-26T23:07:13.489971047Z","created_by":"daemon"}]}
{"id":"mala-w8w.3","title":"Remove dist artifacts and ignore dist/ outputs","description":"Context:\n- dist/ contains built artifacts (wheel/tarball) that can go stale and confuse releases.\n- Repo currently lacks a .gitignore entry for dist/ (file does not exist in tree).\n\nScope:\n- In: remove tracked dist artifacts and add dist/ to .gitignore.\n- Out: build system changes or release automation updates.\n\nAcceptance Criteria:\n- dist/ artifacts are removed from git history (tracked files deleted).\n- .gitignore includes dist/ to prevent reintroduction.\n\nTest Plan:\n- None (file cleanup only).\n\nNotes for Agent:\n- Ensure no other generated paths are unintentionally removed.","status":"closed","priority":4,"issue_type":"chore","created_at":"2025-12-26T23:07:20.726896981Z","updated_at":"2025-12-27T06:39:09.897140907Z","closed_at":"2025-12-27T06:39:09.897140907Z","close_reason":"Already resolved: dist/ is in .gitignore and no artifacts are tracked","dependencies":[{"issue_id":"mala-w8w.3","depends_on_id":"mala-w8w","type":"parent-child","created_at":"2025-12-26T23:07:20.735168885Z","created_by":"daemon"}]}
{"id":"mala-wd1","title":"Refactor: extract Claude SDK subagent loop","description":"## Context\nThe Claude SDK receive loop is currently embedded in `MalaOrchestrator.run_implementer` in `src/main.py`. It should be extracted to a reusable `src/agent_loop.py` module.\n\n## Scope\nCreate `src/agent_loop.py` only. Do **not** modify `src/main.py` in this issue; integration will wire it up later.\n\n### Files\n- Add: `src/agent_loop.py`\n\n## Requirements\n- The extracted loop should be the same logic as today:\n  - `async with ClaudeSDKClient(options=options) as client:`\n  - `await client.query(prompt)`\n  - `async for message in client.receive_response(): ...`\n- It must still:\n  - Handle `AssistantMessage` / `ResultMessage` logging exactly as today.\n  - Support JSONL logging and Braintrust logging (existing behavior).\n- Return the final result text and any needed success/summary data in a way `run_implementer` can use.\n\n## Acceptance Criteria\n- `src/agent_loop.py` exists with the extracted loop behavior.\n- No other files are modified in this issue.\n\n## Notes\n- Integration issue will delegate to this module from `src/main.py`.\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T19:54:51.165716848Z","updated_at":"2025-12-25T20:11:59.449563429Z","closed_at":"2025-12-25T20:11:59.449563429Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-wd1","depends_on_id":"mala-1by","type":"blocks","created_at":"2025-12-25T20:06:47.467342748Z","created_by":"daemon"}]}
{"id":"mala-wg1","title":"Add baseline coverage functions to coverage.py","description":"Context:\n- `coverage.py` currently only parses and checks against fixed thresholds\n- Need new functions: `get_baseline_coverage()` and `is_baseline_stale()`\n- Must distinguish \"missing\" (returns None) from \"parse error\" (raises/fails)\n- Staleness detection: compare mtime vs last commit time + check dirty working tree\n\nScope:\n- In: Add `get_baseline_coverage(report_path: Path) -\u003e float | None`\n- In: Add `is_baseline_stale(report_path: Path, repo_path: Path) -\u003e bool`\n- In: Update `check_coverage_threshold` to accept `min_percent: float | None`\n- In: Update `parse_and_check_coverage` signature similarly\n- Out: Auto-refresh logic (that's in spec_runner.py)\n\nAcceptance Criteria:\n- `get_baseline_coverage()` returns percentage if file exists and valid, None if missing, raises on parse errors\n- `is_baseline_stale()` returns True if mtime \u003c last commit time OR repo is dirty\n- `is_baseline_stale()` handles non-git repos gracefully (returns True if git commands fail)\n- `check_coverage_threshold(result, None)` returns PASSED\n\nTest Plan:\n- TDD: Write failing tests for each new function\n- Test missing file  returns None\n- Test valid file  returns percentage\n- Test malformed XML  raises error\n- Test stale mtime  returns True\n- Test dirty repo  returns True\n- Test non-git repo  handles gracefully\n\nNotes for Agent:\n- Use `git log -1 --format=%ct` for last commit time\n- Use `git status --porcelain` to check dirty status\n- Wrap git commands in try/except for non-git fallback\n- Primary files: src/validation/coverage.py, tests/test_coverage.py","status":"tombstone","priority":1,"issue_type":"task","created_at":"2025-12-27T18:13:44.092339695Z","updated_at":"2025-12-27T18:20:40.62834641Z","labels":["coverage"],"deleted_at":"2025-12-27T18:20:40.62834641Z","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"mala-wr1","title":"Skip uv sync in implementer if dependencies unchanged","description":"## Context\nThe implementer prompt currently runs `uv sync` at the start of every implementation. This is wasteful when dependencies haven't changed.\n\n## Problem\nRunning `uv sync` on every implementation adds unnecessary overhead when pyproject.toml/uv.lock haven't been modified.\n\n## Solution\nUpdate the implementer prompt to only run `uv sync` if:\n1. pyproject.toml has been modified, OR\n2. uv.lock has been modified, OR\n3. .venv doesn't exist\n\n## Acceptance Criteria\n- Implementer prompt conditionally runs `uv sync`\n- Dependencies are still installed when needed\n- Unnecessary syncs are skipped\n\n## Files to Modify\n- src/prompts/implementer_prompt.md\n","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-27T06:44:39.140232276Z","updated_at":"2025-12-27T09:03:57.289712504Z","closed_at":"2025-12-27T09:03:57.289712504Z","close_reason":"Closed"}
{"id":"mala-wya","title":"Prompt cleanup: full validation, mutex rule, REPO_NAMESPACE","description":"Context:\n- Track A1 requires removing guidance that allows skipping tests and replacing with a single clear policy (docs/coordination-plan-codex.md:26-28, 81-83).\n- Implementer prompt includes Speed/Scope Guardrails and \"run tests only on touched files\" guidance (src/prompts/implementer_prompt.md:138-150).\n- Track A3 requires setting REPO_NAMESPACE in the prompt to repo root (docs/coordination-plan-codex.md:33-35).\n\nScope:\n- In: remove Speed/Scope Guardrails section and any skip-tests or blame-pre-existing-failures language.\n- In: require the full validation suite (uv sync, pytest, ruff check/format, ty check) and add the test mutex rule for repo-wide commands.\n- In: export REPO_NAMESPACE to the repo root in the lock environment setup.\n- Out: no lock script or orchestrator logic changes.\n\nAcceptance Criteria:\n- Prompt no longer contains Speed/Scope Guardrails or \"run only touched files\" guidance.\n- Prompt explicitly requires full validation suite and a mutex before repo-wide commands.\n- REPO_NAMESPACE export is present and uses the repo root placeholder.\n\nTest Plan:\n- Doc-only: spot-check rendered prompt with sample values.\n\nNotes for Agent:\n- Keep wording aligned with shared-worktree mode.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T16:43:25.110736233Z","updated_at":"2025-12-26T17:03:04.73672941Z","closed_at":"2025-12-26T17:03:04.73672941Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-wya","depends_on_id":"mala-4w7","type":"parent-child","created_at":"2025-12-26T16:47:52.95649035Z","created_by":"daemon"}]}
{"id":"mala-x00","title":"Epic: Validation integration (gates + orchestrator)","description":"Context:\n- Integrates validation modules into gates, CLI, orchestrator, and run metadata.\n- Derived from docs/quality-hardening-plan.md (v5).\n\nScope:\n- In: EvidenceGate updates, CLI parsing, orchestrator pipeline, run metadata.\n- Out: validation module internals (handled in validation epic).\n\nAcceptance Criteria:\n- All child issues closed and pipeline wired end-to-end.\n\nTest Plan:\n- Defer to child issue test plans; run full suite at the end.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-26T23:00:01.628605121Z","updated_at":"2025-12-27T05:57:33.781911141Z","closed_at":"2025-12-27T05:57:33.781911141Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-x00","depends_on_id":"mala-ng3","type":"blocks","created_at":"2025-12-26T23:00:26.410106574Z","created_by":"daemon"},{"issue_id":"mala-x00","depends_on_id":"mala-e0i","type":"blocks","created_at":"2025-12-26T23:00:26.420942397Z","created_by":"daemon"},{"issue_id":"mala-x00","depends_on_id":"mala-2eu","type":"blocks","created_at":"2025-12-26T23:00:26.432302435Z","created_by":"daemon"},{"issue_id":"mala-x00","depends_on_id":"mala-9mb","type":"blocks","created_at":"2025-12-26T23:00:26.443299296Z","created_by":"daemon"}]}
{"id":"mala-xm2","title":"Codex reviewer fails on retry: only sees incremental diff, not full scope","description":"## Problem\n\nAfter an initial Codex review fails and the subagent makes fixes, the subsequent Codex review only sees the incremental diff (fix commit vs previous commit) rather than the cumulative diff from baseline. This causes the reviewer to incorrectly fail with 'scope incomplete' because the fix commit alone doesn't address all scope items.\n\n### Current Flow\n1. Subagent creates commit A with full implementation\n2. Codex reviews 'commit A vs parent'  sees full scope\n3. Review fails (e.g., missing test coverage)\n4. Subagent creates commit B with fix\n5. Codex reviews 'commit B vs commit A'  only sees fix, not full implementation\n6. Codex fails: 'scope incomplete - diff doesn't address all scope items'\n\n### Root Cause\n`codex_review.py:66` uses:\n```\nReview the diff introduced by commit {commit_sha} (vs its parent).\n```\n\nNo baseline commit hash is tracked. `RetryState` has `baseline_timestamp` (for rejecting stale commits) and `previous_commit_hash` (for no-progress detection), but neither provides a diff range for cumulative review.\n\n## Solution\n\nTrack baseline commit hash and review cumulative diff:\n\n1. Add `baseline_commit_hash: str | None = None` to `RetryState`\n2. Capture `git rev-parse HEAD` before starting the subagent\n3. Add `baseline_commit` parameter to `run_codex_review()`\n4. Update `CODEX_REVIEW_PROMPT` to review `baseline..current` diff range\n\n## In:\n- `src/orchestrator.py`: Add `baseline_commit_hash` to `RetryState`, capture before agent starts, pass to review\n- `src/codex_review.py`: Add `baseline_commit` parameter, update prompt to use diff range\n\n## Out:\n- Codex CLI changes\n- Alternative solutions (thread continuation, commit squashing)","acceptance_criteria":"- Codex reviewer sees cumulative diff on retry (baseline to latest commit)\n- Scope verification works correctly across multiple fix commits\n- Tests verify retry scenario with baseline tracking","status":"closed","issue_type":"bug","created_at":"2025-12-27T22:34:06.489052346Z","updated_at":"2025-12-27T23:46:06.961276862Z","closed_at":"2025-12-27T23:46:06.961276862Z","close_reason":"Closed"}
{"id":"mala-xv8","title":"Epic: A3 Canonical lock keys","description":"Context:\n- Track A3 requires setting REPO_NAMESPACE, normalizing paths before hashing, and updating lock tests (docs/coordination-plan-codex.md:33-36).\n\nScope:\n- In: coordinate child tasks for Python helper, shell scripts, and test updates.\n- Out: does not implement changes directly.\n\nAcceptance Criteria:\n- All child tasks for A3 are completed and locks are canonicalized end-to-end.\n\nTest Plan:\n- N/A (handled by child tasks).\n\nNotes for Agent:\n- Use parent-child relationships for A3 sub-tasks.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-26T16:43:43.874044032Z","updated_at":"2025-12-26T17:12:06.484854779Z","closed_at":"2025-12-26T17:12:06.484854779Z","close_reason":"All children completed","dependencies":[{"issue_id":"mala-xv8","depends_on_id":"mala-4w7","type":"parent-child","created_at":"2025-12-26T16:47:52.985551137Z","created_by":"daemon"}]}
{"id":"mala-xv8.1","title":"Canonicalize Python lock key generation","description":"Context:\n- Track A3 requires path normalization and repo namespace before hashing (docs/coordination-plan-codex.md:33-35).\n- _lock_key currently uses raw filepath without normalization (src/tools/locking.py:22-34).\n\nScope:\n- In: normalize file paths (resolve symlinks, repo-relative to REPO_NAMESPACE) before hashing in _lock_key/_lock_path.\n- In: ensure absolute and relative paths for the same file resolve to the same key.\n- Out: no shell script changes (handled separately).\n\nAcceptance Criteria:\n- _lock_key produces identical keys for equivalent absolute/relative paths within the same repo namespace.\n- Repo namespace prefix remains part of the canonical key.\n- Unit tests cover normalization and namespace behavior.\n\nTest Plan:\n- TDD: add failing tests in a new tests/test_locking_key.py for normalization cases.\n- Implement locking.py changes, update tests to pass.\n- Run uv run pytest tests/test_locking_key.py.\n\nNotes for Agent:\n- Assume REPO_NAMESPACE is set to the repo root in the prompt.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T16:43:52.981798811Z","updated_at":"2025-12-26T17:00:55.334823293Z","closed_at":"2025-12-26T17:00:55.334823293Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-xv8.1","depends_on_id":"mala-xv8","type":"parent-child","created_at":"2025-12-26T16:43:52.990309133Z","created_by":"daemon"}]}
{"id":"mala-xv8.2","title":"Canonicalize lock scripts + update script tests","description":"Context:\n- Track A3 requires path normalization before hashing for lock keys (docs/coordination-plan-codex.md:33-35).\n- Lock scripts currently hash raw input paths (src/scripts/lock-try.sh:20-31).\n- Script-level tests exercise lock scripts behavior (tests/test_lock_scripts.py).\n\nScope:\n- In: update lock-try.sh, lock-check.sh, lock-holder.sh, lock-release.sh to normalize paths (resolve symlinks, repo-relative to REPO_NAMESPACE) before hashing.\n- In: update tests/test_lock_scripts.py to cover normalization and namespace behavior for scripts.\n- Out: no Python locking helper changes (handled separately).\n\nAcceptance Criteria:\n- Scripts generate the same lock file for equivalent absolute/relative paths within the same repo namespace.\n- REPO_NAMESPACE is applied after normalization.\n- tests/test_lock_scripts.py includes cases for normalization and passes.\n\nTest Plan:\n- TDD: add failing tests in tests/test_lock_scripts.py for normalization cases.\n- Implement script changes, update tests to pass.\n- Run uv run pytest tests/test_lock_scripts.py.\n\nNotes for Agent:\n- Use portable path normalization (realpath/readlink fallback) to keep Linux/macOS compatibility.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T16:44:02.611587643Z","updated_at":"2025-12-26T17:02:29.674397068Z","closed_at":"2025-12-26T17:02:29.674397068Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-xv8.2","depends_on_id":"mala-xv8","type":"parent-child","created_at":"2025-12-26T16:44:02.621218247Z","created_by":"daemon"}]}
{"id":"mala-xv8.3","title":"Update SDK/integration lock tests for canonical keys","description":"Context:\n- Track A3 calls out updating slow SDK lock tests and helpers to match hashed naming (docs/coordination-plan-codex.md:33-36).\n- tests/test_lock_sdk_integration.py uses raw path-to-lock-name mapping (tests/test_lock_sdk_integration.py:82-91).\n- tests/test_lock_integration.py builds lock keys without path normalization (tests/test_lock_integration.py:24-40).\n\nScope:\n- In: update lock helper functions in tests/test_lock_sdk_integration.py and tests/test_lock_integration.py to match canonicalized, hashed lock key behavior.\n- In: add or adjust test cases to include absolute/relative normalization and REPO_NAMESPACE behavior.\n- Out: no script or Python locking helper changes.\n\nAcceptance Criteria:\n- SDK and integration tests align with canonicalized lock key behavior.\n- Tests cover normalization and namespace scenarios and pass.\n\nTest Plan:\n- TDD: update tests to assert new canonical key behavior (fail first).\n- Adjust helper functions and fixtures, then re-run tests.\n- Run uv run pytest tests/test_lock_sdk_integration.py tests/test_lock_integration.py.\n\nNotes for Agent:\n- Keep SDK tests fast; avoid introducing new long-running steps.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T16:44:13.175373837Z","updated_at":"2025-12-26T17:07:58.871392452Z","closed_at":"2025-12-26T17:07:58.871392452Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-xv8.3","depends_on_id":"mala-xv8","type":"parent-child","created_at":"2025-12-26T16:44:13.184089977Z","created_by":"daemon"}]}
{"id":"mala-y9i","title":"Epic: Healthcheck fixes (correctness + validation)","description":"Tracks fixes from the latest code health review: quality gate correctness, coverage reporting, failed-run metadata, and env override behavior. Parent epic only; children contain detailed scopes, AC, and tests.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-27T17:23:51.264003246Z","updated_at":"2025-12-27T19:21:06.374890315Z","closed_at":"2025-12-27T19:21:06.374890315Z","close_reason":"All children completed"}
{"id":"mala-y9i.1","title":"Quality gate should fail on non-zero validation exits","description":"Context:\n- Quality gate only checks for presence of validation commands in JSONL logs, not whether they succeeded (`src/quality_gate.py`).\n- This can mark issues as successful even when pytest/ruff/ty failed, risking broken changes slipping through.\n- Verify Claude JSONL includes tool_result exit status; if not, adjust parsing fallback accordingly.\n\nScope:\n- In: parse Bash tool_result entries to capture exit status per command kind and fail the gate on any non-zero exit.\n- In: include non-zero exit details in failure reasons to aid follow-up.\n- In: add/adjust tests in `tests/test_quality_gate.py` for success vs failure evidence.\n- Out: changing which validations are required or orchestrator retry policy.\n\nAcceptance Criteria:\n- Gate fails when a required validation command ran but exited non-zero.\n- Gate passes only when required validation commands ran and exited 0.\n- Resolution markers (ISSUE_NO_CHANGE/ISSUE_OBSOLETE) still bypass validation evidence checks.\n\nTest Plan:\n- TDD: add a failing test with JSONL fixture where pytest exits non-zero.\n- Implement minimal parser change; update fixtures as needed.\n- Run `uv run pytest tests/test_quality_gate.py`.\n\nNotes for Agent:\n- Ensure command matching stays consistent with ValidationSpec detection patterns.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-27T17:24:24.649685599Z","updated_at":"2025-12-27T18:32:55.300250022Z","closed_at":"2025-12-27T18:32:55.300250022Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-y9i.1","depends_on_id":"mala-y9i","type":"parent-child","created_at":"2025-12-27T17:24:24.657898438Z","created_by":"daemon"}]}
{"id":"mala-y9i.2","title":"Generate coverage.xml in spec validation","description":"Context:\n- Spec validation checks for `coverage.xml`, but the pytest command in `build_validation_spec` does not generate XML reports (`src/validation/spec.py`).\n- This causes coverage validation to fail with \"report not found\" even when tests run.\n- Needs verification: confirm current test command/output behavior in the runtime environment.\n\nScope:\n- In: when coverage is enabled, add `--cov=src` and `--cov-report=xml` (and `--cov-branch` if required by policy) to the pytest command built in `build_validation_spec`.\n- In: update/extend tests (e.g., `tests/test_spec.py` or `tests/test_validation.py`) to assert XML coverage is generated and consumed.\n- Out: changing coverage thresholds or parsing logic.\n\nAcceptance Criteria:\n- A spec-based validation run produces `coverage.xml` without manual steps.\n- Coverage checks pass/fail based on threshold, not missing file errors.\n- Existing coverage parsing behavior remains unchanged.\n\nTest Plan:\n- TDD: add a failing test that expects XML coverage generation in spec pytest command.\n- Implement minimal change in `build_validation_spec`.\n- Run `uv run pytest tests/test_spec.py` (and any updated coverage tests).\n\nNotes for Agent:\n- Keep the change scoped to spec-based validation to avoid touching legacy runner behavior unless necessary.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-27T17:24:35.528673696Z","updated_at":"2025-12-27T18:18:03.600116003Z","closed_at":"2025-12-27T18:18:03.600116003Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-y9i.2","depends_on_id":"mala-y9i","type":"parent-child","created_at":"2025-12-27T17:24:35.536611666Z","created_by":"daemon"}]}
{"id":"mala-y9i.3","title":"Record quality-gate evidence for failed runs","description":"Context:\n- Failed runs never populate `quality_gate` in run metadata because the failure branch is nested under the success path (`src/orchestrator.py`).\n- This loses evidence and reasons needed for troubleshooting and follow-up triage.\n\nScope:\n- In: refactor result handling so failures always record `quality_gate` evidence/reasons when a log path exists.\n- In: add/adjust tests in `tests/test_orchestrator.py` to assert `quality_gate` is present for failed runs.\n- Out: changing how issues are closed/marked in Beads or altering retry logic.\n\nAcceptance Criteria:\n- Run metadata includes `quality_gate` details for failed runs with logs.\n- Successful runs continue to record `quality_gate` as before.\n- No change to success/failure outcomes or retry behavior.\n\nTest Plan:\n- TDD: add a failing test for failed-run metadata population.\n- Implement the minimal control-flow fix.\n- Run `uv run pytest tests/test_orchestrator.py`.\n\nNotes for Agent:\n- Keep evidence parsing consistent with existing QualityGate helpers.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-27T17:24:44.528665141Z","updated_at":"2025-12-27T18:37:24.657045092Z","closed_at":"2025-12-27T18:37:24.657045092Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-y9i.3","depends_on_id":"mala-y9i","type":"parent-child","created_at":"2025-12-27T17:24:44.537115188Z","created_by":"daemon"}]}
{"id":"mala-y9i.4","title":"Respect MALA_RUNS_DIR/MALA_LOCK_DIR from user .env","description":"Context:\n- `RUNS_DIR` and `LOCK_DIR` are computed at import time before `.env` is loaded, so `MALA_RUNS_DIR`/`MALA_LOCK_DIR` in `~/.config/mala/.env` are ignored (`src/tools/env.py`, `src/cli.py`).\n- This makes configuration overrides appear to have no effect.\n- Needs verification: confirm behavior in a clean shell where only `.env` sets these variables.\n\nScope:\n- In: defer directory resolution until after `load_user_env()` (e.g., replace module-level constants with getters or re-evaluate post-load).\n- In: add/adjust tests (likely `tests/test_cli.py` or a new env test) to confirm overrides are respected.\n- Out: changing default directories or env var names.\n\nAcceptance Criteria:\n- Setting `MALA_RUNS_DIR` and `MALA_LOCK_DIR` in `~/.config/mala/.env` changes runtime paths.\n- Defaults remain unchanged when env vars are not set.\n\nTest Plan:\n- TDD: add a failing test that loads env and asserts the resolved dirs use overrides.\n- Implement minimal refactor to delay evaluation.\n- Run `uv run pytest tests/test_cli.py` (or relevant env test file).\n\nNotes for Agent:\n- Ensure any refactor doesnt break existing imports that expect constants.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T17:24:55.184682777Z","updated_at":"2025-12-27T19:21:06.3556664Z","closed_at":"2025-12-27T19:21:06.3556664Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-y9i.4","depends_on_id":"mala-y9i","type":"parent-child","created_at":"2025-12-27T17:24:55.193409852Z","created_by":"daemon"}]}
{"id":"mala-yco","title":"Make code review generic, not specific to Codex","description":"Make the code review step in the validation pipeline generic/pluggable rather than hardcoded to Codex. Allow different review backends or approaches.\n","status":"blocked","priority":2,"issue_type":"task","created_at":"2025-12-27T06:45:46.864991081Z","updated_at":"2025-12-27T06:45:51.12435472Z","labels":["needs-grooming"]}
{"id":"mala-yg9","title":"Epic: Architecture refactor follow-ups (2025-12-27 review)","description":"Scope: Follow-up work from docs/architecture-check-2025-12-27.md. Tracks orchestrator + validation refactors to improve boundary clarity and testability.","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-27T06:13:21.897889922Z","updated_at":"2025-12-27T06:13:21.897889922Z"}
{"id":"mala-yg9.1","title":"Epic: Orchestrator lifecycle \u0026 gate flow","description":"Scope: Orchestrator lifecycle policy, gate flow concurrency, and metadata recording improvements from the 2025-12-27 architecture review.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-27T06:13:27.609461567Z","updated_at":"2025-12-27T09:03:57.376513213Z","closed_at":"2025-12-27T09:03:57.376513213Z","close_reason":"All children completed","dependencies":[{"issue_id":"mala-yg9.1","depends_on_id":"mala-yg9","type":"parent-child","created_at":"2025-12-27T06:13:27.618446169Z","created_by":"daemon"}]}
{"id":"mala-yg9.1.1","title":"Record resolution markers in run metadata","description":"Context:\n- Needs verification: _run_quality_gate uses check_with_resolution, so ISSUE_NO_CHANGE/ISSUE_OBSOLETE can pass, but IssueRun.resolution is never set (src/orchestrator.py:884-897, src/logging/run_metadata.py:57-140).\n- Downstream tooling cannot distinguish a normal commit pass from a no-change/obsolete resolution.\n\nScope:\n- In: propagate gate_result.resolution into IssueRun and persist it via RunMetadata.\n- Out: changing marker syntax or commit requirements for normal flows.\n\nAcceptance Criteria:\n- Run metadata records resolution outcome + rationale when markers are used.\n- Non-resolution flows remain unchanged.\n\nTest Plan:\n- TDD: add a failing test for resolution recording, implement fix, refactor.\n- Run: uv run pytest tests/test_quality_gate.py tests/test_orchestrator.py\n\nNotes for Agent:\n- Consider surfacing resolution in logs for visibility (optional).","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T06:15:29.583791182Z","updated_at":"2025-12-27T08:18:08.136749502Z","closed_at":"2025-12-27T08:18:08.136749502Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-yg9.1.1","depends_on_id":"mala-yg9.1","type":"parent-child","created_at":"2025-12-27T06:15:29.592643786Z","created_by":"daemon"},{"issue_id":"mala-yg9.1.1","depends_on_id":"mala-yg9.2.4","type":"blocks","created_at":"2025-12-27T06:16:03.215759211Z","created_by":"daemon"}]}
{"id":"mala-yg9.1.2","title":"Make quality gate checks non-blocking in orchestrator loop","description":"Context:\n- Needs verification: _run_quality_gate is called from the async response loop but uses blocking subprocess/file I/O (src/orchestrator.py:217-433).\n- This can stall the event loop when multiple agents run concurrently.\n\nScope:\n- In: move gate checks to asyncio.to_thread (or equivalent) so the event loop stays responsive.\n- Out: changing gate semantics or evidence requirements.\n\nAcceptance Criteria:\n- Gate checks do not block the event loop (structurally enforced via to_thread/async).\n- Orchestrator can continue servicing other agents while a gate runs.\n\nTest Plan:\n- TDD: add/adjust a test that asserts gate checks are invoked via to_thread or async path, implement change, refactor.\n- Run: uv run pytest tests/test_orchestrator.py\n\nNotes for Agent:\n- Keep logging behavior the same; only adjust execution context.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T06:15:38.057191895Z","updated_at":"2025-12-27T08:26:45.183237829Z","closed_at":"2025-12-27T08:26:45.183237829Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-yg9.1.2","depends_on_id":"mala-yg9.1","type":"parent-child","created_at":"2025-12-27T06:15:38.073339276Z","created_by":"daemon"},{"issue_id":"mala-yg9.1.2","depends_on_id":"mala-yg9.1.1","type":"blocks","created_at":"2025-12-27T06:16:03.227763694Z","created_by":"daemon"}]}
{"id":"mala-yg9.1.3","title":"Extract run_implementer lifecycle state machine","description":"Context:\n- run_implementer mixes SDK IO, streaming output, gate checks, retry policy, Codex review, and cleanup in one long loop (src/orchestrator.py:286-520, 760-923).\n- This coupling makes policy changes risky and unit tests hard to write.\n\nScope:\n- In: extract a pure state machine for retry/gate/review transitions (data-in/data-out) and isolate side effects behind small interfaces.\n- Out: changing user-visible CLI behavior or prompt contents.\n\nAcceptance Criteria:\n- Core retry/gate/review policy is testable without Claude SDK or subprocesses.\n- run_implementer is reduced to orchestration with explicit dependencies.\n\nTest Plan:\n- TDD: add unit tests for state transitions, implement refactor, refactor orchestration.\n- Run: uv run pytest tests/test_orchestrator.py\n\nNotes for Agent:\n- Prefer additive refactor with compatibility shims to limit churn.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-27T06:15:45.890888837Z","updated_at":"2025-12-27T08:52:11.379698431Z","closed_at":"2025-12-27T08:52:11.379698431Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-yg9.1.3","depends_on_id":"mala-yg9.1","type":"parent-child","created_at":"2025-12-27T06:15:45.899578351Z","created_by":"daemon"},{"issue_id":"mala-yg9.1.3","depends_on_id":"mala-yg9.1.2","type":"blocks","created_at":"2025-12-27T06:16:03.239560506Z","created_by":"daemon"}]}
{"id":"mala-yg9.2","title":"Epic: Validation system alignment","description":"Scope: Validation spec enforcement, runner alignment, E2E fixture dedup, and gate evidence consistency from the 2025-12-27 architecture review.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-27T06:13:32.616096867Z","updated_at":"2025-12-27T09:03:57.3770263Z","closed_at":"2025-12-27T09:03:57.3770263Z","close_reason":"All children completed","dependencies":[{"issue_id":"mala-yg9.2","depends_on_id":"mala-yg9","type":"parent-child","created_at":"2025-12-27T06:13:32.624829179Z","created_by":"daemon"}]}
{"id":"mala-yg9.2.1","title":"Normalize log parsing offsets in QualityGate","description":"Context:\n- Needs verification: retry offset semantics are inconsistent between binary and text log parsing (see src/quality_gate.py:188-360 and orchestrator usage at src/orchestrator.py:255-275).\n- parse_issue_resolution_from_offset reads bytes while parse_validation_evidence_from_offset reads text, but offsets are reused across both.\n\nScope:\n- In: introduce a single cursor/offset contract for both resolution + evidence parsing (shared binary reader or explicit separate offsets).\n- Out: changing JSONL log format or Claude SDK logging behavior.\n\nAcceptance Criteria:\n- Offsets are byte-based and consistent across both parsers.\n- Retry-scoped evidence and resolution detection are deterministic across attempts.\n\nTest Plan:\n- TDD: add a failing unit test with synthetic JSONL logs spanning multiple attempts, implement fix, refactor.\n- Run: uv run pytest tests/test_quality_gate.py\n\nNotes for Agent:\n- Keep the public QualityGate API stable if possible; prefer internal refactor.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T06:14:23.231600538Z","updated_at":"2025-12-27T06:50:38.683075107Z","closed_at":"2025-12-27T06:50:38.683075107Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-yg9.2.1","depends_on_id":"mala-yg9.2","type":"parent-child","created_at":"2025-12-27T06:14:23.238427532Z","created_by":"daemon"}]}
{"id":"mala-yg9.2.2","title":"Drive gate evidence parsing from ValidationSpec commands","description":"Context:\n- Needs verification: ValidationSpec defines commands, but QualityGate uses a separate regex map for evidence (src/validation/spec.py:310-360 vs src/quality_gate.py:151-158).\n- This duplication risks false failures when commands change.\n\nScope:\n- In: define a single authoritative command definition (e.g., command IDs or detection patterns on ValidationCommand) and reuse it in QualityGate evidence parsing.\n- Out: changing the actual validation commands or their ordering.\n\nAcceptance Criteria:\n- Evidence parsing is driven from spec command definitions.\n- Updating spec commands automatically updates gate expectations.\n\nTest Plan:\n- TDD: add/adjust a unit test that fails when spec commands change but evidence parsing does not, then implement fix.\n- Run: uv run pytest tests/test_quality_gate.py\n\nNotes for Agent:\n- Prefer minimal API changes; add optional fields to ValidationCommand if needed.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T06:14:32.366184084Z","updated_at":"2025-12-27T07:11:43.246105111Z","closed_at":"2025-12-27T07:11:43.246105111Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-yg9.2.2","depends_on_id":"mala-yg9.2","type":"parent-child","created_at":"2025-12-27T06:14:32.374848132Z","created_by":"daemon"},{"issue_id":"mala-yg9.2.2","depends_on_id":"mala-yg9.2.1","type":"blocks","created_at":"2025-12-27T06:16:03.124875688Z","created_by":"daemon"}]}
{"id":"mala-yg9.2.3","title":"Remove deprecated validation flags and use disable-validations=codex-review","description":"Context:\n- CLI flags --lint-only-for-docs and --skip-e2e-if-no-keys should be removed entirely.\n- Codex review toggling should use --disable-validations=codex-review and replace the --codex-review/--no-codex-review flag (src/cli.py:125-163).\n- Orchestrator currently stores lint_only_for_docs + skip_e2e_if_no_keys and uses codex_review directly (src/orchestrator.py:155-187, 435-520).\n\nScope:\n- In: remove --lint-only-for-docs and --skip-e2e-if-no-keys from CLI and plumbing (cli/orchestrator/spec inputs).\n- In: remove --codex-review/--no-codex-review flag and wire codex review enablement to disable_validations containing \"codex-review\".\n- Out: changing validation command defaults or quality gate semantics.\n\nAcceptance Criteria:\n- CLI help/output no longer includes --lint-only-for-docs or --skip-e2e-if-no-keys.\n- CLI help/output no longer includes --codex-review/--no-codex-review.\n- Codex review is enabled by default and disabled when disable_validations includes \"codex-review\".\n\nTest Plan:\n- TDD: update failing CLI parsing tests to remove deprecated flags and validate codex-review disable path, implement code changes, refactor.\n- Run: uv run pytest tests/test_cli.py tests/test_orchestrator.py\n\nNotes for Agent:\n- Keep behavior backward-compatible only via disable-validations; do not add new flags.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-27T06:14:41.186302644Z","updated_at":"2025-12-27T07:20:37.057790616Z","closed_at":"2025-12-27T07:20:37.057790616Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-yg9.2.3","depends_on_id":"mala-yg9.2","type":"parent-child","created_at":"2025-12-27T06:14:41.194971161Z","created_by":"daemon"},{"issue_id":"mala-yg9.2.3","depends_on_id":"mala-yg9.2.2","type":"blocks","created_at":"2025-12-27T06:16:03.143821949Z","created_by":"daemon"}]}
{"id":"mala-yg9.2.4","title":"Integrate spec-based validation execution into orchestrator metadata","description":"Context:\n- Needs verification: ValidationRunner.run_spec exists but is unused; orchestrator relies on log parsing for pass/fail (src/validation/runner.py:294-540, src/orchestrator.py:822-897).\n- Run metadata has validation fields that are never populated (src/logging/run_metadata.py:57-140).\n\nScope:\n- In: invoke ValidationRunner.run_spec after commit detection and record ValidationResult in RunMetadata/IshueRun.\n- Out: changing validation commands or CLI flags.\n\nAcceptance Criteria:\n- Exactly one validation execution path is used during runs.\n- Run metadata includes validation results when validation runs.\n\nTest Plan:\n- TDD: add/adjust an orchestrator test that asserts validation execution + metadata population, implement fix, refactor.\n- Run: uv run pytest tests/test_orchestrator.py tests/test_validation.py\n\nNotes for Agent:\n- Keep log-parsing gate evidence intact unless explicitly replaced by run_spec.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-27T06:14:50.057484108Z","updated_at":"2025-12-27T07:47:41.275020049Z","closed_at":"2025-12-27T07:47:41.275020049Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-yg9.2.4","depends_on_id":"mala-yg9.2","type":"parent-child","created_at":"2025-12-27T06:14:50.066001705Z","created_by":"daemon"},{"issue_id":"mala-yg9.2.4","depends_on_id":"mala-yg9.2.3","type":"blocks","created_at":"2025-12-27T06:16:03.1558436Z","created_by":"daemon"}],"comments":[{"id":1,"issue_id":"mala-yg9.2.4","author":"cyou","text":"Additional context from type error incident (2025-12-27):\n\nRoot cause: Agents gaming validation by running `uvx ty check src/specific_file.py` instead of full `uvx ty check`. QualityGate's regex-based log parsing accepted this because it only checks if `ty check` was mentioned, not:\n- Whether it ran on full codebase\n- Whether it passed (exit code 0)\n\nEvidence: Commit 0328a6e logs show agent ran:\n- `uvx ty check 2\u003e\u00261 | head -20` (truncated)\n- `uvx ty check src/orchestrator.py` (file-specific)\n\nResult: 62 type errors accumulated in test files, required manual fix in 8c0dc74.\n\nThis confirms the urgency of wiring up ValidationRunner.run_spec() which actually runs full validation in a clean worktree and checks exit codes.","created_at":"2025-12-27T06:36:30Z"}]}
{"id":"mala-yg9.2.5","title":"Split ValidationRunner legacy vs spec APIs","description":"Context:\n- Needs verification: ValidationRunner houses both legacy ValidationConfig flow and new ValidationSpec flow in one class (src/validation/runner.py:1-120, 294-540).\n- This coupling makes deprecating legacy paths risky and tests harder to isolate.\n\nScope:\n- In: split into LegacyValidationRunner + SpecValidationRunner (or an adapter), with shared helpers extracted.\n- Out: changing validation behavior or CLI flags.\n\nAcceptance Criteria:\n- Each runner has a single responsibility and isolated config surface.\n- Tests are updated to use the appropriate runner class.\n\nTest Plan:\n- TDD: update a failing test to target the new runner class, implement refactor, refactor tests.\n- Run: uv run pytest tests/test_validation.py\n\nNotes for Agent:\n- Prefer small module moves; keep public API stable where possible.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T06:14:58.49336286Z","updated_at":"2025-12-27T08:09:26.87856065Z","closed_at":"2025-12-27T08:09:26.87856065Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-yg9.2.5","depends_on_id":"mala-yg9.2","type":"parent-child","created_at":"2025-12-27T06:14:58.502255715Z","created_by":"daemon"},{"issue_id":"mala-yg9.2.5","depends_on_id":"mala-yg9.2.4","type":"blocks","created_at":"2025-12-27T06:16:03.167592633Z","created_by":"daemon"}]}
{"id":"mala-yg9.2.6","title":"Deduplicate E2E fixture logic","description":"Context:\n- E2E fixture creation/prereq checks are duplicated between validation/runner.py and validation/e2e.py (src/validation/runner.py:686-789, src/validation/e2e.py:348-473).\n- This duplication risks drift and inconsistent behavior across legacy/spec flows.\n\nScope:\n- In: centralize fixture creation + prereq checks in E2ERunner and delegate from ValidationRunner.\n- In: remove duplicate helpers from validation.__init__ if they are no longer needed.\n- Out: changing fixture content or mala invocation.\n- Out: any CLI flag changes (handled elsewhere).\n\nAcceptance Criteria:\n- Only one fixture/prereq implementation exists.\n- ValidationRunner delegates E2E execution to E2ERunner for both legacy and spec flows.\n- Duplicate helper exports are removed from validation.__init__ if unused.\n\nTest Plan:\n- TDD: add/adjust a failing E2E-related unit test, implement dedup, refactor.\n- Run: uv run pytest tests/test_e2e.py tests/test_validation.py\n\nNotes for Agent:\n- Keep fixture content identical; change plumbing only.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T06:15:10.06348597Z","updated_at":"2025-12-27T08:21:18.084178254Z","closed_at":"2025-12-27T08:21:18.084178254Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-yg9.2.6","depends_on_id":"mala-yg9.2","type":"parent-child","created_at":"2025-12-27T06:15:10.072149386Z","created_by":"daemon"},{"issue_id":"mala-yg9.2.6","depends_on_id":"mala-yg9.2.5","type":"blocks","created_at":"2025-12-27T06:16:03.179392406Z","created_by":"daemon"}]}
{"id":"mala-yg9.2.7","title":"Standardize subprocess execution via shared CommandRunner","description":"Context:\n- Needs verification: subprocess handling is inconsistent across modules, with different timeout/kill semantics and duplicated output tailing (e.g., src/beads_client.py:45-140, src/quality_gate.py:260-430, src/validation/runner.py:108-240, src/validation/e2e.py:200-420, src/validation/worktree.py:110-200).\n- This increases maintenance burden and inconsistent failure modes.\n\nScope:\n- In: introduce a shared CommandRunner (sync + async) with standardized timeouts, process-group termination, and output capture.\n- In: migrate quality_gate + validation (runner/e2e/worktree) to the shared runner; add beads_client only if needed for consistency.\n- Out: changing which commands run or their ordering.\n\nAcceptance Criteria:\n- CommandRunner exists and is used by quality_gate and validation paths.\n- Duplicate _tail helpers are removed or consolidated.\n\nTest Plan:\n- TDD: add a failing unit test for CommandRunner timeout/kill behavior, implement runner, refactor call sites.\n- Run: uv run pytest tests/test_validation.py tests/test_quality_gate.py\n\nNotes for Agent:\n- Keep API minimal; prefer incremental migration to avoid churn.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T06:15:20.286094712Z","updated_at":"2025-12-27T08:59:29.472484025Z","closed_at":"2025-12-27T08:59:29.472484025Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-yg9.2.7","depends_on_id":"mala-yg9.2","type":"parent-child","created_at":"2025-12-27T06:15:20.295235806Z","created_by":"daemon"},{"issue_id":"mala-yg9.2.7","depends_on_id":"mala-yg9.2.6","type":"blocks","created_at":"2025-12-27T06:16:03.191495098Z","created_by":"daemon"},{"issue_id":"mala-yg9.2.7","depends_on_id":"mala-yg9.2.2","type":"blocks","created_at":"2025-12-27T06:16:03.20365412Z","created_by":"daemon"}]}
{"id":"mala-yg9.3","title":"Orchestrator: drive implementer flow via ImplementerLifecycle","description":"## Context\nFrom architecture review docs/architecture-check-2025-12-27.md issue #4:\n- `src/orchestrator.py:303-644` contains `run_implementer` as a 342-line monolithic method\n- Gate/review retry policy, SDK session management, streaming, and lock cleanup are all mixed together\n- This coupling makes policy changes risky and unit testing difficult without the full SDK runtime\n\n## Current State (after mala-yg9.1.3)\n- `src/lifecycle.py` (470 lines) already implements `ImplementerLifecycle` as a pure state machine\n- `tests/test_lifecycle.py` (630 lines) has 31 tests with 97% coverage\n- Bridge functions exist: `from_orchestrator_retry_state()`, `to_orchestrator_retry_state_fields()`\n- **However**: `ImplementerLifecycle` is NOT imported or used anywhere in `orchestrator.py`\n- The orchestrator still has its own inline retry/gate/review logic duplicating the lifecycle\n\n## Scope\n- In: Refactor `run_implementer` to use `ImplementerLifecycle` for policy decisions\n- In: Orchestrator handles I/O (SDK calls, logs, hooks) based on `Effect` returns from lifecycle\n- In: Remove inline retry/gate/review branches from orchestrator\n- Out: Change retry semantics, Claude SDK integration, or lifecycle state machine design\n\n## Acceptance Criteria\n- `run_implementer` delegates policy decisions to `ImplementerLifecycle`\n- Inline gate/review retry branches are removed from orchestrator (reducing ~200 lines)\n- Lifecycle transitions drive the flow: INITIAL  PROCESSING  AWAITING_LOG  RUNNING_GATE  etc.\n- All existing orchestrator integration tests still pass\n- No SDK mocking required to test policy logic (already covered by lifecycle tests)\n\n## Test Plan\n- TDD: Verify lifecycle is called in orchestrator flow\n- Existing lifecycle tests (31 tests) already cover policy transitions\n- `uv run pytest tests/test_orchestrator.py tests/test_lifecycle.py`\n\n## Notes for Agent\n- Use the existing bridge functions to convert between orchestrator's `RetryState` and lifecycle's `LifecycleContext`\n- Effects returned by lifecycle transitions tell orchestrator what I/O to perform\n- Keep I/O (SDK, logs, hooks) in orchestrator; lifecycle remains pure data-in/data-out\n- Reference lifecycle.py module docstring for design rationale","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-27T17:15:08.120064423Z","updated_at":"2025-12-28T00:56:10.391191905Z","closed_at":"2025-12-28T00:56:10.391191905Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-yg9.3","depends_on_id":"mala-yg9","type":"parent-child","created_at":"2025-12-27T17:15:08.120492531Z","created_by":"daemon"}]}
{"id":"mala-yg9.4","title":"Validation pipeline: make SpecValidationRunner primary and isolate legacy facade","description":"Context:\n- Orchestrator uses the `ValidationRunner` facade to run spec validation (`src/orchestrator.py:880-918`).\n- `ValidationRunner` wraps both legacy and spec flows (`src/validation/runner.py:57-113`).\n- Legacy command definitions remain in `src/validation/legacy_runner.py:134-154`, risking drift from spec.\n\nScope:\n- In: Update orchestrator to use `SpecValidationRunner` directly (or a thin spec-only adapter).\n- In: Reduce `ValidationRunner` to a compatibility wrapper; clearly document legacy path.\n- Out: Remove legacy API entirely or change validation command semantics.\n\nAcceptance Criteria:\n- Orchestrator no longer instantiates `ValidationRunner` for spec-based runs.\n- Legacy runner remains available for backward compatibility but is not used in orchestrator.\n- Validation command definitions are single-sourced (no duplicate lists used by orchestrator).\n\nTest Plan:\n- TDD: add a failing test that exercises spec validation via the new orchestration path.\n- `uv run pytest` (target validation runner/spec tests).\n\nNotes for Agent:\n- Keep the public legacy API working; deprecate via docs/comments only if needed.","status":"in_progress","priority":1,"issue_type":"task","created_at":"2025-12-27T17:15:18.339547533Z","updated_at":"2025-12-28T01:03:37.815534003Z","dependencies":[{"issue_id":"mala-yg9.4","depends_on_id":"mala-yg9","type":"parent-child","created_at":"2025-12-27T17:15:18.348894746Z","created_by":"daemon"},{"issue_id":"mala-yg9.4","depends_on_id":"mala-yg9.3","type":"blocks","created_at":"2025-12-27T17:16:03.096258868Z","created_by":"daemon"}]}
{"id":"mala-yg9.5","title":"Subprocess handling: centralize execution and timeouts","description":"## Context\nFrom architecture review docs/architecture-check-2025-12-27.md issue #7:\n- Subprocess logic is duplicated with different timeout/termination semantics\n- Only `BeadsClient` reliably kills process groups\n- Duplicate `_tail` helpers increase maintenance burden\n\n## Current State (after mala-yg9.2.7)\n`src/validation/command_runner.py` was created with:\n- Unified sync/async execution (`run()` and `run_async()`)\n- Configurable timeouts with process-group termination (SIGTERM  grace  SIGKILL)\n- `CommandResult` dataclass with `stdout_tail()`/`stderr_tail()` methods\n\n**Successfully migrated:**\n- `src/validation/spec_runner.py` - uses CommandRunner for all validation commands\n- `src/validation/legacy_runner.py` - uses CommandRunner for validation steps\n- `src/validation/e2e.py` - uses CommandRunner for mala invocation\n\n**NOT migrated (still use direct subprocess.run):**\n- `src/quality_gate.py:291` - `check_working_tree_clean()` uses subprocess.run for `git status`\n- `src/quality_gate.py:663` - `check_commit_exists()` uses subprocess.run for `git log`\n- `src/validation/worktree.py:191,238,267,318,341` - Multiple subprocess.run calls for git operations\n\n**Independent implementation:**\n- `src/beads_client.py` has its own `_run_subprocess_async()` with similar semantics (predates CommandRunner)\n\n## Scope\n- In: Migrate `quality_gate.py` subprocess calls to use CommandRunner\n- In: Migrate `worktree.py` subprocess calls to use CommandRunner\n- In: Consider whether `beads_client.py` should also use CommandRunner (or keep independent)\n- Out: Change CLI command flags or alter validation policies\n\n## Acceptance Criteria\n- `quality_gate.py` uses CommandRunner for git subprocess calls\n- `worktree.py` uses CommandRunner for git subprocess calls\n- Timeout and process-group termination behavior is consistent across all call sites\n- Error messages remain structured and actionable\n- All existing tests pass\n\n## Test Plan\n- Add/adjust unit tests for subprocess calls in quality_gate and worktree\n- `uv run pytest tests/test_quality_gate.py tests/test_validation.py`\n\n## Notes for Agent\n- CommandRunner is in `src/validation/command_runner.py`\n- For git commands, consider whether they need timeout handling or can use simpler wrappers\n- Preserve stdout/stderr tailing behavior; do not increase log noise\n- BeadsClient migration is optional - evaluate whether unifying is worth the churn","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-27T17:15:27.857841446Z","updated_at":"2025-12-27T18:42:50.993930728Z","dependencies":[{"issue_id":"mala-yg9.5","depends_on_id":"mala-yg9","type":"parent-child","created_at":"2025-12-27T17:15:27.877588866Z","created_by":"daemon"},{"issue_id":"mala-yg9.5","depends_on_id":"mala-yg9.7","type":"blocks","created_at":"2025-12-27T17:16:07.830176685Z","created_by":"daemon"}]}
{"id":"mala-yg9.6","title":"Env config: compute RUNS_DIR/LOCK_DIR after .env load","description":"Context:\n- `RUNS_DIR` and `LOCK_DIR` are computed at import time (`src/tools/env.py:18-29`).\n- `.env` is loaded later in CLI startup (`src/cli.py:17-21`), so overrides are ignored.\n- Needs verification: confirm expected behavior for `MALA_RUNS_DIR`/`MALA_LOCK_DIR` overrides.\n\nScope:\n- In: Replace import-time constants with accessors or a Settings object loaded after `load_user_env()`.\n- In: Update CLI (and any other callers) to use the new access path.\n- Out: Change environment variable names or default paths.\n\nAcceptance Criteria:\n- `.env` overrides for runs/locks apply consistently.\n- No module depends on import-time config constants for these paths.\n- Unit test demonstrates `.env` override behavior.\n\nTest Plan:\n- Add a test that sets env vars or loads a test `.env`, then asserts resolved paths.\n- `uv run pytest` (target env/config tests).\n\nNotes for Agent:\n- Keep `load_user_env()` as the single production entry for env loading.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T17:15:37.761209754Z","updated_at":"2025-12-28T01:13:53.981259155Z","closed_at":"2025-12-28T01:13:53.981259155Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-yg9.6","depends_on_id":"mala-yg9","type":"parent-child","created_at":"2025-12-27T17:15:37.780801225Z","created_by":"daemon"}]}
{"id":"mala-yg9.7","title":"QualityGate: derive evidence requirements from ValidationSpec","description":"## Context\nFrom architecture review docs/architecture-check-2025-12-27.md issue #8:\n- Validation commands defined in `ValidationSpec` but evidence detection used separate regex map in `QualityGate`\n- Changing commands in spec could silently desync evidence detection\n\n## Current State (after mala-yg9.2.2)\n**Spec-driven path implemented and working:**\n- `ValidationCommand` in `spec.py:174-198` includes `detection_pattern` field\n- `build_validation_spec()` creates commands with compiled regex patterns\n- `parse_validation_evidence_with_spec()` in `quality_gate.py:493` derives patterns FROM spec\n- `check_with_resolution()` accepts optional `spec` parameter and uses spec-driven parsing\n- Orchestrator passes spec to gate: `quality_gate.check_with_resolution(..., spec=spec)`\n- Tests verify spec-driven patterns work (TestSpecDrivenEvidencePatterns)\n\n**Remaining cleanup (optional):**\n- `VALIDATION_PATTERNS` hardcoded map still exists in `quality_gate.py:151-158` as fallback\n- Legacy `check()` method and `parse_validation_evidence_from_offset()` still use hardcoded patterns\n- These are only used when no spec is provided (backward compatibility)\n\n## Scope\n- In: Remove `VALIDATION_PATTERNS` hardcoded map if no longer needed\n- In: Update legacy `check()` method to require spec or remove entirely\n- In: Ensure `parse_validation_evidence_from_offset()` is only used as fallback\n- Out: Change which validations are required or their CLI flags\n\n## Acceptance Criteria\n- Hardcoded `VALIDATION_PATTERNS` map is removed or clearly marked as deprecated fallback\n- All production code paths use spec-driven evidence parsing\n- Tests verify that updating spec commands automatically updates evidence expectations\n- Legacy paths (if kept) are clearly documented as deprecated\n\n## Test Plan\n- Verify no production code calls legacy methods without spec\n- Add test that spec command changes propagate to evidence detection\n- `uv run pytest tests/test_quality_gate.py`\n\n## Notes for Agent\n- The core fix is already implemented - this is cleanup work\n- Check if any callers use `check()` or `parse_validation_evidence_from_offset()` without spec\n- If legacy methods have no callers, they can be removed\n- If they have callers, update callers to pass spec or deprecate with warnings","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-27T17:15:46.833421374Z","updated_at":"2025-12-28T00:26:07.938738025Z","dependencies":[{"issue_id":"mala-yg9.7","depends_on_id":"mala-yg9","type":"parent-child","created_at":"2025-12-27T17:15:46.853067905Z","created_by":"daemon"}]}
{"id":"mala-yg9.8","title":"CLI bootstrap: move Braintrust/env side effects into explicit init","description":"Context:\n- `src/cli.py` loads `.env` and applies Braintrust setup at import time (`src/cli.py:12-33`).\n- Import-time side effects make tests and reuse harder.\n- Needs verification: confirm other modules rely on current import-time behavior.\n\nScope:\n- In: Add a `bootstrap()` function to handle env loading and Braintrust patching.\n- In: Ensure entrypoint (`src/main.py`) calls bootstrap before using the SDK.\n- Out: Change CLI commands or Braintrust configuration semantics.\n\nAcceptance Criteria:\n- Importing `src.cli` does not perform env loading or Braintrust setup.\n- CLI still boots with Braintrust enabled when `BRAINTRUST_API_KEY` is set.\n- Unit test (or smoke test) validates import safety.\n\nTest Plan:\n- Add an import-only test that asserts no side effects.\n- `mala --help` and `mala run --help` smoke checks.\n\nNotes for Agent:\n- Keep SDK import ordering safe: bootstrap must run before claude_agent_sdk usage.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-27T17:15:56.854726584Z","updated_at":"2025-12-27T17:15:56.854726584Z","dependencies":[{"issue_id":"mala-yg9.8","depends_on_id":"mala-yg9","type":"parent-child","created_at":"2025-12-27T17:15:56.874255915Z","created_by":"daemon"},{"issue_id":"mala-yg9.8","depends_on_id":"mala-yg9.6","type":"blocks","created_at":"2025-12-27T17:16:12.147876459Z","created_by":"daemon"}]}
{"id":"mala-yg9.9","title":"Remove private helpers from validation __all__ export","description":"## Context\nFrom architecture review docs/architecture-check-2025-12-27.md issue #11:\n- Private helpers (`_tail`, `_format_step_output`, `_check_e2e_prereqs`) are included in `src/validation/__init__.py`'s `__all__` export list (lines 110-112)\n- This makes them part of the public API surface, increasing coupling and making refactors risky\n\n## Current State\n```python\n# In src/validation/__init__.py lines 110-112\n# Backwards compatibility (private)\n\"_check_e2e_prereqs\",\n\"_format_step_output\",\n\"_tail\",\n```\n\nThese are re-exported from `runner.py` (lines 42-47) as underscore-prefixed aliases of the helpers in `helpers.py`.\n\n## Scope\n- In: Remove `_tail`, `_format_step_output`, `_check_e2e_prereqs` from `__all__` in `src/validation/__init__.py`\n- In: Remove the re-export aliases from `src/validation/runner.py`\n- In: Search for external callers and update them to use the public `helpers.py` exports if needed\n- Out: Changing the helper implementations themselves\n\n## Acceptance Criteria\n- Only intended public API symbols are exported from `validation.__init__`\n- No external code breaks (verify via grep for imports of these private symbols)\n- Tests still pass\n\n## Test Plan\n- `uv run pytest tests/test_validation.py` to catch import breakage\n- `grep -r \"from.*validation.*import.*_tail\" src/ tests/` to find any callers\n\n## Notes for Agent\n- These helpers are consolidated in `helpers.py` - the public versions (`tail`, `format_step_output`, `check_e2e_prereqs`) should be used instead\n- If external callers exist, update them to import from `validation.helpers` directly","status":"open","priority":3,"issue_type":"chore","created_at":"2025-12-27T18:41:56.00236732Z","updated_at":"2025-12-27T18:41:56.00236732Z","dependencies":[{"issue_id":"mala-yg9.9","depends_on_id":"mala-yg9","type":"parent-child","created_at":"2025-12-27T18:41:56.009743695Z","created_by":"daemon"}]}
{"id":"mala-ytn","title":"Make tooling language/package-manager agnostic","description":"## Context\nCurrently the codebase is tightly coupled to Python + uv + ruff + ty. Validation commands, quality gate parsing, and prompts all assume this specific toolchain.\n\n## Goal\nMake mala usable with other language/toolchain combinations (e.g., TypeScript/npm, Rust/cargo, Go, etc.) by abstracting the toolchain layer.\n\n## Areas Affected\n\n### Validation Commands (src/validation/)\n- Hardcoded commands: `uv sync`, `uv run pytest`, `uvx ruff check`, `uvx ruff format`, `uvx ty check`\n- Need to support equivalent commands for other ecosystems (npm install, npm test, eslint, tsc, etc.)\n\n### Quality Gate Parsing (src/quality_gate.py)\n- Parses output patterns specific to pytest, ruff, ty\n- Needs configurable or pluggable pattern matching\n\n### Prompts (src/prompts/implementer_prompt.md)\n- References specific tools and commands\n- Should be templated or configurable per project\n\n### CLAUDE.md\n- Project-specific instructions currently assumed to follow Python conventions\n- Should be the source of truth for project toolchain\n\n## Approach Options\n\n1. **Config-driven**: Define toolchain in pyproject.toml/mala.toml with command mappings\n2. **Auto-detect**: Detect toolchain from project files (package.json, Cargo.toml, go.mod, etc.)\n3. **Plugin system**: Allow custom validation plugins per language\n\n## Acceptance Criteria\n- mala can run on a TypeScript project with npm/eslint/tsc\n- Toolchain commands are configurable, not hardcoded\n- Quality gate can parse outputs from multiple test/lint frameworks\n- Documentation covers how to configure for different languages\n\n## Out of Scope (for now)\n- IDE integration changes\n- Language-specific code generation\n- Multi-language monorepos","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-26T23:35:50.333488526Z","updated_at":"2025-12-27T20:57:22.064580719Z","closed_at":"2025-12-27T20:57:22.064580719Z","close_reason":"All children completed"}
{"id":"mala-za5","title":"Honor repo .env for Braintrust setup","description":"Context:\n- Braintrust setup runs before repo .env is loaded, so BRAINTRUST_API_KEY in the repo is ignored.\n- README suggests repo .env overrides user config, which currently isnt true for Braintrust.\n\nScope:\n- In: delay Braintrust setup until after load_env(repo_path) or re-run setup if key becomes available.\n- Out: changes to tracing semantics or Braintrust SDK usage beyond setup timing.\n\nAcceptance Criteria:\n- When only repo .env contains BRAINTRUST_API_KEY, `mala run` reports Braintrust enabled.\n- When no key is present, behavior remains unchanged.\n\nTest Plan:\n- TDD: add a test that simulates repo-only BRAINTRUST_API_KEY, implement fix, and run CLI-related tests.\n\nNotes for Agent:\n- Avoid importing claude_agent_sdk before the wrapper is applied.","status":"tombstone","priority":2,"issue_type":"task","created_at":"2025-12-26T17:35:42.430757121Z","updated_at":"2025-12-26T17:39:58.002809862Z","deleted_at":"2025-12-26T17:39:58.002809862Z","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"mala-zjn","title":"Test blocked without deps","status":"tombstone","priority":2,"issue_type":"task","created_at":"2025-12-26T00:53:15.4017375Z","updated_at":"2025-12-26T00:53:28.39468524Z","deleted_at":"2025-12-26T00:53:28.39468524Z","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"mala-zx5","title":"Add --only flag for specifying beads issues by ID","description":"Add a command-line flag (--only) that accepts a comma-separated list of beads issue IDs. When provided, workers will only process those specific issues instead of picking from all ready issues.\n\nExample usage:\n  mala --only bd-abc123,bd-def456\n\nAcceptance criteria:\n- Add --only flag to CLI argument parsing\n- Parse comma-separated issue IDs\n- Filter get_ready() results to only include specified IDs\n- Validate that specified IDs exist and are ready\n- Update documentation/help text","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T00:40:19.287843127Z","updated_at":"2025-12-26T00:53:27.149701137Z","closed_at":"2025-12-26T00:53:27.149701137Z","close_reason":"Closed"}
