{"id":"mala-01s","title":"Refactor: consolidate lock config + env in one place","description":"Goal: Centralize LOCK_DIR and SCRIPTS_DIR configuration (currently defined in multiple modules). Allow override via env/config where appropriate.\\n\\nScope/files: src/tools/env.py, src/tools/locking.py, any imports that need adjustment.\\n\\nNotes:\\n- Consider single source of truth in tools/env.py.\\n- Keep behavior unchanged unless explicit override is set.\\n\\nAcceptance criteria:\\n- No duplicate definitions for LOCK_DIR/SCRIPTS_DIR.\\n- Locking and scripts continue to work.\\n- Minimal, well-contained changes.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-25T21:40:20.871689769Z","updated_at":"2025-12-26T00:08:19.981435611Z","closed_at":"2025-12-26T00:08:19.981435611Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-01s","depends_on_id":"mala-kpf","type":"blocks","created_at":"2025-12-25T21:47:40.701482404Z","created_by":"daemon"}]}
{"id":"mala-1by","title":"Refactor: extract console logging helpers","description":"## Context\nConsole logging helpers (`Colors`, `log`, `log_tool`, `log_result`) live in `src/main.py`. They should move to `src/logging/console.py` to reduce CLI/orchestrator coupling.\n\n## Scope\nCreate the new module only. Do **not** modify `src/main.py` in this issue; integration will wire it up later.\n\n### Files\n- Add: `src/logging/console.py`\n\n## Requirements\n- Move `Colors`, `log`, `log_tool`, and `log_result` into `src/logging/console.py`.\n- Behavior and output formatting must remain identical.\n\n## Acceptance Criteria\n- `src/logging/console.py` contains the logging helpers with identical behavior.\n- No other files are modified in this issue.\n\n## Notes\n- Integration issue will update imports in `src/main.py` and any other modules.\n- Keep ASCII-only files.\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T19:54:51.142161242Z","updated_at":"2025-12-25T20:09:18.911369058Z","closed_at":"2025-12-25T20:09:18.911369058Z","close_reason":"Closed"}
{"id":"mala-1l2","title":"Make morphllm optional","description":"Make MorphLLM optional: allow running without MORPH_API_KEY by disabling the Morph MCP server and related tool restrictions.","status":"blocked","priority":4,"issue_type":"epic","created_at":"2025-12-26T00:55:42.42123181Z","updated_at":"2025-12-26T15:36:54.476876922Z"}
{"id":"mala-1z6","title":"Disallow destructive git commands (reset, push --force, etc.)","description":"Prevent agents from running destructive git commands that could cause data loss or rewrite history.\n\n## Commands to Block\n\n| Pattern | Reason |\n|---------|--------|\n| `git reset --hard` | Discards uncommitted changes permanently |\n| `git push --force` / `git push -f` | Rewrites remote history (already blocked for main/master) |\n| `git clean -fd` | Deletes untracked files permanently |\n| `git checkout -- .` | Discards all uncommitted changes |\n| `git rebase` | Rewrites commit history |\n| `git branch -D` | Force-deletes branch without merge check |\n\n## Implementation\n\n**File:** `src/hooks.py`\n\n### 1. Add new pattern list after DANGEROUS_PATTERNS\n\n```python\n# Destructive git command patterns to block\nDESTRUCTIVE_GIT_PATTERNS = [\n    \"git reset --hard\",\n    \"git clean -fd\",\n    \"git clean -f\",\n    \"git checkout -- .\",\n    \"git rebase\",\n    \"git branch -D\",\n    \"git branch -d -f\",\n]\n```\n\n### 2. Update block_dangerous_commands function\n\nAdd a new check after the existing dangerous patterns loop:\n\n```python\n# Block destructive git patterns\nfor pattern in DESTRUCTIVE_GIT_PATTERNS:\n    if pattern in command:\n        return {\n            \"decision\": \"block\",\n            \"reason\": f\"Blocked destructive git command: {pattern}\",\n        }\n\n# Expand force push blocking to ALL branches (not just main/master)\nif \"git push\" in command and (\"--force\" in command or \"-f \" in command):\n    return {\n        \"decision\": \"block\",\n        \"reason\": \"Blocked force push (use --force-with-lease if needed)\",\n    }\n```\n\n### 3. Add tests in `tests/test_morph_integration.py`\n\nAdd to `TestBlockDangerousCommands` class:\n\n```python\n@pytest.mark.asyncio\n@pytest.mark.parametrize(\"cmd\", [\n    \"git reset --hard\",\n    \"git reset --hard HEAD~1\",\n    \"git clean -fd\",\n    \"git clean -f .\",\n    \"git checkout -- .\",\n    \"git rebase main\",\n    \"git rebase -i HEAD~3\",\n    \"git branch -D feature\",\n    \"git push --force origin feature\",\n    \"git push -f origin feature\",\n])\nasync def test_blocks_destructive_git_commands(self, make_hook_input, cmd):\n    \"\"\"Destructive git commands should be blocked.\"\"\"\n    from src.hooks import block_dangerous_commands\n    \n    result = await block_dangerous_commands(\n        make_hook_input(\"Bash\", cmd), None, {\"signal\": None}\n    )\n    assert result.get(\"decision\") == \"block\", f\"Should block: {cmd}\"\n```\n\n## Acceptance Criteria\n\n- [ ] All patterns in the table are blocked\n- [ ] Force push blocked on ALL branches (not just main/master)\n- [ ] Tests cover each blocked pattern\n- [ ] Existing tests still pass\n- [ ] Safe git commands still work: `git status`, `git diff`, `git log`, `git add`, `git commit`, `git push` (without --force)\n\n## Notes\n\n- Pattern matching is substring-based; edge cases like `git $VAR --hard` won't be caught\n- Consider suggesting `--force-with-lease` as safer alternative in block message\n- `git checkout -- \u003cspecific-file\u003e` could be allowed (only block `-- .` for all files)\n","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T01:05:31.653651896Z","updated_at":"2025-12-26T16:46:32.669493412Z","closed_at":"2025-12-26T16:46:32.669493412Z","close_reason":"Closed"}
{"id":"mala-20u","title":"Harden PreToolUse hook: robust tool-name matching + tests","description":"Problem: block_dangerous_commands in src/cli.py only checks tool_name == 'Bash'. If SDK uses 'bash' or other names, the safety hook is bypassed.\\n\\nScope/files: src/cli.py, tests (new or existing).\\n\\nWork:\\n- Confirm/assume tool names may vary; make matching robust (case-insensitive set, or accept multiple known names).\\n- Add unit tests for block_dangerous_commands covering allowed/blocked and tool name variations.\\n\\nAcceptance criteria:\\n- Hook blocks dangerous patterns regardless of tool name casing.\\n- Tests cover at least 1 allowed and 1 blocked command for multiple tool names.\\n\\nTDD: Write tests first, then update implementation.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-25T21:38:16.919383816Z","updated_at":"2025-12-25T23:59:03.895437001Z","closed_at":"2025-12-25T23:59:03.895437001Z","close_reason":"Closed"}
{"id":"mala-2ez","title":"Agent mail using filesystem","description":"Agent mail using filesystem: allow agents to send/receive coordination messages via files to reduce lock contention and support handoffs.","status":"closed","priority":4,"issue_type":"epic","created_at":"2025-12-26T00:55:42.268473542Z","updated_at":"2025-12-26T18:28:06.757887173Z","closed_at":"2025-12-26T18:28:06.757887173Z","close_reason":"Closed per user request"}
{"id":"mala-2u3","title":"Epic: Quality Gate Re-entry + Codex Review","description":"Implements same-session re-entry on quality gate failure, shifts issue closing to the orchestrator, and adds a Codex review step with structured JSON output and guardrails.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-26T19:04:48.636008473Z","updated_at":"2025-12-26T19:32:39.524157706Z","closed_at":"2025-12-26T19:32:39.524157706Z","close_reason":"All children completed"}
{"id":"mala-2u3.1","title":"Scope quality gate evidence by attempt","description":"Primary files: src/quality_gate.py, tests/test_quality_gate.py\n\nContext:\n- Gate evidence currently scans the full session log and can pass on stale validation\n- Re-entry needs evidence scoped to the latest attempt\n- No-progress detection should treat unchanged commit + no new evidence as a failure\n\nScope:\n- In: add log-offset-based parsing, return/update offset per attempt, expose a helper that only counts evidence after offset\n- In: add no-progress detection helper (unchanged commit + no new evidence)\n- Out: changes to orchestrator retry loop or prompts\n\nAcceptance Criteria:\n- Evidence parsing can start at a byte offset and ignore earlier log lines\n- Gate result can indicate when no new evidence was found since the last attempt\n- No-progress detection is implemented and covered by tests\n\nTest Plan:\n- TDD: add failing tests for offset parsing and no-progress detection, then implement\n- Run unit tests for quality gate parsing (targeted test file)\n\nNotes for Agent:\n- Keep public API small; prefer a new optional offset argument or a small helper returning (evidence, new_offset)\n","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T19:05:00.499151942Z","updated_at":"2025-12-26T19:12:12.110042901Z","closed_at":"2025-12-26T19:12:12.110042901Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-2u3.1","depends_on_id":"mala-2u3","type":"parent-child","created_at":"2025-12-26T19:05:00.510288361Z","created_by":"daemon"}]}
{"id":"mala-2u3.2","title":"Add retry/review config to CLI and run metadata","description":"Primary files: src/cli.py, src/logging/run_metadata.py\n\nContext:\n- New gate/review retry limits and a codex-review toggle need to be configurable\n- Run metadata should record these config values and per-issue attempt counts\n\nScope:\n- In: add CLI flags --max-gate-retries, --max-review-retries, --codex-review\n- In: extend RunConfig and IssueRun metadata to capture retry limits and attempt counts\n- Out: orchestrator behavior changes (handled separately)\n\nAcceptance Criteria:\n- CLI help shows new flags and defaults\n- Run metadata JSON includes new config fields\n- IssueRun records gate/review attempts (even if defaulted)\n\nTest Plan:\n- Manual: run \"mala run --help\" and verify new flags\n- Manual: run a short session and confirm metadata JSON includes new fields\n\nNotes for Agent:\n- Keep new fields optional/backward compatible in RunMetadata serialization\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T19:05:08.142483863Z","updated_at":"2025-12-26T19:10:26.476631609Z","closed_at":"2025-12-26T19:10:26.476631609Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-2u3.2","depends_on_id":"mala-2u3","type":"parent-child","created_at":"2025-12-26T19:05:08.154749276Z","created_by":"daemon"}]}
{"id":"mala-2u3.3","title":"Shift issue closing to orchestrator","description":"Primary files: src/orchestrator.py, src/beads_client.py, src/prompts/implementer_prompt.md\n\nContext:\n- Agent currently closes issues, which conflicts with same-session re-entry\n- Orchestrator should close only after all gates pass\n\nScope:\n- In: remove bd close instruction from implementer prompt\n- In: add BeadsClient.close_async(issue_id) wrapper\n- In: orchestrator closes issue after gate+review pass\n- Out: re-entry loop or codex review logic (separate tasks)\n\nAcceptance Criteria:\n- Agents no longer call bd close in the prompt\n- Orchestrator closes issues after successful completion\n- No regressions in .beads/issues.jsonl commit flow\n\nTest Plan:\n- Manual: run one issue end-to-end and confirm orchestrator performs bd close\n\nNotes for Agent:\n- Keep orchestrator success criteria aligned with new close flow\n","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T19:05:17.09218776Z","updated_at":"2025-12-26T19:15:17.759359304Z","closed_at":"2025-12-26T19:15:17.759359304Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-2u3.3","depends_on_id":"mala-2u3","type":"parent-child","created_at":"2025-12-26T19:05:17.111639583Z","created_by":"daemon"},{"issue_id":"mala-2u3.3","depends_on_id":"mala-2u3.2","type":"blocks","created_at":"2025-12-26T19:06:12.608088508Z","created_by":"daemon"}]}
{"id":"mala-2u3.4","title":"Implement same-session re-entry on gate failure","description":"Primary files: src/orchestrator.py\n\nContext:\n- Quality gate failures should trigger a same-session fix attempt, not a reopen\n- Claude SDK supports session resume by passing resume: \u003csession_id\u003e\n- Gate retries need guardrails to avoid infinite loops\n\nScope:\n- In: capture session_id from the init system message and store per issue\n- In: implement a gate retry loop with resume calls and failure-reason prompts\n- In: track attempt counts and log offsets per attempt\n- In: avoid adding to failed_issues until retries are exhausted\n- Out: codex review integration (separate task)\n\nAcceptance Criteria:\n- Gate failure triggers a follow-up prompt in the SAME session (resume, no fork)\n- Retries stop after max attempts and mark needs-followup\n- No-progress detection stops retries when commit hash is unchanged and no new evidence exists\n\nTest Plan:\n- Manual: force a gate failure (skip validations) and confirm resume + retry count\n- Manual: confirm retries stop after max\n\nNotes for Agent:\n- Keep retry state per issue to support parallel agents\n","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T19:05:26.093985944Z","updated_at":"2025-12-26T19:22:37.521894989Z","closed_at":"2025-12-26T19:22:37.521894989Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-2u3.4","depends_on_id":"mala-2u3","type":"parent-child","created_at":"2025-12-26T19:05:26.106458545Z","created_by":"daemon"},{"issue_id":"mala-2u3.4","depends_on_id":"mala-2u3.3","type":"blocks","created_at":"2025-12-26T19:06:16.691077263Z","created_by":"daemon"},{"issue_id":"mala-2u3.4","depends_on_id":"mala-2u3.1","type":"blocks","created_at":"2025-12-26T19:06:19.606198443Z","created_by":"daemon"}]}
{"id":"mala-2u3.5","title":"Add Codex review step with strict JSON + retry","description":"Primary files: src/orchestrator.py (optionally new helper module)\n\nContext:\n- After deterministic gates pass, we want an automated Codex review\n- Review output must be strict JSON with one repair retry, then fail closed\n\nScope:\n- In: invoke codex review --commit \u003csha\u003e with a strict JSON schema prompt\n- In: parse JSON output; if invalid, retry once with stricter prompt\n- In: if review fails, resume SAME Claude session with review issues\n- In: re-run deterministic gate after review fixes\n- Out: changes to quality gate parsing logic (separate task)\n\nAcceptance Criteria:\n- Codex review runs after deterministic gate pass\n- JSON parsing is strict with a single retry on parse failure\n- Review failures trigger same-session fixes and re-gating\n\nTest Plan:\n- Manual: run review on a known commit and verify JSON parsing\n- Manual: simulate invalid JSON (e.g., by altering prompt) and verify retry + fail-closed behavior\n\nNotes for Agent:\n- Keep prompts ASCII-only and avoid code fences in the JSON response\n","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T19:05:35.484550183Z","updated_at":"2025-12-26T19:29:10.812795467Z","closed_at":"2025-12-26T19:29:10.812795467Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-2u3.5","depends_on_id":"mala-2u3","type":"parent-child","created_at":"2025-12-26T19:05:35.484834411Z","created_by":"daemon"},{"issue_id":"mala-2u3.5","depends_on_id":"mala-2u3.4","type":"blocks","created_at":"2025-12-26T19:06:23.642607996Z","created_by":"daemon"}]}
{"id":"mala-2u3.6","title":"Update README for orchestrator-close + gate/review retries","description":"Primary files: README.md\n\nContext:\n- Workflow docs currently say the agent closes issues and gate failures reopen later\n- We are changing flow to orchestrator-close + same-session re-entry + codex review\n\nScope:\n- In: update workflow and quality gate sections to reflect new behavior\n- In: document retry limits and codex review step\n- Out: code changes\n\nAcceptance Criteria:\n- README describes orchestrator closing behavior\n- README describes same-session re-entry and review retries\n\nTest Plan:\n- N/A (documentation change)\n\nNotes for Agent:\n- Align wording with actual implemented behavior\n","status":"closed","priority":3,"issue_type":"chore","created_at":"2025-12-26T19:05:43.082927169Z","updated_at":"2025-12-26T19:32:31.343813389Z","closed_at":"2025-12-26T19:32:31.343813389Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-2u3.6","depends_on_id":"mala-2u3","type":"parent-child","created_at":"2025-12-26T19:05:43.094365345Z","created_by":"daemon"},{"issue_id":"mala-2u3.6","depends_on_id":"mala-2u3.5","type":"blocks","created_at":"2025-12-26T19:06:26.62064641Z","created_by":"daemon"}]}
{"id":"mala-3js","title":"Consolidate agent receive loop","description":"Context:\n- agent_loop.py duplicates the receive loop in MalaOrchestrator and is currently unused.\n- Divergent logic increases maintenance risk.\n\nScope:\n- In: consolidate to a single agent receive loop (either delete agent_loop.py or adopt it in orchestrator).\n- Out: changing logging format or agent behavior beyond consolidation.\n\nAcceptance Criteria:\n- Only one receive loop implementation remains.\n- Orchestrator behavior and logging remain consistent with current output.\n\nTest Plan:\n- TDD: if adopting agent_loop, add/adjust tests to cover loop integration; otherwise verify orchestrator tests still pass.\n\nNotes for Agent:\n- Keep JSONL and Braintrust logging order unchanged.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T17:36:04.305912715Z","updated_at":"2025-12-26T19:06:24.780657053Z","closed_at":"2025-12-26T19:06:24.780657053Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-3js","depends_on_id":"mala-jnq","type":"parent-child","created_at":"2025-12-26T17:36:15.734362257Z","created_by":"daemon"},{"issue_id":"mala-3js","depends_on_id":"mala-vdf","type":"blocks","created_at":"2025-12-26T17:36:21.629842741Z","created_by":"daemon"}]}
{"id":"mala-3m7","title":"Deadlock detection between agents","description":"Detect deadlocks between agents (e.g., two agents waiting on each other's locks). Surface the deadlock and provide a resolution path (alert, timeout, or automatic recovery).","status":"closed","priority":4,"issue_type":"epic","created_at":"2025-12-26T00:55:42.798438926Z","updated_at":"2025-12-26T18:28:06.819113751Z","closed_at":"2025-12-26T18:28:06.819113751Z","close_reason":"Closed per user request"}
{"id":"mala-3xv","title":"Add global test mutex wrapper","description":"Context:\n- Track A5 requires serializing repo-wide commands: uv sync, pytest, ruff, ty (docs/coordination-plan-codex.md:44-45).\n- scripts directory currently only contains lock scripts (src/scripts).\n\nScope:\n- In: add a script (e.g., test-mutex.sh) that acquires a global lock and runs a command; release on exit.\n- In: add tests for the mutex behavior in a new test module.\n- Out: no prompt changes (A1) and no orchestrator hooks.\n\nAcceptance Criteria:\n- Wrapper exits non-zero when mutex is held and reports the holder.\n- Successful runs acquire and release the mutex even on command failure.\n- Tests verify acquisition, contention, and release behavior.\n\nTest Plan:\n- TDD: add failing tests in new tests/test_test_mutex.py.\n- Implement script and re-run tests.\n- Run uv run pytest tests/test_test_mutex.py.\n\nNotes for Agent:\n- Pick a stable mutex key (e.g., a fixed path token) to avoid collisions.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T16:44:22.179577746Z","updated_at":"2025-12-26T17:05:43.991099145Z","closed_at":"2025-12-26T17:05:43.991099145Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-3xv","depends_on_id":"mala-4w7","type":"parent-child","created_at":"2025-12-26T16:47:52.996880868Z","created_by":"daemon"}]}
{"id":"mala-3z2","title":"Test: tiny edit","status":"tombstone","priority":2,"issue_type":"task","created_at":"2025-12-25T19:08:44.86959643Z","updated_at":"2025-12-25T19:12:41.579812812Z","deleted_at":"2025-12-25T19:12:41.579812812Z","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"mala-46q","title":"Add orchestrator unit tests (mock bd + SDK)","description":"Problem: Tests focus on lock scripts/SDK integration, but MalaOrchestrator control flow is untested (bd ready/claim/reset, timeout handling, exit code semantics).\\n\\nScope/files: tests/ (new test module), can mock subprocess.run and ClaudeSDKClient to avoid network. Avoid modifying src/cli.py unless absolutely required; if refactor is needed, document why.\\n\\nSuggested tests:\\n- get_ready_issues handles bd JSON and errors.\\n- claim_issue/reset_issue invoked appropriately.\\n- run() handles no ready issues and stops cleanly.\\n- On failed task, resets issue status.\\n\\nAcceptance criteria:\\n- Tests run without network and without actual bd CLI.\\n- Minimal mocking surface; focus on orchestrator state transitions.\\n\\nTDD: Write tests first, then adjust code if needed.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T21:38:34.899307031Z","updated_at":"2025-12-25T23:59:05.389010652Z","closed_at":"2025-12-25T23:59:05.389010652Z","close_reason":"Closed"}
{"id":"mala-4ls","title":"Lock key: hash canonical paths + repo namespace","description":"Problem: Lock filenames are derived by replacing '/' with '_' (scripts + src/tools/locking.py). This causes collisions (e.g., 'a/b' vs 'a_b') and cross-repo contention. Fix by hashing a canonical path (absolute or repo-root+relative) and namespacing locks per repo/cwd.\\n\\nScope/files: scripts/lock-try.sh, lock-check.sh, lock-holder.sh, lock-release.sh, lock-release-all.sh, src/tools/locking.py, tests in tests/test_lock_scripts.py and tests/test_lock_integration.py (and any necessary updates). Consider also centralizing LOCK_DIR/SCRIPTS_DIR if needed.\\n\\nAcceptance criteria:\\n- Lock key is collision-resistant (e.g., sha256 of canonical path).\\n- Locks for different repos/paths do not collide.\\n- Lock holder and cleanup continue to work with AGENT_ID.\\n- Tests updated/added to cover collision case and repo namespace case.\\n\\nTDD: Add/adjust tests first to demonstrate collision and then pass after change.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-25T21:37:59.249680035Z","updated_at":"2025-12-26T00:01:08.029869568Z","closed_at":"2025-12-26T00:01:08.029869568Z","close_reason":"Closed"}
{"id":"mala-4o4","title":"Commit partial progress and mark needs-continuation","status":"tombstone","priority":2,"issue_type":"epic","created_at":"2025-12-26T00:55:42.724613481Z","updated_at":"2025-12-26T00:56:32.195455786Z","deleted_at":"2025-12-26T00:56:32.195455786Z","deleted_by":"daemon","delete_reason":"delete","original_type":"epic"}
{"id":"mala-4ov","title":"Metrics and logging for multi-agent sessions","description":"Add metrics and logging for multi-agent sessions (counts, durations, success/failure rates, queue depth) to make runs observable and debuggable.","status":"closed","priority":4,"issue_type":"epic","created_at":"2025-12-26T00:55:42.866840213Z","updated_at":"2025-12-26T18:28:00.511651865Z","closed_at":"2025-12-26T18:28:00.511651865Z","close_reason":"Closed per user request"}
{"id":"mala-4w7","title":"Epic: Track A Shared-Worktree Hardening","description":"Context:\n- Umbrella epic for Track A (A1–A6) tasks from docs/coordination-plan-codex.md.\n\nScope:\n- In: group all Track A tasks under this epic.\n- Out: no implementation changes.\n\nAcceptance Criteria:\n- All Track A issues are linked as children (directly or via sub-epics).\n\nTest Plan:\n- N/A (coordination-only).\n\nNotes for Agent:\n- Keep A3 as a sub-epic under this umbrella.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-26T16:47:48.086896295Z","updated_at":"2025-12-26T17:15:07.704095723Z","closed_at":"2025-12-26T17:15:07.704095723Z","close_reason":"All children completed"}
{"id":"mala-59n","title":"Fix log indentation and add no-truncation option","description":"## Problem\nLog output has inconsistent indentation and lines are truncated:\n```\n00:43:23 ◌ Waiting for 1 agent(s)...\n  [mala-l7r] ⚙ Bash {'command': 'bd show mala-l7r', 'description': 'Vi\n    [mala-l7r] Now let me understand the codebase structure...\n  [mala-l7r] ⚙ Bash {'command': 'ls -la /home/cyou/mala/src/', 'descri\n```\n\nIssues:\n1. **Inconsistent indentation**: Some lines have 2-space indent, others have 4-space indent before `[agent-id]`\n2. **Truncation**: Lines are cut off (e.g., `'Vi`, `'descri`) without option to see full content\n\n## Scope/files\n- `src/logging/console.py` or equivalent logging module\n- `src/cli.py` or `src/orchestrator.py` for CLI flag\n\n## Work\n1. Fix indentation to be consistent (likely all agent output should have same base indent)\n2. Add `--no-truncate` or `--verbose` CLI flag to disable line truncation\n3. Consider making truncation width configurable\n\n## Acceptance criteria\n- All agent log lines have consistent indentation\n- New flag allows viewing full log lines without truncation\n- Default behavior (truncated) still works","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T00:47:13.094441264Z","updated_at":"2025-12-26T00:57:22.727412832Z","closed_at":"2025-12-26T00:57:22.727412832Z","close_reason":"Closed"}
{"id":"mala-5aa","title":"Refactor: consolidate locking into tools/locking.py","description":"## Context\nLocking behavior is split between `src/filelock.py` and shell scripts in `scripts/`. `src/main.py` directly imports `LOCK_DIR` and `release_all_locks` from `filelock.py` and also defines `make_stop_hook` which relies on lock scripts. The plan is to consolidate locking into `src/tools/locking.py`.\n\n## Scope\nCreate `src/tools/locking.py` only. Do **not** modify `src/main.py` or tests in this issue; integration will wire it up later.\n\n### Files\n- Add: `src/tools/locking.py`\n- (Optional) Modify or remove: `src/filelock.py`\n\n## Requirements\n- `tools/locking.py` should export:\n  - `LOCK_DIR`\n  - `release_all_locks()` (existing behavior)\n  - `cleanup_agent_locks(agent_id)` (existing behavior from `MalaOrchestrator`)\n  - `make_stop_hook(agent_id)` (existing behavior)\n- Decide one:\n  - Keep `src/filelock.py` as a thin re-export for backward compatibility, OR\n  - Remove `src/filelock.py` and update all imports (handled later in integration).\n\n## TDD Guidance\n- If you touch tests in this issue, stop and defer them to integration (tests should be updated there).\n\n## Acceptance Criteria\n- `src/tools/locking.py` exists with the required exports.\n- No other files are modified in this issue (except optional `src/filelock.py`).\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T19:54:51.176735691Z","updated_at":"2025-12-25T20:10:14.682614354Z","closed_at":"2025-12-25T20:10:14.682614354Z","close_reason":"Closed"}
{"id":"mala-5ot","title":"Remove unused sync methods from BeadsClient","description":"## Context\n- `BeadsClient` has both sync and async versions of all methods\n- Orchestrator exclusively uses async versions (`get_ready_async`, `claim_async`, etc.)\n- Sync methods add ~200 lines of duplicated logic\n- Confidence: High - grep confirms no production calls to sync methods\n\n## Primary Files\n`src/beads_client.py:82-278`\n\n## Scope\n**In:** Remove sync methods: `get_epic_children`, `get_ready`, `claim`, `reset`, `get_issue_status`, `commit_issues`, `close_eligible_epics`, `mark_needs_followup`\n**Out:** Keep async methods and `_run_subprocess_async` helper intact\n\n## Acceptance Criteria\n- All sync methods removed from BeadsClient\n- No import errors or missing references\n- All 221 tests pass\n\n## Test Plan\n- Run `uv run pytest`\n- Verify no import errors with `python -c \"from src.beads_client import BeadsClient\"`\n\n## Notes for Agent\n- Tests in `test_orchestrator.py` mock both sync and async methods - only async mocks matter\n- The `DEFAULT_COMMAND_TIMEOUT` constant is used by async methods, keep it","status":"closed","priority":2,"issue_type":"chore","created_at":"2025-12-26T19:44:50.439271516Z","updated_at":"2025-12-26T19:51:49.651613381Z","closed_at":"2025-12-26T19:51:49.651613381Z","close_reason":"Closed","labels":["dead-code"],"dependencies":[{"issue_id":"mala-5ot","depends_on_id":"mala-7zq","type":"parent-child","created_at":"2025-12-26T19:45:26.536295235Z","created_by":"daemon"}]}
{"id":"mala-6ap","title":"Enhanced cleanup on early agent exit: git reset + reopen issue","description":"## Problem\nWhen agents exit early (context exhaustion, error, timeout, etc.), they may leave partial work in the git working tree and the issue in an inconsistent state (e.g., still marked as in_progress).\n\n## Current Behavior\n- Orchestrator calls `reset_issue()` which sets status back, but doesn't clean up git state\n- Partial file changes may remain uncommitted in the working tree\n- Next agent picking up the issue sees a dirty state\n\n## Proposed Solution\nOn early agent exit, the orchestrator should:\n\n1. **Reset git state**: Discard all uncommitted changes for files the agent touched\n   - `git checkout -- \u003cfiles\u003e` or `git restore \u003cfiles\u003e`\n   - Consider `git clean` for any new untracked files created by the agent\n   - Be careful not to discard work from other concurrent agents\n\n2. **Mark issue as open**: Use `bd update \u003cissue\u003e --status open` (not just reset to previous state)\n   - This makes it clear the issue needs to be picked up fresh\n\n3. **Release all locks**: Already done, but ensure it happens before git reset\n\n## Implementation Notes\n- Need to track which files the agent modified (from tool calls in JSONL log)\n- Or simpler: reset only files that match the issue's scope (if defined)\n- Safest approach: only reset files the agent held locks for\n\n## Acceptance Criteria\n- Early exit leaves working tree clean (no partial changes from failed agent)\n- Issue status is set to 'open' \n- Locks are released\n- Other agents' uncommitted work is not affected","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T17:08:40.391592982Z","updated_at":"2025-12-26T18:28:00.450472489Z","closed_at":"2025-12-26T18:28:00.450472489Z","close_reason":"Merged into mala-b0m (Graceful shutdown with agent wrap-up)"}
{"id":"mala-6iv","title":"Test: add hello comment to pyproject.toml","status":"tombstone","priority":2,"issue_type":"task","created_at":"2025-12-25T19:03:17.354821017Z","updated_at":"2025-12-25T19:05:18.077405908Z","close_reason":"Closed","deleted_at":"2025-12-25T19:05:18.077405908Z","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"mala-6m0","title":"Remove dist artifacts from repo","description":"Context:\n- Built artifacts in dist/ are checked into the repo and can become stale or misleading.\n\nScope:\n- In: remove dist artifacts from git and add root .gitignore entries to prevent re-addition.\n- Out: changes to build scripts or release process.\n\nAcceptance Criteria:\n- dist/ artifacts are removed from version control.\n- dist/ is ignored at repo root.\n\nTest Plan:\n- `git status` is clean after removal; building still produces artifacts locally.","status":"closed","priority":4,"issue_type":"chore","created_at":"2025-12-26T17:36:09.569995213Z","updated_at":"2025-12-26T18:41:25.970765111Z","closed_at":"2025-12-26T18:41:25.970765111Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-6m0","depends_on_id":"mala-jnq","type":"parent-child","created_at":"2025-12-26T17:36:15.744955272Z","created_by":"daemon"}]}
{"id":"mala-77z","title":"Remove unused log_result function","description":"## Context\n- `log_result()` is defined but never imported or called anywhere\n- Orchestrator uses `log()` with \"✓\" and \"✗\" icons directly instead\n- ~12 lines of dead code\n- Confidence: High - grep shows only the definition, no callers\n\n## Primary Files\n`src/logging/console.py:263-274`\n\n## Scope\n**In:** Delete the `log_result` function\n**Out:** Keep all other logging functions\n\n## Acceptance Criteria\n- Function removed\n- No import errors or reference breaks\n- Tests pass\n\n## Test Plan\n- Run `uv run pytest`\n- Verify: `python -c \"from src.logging.console import log, log_tool, log_agent_text\"`\n\n## Notes for Agent\n- Function is at lines 263-274, after `log_agent_text`\n- No tests reference this function","status":"closed","priority":2,"issue_type":"chore","created_at":"2025-12-26T19:45:05.56975816Z","updated_at":"2025-12-26T19:53:05.087656466Z","closed_at":"2025-12-26T19:53:05.087656466Z","close_reason":"Closed","labels":["dead-code"],"dependencies":[{"issue_id":"mala-77z","depends_on_id":"mala-7zq","type":"parent-child","created_at":"2025-12-26T19:45:26.566257822Z","created_by":"daemon"}]}
{"id":"mala-781","title":"Package prompt file and align Python requirement","description":"Context:\n- Orchestrator reads the implementer prompt at import; missing files in the wheel will crash CLI startup.\n- Current build config doesn’t explicitly include prompt files in artifacts.\n- requires-python is set to \u003e=3.14 even though the codebase doesn’t appear to need it.\n- Needs verification: confirm wheel contents and the actual minimum supported Python version.\n\nScope:\n- In: include src/prompts/implementer_prompt.md in wheel build config and lower requires-python to the agreed minimum (likely 3.11/3.12).\n- Out: changing prompt content or runtime loading semantics.\n\nAcceptance Criteria:\n- Built wheel contains the prompt file and importing src.orchestrator succeeds.\n- Package installs on the agreed minimum Python version.\n\nTest Plan:\n- Build a wheel and verify prompt file inclusion; run a simple import or `mala status` in a venv.\n\nNotes for Agent:\n- Keep changes isolated to packaging config unless a fallback is required.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-26T17:35:34.45601593Z","updated_at":"2025-12-26T18:20:25.115815935Z","closed_at":"2025-12-26T18:20:25.115815935Z","close_reason":"False positive: hatchling's packages=[\"src\"] includes all files (not just .py), so prompt is already in wheel. Only requires-python issue remains valid but is minor.","dependencies":[{"issue_id":"mala-781","depends_on_id":"mala-jnq","type":"parent-child","created_at":"2025-12-26T17:36:15.690597316Z","created_by":"daemon"}]}
{"id":"mala-784","title":"Ideas: Future improvements","description":"Brainstorm ideas needing grooming:\n- Add back claude orchestrator, manually managing context\n- Agent mail using filesystem?\n- Use codex for code review?\n- Make morphllm optional","status":"tombstone","priority":2,"issue_type":"epic","created_at":"2025-12-26T00:54:39.176848025Z","updated_at":"2025-12-26T00:55:27.983470092Z","deleted_at":"2025-12-26T00:55:27.983470092Z","deleted_by":"daemon","delete_reason":"delete","original_type":"epic"}
{"id":"mala-7pd","title":"Remove Edit from FILE_WRITE_TOOLS (redundant)","description":"## Context\n- `FILE_WRITE_TOOLS` includes `\"Edit\"` for lock enforcement\n- `MORPH_DISALLOWED_TOOLS` also lists `\"Edit\"`, blocking it before lock check runs\n- Lock enforcement hook never triggers for Edit - redundant entry\n- Confidence: Medium - logic is correct but relies on hook ordering\n\n## Primary Files\n`src/hooks.py:50-57`\n\n## Scope\n**In:** Remove `\"Edit\"` from `FILE_WRITE_TOOLS` constant\n**Out:** Don't change `MORPH_DISALLOWED_TOOLS` or lock enforcement logic\n\n## Acceptance Criteria\n- `\"Edit\"` removed from `FILE_WRITE_TOOLS`\n- `\"Edit\"` removed from `FILE_PATH_KEYS` dict\n- Test `test_file_write_tools_constant_contains_expected_tools` updated\n- All tests pass\n\n## Test Plan\n- Run `uv run pytest tests/test_hooks.py`\n- Run full suite: `uv run pytest`\n\n## Notes for Agent\n- Also remove `\"Edit\"` from `FILE_PATH_KEYS` dict (line 61) since it won't be checked\n- Update test in `test_hooks.py:120-124` to not expect `Edit` in the set","status":"closed","priority":3,"issue_type":"chore","created_at":"2025-12-26T19:45:13.913074646Z","updated_at":"2025-12-26T19:50:02.12412912Z","closed_at":"2025-12-26T19:50:02.12412912Z","close_reason":"Closed","labels":["consistency"],"dependencies":[{"issue_id":"mala-7pd","depends_on_id":"mala-7zq","type":"parent-child","created_at":"2025-12-26T19:45:26.577618753Z","created_by":"daemon"}]}
{"id":"mala-7zq","title":"Dead Code and Consistency Cleanup","description":"## Context\n- Healthcheck identified ~250 lines of dead code from incomplete async migration\n- Sync methods exist alongside async versions but are never called in production\n- Minor consistency issues in hook constants\n- All child issues are independent and can parallelize\n\n## Scope\n**In:** Remove dead code, fix consistency issues identified in healthcheck\n**Out:** No functional changes, no new features\n\n## Acceptance Criteria\n- All child issues completed\n- Test suite still passes (221 tests)\n- No dead code warnings from static analysis\n\n## Test Plan\n- Run `uv run pytest` after all children complete","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-26T19:44:42.537192954Z","updated_at":"2025-12-26T19:53:05.164431129Z","closed_at":"2025-12-26T19:53:05.164431129Z","close_reason":"All children completed","labels":["dead-code"]}
{"id":"mala-81g","title":"Explore using CLAUDE_CONFIG_DIR to isolate mala agent logs from system Claude Code","description":"Investigate setting CLAUDE_CONFIG_DIR environment variable when spawning agents to write JSONL logs to a separate location (e.g., ~/.config/mala/claude-logs/) instead of mixing with system Claude Code logs in ~/.claude/projects/. This would make log management and cleanup easier for mala-specific sessions.","status":"blocked","priority":2,"issue_type":"task","created_at":"2025-12-26T18:20:17.980544403Z","updated_at":"2025-12-26T18:25:19.995198414Z","labels":["blocked"]}
{"id":"mala-9ki","title":"Refactor: add tools/env.py and centralize env loading","description":"## Context\n`src/main.py` currently defines `USER_CONFIG_DIR`, `JSONL_LOG_DIR`, `SCRIPTS_DIR`, and performs dotenv loading at import time. This creates side effects and makes reuse/testing harder. The architecture plan calls for a small `tools/env.py` module that owns config paths and env loading, while preserving the **early** load needed for Braintrust setup.\n\n## Scope\nCreate a new module `src/tools/env.py` only. Do **not** modify `src/main.py` in this issue; integration will wire it up later.\n\n### Files\n- Add: `src/tools/env.py`\n\n## Requirements\n- `tools/env.py` should define:\n  - `USER_CONFIG_DIR = Path.home() / \".config\" / \"mala\"`\n  - `JSONL_LOG_DIR = USER_CONFIG_DIR / \"logs\"`\n  - `SCRIPTS_DIR` that points to repo `scripts/` (from `src/tools/env.py`, use `Path(__file__).resolve().parents[2] / \"scripts\"` or equivalent)\n- Provide two helpers:\n  - `load_user_env()` that loads `${USER_CONFIG_DIR}/.env` only (for early Braintrust setup)\n  - `load_env(repo_path: Path | None)` that calls `load_user_env()` and then (if `repo_path` is provided) loads `\u003crepo_path\u003e/.env` with `override=True`\n\n## Acceptance Criteria\n- `src/tools/env.py` exists with the above constants and functions.\n- No other files are modified in this issue.\n\n## Notes\n- Integration issue will wire these into `src/main.py`.\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T19:54:51.122065094Z","updated_at":"2025-12-25T20:08:26.994504903Z","closed_at":"2025-12-25T20:08:26.994504903Z","close_reason":"Closed"}
{"id":"mala-9qr","title":"Refactor: extract hook logic from src/cli.py","description":"Goal: Make hook logic self-contained by moving block_dangerous_commands (and related constants) into a new module (e.g., src/hooks.py).\\n\\nScope/files: src/cli.py, new src/hooks.py.\\n\\nWork:\\n- Move DANGEROUS_PATTERNS + block_dangerous_commands to new module.\\n- Update imports in cli.py.\\n- Keep behavior unchanged.\\n\\nAcceptance criteria:\\n- CLI behavior unchanged.\\n- Hook still used in ClaudeAgentOptions.hooks.\\n- Tests (if any) still pass.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-25T21:41:10.672408295Z","updated_at":"2025-12-26T00:06:41.954204714Z","closed_at":"2025-12-26T00:06:41.954204714Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-9qr","depends_on_id":"mala-akl","type":"blocks","created_at":"2025-12-25T21:47:25.567206045Z","created_by":"daemon"},{"issue_id":"mala-9qr","depends_on_id":"mala-c01","type":"parent-child","created_at":"2025-12-25T22:05:59.455394242Z","created_by":"daemon"}]}
{"id":"mala-aht","title":"Epic: Healthcheck reliability fixes","description":"Context:\n- Umbrella for issues from the code health review (orchestrator + beads reliability).\n- Keep fixes small and parallel where possible.\n\nScope:\n- In: reliability/correctness fixes from the review output.\n- Out: new features or architecture changes.\n\nAcceptance Criteria:\n- Child issues created and linked.\n\nTest Plan:\n- N/A (epic).","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-26T19:54:23.723935931Z","updated_at":"2025-12-26T19:54:23.723935931Z"}
{"id":"mala-aht.1","title":"Stop gate retry loop when Claude log is missing","description":"Context:\n- run_implementer only proceeds if the Claude session log exists after a ResultMessage (src/orchestrator.py:348).\n- If the log never appears, the loop spins until global timeout, causing false failures and queue stalls.\n\nScope:\n- In: add a bounded wait for log creation; if missing, fail fast with a clear summary and exit the loop.\n- Out: changing the log directory or disabling the quality gate.\n\nAcceptance Criteria:\n- When log file never appears, run_implementer exits within a bounded wait and sets a summary indicating missing log.\n- Orchestrator does not stall for the full timeout due to missing logs.\n\nTest Plan:\n- TDD: add a failing unit test with a mocked client that yields ResultMessage but no log file; assert run_implementer returns quickly with a failure summary.\n- Run pytest for the new test.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-26T19:54:34.157781045Z","updated_at":"2025-12-26T20:26:33.740210331Z","closed_at":"2025-12-26T20:26:33.740210331Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-aht.1","depends_on_id":"mala-aht","type":"parent-child","created_at":"2025-12-26T19:54:34.165963474Z","created_by":"daemon"}]}
{"id":"mala-aht.2","title":"Avoid releasing locks owned by other runs","description":"Context:\n- Orchestrator always calls release_all_locks on shutdown (src/orchestrator.py:835), which deletes every lock file in LOCK_DIR (src/tools/locking.py:111).\n- If multiple mala runs share LOCK_DIR, one run can clear locks for another, enabling concurrent writes. Needs verification.\n\nScope:\n- In: only clean up locks owned by this run's agents or isolate each run with a unique LOCK_DIR; keep admin/global cleanup for manual use.\n- Out: redesigning the locking protocol.\n\nAcceptance Criteria:\n- Run cleanup leaves locks owned by other agent IDs intact.\n- Each run only removes its own locks.\n\nTest Plan:\n- TDD: add a unit test that creates lock files for two agent IDs; run cleanup and verify only matching locks are removed.\n- Run pytest for new locking/orchestrator tests.","status":"in_progress","priority":1,"issue_type":"bug","created_at":"2025-12-26T19:54:42.017640957Z","updated_at":"2025-12-26T20:26:33.770377744Z","dependencies":[{"issue_id":"mala-aht.2","depends_on_id":"mala-aht","type":"parent-child","created_at":"2025-12-26T19:54:42.026062315Z","created_by":"daemon"},{"issue_id":"mala-aht.2","depends_on_id":"mala-aht.1","type":"blocks","created_at":"2025-12-26T19:55:09.816278845Z","created_by":"daemon"}]}
{"id":"mala-aht.3","title":"Terminate bd/git subprocesses on timeout","description":"Context:\n- _run_subprocess_async wraps subprocess.run in a thread and uses asyncio.wait_for; timeouts return but the subprocess keeps running (src/beads_client.py:38-70).\n- Hanging bd/git processes can accumulate during long runs.\n\nScope:\n- In: ensure timed-out commands are terminated (e.g., pass timeout to subprocess.run and handle TimeoutExpired, or switch to asyncio subprocess and kill).\n- Out: changing bd CLI usage.\n\nAcceptance Criteria:\n- Timed-out commands are terminated and return a timeout result.\n- Timeout warnings still emit.\n\nTest Plan:\n- TDD: add a failing test mocking subprocess.run to raise TimeoutExpired and assert a safe timeout result.\n- Run pytest for BeadsClient tests.","status":"in_progress","priority":2,"issue_type":"bug","created_at":"2025-12-26T19:54:51.724656053Z","updated_at":"2025-12-26T20:10:53.452538516Z","dependencies":[{"issue_id":"mala-aht.3","depends_on_id":"mala-aht","type":"parent-child","created_at":"2025-12-26T19:54:51.74113736Z","created_by":"daemon"}]}
{"id":"mala-aht.4","title":"Consolidate sync/async BeadsClient implementations","description":"Context:\n- BeadsClient maintains parallel sync and async implementations for the same actions (src/beads_client.py:80 and :244).\n- This duplication risks drift and unused code; needs verification that sync APIs are still required beyond tests.\n\nScope:\n- In: consolidate shared logic or deprecate/remove sync methods if unused; update tests accordingly.\n- Out: changing bd command semantics.\n\nAcceptance Criteria:\n- One authoritative implementation per action.\n- Tests updated and passing.\n\nTest Plan:\n- Run pytest for BeadsClient/orchestrator tests.","status":"open","priority":2,"issue_type":"chore","created_at":"2025-12-26T19:55:00.28451646Z","updated_at":"2025-12-26T19:55:00.28451646Z","dependencies":[{"issue_id":"mala-aht.4","depends_on_id":"mala-aht","type":"parent-child","created_at":"2025-12-26T19:55:00.300728599Z","created_by":"daemon"},{"issue_id":"mala-aht.4","depends_on_id":"mala-aht.3","type":"blocks","created_at":"2025-12-26T19:55:13.994459065Z","created_by":"daemon"}]}
{"id":"mala-akl","title":"mala run exit code: treat no-issue runs as success","description":"Problem: src/cli.py returns exit code 1 when success_count == 0. This makes no-op runs (no issues ready) look like failures in automation.\\n\\nScope/files: src/cli.py.\\n\\nWork:\\n- Distinguish 'no issues processed' from 'issues processed but failed'.\\n- Update exit code to 0 when there were no issues to process. Keep non-zero when actual failures occurred.\\n\\nAcceptance criteria:\\n- If no issues are ready, mala run exits 0.\\n- If issues ran and all failed, still exits non-zero.\\n- If some succeeded, exits 0.\\n\\nDependency: Avoid concurrent edits with mala-20u (same file).","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T21:38:26.013087673Z","updated_at":"2025-12-26T00:00:32.928066608Z","closed_at":"2025-12-26T00:00:32.928066608Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-akl","depends_on_id":"mala-20u","type":"blocks","created_at":"2025-12-25T21:38:51.94427495Z","created_by":"daemon"}]}
{"id":"mala-anh","title":"Refactor: split src/cli.py into focused modules","description":"Goal: Reduce the 600+ line cli module by extracting focused modules (e.g., orchestrator.py, hooks.py, prompt.py, git_utils.py). Keep external behavior unchanged.\\n\\nScope/files: src/cli.py plus new modules under src/.\\n\\nSuggested steps:\\n1) Identify pure helpers (git commit/branch, prompt loading, hook logic).\\n2) Move orchestration class to its own module.\\n3) Keep CLI wiring in cli.py, import helpers.\\n4) Update imports/tests.\\n\\nAcceptance criteria:\\n- CLI commands unchanged.\\n- No behavior changes to orchestrator loop.\\n- Tests pass (or at least no regressions).","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-25T21:40:15.520698126Z","updated_at":"2025-12-25T21:41:31.71957273Z","closed_at":"2025-12-25T21:41:31.71957273Z","close_reason":"Split into smaller refactor tasks: mala-9qr (hooks), mala-dqt (git helpers), mala-as5 (orchestrator extraction)."}
{"id":"mala-as5","title":"Refactor: move MalaOrchestrator to its own module","description":"Goal: Extract MalaOrchestrator class from src/cli.py into a dedicated module (e.g., src/orchestrator.py) to reduce file size and clarify responsibilities.\\n\\nScope/files: src/cli.py, new src/orchestrator.py.\\n\\nWork:\\n- Move IssueResult + MalaOrchestrator to new module.\\n- Adjust imports in cli.py.\\n- Keep CLI command signatures and behavior unchanged.\\n\\nAcceptance criteria:\\n- Orchestrator behavior unchanged.\\n- CLI still works.\\n- Tests (if any) still pass.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-25T21:41:26.002972067Z","updated_at":"2025-12-26T00:15:52.939703847Z","closed_at":"2025-12-26T00:15:52.939703847Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-as5","depends_on_id":"mala-dqt","type":"blocks","created_at":"2025-12-25T21:47:35.258531693Z","created_by":"daemon"},{"issue_id":"mala-as5","depends_on_id":"mala-c01","type":"parent-child","created_at":"2025-12-25T22:05:59.484296839Z","created_by":"daemon"}]}
{"id":"mala-b0m","title":"Graceful shutdown with agent wrap-up","description":"## Goal\nHandle agent exit gracefully: signal active agents to wrap up, clean up partial state, and ensure consistent issue status before exit.\n\n## Problem\nWhen agents exit early (context exhaustion, error, timeout, orchestrator shutdown), they may leave:\n- Partial work uncommitted in the git working tree\n- Issue in inconsistent state (e.g., still marked as in_progress)\n- Locks held without cleanup\n\n## Current Behavior\n- Orchestrator calls `reset_issue()` which sets status back, but doesn't clean up git state\n- Partial file changes may remain uncommitted in the working tree\n- Next agent picking up the issue sees a dirty state\n\n## Proposed Solution\nOn agent exit (early or orchestrator shutdown):\n\n1. **Signal agents to wrap up**: Give active agents a chance to commit partial work or rollback cleanly\n\n2. **Reset git state**: Discard uncommitted changes for files the agent touched\n   - `git checkout -- \u003cfiles\u003e` or `git restore \u003cfiles\u003e`\n   - Consider `git clean` for new untracked files created by the agent\n   - Be careful not to discard work from other concurrent agents\n\n3. **Mark issue as open**: Use `bd update \u003cissue\u003e --status open` (not just reset to previous state)\n\n4. **Release all locks**: Ensure locks are released before git reset\n\n5. **Emit final summary**: Log what was cleaned up and issue states\n\n## Implementation Notes\n- Track which files the agent modified (from tool calls in JSONL log)\n- Or simpler: reset only files the agent held locks for\n- Safest approach: only reset files associated with locks held by the exiting agent\n\n## Acceptance Criteria\n- Early exit leaves working tree clean (no partial changes from failed agent)\n- Orchestrator shutdown signals all agents before force-terminating\n- Issue status is set to 'open' on failure\n- Locks are released\n- Other agents' uncommitted work is not affected\n- Final summary emitted showing cleanup actions","status":"blocked","priority":4,"issue_type":"epic","created_at":"2025-12-26T00:55:42.940976936Z","updated_at":"2025-12-26T18:27:54.400792078Z"}
{"id":"mala-bgl","title":"Save progress state on context exhaustion","status":"tombstone","priority":2,"issue_type":"epic","created_at":"2025-12-26T00:55:42.565812819Z","updated_at":"2025-12-26T00:56:32.19480344Z","deleted_at":"2025-12-26T00:56:32.19480344Z","deleted_by":"daemon","delete_reason":"delete","original_type":"epic"}
{"id":"mala-buj","title":"Remove unused sync git functions","description":"## Context\n- `get_git_commit()` and `get_git_branch()` (sync versions) are defined but never called\n- Only async versions (`get_git_commit_async`, `get_git_branch_async`) are used by orchestrator\n- ~30 lines of dead code\n- Confidence: High - grep confirms no callers\n\n## Primary Files\n`src/git_utils.py:14-45`\n\n## Scope\n**In:** Remove `get_git_commit` and `get_git_branch` sync functions\n**Out:** Keep async versions and `DEFAULT_GIT_TIMEOUT` constant\n\n## Acceptance Criteria\n- Sync functions removed\n- No import errors\n- Tests pass\n\n## Test Plan\n- Run `uv run pytest`\n- Verify module imports cleanly: `python -c \"from src.git_utils import get_git_commit_async\"`\n\n## Notes for Agent\n- Keep the module docstring and async functions intact\n- The sync functions are lines 14-45, async are 51-100","status":"closed","priority":2,"issue_type":"chore","created_at":"2025-12-26T19:44:58.439537512Z","updated_at":"2025-12-26T19:52:03.649089915Z","closed_at":"2025-12-26T19:52:03.649089915Z","close_reason":"Closed","labels":["dead-code"],"dependencies":[{"issue_id":"mala-buj","depends_on_id":"mala-7zq","type":"parent-child","created_at":"2025-12-26T19:45:26.554545264Z","created_by":"daemon"}]}
{"id":"mala-bvd","title":"Other Improvements","description":"General improvements:\n- Deadlock detection (two agents waiting on each other)\n- Metrics/logging for multi-agent sessions\n- Graceful shutdown (signal all agents to wrap up)","status":"tombstone","priority":2,"issue_type":"epic","created_at":"2025-12-26T00:54:39.298081197Z","updated_at":"2025-12-26T00:55:27.989133028Z","deleted_at":"2025-12-26T00:55:27.989133028Z","deleted_by":"daemon","delete_reason":"delete","original_type":"epic"}
{"id":"mala-c01","title":"Epic: CLI module refactor (split cli.py)","description":"Parent epic for refactoring src/cli.py into focused modules without changing behavior. Children: hook extraction, git helper extraction, orchestrator extraction.","status":"closed","priority":3,"issue_type":"epic","created_at":"2025-12-25T21:41:59.788032839Z","updated_at":"2025-12-26T00:15:59.835213834Z","closed_at":"2025-12-26T00:15:59.835213834Z","close_reason":"All children completed"}
{"id":"mala-c01.1","title":"Refactor: extract beads client from cli.py","description":"Goal: Extract beads-related logic from MalaOrchestrator into a dedicated BeadsClient class (e.g., src/beads_client.py) that wraps bd CLI calls.\n\nScope/files: src/cli.py, new src/beads_client.py.\n\nWork:\n- Create BeadsClient class with methods: get_ready_issues(), claim_issue(), reset_issue(), commit_issues(), close_eligible_epics().\n- Move bd CLI subprocess calls from MalaOrchestrator to BeadsClient.\n- Have MalaOrchestrator use BeadsClient instance.\n- Keep CLI behavior unchanged.\n\nAcceptance criteria:\n- All bd CLI calls go through BeadsClient.\n- MalaOrchestrator behavior unchanged.\n- CLI still works.\n- Tests (if any) still pass.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-25T22:15:22.761330846Z","updated_at":"2025-12-26T00:09:17.45761968Z","closed_at":"2025-12-26T00:09:17.45761968Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-c01.1","depends_on_id":"mala-c01","type":"parent-child","created_at":"2025-12-25T22:15:22.771293472Z","created_by":"daemon"}]}
{"id":"mala-c5n","title":"Replace exponential backoff with simple 1s polling for lock waits","description":"## Problem\nThe implementer prompt instructs agents to use exponential backoff (10s, 20s, 40s, 80s, 160s, 320s, 640s) when waiting for locks. This has two issues:\n\n1. **Noisy logs**: Agents print a message every time they sleep, cluttering output\n2. **Over-engineering**: Exponential backoff adds complexity; a simple 1-second polling loop is simpler and equally effective for file locks\n\n## Current Behavior\nFrom src/prompts/implementer_prompt.md:53:\n```\n- Use exponential backoff: 10s, 20s, 40s, 80s, 160s, 320s, 640s (max 15 min total)\n```\n\n## Proposed Solution\n\nOption A: Add a helper script (e.g., `scripts/lock-wait.sh`) that:\n- Takes a file path and agent ID\n- Polls every 1 second until lock is available\n- Prints status only once at start and once when acquired\n- Agent calls this instead of implementing backoff loop\n\nOption B: Update prompt to use simpler guidance:\n- Replace exponential backoff with 'poll every 1 second'\n- Tell agent not to print on every poll, just when starting and when acquired\n\n## Acceptance Criteria\n- Agents no longer spam logs while waiting for locks\n- Lock waiting behavior is simple (1s fixed interval)\n- Either via helper script or updated prompt guidance","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T17:07:53.583339508Z","updated_at":"2025-12-26T17:16:00.837069817Z","closed_at":"2025-12-26T17:16:00.837069817Z","close_reason":"Closed"}
{"id":"mala-cdw","title":"Context Exhaustion Handling","description":"When agents run out of context mid-implementation:\n- Detect context exhaustion (agent returns incomplete)\n- Save progress state (files modified, locks held)\n- Spawn continuation agent with summary of prior work\n- Or: commit partial progress, mark issue as needs-continuation","status":"tombstone","priority":2,"issue_type":"epic","created_at":"2025-12-26T00:54:39.236980254Z","updated_at":"2025-12-26T00:55:27.98871018Z","deleted_at":"2025-12-26T00:55:27.98871018Z","deleted_by":"daemon","delete_reason":"delete","original_type":"epic"}
{"id":"mala-d6x","title":"Context exhaustion handling","description":"When agents run out of context mid-implementation, handle it explicitly: detect exhaustion, save progress state (files modified, locks held), spawn a continuation agent with a summary, or commit partial progress and mark needs-continuation.","status":"blocked","priority":4,"issue_type":"epic","created_at":"2025-12-26T00:56:35.644475789Z","updated_at":"2025-12-26T15:36:54.475107527Z"}
{"id":"mala-d6x.1","title":"Detect context exhaustion in agent runs","description":"Detect when an agent run exhausts context or returns incomplete output. Emit a structured reason (e.g., context_exhausted) so the orchestrator can trigger follow-up handling without treating it as a generic failure.","status":"tombstone","priority":2,"issue_type":"task","created_at":"2025-12-26T01:14:09.957270657Z","updated_at":"2025-12-26T15:33:44.086569066Z","deleted_at":"2025-12-26T15:33:44.086569066Z","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"mala-d6x.2","title":"Persist progress snapshot on context exhaustion","description":"When context exhaustion is detected, capture a progress snapshot (modified files, locks held, agent summary, and any partial results) in a durable location so continuation can resume safely.","status":"tombstone","priority":2,"issue_type":"task","created_at":"2025-12-26T01:14:15.412064244Z","updated_at":"2025-12-26T15:33:44.086569066Z","deleted_at":"2025-12-26T15:33:44.086569066Z","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"mala-d6x.3","title":"Spawn continuation agent with prior summary","description":"After persisting a progress snapshot, spawn a continuation agent and pass a concise summary + snapshot path so it can resume work without losing context.","status":"tombstone","priority":2,"issue_type":"task","created_at":"2025-12-26T01:14:19.459225253Z","updated_at":"2025-12-26T15:33:44.086569066Z","deleted_at":"2025-12-26T15:33:44.086569066Z","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"mala-d6x.4","title":"Commit partial progress and mark needs-continuation","description":"Provide a fallback path to commit partial work on context exhaustion and mark the issue as needs-continuation (status/notes) so a future run can pick it up intentionally.","status":"tombstone","priority":2,"issue_type":"task","created_at":"2025-12-26T01:14:24.562096252Z","updated_at":"2025-12-26T15:33:44.086569066Z","deleted_at":"2025-12-26T15:33:44.086569066Z","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"mala-dqp","title":"Fix lock enforcement canonicalization","description":"Context:\n- Hook lock checks use repo-relative hashing, but current canonicalization can diverge from lock scripts when mala is launched outside the repo.\n- This can cause false \"not locked\" blocks or allow writes without a matching lock.\n- The unused lock hook duplicates logic and risks drift.\n- Needs verification: reproduce mismatch by running from a non-repo cwd.\n\nScope:\n- In: unify path canonicalization between shell scripts and Python hook (use repo namespace consistently), pass repo path into lock enforcement, remove redundant hook, and ensure LOCK_DIR mkdir uses parents=True.\n- Out: redesigning the locking model or changing lock script behavior beyond canonicalization.\n\nAcceptance Criteria:\n- A lock acquired via lock-try.sh is recognized by the PreToolUse hook even when mala is launched from outside the repo.\n- Hook blocks writes when another agent holds the lock and allows when the current agent holds it.\n- Redundant lock hook removed (single source of truth).\n- Nested MALA_LOCK_DIR paths start without error.\n\nTest Plan:\n- TDD: add failing test for cross-cwd lock enforcement, implement fix, then run lock integration tests.\n- Run relevant tests in tests/test_lock_sdk_integration.py and tests/test_lock_scripts.py.\n\nNotes for Agent:\n- Keep canonicalization consistent with lock-try.sh hashing; avoid changing lock key format.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-26T17:35:26.214219228Z","updated_at":"2025-12-26T18:45:48.051480297Z","closed_at":"2025-12-26T18:45:48.051480297Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-dqp","depends_on_id":"mala-jnq","type":"parent-child","created_at":"2025-12-26T17:36:15.673575659Z","created_by":"daemon"}]}
{"id":"mala-dqt","title":"Refactor: extract git helper functions","description":"Goal: Move git helper(s) from src/cli.py (e.g., get_git_commit) into a small utility module (e.g., src/git_utils.py).\\n\\nScope/files: src/cli.py, new src/git_utils.py.\\n\\nWork:\\n- Move get_git_commit (and any related helpers if needed).\\n- Update imports in cli.py.\\n- Keep behavior unchanged.\\n\\nAcceptance criteria:\\n- Same git commit info used in metadata.\\n- No behavior changes to CLI.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-25T21:41:18.022578128Z","updated_at":"2025-12-26T00:11:10.071338973Z","closed_at":"2025-12-26T00:11:10.071338973Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-dqt","depends_on_id":"mala-9qr","type":"blocks","created_at":"2025-12-25T21:47:31.302567088Z","created_by":"daemon"},{"issue_id":"mala-dqt","depends_on_id":"mala-c01","type":"parent-child","created_at":"2025-12-25T22:05:59.473063215Z","created_by":"daemon"}]}
{"id":"mala-dyt","title":"Improve tool call formatting with better colors and code pretty-printing","description":"## Goal\n1. **All tools**: Skip \"args:\" prefix and JSON brackets, use `key: value` format with distinct colors\n2. **Edit tools**: Pretty-print code fields with actual newlines and distinct coloring\n3. **CLI flag**: Change `--no-truncate` to `--verbose` / `-v`\n\n## Current output\n```\n  [mala-e47] ⚙ mcp__morphllm__edit_file\n    args:\n    {\n      \"path\": \"/home/cyou/mala/tests/test_orchestrator.py\",\n      \"code_edit\": \"    @pytest.mark.asyncio\\n    async def...\"\n    }\n```\n\n## Desired output\n```\n  [mala-e47] ⚙ mcp__morphllm__edit_file\n    path: /home/cyou/mala/tests/test_orchestrator.py     \u003c- key=CYAN, value=WHITE\n    instruction: Update mock_get_ready signature...\n    code_edit:                                           \u003c- key=CYAN\n        @pytest.mark.asyncio                             \u003c- code=GRAY/dim\n        async def test_success...\n```\n\n## Files to modify\n- `src/cli.py` - rename flag from --no-truncate to --verbose/-v\n- `src/logging/console.py` - formatting logic\n\n## Implementation\n1. Rename CLI flag to --verbose/-v\n2. Define constants for edit tool detection and code fields\n3. Rewrite _format_arguments() for key:value format with colors\n4. For edit tools, expand code fields with actual newlines\n5. Remove \"args:\" prefix from output","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T19:08:00.801228302Z","updated_at":"2025-12-26T19:14:26.272944778Z","closed_at":"2025-12-26T19:14:26.272944778Z","close_reason":"Closed"}
{"id":"mala-e47","title":"Update orchestrator tests for get_ready signature and max_agents default","description":"Tests currently mock get_ready without the new suppress_warn_ids param and still assert max_agents==3 even though default is now unlimited (None). Update tests to match current behavior and avoid TypeError.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T15:34:00.738271737Z","updated_at":"2025-12-26T18:42:41.370094167Z","closed_at":"2025-12-26T18:42:41.370094167Z","close_reason":"Closed"}
{"id":"mala-f69","title":"Default to unlimited concurrent agents","description":"Goal: Change the default for --max-agents/-n to unlimited (no cap on concurrent agents).\n\nCurrent behavior: max_agents defaults to 3, limiting concurrent agent execution.\n\nDesired behavior: By default, spawn as many agents as there are ready issues. Users can still use --max-agents to set a limit if needed.\n\nScope/files: src/cli.py, src/orchestrator.py.\n\nWork:\n- Change max_agents default from 3 to None (unlimited).\n- Update orchestrator logic to handle None as 'spawn all ready issues'.\n- Update help text to reflect new default.\n\nAcceptance criteria:\n- 'mala run' with no flags spawns agents for all ready issues.\n- 'mala run --max-agents 3' limits to 3 concurrent agents.\n- Logging/status output reflects unlimited when no cap set.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T00:18:53.28766291Z","updated_at":"2025-12-26T00:50:20.634125479Z","closed_at":"2025-12-26T00:50:20.634125479Z","close_reason":"Closed"}
{"id":"mala-fih","title":"Claude orchestrator with manual context management","description":"Add back a Claude-based orchestrator that manually manages context windows (non-MCP), for long-running tasks that exceed default context limits.","status":"blocked","priority":4,"issue_type":"epic","created_at":"2025-12-26T00:55:42.188094716Z","updated_at":"2025-12-26T15:36:54.477549316Z"}
{"id":"mala-ggx","title":"Spawn continuation agent with prior work summary","status":"tombstone","priority":2,"issue_type":"epic","created_at":"2025-12-26T00:55:42.639177056Z","updated_at":"2025-12-26T00:56:32.195175308Z","deleted_at":"2025-12-26T00:56:32.195175308Z","deleted_by":"daemon","delete_reason":"delete","original_type":"epic"}
{"id":"mala-ih0","title":"Use codex for code review","description":"Use Codex for code review: add an optional post-implementation review pass and surface findings before commit/close.","status":"blocked","priority":4,"issue_type":"epic","created_at":"2025-12-26T00:55:42.345522647Z","updated_at":"2025-12-26T15:36:54.47710734Z"}
{"id":"mala-iml","title":"Widen quality gate commit window","description":"Context:\n- Quality gate only searches commits from the last 24 hours; long-running work gets flagged as failed even when commits exist.\n- Needs verification: confirm intended commit search window policy.\n\nScope:\n- In: widen or parameterize the commit search window and update related tests.\n- Out: changing validation command requirements or gate semantics beyond the commit window.\n\nAcceptance Criteria:\n- A commit older than 1 day with bd-\u003cissue_id\u003e satisfies the gate.\n- Failure message reflects the new window if no commit is found.\n\nTest Plan:\n- TDD: add a failing test for an older commit, implement the change, then run quality gate tests in tests/test_orchestrator.py.\n\nNotes for Agent:\n- Keep the log parsing behavior unchanged.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-26T17:35:48.828509883Z","updated_at":"2025-12-26T18:47:04.234602018Z","closed_at":"2025-12-26T18:47:04.234602018Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-iml","depends_on_id":"mala-jnq","type":"parent-child","created_at":"2025-12-26T17:36:15.712687221Z","created_by":"daemon"}]}
{"id":"mala-jnq","title":"Epic: Code health fixes from review","description":"Goal: address high/medium issues from the code health review with minimal overlap and clear dependencies.\n\\nScope:\n- Focus on lock enforcement correctness, build packaging, Braintrust config order, quality gate robustness, async bd calls, agent loop consolidation, and repo hygiene.\n- Out: feature work or architecture redesign beyond the listed fixes.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-26T17:35:14.749720136Z","updated_at":"2025-12-26T19:32:39.518659356Z","closed_at":"2025-12-26T19:32:39.518659356Z","close_reason":"All children completed"}
{"id":"mala-jxc","title":"Enforce lock ownership in PreToolUse","description":"Context:\n- Track A2 requires a PreToolUse hook that blocks file writes unless the agent holds the lock (docs/coordination-plan-codex.md:30-32).\n- hooks currently only block dangerous commands and Morph tool usage (src/hooks.py:37-86).\n- Orchestrator registers PreToolUse hooks in run_implementer (src/orchestrator.py:145-155).\n\nScope:\n- In: add a new PreToolUse hook to detect file-write tool calls and verify lock ownership via locking helpers.\n- In: register the new hook in the orchestrator PreToolUse hook list.\n- Out: no changes to lock key generation or prompt content.\n\nAcceptance Criteria:\n- File-write tool uses are blocked when the agent does not hold the lock; allowed when it does.\n- Block reason includes the file path and current lock holder when available.\n- Orchestrator includes the new hook in PreToolUse.\n\nTest Plan:\n- TDD: add failing unit tests for hook behavior with and without locks.\n- Implement hook, update tests to pass.\n- Run uv run pytest for the new/updated hook tests.\n\nNotes for Agent:\n- Confirm tool input shapes for file paths and which tools count as writes (needs verification).","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T16:43:36.955166144Z","updated_at":"2025-12-26T17:01:31.441554529Z","closed_at":"2025-12-26T17:01:31.441554529Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-jxc","depends_on_id":"mala-4w7","type":"parent-child","created_at":"2025-12-26T16:47:52.974558844Z","created_by":"daemon"}]}
{"id":"mala-kpf","title":"Clean up file_lock shim / align lock owner format","description":"Problem: src/tools/locking.py:file_lock writes PID into lock files and src/filelock.py re-exports it, but the rest of the system uses AGENT_ID in lock files. file_lock is unused and inconsistent.\\n\\nScope/files: src/tools/locking.py, src/filelock.py (and possibly tests).\\n\\nOptions:\\n- Remove file_lock and filelock.py entirely, or\\n- Rework file_lock to use the same AGENT_ID scheme and lock keying as the scripts.\\n\\nAcceptance criteria:\\n- No dead/unused locking API left behind.\\n- If kept, file_lock uses the same lock format + keying as scripts.\\n- Tests updated if necessary.\\n\\nDependency: Must wait for lock-key hashing change (mala-4ls) because both edit src/tools/locking.py.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T21:38:08.362262314Z","updated_at":"2025-12-26T00:04:34.226695444Z","closed_at":"2025-12-26T00:04:34.226695444Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-kpf","depends_on_id":"mala-4ls","type":"blocks","created_at":"2025-12-25T21:38:46.924557872Z","created_by":"daemon"}]}
{"id":"mala-kz4","title":"Detect context exhaustion","status":"tombstone","priority":2,"issue_type":"epic","created_at":"2025-12-26T00:55:42.494971406Z","updated_at":"2025-12-26T00:56:32.189479702Z","deleted_at":"2025-12-26T00:56:32.189479702Z","deleted_by":"daemon","delete_reason":"delete","original_type":"epic"}
{"id":"mala-l7r","title":"Support epic filter for getting ready tasks","description":"Goal: Allow specifying a beads epic ID to filter ready tasks, so only tasks that are children of that epic are returned.\n\nScope/files: src/beads_client.py, src/cli.py (or src/orchestrator.py if it exists).\n\nWork:\n- Add optional epic_id parameter to BeadsClient.get_ready() method.\n- Filter returned issues to only include those with a parent-child dependency on the specified epic.\n- Add --epic CLI option to 'mala run' command to pass epic filter.\n- Update orchestrator to pass epic filter to BeadsClient.\n\nAcceptance criteria:\n- 'mala run --epic mala-c01' only processes tasks that are children of epic mala-c01.\n- Without --epic flag, behavior unchanged (all ready tasks).\n- Epic itself is still excluded from ready tasks (existing behavior).\n- Tests cover epic filter logic.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T00:17:16.892104528Z","updated_at":"2025-12-26T00:48:18.823402862Z","closed_at":"2025-12-26T00:48:18.823402862Z","close_reason":"Closed"}
{"id":"mala-lm0","title":"Refactor: extract JSONLLogger","description":"## Context\n`JSONLLogger` currently lives in `src/main.py`. It should be moved into `src/logging/jsonl.py` to isolate logging and reduce `main.py` surface area.\n\n## Scope\nCreate the new module only. Do **not** modify `src/main.py` in this issue; integration will wire it up later.\n\n### Files\n- Add: `src/logging/jsonl.py`\n\n## Requirements\n- `JSONLLogger` behavior must remain unchanged (file path, JSONL structure, timestamps, flush behavior).\n- Use the same `JSONL_LOG_DIR` constant from `src/tools/env.py` (so this issue depends on the env module existing).\n\n## Acceptance Criteria\n- `src/logging/jsonl.py` exists and matches current JSONLLogger behavior.\n- No other files are modified in this issue.\n\n## Notes\n- Integration issue will update imports in `src/main.py`.\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T19:54:51.153849001Z","updated_at":"2025-12-25T20:11:41.797668608Z","closed_at":"2025-12-25T20:11:41.797668608Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-lm0","depends_on_id":"mala-9ki","type":"blocks","created_at":"2025-12-25T20:06:47.457341927Z","created_by":"daemon"}]}
{"id":"mala-lo9","title":"Add quality gate for commits + validation evidence","description":"Context:\n- Track A4 requires verifying commit message contains bd-\u003cissue_id\u003e and that validation checks ran (docs/coordination-plan-codex.md:38-41).\n- Orchestrator currently marks success solely by bd status closed (src/orchestrator.py:180-209).\n\nScope:\n- In: add a post-run quality gate that checks for a commit message containing bd-\u003cissue_id\u003e.\n- In: verify validation commands ran by parsing JSONL logs (or by rerunning in orchestrator if needed).\n- In: on gate failure, mark needs-followup and record failure context.\n- Out: no prompt updates and no handoff file generation (A6).\n\nAcceptance Criteria:\n- Issues only count as success when closed, a matching commit exists, and validation evidence is present.\n- Gate failures record the missing evidence and apply a needs-followup marker.\n- JSONL parsing recognizes uv sync, pytest, ruff check/format, and ty check commands.\n\nTest Plan:\n- TDD: add failing tests in tests/test_orchestrator.py for pass/fail gate scenarios (mock git log + JSONL data).\n- Implement gate logic and update tests to pass.\n- Run uv run pytest tests/test_orchestrator.py.\n\nNotes for Agent:\n- Decide whether needs-followup is a bd label or status and document the choice.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T16:44:33.280391503Z","updated_at":"2025-12-26T17:10:02.788723047Z","closed_at":"2025-12-26T17:10:02.788723047Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-lo9","depends_on_id":"mala-jxc","type":"blocks","created_at":"2025-12-26T16:44:48.861098735Z","created_by":"daemon"},{"issue_id":"mala-lo9","depends_on_id":"mala-4w7","type":"parent-child","created_at":"2025-12-26T16:47:53.007870582Z","created_by":"daemon"}]}
{"id":"mala-lvw","title":"Single-threaded mode without locking","status":"blocked","priority":4,"issue_type":"epic","created_at":"2025-12-26T00:57:29.777283988Z","updated_at":"2025-12-26T15:36:54.46996311Z"}
{"id":"mala-mj8","title":"Docs: update README + Braintrust docstring to match implementation","description":"Problem: README says lock mechanism uses atomic mkdir, but scripts use hardlink+tempfile; braintrust_integration.py docstring says setup is in main.py, but it is in cli.py.\\n\\nScope/files: README.md, src/braintrust_integration.py.\\n\\nWork:\\n- Update README to reflect actual lock mechanism and current braintrust setup location.\\n- Update braintrust_integration.py docstring to refer to cli.py (or central location if changed).\\n\\nAcceptance criteria:\\n- Docs match current behavior.\\n- No functional code changes.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-25T21:38:42.843621671Z","updated_at":"2025-12-26T00:00:38.778018843Z","closed_at":"2025-12-26T00:00:38.778018843Z","close_reason":"Closed"}
{"id":"mala-n0n","title":"Write failure handoff files on agent failure","description":"Context:\n- Track A6 requires writing .mala/handoff/\u003cissue_id\u003e.md with last commands and error summary (docs/coordination-plan-codex.md:47-48).\n- Orchestrator currently resets failed issues without a persistent handoff artifact (src/orchestrator.py:300-340).\n\nScope:\n- In: on agent failure (including quality gate failures), write .mala/handoff/\u003cissue_id\u003e.md with last commands and error summary.\n- In: ensure the handoff directory is created and file names are sanitized.\n- Out: do not change the quality gate logic beyond invoking handoff writer.\n\nAcceptance Criteria:\n- A handoff file is created for failed issues and contains last command(s) and an error summary.\n- File is created even when no commands are available (explicitly say so).\n- Handoff path is deterministic and safe for all issue IDs.\n\nTest Plan:\n- TDD: add failing unit test in a new tests/test_handoff.py.\n- Implement handoff writer and update tests to pass.\n- Run uv run pytest tests/test_handoff.py.\n\nNotes for Agent:\n- Prefer sourcing command history from JSONL logs to avoid missing data.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T16:44:42.712108592Z","updated_at":"2025-12-26T17:14:50.909626715Z","closed_at":"2025-12-26T17:14:50.909626715Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-n0n","depends_on_id":"mala-lo9","type":"blocks","created_at":"2025-12-26T16:44:52.444889534Z","created_by":"daemon"},{"issue_id":"mala-n0n","depends_on_id":"mala-4w7","type":"parent-child","created_at":"2025-12-26T16:47:53.018656516Z","created_by":"daemon"}]}
{"id":"mala-o17","title":"Test issue: add a comment to README.md","status":"tombstone","priority":2,"issue_type":"task","created_at":"2025-12-25T18:49:43.062524854Z","updated_at":"2025-12-25T18:53:44.873613587Z","close_reason":"Closed","deleted_at":"2025-12-25T18:53:44.873613587Z","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"mala-o3z","title":"Test braintrust tracing","description":"Add a comment to the README TODOs section noting that Braintrust LLM tracing is now implemented","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T19:22:15.933197275Z","updated_at":"2025-12-25T19:23:21.922382429Z","closed_at":"2025-12-25T19:23:21.922382429Z","close_reason":"Closed"}
{"id":"mala-q24","title":"Pretty print tool call arguments in logs","description":"Currently log_tool() in src/logging/console.py only shows tool name and a brief description. Tool call arguments (like file paths, search patterns, etc.) are not displayed.\n\nWhen --no-truncate is used, tool arguments MUST be pretty-printed in the logs:\n- Add 'arguments' parameter to log_tool()\n- When truncation is disabled, format arguments nicely (e.g., key=value pairs)\n- Use multi-line formatting for complex nested arguments (JSON)\n- When truncation is enabled, can show abbreviated/truncated version\n\nThis ties into mala-59n which added the --no-truncate option. The full output mode should include full tool arguments for debugging.\n\nReference: src/logging/console.py:103","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T17:12:19.753573776Z","updated_at":"2025-12-26T17:16:20.717304732Z","closed_at":"2025-12-26T17:16:20.717304732Z","close_reason":"Closed"}
{"id":"mala-rsg","title":"Honor --no-truncate for completion summaries","description":"Completion log lines still hard-truncate summaries to 50 chars. Apply the global truncation setting so --no-truncate shows full completion summaries.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-26T15:34:15.335284655Z","updated_at":"2025-12-26T17:11:44.411821976Z","closed_at":"2025-12-26T17:11:44.411821976Z","close_reason":"Closed"}
{"id":"mala-rsq","title":"Refactor: split CLI into cli.py and make main.py a shim","description":"## Context\nWe will parallelize by creating new modules in separate issues, then do a single integration pass to wire everything together. This issue is the integration/wiring step.\n\n## Scope\nWire all refactor modules into the app, update tests, and make `src/main.py` a true shim. This is the **only** issue that should edit `src/main.py` and tests.\n\n### Files\n- Add: `src/cli.py`\n- Modify: `src/main.py`\n- Modify: `tests/test_lock_integration.py`\n- Modify: `tests/test_lock_sdk_integration.py`\n- Modify: any files needed to update imports/paths after the prompt move\n\n## Requirements\n- Create `src/cli.py` with the Typer app + commands currently defined in `src/main.py`.\n- Move CLI-adjacent logic out of `src/main.py` so it becomes a tiny shim that only exposes `app`.\n- Update imports to use the new modules:\n  - `src/tools/env.py`\n  - `src/logging/console.py`\n  - `src/logging/jsonl.py`\n  - `src/agent_loop.py`\n  - `src/tools/locking.py`\n- Update prompt loading to the new path: `src/prompts/implementer_prompt.md`.\n- Update tests to import from new module paths (locking + prompt template).\n- Keep `pyproject.toml` entrypoint as `src.main:app`.\n\n## TDD Guidance\n- Update tests first (imports/paths), run relevant tests:\n  - `tests/test_lock_integration.py`\n  - `tests/test_lock_sdk_integration.py`\n  - `tests/test_lock_scripts.py`\n- Then implement wiring changes and re-run the tests.\n\n## Acceptance Criteria\n- `src/main.py` is a thin shim (import + expose `app`).\n- CLI behavior is unchanged (`mala --help` identical).\n- Prompt loads from the new location.\n- Locking + prompt tests pass with updated imports.\n- All refactor modules are used by the CLI/orchestrator.\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T19:54:51.18845258Z","updated_at":"2025-12-25T20:24:59.79953084Z","closed_at":"2025-12-25T20:24:59.79953084Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-rsq","depends_on_id":"mala-9ki","type":"blocks","created_at":"2025-12-25T20:06:47.478081301Z","created_by":"daemon"},{"issue_id":"mala-rsq","depends_on_id":"mala-1by","type":"blocks","created_at":"2025-12-25T20:06:47.48915539Z","created_by":"daemon"},{"issue_id":"mala-rsq","depends_on_id":"mala-lm0","type":"blocks","created_at":"2025-12-25T20:06:47.499510627Z","created_by":"daemon"},{"issue_id":"mala-rsq","depends_on_id":"mala-wd1","type":"blocks","created_at":"2025-12-25T20:06:47.510195051Z","created_by":"daemon"},{"issue_id":"mala-rsq","depends_on_id":"mala-5aa","type":"blocks","created_at":"2025-12-25T20:06:47.520878684Z","created_by":"daemon"},{"issue_id":"mala-rsq","depends_on_id":"mala-vrm","type":"blocks","created_at":"2025-12-25T20:06:47.530900735Z","created_by":"daemon"}]}
{"id":"mala-tci","title":"Update README for new CLI defaults and flags","description":"README still shows max-agents default as 3 and doesn't document --epic, --only, or --no-truncate. Update usage + CLI options table to reflect current behavior (unlimited max-agents by default).","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-26T15:34:30.211575764Z","updated_at":"2025-12-26T18:40:12.900416446Z","closed_at":"2025-12-26T18:40:12.900416446Z","close_reason":"Closed"}
{"id":"mala-u1w","title":"Test: tiny README change","status":"tombstone","priority":2,"issue_type":"task","created_at":"2025-12-25T19:05:18.089001881Z","updated_at":"2025-12-25T19:08:44.858511785Z","close_reason":"Closed","deleted_at":"2025-12-25T19:08:44.858511785Z","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"mala-vdf","title":"Offload bd/git calls from async loop","description":"Context:\n- Orchestrator uses blocking subprocess calls via BeadsClient inside the async loop, which can stall other agent tasks.\n- Needs verification: confirm bd/git commands can hang long enough to impact agent receive loops.\n\nScope:\n- In: move bd/git calls used in the orchestrator loop to async-friendly execution (asyncio.to_thread or async subprocess) with timeouts; update orchestrator to await these calls.\n- Out: replacing the bd CLI or changing issue selection logic.\n\nAcceptance Criteria:\n- Slow or hanging bd commands do not block other agent tasks.\n- Timeouts are handled with clear warnings and safe fallback behavior.\n\nTest Plan:\n- TDD: add a test that simulates a slow bd command, implement async/offload behavior, then run orchestrator tests.\n\nNotes for Agent:\n- Keep the public BeadsClient API consistent unless updating call sites in orchestrator.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T17:35:56.818359351Z","updated_at":"2025-12-26T18:58:44.392606409Z","closed_at":"2025-12-26T18:58:44.392606409Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-vdf","depends_on_id":"mala-jnq","type":"parent-child","created_at":"2025-12-26T17:36:15.723438514Z","created_by":"daemon"},{"issue_id":"mala-vdf","depends_on_id":"mala-dqp","type":"blocks","created_at":"2025-12-26T17:36:21.612596465Z","created_by":"daemon"}]}
{"id":"mala-vrm","title":"Refactor: move implementer prompt to src/prompts/","description":"## Context\nThe implementer prompt lives at `src/implementer_prompt.md`. The proposed structure puts prompts under `src/prompts/`.\n\n## Scope\nMove the prompt file only. Do **not** update loaders or tests in this issue; integration will wire it up later.\n\n### Files\n- Move: `src/implementer_prompt.md` → `src/prompts/implementer_prompt.md`\n\n## Requirements\n- Prompt content must be unchanged after move.\n\n## Acceptance Criteria\n- File exists at `src/prompts/implementer_prompt.md` with identical content.\n- No other files are modified in this issue.\n\n## Notes\n- Integration issue will update imports/tests referencing `IMPLEMENTER_PROMPT_TEMPLATE`.\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T19:54:51.200086139Z","updated_at":"2025-12-25T20:08:18.586126987Z","closed_at":"2025-12-25T20:08:18.586126987Z","close_reason":"Closed"}
{"id":"mala-wd1","title":"Refactor: extract Claude SDK subagent loop","description":"## Context\nThe Claude SDK receive loop is currently embedded in `MalaOrchestrator.run_implementer` in `src/main.py`. It should be extracted to a reusable `src/agent_loop.py` module.\n\n## Scope\nCreate `src/agent_loop.py` only. Do **not** modify `src/main.py` in this issue; integration will wire it up later.\n\n### Files\n- Add: `src/agent_loop.py`\n\n## Requirements\n- The extracted loop should be the same logic as today:\n  - `async with ClaudeSDKClient(options=options) as client:`\n  - `await client.query(prompt)`\n  - `async for message in client.receive_response(): ...`\n- It must still:\n  - Handle `AssistantMessage` / `ResultMessage` logging exactly as today.\n  - Support JSONL logging and Braintrust logging (existing behavior).\n- Return the final result text and any needed success/summary data in a way `run_implementer` can use.\n\n## Acceptance Criteria\n- `src/agent_loop.py` exists with the extracted loop behavior.\n- No other files are modified in this issue.\n\n## Notes\n- Integration issue will delegate to this module from `src/main.py`.\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T19:54:51.165716848Z","updated_at":"2025-12-25T20:11:59.449563429Z","closed_at":"2025-12-25T20:11:59.449563429Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-wd1","depends_on_id":"mala-1by","type":"blocks","created_at":"2025-12-25T20:06:47.467342748Z","created_by":"daemon"}]}
{"id":"mala-wya","title":"Prompt cleanup: full validation, mutex rule, REPO_NAMESPACE","description":"Context:\n- Track A1 requires removing guidance that allows skipping tests and replacing with a single clear policy (docs/coordination-plan-codex.md:26-28, 81-83).\n- Implementer prompt includes Speed/Scope Guardrails and \"run tests only on touched files\" guidance (src/prompts/implementer_prompt.md:138-150).\n- Track A3 requires setting REPO_NAMESPACE in the prompt to repo root (docs/coordination-plan-codex.md:33-35).\n\nScope:\n- In: remove Speed/Scope Guardrails section and any skip-tests or blame-pre-existing-failures language.\n- In: require the full validation suite (uv sync, pytest, ruff check/format, ty check) and add the test mutex rule for repo-wide commands.\n- In: export REPO_NAMESPACE to the repo root in the lock environment setup.\n- Out: no lock script or orchestrator logic changes.\n\nAcceptance Criteria:\n- Prompt no longer contains Speed/Scope Guardrails or \"run only touched files\" guidance.\n- Prompt explicitly requires full validation suite and a mutex before repo-wide commands.\n- REPO_NAMESPACE export is present and uses the repo root placeholder.\n\nTest Plan:\n- Doc-only: spot-check rendered prompt with sample values.\n\nNotes for Agent:\n- Keep wording aligned with shared-worktree mode.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T16:43:25.110736233Z","updated_at":"2025-12-26T17:03:04.73672941Z","closed_at":"2025-12-26T17:03:04.73672941Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-wya","depends_on_id":"mala-4w7","type":"parent-child","created_at":"2025-12-26T16:47:52.95649035Z","created_by":"daemon"}]}
{"id":"mala-xv8","title":"Epic: A3 Canonical lock keys","description":"Context:\n- Track A3 requires setting REPO_NAMESPACE, normalizing paths before hashing, and updating lock tests (docs/coordination-plan-codex.md:33-36).\n\nScope:\n- In: coordinate child tasks for Python helper, shell scripts, and test updates.\n- Out: does not implement changes directly.\n\nAcceptance Criteria:\n- All child tasks for A3 are completed and locks are canonicalized end-to-end.\n\nTest Plan:\n- N/A (handled by child tasks).\n\nNotes for Agent:\n- Use parent-child relationships for A3 sub-tasks.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-26T16:43:43.874044032Z","updated_at":"2025-12-26T17:12:06.484854779Z","closed_at":"2025-12-26T17:12:06.484854779Z","close_reason":"All children completed","dependencies":[{"issue_id":"mala-xv8","depends_on_id":"mala-4w7","type":"parent-child","created_at":"2025-12-26T16:47:52.985551137Z","created_by":"daemon"}]}
{"id":"mala-xv8.1","title":"Canonicalize Python lock key generation","description":"Context:\n- Track A3 requires path normalization and repo namespace before hashing (docs/coordination-plan-codex.md:33-35).\n- _lock_key currently uses raw filepath without normalization (src/tools/locking.py:22-34).\n\nScope:\n- In: normalize file paths (resolve symlinks, repo-relative to REPO_NAMESPACE) before hashing in _lock_key/_lock_path.\n- In: ensure absolute and relative paths for the same file resolve to the same key.\n- Out: no shell script changes (handled separately).\n\nAcceptance Criteria:\n- _lock_key produces identical keys for equivalent absolute/relative paths within the same repo namespace.\n- Repo namespace prefix remains part of the canonical key.\n- Unit tests cover normalization and namespace behavior.\n\nTest Plan:\n- TDD: add failing tests in a new tests/test_locking_key.py for normalization cases.\n- Implement locking.py changes, update tests to pass.\n- Run uv run pytest tests/test_locking_key.py.\n\nNotes for Agent:\n- Assume REPO_NAMESPACE is set to the repo root in the prompt.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T16:43:52.981798811Z","updated_at":"2025-12-26T17:00:55.334823293Z","closed_at":"2025-12-26T17:00:55.334823293Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-xv8.1","depends_on_id":"mala-xv8","type":"parent-child","created_at":"2025-12-26T16:43:52.990309133Z","created_by":"daemon"}]}
{"id":"mala-xv8.2","title":"Canonicalize lock scripts + update script tests","description":"Context:\n- Track A3 requires path normalization before hashing for lock keys (docs/coordination-plan-codex.md:33-35).\n- Lock scripts currently hash raw input paths (src/scripts/lock-try.sh:20-31).\n- Script-level tests exercise lock scripts behavior (tests/test_lock_scripts.py).\n\nScope:\n- In: update lock-try.sh, lock-check.sh, lock-holder.sh, lock-release.sh to normalize paths (resolve symlinks, repo-relative to REPO_NAMESPACE) before hashing.\n- In: update tests/test_lock_scripts.py to cover normalization and namespace behavior for scripts.\n- Out: no Python locking helper changes (handled separately).\n\nAcceptance Criteria:\n- Scripts generate the same lock file for equivalent absolute/relative paths within the same repo namespace.\n- REPO_NAMESPACE is applied after normalization.\n- tests/test_lock_scripts.py includes cases for normalization and passes.\n\nTest Plan:\n- TDD: add failing tests in tests/test_lock_scripts.py for normalization cases.\n- Implement script changes, update tests to pass.\n- Run uv run pytest tests/test_lock_scripts.py.\n\nNotes for Agent:\n- Use portable path normalization (realpath/readlink fallback) to keep Linux/macOS compatibility.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T16:44:02.611587643Z","updated_at":"2025-12-26T17:02:29.674397068Z","closed_at":"2025-12-26T17:02:29.674397068Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-xv8.2","depends_on_id":"mala-xv8","type":"parent-child","created_at":"2025-12-26T16:44:02.621218247Z","created_by":"daemon"}]}
{"id":"mala-xv8.3","title":"Update SDK/integration lock tests for canonical keys","description":"Context:\n- Track A3 calls out updating slow SDK lock tests and helpers to match hashed naming (docs/coordination-plan-codex.md:33-36).\n- tests/test_lock_sdk_integration.py uses raw path-to-lock-name mapping (tests/test_lock_sdk_integration.py:82-91).\n- tests/test_lock_integration.py builds lock keys without path normalization (tests/test_lock_integration.py:24-40).\n\nScope:\n- In: update lock helper functions in tests/test_lock_sdk_integration.py and tests/test_lock_integration.py to match canonicalized, hashed lock key behavior.\n- In: add or adjust test cases to include absolute/relative normalization and REPO_NAMESPACE behavior.\n- Out: no script or Python locking helper changes.\n\nAcceptance Criteria:\n- SDK and integration tests align with canonicalized lock key behavior.\n- Tests cover normalization and namespace scenarios and pass.\n\nTest Plan:\n- TDD: update tests to assert new canonical key behavior (fail first).\n- Adjust helper functions and fixtures, then re-run tests.\n- Run uv run pytest tests/test_lock_sdk_integration.py tests/test_lock_integration.py.\n\nNotes for Agent:\n- Keep SDK tests fast; avoid introducing new long-running steps.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T16:44:13.175373837Z","updated_at":"2025-12-26T17:07:58.871392452Z","closed_at":"2025-12-26T17:07:58.871392452Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-xv8.3","depends_on_id":"mala-xv8","type":"parent-child","created_at":"2025-12-26T16:44:13.184089977Z","created_by":"daemon"}]}
{"id":"mala-za5","title":"Honor repo .env for Braintrust setup","description":"Context:\n- Braintrust setup runs before repo .env is loaded, so BRAINTRUST_API_KEY in the repo is ignored.\n- README suggests repo .env overrides user config, which currently isn’t true for Braintrust.\n\nScope:\n- In: delay Braintrust setup until after load_env(repo_path) or re-run setup if key becomes available.\n- Out: changes to tracing semantics or Braintrust SDK usage beyond setup timing.\n\nAcceptance Criteria:\n- When only repo .env contains BRAINTRUST_API_KEY, `mala run` reports Braintrust enabled.\n- When no key is present, behavior remains unchanged.\n\nTest Plan:\n- TDD: add a test that simulates repo-only BRAINTRUST_API_KEY, implement fix, and run CLI-related tests.\n\nNotes for Agent:\n- Avoid importing claude_agent_sdk before the wrapper is applied.","status":"tombstone","priority":2,"issue_type":"task","created_at":"2025-12-26T17:35:42.430757121Z","updated_at":"2025-12-26T17:39:58.002809862Z","deleted_at":"2025-12-26T17:39:58.002809862Z","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"mala-zjn","title":"Test blocked without deps","status":"tombstone","priority":2,"issue_type":"task","created_at":"2025-12-26T00:53:15.4017375Z","updated_at":"2025-12-26T00:53:28.39468524Z","deleted_at":"2025-12-26T00:53:28.39468524Z","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"mala-zx5","title":"Add --only flag for specifying beads issues by ID","description":"Add a command-line flag (--only) that accepts a comma-separated list of beads issue IDs. When provided, workers will only process those specific issues instead of picking from all ready issues.\n\nExample usage:\n  mala --only bd-abc123,bd-def456\n\nAcceptance criteria:\n- Add --only flag to CLI argument parsing\n- Parse comma-separated issue IDs\n- Filter get_ready() results to only include specified IDs\n- Validate that specified IDs exist and are ready\n- Update documentation/help text","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T00:40:19.287843127Z","updated_at":"2025-12-26T00:53:27.149701137Z","closed_at":"2025-12-26T00:53:27.149701137Z","close_reason":"Closed"}
