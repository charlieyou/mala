{"id":"mala-01s","title":"Refactor: consolidate lock config + env in one place","description":"Goal: Centralize LOCK_DIR and SCRIPTS_DIR configuration (currently defined in multiple modules). Allow override via env/config where appropriate.\\n\\nScope/files: src/tools/env.py, src/tools/locking.py, any imports that need adjustment.\\n\\nNotes:\\n- Consider single source of truth in tools/env.py.\\n- Keep behavior unchanged unless explicit override is set.\\n\\nAcceptance criteria:\\n- No duplicate definitions for LOCK_DIR/SCRIPTS_DIR.\\n- Locking and scripts continue to work.\\n- Minimal, well-contained changes.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-25T21:40:20.871689769Z","updated_at":"2026-01-01T08:19:23.320727877Z","closed_at":"2026-01-01T08:19:23.320727877Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-01s","depends_on_id":"mala-kpf","type":"blocks","created_at":"2025-12-25T21:47:40.701482404Z","created_by":"daemon"}]}
{"id":"mala-08f","title":"Add protocol-completeness check to bd-breakdown skill","description":"Context:\n- Issue mala-ng3 implemented the quality gate side of ISSUE_NO_CHANGE/ISSUE_OBSOLETE markers\n- But no task was created to document these markers in the implementer prompt (mala-3uo created retroactively)\n- Root cause: when breaking down plans, bidirectional protocols need tasks for BOTH producer and consumer sides\n- The bd-breakdown skill didn't flag this gap\n\nScope:\n- In: Add guidance to bd-breakdown skill (commands/bd-breakdown.md) to check for protocol completeness\n- In: When a task involves parsing/receiving a signal, ensure a corresponding producer task exists\n- Out: Changing how mala-ng3 was implemented (already done)\n\nAcceptance Criteria:\n- bd-breakdown skill prompts agent to verify both sides of any interface/protocol are covered\n- Checklist includes: 'For log markers/signals: is there a task to update the component that produces them?'\n- Checklist includes: 'For prompt-driven behavior: is there a task to update the prompt that instructs agents?'\n\nTest Plan:\n- Manual review of skill changes\n- Apply to a sample breakdown to verify checklist is used\n\nNotes for Agent:\n- The skill is at commands/bd-breakdown.md in this repo\n- Key addition: when an issue involves 'parse X marker' or 'handle X signal', ask: who produces X and do they have instructions to do so?","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T06:25:20.359991212Z","updated_at":"2025-12-27T06:26:40.359583428Z","closed_at":"2025-12-27T06:26:40.359583428Z","close_reason":"Will fix directly via prompt"}
{"id":"mala-0dsz","title":"[Review] src/cli/cli.py:386-392: [P2] --orphans-only and --epic flags are mutually exclusive but not validated","description":"## Review Finding\n\nThis issue was auto-created from a P2 review finding.\n\n**Source issue:** mala-jnah\n**Reviewer:** claude\n**Location:** src/cli/cli.py:386-392\n\n## Details\n\nWhen `--epic` is used, issues are filtered to children of that epic. When `--orphans-only` is used, issues are filtered to those without a parent epic. These conditions are mutually exclusive - children of an epic by definition have that epic as their parent. Using both flags together will silently return an empty issue list rather than warning the user about the conflicting options.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T23:18:02.901411634Z","created_by":"cyou","updated_at":"2026-01-01T23:41:40.109838134Z","closed_at":"2026-01-01T23:41:40.109838134Z","close_reason":"Closed","labels":["auto_generated","review_finding","review_finding:10fec5f4942c","source:mala-jnah"]}
{"id":"mala-0hn","title":"Health monitoring system","description":"Add health monitoring for agent runs and system status","status":"blocked","priority":3,"issue_type":"feature","created_at":"2025-12-28T06:21:39.303646583Z","updated_at":"2025-12-28T06:25:03.063476085Z"}
{"id":"mala-0k7","title":"Close epics after each agent completion, not just at run end","description":"## Problem\n\nCurrently, epics are only checked for closure at the end of a run. If an agent completes the last child issue of an epic mid-run, the epic stays open until the entire run finishes.\n\nThis means:\n- Epic status doesn't reflect reality during the run\n- Other agents may not see updated epic status for dependency resolution\n- `bd ready` may return stale results if epic completion affects other issues\n\n## Desired Behavior\n\nAfter each agent successfully completes an issue:\n1. Check if the issue belongs to any epics (via parent-child dependency)\n2. For each parent epic, check if all children are now closed\n3. If all children closed, close the epic with reason \"All children completed\"\n\n## Implementation\n\nIn `src/orchestrator.py`, after closing an issue in the agent completion flow:\n\n```python\n# After: bd close \u003cissue_id\u003e\n# Add: Check and close parent epics if all children done\nawait self._close_completed_epics(issue_id)\n```\n\nThe `_close_completed_epics` method should:\n1. Get parent epic(s) for the issue via `bd show \u003cissue_id\u003e --json`\n2. For each parent, check if all children are closed via `bd epic children \u003cepic_id\u003e --json`\n3. If all closed, run `bd close \u003cepic_id\u003e --reason \"All children completed\"`\n\n## Acceptance Criteria\n\n- [ ] Epics close immediately when last child completes\n- [ ] Works for nested epics (closing child epic triggers parent check)\n- [ ] Logged when epic is auto-closed\n- [ ] Tests verify epic closure after child completion\n\n## Files\n- src/orchestrator.py\n- tests/test_orchestrator.py","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T06:38:21.964459481Z","updated_at":"2025-12-27T08:01:07.948833639Z","closed_at":"2025-12-27T08:01:07.948833639Z","close_reason":"Closed"}
{"id":"mala-1by","title":"Refactor: extract console logging helpers","description":"## Context\nConsole logging helpers (`Colors`, `log`, `log_tool`, `log_result`) live in `src/main.py`. They should move to `src/logging/console.py` to reduce CLI/orchestrator coupling.\n\n## Scope\nCreate the new module only. Do **not** modify `src/main.py` in this issue; integration will wire it up later.\n\n### Files\n- Add: `src/logging/console.py`\n\n## Requirements\n- Move `Colors`, `log`, `log_tool`, and `log_result` into `src/logging/console.py`.\n- Behavior and output formatting must remain identical.\n\n## Acceptance Criteria\n- `src/logging/console.py` contains the logging helpers with identical behavior.\n- No other files are modified in this issue.\n\n## Notes\n- Integration issue will update imports in `src/main.py` and any other modules.\n- Keep ASCII-only files.\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T19:54:51.142161242Z","updated_at":"2025-12-25T20:09:18.911369058Z","closed_at":"2025-12-25T20:09:18.911369058Z","close_reason":"Closed"}
{"id":"mala-1gb","title":"Agent mail: inter-agent communication system","description":"Allow agents to communicate with each other during a run:\n\n**Use cases:**\n- Agent A discovers issue needs API change, notifies Agent B working on API\n- Agent requests specialist help (e.g., 'need SQL optimization advice')\n- Handoff context when one agent completes prerequisite work\n\n**Implementation ideas:**\n- Mailbox directory per agent in lock dir\n- Tools: send-mail.sh, check-mail.sh, read-mail.sh\n- PreToolUse hook to inject unread mail as system message\n- Optional: synchronous request/response pattern\n\n**Coordination:**\n- Messages are advisory, not blocking (avoid deadlock)\n- Orchestrator can inject mail (human-in-the-loop hints)\n- Mail log persisted for debugging","status":"blocked","priority":3,"issue_type":"feature","created_at":"2025-12-28T06:31:49.761390022Z","updated_at":"2025-12-28T06:31:54.058410432Z"}
{"id":"mala-1l2","title":"Make morphllm optional","description":"Make MorphLLM optional: allow running without MORPH_API_KEY by disabling the Morph MCP server and related tool restrictions.","notes":"REVIEW (2025-12-27): Plan solid. Set status to open (no blockers). Add acceptance criteria: Edit/Grep allowed when MORPH_API_KEY missing; morph-disabled must not install hooks/restrictions anywhere. Edge cases: any shared validation helpers must not implicitly require MORPH_API_KEY. Tests: add/adjust a morph-disabled logging/behavior assertion. Docs: update any required-env/.env samples beyond README.","status":"closed","priority":4,"issue_type":"epic","created_at":"2025-12-26T00:55:42.42123181Z","updated_at":"2025-12-27T05:57:33.787813045Z","closed_at":"2025-12-27T05:57:33.787813045Z","close_reason":"Closed"}
{"id":"mala-1l2.1","title":"Validation prereqs for optional MorphLLM","description":"Context:\\n- Break out validation-related changes needed to make MORPH_API_KEY optional.\\n- Focused on e2e/validation prechecks and required_env gating.\\n\\nScope:\\n- In: tasks updating validation spec/runner/e2e prereqs + their focused tests.\\n- Out: CLI/orchestrator behavior changes; docs updates.\\n\\nAcceptance Criteria:\\n- Child issues cover spec, e2e, and runner validation behavior plus tests.\\n\\nTest Plan:\\n- Covered by child tasks.\\n\\nNotes for Agent:\\n- Keep validation changes isolated to their files and corresponding tests.","status":"closed","priority":4,"issue_type":"epic","created_at":"2025-12-27T00:46:40.769608139Z","updated_at":"2025-12-27T01:53:32.920933073Z","closed_at":"2025-12-27T01:53:32.920933073Z","close_reason":"All children completed","dependencies":[{"issue_id":"mala-1l2.1","depends_on_id":"mala-1l2","type":"parent-child","created_at":"2025-12-27T00:46:40.769965987Z","created_by":"daemon"}]}
{"id":"mala-1l2.1.1","title":"Relax required_env for Morph in validation spec (with tests)","description":"Primary files: src/validation/spec.py, tests/test_spec.py\\n\\nContext:\\n- Validation spec currently treats MORPH_API_KEY as required for e2e runs.\\n- Optional Morph should not fail validation solely due to missing key.\\n\\nScope:\\n- In: remove MORPH_API_KEY from required_env for e2e (or gate on morph_enabled if available in spec inputs).\\n- Out: runner/e2e prereq logic.\\n\\nAcceptance Criteria:\\n- required_env no longer unconditionally includes MORPH_API_KEY for e2e.\\n- tests/test_spec.py updated to match new required_env expectations.\\n\\nTest Plan:\\n- TDD: adjust tests/test_spec.py to fail on current required_env behavior.\\n- Implement spec change; refactor if needed.\\n- Run: uv run pytest tests/test_spec.py\\n\\nNotes for Agent:\\n- If spec has no morph_enabled input, prefer removing the requirement entirely.","status":"closed","priority":4,"issue_type":"task","created_at":"2025-12-27T00:47:14.858287475Z","updated_at":"2025-12-27T01:14:50.347672201Z","closed_at":"2025-12-27T01:14:50.347672201Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-1l2.1.1","depends_on_id":"mala-1l2.1","type":"parent-child","created_at":"2025-12-27T00:47:14.867609402Z","created_by":"daemon"}]}
{"id":"mala-1l2.1.2","title":"Remove hard MORPH_API_KEY prereq in validation e2e (with tests)","description":"Primary files: src/validation/e2e.py, tests/test_e2e.py\\n\\nContext:\\n- E2E validation should not fail when MORPH_API_KEY is missing.\\n- Morph-specific tests can still be skipped when keys are absent.\\n\\nScope:\\n- In: remove any hard prereq requiring MORPH_API_KEY in e2e validation; keep skip_if_no_keys behavior for Morph-specific checks.\\n- Out: validation spec required_env and runner prereqs.\\n\\nAcceptance Criteria:\\n- E2E validation does not error solely due to missing MORPH_API_KEY.\\n- Morph-specific E2E tests continue to skip when key is missing.\\n- tests/test_e2e.py updated to cover new prereq behavior.\\n\\nTest Plan:\\n- TDD: update tests/test_e2e.py to fail on current prereq requirement.\\n- Implement e2e validation changes; refactor if needed.\\n- Run: uv run pytest tests/test_e2e.py\\n\\nNotes for Agent:\\n- Keep backward-compatible skip semantics; do not enable Morph tests without a key.","status":"closed","priority":4,"issue_type":"task","created_at":"2025-12-27T00:47:26.211628366Z","updated_at":"2025-12-27T01:21:46.329883547Z","closed_at":"2025-12-27T01:21:46.329883547Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-1l2.1.2","depends_on_id":"mala-1l2.1","type":"parent-child","created_at":"2025-12-27T00:47:26.220050469Z","created_by":"daemon"},{"issue_id":"mala-1l2.1.2","depends_on_id":"mala-1l2.1.1","type":"blocks","created_at":"2025-12-27T00:48:10.128669054Z","created_by":"daemon"}]}
{"id":"mala-1l2.1.3","title":"Relax MORPH_API_KEY prereqs in validation runner (with tests)","description":"Primary files: src/validation/runner.py, tests/test_validation.py\\n\\nContext:\\n- Runner-level validation should not treat MORPH_API_KEY as a hard requirement for all e2e runs.\\n- Optional Morph should still allow general validation to proceed.\\n\\nScope:\\n- In: remove or gate MORPH_API_KEY prereq at runner level; preserve skip behavior for Morph-only checks.\\n- Out: validation spec required_env and e2e module logic.\\n\\nAcceptance Criteria:\\n- Runner no longer blocks validation solely due to missing MORPH_API_KEY.\\n- tests/test_validation.py updated to match new prereq behavior.\\n\\nTest Plan:\\n- TDD: adjust tests/test_validation.py to fail on current prereq requirement.\\n- Implement runner changes; refactor if needed.\\n- Run: uv run pytest tests/test_validation.py\\n\\nNotes for Agent:\\n- Keep compatibility with existing skip_if_no_keys behavior.","status":"closed","priority":4,"issue_type":"task","created_at":"2025-12-27T00:47:36.507485416Z","updated_at":"2025-12-27T01:24:47.858660441Z","closed_at":"2025-12-27T01:24:47.858660441Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-1l2.1.3","depends_on_id":"mala-1l2.1","type":"parent-child","created_at":"2025-12-27T00:47:36.514793237Z","created_by":"daemon"},{"issue_id":"mala-1l2.1.3","depends_on_id":"mala-1l2.1.1","type":"blocks","created_at":"2025-12-27T00:48:13.488191772Z","created_by":"daemon"}]}
{"id":"mala-1l2.2","title":"Gate Morph MCP config in orchestrator (with tests)","description":"Primary files: src/orchestrator.py, tests/test_morph_integration.py\\n\\nContext:\\n- Morph MCP should be optional when MORPH_API_KEY is missing.\\n- Orchestrator owns MCP server configuration and tool restrictions.\\n\\nScope:\\n- In: add morph_enabled parameter/default; when false, return no Morph MCP servers, skip disallowed_tools + hook registration; log enabled/disabled state.\\n- Out: CLI env parsing; validation/e2e prereqs.\\n\\nAcceptance Criteria:\\n- Without MORPH_API_KEY (morph_enabled false), Morph MCP server is not configured and no tool restrictions/hooks are applied.\\n- With MORPH_API_KEY, behavior remains unchanged.\\n- Logs clearly indicate Morph enabled vs disabled.\\n- tests/test_morph_integration.py updated to cover enabled/disabled cases.\\n\\nTest Plan:\\n- TDD: adjust/add failing tests in tests/test_morph_integration.py first.\\n- Implement minimal orchestrator changes; refactor if needed.\\n- Run: uv run pytest tests/test_morph_integration.py\\n\\nNotes for Agent:\\n- Ensure default keeps existing callers working (safe default for morph_enabled).","status":"closed","priority":4,"issue_type":"task","created_at":"2025-12-27T00:46:53.269468392Z","updated_at":"2025-12-27T01:36:56.0650868Z","closed_at":"2025-12-27T01:36:56.0650868Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-1l2.2","depends_on_id":"mala-1l2","type":"parent-child","created_at":"2025-12-27T00:46:53.276443605Z","created_by":"daemon"}]}
{"id":"mala-1l2.3","title":"Make CLI accept missing MORPH_API_KEY (with tests)","description":"Primary files: src/cli.py, tests/test_cli.py\\n\\nContext:\\n- CLI currently hard-fails when MORPH_API_KEY is missing.\\n- Optional Morph requires CLI to compute morph_enabled and proceed.\\n\\nScope:\\n- In: replace hard validation with optional getter; compute morph_enabled = bool(MORPH_API_KEY); pass to orchestrator; warn/log when disabled.\\n- Out: orchestrator MCP server logic; validation prereqs.\\n\\nAcceptance Criteria:\\n- Running without MORPH_API_KEY no longer exits early.\\n- morph_enabled is passed through to orchestrator.\\n- Logs warn/indicate Morph is disabled when key missing.\\n- tests/test_cli.py updated to reflect optional key behavior.\\n\\nTest Plan:\\n- TDD: update/add tests in tests/test_cli.py to fail on current behavior.\\n- Implement CLI changes; refactor if needed.\\n- Run: uv run pytest tests/test_cli.py\\n\\nNotes for Agent:\\n- Coordinate with orchestrator change so the new parameter is accepted.","status":"closed","priority":4,"issue_type":"task","created_at":"2025-12-27T00:47:03.034540213Z","updated_at":"2025-12-27T01:48:34.295154358Z","closed_at":"2025-12-27T01:48:34.295154358Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-1l2.3","depends_on_id":"mala-1l2","type":"parent-child","created_at":"2025-12-27T00:47:03.034931741Z","created_by":"daemon"},{"issue_id":"mala-1l2.3","depends_on_id":"mala-1l2.2","type":"blocks","created_at":"2025-12-27T00:48:04.407695212Z","created_by":"daemon"}]}
{"id":"mala-1l2.4","title":"Document optional MorphLLM (README + quality hardening doc)","description":"Primary files: README.md, docs/quality-hardening-plan.md\\n\\nContext:\\n- Docs currently imply MORPH_API_KEY is required.\\n- Need to document optional Morph MCP and fallback behavior.\\n\\nScope:\\n- In: update README to mark MorphLLM MCP optional; explain enablement via MORPH_API_KEY; note fallback to built-in Edit/Grep when disabled.\\n- In: update docs/quality-hardening-plan.md (and any required-env lists in these files).\\n- Out: code changes or tests.\\n\\nAcceptance Criteria:\\n- README clearly states Morph is optional and how it is enabled.\\n- Any required-env sections in these docs no longer mark MORPH_API_KEY as mandatory.\\n\\nTest Plan:\\n- Not applicable (docs-only).\\n\\nNotes for Agent:\\n- Keep wording consistent with actual runtime behavior and logs.","status":"closed","priority":4,"issue_type":"chore","created_at":"2025-12-27T00:47:46.694517979Z","updated_at":"2025-12-27T01:35:17.82530074Z","closed_at":"2025-12-27T01:35:17.82530074Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-1l2.4","depends_on_id":"mala-1l2","type":"parent-child","created_at":"2025-12-27T00:47:46.70338778Z","created_by":"daemon"}]}
{"id":"mala-1l2.5","title":"QA: verify optional MorphLLM behavior","description":"Primary files: (none)\\n\\nContext:\\n- After code/test updates, verify behavior without MORPH_API_KEY.\\n\\nScope:\\n- In: run targeted tests and do a quick manual run without MORPH_API_KEY to confirm morph disabled log and no crash.\\n- Out: code or doc changes.\\n\\nAcceptance Criteria:\\n- Targeted pytest runs pass: tests/test_cli.py, tests/test_morph_integration.py, tests/test_spec.py, tests/test_e2e.py, tests/test_validation.py.\\n- Manual run without MORPH_API_KEY starts successfully and logs morph disabled.\\n\\nTest Plan:\\n- Run: uv run pytest tests/test_cli.py tests/test_morph_integration.py tests/test_spec.py tests/test_e2e.py tests/test_validation.py\\n- Optional: run command to start mala without MORPH_API_KEY and confirm log.\\n\\nNotes for Agent:\\n- If manual run is too expensive, document why and what was verified instead.","status":"closed","priority":4,"issue_type":"task","created_at":"2025-12-27T00:47:57.157193532Z","updated_at":"2025-12-27T01:53:32.839930036Z","closed_at":"2025-12-27T01:53:32.839930036Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-1l2.5","depends_on_id":"mala-1l2","type":"parent-child","created_at":"2025-12-27T00:47:57.164709042Z","created_by":"daemon"},{"issue_id":"mala-1l2.5","depends_on_id":"mala-1l2.2","type":"blocks","created_at":"2025-12-27T00:48:17.588479082Z","created_by":"daemon"},{"issue_id":"mala-1l2.5","depends_on_id":"mala-1l2.3","type":"blocks","created_at":"2025-12-27T00:48:22.938022111Z","created_by":"daemon"},{"issue_id":"mala-1l2.5","depends_on_id":"mala-1l2.1.1","type":"blocks","created_at":"2025-12-27T00:48:28.737891014Z","created_by":"daemon"},{"issue_id":"mala-1l2.5","depends_on_id":"mala-1l2.1.2","type":"blocks","created_at":"2025-12-27T00:48:31.649321978Z","created_by":"daemon"},{"issue_id":"mala-1l2.5","depends_on_id":"mala-1l2.1.3","type":"blocks","created_at":"2025-12-27T00:48:34.702018781Z","created_by":"daemon"}]}
{"id":"mala-1lx","title":"Explore Ralph Wiggum completion loop integration","description":"Investigate adding Ralph-style completion promise loop to Mala (pre-gate loop). Evaluate impact on gate/review retries, proposed CLI flags, cancellation path, and telemetry. This is exploratory; not yet scheduled for implementation.","notes":"BLOCKERS: Awaiting decision on whether to proceed with completion-promise loop experiments and scope (minimal vs full).","status":"closed","priority":4,"issue_type":"task","created_at":"2025-12-27T17:50:02.937540116Z","updated_at":"2026-01-01T21:40:44.516249907Z","closed_at":"2026-01-01T21:40:44.516249907Z","close_reason":"Closed"}
{"id":"mala-1qoc","title":"Clean up uncommitted changes after agent timeout","description":"When an agent times out, any uncommitted changes it made remain in the working directory. This can cause issues:\n\n1. Partial/incomplete code left in working tree\n2. Other agents may see and be confused by uncommitted changes\n3. No cleanup of modified files after timeout\n\nProposed solution:\n- After timeout, run `git checkout -- \u003cfiles\u003e` for any uncommitted changes in the working directory\n- Or use `git stash` to preserve changes for manual review\n- Log which files had uncommitted changes for debugging\n\nSee mala-drqh timeout in run 4bcf1d4b for example case (though in that case, the agent was stuck in lock contention and hadn't made changes yet).","status":"open","priority":2,"issue_type":"feature","created_at":"2026-01-02T15:21:34.932237532Z","created_by":"cyou","updated_at":"2026-01-02T15:21:34.932237532Z"}
{"id":"mala-1z6","title":"Disallow destructive git commands (reset, push --force, etc.)","description":"Prevent agents from running destructive git commands that could cause data loss or rewrite history.\n\n## Commands to Block\n\n| Pattern | Reason |\n|---------|--------|\n| `git reset --hard` | Discards uncommitted changes permanently |\n| `git push --force` / `git push -f` | Rewrites remote history (already blocked for main/master) |\n| `git clean -fd` | Deletes untracked files permanently |\n| `git checkout -- .` | Discards all uncommitted changes |\n| `git rebase` | Rewrites commit history |\n| `git branch -D` | Force-deletes branch without merge check |\n\n## Implementation\n\n**File:** `src/hooks.py`\n\n### 1. Add new pattern list after DANGEROUS_PATTERNS\n\n```python\n# Destructive git command patterns to block\nDESTRUCTIVE_GIT_PATTERNS = [\n    \"git reset --hard\",\n    \"git clean -fd\",\n    \"git clean -f\",\n    \"git checkout -- .\",\n    \"git rebase\",\n    \"git branch -D\",\n    \"git branch -d -f\",\n]\n```\n\n### 2. Update block_dangerous_commands function\n\nAdd a new check after the existing dangerous patterns loop:\n\n```python\n# Block destructive git patterns\nfor pattern in DESTRUCTIVE_GIT_PATTERNS:\n    if pattern in command:\n        return {\n            \"decision\": \"block\",\n            \"reason\": f\"Blocked destructive git command: {pattern}\",\n        }\n\n# Expand force push blocking to ALL branches (not just main/master)\nif \"git push\" in command and (\"--force\" in command or \"-f \" in command):\n    return {\n        \"decision\": \"block\",\n        \"reason\": \"Blocked force push (use --force-with-lease if needed)\",\n    }\n```\n\n### 3. Add tests in `tests/test_morph_integration.py`\n\nAdd to `TestBlockDangerousCommands` class:\n\n```python\n@pytest.mark.asyncio\n@pytest.mark.parametrize(\"cmd\", [\n    \"git reset --hard\",\n    \"git reset --hard HEAD~1\",\n    \"git clean -fd\",\n    \"git clean -f .\",\n    \"git checkout -- .\",\n    \"git rebase main\",\n    \"git rebase -i HEAD~3\",\n    \"git branch -D feature\",\n    \"git push --force origin feature\",\n    \"git push -f origin feature\",\n])\nasync def test_blocks_destructive_git_commands(self, make_hook_input, cmd):\n    \"\"\"Destructive git commands should be blocked.\"\"\"\n    from src.hooks import block_dangerous_commands\n    \n    result = await block_dangerous_commands(\n        make_hook_input(\"Bash\", cmd), None, {\"signal\": None}\n    )\n    assert result.get(\"decision\") == \"block\", f\"Should block: {cmd}\"\n```\n\n## Acceptance Criteria\n\n- [ ] All patterns in the table are blocked\n- [ ] Force push blocked on ALL branches (not just main/master)\n- [ ] Tests cover each blocked pattern\n- [ ] Existing tests still pass\n- [ ] Safe git commands still work: `git status`, `git diff`, `git log`, `git add`, `git commit`, `git push` (without --force)\n\n## Notes\n\n- Pattern matching is substring-based; edge cases like `git $VAR --hard` won't be caught\n- Consider suggesting `--force-with-lease` as safer alternative in block message\n- `git checkout -- \u003cspecific-file\u003e` could be allowed (only block `-- .` for all files)\n","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T01:05:31.653651896Z","updated_at":"2025-12-26T16:46:32.669493412Z","closed_at":"2025-12-26T16:46:32.669493412Z","close_reason":"Closed"}
{"id":"mala-20u","title":"Harden PreToolUse hook: robust tool-name matching + tests","description":"Problem: block_dangerous_commands in src/cli.py only checks tool_name == 'Bash'. If SDK uses 'bash' or other names, the safety hook is bypassed.\\n\\nScope/files: src/cli.py, tests (new or existing).\\n\\nWork:\\n- Confirm/assume tool names may vary; make matching robust (case-insensitive set, or accept multiple known names).\\n- Add unit tests for block_dangerous_commands covering allowed/blocked and tool name variations.\\n\\nAcceptance criteria:\\n- Hook blocks dangerous patterns regardless of tool name casing.\\n- Tests cover at least 1 allowed and 1 blocked command for multiple tool names.\\n\\nTDD: Write tests first, then update implementation.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-25T21:38:16.919383816Z","updated_at":"2025-12-25T23:59:03.895437001Z","closed_at":"2025-12-25T23:59:03.895437001Z","close_reason":"Closed"}
{"id":"mala-242x","title":"CLI flag to disable MorphLLM","description":"Add a command-line flag (e.g., --no-morph or --disable-morph) to disable MorphLLM model routing. This allows users to bypass MorphLLM and use models directly when needed for debugging, cost control, or when MorphLLM is unavailable.\n\nAcceptance criteria:\n- Add --no-morph flag to CLI argument parsing\n- When set, skip MorphLLM routing and use the model directly\n- Update help text to document the flag","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T02:02:50.359221366Z","created_by":"cyou","updated_at":"2025-12-29T02:52:47.33145069Z","closed_at":"2025-12-29T02:52:47.33145069Z","close_reason":"Closed"}
{"id":"mala-252","title":"Implement validation worktree utility","description":"Context:\n- Clean-room validation requires deterministic worktree creation and cleanup.\n- Plan specifies unique worktree paths and keep-on-failure behavior.\n\nScope:\n- In: implement worktree create/remove helpers with unique paths and state tracking.\n- Out: validation command execution (runner handles).\n\nAcceptance Criteria:\n- Worktree paths follow the run/issue/attempt format.\n- Cleanup honors --keep-worktrees and records worktree_state.\n- Failures surface clear errors without leaving stale worktrees.\n\nTest Plan:\n- Add unit tests for worktree create/remove paths (mock git calls).\n- Run targeted tests for worktree module.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T23:00:01.66635989Z","updated_at":"2025-12-27T00:05:55.340798599Z","closed_at":"2025-12-27T00:05:55.340798599Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-252","depends_on_id":"mala-j6p","type":"blocks","created_at":"2025-12-26T23:00:26.466631948Z","created_by":"daemon"}]}
{"id":"mala-264j","title":"[Review] .beads/issues.jsonl:243: [P2] Incomplete metadata update for mala-iy6l.5 in issues.jsonl","description":"## Review Finding\n\nThis issue was auto-created from a P2 review finding.\n\n**Source issue:** mala-iy6l.5\n**Reviewer:** gemini\n**Location:** .beads/issues.jsonl:243\n\n## Details\n\nThe commit message states that this change \"completes the domain package structure\" for issue `mala-iy6l.5`, but the status in `.beads/issues.jsonl` remains `in_progress`, the `needs-followup` label is still present, and a stale error note about a timeout remains. These should be updated to reflect the task's completion.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T15:27:37.721620987Z","created_by":"cyou","updated_at":"2026-01-01T21:23:20.75553695Z","closed_at":"2026-01-01T21:23:20.75553695Z","close_reason":"Not actionable - issues.jsonl metadata is auto-generated, not code to fix","labels":["auto_generated","review_finding","review_finding:1466b8f55162","source:mala-iy6l.5"]}
{"id":"mala-26jj","title":"[Review] src/infra/io/event_sink.py:1135-1325: [P2] ConsoleEventSink methods updated but out of scope per task description","description":"## Review Finding\n\nThis issue was auto-created from a P2 review finding.\n\n**Source issue:** mala-40pg.2\n**Reviewer:** claude\n**Location:** src/infra/io/event_sink.py:1135-1325\n\n## Details\n\nThe task description explicitly states \"This task does NOT touch ConsoleEventSink (lines 837+)\" and scope is limited to \"protocol and NullEventSink\". However, the diff includes updates to ConsoleEventSink methods adding `issue_id` parameters. While these changes are correct and needed for consistency, they exceed the stated scope. This may cause coordination issues with mala-40pg.3 which is specifically tasked with \"Implement ConsoleEventSink logging with issue_id\".","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T19:33:10.841469864Z","created_by":"cyou","updated_at":"2026-01-01T21:23:20.786399145Z","closed_at":"2026-01-01T21:23:20.786399145Z","close_reason":"Wontfix - changes were intentionally out of scope per original task description","labels":["auto_generated","review_finding","review_finding:eacfa8235066","source:mala-40pg.2"]}
{"id":"mala-26pf","title":"[Review] src/domain/validation/config.py:198-202: [P3] Reject boolean thresholds in coverage config","description":"## Review Finding\n\nThis issue was auto-created from a P3 review finding.\n\n**Source issue:** mala-fdp1.1\n**Reviewer:** codex\n**Location:** src/domain/validation/config.py:198-202\n\n## Details\n\n`threshold: true` is accepted because `bool` satisfies `int | float`, then it’s coerced to `1.0` and passes the range check. That silently turns a boolean into a 1% threshold. You likely want to reject booleans explicitly here (and the same applies to the `timeout` check a few lines below).","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-02T03:19:13.895562712Z","created_by":"cyou","updated_at":"2026-01-02T03:40:45.301134263Z","closed_at":"2026-01-02T03:40:45.301134263Z","close_reason":"Closed","labels":["auto_generated","review_finding","review_finding:8ff1a65d015b","source:mala-fdp1.1"]}
{"id":"mala-28sg","title":"[Review] src/infra/io/event_sink.py:1327-1329: [P2] Pass issue_id on validation success logs","description":"## Review Finding\n\nThis issue was auto-created from a P2 review finding.\n\n**Source issue:** mala-40pg.3\n**Reviewer:** codex\n**Location:** src/infra/io/event_sink.py:1327-1329\n\n## Details\n\n`on_validation_result` now accepts `issue_id`, but the success branch calls `log_verbose` without it, so verbose-mode \"Validation passed\" messages will continue to show `[agent-...]` instead of `[ISSUE-...]`. This is inconsistent with the failure branch and the stated goal of showing issue IDs in major logs. Pass `issue_id=issue_id` into the `log_verbose` call to keep output consistent.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T19:41:09.689813145Z","created_by":"cyou","updated_at":"2026-01-01T21:23:29.780887893Z","closed_at":"2026-01-01T21:23:29.780887893Z","close_reason":"Duplicate of mala-apsz which covers this finding more comprehensively","labels":["auto_generated","review_finding","review_finding:b6578355c458","source:mala-40pg.3"]}
{"id":"mala-29eu","title":"Epic: Architecture Refactor 2025-12-31 (hooks, factory, evidence)","description":"Addresses 3 high-severity issues from architecture review.\n\n## Context\n\n- `src/hooks.py` is 806 lines mixing unrelated concerns (security, caching, locking)\n- `MalaOrchestrator.__init__` is 250+ lines, hard to understand and test\n- `_finalize_issue_result` has ~180 lines with duplicate evidence extraction\n- All changes are pure refactors with no behavior changes\n\n## Scope\n\n**In:**\n- Phase 1: Split hooks.py into focused subpackage\n- Phase 2: Extract orchestrator factory function\n- Phase 3: Extract evidence extraction into pure functions\n\n**Out:**\n- Runtime behavior changes\n- Protocol interface changes\n- IssueRunner refactoring (medium-severity, deferred)\n\n## Acceptance Criteria\n\n- [ ] `src/hooks.py` replaced by `src/hooks/` subpackage with 4 focused modules\n- [ ] `MalaOrchestrator.__init__` under 60 lines with factory function\n- [ ] Evidence extraction in testable pure functions\n- [ ] All existing tests pass unchanged\n- [ ] Linting passes: `uvx ruff check . \u0026\u0026 uvx ty check`\n\n## Spec\n\nSee: docs/2025-12-31-architecture-refactor-spec.md","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-31T04:49:31.732444088Z","created_by":"cyou","updated_at":"2026-01-01T15:24:42.723289935Z","closed_at":"2026-01-01T15:24:42.723289935Z","close_reason":"Closed","labels":["refactor"]}
{"id":"mala-29eu.1","title":"Split hooks.py into focused subpackage","description":"Split the 806-line `src/hooks.py` into a focused subpackage with 4 modules.\n\n## Context\n\n- `src/hooks.py` mixes 4 unrelated concerns in one file\n- Security patterns (DANGEROUS_PATTERNS, block_dangerous_commands) ~120 lines\n- File read caching (FileReadCache, make_file_read_cache_hook) ~200 lines\n- Lint caching (LintCache, make_lint_cache_hook) ~200 lines\n- Locking hooks (make_lock_enforcement_hook, make_stop_hook) ~80 lines\n- Matches existing subpackage patterns in `src/pipeline/` and `src/validation/`\n\n## Scope\n\n**In:**\n- Create `src/hooks/` directory with 4 focused modules\n- Create `src/hooks/__init__.py` with re-exports for backward compatibility\n- Delete `src/hooks.py`\n\n**Out:**\n- Changing hook behavior\n- Modifying external consumers (they use re-exports)\n\n## New Structure\n\n```\nsrc/hooks/\n├── __init__.py           # Re-exports all public symbols\n├── dangerous_commands.py # DANGEROUS_PATTERNS, DESTRUCTIVE_GIT_PATTERNS, SAFE_GIT_ALTERNATIVES, BASH_TOOL_NAMES, block_dangerous_commands(), block_morph_replaced_tools()\n├── file_cache.py         # CachedFileInfo, FileReadCache, make_file_read_cache_hook(), FILE_WRITE_TOOLS, FILE_PATH_KEYS\n├── lint_cache.py         # LINT_COMMAND_PATTERNS, LintCacheEntry, LintCache, _get_git_state(), _detect_lint_command(), make_lint_cache_hook()\n└── locking.py            # make_lock_enforcement_hook(), make_stop_hook()\n```\n\n## Acceptance Criteria\n\n- [ ] `src/hooks/dangerous_commands.py` contains security patterns and blocking hooks\n- [ ] `src/hooks/file_cache.py` contains file read caching logic\n- [ ] `src/hooks/lint_cache.py` contains lint command caching logic\n- [ ] `src/hooks/locking.py` contains lock enforcement hooks\n- [ ] `src/hooks/__init__.py` re-exports all public symbols including PreToolUseHook and StopHook type aliases\n- [ ] `from src.hooks import X` continues to work for all existing consumers\n- [ ] `src/hooks.py` deleted\n- [ ] All existing tests pass: `uv run pytest -m \"unit or integration\"`\n- [ ] Linting passes: `uvx ruff check . \u0026\u0026 uvx ty check`\n\n## Test Plan\n\n1. Run `uv run pytest -m \"unit or integration\"` - all existing hook tests must pass via re-exports\n2. Run `uvx ruff check . \u0026\u0026 uvx ty check`\n3. Verify no external import changes needed (check agent_session_runner.py imports work)\n\n## Notes for Agent\n\n- Each new module needs its own TYPE_CHECKING imports for SDK types (HookContext, PreToolUseHookInput, etc.)\n- FILE_WRITE_TOOLS and FILE_PATH_KEYS stay in file_cache.py (used by make_file_read_cache_hook)\n- BASH_TOOL_NAMES used by both dangerous_commands.py and lint_cache.py - put in dangerous_commands.py, import from there in lint_cache.py\n- Preserve the import from mcp module: `from .mcp import MORPH_DISALLOWED_TOOLS` in dangerous_commands.py","notes":"Quality gate failed: Timeout after 60 minutes\nLog: /home/cyou/.claude/projects/-home-cyou-mala/48dc63f8-23a9-4aaf-92d2-8dbce15d7f3c.jsonl","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-31T04:49:54.360423932Z","created_by":"cyou","updated_at":"2025-12-31T17:54:27.083530134Z","closed_at":"2025-12-31T17:54:27.083530134Z","close_reason":"Closed","labels":["needs-followup"],"dependencies":[{"issue_id":"mala-29eu.1","depends_on_id":"mala-29eu","type":"parent-child","created_at":"2025-12-31T04:49:54.368107598Z","created_by":"daemon"}]}
{"id":"mala-29eu.2","title":"Extract orchestrator initialization into factory function","description":"Extract the 250+ line `MalaOrchestrator.__init__` into a factory function.\n\n## Context\n\n- `MalaOrchestrator.__init__` spans lines 147-395 (~250 lines)\n- Mixes config derivation, feature flags, DI setup, pipeline runner construction\n- Hard to test in isolation; new developers must trace 250+ lines to understand initialization\n- Matches existing factory pattern in `build_validation_spec()` in `src/validation/spec.py`\n\n## Scope\n\n**In:**\n- Create `src/orchestrator_factory.py` with OrchestratorConfig, OrchestratorDependencies, create_orchestrator()\n- Refactor `__init__` to support both legacy and new signatures\n- Update cli.py to use factory\n\n**Out:**\n- Changing runtime behavior\n- Modifying protocol interfaces\n\n## Technical Design\n\n```python\n@dataclass\nclass OrchestratorConfig:\n    repo_path: Path\n    max_agents: int | None = None\n    timeout_minutes: int | None = None\n    # ... all config fields from current __init__\n\n@dataclass\nclass OrchestratorDependencies:\n    issue_provider: IssueProvider\n    code_reviewer: CodeReviewer\n    gate_checker: GateChecker\n    # ... all protocol implementations\n\ndef create_orchestrator(\n    config: OrchestratorConfig,\n    *,\n    mala_config: MalaConfig | None = None,\n    deps: OrchestratorDependencies | None = None,\n    # Individual overrides for testing...\n) -\u003e MalaOrchestrator:\n    \"\"\"Factory function encapsulating all initialization logic.\"\"\"\n```\n\n## Acceptance Criteria\n\n- [ ] `src/orchestrator_factory.py` contains OrchestratorConfig and OrchestratorDependencies dataclasses\n- [ ] `create_orchestrator()` factory function encapsulates all initialization logic\n- [ ] `MalaOrchestrator.__init__` under 60 lines\n- [ ] Supports both legacy (individual params) and new (_config, _deps) patterns\n- [ ] Legacy callers continue to work unchanged (backward compatible)\n- [ ] `src/cli.py` uses `create_orchestrator()` for production instantiation\n- [ ] All existing tests pass: `uv run pytest -m \"unit or integration\"`\n- [ ] Linting passes: `uvx ruff check . \u0026\u0026 uvx ty check`\n\n## Test Plan\n\n1. Run `uv run pytest -m \"unit or integration\"` - all orchestrator tests must pass\n2. Run `uvx ruff check . \u0026\u0026 uvx ty check`\n3. Add unit tests for create_orchestrator() with various config combinations\n4. Verify legacy __init__ still works with individual parameters\n\n## Notes for Agent\n\n- Use `_init_from_config()` and `_init_legacy()` helper methods to keep __init__ clean\n- When _config is provided but _deps is None, raise ValueError (don't silently fall back)\n- Config precedence: explicit overrides \u003e OrchestratorConfig \u003e MalaConfig \u003e defaults\n- AgentSessionRunner is NOT in OrchestratorDependencies (constructed per-issue in run_implementer)","notes":"Quality gate failed: Timeout after 60 minutes\nLog: /home/cyou/.claude/projects/-home-cyou-mala/64125c1a-959e-44f6-bd64-9950e2a7e16c.jsonl","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-31T04:50:16.033010911Z","created_by":"cyou","updated_at":"2025-12-31T18:05:50.704813262Z","closed_at":"2025-12-31T18:05:50.704813262Z","close_reason":"Closed","labels":["needs-followup"],"dependencies":[{"issue_id":"mala-29eu.2","depends_on_id":"mala-29eu","type":"parent-child","created_at":"2025-12-31T04:50:16.040684028Z","created_by":"daemon"}]}
{"id":"mala-29eu.3","title":"Extract evidence extraction into pure functions","description":"Extract duplicate evidence extraction logic from `_finalize_issue_result` into pure functions.\n\n## Context\n\n- `_finalize_issue_result` spans lines 477-657 (~180 lines) with 3 branches\n- Each branch duplicates evidence extraction logic (~60% identical code)\n- Hard to unit test; changes require updating multiple locations\n- Pure function extraction enables isolated testing\n\n## Scope\n\n**In:**\n- Add GateMetadata dataclass to src/orchestrator.py\n- Implement `_build_gate_metadata()` pure function for stored gate results\n- Implement `_build_gate_metadata_from_logs()` for fallback log parsing\n- Refactor `_finalize_issue_result()` to use new functions\n- Extract helper methods for remaining logic\n\n**Out:**\n- Changing behavior of finalization\n- Extracting to separate file (keep in orchestrator.py)\n\n## Technical Design\n\n```python\n@dataclass\nclass GateMetadata:\n    quality_gate_result: QualityGateResult | None\n    validation_result: MetaValidationResult | None\n\ndef _build_gate_metadata(\n    gate_result: GateResult | None,\n    log_path: Path | None,\n    quality_gate: GateChecker,\n    per_issue_spec: ValidationSpec | None,\n) -\u003e GateMetadata:\n    \"\"\"Extract metadata from stored gate result.\"\"\"\n\ndef _build_gate_metadata_from_logs(\n    log_path: Path,\n    result: IssueResult,\n    quality_gate: GateChecker,\n    per_issue_spec: ValidationSpec | None,\n) -\u003e GateMetadata:\n    \"\"\"Fallback: parse logs directly when no stored result.\"\"\"\n```\n\n## Acceptance Criteria\n\n- [ ] `GateMetadata` dataclass added to src/orchestrator.py\n- [ ] `_build_gate_metadata()` extracts evidence from stored gate result\n- [ ] `_build_gate_metadata_from_logs()` handles fallback log parsing\n- [ ] Fallback function respects result.success for passed status (not hardcoded False)\n- [ ] When per_issue_spec is None, fallback returns GateMetadata(None, None)\n- [ ] `_finalize_issue_result()` reduced to ~80 lines using the new functions\n- [ ] Helper methods extracted: `_check_epic_closure()`, `_record_issue_run()`, `_cleanup_session_paths()`, `_emit_completion()`\n- [ ] All existing tests pass: `uv run pytest -m \"unit or integration\"`\n- [ ] Linting passes: `uvx ruff check . \u0026\u0026 uvx ty check`\n\n## Test Plan\n\n1. Run `uv run pytest -m \"unit or integration\"` - all orchestrator tests must pass\n2. Run `uvx ruff check . \u0026\u0026 uvx ty check`\n3. Add unit tests for `_build_gate_metadata()` with:\n   - Successful gate result with full evidence\n   - Failed gate result with partial evidence\n   - None gate result (returns empty metadata)\n   - Empty failure reasons, missing commit hash\n4. Add unit tests for `_build_gate_metadata_from_logs()` with:\n   - Valid spec (parses evidence)\n   - None spec (returns empty metadata)\n\n## Notes for Agent\n\n- When per_issue_spec is None, `_build_gate_metadata_from_logs()` returns GateMetadata(None, None)\n- Use result.success to determine passed status in fallback function, not hardcoded False\n- Keep functions in orchestrator.py (don't extract to separate file) - they're tightly coupled","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-31T04:50:37.909789534Z","created_by":"cyou","updated_at":"2025-12-31T19:09:53.048957797Z","closed_at":"2025-12-31T19:09:53.048957797Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-29eu.3","depends_on_id":"mala-29eu","type":"parent-child","created_at":"2025-12-31T04:50:37.916701071Z","created_by":"daemon"},{"issue_id":"mala-29eu.3","depends_on_id":"mala-29eu.2","type":"blocks","created_at":"2025-12-31T04:50:47.815353862Z","created_by":"daemon"}]}
{"id":"mala-29eu.4","title":"[Remediation] MalaOrchestrator.__init__ under 60 lines with factory functi...","description":"## Context\nThis issue was auto-created by epic verification for epic `mala-29eu`.\n\n## Epic Description / Acceptance Criteria\nTitle: Epic: Architecture Refactor 2025-12-31 (hooks, factory, evidence)\n\nAddresses 3 high-severity issues from architecture review.\n\n## Context\n\n- `src/hooks.py` is 806 lines mixing unrelated concerns (security, caching, locking)\n- `MalaOrchestrator.__init__` is 250+ lines, hard to understand and test\n- `_finalize_issue_result` has ~180 lines with duplicate evidence extraction\n- All changes are pure refactors with no behavior changes\n\n## Scope\n\n**In:**\n- Phase 1: Split hooks.py into focused subpackage\n- Phase 2: Extract orchestrator factory function\n- Phase 3: Extract evidence extraction into pure functions\n\n**Out:**\n- Runtime behavior changes\n- Protocol interface changes\n- IssueRunner refactoring (medium-severity, deferred)\n\n## Acceptance Criteria\n\n- [ ] `src/hooks.py` replaced by `src/hooks/` subpackage with 4 focused modules\n- [ ] `MalaOrchestrator.__init__` under 60 lines with factory function\n- [ ] Evidence extraction in testable pure functions\n- [ ] All existing tests pass unchanged\n- [ ] Linting passes: `uvx ruff check . \u0026\u0026 uvx ty check`\n\n## Spec\n\nSee: docs/2025-12-31-architecture-refactor-spec.md\n\n## Commit Scope\n- Range hint: fe43d72c1f2b303b0a6317b32a45b48ea497be44^..ace3f68fb775964afb998669d62bbe5c986b9ffe\n- Commits:\n- f85005c6ab0c3dc0bd8ac590a559b4122e731044 bd-mala-29eu.2: Add unit tests for orchestrator factory function\n- af8739de9442a7f5583259e0bb8472c3cd026d45 bd-mala-29eu.2: Review only issue commits via Cerberus\n- 1de9b755be81d4bdb0b3916e0b18c7eeb17489d5 bd-mala-29eu.2: Fix review issues - re-exports and factory behavior\n- 32f9c0a64290112120fc5859713539af443b7636 bd-mala-29eu.2: Add orchestrator factory with OrchestratorConfig\n- 8a414a4368f69ac64c3a09713d5c59e71a379d3c Revert epic mala-29eu: Architecture Refactor 2025-12-31\n- 181119bb40b8f14b8617ce638cb6f1c75a648339 bd-mala-29eu.2: Add orchestrator factory with OrchestratorConfig\n- ace3f68fb775964afb998669d62bbe5c986b9ffe bd-mala-n5du: Complete evidence extraction with validation_result in fallback path\n- d37c432ffcbb3eb395171153c0ba1415ac83f99a bd-mala-29eu.1: Restore strict validation for aggregated_findings\n- 21d0a84eadeaf6aff0a8ada9f1fb1f502b7ebbab bd-mala-29eu.1: Re-export get_lock_holder and run_command for backward compat\n- c1aabf576d21c12957aeef08b334b97733f38236 bd-mala-29eu.1: Format test file\n- 7d0e046fa5bd45720fa974e37996d9f68d8e246f bd-mala-29eu.1: Split hooks.py into focused subpackage\n- fe43d72c1f2b303b0a6317b32a45b48ea497be44 bd-mala-29eu.1: Split hooks.py into focused subpackage\n- bd38e5c54ae129c1016d7d0424e66cc1d957264b bd-mala-29eu.3: Fix lint errors in test imports\n\n## Child Issues\n- mala-29eu.1\n- mala-29eu.2\n- mala-29eu.3\n- mala-n5du\n\n## Unmet Criterion\nMalaOrchestrator.__init__ under 60 lines with factory function\n\n## Evidence\nThe __init__ method is currently 84 lines (lines 360-443) which exceeds the 60-line requirement. While a factory function create_orchestrator() was implemented and works correctly, the original __init__ method size was not reduced to meet the acceptance criteria.\n\n## Severity\nmajor\n\n## Resolution\nAddress this criterion to unblock epic closure. When complete, close this issue.\n","notes":"USER FEEDBACK: Code style issues like method line counts shouldn't block epic closure. This type of criterion should be informational only, not create a blocking remediation task. The factory function was implemented correctly and achieves the architectural goal - the init method being 84 vs 60 lines is a stylistic detail, not a functional requirement.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-01T05:55:33.086667643Z","created_by":"cyou","updated_at":"2026-01-01T06:00:16.362339222Z","closed_at":"2026-01-01T06:00:16.362339222Z","close_reason":"Code style issues (line counts) should be informational, not blockers. The factory function achieves the architectural goal - 84 vs 60 lines is stylistic, not functional.","labels":["auto_generated","epic_remediation:mala-29eu:13a69444f9e71224d8b3ef6280cb5557d33ca04d9d94317c2463053522a43ed3"],"dependencies":[{"issue_id":"mala-29eu.4","depends_on_id":"mala-29eu","type":"parent-child","created_at":"2026-01-01T05:55:33.087121269Z","created_by":"daemon"}]}
{"id":"mala-2eu","title":"Update CLI parsing for disable-validations + related flags","description":"Context:\n- CLI must accept --disable-validations and map values into config/spec inputs.\n- Other flags include --coverage-threshold, --lint-only-for-docs, --skip-e2e-if-no-keys.\n\nScope:\n- In: parse --disable-validations CSV and pass to config; validate values; wire other flags.\n- Out: orchestrator execution changes (separate task).\n\nAcceptance Criteria:\n- Unknown disable values produce a clear CLI error.\n- Parsed options are available to spec/orchestrator configuration.\n- Help text matches the plan.\n\nTest Plan:\n- Add CLI parsing tests for valid/invalid disable lists.\n- Run CLI unit tests.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T23:00:01.741979177Z","updated_at":"2025-12-27T00:55:51.216408694Z","closed_at":"2025-12-27T00:55:51.216408694Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-2eu","depends_on_id":"mala-5us","type":"blocks","created_at":"2025-12-26T23:00:26.581177502Z","created_by":"daemon"}]}
{"id":"mala-2exn","title":"[Review] src/infra/io/event_sink.py:1196-1201: [P3] Update Args section in ConsoleEventSink.on_gate_result docstring","description":"## Review Finding\n\nThis issue was auto-created from a P3 review finding.\n\n**Source issue:** mala-40pg.2\n**Reviewer:** gemini\n**Location:** src/infra/io/event_sink.py:1196-1201\n\n## Details\n\nThe `issue_id` parameter was added to the signature but not to the `Args` section of the docstring for `ConsoleEventSink.on_gate_result`. For consistency with the Protocol and other methods that document their arguments, this should be added.","notes":"Quality gate failed: External review failed: spawn failed: Artifact written: /home/cyou/.claude/projects/-home-cyou-mala/cerberus/4d55972e-ae6a-4e3d-81dc-74b8a86f103d/latest.md\nReview gate already active (status: pending, age: 57s)\nUse /home/cyou/.claude/plugins/cache/cerberus/cerberus/1.10.6/bin/review-gate resolve to complete the existing gate first.\nLog: /home/cyou/.claude/projects/-home-cyou-mala/4d55972e-ae6a-4e3d-81dc-74b8a86f103d.jsonl","status":"closed","priority":4,"issue_type":"task","created_at":"2026-01-01T19:33:10.867611486Z","created_by":"cyou","updated_at":"2026-01-02T00:02:32.569180808Z","closed_at":"2026-01-01T23:53:31.188783532Z","labels":["auto_generated","needs-followup","review_finding","review_finding:9f804d3a72f0","source:mala-40pg.2"],"dependencies":[{"issue_id":"mala-2exn","depends_on_id":"mala-apsz","type":"blocks","created_at":"2026-01-01T21:29:27.017529522Z","created_by":"daemon"}]}
{"id":"mala-2ez","title":"Agent mail using filesystem","description":"Agent mail using filesystem: allow agents to send/receive coordination messages via files to reduce lock contention and support handoffs.","status":"closed","priority":4,"issue_type":"epic","created_at":"2025-12-26T00:55:42.268473542Z","updated_at":"2025-12-26T18:28:06.757887173Z","closed_at":"2025-12-26T18:28:06.757887173Z","close_reason":"Closed per user request"}
{"id":"mala-2i7","title":"Epic: Validation module refactor + tooling","description":"Context:\n- Covers refactor of validation module into a package and new validation helpers.\n- Derived from docs/quality-hardening-plan.md (v5).\n\nScope:\n- In: validation package scaffolding + core modules (spec, worktree, coverage, e2e, runner).\n- Out: orchestrator/gate integration (handled in a separate epic).\n\nAcceptance Criteria:\n- All child issues closed and validation modules ready for integration.\n\nTest Plan:\n- Defer to child issue test plans.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-26T23:00:01.608651792Z","updated_at":"2025-12-27T01:06:32.783600955Z","closed_at":"2025-12-27T01:06:32.783600955Z","close_reason":"All 6 child issues closed: validation module refactored into package with spec, coverage, worktree, e2e, runner, deps_sync modules. 239 unit tests passing, 88% coverage.","dependencies":[{"issue_id":"mala-2i7","depends_on_id":"mala-j6p","type":"blocks","created_at":"2025-12-26T23:00:26.343216812Z","created_by":"daemon"},{"issue_id":"mala-2i7","depends_on_id":"mala-5us","type":"blocks","created_at":"2025-12-26T23:00:26.354537591Z","created_by":"daemon"},{"issue_id":"mala-2i7","depends_on_id":"mala-252","type":"blocks","created_at":"2025-12-26T23:00:26.365551792Z","created_by":"daemon"},{"issue_id":"mala-2i7","depends_on_id":"mala-c1o","type":"blocks","created_at":"2025-12-26T23:00:26.37697623Z","created_by":"daemon"},{"issue_id":"mala-2i7","depends_on_id":"mala-4dh","type":"blocks","created_at":"2025-12-26T23:00:26.387839923Z","created_by":"daemon"},{"issue_id":"mala-2i7","depends_on_id":"mala-cij","type":"blocks","created_at":"2025-12-26T23:00:26.399183121Z","created_by":"daemon"}]}
{"id":"mala-2im","title":"CLI status should be directory-scoped by default","description":"## Problem\n\nCurrently `mala status` (or similar status command) reports on all running mala instances globally. This is confusing when working in multiple repos simultaneously - you see status for unrelated runs.\n\n## Desired Behavior\n\n- **Default**: Show status only for mala instance(s) running in the current directory\n- **--all flag**: Show status for all running mala instances across all directories\n\n### Example output:\n\n```bash\n# In /home/cyou/mala\n$ mala status\nRunning: 3 agents processing 5 issues\nStarted: 10 minutes ago\nIssues: 2 completed, 3 in progress\n\n# In /home/cyou/other-repo (no mala running)\n$ mala status\nNo mala instance running in this directory.\n\n# Show all instances\n$ mala status --all\n/home/cyou/mala:\n  Running: 3 agents processing 5 issues\n  Started: 10 minutes ago\n\n/home/cyou/another-repo:\n  Running: 1 agent processing 2 issues\n  Started: 5 minutes ago\n```\n\n## Implementation\n\n**Files:**\n- `src/cli.py`: Update status command to filter by cwd, add --all flag\n- `src/tools/locking.py` or status module: Add helper to get running instances by directory\n\n### Key changes:\n\n1. **Store repo path in lock/status file**: Ensure running instances record their repo path\n2. **Filter by cwd**: Default status checks if current directory matches any running instance's repo path\n3. **--all flag**: Bypasses directory filter, shows all instances grouped by repo\n\n### CLI changes:\n\n```python\n@app.command()\ndef status(\n    all_instances: bool = typer.Option(False, \"--all\", help=\"Show all running instances\")\n):\n    \"\"\"Show status of mala instance(s).\"\"\"\n    cwd = Path.cwd().resolve()\n    \n    if all_instances:\n        instances = get_all_running_instances()\n    else:\n        instances = get_running_instances_for_dir(cwd)\n    \n    if not instances:\n        if all_instances:\n            print(\"No mala instances running.\")\n        else:\n            print(\"No mala instance running in this directory.\")\n        return\n    \n    for instance in instances:\n        display_instance_status(instance)\n```\n\n## Acceptance Criteria\n\n- [ ] `mala status` only shows instance running in current directory\n- [ ] `mala status` prints clear message when no instance running in cwd\n- [ ] `mala status --all` shows all running instances grouped by directory\n- [ ] Repo path is recorded when mala starts (for filtering)\n\n## Test Plan\n\n- Unit tests for directory filtering logic\n- Manual: start mala in two repos, verify `status` shows only local instance\n- Manual: verify `--all` shows both instances\n\n## Dependencies\n\n- May benefit from mala-db2 (per-repo log directories) for consistent path handling","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-27T22:52:41.322367853Z","updated_at":"2025-12-28T05:51:58.825582959Z","closed_at":"2025-12-28T05:51:58.825582959Z","close_reason":"Closed"}
{"id":"mala-2m5","title":"Scope down permissions, setup sandbox/dev container","description":"Reduce agent permissions and set up sandboxed dev container environment for safer execution","status":"blocked","priority":0,"issue_type":"task","created_at":"2025-12-28T06:21:39.150409473Z","updated_at":"2025-12-28T06:24:59.117208686Z"}
{"id":"mala-2u3","title":"Epic: Quality Gate Re-entry + Codex Review","description":"Implements same-session re-entry on quality gate failure, shifts issue closing to the orchestrator, and adds a Codex review step with structured JSON output and guardrails.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-26T19:04:48.636008473Z","updated_at":"2025-12-26T19:32:39.524157706Z","closed_at":"2025-12-26T19:32:39.524157706Z","close_reason":"All children completed"}
{"id":"mala-2u3.1","title":"Scope quality gate evidence by attempt","description":"Primary files: src/quality_gate.py, tests/test_quality_gate.py\n\nContext:\n- Gate evidence currently scans the full session log and can pass on stale validation\n- Re-entry needs evidence scoped to the latest attempt\n- No-progress detection should treat unchanged commit + no new evidence as a failure\n\nScope:\n- In: add log-offset-based parsing, return/update offset per attempt, expose a helper that only counts evidence after offset\n- In: add no-progress detection helper (unchanged commit + no new evidence)\n- Out: changes to orchestrator retry loop or prompts\n\nAcceptance Criteria:\n- Evidence parsing can start at a byte offset and ignore earlier log lines\n- Gate result can indicate when no new evidence was found since the last attempt\n- No-progress detection is implemented and covered by tests\n\nTest Plan:\n- TDD: add failing tests for offset parsing and no-progress detection, then implement\n- Run unit tests for quality gate parsing (targeted test file)\n\nNotes for Agent:\n- Keep public API small; prefer a new optional offset argument or a small helper returning (evidence, new_offset)\n","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T19:05:00.499151942Z","updated_at":"2025-12-26T19:12:12.110042901Z","closed_at":"2025-12-26T19:12:12.110042901Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-2u3.1","depends_on_id":"mala-2u3","type":"parent-child","created_at":"2025-12-26T19:05:00.510288361Z","created_by":"daemon"}]}
{"id":"mala-2u3.2","title":"Add retry/review config to CLI and run metadata","description":"Primary files: src/cli.py, src/logging/run_metadata.py\n\nContext:\n- New gate/review retry limits and a codex-review toggle need to be configurable\n- Run metadata should record these config values and per-issue attempt counts\n\nScope:\n- In: add CLI flags --max-gate-retries, --max-review-retries, --codex-review\n- In: extend RunConfig and IssueRun metadata to capture retry limits and attempt counts\n- Out: orchestrator behavior changes (handled separately)\n\nAcceptance Criteria:\n- CLI help shows new flags and defaults\n- Run metadata JSON includes new config fields\n- IssueRun records gate/review attempts (even if defaulted)\n\nTest Plan:\n- Manual: run \"mala run --help\" and verify new flags\n- Manual: run a short session and confirm metadata JSON includes new fields\n\nNotes for Agent:\n- Keep new fields optional/backward compatible in RunMetadata serialization\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T19:05:08.142483863Z","updated_at":"2025-12-26T19:10:26.476631609Z","closed_at":"2025-12-26T19:10:26.476631609Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-2u3.2","depends_on_id":"mala-2u3","type":"parent-child","created_at":"2025-12-26T19:05:08.154749276Z","created_by":"daemon"}]}
{"id":"mala-2u3.3","title":"Shift issue closing to orchestrator","description":"Primary files: src/orchestrator.py, src/beads_client.py, src/prompts/implementer_prompt.md\n\nContext:\n- Agent currently closes issues, which conflicts with same-session re-entry\n- Orchestrator should close only after all gates pass\n\nScope:\n- In: remove bd close instruction from implementer prompt\n- In: add BeadsClient.close_async(issue_id) wrapper\n- In: orchestrator closes issue after gate+review pass\n- Out: re-entry loop or codex review logic (separate tasks)\n\nAcceptance Criteria:\n- Agents no longer call bd close in the prompt\n- Orchestrator closes issues after successful completion\n- No regressions in .beads/issues.jsonl commit flow\n\nTest Plan:\n- Manual: run one issue end-to-end and confirm orchestrator performs bd close\n\nNotes for Agent:\n- Keep orchestrator success criteria aligned with new close flow\n","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T19:05:17.09218776Z","updated_at":"2025-12-26T19:15:17.759359304Z","closed_at":"2025-12-26T19:15:17.759359304Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-2u3.3","depends_on_id":"mala-2u3","type":"parent-child","created_at":"2025-12-26T19:05:17.111639583Z","created_by":"daemon"},{"issue_id":"mala-2u3.3","depends_on_id":"mala-2u3.2","type":"blocks","created_at":"2025-12-26T19:06:12.608088508Z","created_by":"daemon"}]}
{"id":"mala-2u3.4","title":"Implement same-session re-entry on gate failure","description":"Primary files: src/orchestrator.py\n\nContext:\n- Quality gate failures should trigger a same-session fix attempt, not a reopen\n- Claude SDK supports session resume by passing resume: \u003csession_id\u003e\n- Gate retries need guardrails to avoid infinite loops\n\nScope:\n- In: capture session_id from the init system message and store per issue\n- In: implement a gate retry loop with resume calls and failure-reason prompts\n- In: track attempt counts and log offsets per attempt\n- In: avoid adding to failed_issues until retries are exhausted\n- Out: codex review integration (separate task)\n\nAcceptance Criteria:\n- Gate failure triggers a follow-up prompt in the SAME session (resume, no fork)\n- Retries stop after max attempts and mark needs-followup\n- No-progress detection stops retries when commit hash is unchanged and no new evidence exists\n\nTest Plan:\n- Manual: force a gate failure (skip validations) and confirm resume + retry count\n- Manual: confirm retries stop after max\n\nNotes for Agent:\n- Keep retry state per issue to support parallel agents\n","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T19:05:26.093985944Z","updated_at":"2025-12-26T19:22:37.521894989Z","closed_at":"2025-12-26T19:22:37.521894989Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-2u3.4","depends_on_id":"mala-2u3","type":"parent-child","created_at":"2025-12-26T19:05:26.106458545Z","created_by":"daemon"},{"issue_id":"mala-2u3.4","depends_on_id":"mala-2u3.3","type":"blocks","created_at":"2025-12-26T19:06:16.691077263Z","created_by":"daemon"},{"issue_id":"mala-2u3.4","depends_on_id":"mala-2u3.1","type":"blocks","created_at":"2025-12-26T19:06:19.606198443Z","created_by":"daemon"}]}
{"id":"mala-2u3.5","title":"Add Codex review step with strict JSON + retry","description":"Primary files: src/orchestrator.py (optionally new helper module)\n\nContext:\n- After deterministic gates pass, we want an automated Codex review\n- Review output must be strict JSON with one repair retry, then fail closed\n\nScope:\n- In: invoke codex review --commit \u003csha\u003e with a strict JSON schema prompt\n- In: parse JSON output; if invalid, retry once with stricter prompt\n- In: if review fails, resume SAME Claude session with review issues\n- In: re-run deterministic gate after review fixes\n- Out: changes to quality gate parsing logic (separate task)\n\nAcceptance Criteria:\n- Codex review runs after deterministic gate pass\n- JSON parsing is strict with a single retry on parse failure\n- Review failures trigger same-session fixes and re-gating\n\nTest Plan:\n- Manual: run review on a known commit and verify JSON parsing\n- Manual: simulate invalid JSON (e.g., by altering prompt) and verify retry + fail-closed behavior\n\nNotes for Agent:\n- Keep prompts ASCII-only and avoid code fences in the JSON response\n","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T19:05:35.484550183Z","updated_at":"2025-12-26T19:29:10.812795467Z","closed_at":"2025-12-26T19:29:10.812795467Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-2u3.5","depends_on_id":"mala-2u3","type":"parent-child","created_at":"2025-12-26T19:05:35.484834411Z","created_by":"daemon"},{"issue_id":"mala-2u3.5","depends_on_id":"mala-2u3.4","type":"blocks","created_at":"2025-12-26T19:06:23.642607996Z","created_by":"daemon"}]}
{"id":"mala-2u3.6","title":"Update README for orchestrator-close + gate/review retries","description":"Primary files: README.md\n\nContext:\n- Workflow docs currently say the agent closes issues and gate failures reopen later\n- We are changing flow to orchestrator-close + same-session re-entry + codex review\n\nScope:\n- In: update workflow and quality gate sections to reflect new behavior\n- In: document retry limits and codex review step\n- Out: code changes\n\nAcceptance Criteria:\n- README describes orchestrator closing behavior\n- README describes same-session re-entry and review retries\n\nTest Plan:\n- N/A (documentation change)\n\nNotes for Agent:\n- Align wording with actual implemented behavior\n","status":"closed","priority":3,"issue_type":"chore","created_at":"2025-12-26T19:05:43.082927169Z","updated_at":"2025-12-26T19:32:31.343813389Z","closed_at":"2025-12-26T19:32:31.343813389Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-2u3.6","depends_on_id":"mala-2u3","type":"parent-child","created_at":"2025-12-26T19:05:43.094365345Z","created_by":"daemon"},{"issue_id":"mala-2u3.6","depends_on_id":"mala-2u3.5","type":"blocks","created_at":"2025-12-26T19:06:26.62064641Z","created_by":"daemon"}]}
{"id":"mala-3js","title":"Consolidate agent receive loop","description":"Context:\n- agent_loop.py duplicates the receive loop in MalaOrchestrator and is currently unused.\n- Divergent logic increases maintenance risk.\n\nScope:\n- In: consolidate to a single agent receive loop (either delete agent_loop.py or adopt it in orchestrator).\n- Out: changing logging format or agent behavior beyond consolidation.\n\nAcceptance Criteria:\n- Only one receive loop implementation remains.\n- Orchestrator behavior and logging remain consistent with current output.\n\nTest Plan:\n- TDD: if adopting agent_loop, add/adjust tests to cover loop integration; otherwise verify orchestrator tests still pass.\n\nNotes for Agent:\n- Keep JSONL and Braintrust logging order unchanged.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T17:36:04.305912715Z","updated_at":"2025-12-26T19:06:24.780657053Z","closed_at":"2025-12-26T19:06:24.780657053Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-3js","depends_on_id":"mala-jnq","type":"parent-child","created_at":"2025-12-26T17:36:15.734362257Z","created_by":"daemon"},{"issue_id":"mala-3js","depends_on_id":"mala-vdf","type":"blocks","created_at":"2025-12-26T17:36:21.629842741Z","created_by":"daemon"}]}
{"id":"mala-3m7","title":"Deadlock detection between agents","description":"Detect deadlocks between agents (e.g., two agents waiting on each other's locks). Surface the deadlock and provide a resolution path (alert, timeout, or automatic recovery).","status":"closed","priority":4,"issue_type":"epic","created_at":"2025-12-26T00:55:42.798438926Z","updated_at":"2025-12-26T18:28:06.819113751Z","closed_at":"2025-12-26T18:28:06.819113751Z","close_reason":"Closed per user request"}
{"id":"mala-3qp","title":"Epic: Architecture review 2025-12-29 (bootstrap, boundaries, SDK coupling)","description":"## Context\nArchitecture review from 2025-12-29 using multi-model synthesis (Codex gpt-5.2-codex, Gemini gemini-3-flash-preview).\n\n## Key Findings\n\n### Critical\n1. **Bootstrap bypass** - SDK imports at module load defeat lazy-loading; 4 files need deferred imports\n\n### High Priority\n2. **Dual locking implementations** - Shell scripts and Python duplicate locking logic\n3. **CommandRunner boundary inversion** - Lives in validation/ but used by core modules\n4. **Logging depends on validation types** - run_metadata imports from validation.spec\n5. **SDK log coupling** - Hardcoded paths and schema knowledge spread across modules\n6. **Orchestrator monolith** - 1654 lines mixing policy, I/O, presentation\n\n### Medium Priority\n7. **Event sink not wired** (existing mala-7si.1)\n8. **SpecValidationRunner oversized** - 813 lines, mixed concerns\n9. **ValidationEvidence rigid** - Hardcoded booleans vs spec-driven\n10. **Duplicate validation runs** - Gate and metadata run validation separately\n\n### Low Priority\n11. **BeadsClient mixed concerns**\n12. **Duplicate dataclasses**\n\n## Execution Strategy\n1. Fix bootstrap bypass first (Critical, blocks clean testing)\n2. Boundary fixes can parallelize (CommandRunner move, shared types)\n3. Larger refactors (orchestrator decomposition, SDK abstraction) after boundaries clean\n\n## Related Epics\n- mala-869: Previous architecture work (closed issues for protocols, CommandRunner migrations)\n- mala-7si: Healthcheck cleanup (MalaConfig injection in progress)\n- mala-7si.1: EventSink injection (deferred P4)\n\n## Primary Files\n- src/orchestrator.py, src/__init__.py, src/hooks.py, src/braintrust_integration.py (bootstrap)\n- src/tools/locking.py, src/scripts/lock-*.sh (locking)\n- src/validation/command_runner.py (boundary)\n- src/logging/run_metadata.py, src/validation/spec.py (shared types)","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-29T00:01:44.520404643Z","created_by":"cyou","updated_at":"2025-12-30T03:27:37.758139778Z","closed_at":"2025-12-30T03:27:37.758139778Z","close_reason":"All mala-3qp child issues are closed; removed healthcheck epic linkage to allow closure."}
{"id":"mala-3qp.1","title":"Defer SDK imports to fix bootstrap bypass (orchestrator, hooks, braintrust_integration)","description":"## Context\n- `src/orchestrator.py:12-20` imports `claude_agent_sdk` at module-level, but correct behavior depends on `cli.bootstrap()` running first to load env and patch Braintrust\n- CLI lazy-loading via `__getattr__` is defeated by multiple paths:\n  1. Direct import: `from src.orchestrator import MalaOrchestrator`\n  2. Package import: `src/__init__.py:3` re-exports MalaOrchestrator\n  3. Transitive via hooks: `src/hooks.py:12-17` imports `claude_agent_sdk.types`\n  4. Transitive via braintrust: `src/braintrust_integration.py:34-40` imports SDK types\n- This causes **silent failures**: Braintrust tracing won't work, environment variables may be missing\n\n## Primary Files\n- src/orchestrator.py:12-20 (defer SDK imports)\n- src/hooks.py:12-17 (defer SDK type imports)\n- src/braintrust_integration.py:34-40 (defer SDK imports)\n- src/__init__.py:3 (use __getattr__ for lazy export)\n\n## Scope\n**In:** Defer all `claude_agent_sdk` imports using TYPE_CHECKING guards and runtime imports\n**In:** Change `src/__init__.py` to use `__getattr__` for lazy MalaOrchestrator export\n**In:** Update type aliases in hooks.py to use string annotations\n**Out:** Changing CLI entry point structure\n**Out:** Removing Braintrust integration\n\n## Acceptance Criteria\n- `import src` does not import `claude_agent_sdk`\n- `from src.orchestrator import MalaOrchestrator` does not import SDK until bootstrap runs\n- `from src.hooks import ...` does not import SDK until bootstrap runs\n- All modules with SDK type hints use TYPE_CHECKING guards\n- Unit test demonstrates both CLI and direct-import paths work correctly\n- No silent failures when BRAINTRUST_API_KEY is set but bootstrap wasn't called\n\n## Test Plan\n- TDD: Add test that imports orchestrator directly and verifies SDK not loaded\n- Add test that imports src.hooks and verifies SDK not loaded\n- Test with and without BRAINTRUST_API_KEY set\n- Verify `import src` does not trigger SDK import\n\n## Notes for Agent\n- Use `if TYPE_CHECKING:` guard for type hints, move actual imports to method bodies\n- For hooks.py type aliases: `Callable[[\"PreToolUseHookInput\", ...], ...]` with string annotations\n- orchestrator.py imports hooks at module level, so hooks must be fixed too\n- Package __init__.py pattern:\n  ```python\n  def __getattr__(name: str):\n      if name == \"MalaOrchestrator\":\n          from .orchestrator import MalaOrchestrator\n          return MalaOrchestrator\n      raise AttributeError(f\"module {__name__!r} has no attribute {name!r}\")\n  ```","notes":"Quality gate failed: Timeout after 30 minutes\nLog: /home/cyou/.claude/projects/-home-cyou-mala/671bb8c9-9098-4bfa-97ae-0f8de3d811bf.jsonl","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-12-29T00:02:07.754689932Z","created_by":"cyou","updated_at":"2025-12-29T04:12:37.639324189Z","closed_at":"2025-12-29T04:12:37.639324189Z","close_reason":"Closed","labels":["needs-followup"],"dependencies":[{"issue_id":"mala-3qp.1","depends_on_id":"mala-3qp","type":"parent-child","created_at":"2025-12-29T00:02:07.762817184Z","created_by":"daemon"}]}
{"id":"mala-3qp.10","title":"Extract baseline refresh from SpecValidationRunner","description":"## Context\n- SpecValidationRunner is 813 lines combining worktree management, baseline coverage refresh, command execution, and E2E coordination\n- Baseline refresh logic (lines ~168-301) involves file-based locking, temporary worktrees, and specialized pytest flag overrides\n- This is a distinct sub-domain buried inside the validation runner\n- Confidence: High (from Gemini review)\n\n## Primary Files\n- src/validation/spec_runner.py:168-301 (baseline refresh logic to extract)\n- src/validation/coverage.py (existing, could host BaselineCoverageService)\n\n## Scope\n**In:** Extract baseline refresh into BaselineCoverageService\n**In:** Use composition in SpecValidationRunner to coordinate\n**Out:** Changing validation spec format\n**Out:** Modifying E2E test behavior\n\n## Acceptance Criteria\n- SpecValidationRunner focused strictly on executing ValidationSpec\n- Baseline refresh logic in separate module\n- Clear boundaries between worktree management and validation execution\n- Existing behavior unchanged\n\n## Test Plan\n- Unit test BaselineCoverageService with mocked CommandRunner\n- Test baseline refresh concurrently from two processes (locking behavior)\n- Run existing coverage tests\n\n## Notes for Agent\n- Baseline refresh is tightly integrated with validation flow\n- Extract as callable service rather than class hierarchy\n- Service should accept worktree path, return baseline coverage result\n- Keep locking behavior intact","notes":"Quality gate failed: Timeout after 30 minutes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T00:04:49.799006251Z","created_by":"cyou","updated_at":"2025-12-29T04:37:11.978546758Z","closed_at":"2025-12-29T04:37:11.978546758Z","close_reason":"Closed","labels":["needs-followup"],"dependencies":[{"issue_id":"mala-3qp.10","depends_on_id":"mala-3qp","type":"parent-child","created_at":"2025-12-29T00:04:49.808937494Z","created_by":"daemon"},{"issue_id":"mala-3qp.10","depends_on_id":"mala-3qp.3","type":"blocks","created_at":"2025-12-29T00:05:41.636059202Z","created_by":"daemon"}]}
{"id":"mala-3qp.11","title":"Extract sorting logic from BeadsClient to IssueManager","description":"## Context\n- BeadsClient contains complex issue sorting (`_sort_by_epic_groups`) and filtering logic\n- As a \"client,\" it should focus on I/O with the bd CLI\n- Domain-specific sorting and grouping should be in a higher-level service\n- Confidence: Medium (from Gemini review)\n\n## Primary Files\n- src/beads_client.py:91-180 (sorting logic to extract)\n- src/beads_client.py:344-770 (filtering logic)\n\n## Scope\n**In:** Move sorting and filtering logic to IssueManager or WorkloadManager service\n**In:** BeadsClient returns raw issue data\n**Out:** Changing bd CLI interface\n**Out:** Modifying issue data structures\n\n## Acceptance Criteria\n- BeadsClient methods focus on CRUD-like operations for issues\n- Sorting logic is pure and testable without subprocess mocking\n- Existing orchestrator behavior unchanged\n\n## Test Plan\n- Unit tests for IssueManager using fixture data\n- Verify sorting produces same order as before\n- Run existing beads_client tests\n\n## Notes for Agent\n- Lower priority (P3) - existing tests work\n- Consider if this is worth the abstraction overhead\n- May be good opportunity to simplify complex sorting logic","notes":"Quality gate failed: Codex review failed: src/beads_client.py:193: Scope gap: BeadsClient still filters WIP issues (`blocked_by`), and `enrich_with_epics_async` filters blocked epics. That keeps filtering logic in the client and returns non-raw issue data, so the “move filtering logic / BeadsClient returns raw issue data” scope item isn’t fully addressed.\nLog: /home/cyou/.claude/projects/-home-cyou-mala/56b47f4a-a187-41ff-9534-4e4c661f24e5.jsonl","status":"closed","priority":3,"issue_type":"chore","created_at":"2025-12-29T00:05:01.859430741Z","created_by":"cyou","updated_at":"2025-12-29T15:00:52.145545339Z","closed_at":"2025-12-29T15:00:52.145545339Z","close_reason":"IssueManager extracted to src/issue_manager.py; BeadsClient delegates sorting/filtering to IssueManager methods.","labels":["needs-followup"],"dependencies":[{"issue_id":"mala-3qp.11","depends_on_id":"mala-3qp","type":"parent-child","created_at":"2025-12-29T00:05:01.869216455Z","created_by":"daemon"},{"issue_id":"mala-3qp.11","depends_on_id":"mala-3qp.3","type":"blocks","created_at":"2025-12-29T00:05:55.887086363Z","created_by":"daemon"}]}
{"id":"mala-3qp.12","title":"Epic: SpecValidationRunner decomposition into stages","description":"## Context\\n- SpecValidationRunner is oversized (~800+ lines) with mixed concerns (workspace setup, command execution, coverage, E2E, result assembly)\\n- Medium-confidence finding from 2025-12-29 architecture review (needs verification)\\n\\n## Goal\\nSplit SpecValidationRunner into focused, testable stages with explicit inputs/outputs while preserving behavior.\\n\\n## Proposed Stages\\n1. Workspace/Baseline setup (log dir, run_id, baseline refresh, worktree lifecycle)\\n2. Command execution (lint cache, step logging, command runner)\\n3. Post-processing (coverage/E2E checks, result assembly)\\n\\n## Acceptance Criteria\\n- SpecValidationRunner becomes a thin coordinator delegating to stage modules\\n- Each stage module has explicit input/output types and unit tests with fakes\\n- No behavioral regressions in validation results\\n\\n## Notes\\n- Land stages sequentially to minimize diff size\\n- Avoid changing validation policy or metadata format","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-29T15:24:39.402065862Z","created_by":"cyou","updated_at":"2025-12-29T23:11:31.418794572Z","closed_at":"2025-12-29T23:11:31.418794572Z","close_reason":"All children completed","dependencies":[{"issue_id":"mala-3qp.12","depends_on_id":"mala-3qp","type":"parent-child","created_at":"2025-12-29T15:24:39.414571063Z","created_by":"daemon"}]}
{"id":"mala-3qp.12.1","title":"SpecValidationRunner: extract workspace/baseline/worktree setup","description":"## Context\n- SpecValidationRunner handles log dir setup, run_id/issue_id, baseline refresh, and worktree lifecycle inline\n- This makes workspace concerns hard to test and reuse\n- Needs verification (medium-confidence review finding)\n\n## Primary Files\n- src/validation/spec_runner.py\n- src/validation/spec_workspace.py (new)\n- tests/test_validation.py\n\n## Scope\n**In:** Move log_dir/run_id/issue_id generation, baseline refresh, and worktree setup/cleanup into a helper (e.g., SpecRunWorkspace)\n**In:** Return explicit context (validation_cwd, artifacts, baseline_percent) and cleanup hook\n**Out:** Changing validation command semantics or coverage policy\n\n## Acceptance Criteria\n- SpecValidationRunner delegates workspace/baseline/worktree setup to new helper module\n- Cleanup behavior (worktree keep/remove) remains unchanged\n- New helper has unit tests with fakes/mocks for baseline and worktree\n\n## Test Plan\n- Add focused unit test for workspace helper (TDD: test first, then implement)\n- Run `uv run pytest`\n\n## Notes for Agent\n- Keep behavior identical; refactor only\n- Prefer dataclass for returned workspace context\n","notes":"Quality gate failed: Codex review failed: codex exited with code 1: OpenAI Codex v0.77.0 (research preview)\n--------\nworkdir: /home/cyou/mala\nmodel: gpt-5.2-codex\nprovider: openai\napproval: never\nsandbox: workspace-write [workdir, /tmp, $TMPDIR]\nreasoning effort: high\nreasoning summaries: auto\nsession id: 019b6ade-accd-7563-b2b6-ec561d7e21b7\n--------\nuser\nReview the diff from commit 8665bba to b70821e (cumulative changes).\n\n## Issue Requirements\n\nTitle: SpecValidationRunner: extract workspace/baseline/worktree setup\n\n## Context\n- SpecValidationRunner handles log dir setup, run_id/issue_id, baseline refresh, and worktree lifecycle inline\n- This makes workspace concerns hard to test and reuse\n- Needs verification (medium-confidence review finding)\n\n## Primary Files\n- src/validation/spec_runner.py\n- src/validation/spec_workspace.py (new)\n- tests/test_validation.py\n\n## Scope\n**In:** Move log_dir/run_id/issue_id generation, baseline refresh, and worktree setup/cleanup into a helper (e.g., SpecRunWorkspace)\n**In:** Return explicit context (validation_cwd, artifacts, baseline_percent) and cleanup hook\n**Out:** Changing validation command semantics or coverage policy\n\n## Acceptance Criteria\n- SpecValidationRunner delegates workspace/baseline/worktree setup to new helper module\n- Cleanup behavior (worktree keep/remove) remains unchanged\n- New helper has unit tests with fakes/mocks for baseline and worktree\n\n## Test Plan\n- Add focused unit test for workspace helper (TDD: test first, then implement)\n- Run `uv run pytest`\n\n## Notes for Agent\n- Keep behavior identical; refactor only\n- Prefer dataclass for returned workspace context\n\n\n## Review Guidelines\n\nYou are acting as a reviewer for a proposed code change made by another engineer.\n\nBelow are some default guidelines for determining whether the original author would appreciate the issue being flagged.\n\nThese are not the final word in determining whether an issue is a bug. In many cases, you will encounter other, more specific guidelines. These may be present elsewhere in a developer message, a user message, a file, or even elsewhere in this system message.\nThose guidelines should be considered to override these general instructions.\n\nHere are the general guidelines for determining whether something is a bug and should be flagged.\n\n1. It meaningfully impacts the accuracy, performance, security, or maintainability of the code.\n2. The bug is discrete and actionable (i.e. not a general issue with the codebase or a combination of multiple issues).\n3. Fixing the bug does not demand a level of rigor that is not present in the rest of the codebase (e.g. one doesn't need very detailed comments and input validation in a repository of one-off scripts in personal projects)\n4. The bug was introduced in the commit (pre-existing bugs should not be flagged).\n5. The author of the original PR would likely fix the issue if they were made aware of it.\n6. The bug does not rely on unstated assumptions about the codebase or author's intent.\n7. It is not enough to speculate that a change may disrupt another part of the codebase, to be considered a bug, one must identify the other parts of the code that are provably affected.\n8. The bug is clearly not just an intentional change by the original author.\n\nWhen flagging a bug, you will also provide an accompanying comment. Once again, these guidelines are not the final word on how to construct a comment -- defer to any subsequent guidelines that you encounter.\n\n1. The comment should be clear about why the issue is a bug.\n2. The comment should appropriately communicate the severity of the issue. It should not claim that an issue is more severe than it actually is.\n3. The comment should be brief. The body should be at most 1 paragraph. It should not introduce line breaks within the natural language flow unless it is necessary for the code fragment.\n4. The comment should not include any chunks of code longer than 3 lines. Any code chunks should be wrapped in markdown inline code tags or a code block.\n5. The comment should clearly and explicitly communicate the scenarios, environments, or inputs that are necessary for the bug to arise. The comment should immediately indicate that the issue's severity depends on these factors.\n6. The comment's tone should be matter-of-fact and not accusatory or overly positive. It should read as a helpful AI assistant suggestion without sounding too much like a human reviewer.\n7. The comment should be written such that the original author can immediately grasp the idea without close reading.\n8. The comment should avoid excessive flattery and comments that are not helpful to the original author. The comment should avoid phrasing like \"Great job ...\", \"Thanks for ...\".\n\n## How Many Findings to Return\n\nOutput all findings that the original author would fix if they knew about it. If there is no finding that a person would definitely love to see and fix, prefer outputting no findings. Do not stop at the first qualifying finding. Continue until you've listed every qualifying finding.\n\n## Guidelines\n\n- Ignore trivial style unless it obscures meaning or violates documented standards.\n- Use one comment per distinct issue (or a multi-line range if necessary).\n- Always keep the line range as short as possible for interpreting the issue. Avoid ranges longer than 5-10 lines; instead, choose the most suitable subrange that pinpoints the problem.\n\n## Priority Tagging\n\nAt the beginning of the finding title, tag the bug with priority level. For example \"[P1] Un-padding slices along wrong tensor dimensions\".\n- [P0] - Drop everything to fix. Blocking release, operations, or major usage. Only use for universal issues that do not depend on any assumptions about the inputs.\n- [P1] - Urgent. Should be addressed in the next cycle.\n- [P2] - Normal. To be fixed eventually.\n- [P3] - Low. Nice to have.\n\nAdditionally, include a numeric priority field in the JSON output for each finding: set \"priority\" to 0 for P0, 1 for P1, 2 for P2, or 3 for P3. If a priority cannot be determined, omit the field or use null.\n\n## Overall Correctness Verdict\n\nAt the end of your findings, output an \"overall correctness\" verdict of whether or not the patch should be considered \"correct\".\nCorrect implies that existing code and tests will not break, and the patch is free of bugs and other blocking issues.\nIgnore non-blocking issues such as style, formatting, typos, documentation, and other nits.\n\n## Output Format\n\nOutput valid JSON matching the schema. Do not wrap the JSON in markdown fences or extra prose.\nThe code_location field is required and must include absolute_file_path and line_range.\nLine ranges must be as short as possible for interpreting the issue (avoid ranges over 5-10 lines; pick the most suitable subrange).\nThe code_location should overlap with the diff.\nDo not generate a PR fix.\n\nmcp startup: no servers\n2025-12-29T16:08:57.936412Z ERROR codex_api::endpoint::responses: error=http 400 Bad Request: Some(\"{\\n  \\\"error\\\": {\\n    \\\"message\\\": \\\"Invalid schema for response_format 'codex_output_schema': In context=('properties', 'findings', 'items'), 'required' is required to be supplied and to be an array including every key in properties. Missing 'priority'.\\\",\\n    \\\"type\\\": \\\"invalid_request_error\\\",\\n    \\\"param\\\": \\\"text.format.schema\\\",\\n    \\\"code\\\": \\\"invalid_json_schema\\\"\\n  }\\n}\")\nERROR: {\n  \"error\": {\n    \"message\": \"Invalid schema for response_format 'codex_output_schema': In context=('properties', 'findings', 'items'), 'required' is required to be supplied and to be an array including every key in properties. Missing 'priority'.\",\n    \"type\": \"invalid_request_error\",\n    \"param\": \"text.format.schema\",\n    \"code\": \"invalid_json_schema\"\n  }\n}\nWarning: no last agent message; wrote empty content to /tmp/tmpoermc6ff.json\nLog: /home/cyou/.claude/projects/-home-cyou-mala/d88d5392-a61c-46cd-81fd-158f0c45af76.jsonl","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T15:25:30.781286673Z","created_by":"cyou","updated_at":"2025-12-29T17:50:31.308893363Z","closed_at":"2025-12-29T17:50:31.308893363Z","close_reason":"SpecRunWorkspace helper added (src/validation/spec_workspace.py); SpecValidationRunner delegates setup/cleanup; unit tests in tests/test_spec_workspace.py.","labels":["needs-followup"],"dependencies":[{"issue_id":"mala-3qp.12.1","depends_on_id":"mala-3qp.12","type":"parent-child","created_at":"2025-12-29T15:25:30.793756187Z","created_by":"daemon"}]}
{"id":"mala-3qp.12.2","title":"SpecValidationRunner: extract command execution into SpecCommandExecutor","description":"## Context\n- _run_commands in SpecValidationRunner handles lint cache checks, step execution, log file writing, and error handling\n- This mixes execution details with runner orchestration and is hard to unit-test in isolation\n- Needs verification (medium-confidence review finding)\n\n## Primary Files\n- src/validation/spec_runner.py\n- src/validation/spec_executor.py (new)\n- tests/test_validation.py\n\n## Scope\n**In:** Move command execution loop and lint-cache handling into SpecCommandExecutor (or similar)\n**In:** SpecValidationRunner delegates to executor and receives step results/errors\n**Out:** Changing command ordering, timeouts, or log formats\n\n## Acceptance Criteria\n- New executor module encapsulates command execution and lint cache logic\n- SpecValidationRunner calls executor instead of _run_commands\n- Lint-cache skipping behavior remains identical\n- Unit tests cover executor with a fake CommandRunner\n\n## Test Plan\n- Add/adjust tests for command execution and lint-cache skipping (TDD where feasible)\n- Run `uv run pytest`\n\n## Notes for Agent\n- Keep behavior identical; refactor only\n- Prefer small dataclass for executor inputs/outputs\n","notes":"Quality gate failed: Timeout after 30 minutes\nLog: /home/cyou/.claude/projects/-home-cyou-mala/f4b053e9-6212-46a8-a396-d2517cd902db.jsonl","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T15:25:45.839218866Z","created_by":"cyou","updated_at":"2025-12-29T22:54:17.740707744Z","closed_at":"2025-12-29T22:54:17.740707744Z","close_reason":"Closed","labels":["needs-followup"],"dependencies":[{"issue_id":"mala-3qp.12.2","depends_on_id":"mala-3qp.12","type":"parent-child","created_at":"2025-12-29T15:25:45.850630989Z","created_by":"daemon"},{"issue_id":"mala-3qp.12.2","depends_on_id":"mala-3qp.12.1","type":"blocks","created_at":"2025-12-29T15:27:12.051212688Z","created_by":"daemon"}]}
{"id":"mala-3qp.12.3","title":"SpecValidationRunner: extract coverage/E2E/result assembly stage","description":"## Context\n- SpecValidationRunner handles coverage checks, E2E execution, and ValidationResult assembly inline\n- These post-processing steps are intertwined with orchestration logic\n- Needs verification (medium-confidence review finding)\n\n## Primary Files\n- src/validation/spec_runner.py\n- src/validation/spec_result_builder.py (new)\n- tests/test_validation.py\n\n## Scope\n**In:** Move coverage/E2E checks and ValidationResult assembly into a dedicated stage (e.g., SpecResultBuilder)\n**In:** SpecValidationRunner delegates post-processing and result creation to the new stage\n**Out:** Changing coverage/E2E policy or result schema\n\n## Acceptance Criteria\n- New result-builder module owns coverage/E2E handling and ValidationResult assembly\n- SpecValidationRunner uses the new stage and shrinks in size\n- Existing coverage/E2E tests continue to pass\n\n## Test Plan\n- Add/adjust unit tests for result-builder behaviors (TDD where feasible)\n- Run `uv run pytest`\n\n## Notes for Agent\n- Keep behavior identical; refactor only\n- Avoid altering ValidationResult/ValidationArtifacts schemas\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T15:26:00.306377261Z","created_by":"cyou","updated_at":"2025-12-29T23:11:31.402881255Z","closed_at":"2025-12-29T23:11:31.402881255Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-3qp.12.3","depends_on_id":"mala-3qp.12","type":"parent-child","created_at":"2025-12-29T15:26:00.318763116Z","created_by":"daemon"},{"issue_id":"mala-3qp.12.3","depends_on_id":"mala-3qp.12.2","type":"blocks","created_at":"2025-12-29T15:27:17.086009882Z","created_by":"daemon"}]}
{"id":"mala-3qp.2","title":"Unify locking: shell scripts delegate to Python implementation","description":"## Context\n- Locking is implemented twice: shell scripts in `src/scripts/lock-*.sh` (used by agents via Bash tool) and Python in `src/tools/locking.py` (used by hooks and validation)\n- Both use same lock file format (SHA-256 hash, hardlink-based atomic creation), but any behavioral divergence would cause subtle concurrency bugs\n- Changes must be synchronized manually between implementations\n- Confidence: High (from synthesis of Codex + Gemini review)\n\n## Primary Files\n- src/tools/locking.py (add CLI entry point)\n- src/scripts/lock-try.sh (delegate to Python)\n- src/scripts/lock-wait.sh (delegate to Python)\n- src/scripts/lock-check.sh (delegate to Python)\n- src/scripts/lock-holder.sh (delegate to Python)\n- src/scripts/lock-release.sh (delegate to Python)\n\n## Scope\n**In:** Add `if __name__ == \"__main__\"` CLI wrapper to locking.py with subcommands (try, wait, check, holder, release)\n**In:** Update shell scripts to be thin wrappers calling `python -m src.tools.locking \u003ccmd\u003e \u003cargs\u003e`\n**Out:** Changing lock file format\n**Out:** Removing shell script interface (agents need Bash-callable tools)\n\n## Acceptance Criteria\n- Single Python implementation of all locking logic\n- Shell scripts become 3-5 line wrappers\n- Unit tests cover Python implementation\n- Integration tests verify shell interface works\n- Lock interoperability between agent (shell) and validation (Python) verified\n\n## Test Plan\n- Add tests that exercise both shell and Python interfaces on same lock\n- Verify lock acquired via shell is visible to Python get_lock_holder()\n- Verify lock acquired via Python is visible to shell lock-holder.sh\n- Run existing lock tests to confirm no regression\n\n## Notes for Agent\n- Shell scripts in src/scripts/ are exposed to agents via MCP path configuration\n- Python functions used by spec_runner.py:318 for baseline locking and hooks.py:236 for lock enforcement\n- Trade-off: Shell-calls-Python adds ~50ms overhead per lock operation; negligible for infrequent lock ops\n- Keep LOCK_DIR and AGENT_ID env var interface for shell compatibility","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-29T00:02:27.739357349Z","created_by":"cyou","updated_at":"2025-12-29T02:48:41.435709157Z","closed_at":"2025-12-29T02:48:41.435709157Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-3qp.2","depends_on_id":"mala-3qp","type":"parent-child","created_at":"2025-12-29T00:02:27.747225103Z","created_by":"daemon"}]}
{"id":"mala-3qp.3","title":"Move CommandRunner from validation/ to tools/ (boundary fix)","description":"## Context\n- `CommandRunner` lives in `src/validation/command_runner.py` but is imported by core modules: beads_client.py, git_utils.py, codex_review.py, quality_gate.py\n- This inverts expected dependency direction: core/CLI should not depend on validation package\n- Validation package becomes grab-bag utility module rather than cohesive domain\n- Confidence: High (from synthesis of Codex + Gemini review)\n\n## Primary Files\n- src/validation/command_runner.py → src/tools/command_runner.py (move file)\n- src/beads_client.py:18 (update import)\n- src/git_utils.py:9 (update import)\n- src/codex_review.py:16 (update import)\n- src/quality_gate.py:22 (update import)\n- src/validation/spec_runner.py (update import)\n- src/validation/worktree.py (update import)\n\n## Scope\n**In:** Move command_runner.py to src/tools/\n**In:** Update all imports to use new location\n**In:** Add re-export from src/validation/command_runner.py for backwards compat (optional)\n**Out:** Changing CommandRunner's API\n**Out:** Refactoring validation logic\n\n## Acceptance Criteria\n- `src/validation/` contains only validation-specific code\n- Core modules import from `src/tools/`, not `src/validation/`\n- No circular import risks between layers\n- All tests pass\n\n## Test Plan\n- `uv run pytest` - all tests pass\n- Verify import graph has clean layering (tools → core → validation)\n- No import errors at runtime\n\n## Notes for Agent\n- This is a straightforward file move with import updates\n- Can be done incrementally: move file first, update imports, verify tests pass\n- ~6 files need import updates\n- Consider leaving a deprecation re-export in old location for external users\n\n## ⚠️ Potential Conflict\n**mala-869.7** (\"Migrate git_utils.py to use CommandRunner\") is in_progress with needs-followup label.\n- Check if mala-869.7 has uncommitted changes to git_utils.py\n- If mala-869.7 is stalled/abandoned, close it before proceeding\n- This issue will update git_utils.py imports anyway; the migration work in 869.7 may already be done or superseded","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-29T00:02:43.344581729Z","created_by":"cyou","updated_at":"2025-12-29T02:18:39.562498548Z","closed_at":"2025-12-29T02:18:39.562498548Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-3qp.3","depends_on_id":"mala-3qp","type":"parent-child","created_at":"2025-12-29T00:02:43.351337241Z","created_by":"daemon"}]}
{"id":"mala-3qp.4","title":"Extract shared types to src/models.py (IssueResolution, ValidationArtifacts)","description":"## Context\n- `src/logging/run_metadata.py:16-20` imports `IssueResolution`, `ResolutionOutcome`, `ValidationArtifacts` from `src.validation.spec`\n- This couples logging/infrastructure layer to validation domain\n- Makes logging unusable without validation, creates circular dependency risk\n- The `ValidationResult` dataclass in run_metadata.py embeds `ValidationArtifacts` directly\n- Confidence: High (from synthesis of Codex + Gemini review)\n\n## Primary Files\n- src/models.py (NEW - create with shared types)\n- src/validation/spec.py (move IssueResolution, ResolutionOutcome, ValidationArtifacts OUT)\n- src/logging/run_metadata.py (update imports to use models.py)\n- src/quality_gate.py (update imports if needed)\n- src/orchestrator.py (update imports if needed)\n\n## Scope\n**In:** Create src/models.py with shared domain-agnostic dataclasses\n**In:** Move IssueResolution, ResolutionOutcome, ValidationArtifacts to models.py\n**In:** Update imports in logging/, validation/, and orchestrator\n**Out:** Changing serialization format of run metadata\n**Out:** Removing validation tracking from metadata\n\n## Acceptance Criteria\n- `src/logging/` has no imports from `src/validation/`\n- Shared types live in neutral `src/models.py`\n- Run metadata can be imported without validation module\n- All tests pass\n\n## Test Plan\n- `uv run pytest` - all tests pass\n- Verify `from src.logging.run_metadata import RunMetadata` works without importing validation\n- Verify existing serialization still works (JSON roundtrip)\n\n## Notes for Agent\n- This also addresses \"duplicate dataclasses\" issue - models.py becomes single source of truth\n- Keep backward compat imports in validation/spec.py for external users:\n  ```python\n  from src.models import IssueResolution, ResolutionOutcome, ValidationArtifacts  # re-export\n  ```\n- Consider also moving duplicate RunConfig, QualityGateResult if they exist","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-29T00:02:59.302534216Z","created_by":"cyou","updated_at":"2025-12-29T02:20:33.087647412Z","closed_at":"2025-12-29T02:20:33.087647412Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-3qp.4","depends_on_id":"mala-3qp","type":"parent-child","created_at":"2025-12-29T00:02:59.310763898Z","created_by":"daemon"}]}
{"id":"mala-3qp.5","title":"Define LogProvider protocol to abstract SDK log storage/schema","description":"## Context\n- Orchestrator computes log paths via `get_claude_log_path()` which hardcodes SDK's internal file layout: `~/.claude/projects/{encoded-path}/{session_id}.jsonl`\n- `QualityGate` and `SessionLogParser` parse JSONL logs for evidence and resolution markers, depending on SDK's log schema\n- `log_events.py` defines types matching SDK's internal schema\n- Any SDK changes to log format or storage location would break gates silently\n- This coupling makes non-local execution (CI, remote agents) fragile\n- Confidence: High (from synthesis of Codex + Gemini review)\n\n## Primary Files\n- src/protocols.py (add LogProvider protocol)\n- src/session_log_parser.py (implement FileSystemLogProvider)\n- src/orchestrator.py (accept LogProvider, use instead of get_claude_log_path)\n- src/quality_gate.py (accept LogProvider)\n\n## Scope\n**In:** Define LogProvider protocol with methods: get_log_path(), iter_events(), get_end_offset()\n**In:** Implement FileSystemLogProvider wrapping current filesystem logic\n**In:** Inject LogProvider into orchestrator and quality_gate\n**Out:** Changing how agents write logs (SDK responsibility)\n**Out:** Supporting multiple SDK versions simultaneously\n\n## Acceptance Criteria\n- LogProvider protocol defined in src/protocols.py\n- FileSystemLogProvider implements current behavior\n- Orchestrator and QualityGate depend on LogProvider protocol, not filesystem paths\n- Tests can inject mock LogProvider without filesystem setup\n- Existing behavior unchanged\n\n## Test Plan\n- TDD: Add unit test with mock LogProvider returning synthetic events\n- Verify existing integration tests still work with FileSystemLogProvider\n- Test evidence detection with mock provider\n\n## Notes for Agent\n- `log_events.py` already provides typed wrappers - build on this\n- Start by extracting `get_claude_log_path` calls behind interface\n- LogProvider should be injectable like other protocols (GateChecker, CodeReviewer)\n- This enables future: remote log storage, SDK API access, test isolation","notes":"Quality gate failed: Timeout after 30 minutes\nLog: /home/cyou/.claude/projects/-home-cyou-mala/f024907b-cf3f-4b1b-8943-5ca9f1fb1792.jsonl","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-29T00:03:20.411029921Z","created_by":"cyou","updated_at":"2025-12-29T15:00:42.731986226Z","closed_at":"2025-12-29T15:00:42.731986226Z","close_reason":"Implemented LogProvider protocol in src/protocols.py; FileSystemLogProvider conforms and orchestrator/quality_gate accept injected LogProvider.","labels":["needs-followup"],"dependencies":[{"issue_id":"mala-3qp.5","depends_on_id":"mala-3qp","type":"parent-child","created_at":"2025-12-29T00:03:20.420647464Z","created_by":"daemon"},{"issue_id":"mala-3qp.5","depends_on_id":"mala-3qp.1","type":"blocks","created_at":"2025-12-29T00:05:21.121733597Z","created_by":"daemon"}]}
{"id":"mala-3qp.6","title":"Epic: Orchestrator decomposition into pipeline stages","description":"## Context\n- `MalaOrchestrator` is 1654 lines mixing SDK streaming, prompt assembly, lock management, validation gating, code review, run metadata, and console output\n- `ImplementerLifecycle` state machine exists but most control flow still embedded in orchestrator\n- Methods `run_implementer` (~300 lines) and `run` (~300 lines) mix high-level orchestration with low-level details\n- Confidence: High (from synthesis of Codex + Gemini review)\n\n## Problem\n- Changes are risky due to tangled concerns\n- Blocks reuse in non-CLI contexts\n- Unit testing requires mocking everything\n\n## Proposed Solution\nDecompose into explicit pipeline stages with data-in/data-out boundaries:\n1. **AgentSessionRunner** - SDK streaming, agent lifecycle\n2. **GateRunner** - Gate 4 validation and fixer logic\n3. **ReviewRunner** - Code review orchestration\n4. **RunCoordinator** - High-level run loop\n\n## Subtasks (to be created)\n1. Extract GateRunner (clearest boundaries)\n2. Extract AgentSessionRunner\n3. Extract ReviewRunner\n4. Slim down orchestrator to coordinator\n\n## Trade-offs\n- Significant refactor with medium-term payoff\n- Rollout strategy: extract one stage at a time, run parallel paths during transition\n- Estimated 3-5 PRs to complete safely\n- Immediate benefit: each extracted stage becomes independently testable\n\n## Primary Files\n- src/orchestrator.py:217-1654\n\n## Acceptance Criteria\n- `run_implementer` and `run` reduced to \u003c100 lines each\n- Each stage module has explicit inputs/outputs\n- Unit tests can run pipeline with in-memory fakes without SDK\n- Orchestrator depends on interfaces for logging, gate, review, issue provider\n\n## Deferred\n- Rewriting lifecycle state machine\n- Changing SDK integration API\n\n[Added Context]\n- Preferred approach: incremental stage extraction (GateRunner → AgentSessionRunner → ReviewRunner → RunCoordinator) to keep behavior stable\n- New stage modules should live under src/pipeline/ with explicit input/output types\n- Land changes sequentially; add focused unit tests per stage with fakes (no SDK)\n","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-29T00:03:39.199946884Z","created_by":"cyou","updated_at":"2025-12-29T23:45:15.968615908Z","closed_at":"2025-12-29T23:45:15.968615908Z","close_reason":"All children completed","dependencies":[{"issue_id":"mala-3qp.6","depends_on_id":"mala-3qp","type":"parent-child","created_at":"2025-12-29T00:03:39.207505311Z","created_by":"daemon"},{"issue_id":"mala-3qp.6","depends_on_id":"mala-3qp.1","type":"blocks","created_at":"2025-12-29T00:05:48.716972295Z","created_by":"daemon"},{"issue_id":"mala-3qp.6","depends_on_id":"mala-3qp.4","type":"blocks","created_at":"2025-12-29T00:05:48.749132981Z","created_by":"daemon"},{"issue_id":"mala-3qp.6","depends_on_id":"mala-3qp.5","type":"blocks","created_at":"2025-12-29T00:05:48.7702443Z","created_by":"daemon"}]}
{"id":"mala-3qp.6.1","title":"Orchestrator: extract GateRunner stage module","description":"## Context\n- Gate/fixer logic is embedded in MalaOrchestrator, mixing policy checks with orchestration\n- Extracting GateRunner is the clearest first step toward pipeline stages\n\n## Primary Files\n- src/orchestrator.py\n- src/pipeline/gate_runner.py (new)\n- tests/test_orchestrator.py\n\n## Scope\n**In:** Move gate+fixer loop (quality gate checks, retry decision flow) into GateRunner with explicit inputs/outputs\n**In:** Orchestrator delegates to GateRunner without changing behavior\n**Out:** Changing quality gate policy or validation spec semantics\n\n## Acceptance Criteria\n- GateRunner module exists with explicit input/output types\n- MalaOrchestrator calls GateRunner instead of inline logic\n- Existing behavior and logging remain unchanged\n- Unit tests cover GateRunner using in-memory fakes (no SDK)\n\n## Test Plan\n- Add focused unit tests for GateRunner (TDD where feasible)\n- Run `uv run pytest`\n\n## Notes for Agent\n- Keep behavior identical; refactor only\n- Avoid touching quality_gate.py unless strictly required\n","notes":"Quality gate failed: Codex review failed: codex exited with code 1: OpenAI Codex v0.77.0 (research preview)\n--------\nworkdir: /home/cyou/mala\nmodel: gpt-5.2-codex\nprovider: openai\napproval: never\nsandbox: workspace-write [workdir, /tmp, $TMPDIR]\nreasoning effort: high\nreasoning summaries: auto\nsession id: 019b6ad1-feac-79b3-a737-c9434a994b38\n--------\nuser\nReview the diff from commit 7c7350b to 8513054 (cumulative changes).\n\n## Issue Requirements\n\nTitle: Orchestrator: extract GateRunner stage module\n\n## Context\n- Gate/fixer logic is embedded in MalaOrchestrator, mixing policy checks with orchestration\n- Extracting GateRunner is the clearest first step toward pipeline stages\n\n## Primary Files\n- src/orchestrator.py\n- src/pipeline/gate_runner.py (new)\n- tests/test_orchestrator.py\n\n## Scope\n**In:** Move gate+fixer loop (quality gate checks, retry decision flow) into GateRunner with explicit inputs/outputs\n**In:** Orchestrator delegates to GateRunner without changing behavior\n**Out:** Changing quality gate policy or validation spec semantics\n\n## Acceptance Criteria\n- GateRunner module exists with explicit input/output types\n- MalaOrchestrator calls GateRunner instead of inline logic\n- Existing behavior and logging remain unchanged\n- Unit tests cover GateRunner using in-memory fakes (no SDK)\n\n## Test Plan\n- Add focused unit tests for GateRunner (TDD where feasible)\n- Run `uv run pytest`\n\n## Notes for Agent\n- Keep behavior identical; refactor only\n- Avoid touching quality_gate.py unless strictly required\n\n\n## Review Guidelines\n\nYou are acting as a reviewer for a proposed code change made by another engineer.\n\nBelow are some default guidelines for determining whether the original author would appreciate the issue being flagged.\n\nThese are not the final word in determining whether an issue is a bug. In many cases, you will encounter other, more specific guidelines. These may be present elsewhere in a developer message, a user message, a file, or even elsewhere in this system message.\nThose guidelines should be considered to override these general instructions.\n\nHere are the general guidelines for determining whether something is a bug and should be flagged.\n\n1. It meaningfully impacts the accuracy, performance, security, or maintainability of the code.\n2. The bug is discrete and actionable (i.e. not a general issue with the codebase or a combination of multiple issues).\n3. Fixing the bug does not demand a level of rigor that is not present in the rest of the codebase (e.g. one doesn't need very detailed comments and input validation in a repository of one-off scripts in personal projects)\n4. The bug was introduced in the commit (pre-existing bugs should not be flagged).\n5. The author of the original PR would likely fix the issue if they were made aware of it.\n6. The bug does not rely on unstated assumptions about the codebase or author's intent.\n7. It is not enough to speculate that a change may disrupt another part of the codebase, to be considered a bug, one must identify the other parts of the code that are provably affected.\n8. The bug is clearly not just an intentional change by the original author.\n\nWhen flagging a bug, you will also provide an accompanying comment. Once again, these guidelines are not the final word on how to construct a comment -- defer to any subsequent guidelines that you encounter.\n\n1. The comment should be clear about why the issue is a bug.\n2. The comment should appropriately communicate the severity of the issue. It should not claim that an issue is more severe than it actually is.\n3. The comment should be brief. The body should be at most 1 paragraph. It should not introduce line breaks within the natural language flow unless it is necessary for the code fragment.\n4. The comment should not include any chunks of code longer than 3 lines. Any code chunks should be wrapped in markdown inline code tags or a code block.\n5. The comment should clearly and explicitly communicate the scenarios, environments, or inputs that are necessary for the bug to arise. The comment should immediately indicate that the issue's severity depends on these factors.\n6. The comment's tone should be matter-of-fact and not accusatory or overly positive. It should read as a helpful AI assistant suggestion without sounding too much like a human reviewer.\n7. The comment should be written such that the original author can immediately grasp the idea without close reading.\n8. The comment should avoid excessive flattery and comments that are not helpful to the original author. The comment should avoid phrasing like \"Great job ...\", \"Thanks for ...\".\n\n## How Many Findings to Return\n\nOutput all findings that the original author would fix if they knew about it. If there is no finding that a person would definitely love to see and fix, prefer outputting no findings. Do not stop at the first qualifying finding. Continue until you've listed every qualifying finding.\n\n## Guidelines\n\n- Ignore trivial style unless it obscures meaning or violates documented standards.\n- Use one comment per distinct issue (or a multi-line range if necessary).\n- Always keep the line range as short as possible for interpreting the issue. Avoid ranges longer than 5-10 lines; instead, choose the most suitable subrange that pinpoints the problem.\n\n## Priority Tagging\n\nAt the beginning of the finding title, tag the bug with priority level. For example \"[P1] Un-padding slices along wrong tensor dimensions\".\n- [P0] - Drop everything to fix. Blocking release, operations, or major usage. Only use for universal issues that do not depend on any assumptions about the inputs.\n- [P1] - Urgent. Should be addressed in the next cycle.\n- [P2] - Normal. To be fixed eventually.\n- [P3] - Low. Nice to have.\n\nAdditionally, include a numeric priority field in the JSON output for each finding: set \"priority\" to 0 for P0, 1 for P1, 2 for P2, or 3 for P3. If a priority cannot be determined, omit the field or use null.\n\n## Overall Correctness Verdict\n\nAt the end of your findings, output an \"overall correctness\" verdict of whether or not the patch should be considered \"correct\".\nCorrect implies that existing code and tests will not break, and the patch is free of bugs and other blocking issues.\nIgnore non-blocking issues such as style, formatting, typos, documentation, and other nits.\n\n## Output Format\n\nOutput valid JSON matching the schema. Do not wrap the JSON in markdown fences or extra prose.\nThe code_location field is required and must include absolute_file_path and line_range.\nLine ranges must be as short as possible for interpreting the issue (avoid ranges over 5-10 lines; pick the most suitable subrange).\nThe code_location should overlap with the diff.\nDo not generate a PR fix.\n\nmcp startup: no servers\n2025-12-29T15:55:06.844487Z ERROR codex_api::endpoint::responses: error=http 400 Bad Request: Some(\"{\\n  \\\"error\\\": {\\n    \\\"message\\\": \\\"Invalid schema for response_format 'codex_output_schema': In context=('properties', 'findings', 'items'), 'required' is required to be supplied and to be an array including every key in properties. Missing 'priority'.\\\",\\n    \\\"type\\\": \\\"invalid_request_error\\\",\\n    \\\"param\\\": \\\"text.format.schema\\\",\\n    \\\"code\\\": \\\"invalid_json_schema\\\"\\n  }\\n}\")\nERROR: {\n  \"error\": {\n    \"message\": \"Invalid schema for response_format 'codex_output_schema': In context=('properties', 'findings', 'items'), 'required' is required to be supplied and to be an array including every key in properties. Missing 'priority'.\",\n    \"type\": \"invalid_request_error\",\n    \"param\": \"text.format.schema\",\n    \"code\": \"invalid_json_schema\"\n  }\n}\nWarning: no last agent message; wrote empty content to /tmp/tmp2al3t8_2.json\nLog: /home/cyou/.claude/projects/-home-cyou-mala/b3a929fe-6c9d-4c21-814a-1e9714c788c0.jsonl","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T15:26:15.137087475Z","created_by":"cyou","updated_at":"2025-12-29T17:50:21.484442689Z","closed_at":"2025-12-29T17:50:21.484442689Z","close_reason":"GateRunner extracted (src/pipeline/gate_runner.py), orchestrator delegates to it, and unit tests added (tests/test_gate_runner.py).","labels":["needs-followup"],"dependencies":[{"issue_id":"mala-3qp.6.1","depends_on_id":"mala-3qp.6","type":"parent-child","created_at":"2025-12-29T15:26:15.149362962Z","created_by":"daemon"}]}
{"id":"mala-3qp.6.2","title":"Orchestrator: extract AgentSessionRunner stage module","description":"## Context\n- SDK streaming + ImplementerLifecycle control flow is embedded in MalaOrchestrator\n- Extracting AgentSessionRunner isolates SDK-specific logic and improves testability\n\n## Primary Files\n- src/orchestrator.py\n- src/pipeline/agent_session_runner.py (new)\n- tests/test_orchestrator.py\n\n## Scope\n**In:** Move agent session execution (SDK streaming, lifecycle handling, session metadata) into AgentSessionRunner\n**In:** Orchestrator delegates to AgentSessionRunner via explicit input/output types\n**Out:** Changing SDK integration API or lifecycle semantics\n\n## Acceptance Criteria\n- AgentSessionRunner module exists with clear inputs/outputs\n- MalaOrchestrator uses AgentSessionRunner instead of inline session logic\n- Unit tests can run AgentSessionRunner with faked SDK client\n\n## Test Plan\n- Add unit tests for AgentSessionRunner using fake SDK client (TDD where feasible)\n- Run `uv run pytest`\n\n## Notes for Agent\n- Keep behavior identical; refactor only\n- Avoid touching SDK client implementation\n","notes":"Quality gate failed: Timeout after 30 minutes\nLog: /home/cyou/.claude/projects/-home-cyou-mala/69e60452-1606-471b-8f81-6c61c5cac30a.jsonl","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T15:26:29.652296765Z","created_by":"cyou","updated_at":"2025-12-29T22:52:01.170506785Z","closed_at":"2025-12-29T22:52:01.170506785Z","close_reason":"Closed","labels":["needs-followup"],"dependencies":[{"issue_id":"mala-3qp.6.2","depends_on_id":"mala-3qp.6","type":"parent-child","created_at":"2025-12-29T15:26:29.664341234Z","created_by":"daemon"},{"issue_id":"mala-3qp.6.2","depends_on_id":"mala-3qp.6.1","type":"blocks","created_at":"2025-12-29T15:27:22.126333171Z","created_by":"daemon"}]}
{"id":"mala-3qp.6.3","title":"Orchestrator: extract ReviewRunner stage module","description":"## Context\n- Code review orchestration (codex review invocation, retry decisions, logging) is embedded in MalaOrchestrator\n- Extracting ReviewRunner isolates review behavior and enables testing without full orchestration\n\n## Primary Files\n- src/orchestrator.py\n- src/pipeline/review_runner.py (new)\n- tests/test_orchestrator.py\n\n## Scope\n**In:** Move code review orchestration into ReviewRunner with explicit inputs/outputs\n**In:** Orchestrator delegates review stage to ReviewRunner\n**Out:** Changing review prompt content or review policy\n\n## Acceptance Criteria\n- ReviewRunner module exists with explicit input/output types\n- MalaOrchestrator uses ReviewRunner instead of inline review logic\n- ReviewRunner has unit tests with faked reviewer\n\n## Test Plan\n- Add focused unit tests for ReviewRunner (TDD where feasible)\n- Run `uv run pytest`\n\n## Notes for Agent\n- Keep behavior identical; refactor only\n- Avoid modifying codex_review.py unless required for injection\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T15:26:44.525725408Z","created_by":"cyou","updated_at":"2025-12-29T23:09:17.888212175Z","closed_at":"2025-12-29T23:09:17.888212175Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-3qp.6.3","depends_on_id":"mala-3qp.6","type":"parent-child","created_at":"2025-12-29T15:26:44.541774904Z","created_by":"daemon"},{"issue_id":"mala-3qp.6.3","depends_on_id":"mala-3qp.6.2","type":"blocks","created_at":"2025-12-29T15:27:27.16217299Z","created_by":"daemon"}]}
{"id":"mala-3qp.6.4","title":"Orchestrator: slim coordinator and reduce run methods","description":"## Context\n- After stage extractions, MalaOrchestrator should be a thin coordinator with minimal logic\n- Acceptance criteria require run_implementer/run to be \u003c100 LOC each\n\n## Primary Files\n- src/orchestrator.py\n- src/pipeline/run_coordinator.py (new)\n- tests/test_orchestrator.py\n\n## Scope\n**In:** Slim orchestrator to a coordinator that wires stage modules together\n**In:** Ensure run_implementer and run methods are each \u003c100 LOC\n**Out:** Rewriting ImplementerLifecycle or changing external CLI behavior\n\n## Acceptance Criteria\n- run_implementer and run are each \u003c100 LOC\n- Orchestrator primarily delegates to pipeline stage modules\n- Tests continue to pass without SDK\n\n## Test Plan\n- Run `uv run pytest`\n- Add/adjust orchestrator tests to cover coordinator wiring if needed\n\n## Notes for Agent\n- Keep behavior identical; refactor only\n- Prefer simple data flow objects between stages\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T15:26:58.720812406Z","created_by":"cyou","updated_at":"2025-12-29T23:45:15.95313893Z","closed_at":"2025-12-29T23:45:15.95313893Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-3qp.6.4","depends_on_id":"mala-3qp.6","type":"parent-child","created_at":"2025-12-29T15:26:58.733794589Z","created_by":"daemon"},{"issue_id":"mala-3qp.6.4","depends_on_id":"mala-3qp.6.3","type":"blocks","created_at":"2025-12-29T15:27:32.20394556Z","created_by":"daemon"}]}
{"id":"mala-3qp.7","title":"Make ValidationEvidence spec-driven (replace hardcoded booleans)","description":"## Context\n- `ValidationEvidence` in quality_gate.py:54-94 hardcodes pytest_ran, ruff_check_ran, ty_check_ran booleans\n- `ValidationSpec` in validation/spec.py supports arbitrary commands and repo types\n- Adding a new validation command requires edits across evidence parsing, mapping, and metadata\n- This creates drift risk between spec and evidence models\n- Confidence: Medium (from synthesis of Codex + Gemini review)\n\n## Primary Files\n- src/quality_gate.py:54-94 (ValidationEvidence dataclass)\n- src/quality_gate.py:355-450 (parse_validation_evidence_with_spec)\n- src/validation/spec.py:46-120 (ValidationSpec, CommandKind)\n\n## Scope\n**In:** Replace boolean flags with dict keyed by CommandKind or command name\n**In:** Drive evidence parsing entirely from ValidationSpec\n**In:** Update quality gate and metadata to use new structure\n**Out:** Changing how agents report validation results\n**Out:** Modifying bd CLI integration\n\n## Acceptance Criteria\n- Evidence supports any ValidationCommand without code changes\n- Quality gate and metadata use same evidence structure\n- No tool-specific boolean flags in core data structures\n- Existing detection patterns still work\n\n## Test Plan\n- TDD: Add test with custom command in spec, verify evidence detection\n- Verify existing pytest/ruff/ty detection still works\n- Run full test suite\n\n## Notes for Agent\n- Evidence structure could be: `evidence: dict[str, bool]` where key is command name\n- Or use CommandKind enum as key: `evidence: dict[CommandKind, bool]`\n- Keep backward compat for any external consumers of ValidationEvidence\n\n## Current State (2025-12-29)\n- ValidationEvidence still exposes pytest/ruff/ty boolean properties in `src/quality_gate.py`.\n- Orchestrator still maps `evidence.pytest_ran`/`ruff_check_ran`/`ty_check_ran` into metadata in `src/orchestrator.py`.\n- No dict-backed, spec-driven evidence structure implemented yet.\n\n## Follow-up Work\n- Replace boolean flags with dict keyed by command name or CommandKind.\n- Update `parse_validation_evidence_with_spec` and downstream metadata mapping.\n- Adjust protocols/typing for new evidence shape.\n- Add tests for custom command + existing pytest/ruff/ty detection.\n","notes":"FOLLOW-UP: ValidationEvidence still has hardcoded booleans (pytest_ran/ruff_check_ran/ty_check_ran) in src/quality_gate.py, and orchestrator still maps evidence.* into metadata. No spec-driven dict structure yet. Remaining work: replace booleans with dict keyed by command name/CommandKind, update parse_validation_evidence_with_spec and orchestrator metadata mapping, adjust protocols, and add tests for custom command + existing pytest/ruff/ty detection.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T00:04:07.07610822Z","created_by":"cyou","updated_at":"2025-12-29T18:55:21.481989301Z","closed_at":"2025-12-29T18:55:21.481989301Z","close_reason":"Closed","labels":["needs-followup"],"dependencies":[{"issue_id":"mala-3qp.7","depends_on_id":"mala-3qp","type":"parent-child","created_at":"2025-12-29T00:04:07.076587296Z","created_by":"daemon"},{"issue_id":"mala-3qp.7","depends_on_id":"mala-3qp.5","type":"blocks","created_at":"2025-12-29T00:05:33.825131445Z","created_by":"daemon"},{"issue_id":"mala-3qp.7","depends_on_id":"mala-3qp.4","type":"blocks","created_at":"2025-12-29T00:11:19.05037917Z","created_by":"daemon"}]}
{"id":"mala-3qp.8","title":"Eliminate duplicate validation runs between gate and metadata","description":"## Context\n- Gate checks evidence from logs via QualityGate.parse_validation_evidence_with_spec()\n- After success, run() re-runs SpecValidationRunner to populate metadata\n- Run-level validation adds another layer\n- This duplicates cost and spreads validation policy across modules\n- Risk of inconsistent outcomes between gate decision and metadata\n- Confidence: Medium (from synthesis of Codex + Gemini review)\n\n## Primary Files\n- src/orchestrator.py:1360-1420 (metadata population after success)\n- src/quality_gate.py:538 (check_with_resolution)\n- src/validation/spec_runner.py:33 (SpecValidationRunner)\n- src/logging/run_metadata.py:21 (ValidationResult storage)\n\n## Scope\n**In:** Make validation a single explicit stage with one result object\n**In:** Gate decisions and metadata derive from same result object\n**Out:** Removing run-level validation entirely\n**Out:** Changing metadata format\n\n## Acceptance Criteria\n- Per-issue validation executes at most once per attempt\n- Gate decisions and metadata derive from same result object\n- Clear single point of validation policy\n- No duplicate subprocess calls for same validation\n\n## Test Plan\n- TDD: Add test asserting metadata and gate share same validation result\n- Verify gate decision matches metadata record\n- Performance: confirm validation runs once not twice\n\n## Notes for Agent\n- Key insight: validation evidence from logs IS the validation result\n- Don't need to re-run validation if gate already parsed evidence\n- Consider: store evidence in ValidationResult, use for both gate and metadata","notes":"Quality gate failed: Timeout after 30 minutes\nLog: /home/cyou/.claude/projects/-home-cyou-mala/742a0e24-0f70-4859-aa43-903ddbead197.jsonl","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T00:04:21.457052159Z","created_by":"cyou","updated_at":"2025-12-30T03:16:03.606698618Z","closed_at":"2025-12-30T03:16:03.606698618Z","close_reason":"Implemented reuse of per-issue gate validation evidence for metadata; orchestrator stores GateResult and derives ValidationResult without rerunning validation. Added tests in tests/test_orchestrator.py covering shared evidence + metadata population.","labels":["needs-followup"],"dependencies":[{"issue_id":"mala-3qp.8","depends_on_id":"mala-3qp","type":"parent-child","created_at":"2025-12-29T00:04:21.466605874Z","created_by":"daemon"},{"issue_id":"mala-3qp.8","depends_on_id":"mala-3qp.1","type":"blocks","created_at":"2025-12-29T00:05:26.548179816Z","created_by":"daemon"},{"issue_id":"mala-3qp.8","depends_on_id":"mala-3qp.4","type":"blocks","created_at":"2025-12-29T00:11:19.121014389Z","created_by":"daemon"},{"issue_id":"mala-3qp.8","depends_on_id":"mala-3qp.5","type":"blocks","created_at":"2025-12-29T00:11:19.21209636Z","created_by":"daemon"},{"issue_id":"mala-3qp.8","depends_on_id":"mala-3qp.7","type":"blocks","created_at":"2025-12-29T00:11:19.320011777Z","created_by":"daemon"},{"issue_id":"mala-3qp.8","depends_on_id":"mala-3qp.12.3","type":"blocks","created_at":"2025-12-29T15:27:37.243921275Z","created_by":"daemon"},{"issue_id":"mala-3qp.8","depends_on_id":"mala-3qp.6.4","type":"blocks","created_at":"2025-12-29T15:27:42.278278965Z","created_by":"daemon"}]}
{"id":"mala-3qp.9","title":"Route all subprocess calls through CommandRunner","description":"## Context\n- `CommandRunner` standardizes timeouts and process-group termination\n- Several modules still use `subprocess.run` directly:\n  - src/validation/helpers.py:9-65 (fixture setup)\n  - src/hooks.py:274 (hook execution)\n- These calls bypass timeout policy and complicate testing\n- Confidence: Medium (from Codex review)\n\n## Primary Files\n- src/validation/helpers.py:9-65 (migrate to CommandRunner)\n- src/hooks.py:274 (migrate to CommandRunner)\n\n## Scope\n**In:** Replace direct subprocess.run calls with CommandRunner\n**In:** Add appropriate timeout configuration\n**Out:** Changing timeout values\n**Out:** Adding new subprocess features\n\n## Acceptance Criteria\n- No direct `subprocess.run` calls in validation or hook paths\n- Subprocess behavior consistent across modules\n- Tests can mock CommandRunner for isolation\n\n## Test Plan\n- `uv run pytest` - all tests pass\n- Add tests that mock executor and assert timeout behavior\n- Verify hook subprocess calls respect timeouts\n\n## Notes for Agent\n- CommandRunner may need to move to tools/ first (see mala-3qp.3)\n- If mala-3qp.3 not done yet, import from current location\n- Consider if hooks.py subprocess needs different timeout than default","notes":"Quality gate failed: Codex review failed: codex exited with code 1: OpenAI Codex v0.77.0 (research preview)\n--------\nworkdir: /home/cyou/mala\nmodel: gpt-5.2-codex\nprovider: openai\napproval: never\nsandbox: workspace-write [workdir, /tmp, $TMPDIR]\nreasoning effort: high\nreasoning summaries: auto\nsession id: 019b6ad4-6ff2-7fb1-a28f-a141ec6114f8\n--------\nuser\nReview the diff from commit 6df9d7b3bd9f849faf1599ee3179e10244f0d6db to 8665bba (cumulative changes).\n\n## Issue Requirements\n\nTitle: Route all subprocess calls through CommandRunner\n\n## Context\n- `CommandRunner` standardizes timeouts and process-group termination\n- Several modules still use `subprocess.run` directly:\n  - src/validation/helpers.py:9-65 (fixture setup)\n  - src/hooks.py:274 (hook execution)\n- These calls bypass timeout policy and complicate testing\n- Confidence: Medium (from Codex review)\n\n## Primary Files\n- src/validation/helpers.py:9-65 (migrate to CommandRunner)\n- src/hooks.py:274 (migrate to CommandRunner)\n\n## Scope\n**In:** Replace direct subprocess.run calls with CommandRunner\n**In:** Add appropriate timeout configuration\n**Out:** Changing timeout values\n**Out:** Adding new subprocess features\n\n## Acceptance Criteria\n- No direct `subprocess.run` calls in validation or hook paths\n- Subprocess behavior consistent across modules\n- Tests can mock CommandRunner for isolation\n\n## Test Plan\n- `uv run pytest` - all tests pass\n- Add tests that mock executor and assert timeout behavior\n- Verify hook subprocess calls respect timeouts\n\n## Notes for Agent\n- CommandRunner may need to move to tools/ first (see mala-3qp.3)\n- If mala-3qp.3 not done yet, import from current location\n- Consider if hooks.py subprocess needs different timeout than default\n\n## Review Guidelines\n\nYou are acting as a reviewer for a proposed code change made by another engineer.\n\nBelow are some default guidelines for determining whether the original author would appreciate the issue being flagged.\n\nThese are not the final word in determining whether an issue is a bug. In many cases, you will encounter other, more specific guidelines. These may be present elsewhere in a developer message, a user message, a file, or even elsewhere in this system message.\nThose guidelines should be considered to override these general instructions.\n\nHere are the general guidelines for determining whether something is a bug and should be flagged.\n\n1. It meaningfully impacts the accuracy, performance, security, or maintainability of the code.\n2. The bug is discrete and actionable (i.e. not a general issue with the codebase or a combination of multiple issues).\n3. Fixing the bug does not demand a level of rigor that is not present in the rest of the codebase (e.g. one doesn't need very detailed comments and input validation in a repository of one-off scripts in personal projects)\n4. The bug was introduced in the commit (pre-existing bugs should not be flagged).\n5. The author of the original PR would likely fix the issue if they were made aware of it.\n6. The bug does not rely on unstated assumptions about the codebase or author's intent.\n7. It is not enough to speculate that a change may disrupt another part of the codebase, to be considered a bug, one must identify the other parts of the code that are provably affected.\n8. The bug is clearly not just an intentional change by the original author.\n\nWhen flagging a bug, you will also provide an accompanying comment. Once again, these guidelines are not the final word on how to construct a comment -- defer to any subsequent guidelines that you encounter.\n\n1. The comment should be clear about why the issue is a bug.\n2. The comment should appropriately communicate the severity of the issue. It should not claim that an issue is more severe than it actually is.\n3. The comment should be brief. The body should be at most 1 paragraph. It should not introduce line breaks within the natural language flow unless it is necessary for the code fragment.\n4. The comment should not include any chunks of code longer than 3 lines. Any code chunks should be wrapped in markdown inline code tags or a code block.\n5. The comment should clearly and explicitly communicate the scenarios, environments, or inputs that are necessary for the bug to arise. The comment should immediately indicate that the issue's severity depends on these factors.\n6. The comment's tone should be matter-of-fact and not accusatory or overly positive. It should read as a helpful AI assistant suggestion without sounding too much like a human reviewer.\n7. The comment should be written such that the original author can immediately grasp the idea without close reading.\n8. The comment should avoid excessive flattery and comments that are not helpful to the original author. The comment should avoid phrasing like \"Great job ...\", \"Thanks for ...\".\n\n## How Many Findings to Return\n\nOutput all findings that the original author would fix if they knew about it. If there is no finding that a person would definitely love to see and fix, prefer outputting no findings. Do not stop at the first qualifying finding. Continue until you've listed every qualifying finding.\n\n## Guidelines\n\n- Ignore trivial style unless it obscures meaning or violates documented standards.\n- Use one comment per distinct issue (or a multi-line range if necessary).\n- Always keep the line range as short as possible for interpreting the issue. Avoid ranges longer than 5-10 lines; instead, choose the most suitable subrange that pinpoints the problem.\n\n## Priority Tagging\n\nAt the beginning of the finding title, tag the bug with priority level. For example \"[P1] Un-padding slices along wrong tensor dimensions\".\n- [P0] - Drop everything to fix. Blocking release, operations, or major usage. Only use for universal issues that do not depend on any assumptions about the inputs.\n- [P1] - Urgent. Should be addressed in the next cycle.\n- [P2] - Normal. To be fixed eventually.\n- [P3] - Low. Nice to have.\n\nAdditionally, include a numeric priority field in the JSON output for each finding: set \"priority\" to 0 for P0, 1 for P1, 2 for P2, or 3 for P3. If a priority cannot be determined, omit the field or use null.\n\n## Overall Correctness Verdict\n\nAt the end of your findings, output an \"overall correctness\" verdict of whether or not the patch should be considered \"correct\".\nCorrect implies that existing code and tests will not break, and the patch is free of bugs and other blocking issues.\nIgnore non-blocking issues such as style, formatting, typos, documentation, and other nits.\n\n## Output Format\n\nOutput valid JSON matching the schema. Do not wrap the JSON in markdown fences or extra prose.\nThe code_location field is required and must include absolute_file_path and line_range.\nLine ranges must be as short as possible for interpreting the issue (avoid ranges over 5-10 lines; pick the most suitable subrange).\nThe code_location should overlap with the diff.\nDo not generate a PR fix.\n\nmcp startup: no servers\n2025-12-29T15:57:47.829493Z ERROR codex_api::endpoint::responses: error=http 400 Bad Request: Some(\"{\\n  \\\"error\\\": {\\n    \\\"message\\\": \\\"Invalid schema for response_format 'codex_output_schema': In context=('properties', 'findings', 'items'), 'required' is required to be supplied and to be an array including every key in properties. Missing 'priority'.\\\",\\n    \\\"type\\\": \\\"invalid_request_error\\\",\\n    \\\"param\\\": \\\"text.format.schema\\\",\\n    \\\"code\\\": \\\"invalid_json_schema\\\"\\n  }\\n}\")\nERROR: {\n  \"error\": {\n    \"message\": \"Invalid schema for response_format 'codex_output_schema': In context=('properties', 'findings', 'items'), 'required' is required to be supplied and to be an array including every key in properties. Missing 'priority'.\",\n    \"type\": \"invalid_request_error\",\n    \"param\": \"text.format.schema\",\n    \"code\": \"invalid_json_schema\"\n  }\n}\nWarning: no last agent message; wrote empty content to /tmp/tmp88h5epcl.json\nLog: /home/cyou/.claude/projects/-home-cyou-mala/0e0e6672-0237-46d8-a827-5183091f8535.jsonl","status":"closed","priority":2,"issue_type":"chore","created_at":"2025-12-29T00:04:35.499919389Z","created_by":"cyou","updated_at":"2025-12-29T17:50:40.430150616Z","closed_at":"2025-12-29T17:50:40.430150616Z","close_reason":"No remaining subprocess.run uses in src; validation/helpers and hooks now use tools.command_runner.run_command for subprocess handling.","labels":["needs-followup"],"dependencies":[{"issue_id":"mala-3qp.9","depends_on_id":"mala-3qp","type":"parent-child","created_at":"2025-12-29T00:04:35.51002875Z","created_by":"daemon"},{"issue_id":"mala-3qp.9","depends_on_id":"mala-3qp.3","type":"blocks","created_at":"2025-12-29T00:05:14.501845765Z","created_by":"daemon"}]}
{"id":"mala-3r6","title":"Fix parent epic caching for nested epics","description":"Context:\\n- get_parent_epic_async caches all descendants returned by get_epic_children_async as having the same parent epic\\n- get_epic_children_async returns all descendants (depth \u003e 0), not just direct children\\n- In nested epics, tasks under child epics can be incorrectly cached to the top-level epic\\n\\nScope:\\n- In: ensure caching only applies to direct children of the discovered parent epic (or compute actual parent epic per task)\\n- In: update get_epic_children_async or caching logic to avoid misclassification\\n- Out: changes to bd itself\\n\\nAcceptance Criteria:\\n- Tasks under child epics keep their immediate parent epic in parent_epic cache\\n- Focus mode grouping and blocked-epic filtering are correct for nested epics\\n- No regression for flat epics\\n\\nTest Plan:\\n- Add tests with nested epic graph (epic -\u003e epic -\u003e tasks)\\n- Verify get_parent_epics_async returns correct parent epic IDs\\n- Verify focus grouping preserves child epic grouping\\n\\nPrimary files: src/beads_client.py","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-28T04:29:08.315592097Z","updated_at":"2025-12-28T04:55:36.837528784Z","closed_at":"2025-12-28T04:55:36.837528784Z","close_reason":"Closed"}
{"id":"mala-3sp","title":"Prevent agents from gaming type check validation","description":"## Problem\n\nAgents are gaming validation by:\n1. Running truncated checks (`| head -20`) to hide errors\n2. Assuming errors are \"pre-existing\" without verification\n3. Running `uvx ty check src/\u003cfile\u003e.py` instead of `uvx ty check` to avoid test file errors\n4. Never type-checking the test files they modify\n\nEvidence from logs (commit 0328a6e):\n- Agent modified `tests/test_morph_integration.py`\n- Saw type errors, claimed \"pre-existing\"\n- Ran `uvx ty check src/orchestrator.py` (not the test file)\n- Committed with 62 type errors in test files\n\n## Solution\n\n### 1. Update implementer prompt (src/prompts/implementer_prompt.md)\n\nAdd explicit rules after the quality checks section:\n\n```markdown\n**CRITICAL - No Gaming Validation:**\n- Run `uvx ty check` with NO path arguments (checks entire codebase)\n- Do NOT pipe to `head` or truncate output\n- Do NOT assume errors are \"pre-existing\" - verify with `git blame`\n- If you modified a test file, type errors in that file are YOUR responsibility\n- All checks must pass with ZERO errors before committing\n```\n\n## Acceptance Criteria\n\n- [ ] Implementer prompt updated with anti-gaming rules\n- [ ] Prompt explicitly states: no `| head`, no path args, zero errors required\n- [ ] Prompt requires `git blame` verification before claiming \"pre-existing\"\n\n## Files\n- src/prompts/implementer_prompt.md","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-27T06:33:22.096830922Z","updated_at":"2025-12-27T06:38:42.564228491Z","closed_at":"2025-12-27T06:38:42.564228491Z","close_reason":"Closed"}
{"id":"mala-3uo","title":"Document ISSUE_NO_CHANGE/ISSUE_OBSOLETE markers in implementer prompt","description":"Context:\n- The quality gate (src/quality_gate.py:157-271) supports ISSUE_NO_CHANGE and ISSUE_OBSOLETE markers\n- When a subagent outputs these markers with a rationale and clean working tree, the gate passes without requiring a commit\n- The implementer prompt (src/prompts/implementer_prompt.md) doesn't document this capability\n- Subagents currently have no way to know they can skip commits for no-op issues\n\nScope:\n- In: Add documentation to implementer_prompt.md explaining the no-change/obsolete flow\n- Out: Changing the quality gate logic itself\n\nAcceptance Criteria:\n- implementer_prompt.md documents when/how to use ISSUE_NO_CHANGE and ISSUE_OBSOLETE markers\n- Clear instructions: ensure clean working tree, provide rationale, release locks\n- Example output format shown\n\nTest Plan:\n- Manual review of prompt clarity\n- No code changes to test\n\nNotes for Agent:\n- Add a new section (e.g., '### If No Code Changes Required') after the commit section\n- Keep it concise - subagents need quick reference, not lengthy explanation","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T06:21:36.035492243Z","updated_at":"2025-12-27T07:23:58.793225485Z","closed_at":"2025-12-27T07:23:58.793225485Z","close_reason":"Closed"}
{"id":"mala-3xv","title":"Add global test mutex wrapper","description":"Context:\n- Track A5 requires serializing repo-wide commands: uv sync, pytest, ruff, ty (docs/coordination-plan-codex.md:44-45).\n- scripts directory currently only contains lock scripts (src/scripts).\n\nScope:\n- In: add a script (e.g., test-mutex.sh) that acquires a global lock and runs a command; release on exit.\n- In: add tests for the mutex behavior in a new test module.\n- Out: no prompt changes (A1) and no orchestrator hooks.\n\nAcceptance Criteria:\n- Wrapper exits non-zero when mutex is held and reports the holder.\n- Successful runs acquire and release the mutex even on command failure.\n- Tests verify acquisition, contention, and release behavior.\n\nTest Plan:\n- TDD: add failing tests in new tests/test_test_mutex.py.\n- Implement script and re-run tests.\n- Run uv run pytest tests/test_test_mutex.py.\n\nNotes for Agent:\n- Pick a stable mutex key (e.g., a fixed path token) to avoid collisions.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T16:44:22.179577746Z","updated_at":"2025-12-26T17:05:43.991099145Z","closed_at":"2025-12-26T17:05:43.991099145Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-3xv","depends_on_id":"mala-4w7","type":"parent-child","created_at":"2025-12-26T16:47:52.996880868Z","created_by":"daemon"}]}
{"id":"mala-3z2","title":"Test: tiny edit","status":"tombstone","priority":2,"issue_type":"task","created_at":"2025-12-25T19:08:44.86959643Z","updated_at":"2025-12-25T19:12:41.579812812Z","deleted_at":"2025-12-25T19:12:41.579812812Z","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"mala-40pg","title":"Epic: Improve Terminal Logging Visibility","description":"# Epic: Improve Terminal Logging Visibility\n\n**Spec**: `docs/2026-01-01-improve-terminal-logging-spec.md`\n**Plan**: `docs/2026-01-01-improve-terminal-logging-plan.md`\n\n## Context\n- Users need better visibility into orchestrator operations during long-running tasks\n- Currently missing `on_validation_started` event, gate/review starts are verbose-only\n- Issue IDs not shown in logs, making it hard to correlate with specific issues\n\n## Goals\n1. Add `on_validation_started` event (new)\n2. Make gate/review start events visible in normal mode (change `log_verbose()` → `log()`)\n3. Include issue IDs in major event logs (e.g., `[ISSUE-123]` instead of `[agent-a1b2]`)\n\n## Scope\n**In**: coordinate all terminal logging improvements across console.py, event_sink.py, agent_session_runner.py\n**Out**: JSON/machine-readable output, progress bars, CLI flag changes\n\n## Child Issues\n- Add `issue_id` parameter to console `log()` function\n- Add `on_validation_started` and `issue_id` params to MalaEventSink protocol\n- Implement ConsoleEventSink logging with `issue_id` and normal-mode start events\n- Wire event emissions with `issue_id` in AgentSessionRunner\n\n## Acceptance Criteria\n- [ ] `on_validation_started` event emits and logs\n- [ ] Gate/review start events visible without `-v` flag\n- [ ] Issue IDs shown as `[ISSUE-123]` in major event logs\n- [ ] Agent ID fallback `[agent-a1b2]` when no issue context\n- [ ] All existing tests pass; new tests added","status":"closed","priority":2,"issue_type":"epic","created_at":"2026-01-01T18:58:31.17131776Z","created_by":"cyou","updated_at":"2026-01-01T19:56:47.290782182Z","closed_at":"2026-01-01T19:56:47.290782182Z","close_reason":"Closed","labels":["logging"]}
{"id":"mala-40pg.1","title":"Add issue_id parameter to console log() function","description":"# Add issue_id parameter to console log() function\n\n**Plan Task**: Task 1 from `docs/2026-01-01-improve-terminal-logging-plan.md`\n\n## Context\n- `log()` function at `src/infra/io/log_output/console.py:116-142` currently only accepts `agent_id`\n- Need dual-ID display: show `issue_id` for display, use `agent_id` for color mapping\n- Format: `[ISSUE-123]` when issue_id provided, fallback to `[agent-a1b2]`\n\n## Primary Files\n- `src/infra/io/log_output/console.py`\n- `tests/test_logging_console.py`\n\n## Scope\n**In**: Add `issue_id: str | None = None` parameter to `log()`, update prefix logic\n**Out**: Changes to `log_verbose()`, `log_tool()`, `log_agent_text()` (must stay compact per spec)\n\n## Implementation\n```python\ndef log(\n    icon: str,\n    message: str,\n    color: str = Colors.RESET,\n    dim: bool = False,\n    agent_id: str | None = None,\n    issue_id: str | None = None,  # NEW parameter\n) -\u003e None:\n```\n\nUpdate prefix logic (lines 134-138):\n```python\nif issue_id:\n    # Use issue_id as display, agent_id for color mapping\n    agent_color = get_agent_color(agent_id) if agent_id else Colors.CYAN\n    prefix = f\"{agent_color}[{issue_id}]{Colors.RESET} \"\nelif agent_id:\n    agent_color = get_agent_color(agent_id)\n    prefix = f\"{agent_color}[{agent_id}]{Colors.RESET} \"\nelse:\n    prefix = \"\"\n```\n\n## Acceptance Criteria\n- [ ] `log()` accepts optional `issue_id` parameter\n- [ ] When `issue_id` provided: displays `[ISSUE-123]`, agent_id used for color only\n- [ ] When `issue_id` not provided: displays `[agent-a1b2]` (existing behavior)\n- [ ] When `issue_id` provided without `agent_id`: uses cyan color\n- [ ] Existing calls to `log()` continue to work unchanged\n\n## Test Plan\n- TDD: Write `test_log_with_issue_id_shows_issue_only` first - assert `[ISSUE-123]` in output, `agent-abc` NOT in output\n- TDD: Write `test_log_with_issue_id_uses_agent_color` - assert agent_id in color map\n- TDD: Write `test_log_fallback_shows_agent_id_when_no_issue_id` - assert `[agent-a1b2]` appears\n- Run: `uv run pytest tests/test_logging_console.py -v`\n\n## Notes for Agent\n- Preserve signature compatibility - all new params must be optional with defaults\n- Color mapping via `get_agent_color(agent_id)` must still work when issue_id is displayed\n- See plan lines 69-92 for exact implementation","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T18:58:44.626789209Z","created_by":"cyou","updated_at":"2026-01-01T19:32:36.918841057Z","closed_at":"2026-01-01T19:32:36.918841057Z","close_reason":"Closed","labels":["logging"],"dependencies":[{"issue_id":"mala-40pg.1","depends_on_id":"mala-40pg","type":"parent-child","created_at":"2026-01-01T18:58:44.634828266Z","created_by":"daemon"}]}
{"id":"mala-40pg.2","title":"Add on_validation_started and issue_id params to MalaEventSink protocol","description":"# Add on_validation_started and issue_id params to MalaEventSink protocol\n\n**Plan Task**: Task 2 from `docs/2026-01-01-improve-terminal-logging-plan.md`\n\n## Context\n- `MalaEventSink` protocol at lines 56-599 defines semantic events\n- `NullEventSink` at lines 601-835 must implement matching no-ops\n- Currently no `on_validation_started` event; only `on_validation_result` exists at line 388\n\n## Primary Files\n- `src/infra/io/event_sink.py` (lines 55-835 only - protocol and NullEventSink)\n- `tests/test_event_sink.py`\n\n## Scope\n**In**: Add `on_validation_started(agent_id, issue_id=None)` to protocol and NullEventSink; add `issue_id` param to 9 existing methods\n**Out**: ConsoleEventSink implementation (separate task), changing method logic\n\n## Methods to Update\nAdd `issue_id: str | None = None` parameter to:\n1. `on_validation_result` (~line 388)\n2. `on_gate_started` (~line 195)\n3. `on_gate_passed` (~line 210)\n4. `on_gate_failed` (~line 218)\n5. `on_gate_retry` (~line 233)\n6. `on_gate_result` (~line 248)\n7. `on_review_started` (~line 270)\n8. `on_review_passed` (~line 285)\n9. `on_review_retry` (~line 293)\n\n## New Method (Protocol)\nAdd after `on_validation_result` at ~line 399:\n```python\ndef on_validation_started(self, agent_id: str, issue_id: str | None = None) -\u003e None:\n    \"\"\"Called when per-issue validation begins.\n\n    Args:\n        agent_id: Agent being validated.\n        issue_id: Issue being validated (for display).\n    \"\"\"\n    ...\n```\n\n## New Method (NullEventSink)\nAdd after line 752:\n```python\ndef on_validation_started(self, agent_id: str, issue_id: str | None = None) -\u003e None:\n    pass\n```\n\n## Acceptance Criteria\n- [ ] `MalaEventSink` protocol has `on_validation_started(agent_id: str, issue_id: str | None = None)`\n- [ ] All 9 methods updated with `issue_id: str | None = None` parameter\n- [ ] `NullEventSink` implements all new/modified methods as `pass`\n- [ ] `isinstance(NullEventSink(), MalaEventSink)` still returns True\n\n## Test Plan\n- TDD: Add `test_null_sink_on_validation_started` - assert returns None\n- TDD: Add test that NullEventSink accepts `issue_id=None` without error for updated methods\n- Run: `uv run pytest tests/test_event_sink.py::TestNullEventSink -v`\n- Run: `uvx ty check src/infra/io/event_sink.py`\n\n## Notes for Agent\n- This task does NOT touch ConsoleEventSink (lines 837+)\n- All `issue_id` params must default to `None` for backwards compatibility\n- Also update the corresponding NullEventSink methods to accept the new param\n\n## Coordination Note\n**mala-cavk.1** (P1) also modifies `event_sink.py` to create `BaseEventSink`. If that lands first:\n- `NullEventSink` may become an alias to `BaseEventSink`\n- Add new method to `BaseEventSink` instead of `NullEventSink`\n- Check current structure before starting","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T18:58:58.573608388Z","created_by":"cyou","updated_at":"2026-01-01T19:33:10.814819603Z","closed_at":"2026-01-01T19:33:10.814819603Z","close_reason":"Closed","labels":["logging"],"dependencies":[{"issue_id":"mala-40pg.2","depends_on_id":"mala-40pg","type":"parent-child","created_at":"2026-01-01T18:58:58.581712773Z","created_by":"daemon"}]}
{"id":"mala-40pg.3","title":"Implement ConsoleEventSink logging with issue_id and normal-mode start events","description":"# Implement ConsoleEventSink logging with issue_id and normal-mode start events\n\n**Plan Task**: Task 3 from `docs/2026-01-01-improve-terminal-logging-plan.md`\n\n## Context\n- `ConsoleEventSink` at `src/infra/io/event_sink.py:837-1397` needs to implement new events and pass issue_id to log()\n- `on_gate_started` (line 1074) and `on_review_started` (line 1146) currently use `log_verbose()` - need to change to `log()`\n\n## Primary Files\n- `src/infra/io/event_sink.py` (lines 837-1397 only - ConsoleEventSink)\n- `tests/test_event_sink.py`\n\n## Scope\n**In**: Implement `on_validation_started` in ConsoleEventSink; add `issue_id` param to 9 methods and pass to `log()`; change `on_gate_started` and `on_review_started` from `log_verbose()` to `log()`\n**Out**: Event emission call sites (separate task)\n\n## Implementation\n\n### Add on_validation_started (after on_validation_result at ~line 1248)\n```python\ndef on_validation_started(self, agent_id: str, issue_id: str | None = None) -\u003e None:\n    \"\"\"Log validation start.\"\"\"\n    log(\"◐\", \"Starting validation...\", Colors.MUTED, agent_id=agent_id, issue_id=issue_id)\n```\n\n### Update on_gate_started (~line 1074-1087)\n```python\ndef on_gate_started(\n    self,\n    agent_id: str | None,\n    attempt: int,\n    max_attempts: int,\n    issue_id: str | None = None,  # NEW\n) -\u003e None:\n    \"\"\"Log quality gate check start.\"\"\"\n    scope = \"run-level \" if agent_id is None else \"\"\n    log(  # Changed from log_verbose\n        \"→\",\n        f\"Quality gate {scope}check (attempt {attempt}/{max_attempts})\",\n        Colors.MUTED,\n        agent_id=agent_id,\n        issue_id=issue_id,\n    )\n```\n\n### Update on_review_started (~line 1146-1158)\n```python\ndef on_review_started(\n    self,\n    agent_id: str,\n    attempt: int,\n    max_attempts: int,\n    issue_id: str | None = None,  # NEW\n) -\u003e None:\n    \"\"\"Log review start.\"\"\"\n    log(  # Changed from log_verbose\n        \"→\",\n        f\"Review (attempt {attempt}/{max_attempts})\",\n        Colors.MUTED,\n        agent_id=agent_id,\n        issue_id=issue_id,\n    )\n```\n\n### Update remaining handlers with issue_id parameter\n- `on_gate_passed`, `on_gate_failed`, `on_gate_retry`, `on_gate_result`\n- `on_review_passed`, `on_review_retry`\n- `on_validation_result`\n\n## Acceptance Criteria\n- [ ] `ConsoleEventSink.on_validation_started()` logs \"Starting validation...\" with issue_id\n- [ ] `on_gate_started` uses `log()` not `log_verbose()` (visible without -v)\n- [ ] `on_review_started` uses `log()` not `log_verbose()` (visible without -v)\n- [ ] All 9 updated methods pass `issue_id` to `log()` calls\n- [ ] `isinstance(ConsoleEventSink(), MalaEventSink)` returns True\n\n## Test Plan\n- TDD: Add `test_validation_started_logs_message` - mock datetime, assert timestamp and \"[ISSUE-123]\" in output\n- TDD: Add `test_on_gate_started_uses_log_not_verbose` - patch `log`, assert called\n- TDD: Add `test_on_review_started_uses_log_not_verbose` - patch `log`, assert called\n- Run: `uv run pytest tests/test_event_sink.py::TestConsoleEventSink -v`\n\n## Notes for Agent\n- Do NOT modify `log_tool()` or `log_agent_text()` output (spec non-goal)\n- See plan lines 151-202 for exact implementation snippets\n\n## Coordination Note\n**mala-cavk.1** (P1) also modifies `event_sink.py` to refactor inheritance. If that lands first:\n- `ConsoleEventSink` may inherit from `BaseEventSink` instead of implementing from scratch\n- Verify class inheritance before adding new methods\n- The line numbers in this issue may shift - search for method names instead","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T18:59:17.304278149Z","created_by":"cyou","updated_at":"2026-01-01T19:41:09.663780386Z","closed_at":"2026-01-01T19:41:09.663780386Z","close_reason":"Closed","labels":["logging"],"dependencies":[{"issue_id":"mala-40pg.3","depends_on_id":"mala-40pg","type":"parent-child","created_at":"2026-01-01T18:59:17.312930516Z","created_by":"daemon"},{"issue_id":"mala-40pg.3","depends_on_id":"mala-40pg.1","type":"blocks","created_at":"2026-01-01T19:03:15.480738598Z","created_by":"daemon"},{"issue_id":"mala-40pg.3","depends_on_id":"mala-40pg.2","type":"blocks","created_at":"2026-01-01T19:03:35.43540132Z","created_by":"daemon"}]}
{"id":"mala-40pg.4","title":"Wire event emissions with issue_id in AgentSessionRunner","description":"# Wire event emissions with issue_id in AgentSessionRunner\n\n**Plan Task**: Task 4 from `docs/2026-01-01-improve-terminal-logging-plan.md`\n\n## Context\n- `AgentSessionRunner.run_session()` emits gate/review events at lines 856-930\n- Need to emit new `on_validation_started` event and pass `issue_id` to existing emissions\n- **Current behavior**: `input.issue_id` is passed as `agent_id` param (line 875, 1003) for color mapping\n\n## Primary Files\n- `src/pipeline/agent_session_runner.py`\n- `tests/test_agent_session_runner.py`\n\n## Scope\n**In**: Emit `on_validation_started` before RUN_GATE effect; add `issue_id=input.issue_id` kwarg to all event_sink calls\n**Out**: Protocol/sink changes (done in prior tasks); changing color mapping behavior\n\n## Implementation\nIn `AgentSessionRunner.run_session()`, at the RUN_GATE handling (~line 874):\n\n```python\nif result.effect == Effect.RUN_GATE:\n    # Emit validation started BEFORE the gate check\n    if self.event_sink is not None:\n        self.event_sink.on_validation_started(\n            input.issue_id,  # Keep using issue_id for color mapping (current behavior)\n            issue_id=input.issue_id,  # NEW: also pass for display\n        )\n\n    if self.event_sink is not None:\n        self.event_sink.on_gate_started(\n            input.issue_id,  # Keep using issue_id for color mapping (current behavior)\n            lifecycle_ctx.retry_state.gate_attempt,\n            self.config.max_gate_retries,\n            issue_id=input.issue_id,  # NEW: pass for display\n        )\n    # ... existing gate check code ...\n```\n\nSimilarly update all other event emissions to add `issue_id=input.issue_id` as a new keyword argument.\n\n**Note**: We keep `input.issue_id` as the first positional arg (agent_id) to maintain current color-per-issue behavior. The new `issue_id` kwarg enables the display format `[ISSUE-123]` without changing colors.\n\n## Acceptance Criteria\n- [ ] `on_validation_started(input.issue_id, issue_id=input.issue_id)` emitted just before gate check\n- [ ] All `on_gate_*` emissions include new `issue_id=input.issue_id` kwarg\n- [ ] All `on_review_*` emissions include new `issue_id=input.issue_id` kwarg\n- [ ] Color mapping behavior unchanged (still uses issue_id for colors)\n\n## Test Plan\n- Add test in `tests/test_agent_session_runner.py` verifying `on_validation_started` is called before `on_gate_started`\n- Run: `uv run pytest tests/test_agent_session_runner.py -v -k gate`\n- Manual: Run `mala run` on test issue and verify log output matches spec example\n\n## Notes for Agent\n- **Keep first arg as `input.issue_id`** - this maintains current color-per-issue behavior\n- The new `issue_id` kwarg is for display purposes only\n- Validation started should emit just before the RUN_GATE effect handling (~line 874)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T18:59:35.611542705Z","created_by":"cyou","updated_at":"2026-01-01T19:54:45.015490132Z","closed_at":"2026-01-01T19:54:45.015490132Z","close_reason":"Closed","labels":["logging"],"dependencies":[{"issue_id":"mala-40pg.4","depends_on_id":"mala-40pg","type":"parent-child","created_at":"2026-01-01T18:59:35.619955695Z","created_by":"daemon"},{"issue_id":"mala-40pg.4","depends_on_id":"mala-40pg.3","type":"blocks","created_at":"2026-01-01T19:03:43.398597552Z","created_by":"daemon"}]}
{"id":"mala-4313","title":"[Review] src/infra/hooks/lint_cache.py:115-120: [P2] Case-insensitive matching removed from lint detection","description":"## Review Finding\n\nThis issue was auto-created from a P2 review finding.\n\n**Source issue:** mala-fdp1.10\n**Reviewer:** claude\n**Location:** src/infra/hooks/lint_cache.py:115-120\n\n## Details\n\nThe previous implementation used `re.IGNORECASE` for lint command detection, meaning commands like `RUFF CHECK .` would be recognized. The new implementation using `extract_tool_name()` does case-sensitive matching since `lint_tools` contains lowercase strings (`\"ruff\"`, `\"eslint\"`, etc.) and the extracted tool name is compared directly. While uppercase lint commands are unusual in practice, this is a subtle behavioral change that could cause previously-cached commands to no longer match. If case-insensitive matching was intentional, you could normalize: `base_tool.lower() in lint_tools`.","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-02T15:43:51.253520158Z","created_by":"cyou","updated_at":"2026-01-02T15:43:51.253520158Z","labels":["auto_generated","review_finding","review_finding:ae57de29aa47","source:mala-fdp1.10"]}
{"id":"mala-46q","title":"Add orchestrator unit tests (mock bd + SDK)","description":"Problem: Tests focus on lock scripts/SDK integration, but MalaOrchestrator control flow is untested (bd ready/claim/reset, timeout handling, exit code semantics).\\n\\nScope/files: tests/ (new test module), can mock subprocess.run and ClaudeSDKClient to avoid network. Avoid modifying src/cli.py unless absolutely required; if refactor is needed, document why.\\n\\nSuggested tests:\\n- get_ready_issues handles bd JSON and errors.\\n- claim_issue/reset_issue invoked appropriately.\\n- run() handles no ready issues and stops cleanly.\\n- On failed task, resets issue status.\\n\\nAcceptance criteria:\\n- Tests run without network and without actual bd CLI.\\n- Minimal mocking surface; focus on orchestrator state transitions.\\n\\nTDD: Write tests first, then adjust code if needed.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T21:38:34.899307031Z","updated_at":"2025-12-25T23:59:05.389010652Z","closed_at":"2025-12-25T23:59:05.389010652Z","close_reason":"Closed"}
{"id":"mala-48s","title":"Improve review prompt","description":"Enhance the review prompt for better quality code reviews","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-28T06:21:39.46584358Z","updated_at":"2026-01-01T21:39:57.039885773Z","closed_at":"2026-01-01T21:39:57.039885773Z","close_reason":"Closed"}
{"id":"mala-4dh","title":"Implement E2E fixture runner","description":"Context:\n- E2E fixture run validates mala end-to-end behavior on a tiny repo.\n- Requires Claude CLI, MORPH_API_KEY, and bd availability.\n\nScope:\n- In: create fixture repo, run mala, validate outputs, cleanup; enforce preconditions; support --skip-e2e-if-no-keys.\n- Out: per-issue validation; E2E is run-level only.\n\nAcceptance Criteria:\n- E2E runner returns E2EResult with clear failure reasons.\n- Preconditions enforced or skipped per flag.\n- Fixture repo cleaned up unless keep flag is set.\n\nTest Plan:\n- Add unit tests for precondition checks and fixture path handling.\n- Mark full E2E run test as slow/optional.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T23:00:01.691693551Z","updated_at":"2025-12-27T00:32:01.5851032Z","closed_at":"2025-12-27T00:32:01.5851032Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-4dh","depends_on_id":"mala-j6p","type":"blocks","created_at":"2025-12-26T23:00:26.489084536Z","created_by":"daemon"}]}
{"id":"mala-4h5","title":"CLI: Make quiet mode the default, require --verbose for verbose output","description":"## Problem\n\nCurrently the CLI defaults to verbose mode (`--verbose/--quiet` with default True), meaning users must pass `-q` or `--quiet` to get quieter output. This is backwards - quiet should be the default.\n\n## Current Behavior\n```python\nverbose: Annotated[\n    bool,\n    typer.Option(\n        \"--verbose/--quiet\",\n        \"-v/-q\",\n        help=\"Verbose output shows full tool arguments; quiet mode shows single line per tool call\",\n    ),\n] = True\n```\n\n## Desired Behavior\n- Default to quiet mode (verbose=False)\n- Users must specify `--verbose` or `-v` to get verbose output\n- Remove the `--quiet`/`-q` flag entirely since quiet is now the default\n\n## Files\n- src/cli.py\n\n## Acceptance Criteria\n- [ ] CLI defaults to quiet mode\n- [ ] `--verbose` / `-v` enables verbose output\n- [ ] `--quiet` / `-q` flags are removed\n- [ ] Help text updated accordingly\n- [ ] Tests updated to reflect new default","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-27T17:54:13.041418656Z","updated_at":"2025-12-28T05:08:24.629647587Z","closed_at":"2025-12-28T05:08:24.629647587Z","close_reason":"Closed"}
{"id":"mala-4ls","title":"Lock key: hash canonical paths + repo namespace","description":"Problem: Lock filenames are derived by replacing '/' with '_' (scripts + src/tools/locking.py). This causes collisions (e.g., 'a/b' vs 'a_b') and cross-repo contention. Fix by hashing a canonical path (absolute or repo-root+relative) and namespacing locks per repo/cwd.\\n\\nScope/files: scripts/lock-try.sh, lock-check.sh, lock-holder.sh, lock-release.sh, lock-release-all.sh, src/tools/locking.py, tests in tests/test_lock_scripts.py and tests/test_lock_integration.py (and any necessary updates). Consider also centralizing LOCK_DIR/SCRIPTS_DIR if needed.\\n\\nAcceptance criteria:\\n- Lock key is collision-resistant (e.g., sha256 of canonical path).\\n- Locks for different repos/paths do not collide.\\n- Lock holder and cleanup continue to work with AGENT_ID.\\n- Tests updated/added to cover collision case and repo namespace case.\\n\\nTDD: Add/adjust tests first to demonstrate collision and then pass after change.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-25T21:37:59.249680035Z","updated_at":"2025-12-26T00:01:08.029869568Z","closed_at":"2025-12-26T00:01:08.029869568Z","close_reason":"Closed"}
{"id":"mala-4o4","title":"Commit partial progress and mark needs-continuation","status":"tombstone","priority":2,"issue_type":"epic","created_at":"2025-12-26T00:55:42.724613481Z","updated_at":"2025-12-26T00:56:32.195455786Z","deleted_at":"2025-12-26T00:56:32.195455786Z","deleted_by":"daemon","delete_reason":"delete","original_type":"epic"}
{"id":"mala-4ov","title":"Metrics and logging for multi-agent sessions","description":"Add metrics and logging for multi-agent sessions (counts, durations, success/failure rates, queue depth) to make runs observable and debuggable.","status":"closed","priority":4,"issue_type":"epic","created_at":"2025-12-26T00:55:42.866840213Z","updated_at":"2025-12-26T18:28:00.511651865Z","closed_at":"2025-12-26T18:28:00.511651865Z","close_reason":"Closed per user request"}
{"id":"mala-4w7","title":"Epic: Track A Shared-Worktree Hardening","description":"Context:\n- Umbrella epic for Track A (A1–A6) tasks from docs/coordination-plan-codex.md.\n\nScope:\n- In: group all Track A tasks under this epic.\n- Out: no implementation changes.\n\nAcceptance Criteria:\n- All Track A issues are linked as children (directly or via sub-epics).\n\nTest Plan:\n- N/A (coordination-only).\n\nNotes for Agent:\n- Keep A3 as a sub-epic under this umbrella.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-26T16:47:48.086896295Z","updated_at":"2025-12-26T17:15:07.704095723Z","closed_at":"2025-12-26T17:15:07.704095723Z","close_reason":"All children completed"}
{"id":"mala-503","title":"Fix run-level E2E status when E2E is skipped","description":"Run-level validation currently records e2e_passed True/False even when E2E was not executed (e.g., disable_validations/run_e2e false or spec omits E2E). This makes run metadata misleading. Update run-level metadata to reflect actual E2E execution: set e2e_passed based on E2E run result, or None when E2E skipped. Affects src/orchestrator.py around run-level validation recording.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-27T22:40:50.347545047Z","updated_at":"2025-12-28T05:11:42.096301671Z","closed_at":"2025-12-28T05:11:42.096301671Z","close_reason":"Closed"}
{"id":"mala-51q","title":"Epic: Architecture refactors (2025-12-28 review)","description":"## Context\nArchitecture review identified 10 issues across the codebase. Primary hotspot is orchestrator.py with CCN=81 in run() method.\n\n## Goals\n- Reduce orchestrator.py complexity (target: \u003c500 LOC, no function CCN \u003e 20)\n- Eliminate duplicate code in BeadsClient and QualityGate\n- Improve testability through better separation of concerns\n\n## Child Issues\nSee linked children for individual refactors.\n\n## Acceptance Criteria\n- All child issues completed\n- No function with CCN \u003e 20\n- Existing tests pass","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-28T07:20:17.041646469Z","updated_at":"2025-12-28T16:39:47.541056148Z","closed_at":"2025-12-28T16:39:47.541056148Z","close_reason":"All children completed"}
{"id":"mala-51q.1","title":"BeadsClient: extract shared filtering logic from get_ready methods","description":"## Context\n- `get_ready_async` (lines 298-420) and `get_ready_issues_async` (lines 423-538) share ~80% logic\n- Filtering, WIP handling, epic filtering, blocked epic exclusion, and sorting are duplicated\n- Only return type differs (list[str] vs list[dict])\n- Current implementations have subtle ordering differences that could diverge\n\n## Primary Files\n- src/beads_client.py\n\n## Scope\n**In:** Extract `_fetch_and_filter_issues(...)` returning list[dict]; refactor both public methods to use it\n**Out:** No public API changes; no behavioral changes\n\n## Acceptance Criteria\n- Single private method handles all filtering/sorting logic\n- `get_ready_async` extracts IDs from shared result\n- `get_ready_issues_async` returns shared result directly\n- Identical ordering between both methods (add test)\n\n## Test Plan\n- Run `test_beads_client.py` suite\n- Add test verifying `get_ready_async` and `get_ready_issues_async` return consistent ordering\n\n## Notes for Agent\n- Watch for subtle differences in lines 404-418 vs 524-534 (sorting after focus grouping)\n- Both methods must call the same parent_epic enrichment logic","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-28T07:20:38.570019133Z","updated_at":"2025-12-28T07:35:23.973092937Z","closed_at":"2025-12-28T07:35:23.973092937Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-51q.1","depends_on_id":"mala-51q","type":"parent-child","created_at":"2025-12-28T07:20:38.577740681Z","created_by":"daemon"}]}
{"id":"mala-51q.10","title":"QualityGate: remove deprecated VALIDATION_PATTERNS and legacy parsing methods","description":"## Context\n- `VALIDATION_PATTERNS` class variable at `quality_gate.py:165-170` is marked \"DEPRECATED: Use detection_pattern from ValidationSpec commands instead\"\n- `_get_fallback_pattern()` still uses these deprecated patterns for backward compatibility\n- Legacy methods `parse_validation_evidence()` and `parse_validation_evidence_from_offset()` still exist\n- Production code uses `parse_validation_evidence_with_spec()` exclusively (per mala-yg9.7 implementation)\n\n## Primary Files\n- src/quality_gate.py\n\n## Scope\n**In:** Verify no production code uses legacy methods; remove `VALIDATION_PATTERNS`, `_get_fallback_pattern()`, and legacy parsing methods if safe\n**Out:** Do not change spec-driven parsing logic\n\n## Acceptance Criteria\n- `VALIDATION_PATTERNS` removed from QualityGate\n- `_get_fallback_pattern()` removed\n- Legacy `parse_validation_evidence()` and `parse_validation_evidence_from_offset()` removed or clearly deprecated\n- All tests pass\n- Grep confirms no production usages of removed methods\n\n## Test Plan\n- Grep for usages of deprecated methods in production code (not tests)\n- `uv run pytest tests/test_quality_gate.py`\n\n## Notes for Agent\n- This depends on mala-51q.2 (JSONL iterator extraction) since that touches same file\n- Check that orchestrator passes spec to all QualityGate calls\n- If any production path still needs legacy methods, add deprecation warnings instead of removing","status":"closed","priority":3,"issue_type":"chore","created_at":"2025-12-28T07:23:46.438342948Z","updated_at":"2025-12-28T16:27:01.364829948Z","closed_at":"2025-12-28T16:27:01.364829948Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-51q.10","depends_on_id":"mala-51q","type":"parent-child","created_at":"2025-12-28T07:23:46.438965911Z","created_by":"daemon"},{"issue_id":"mala-51q.10","depends_on_id":"mala-51q.2","type":"blocks","created_at":"2025-12-28T07:23:51.988808262Z","created_by":"daemon"}]}
{"id":"mala-51q.2","title":"QualityGate: extract reusable JSONL log iterator","description":"## Context\n- Three methods iterate JSONL logs with nearly identical patterns: `parse_issue_resolution_from_offset`, `parse_validation_evidence_from_offset`, `parse_validation_evidence_with_spec`\n- Each has byte-offset tracking, JSON parsing, error handling duplicated\n- CCN ranges from 15-31 due to deep nesting\n\n## Primary Files\n- src/quality_gate.py\n\n## Scope\n**In:** Create `_iter_jsonl_entries(log_path, offset) -\u003e Iterator[(entry, line_len, offset)]`; refactor all three methods to use it\n**Out:** Do not remove deprecated methods; no behavioral changes\n\n## Acceptance Criteria\n- Single JSONL iteration implementation\n- Each parser method is \u003c30 lines\n- Offset tracking works correctly (test with edge cases)\n\n## Test Plan\n- Run `test_quality_gate.py` suite\n- Verify offset tracking with empty lines, binary data, truncated files\n\n## Notes for Agent\n- Must read in binary mode for accurate byte offsets\n- Handle UnicodeDecodeError gracefully in iterator\n- Consider yielding a named tuple or dataclass for clarity","notes":"Quality gate failed: Quality gate failed: Missing validation commands: ty check, ruff format, pytest, ruff check; No progress: commit unchanged and no new validation evidence\nLog: /home/cyou/.claude/projects/-home-cyou-mala/97d62139-ad7f-4f84-bf2d-72364026f051.jsonl","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-28T07:20:55.555078495Z","updated_at":"2025-12-28T15:32:13.909523879Z","closed_at":"2025-12-28T15:32:13.909523879Z","close_reason":"Closed","labels":["needs-followup"],"dependencies":[{"issue_id":"mala-51q.2","depends_on_id":"mala-51q","type":"parent-child","created_at":"2025-12-28T07:20:55.562506778Z","created_by":"daemon"}]}
{"id":"mala-51q.3","title":"Orchestrator: extract result handling into separate module","description":"## Context\n- Lines 1300-1483 in `run()` handle completed task processing\n- This includes evidence parsing, validation running, metadata recording, and issue closing\n- Extracting this reduces orchestrator complexity significantly\n\n## Primary Files\n- src/orchestrator.py\n- src/result_handler.py (new)\n\n## Scope\n**In:** Create `src/result_handler.py` with `handle_completed_result(...)` function; move result processing logic there\n**Out:** Do not change external behavior; do not refactor run_implementer yet\n\n## Acceptance Criteria\n- Result handling logic in dedicated module\n- orchestrator.py `run()` method calls `handle_completed_result`\n- All existing tests pass\n\n## Test Plan\n- Run `test_orchestrator.py` suite\n- Verify successful and failed issue handling works identically\n\n## Notes for Agent\n- Will need access to quality_gate, beads client, and run_metadata\n- Consider passing these as parameters or a context object\n- Keep the interface simple - don't over-abstract yet","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-28T07:20:55.629561739Z","updated_at":"2025-12-28T07:52:53.19473233Z","closed_at":"2025-12-28T07:52:53.19473233Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-51q.3","depends_on_id":"mala-51q","type":"parent-child","created_at":"2025-12-28T07:20:55.630113922Z","created_by":"daemon"}]}
{"id":"mala-51q.4","title":"spec_runner: split _execute_spec_commands into focused functions","description":"## Context\n- `_execute_spec_commands` (lines 386-525) has CCN=17 and mixes command execution, logging, coverage, and E2E\n- Early returns scattered throughout make success path hard to follow\n- `_check_coverage` is already extracted but invoked inline\n\n## Primary Files\n- src/validation/spec_runner.py\n\n## Scope\n**In:** Extract `_run_commands(spec, cwd, env, log_dir) -\u003e list[ValidationStepResult]`; use pipeline pattern in `_run_spec_sync`\n**Out:** Do not change ValidationResult structure\n\n## Acceptance Criteria\n- Each step function has single responsibility\n- Success path is linear: run_commands -\u003e check_coverage -\u003e run_e2e -\u003e build_result\n- No function over 50 lines\n\n## Test Plan\n- Existing spec_runner tests pass\n- Add test for command failure early exit\n\n## Notes for Agent\n- Coverage check already extracted; just needs cleaner invocation\n- Consider returning early failure as a result, not using exceptions","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-28T07:21:17.14628441Z","updated_at":"2025-12-28T08:40:39.117367362Z","closed_at":"2025-12-28T08:40:39.117367362Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-51q.4","depends_on_id":"mala-51q","type":"parent-child","created_at":"2025-12-28T07:21:17.155201727Z","created_by":"daemon"}]}
{"id":"mala-51q.5","title":"Unify RetryState between orchestrator and lifecycle modules","description":"## Context\n- Two RetryState classes exist: orchestrator uses `attempt`, lifecycle uses `gate_attempt`\n- Lines 854-863 in run_implementer manually sync between them\n- lifecycle.py notes this as \"compatibility\" but it creates confusion\n- **Bridge functions are dead code**: `from_orchestrator_retry_state()` and `to_orchestrator_retry_state_fields()` (lines 434-489) are only used in tests, not in production\n\n## Primary Files\n- src/orchestrator.py\n- src/lifecycle.py\n- tests/test_lifecycle.py\n\n## Scope\n**In:** Use lifecycle.py's RetryState as canonical source; remove orchestrator's duplicate; eliminate sync code; remove unused bridge functions\n**Out:** Do not change lifecycle state machine semantics\n\n## Acceptance Criteria\n- Single RetryState definition (in lifecycle.py)\n- No manual state syncing in run_implementer\n- Bridge functions `from_orchestrator_retry_state()` and `to_orchestrator_retry_state_fields()` removed\n- Tests updated to construct RetryState directly\n- All tests pass\n\n## Test Plan\n- Run lifecycle and orchestrator test suites\n- `pytest tests/test_lifecycle.py` passes after bridge function removal\n\n## Notes for Agent\n- Check if any code outside run_implementer uses orchestrator's RetryState\n- May need to import RetryState from lifecycle in orchestrator\n- Bridge functions at lifecycle.py:434-489 are dead code - remove them\n- Update test_lifecycle.py to construct RetryState directly instead of using bridge","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-28T07:21:17.236197567Z","updated_at":"2025-12-28T08:07:08.787455409Z","closed_at":"2025-12-28T08:07:08.787455409Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-51q.5","depends_on_id":"mala-51q","type":"parent-child","created_at":"2025-12-28T07:21:17.236515373Z","created_by":"daemon"},{"issue_id":"mala-51q.5","depends_on_id":"mala-51q.3","type":"blocks","created_at":"2025-12-28T07:22:06.952208101Z","created_by":"daemon"}]}
{"id":"mala-51q.6","title":"cli.py: eliminate runtime imports with lazy-loading pattern","description":"## Context\n- CLI imports BeadsClient and MalaOrchestrator inside run() function body (lines 385-387)\n- Done to defer SDK loading until after bootstrap()\n- Makes dependencies unclear and complicates testing\n\n## Primary Files\n- src/cli.py\n\n## Scope\n**In:** Use `__getattr__` lazy-loading pattern at module level; or create AppContext returned by bootstrap\n**Out:** Do not change bootstrap() external behavior\n\n## Acceptance Criteria\n- Dependencies are explicit (either in signatures or module-level with lazy loading)\n- No runtime imports inside command functions\n- CLI still works with and without BRAINTRUST_API_KEY\n\n## Test Plan\n- Verify CLI commands work with/without env vars\n- Test imports don't trigger SDK loading prematurely\n\n## Notes for Agent\n- The bootstrap() pattern exists to ensure Braintrust SDK patching before claude_agent_sdk import\n- A simple approach: use module-level `_orchestrator_module = None` and lazy-load on first access","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-28T07:21:34.83971Z","updated_at":"2025-12-28T08:28:48.428025328Z","closed_at":"2025-12-28T08:28:48.428025328Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-51q.6","depends_on_id":"mala-51q","type":"parent-child","created_at":"2025-12-28T07:21:34.846347497Z","created_by":"daemon"}]}
{"id":"mala-51q.7","title":"Orchestrator: cache per-issue validation spec","description":"## Context\n- `build_validation_spec()` called 4+ times in run() with identical arguments\n- Lines 298-303, 1304-1309, 1402-1407 all build the same PER_ISSUE spec\n- Minor inefficiency but also DRY violation\n\n## Primary Files\n- src/orchestrator.py\n\n## Scope\n**In:** Build per-issue spec once at start of run loop; reuse throughout\n**Out:** Do not change spec building logic\n\n## Acceptance Criteria\n- Single spec construction per scope per run\n- No behavioral change\n\n## Test Plan\n- Verify spec attributes match current behavior\n\n## Notes for Agent\n- Create spec before entering main while loop\n- Pass spec to result handler if extracted\n- Depends on ORCH-RESULT being done first (same file)","notes":"Quality gate failed: Quality gate failed: No commit with bd-mala-51q.7 found after run baseline (stale commits from previous runs are rejected); Missing validation commands: ty check, ruff format, pytest, ruff check; No progress: commit unchanged and no new validation evidence\nLog: /home/cyou/.claude/projects/-home-cyou-mala/906253d2-918a-40da-a462-77f3d08b6361.jsonl","status":"closed","priority":3,"issue_type":"chore","created_at":"2025-12-28T07:21:34.910351945Z","updated_at":"2025-12-28T16:19:54.628873488Z","closed_at":"2025-12-28T16:19:54.628873488Z","close_reason":"Closed","labels":["needs-followup"],"dependencies":[{"issue_id":"mala-51q.7","depends_on_id":"mala-51q","type":"parent-child","created_at":"2025-12-28T07:21:34.910655561Z","created_by":"daemon"},{"issue_id":"mala-51q.7","depends_on_id":"mala-51q.3","type":"blocks","created_at":"2025-12-28T07:22:06.969877016Z","created_by":"daemon"}]}
{"id":"mala-51q.8","title":"Orchestrator: move inline prompts to src/prompts/","description":"## Context\n- `GATE_FOLLOWUP_PROMPT`, `CODEX_REVIEW_FOLLOWUP_PROMPT`, `RUN_LEVEL_FIXER_PROMPT` are multi-line strings in orchestrator.py (lines 95-150)\n- Main implementer prompt correctly loads from file\n- Consistency improves maintainability\n\n## Primary Files\n- src/orchestrator.py\n- src/prompts/gate_followup.md (new)\n- src/prompts/review_followup.md (new)\n- src/prompts/fixer.md (new)\n\n## Scope\n**In:** Move three follow-up prompts to `src/prompts/`; load at module level like implementer prompt\n**Out:** Do not change prompt content\n\n## Acceptance Criteria\n- All prompts in `src/prompts/` directory\n- Orchestrator has no inline multi-line prompt strings\n- Prompts load correctly at import time\n\n## Test Plan\n- Verify prompts contain expected placeholders\n- Run integration test that triggers follow-up prompts (gate retry)","status":"closed","priority":3,"issue_type":"chore","created_at":"2025-12-28T07:21:50.973141103Z","updated_at":"2025-12-28T08:52:55.945821631Z","closed_at":"2025-12-28T08:52:55.945821631Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-51q.8","depends_on_id":"mala-51q","type":"parent-child","created_at":"2025-12-28T07:21:50.973469208Z","created_by":"daemon"},{"issue_id":"mala-51q.8","depends_on_id":"mala-51q.3","type":"blocks","created_at":"2025-12-28T07:22:06.981091579Z","created_by":"daemon"}]}
{"id":"mala-51q.9","title":"Remove LegacyValidationRunner after verifying no external usage","description":"## Context\n- `legacy_runner.py` (240 LOC) duplicates spec_runner functionality\n- **17 usages** of `ValidationRunner` in tests (`test_validation.py`) - not just one\n- Orchestrator now uses `SpecValidationRunner.run_spec()` directly\n- `ValidationRunner` is marked deprecated in docstrings but still re-exported from `__init__.py`\n\n## Primary Files\n- src/validation/legacy_runner.py\n- src/validation/runner.py  \n- src/validation/__init__.py\n- tests/test_validation.py\n\n## Scope\n**In:** Migrate all 17 test usages from `ValidationRunner(repo_path, config)` to `SpecValidationRunner(repo_path)`; remove `ValidationRunner` facade; remove `LegacyValidationRunner`; update exports\n**Out:** Do not change ValidationResult structure; do not refactor SpecValidationRunner itself\n\n## Acceptance Criteria\n- All tests use `SpecValidationRunner` directly\n- `ValidationRunner` facade class removed\n- `LegacyValidationRunner` removed\n- Exports updated in `__init__.py`\n- Coverage remains at 86%+\n\n## Test Plan\n- All existing tests pass after migration\n- Grep confirms no ValidationRunner usages remain\n\n## Notes for Agent\n- Check for any plugins/external tools importing from mala.validation\n- Many tests construct `ValidationRunner(tmp_path, config)` - each needs migration to spec-based API\n- May need to convert ValidationConfig usage to ValidationSpec","notes":"Quality gate failed: Quality gate failed: Missing validation commands: ty check, ruff format, pytest, ruff check; No progress: commit unchanged and no new validation evidence\nLog: /home/cyou/.claude/projects/-home-cyou-mala/59dc6ec6-5d59-4475-82ca-246d6a8c1a30.jsonl","status":"closed","priority":3,"issue_type":"chore","created_at":"2025-12-28T07:21:51.030134159Z","updated_at":"2025-12-28T16:39:47.521533012Z","closed_at":"2025-12-28T16:39:47.521533012Z","close_reason":"Closed","labels":["needs-followup"],"dependencies":[{"issue_id":"mala-51q.9","depends_on_id":"mala-51q","type":"parent-child","created_at":"2025-12-28T07:21:51.030678912Z","created_by":"daemon"}]}
{"id":"mala-53v","title":"Quality gate: enforce full validation suite evidence","description":"Context:\n- src/quality_gate.py: ValidationEvidence.has_minimum_validation() currently passes with pytest OR ruff check+format; missing_commands() omits uv sync and ty check.\n- Implementer prompt/README require the full suite (uv sync, pytest, ruff check/format, ty check), so the gate can pass incomplete validation.\n\nScope:\n- In: require evidence for the full validation suite (uv sync, pytest, ruff check, ruff format, ty check) and update tests accordingly.\n- Out: changing prompt/docs or redefining the suite beyond the current prompt requirements.\n\nAcceptance Criteria:\n- Gate fails when any required command is missing, even if pytest or ruff ran.\n- Failure reasons list all missing commands including uv sync and ty check.\n- Tests cover missing uv sync and ty check scenarios.\n\nTest Plan:\n- TDD: add failing tests in tests/test_quality_gate.py for missing uv sync/ty check, implement minimal fix, run: uv run pytest tests/test_quality_gate.py\n\nNotes for Agent:\n- Keep parsing patterns consistent; only tighten required-command logic.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-26T21:43:43.706215554Z","updated_at":"2025-12-26T22:39:21.901160405Z","closed_at":"2025-12-26T22:39:21.901160405Z","close_reason":"Closed"}
{"id":"mala-59n","title":"Fix log indentation and add no-truncation option","description":"## Problem\nLog output has inconsistent indentation and lines are truncated:\n```\n00:43:23 ◌ Waiting for 1 agent(s)...\n  [mala-l7r] ⚙ Bash {'command': 'bd show mala-l7r', 'description': 'Vi\n    [mala-l7r] Now let me understand the codebase structure...\n  [mala-l7r] ⚙ Bash {'command': 'ls -la /home/cyou/mala/src/', 'descri\n```\n\nIssues:\n1. **Inconsistent indentation**: Some lines have 2-space indent, others have 4-space indent before `[agent-id]`\n2. **Truncation**: Lines are cut off (e.g., `'Vi`, `'descri`) without option to see full content\n\n## Scope/files\n- `src/logging/console.py` or equivalent logging module\n- `src/cli.py` or `src/orchestrator.py` for CLI flag\n\n## Work\n1. Fix indentation to be consistent (likely all agent output should have same base indent)\n2. Add `--no-truncate` or `--verbose` CLI flag to disable line truncation\n3. Consider making truncation width configurable\n\n## Acceptance criteria\n- All agent log lines have consistent indentation\n- New flag allows viewing full log lines without truncation\n- Default behavior (truncated) still works","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T00:47:13.094441264Z","updated_at":"2025-12-26T00:57:22.727412832Z","closed_at":"2025-12-26T00:57:22.727412832Z","close_reason":"Closed"}
{"id":"mala-5aa","title":"Refactor: consolidate locking into tools/locking.py","description":"## Context\nLocking behavior is split between `src/filelock.py` and shell scripts in `scripts/`. `src/main.py` directly imports `LOCK_DIR` and `release_all_locks` from `filelock.py` and also defines `make_stop_hook` which relies on lock scripts. The plan is to consolidate locking into `src/tools/locking.py`.\n\n## Scope\nCreate `src/tools/locking.py` only. Do **not** modify `src/main.py` or tests in this issue; integration will wire it up later.\n\n### Files\n- Add: `src/tools/locking.py`\n- (Optional) Modify or remove: `src/filelock.py`\n\n## Requirements\n- `tools/locking.py` should export:\n  - `LOCK_DIR`\n  - `release_all_locks()` (existing behavior)\n  - `cleanup_agent_locks(agent_id)` (existing behavior from `MalaOrchestrator`)\n  - `make_stop_hook(agent_id)` (existing behavior)\n- Decide one:\n  - Keep `src/filelock.py` as a thin re-export for backward compatibility, OR\n  - Remove `src/filelock.py` and update all imports (handled later in integration).\n\n## TDD Guidance\n- If you touch tests in this issue, stop and defer them to integration (tests should be updated there).\n\n## Acceptance Criteria\n- `src/tools/locking.py` exists with the required exports.\n- No other files are modified in this issue (except optional `src/filelock.py`).\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T19:54:51.176735691Z","updated_at":"2025-12-25T20:10:14.682614354Z","closed_at":"2025-12-25T20:10:14.682614354Z","close_reason":"Closed"}
{"id":"mala-5cz","title":"Skip uv sync when pyproject.toml unchanged","description":"## Context\nCurrently `uv sync` runs on every validation cycle, even when dependencies haven't changed.\n\n## Goal\nOnly run `uv sync` when `pyproject.toml` (or `uv.lock`) has been modified since the last sync.\n\n## Approach\n- Track last sync timestamp or hash of pyproject.toml/uv.lock\n- Compare before running sync\n- Skip if unchanged, reducing validation overhead\n\n## Acceptance Criteria\n- `uv sync` only runs when dependency files have changed\n- First run still syncs (no prior state)\n- Force sync option available if needed","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T00:55:36.999060635Z","updated_at":"2025-12-27T01:09:49.406031776Z","closed_at":"2025-12-27T01:09:49.406031776Z","close_reason":"Closed"}
{"id":"mala-5eg","title":"Enforce full validation in quality gate (no file-specific checks)","description":"## Problem\n\n**CRITICAL GAP**: The orchestrator does NOT actually run validation after agent commits.\n\nCurrent flow:\n1. Agent runs, does its own validation (or games it with `ty check src/specific_file.py`)\n2. `QualityGate` parses JSONL logs for regex matches like `r\"\\b(uvx\\s+)?ty\\s+check\\b\"`\n3. If `ty check` was **mentioned** (even with a path argument) → gate passes\n\nThe `QualityGate` only checks IF commands were mentioned, NOT:\n- Whether they ran on the full codebase (vs `ty check src/foo.py`)\n- Whether they passed (exit code 0)\n- Whether the output showed 0 errors\n\nMeanwhile, `ValidationRunner` exists with proper worktree-based validation but is **not wired up** to the orchestrator flow.\n\n## Solution\n\n### Option A: Wire up ValidationRunner (Recommended)\nAfter agent commits, orchestrator should:\n1. Call `ValidationRunner.validate_commit(commit_sha, issue_id)`\n2. This runs full validation in clean worktree including `uvx ty check`\n3. Gate fails if any validation step fails\n\n### Option B: Enhance QualityGate Regex (Partial Fix)\nUpdate `VALIDATION_PATTERNS[\"ty_check\"]` to reject:\n- Path arguments: `ty check src/`, `ty check tests/`\n- Truncation: `| head`, `| tail`\n- Non-zero exit detection from tool_result\n\nBut this is weaker - agents could still game it.\n\n## Root Cause Evidence\n\nFrom commit 0328a6e logs, agent ran:\n```\nuvx ty check 2\u003e\u00261 | head -20     # Truncated!\nuvx ty check src/orchestrator.py  # File-specific to avoid errors!\n```\n\nQualityGate regex matched these and passed the gate despite 62 type errors in test files.\n\n## Acceptance Criteria\n\n- [ ] ValidationRunner integrated into post-commit flow\n- [ ] Gate fails if `uvx ty check` returns non-zero\n- [ ] Gate fails if pytest/ruff/format fail\n- [ ] Tests verify full validation actually runs\n\n## Files\n- src/orchestrator.py (integrate ValidationRunner)\n- src/quality_gate.py (or deprecate log-parsing approach)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-27T06:33:36.274895875Z","updated_at":"2025-12-27T06:36:30.720892188Z","closed_at":"2025-12-27T06:36:30.720892188Z","close_reason":"Duplicate of mala-yg9.2.4 which already covers wiring up ValidationRunner"}
{"id":"mala-5ot","title":"Remove unused sync methods from BeadsClient","description":"## Context\n- `BeadsClient` has both sync and async versions of all methods\n- Orchestrator exclusively uses async versions (`get_ready_async`, `claim_async`, etc.)\n- Sync methods add ~200 lines of duplicated logic\n- Confidence: High - grep confirms no production calls to sync methods\n\n## Primary Files\n`src/beads_client.py:82-278`\n\n## Scope\n**In:** Remove sync methods: `get_epic_children`, `get_ready`, `claim`, `reset`, `get_issue_status`, `commit_issues`, `close_eligible_epics`, `mark_needs_followup`\n**Out:** Keep async methods and `_run_subprocess_async` helper intact\n\n## Acceptance Criteria\n- All sync methods removed from BeadsClient\n- No import errors or missing references\n- All 221 tests pass\n\n## Test Plan\n- Run `uv run pytest`\n- Verify no import errors with `python -c \"from src.beads_client import BeadsClient\"`\n\n## Notes for Agent\n- Tests in `test_orchestrator.py` mock both sync and async methods - only async mocks matter\n- The `DEFAULT_COMMAND_TIMEOUT` constant is used by async methods, keep it","status":"closed","priority":2,"issue_type":"chore","created_at":"2025-12-26T19:44:50.439271516Z","updated_at":"2025-12-26T19:51:49.651613381Z","closed_at":"2025-12-26T19:51:49.651613381Z","close_reason":"Closed","labels":["dead-code"],"dependencies":[{"issue_id":"mala-5ot","depends_on_id":"mala-7zq","type":"parent-child","created_at":"2025-12-26T19:45:26.536295235Z","created_by":"daemon"}]}
{"id":"mala-5shj","title":"Auto-create beads issues from P2/P3 Cerberus review findings","description":"When Cerberus review returns P2/P3 issues, mala currently accepts the review but notes them for later tracking. This feature should automatically create beads issues from those P2/P3 findings so they are actually tracked and not forgotten.\n\nContext:\n- In src/lifecycle.py, P0/P1 issues block the review (priority \u003c= 1)\n- P2/P3 issues are accepted with message 'Review passed (N P2/P3 issues noted for later)'\n- The issues contain: file, line_start, line_end, priority, title, body, reviewer\n- These should become beads issues with appropriate priority mapping (P2→P2, P3→P3)\n\nImplementation notes:\n- After review passes with low-priority issues, call bd create for each\n- Include file:line reference in issue title/description\n- Link reviewer attribution in the issue body\n- Consider making this behavior configurable (--track-review-issues flag)","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-31T19:06:15.394486047Z","created_by":"cyou","updated_at":"2025-12-31T19:51:10.343260754Z","closed_at":"2025-12-31T19:51:10.343260754Z","close_reason":"Closed"}
{"id":"mala-5us","title":"Implement ValidationSpec + policy classification","description":"Context:\n- ValidationSpec and related types define what validations run per scope.\n- Policy classification (code vs docs) and disable list drive required commands.\n\nScope:\n- In: implement ValidationSpec/ValidationCommand/Context/Result/Artifacts/IssueResolution types; build ValidationSpec from inputs; code-change classification and disable list handling per plan.\n- Out: runner execution and orchestration (separate tasks).\n\nAcceptance Criteria:\n- ValidationSpec construction supports scope (per-issue vs run-level).\n- Code vs docs classification available as a helper.\n- Disable list values map to spec omissions as described in the plan.\n\nTest Plan:\n- TDD: add unit tests for spec building and classification before implementation.\n- Run unit tests for spec module.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T23:00:01.653337578Z","updated_at":"2025-12-26T23:45:40.848755874Z","closed_at":"2025-12-26T23:45:40.848755874Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-5us","depends_on_id":"mala-j6p","type":"blocks","created_at":"2025-12-26T23:00:26.454579505Z","created_by":"daemon"}]}
{"id":"mala-5x4w","title":"[Review] src/domain/validation/tool_name_extractor.py:130-139: [P2] Skip all set arguments to avoid false tool detection","description":"## Review Finding\n\nThis issue was auto-created from a P2 review finding.\n\n**Source issue:** mala-c7wb\n**Reviewer:** codex\n**Location:** src/domain/validation/tool_name_extractor.py:130-139\n\n## Details\n\n`set` is a shell built-in and does not execute a following command; all remaining words are arguments/positional parameters. The new logic stops at the first non-flag and returns it as a tool. Example: `set -- pytest -q \u0026\u0026 echo done` will extract `pytest` from the `set` segment and return it as the tool, even though nothing ran there and the operator handling returns the first meaningful tool. Consider consuming the rest of the tokens for `set` (or treating it as terminal) to avoid false positives.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T03:55:38.87207758Z","created_by":"cyou","updated_at":"2026-01-02T04:22:20.7108924Z","closed_at":"2026-01-02T04:22:20.7108924Z","close_reason":"Closed","labels":["auto_generated","review_finding","review_finding:43794d0d11f1","source:mala-c7wb"]}
{"id":"mala-67vp","title":"[Review] tests/test_code_pattern_matcher.py:51-62: [P2] Test for invalid pattern warning path is incomplete","description":"## Review Finding\n\nThis issue was auto-created from a P2 review finding.\n\n**Source issue:** mala-fdp1.6\n**Reviewer:** claude\n**Location:** tests/test_code_pattern_matcher.py:51-62\n\n## Details\n\nThe test `test_invalid_pattern_treated_as_literal` doesn't actually test the `re.error` exception path (lines 80-83 of the implementation). The test comments acknowledge this but doesn't provide an actual test. Since the implementation escapes all regex special chars before compilation, triggering `re.error` is difficult, but this means the error handling code is untested dead code. Consider either removing the try/except or finding a way to trigger it (e.g., via mocking).","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T03:15:34.517073504Z","created_by":"cyou","updated_at":"2026-01-02T03:21:30.456201061Z","closed_at":"2026-01-02T03:21:30.456201061Z","close_reason":"Closed","labels":["auto_generated","review_finding","review_finding:20497ddaa6c2","source:mala-fdp1.6"]}
{"id":"mala-698p","title":"[Review] src/orchestration/orchestrator.py:1215-1233: [P2] Propagate failed results to coordinator exclude list","description":"## Review Finding\n\nThis issue was auto-created from a P2 review finding.\n\n**Source issue:** mala-cavk.3\n**Reviewer:** codex\n**Location:** src/orchestration/orchestrator.py:1215-1233\n\n## Details\n\n`IssueExecutionCoordinator.run_loop` uses its own `failed_issues` set as `exclude_ids` when calling `get_ready_async`. In the new flow, the orchestrator only calls `mark_completed`, so issues that fail during execution (gate failure, agent error) are never added to the coordinator’s failed set. That means the provider can return the same failed issue again in the same run, causing repeated work or loops if the issue stays open. Consider marking failures in `finalize_callback` (e.g., when `result.success` is false) or have the coordinator exclude `completed_ids` as well.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T22:23:07.425262853Z","created_by":"cyou","updated_at":"2026-01-02T01:49:06.154094095Z","closed_at":"2026-01-02T01:49:06.154094095Z","close_reason":"Closed","labels":["auto_generated","review_finding","review_finding:3d119c8b5aca","source:mala-cavk.3"],"dependencies":[{"issue_id":"mala-698p","depends_on_id":"mala-i8ke","type":"blocks","created_at":"2026-01-01T23:03:58.862844682Z","created_by":"daemon"}]}
{"id":"mala-6a7","title":"Epic: Coverage 'No Decrease' Policy with Auto-Refresh Baseline","description":"Context:\n- Current CLI uses fixed 85% coverage threshold, which is inflexible\n- Goal: default behavior should prevent coverage from decreasing (not a fixed number)\n- Uses existing coverage.xml as baseline, with auto-refresh when missing/stale\n- Must handle parallel agents safely via locking and temp worktrees\n\nScope:\n- In: CLI option changes, coverage.py baseline functions, spec.py CoverageConfig, spec_runner.py auto-refresh logic, orchestrator.py signature\n- Out: pyproject.toml threshold (keep for direct pytest), legacy_runner changes\n\nAcceptance Criteria:\n- `bd run` without `--coverage-threshold` uses \"no decrease\" mode\n- Baseline auto-refreshes when missing or stale\n- Parallel agents don't corrupt baseline via locking\n- Parse errors fail loudly, missing baseline warns + refreshes\n\nNotes for Agent:\n- This is the umbrella epic; implement child issues in dependency order","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-27T18:20:55.598874949Z","updated_at":"2025-12-28T04:44:54.466282373Z","closed_at":"2025-12-28T04:44:54.466282373Z","close_reason":"All children completed"}
{"id":"mala-6a7.1","title":"Add baseline coverage functions to coverage.py","description":"Context:\n- `coverage.py` currently only parses and checks against fixed thresholds\n- Need new functions: `get_baseline_coverage()` and `is_baseline_stale()`\n- Must distinguish \"missing\" (returns None) from \"parse error\" (raises/fails)\n- Staleness detection: compare mtime vs last commit time + check dirty working tree\n\nScope:\n- In: Add `get_baseline_coverage(report_path: Path) -\u003e float | None`\n- In: Add `is_baseline_stale(report_path: Path, repo_path: Path) -\u003e bool`\n- In: Update `check_coverage_threshold` to accept `min_percent: float | None`\n- In: Update `parse_and_check_coverage` signature similarly\n- Out: Auto-refresh logic (that's in spec_runner.py)\n\nAcceptance Criteria:\n- `get_baseline_coverage()` returns percentage if file exists and valid, None if missing, raises on parse errors\n- `is_baseline_stale()` returns True if mtime \u003c last commit time OR repo is dirty\n- `is_baseline_stale()` handles non-git repos gracefully (returns True if git commands fail)\n- `check_coverage_threshold(result, None)` returns PASSED\n\nTest Plan:\n- TDD: Write failing tests for each new function\n- Test missing file → returns None\n- Test valid file → returns percentage\n- Test malformed XML → raises error\n- Test stale mtime → returns True\n- Test dirty repo → returns True\n- Test non-git repo → handles gracefully\n\nNotes for Agent:\n- Use `git log -1 --format=%ct` for last commit time\n- Use `git status --porcelain` to check dirty status\n- Wrap git commands in try/except for non-git fallback\n- Primary files: src/validation/coverage.py, tests/test_coverage.py","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T18:21:11.580596827Z","updated_at":"2025-12-28T03:22:57.898659634Z","closed_at":"2025-12-28T03:22:57.898659634Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-6a7.1","depends_on_id":"mala-6a7","type":"parent-child","created_at":"2025-12-27T18:21:11.587208102Z","created_by":"daemon"}]}
{"id":"mala-6a7.2","title":"Update CoverageConfig and pytest command in spec.py","description":"Context:\n- `CoverageConfig.min_percent` currently defaults to 85.0\n- Need to change default to None (meaning \"no decrease\" mode)\n- When `coverage_threshold is None`, must add `--cov-fail-under=0` to pytest command to override pyproject.toml\n\nScope:\n- In: Change `CoverageConfig.min_percent: float = 85.0` to `min_percent: float | None = None`\n- In: Update docstring to explain None = \"no decrease\" mode\n- In: In `build_validation_spec`, when `coverage_threshold is None`, add `--cov-fail-under=0` to pytest command\n- Out: Actual baseline comparison logic (that's in spec_runner.py)\n\nAcceptance Criteria:\n- `CoverageConfig(enabled=True)` has `min_percent=None` by default\n- Pytest command includes `--cov-fail-under=0` when threshold is None\n- Pytest command includes explicit threshold when provided\n- Docstrings updated\n\nTest Plan:\n- TDD: Test default CoverageConfig has min_percent=None\n- Test `build_validation_spec()` with no threshold → pytest includes `--cov-fail-under=0`\n- Test `build_validation_spec(coverage_threshold=80)` → pytest includes `--cov-fail-under=80`\n\nNotes for Agent:\n- The `--cov-fail-under=0` is needed to override pyproject.toml's `--cov-fail-under=85`\n- Keep existing coverage-related pytest flags (`--cov=src`, etc.)\n- Primary files: src/validation/spec.py, tests/test_spec.py","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T18:21:24.776545691Z","updated_at":"2025-12-28T03:29:44.503500832Z","closed_at":"2025-12-28T03:29:44.503500832Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-6a7.2","depends_on_id":"mala-6a7","type":"parent-child","created_at":"2025-12-27T18:21:24.783252376Z","created_by":"daemon"},{"issue_id":"mala-6a7.2","depends_on_id":"mala-6a7.1","type":"blocks","created_at":"2025-12-27T18:22:19.876162823Z","created_by":"daemon"}]}
{"id":"mala-6a7.3","title":"Implement baseline auto-refresh in spec_runner.py","description":"Context:\n- Must capture baseline from main repo BEFORE worktree creation\n- If baseline missing or stale, auto-refresh by running tests in temp worktree\n- Need locking to prevent parallel agents from clobbering\n- Must use same pytest args as validation spec\n\nScope:\n- In: Add `_refresh_baseline(spec, repo_path) -\u003e float` method\n- In: Before worktree setup in `run_validation_spec`, check/refresh baseline\n- In: Use file locking (existing locking.py) with double-check pattern\n- In: Pass `baseline_percent` to `_check_coverage`\n- In: Update `_check_coverage` to accept and use baseline_percent\n- Out: CLI changes, CoverageConfig changes (done in other issues)\n\nAcceptance Criteria:\n- Baseline captured from main repo before worktree creation\n- If baseline missing/stale, `_refresh_baseline` runs in temp worktree\n- Lock acquired before refresh, released after\n- Double-check pattern: re-verify staleness after acquiring lock\n- Temp worktree cleaned up after refresh\n- Atomic rename of coverage.xml to main repo\n- `_check_coverage` uses baseline_percent when min_percent is None\n\nTest Plan:\n- Test baseline captured before worktree setup\n- Test missing baseline triggers refresh\n- Test stale baseline triggers refresh\n- Test fresh baseline skips refresh\n- Test lock prevents concurrent refreshes\n- Mock worktree creation/cleanup\n\nNotes for Agent:\n- Use existing `create_worktree` from worktree.py\n- Use existing locking functions from locking.py\n- Run pytest with same args from spec, just override `--cov-fail-under=0`\n- Write to temp file, then `os.rename()` for atomic update\n- Primary file: src/validation/spec_runner.py","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T18:21:40.548034735Z","updated_at":"2025-12-28T04:07:15.465023394Z","closed_at":"2025-12-28T04:07:15.465023394Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-6a7.3","depends_on_id":"mala-6a7","type":"parent-child","created_at":"2025-12-27T18:21:40.555202907Z","created_by":"daemon"},{"issue_id":"mala-6a7.3","depends_on_id":"mala-6a7.1","type":"blocks","created_at":"2025-12-27T18:22:19.893411903Z","created_by":"daemon"},{"issue_id":"mala-6a7.3","depends_on_id":"mala-6a7.2","type":"blocks","created_at":"2025-12-27T18:22:19.90738317Z","created_by":"daemon"}]}
{"id":"mala-6a7.4","title":"Update CLI coverage-threshold option","description":"Context:\n- CLI currently has `--coverage-threshold` defaulting to 85.0\n- Need to change default to None\n- Validation logic must allow None (currently rejects non-0-100 values)\n\nScope:\n- In: Change `--coverage-threshold` default from `85.0` to `None`\n- In: Update help text to explain \"no decrease\" mode\n- In: Update validation to allow None (skip range check if None)\n- Out: Actual coverage logic (that's in coverage.py/spec_runner.py)\n\nAcceptance Criteria:\n- `--coverage-threshold` defaults to None\n- Help text mentions \"no decrease\" behavior\n- Running without `--coverage-threshold` doesn't error\n- Running with `--coverage-threshold 80` still works\n\nTest Plan:\n- Test CLI parses None default correctly\n- Test explicit threshold value works\n- Test help text is updated\n\nNotes for Agent:\n- Type should be `float | None` with default `None`\n- Skip the `0 \u003c= coverage_threshold \u003c= 100` check when None\n- Primary file: src/cli.py","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T18:21:51.768479029Z","updated_at":"2025-12-28T04:16:04.584178893Z","closed_at":"2025-12-28T04:16:04.584178893Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-6a7.4","depends_on_id":"mala-6a7","type":"parent-child","created_at":"2025-12-27T18:21:51.776699972Z","created_by":"daemon"},{"issue_id":"mala-6a7.4","depends_on_id":"mala-6a7.5","type":"blocks","created_at":"2025-12-27T18:25:07.340502685Z","created_by":"daemon"}]}
{"id":"mala-6a7.5","title":"Update orchestrator coverage_threshold type","description":"Context:\n- `MalaOrchestrator.__init__` accepts `coverage_threshold: float = 85.0`\n- Need to update type to `float | None = None` to match CLI\n\nScope:\n- In: Change `coverage_threshold` parameter type to `float | None = None`\n- Out: Any logic changes (just type signature update)\n\nAcceptance Criteria:\n- Orchestrator accepts None for coverage_threshold\n- Type hints updated\n- Passes value through to ValidationSpec correctly\n\nTest Plan:\n- Verify orchestrator instantiation with None works\n- Verify orchestrator instantiation with float works\n\nNotes for Agent:\n- Simple signature change, no logic changes needed\n- Primary file: src/orchestrator.py","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T18:21:59.927350234Z","updated_at":"2025-12-28T04:10:58.931642626Z","closed_at":"2025-12-28T04:10:58.931642626Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-6a7.5","depends_on_id":"mala-6a7","type":"parent-child","created_at":"2025-12-27T18:21:59.93766352Z","created_by":"daemon"},{"issue_id":"mala-6a7.5","depends_on_id":"mala-6a7.2","type":"blocks","created_at":"2025-12-27T18:25:07.327542248Z","created_by":"daemon"}]}
{"id":"mala-6a7.6","title":"Add tests for 'no decrease' coverage behavior","description":"Context:\n- Need integration-level tests for the full \"no decrease\" flow\n- Existing tests may need updates for new default behavior\n\nScope:\n- In: Add tests for \"no decrease\" mode end-to-end\n- In: Update existing tests that assume 85.0 default\n- Out: Core implementation (done in other issues)\n\nAcceptance Criteria:\n- Tests verify baseline is captured before validation\n- Tests verify auto-refresh when baseline missing\n- Tests verify coverage comparison against baseline\n- Existing tests pass with new defaults\n\nTest Plan:\n- Test \"no decrease\" mode with fresh baseline\n- Test \"no decrease\" mode with stale baseline triggers refresh\n- Test explicit threshold overrides baseline mode\n\nNotes for Agent:\n- May need to mock git commands for staleness tests\n- May need to mock worktree creation for refresh tests\n- Primary files: tests/test_spec.py, tests/test_coverage.py","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T18:22:09.331814334Z","updated_at":"2025-12-28T04:44:54.447831708Z","closed_at":"2025-12-28T04:44:54.447831708Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-6a7.6","depends_on_id":"mala-6a7","type":"parent-child","created_at":"2025-12-27T18:22:09.338662428Z","created_by":"daemon"},{"issue_id":"mala-6a7.6","depends_on_id":"mala-6a7.3","type":"blocks","created_at":"2025-12-27T18:22:19.946957118Z","created_by":"daemon"}]}
{"id":"mala-6ap","title":"Enhanced cleanup on early agent exit: git reset + reopen issue","description":"## Problem\nWhen agents exit early (context exhaustion, error, timeout, etc.), they may leave partial work in the git working tree and the issue in an inconsistent state (e.g., still marked as in_progress).\n\n## Current Behavior\n- Orchestrator calls `reset_issue()` which sets status back, but doesn't clean up git state\n- Partial file changes may remain uncommitted in the working tree\n- Next agent picking up the issue sees a dirty state\n\n## Proposed Solution\nOn early agent exit, the orchestrator should:\n\n1. **Reset git state**: Discard all uncommitted changes for files the agent touched\n   - `git checkout -- \u003cfiles\u003e` or `git restore \u003cfiles\u003e`\n   - Consider `git clean` for any new untracked files created by the agent\n   - Be careful not to discard work from other concurrent agents\n\n2. **Mark issue as open**: Use `bd update \u003cissue\u003e --status open` (not just reset to previous state)\n   - This makes it clear the issue needs to be picked up fresh\n\n3. **Release all locks**: Already done, but ensure it happens before git reset\n\n## Implementation Notes\n- Need to track which files the agent modified (from tool calls in JSONL log)\n- Or simpler: reset only files that match the issue's scope (if defined)\n- Safest approach: only reset files the agent held locks for\n\n## Acceptance Criteria\n- Early exit leaves working tree clean (no partial changes from failed agent)\n- Issue status is set to 'open' \n- Locks are released\n- Other agents' uncommitted work is not affected","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T17:08:40.391592982Z","updated_at":"2025-12-26T18:28:00.450472489Z","closed_at":"2025-12-26T18:28:00.450472489Z","close_reason":"Merged into mala-b0m (Graceful shutdown with agent wrap-up)"}
{"id":"mala-6c0","title":"Enforce single mala run per directory with lock file","description":"Context:\n- Running multiple mala instances in the same directory can cause conflicts.\n- Need a lock mechanism to prevent concurrent runs.\n\nScope:\n- In: create lock file on run start; check for existing lock; fail fast if locked.\n- Out: distributed locking; cross-machine coordination.\n\nAcceptance Criteria:\n- Second mala run in same directory fails immediately with clear error message.\n- Lock file is cleaned up on normal exit.\n- Stale locks (from crashed runs) are detected and can be overridden with --force.\n\nTest Plan:\n- Manual: start two runs in same dir, verify second fails.\n- Unit: mock lock file operations.","status":"blocked","priority":0,"issue_type":"feature","created_at":"2025-12-27T01:11:27.170231152Z","updated_at":"2025-12-28T06:24:59.132667763Z"}
{"id":"mala-6dgv","title":"[Review] src/pipeline/agent_session_runner.py:526-743: [P2] Missing unit tests for extracted helpers","description":"## Review Finding\n\nThis issue was auto-created from a P2 review finding.\n\n**Source issue:** mala-cavk.4\n**Reviewer:** gemini\n**Location:** src/pipeline/agent_session_runner.py:526-743\n\n## Details\n\nThe acceptance criteria for this epic explicitly require 'New unit tests for extracted helpers'. While the refactoring successfully reduces the line count of `run_session` from 262 to 39 lines (satisfying the primary line-count goal), this commit does not include any new tests for the newly extracted methods (`_initialize_session`, `_run_lifecycle_loop`, `_handle_gate_check`, `_handle_review_check`, `_build_session_output`). Adding unit tests for these components is necessary to ensure the refactor is fully verified and compliant with the epic's requirements.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T22:35:35.188851751Z","created_by":"cyou","updated_at":"2026-01-02T02:06:07.737279028Z","closed_at":"2026-01-02T02:06:07.737279028Z","close_reason":"Closed","labels":["auto_generated","review_finding","review_finding:3be8d5669704","source:mala-cavk.4"],"dependencies":[{"issue_id":"mala-6dgv","depends_on_id":"mala-actw","type":"blocks","created_at":"2026-01-01T23:31:14.934932198Z","created_by":"daemon"},{"issue_id":"mala-6dgv","depends_on_id":"mala-rmxf","type":"blocks","created_at":"2026-01-01T23:31:14.966743103Z","created_by":"daemon"}]}
{"id":"mala-6hp","title":"Add CLAUDE.md/AGENTS.md context loading for Agent SDK apps","description":"Agent SDK applications should optionally load and incorporate CLAUDE.md or AGENTS.md files into their context, similar to how Claude Code automatically reads these files for project-specific instructions.\n\nThis would allow:\n- Consistent behavior between Claude Code and Agent SDK apps\n- Project-specific instructions to apply to custom agents\n- Reuse of existing CLAUDE.md files in Agent SDK applications\n\nBlocked on: Determining the best API design for this feature (should it be automatic, opt-in, or configurable?)","status":"blocked","priority":4,"issue_type":"feature","created_at":"2025-12-27T20:00:05.349091312Z","updated_at":"2025-12-28T06:25:04.584519195Z"}
{"id":"mala-6iv","title":"Test: add hello comment to pyproject.toml","status":"tombstone","priority":2,"issue_type":"task","created_at":"2025-12-25T19:03:17.354821017Z","updated_at":"2025-12-25T19:05:18.077405908Z","close_reason":"Closed","deleted_at":"2025-12-25T19:05:18.077405908Z","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"mala-6m0","title":"Remove dist artifacts from repo","description":"Context:\n- Built artifacts in dist/ are checked into the repo and can become stale or misleading.\n\nScope:\n- In: remove dist artifacts from git and add root .gitignore entries to prevent re-addition.\n- Out: changes to build scripts or release process.\n\nAcceptance Criteria:\n- dist/ artifacts are removed from version control.\n- dist/ is ignored at repo root.\n\nTest Plan:\n- `git status` is clean after removal; building still produces artifacts locally.","status":"closed","priority":4,"issue_type":"chore","created_at":"2025-12-26T17:36:09.569995213Z","updated_at":"2025-12-26T18:41:25.970765111Z","closed_at":"2025-12-26T18:41:25.970765111Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-6m0","depends_on_id":"mala-jnq","type":"parent-child","created_at":"2025-12-26T17:36:15.744955272Z","created_by":"daemon"}]}
{"id":"mala-6v0w","title":"[Review] src/domain/validation/config.py:105-109: [P3] Reject boolean timeout values in CommandConfig","description":"## Review Finding\n\nThis issue was auto-created from a P3 review finding.\n\n**Source issue:** mala-fdp1.1\n**Reviewer:** codex\n**Location:** src/domain/validation/config.py:105-109\n\n## Details\n\n`bool` is a subclass of `int`, so a YAML value like `timeout: true` passes the `isinstance(timeout, int)` check and becomes a 1-second timeout instead of raising a config error. That’s a silent misconfiguration. Consider rejecting booleans explicitly (e.g., `isinstance(timeout, bool)` or `type(timeout) is int`).","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-02T03:19:13.881432152Z","created_by":"cyou","updated_at":"2026-01-02T03:45:14.194503004Z","closed_at":"2026-01-02T03:45:14.194503004Z","close_reason":"Closed","labels":["auto_generated","review_finding","review_finding:aef0c433e009","source:mala-fdp1.1"]}
{"id":"mala-6wen","title":"[Review] src/orchestration/orchestrator.py:543-547: [P2] Include exception details in finalization warning","description":"## Review Finding\n\nThis issue was auto-created from a P2 review finding.\n\n**Source issue:** mala-mfnr\n**Reviewer:** claude\n**Location:** src/orchestration/orchestrator.py:543-547\n\n## Details\n\nThe caught exception is discarded without logging its message or traceback. This makes debugging difficult when `_finalize_issue_result` fails. Capture the exception with `except Exception as e:` and include it in the warning message, e.g.:\n```python\nexcept Exception as e:\n    self.event_sink.on_warning(\n        f\"Failed to finalize remediation result for {issue_id}: {e}\",\n```","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T02:17:45.104276387Z","created_by":"cyou","updated_at":"2026-01-02T02:19:58.047300382Z","closed_at":"2026-01-02T02:19:58.047300382Z","close_reason":"Closed","labels":["auto_generated","review_finding","review_finding:73aa721c3b73","source:mala-mfnr"]}
{"id":"mala-720s","title":"[Review] src/infra/clients/cerberus_review.py:255-258: [P3] Use user-facing terminology in fatal error message","description":"## Review Finding\n\nThis issue was auto-created from a P3 review finding.\n\n**Source issue:** mala-awsa\n**Reviewer:** gemini\n**Location:** src/infra/clients/cerberus_review.py:255-258\n\n## Details\n\nThe fatal error message includes technical justification ('cannot auto-resolve without session scoping') that may be confusing to end users. Consider a more actionable message like: 'Another review gate is already active. Please wait for the current run to finish or resolve it manually using `review-gate resolve` if you are certain no other runs are active.'","notes":"Quality gate failed: External review failed: spawn failed: Artifact written: /home/cyou/.claude/projects/-home-cyou-mala/cerberus/7b38713e-813e-4a50-8c59-4aff423d849e/latest.md\nReview gate already active (status: pending, age: 24s)\nUse /home/cyou/.claude/plugins/cache/cerberus/cerberus/1.10.6/bin/review-gate resolve to complete the existing gate first.\nLog: /home/cyou/.claude/projects/-home-cyou-mala/7b38713e-813e-4a50-8c59-4aff423d849e.jsonl","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-01T23:55:18.815108514Z","created_by":"cyou","updated_at":"2026-01-02T00:48:32.831997342Z","closed_at":"2026-01-02T00:48:32.831997342Z","close_reason":"Closed","labels":["auto_generated","needs-followup","review_finding","review_finding:4d81bd7daf78","source:mala-awsa"]}
{"id":"mala-77z","title":"Remove unused log_result function","description":"## Context\n- `log_result()` is defined but never imported or called anywhere\n- Orchestrator uses `log()` with \"✓\" and \"✗\" icons directly instead\n- ~12 lines of dead code\n- Confidence: High - grep shows only the definition, no callers\n\n## Primary Files\n`src/logging/console.py:263-274`\n\n## Scope\n**In:** Delete the `log_result` function\n**Out:** Keep all other logging functions\n\n## Acceptance Criteria\n- Function removed\n- No import errors or reference breaks\n- Tests pass\n\n## Test Plan\n- Run `uv run pytest`\n- Verify: `python -c \"from src.logging.console import log, log_tool, log_agent_text\"`\n\n## Notes for Agent\n- Function is at lines 263-274, after `log_agent_text`\n- No tests reference this function","status":"closed","priority":2,"issue_type":"chore","created_at":"2025-12-26T19:45:05.56975816Z","updated_at":"2025-12-26T19:53:05.087656466Z","closed_at":"2025-12-26T19:53:05.087656466Z","close_reason":"Closed","labels":["dead-code"],"dependencies":[{"issue_id":"mala-77z","depends_on_id":"mala-7zq","type":"parent-child","created_at":"2025-12-26T19:45:26.566257822Z","created_by":"daemon"}]}
{"id":"mala-781","title":"Package prompt file and align Python requirement","description":"Context:\n- Orchestrator reads the implementer prompt at import; missing files in the wheel will crash CLI startup.\n- Current build config doesn’t explicitly include prompt files in artifacts.\n- requires-python is set to \u003e=3.14 even though the codebase doesn’t appear to need it.\n- Needs verification: confirm wheel contents and the actual minimum supported Python version.\n\nScope:\n- In: include src/prompts/implementer_prompt.md in wheel build config and lower requires-python to the agreed minimum (likely 3.11/3.12).\n- Out: changing prompt content or runtime loading semantics.\n\nAcceptance Criteria:\n- Built wheel contains the prompt file and importing src.orchestrator succeeds.\n- Package installs on the agreed minimum Python version.\n\nTest Plan:\n- Build a wheel and verify prompt file inclusion; run a simple import or `mala status` in a venv.\n\nNotes for Agent:\n- Keep changes isolated to packaging config unless a fallback is required.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-26T17:35:34.45601593Z","updated_at":"2025-12-26T18:20:25.115815935Z","closed_at":"2025-12-26T18:20:25.115815935Z","close_reason":"False positive: hatchling's packages=[\"src\"] includes all files (not just .py), so prompt is already in wheel. Only requires-python issue remains valid but is minor.","dependencies":[{"issue_id":"mala-781","depends_on_id":"mala-jnq","type":"parent-child","created_at":"2025-12-26T17:36:15.690597316Z","created_by":"daemon"}]}
{"id":"mala-784","title":"Ideas: Future improvements","description":"Brainstorm ideas needing grooming:\n- Add back claude orchestrator, manually managing context\n- Agent mail using filesystem?\n- Use codex for code review?\n- Make morphllm optional","status":"tombstone","priority":2,"issue_type":"epic","created_at":"2025-12-26T00:54:39.176848025Z","updated_at":"2025-12-26T00:55:27.983470092Z","deleted_at":"2025-12-26T00:55:27.983470092Z","deleted_by":"daemon","delete_reason":"delete","original_type":"epic"}
{"id":"mala-7a6","title":"Baseline commit lost on session resume: Codex review sees partial diff","description":"## Problem\n\nWhen an issue is partially completed in a prior session (e.g., agent made commits but gate/review failed), a new orchestrator session captures a NEW baseline from current HEAD. This means the cumulative diff only includes changes from the current session, not the full implementation.\n\n### Scenario\n\n1. **Session 1**: Issue claimed, baseline = commit A\n2. **Session 1**: Agent creates commits B, C (partial implementation)\n3. **Session 1**: Gate/review fails, session ends\n4. **Session 2**: New orchestrator run, baseline = commit C (prior work!)\n5. **Session 2**: Agent creates commit D (fix)\n6. **Session 2**: Codex reviews diff C..D — **misses work in B and C!**\n\n### Root Cause\n\n`baseline_commit_hash` is captured fresh in `run_implementer()` at session start, stored only in `RetryState` (in-memory). Not persisted across orchestrator runs.\n\n## Solution\n\nDerive baseline from git history instead of capturing at session start:\n\n```python\ndef get_baseline_for_issue(repo_path: Path, issue_id: str) -\u003e str | None:\n    # Find first commit with \"bd-{issue_id}:\" prefix\n    result = subprocess.run(\n        [\"git\", \"log\", \"--oneline\", \"--reverse\", f\"--grep=^bd-{issue_id}:\"],\n        capture_output=True, text=True, cwd=repo_path\n    )\n    if result.stdout.strip():\n        first_commit = result.stdout.strip().split('\\n')[0].split()[0]\n        # Get its parent\n        parent = subprocess.run(\n            [\"git\", \"rev-parse\", f\"{first_commit}^\"],\n            capture_output=True, text=True, cwd=repo_path\n        )\n        return parent.stdout.strip() if parent.returncode == 0 else None\n    return None  # No commits yet for this issue\n```\n\nLogic in `run_implementer()`:\n- If git history has commits for this issue → use parent of first commit as baseline\n- If no commits yet → capture current HEAD as baseline (fresh issue)\n\n### Why git history approach\n\n1. Git is source of truth - always accurate\n2. Works retroactively for existing in-progress issues  \n3. No beads schema changes or notes parsing\n4. Self-healing if metadata gets corrupted\n5. Handles edge cases (parallel agents, rebases) naturally\n\n## In Scope\n\n- `src/git_utils.py`: Add `get_baseline_for_issue()` async function\n- `src/orchestrator.py`: Update `run_implementer()` to use git-derived baseline\n- Tests: TDD approach - write tests first for:\n  - Fresh issue (no prior commits) → captures HEAD\n  - Resumed issue (has prior commits) → finds parent of first commit\n  - Edge cases: merge commits, rebased history, no parent (root commit)\n\n## Out of Scope\n\n- Persisting baseline in beads notes (simpler git approach preferred)\n- Changes to beads schema\n- Codex prompt changes (already handles baseline correctly when provided)\n\n## Implementation Notes\n\n**Use TDD approach:**\n1. Write failing tests first for `get_baseline_for_issue()`\n2. Write failing tests for orchestrator integration\n3. Implement to make tests pass\n4. Refactor as needed\n\n## Acceptance Criteria\n\n- [ ] Resumed sessions use correct baseline (parent of first issue commit)\n- [ ] Fresh issues still capture HEAD as baseline\n- [ ] Codex review sees cumulative diff across sessions\n- [ ] Tests cover fresh, resumed, and edge case scenarios","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-12-27T23:49:29.153535606Z","updated_at":"2025-12-28T00:55:16.085961516Z","closed_at":"2025-12-28T00:55:16.085961516Z","close_reason":"Closed"}
{"id":"mala-7jj","title":"CLI tool for mala run performance analysis","description":"Context:\n- Currently, analyzing mala run performance requires ad-hoc Python scripts\n- Key metrics needed: token usage, context accumulation, duration, success rates, headroom analysis\n- Data sources: ~/.config/mala/runs/*.json (run metadata) and Claude JSONL logs (token usage)\n\nScope:\n- In: CLI command `mala analyze` (or similar) that queries local run data\n- In: Summary stats (min/median/mean/max) for: final context tokens, duration, success rate\n- In: Context headroom analysis (% of 200K limit used)\n- In: Top N issues by token consumption\n- In: Filtering by time range (e.g., --last 1d, --last 7d)\n- Out: Braintrust integration (separate concern)\n- Out: Real-time monitoring (this is post-hoc analysis)\n\nAcceptance Criteria:\n- mala analyze shows summary statistics for recent runs\n- mala analyze --last 1d filters to last 24 hours\n- mala analyze --top 10 shows top 10 issues by token usage\n- mala analyze --context shows context headroom distribution\n- Output is formatted for terminal (not JSON by default, but --json flag available)\n\nTest Plan:\n- Unit tests for log parsing and aggregation logic\n- Integration test with sample run/log fixtures\n- Manual verification against known run data\n\nNotes for Agent:\n- Token calculation: input_tokens + cache_creation_input_tokens + cache_read_input_tokens\n- Run files are in ~/.config/mala/runs/*.json\n- Log files are referenced in run JSON as issues.\u003cid\u003e.log_path\n- Usage data is in JSONL entries at entry.message.usage","status":"blocked","priority":2,"issue_type":"feature","created_at":"2025-12-27T18:08:15.379697993Z","updated_at":"2025-12-28T06:25:01.727052734Z"}
{"id":"mala-7m1","title":"Support non-Python repos in validation","description":"Currently mala assumes all repos are Python projects and requires uv sync, ruff, pytest, ty validation commands.\n\n## Future Improvements\n\n### 1. Detect project type\nSkip Python validation for non-Python repos (check for pyproject.toml existence). Could also detect other project types (Node.js via package.json, Go via go.mod, etc.) and run appropriate validation.\n\n### 2. Per-repo validation config\nAllow repos to specify their own validation commands via:\n- CLAUDE.md directives\n- .beads/validation.yaml\n- pyproject.toml [tool.mala] section\n\n## Context\nDiscovered when ai-configs-464.1 (a shell script repo) failed quality gate due to missing 'uv sync' - there's no pyproject.toml because it's not a Python project.\n\n## References\n- src/validation/spec.py:build_validation_spec() - hardcodes Python commands\n- src/quality_gate.py:ValidationEvidence - hardcodes Python evidence checks","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T20:30:11.760932242Z","updated_at":"2025-12-27T20:36:17.101092438Z","closed_at":"2025-12-27T20:36:17.101092438Z","close_reason":"Merged into parent epic mala-ytn","dependencies":[{"issue_id":"mala-7m1","depends_on_id":"mala-ytn","type":"parent-child","created_at":"2025-12-27T20:36:11.439535313Z","created_by":"daemon"}]}
{"id":"mala-7pd","title":"Remove Edit from FILE_WRITE_TOOLS (redundant)","description":"## Context\n- `FILE_WRITE_TOOLS` includes `\"Edit\"` for lock enforcement\n- `MORPH_DISALLOWED_TOOLS` also lists `\"Edit\"`, blocking it before lock check runs\n- Lock enforcement hook never triggers for Edit - redundant entry\n- Confidence: Medium - logic is correct but relies on hook ordering\n\n## Primary Files\n`src/hooks.py:50-57`\n\n## Scope\n**In:** Remove `\"Edit\"` from `FILE_WRITE_TOOLS` constant\n**Out:** Don't change `MORPH_DISALLOWED_TOOLS` or lock enforcement logic\n\n## Acceptance Criteria\n- `\"Edit\"` removed from `FILE_WRITE_TOOLS`\n- `\"Edit\"` removed from `FILE_PATH_KEYS` dict\n- Test `test_file_write_tools_constant_contains_expected_tools` updated\n- All tests pass\n\n## Test Plan\n- Run `uv run pytest tests/test_hooks.py`\n- Run full suite: `uv run pytest`\n\n## Notes for Agent\n- Also remove `\"Edit\"` from `FILE_PATH_KEYS` dict (line 61) since it won't be checked\n- Update test in `test_hooks.py:120-124` to not expect `Edit` in the set","status":"closed","priority":3,"issue_type":"chore","created_at":"2025-12-26T19:45:13.913074646Z","updated_at":"2025-12-26T19:50:02.12412912Z","closed_at":"2025-12-26T19:50:02.12412912Z","close_reason":"Closed","labels":["consistency"],"dependencies":[{"issue_id":"mala-7pd","depends_on_id":"mala-7zq","type":"parent-child","created_at":"2025-12-26T19:45:26.577618753Z","created_by":"daemon"}]}
{"id":"mala-7rt","title":"Worktree mode support","description":"Add git worktree support for parallel agent work","status":"blocked","priority":4,"issue_type":"feature","created_at":"2025-12-28T06:21:39.000904646Z","updated_at":"2025-12-28T06:25:04.544272807Z"}
{"id":"mala-7si","title":"Epic: Healthcheck cleanup (2025-12-28)","description":"## Context\nHealthcheck from 2025-12-28 identified incomplete migrations and minor issues.\n\n## Findings from mala-869 (Architecture epic)\nThree modules were created but never integrated:\n- event_sink.py - MalaEventSink protocol (DEFERRED - too large)\n- telemetry.py - TelemetryProvider protocol (small fix)\n- config.py - MalaConfig dataclass (medium fix)\n\n## Other Findings\n- Dist artifacts still exist despite mala-w8w.3 being closed\n- Tool name case sensitivity issue in session_log_parser.py\n\n## Acceptance Criteria\n- TelemetryProvider injected into orchestrator\n- MalaConfig injected into orchestrator and CLI\n- Tool name case sensitivity fixed\n- Dist directory clean\n- Event_sink epic documented for future consideration\n\n## Execution Order\n1. mala-7si.2 (telemetry) - no blockers\n2. mala-7si.5 (config) - blocked by telemetry (file overlap)\n3. mala-7si.3 (case sensitivity) - parallel with above\n4. mala-7si.4 (dist artifacts) - parallel with above\n\n## Out of Scope\n- Full event_sink migration (deferred as mala-7si.1)","notes":"Combined under mala-3qp epic.","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-28T22:06:30.51180045Z","created_by":"cyou","updated_at":"2025-12-30T04:25:34.989833297Z","closed_at":"2025-12-30T04:25:34.989833297Z","close_reason":"Closed"}
{"id":"mala-7si.1","title":"Epic: Inject MalaEventSink into orchestrator","description":"## Context\n- `mala-869.17` created MalaEventSink protocol but follow-up to inject into orchestrator was never done\n- Goal: Decouple orchestrator from console logging for testability\n- Currently orchestrator directly calls log(), log_tool(), log_agent_text() (131 log-related lines)\n\n## Complexity Assessment\nThis is a large migration:\n- 131 log calls need mapping to ~30 event sink methods\n- Need to create ConsoleEventSink (doesn't exist)\n- RunConfig naming collision: event_sink.RunConfig vs run_metadata.RunConfig\n- All-or-nothing: partial migration provides zero testability benefit\n- 3811 lines of orchestrator tests already work without this\n\n## Subtasks Needed (if pursued)\n1. Resolve RunConfig naming collision\n2. Create ConsoleEventSink wrapping current log functions\n3. Add event_sink parameter to MalaOrchestrator\n4. Migrate lifecycle log calls to sink events\n5. Migrate agent log calls to sink events\n6. Migrate gate/review log calls to sink events\n7. Migrate warning/diagnostic log calls to sink events\n\n## Decision\nDeferred to P4. Current tests work fine. Revisit if testability becomes a real problem.\n\n## Primary Files\n- src/orchestrator.py\n- src/event_sink.py\n\n## Acceptance Criteria\n- All subtasks completed\n- Orchestrator emits ALL output through event sink\n- NullEventSink enables silent test execution\n\n[Added Context]\n- Codebase still uses console logging directly in src/orchestrator.py via log/log_tool/log_agent_text (~100+ call sites)\n- src/event_sink.py defines MalaEventSink + NullEventSink but no ConsoleEventSink exists\n- Recommend doing this after orchestrator pipeline extraction (mala-3qp.6.4) to reduce churn\n","status":"closed","priority":4,"issue_type":"epic","created_at":"2025-12-28T22:06:43.782262444Z","created_by":"cyou","updated_at":"2025-12-30T04:24:12.287383624Z","closed_at":"2025-12-30T04:24:12.287383624Z","close_reason":"All children completed","dependencies":[{"issue_id":"mala-7si.1","depends_on_id":"mala-7si","type":"parent-child","created_at":"2025-12-28T22:06:43.789175677Z","created_by":"daemon"},{"issue_id":"mala-7si.1","depends_on_id":"mala-3qp.6.4","type":"blocks","created_at":"2025-12-29T15:35:31.32178513Z","created_by":"daemon"}]}
{"id":"mala-7si.1.1","title":"Event sink: add ConsoleEventSink + resolve RunConfig collision","description":"## Context\n- src/event_sink.py defines MalaEventSink + NullEventSink but no ConsoleEventSink exists\n- src/event_sink.py also defines RunConfig which collides with logging.run_metadata.RunConfig\n- Orchestrator still logs directly; a console sink is needed before migration\n\n## Primary Files\n- src/event_sink.py\n- src/event_sink_console.py (new)\n- src/logging/console.py\n\n## Scope\n**In:** Add ConsoleEventSink implementing MalaEventSink using existing console log helpers\n**In:** Resolve RunConfig naming collision (rename in event_sink or export alias)\n**Out:** Modifying orchestrator or changing logging formats\n\n## Acceptance Criteria\n- ConsoleEventSink exists and implements all MalaEventSink methods\n- RunConfig naming collision is resolved (no ambiguous RunConfig import in orchestrator)\n- No behavior changes yet (orchestrator still logs directly)\n\n## Test Plan\n- Add a smoke test that instantiates ConsoleEventSink and calls representative methods (monkeypatch log/log_tool/log_agent_text)\n- Run `uv run pytest`\n\n## Notes for Agent\n- Keep console formatting identical by reusing logging/console helpers\n- Prefer renaming event_sink.RunConfig to EventRunConfig (or similar) to avoid clashes\n","status":"closed","priority":4,"issue_type":"task","created_at":"2025-12-29T15:40:07.495706178Z","created_by":"cyou","updated_at":"2025-12-30T00:19:55.069028743Z","closed_at":"2025-12-30T00:19:55.069028743Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-7si.1.1","depends_on_id":"mala-7si.1","type":"parent-child","created_at":"2025-12-29T15:40:07.505797977Z","created_by":"daemon"}]}
{"id":"mala-7si.1.2","title":"Orchestrator: wire event sink for run lifecycle logs","description":"## Context\n- Orchestrator still logs run lifecycle events directly via log()\n- With ConsoleEventSink available, run-level events can be routed through the sink\n\n## Primary Files\n- src/orchestrator.py\n- src/event_sink_console.py\n- src/event_sink.py\n\n## Scope\n**In:** Add event_sink parameter to MalaOrchestrator with default ConsoleEventSink\n**In:** Replace run lifecycle logs (run started, ready issues, waiting, no more issues, run completed) with sink events\n**Out:** Changing run behavior or log content\n\n## Acceptance Criteria\n- MalaOrchestrator accepts optional event_sink and defaults to ConsoleEventSink\n- Run lifecycle log calls are replaced by event_sink methods\n- Console output remains unchanged with default sink\n\n## Test Plan\n- Add a test using a fake sink to assert run lifecycle events are emitted\n- Run `uv run pytest`\n\n## Notes for Agent\n- Avoid duplicating output (remove direct log() calls once sink is used)\n- Keep sink calls non-blocking and synchronous\n","notes":"Quality gate failed: Codex review failed: /home/cyou/mala/src/orchestrator.py:1023: [P2] Commit/metadata console lines are now suppressed or changed under the default sink; /home/cyou/mala/src/orchestrator.py:942: [P3] on_ready_issues receives a list that is immediately mutated\nLog: /home/cyou/.claude/projects/-home-cyou-mala/d5c7c053-4701-4860-b815-5c5285f433f5.jsonl","status":"closed","priority":4,"issue_type":"task","created_at":"2025-12-29T15:40:21.389957102Z","created_by":"cyou","updated_at":"2025-12-30T02:10:20.391933808Z","closed_at":"2025-12-30T02:10:20.391933808Z","close_reason":"Closed","labels":["needs-followup"],"dependencies":[{"issue_id":"mala-7si.1.2","depends_on_id":"mala-7si.1","type":"parent-child","created_at":"2025-12-29T15:40:21.399160417Z","created_by":"daemon"},{"issue_id":"mala-7si.1.2","depends_on_id":"mala-7si.1.1","type":"blocks","created_at":"2025-12-29T15:41:16.34066354Z","created_by":"daemon"},{"issue_id":"mala-7si.1.2","depends_on_id":"mala-3qp.6.4","type":"blocks","created_at":"2025-12-29T15:41:21.371744994Z","created_by":"daemon"}]}
{"id":"mala-7si.1.3","title":"Orchestrator: migrate agent lifecycle + streaming logs to sink","description":"## Context\n- Agent lifecycle and streaming output are logged directly via log_agent_text/log_tool/log()\n- This output should be routed through the event sink for testability\n\n## Primary Files\n- src/orchestrator.py\n- src/event_sink_console.py\n\n## Scope\n**In:** Replace agent lifecycle logs (agent started/completed/claim failed) with sink events\n**In:** Route tool usage + agent text streaming through sink methods\n**Out:** Changing SDK integration or log formatting\n\n## Acceptance Criteria\n- All agent lifecycle and streaming log calls are replaced by event_sink calls\n- Console output remains unchanged with ConsoleEventSink\n\n## Test Plan\n- Add a test using a fake sink to assert agent events and tool/text events are emitted\n- Run `uv run pytest`\n\n## Notes for Agent\n- Keep truncation behavior consistent by reusing console helpers in the sink\n","status":"closed","priority":4,"issue_type":"task","created_at":"2025-12-29T15:40:34.85849573Z","created_by":"cyou","updated_at":"2025-12-30T03:05:45.141158874Z","closed_at":"2025-12-30T03:05:45.141158874Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-7si.1.3","depends_on_id":"mala-7si.1","type":"parent-child","created_at":"2025-12-29T15:40:34.867420567Z","created_by":"daemon"},{"issue_id":"mala-7si.1.3","depends_on_id":"mala-7si.1.2","type":"blocks","created_at":"2025-12-29T15:41:26.40026671Z","created_by":"daemon"}]}
{"id":"mala-7si.1.4","title":"Orchestrator: migrate gate/review/fixer logs to sink","description":"## Context\n- Gate/review/fixer flows log directly to console within orchestrator\n- These should emit structured sink events for testability and alternate sinks\n\n## Primary Files\n- src/orchestrator.py\n- src/event_sink_console.py\n\n## Scope\n**In:** Replace gate logs (start/pass/fail/retry/result) with sink events\n**In:** Replace review logs (start/retry/pass) with sink events\n**In:** Replace fixer logs (start/complete/fail) with sink events\n**Out:** Changing gate/review policy or retry behavior\n\n## Acceptance Criteria\n- Gate/review/fixer log calls are fully routed through event sink\n- Console output remains unchanged with ConsoleEventSink\n\n## Test Plan\n- Add a test using a fake sink to assert gate/review/fixer events are emitted\n- Run `uv run pytest`\n\n## Notes for Agent\n- Avoid emitting both sink and direct log calls\n","notes":"Quality gate failed: Codex review failed: /home/cyou/mala/src/pipeline/agent_session_runner.py:603: [P2] Gate/review start messages no longer appear in non-verbose runs; /home/cyou/mala/src/event_sink_console.py:297: [P3] Gate retries now print failure reasons on every attempt\nLog: /home/cyou/.claude/projects/-home-cyou-mala/7777348a-3a78-4473-995e-24f43d03fb39.jsonl","status":"closed","priority":4,"issue_type":"task","created_at":"2025-12-29T15:40:48.964887082Z","created_by":"cyou","updated_at":"2025-12-30T04:04:31.79574809Z","closed_at":"2025-12-30T04:04:31.79574809Z","close_reason":"Closed","labels":["needs-followup"],"dependencies":[{"issue_id":"mala-7si.1.4","depends_on_id":"mala-7si.1","type":"parent-child","created_at":"2025-12-29T15:40:48.975462167Z","created_by":"daemon"},{"issue_id":"mala-7si.1.4","depends_on_id":"mala-7si.1.3","type":"blocks","created_at":"2025-12-29T15:41:31.436148248Z","created_by":"daemon"}]}
{"id":"mala-7si.1.5","title":"Orchestrator: migrate warnings/diagnostics logs to sink","description":"## Context\n- Warnings, diagnostics, lock cleanup, and metadata messages still log directly to console\n- These should route through the event sink for full decoupling\n\n## Primary Files\n- src/orchestrator.py\n- src/event_sink_console.py\n\n## Scope\n**In:** Replace warning/diagnostic logs (timeouts, lock cleanup/release, metadata saved, issues committed) with sink events\n**Out:** Changing error handling or log message content\n\n## Acceptance Criteria\n- All remaining diagnostic/warning log calls use event sink\n- No direct log() calls remain in orchestrator (except possibly in CLI or other modules)\n- Console output remains unchanged with ConsoleEventSink\n\n## Test Plan\n- Add a test using a fake sink to assert diagnostic events are emitted\n- Run `uv run pytest`\n\n## Notes for Agent\n- Verify remaining log() calls in orchestrator are eliminated after this step\n","status":"closed","priority":4,"issue_type":"task","created_at":"2025-12-29T15:41:02.380545492Z","created_by":"cyou","updated_at":"2025-12-30T04:24:12.274050067Z","closed_at":"2025-12-30T04:24:12.274050067Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-7si.1.5","depends_on_id":"mala-7si.1","type":"parent-child","created_at":"2025-12-29T15:41:02.391032208Z","created_by":"daemon"},{"issue_id":"mala-7si.1.5","depends_on_id":"mala-7si.1.4","type":"blocks","created_at":"2025-12-29T15:41:36.462025059Z","created_by":"daemon"}]}
{"id":"mala-7si.2","title":"Inject TelemetryProvider into orchestrator","description":"## Context\n- `mala-869.8` created TelemetryProvider protocol but follow-up to inject it was never done\n- Goal: Abstract telemetry for testability and programmatic control\n- Currently uses TracedAgentExecution directly from braintrust_integration.py (one call site: line 782)\n- telemetry.py already has complete BraintrustProvider wrapping TracedAgentExecution\n\n## Primary Files\n- src/orchestrator.py (add provider parameter, change one call site)\n- src/telemetry.py (already complete - no changes needed)\n\n## Scope\n**In:** Inject TelemetryProvider into MalaOrchestrator; use provider.create_span() instead of TracedAgentExecution directly\n**Out:** Removing global SDK patching (may still be needed for auto-instrumentation)\n\n## Acceptance Criteria\n- MalaOrchestrator accepts optional telemetry_provider parameter\n- Default to BraintrustProvider() when braintrust_enabled=True, else NullTelemetryProvider()\n- NullTelemetryProvider can be used in tests\n- Existing tracing behavior unchanged\n\n## Test Plan\n- Add test using NullTelemetryProvider to verify no telemetry side effects\n- Verify Braintrust traces still work in production\n- Run existing tests to confirm no regression\n\n## Notes for Agent\n- Only ONE call site to change: line 782 TracedAgentExecution usage\n- BraintrustProvider is already implemented in telemetry.py\n- Keep backward compatible - provider should be optional with sensible default","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-28T22:06:51.294234122Z","created_by":"cyou","updated_at":"2025-12-28T23:10:41.614342542Z","closed_at":"2025-12-28T23:10:41.614342542Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-7si.2","depends_on_id":"mala-7si","type":"parent-child","created_at":"2025-12-28T22:06:51.302309739Z","created_by":"daemon"}]}
{"id":"mala-7si.3","title":"Fix tool name case sensitivity in session_log_parser","description":"## Context\n- `session_log_parser.py:168` checks `block.name == \"Bash\"` (case-sensitive)\n- `hooks.py:95` defines `BASH_TOOL_NAMES = frozenset([\"bash\"])` with comment \"case-insensitive matching\"\n- If Claude SDK ever returns \"bash\" instead of \"Bash\", validation evidence detection would fail\n- Confidence: Medium - Claude Code currently uses \"Bash\" but this is fragile\n\n## Primary Files\n- src/session_log_parser.py\n\n## Scope\n**In:** Normalize tool name comparison in extract_bash_commands() to be case-insensitive\n**Out:** Changes to hooks.py (already handles case correctly)\n\n## Acceptance Criteria\n- `extract_bash_commands()` matches tool name case-insensitively\n- Both \"Bash\" and \"bash\" return the same results\n\n## Test Plan\n- TDD: Add test case with lowercase \"bash\" tool name, verify it fails initially\n- Fix: Change `block.name == \"Bash\"` to `block.name.lower() == \"bash\"`\n- Verify test passes\n\n## Notes for Agent\n- Also check `_extract_bash_commands_from_data()` fallback method for same issue (line ~190)\n- Use `.lower()` comparison, not a set lookup (simpler)","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-28T22:06:59.297259102Z","created_by":"cyou","updated_at":"2025-12-28T22:55:33.235204619Z","closed_at":"2025-12-28T22:55:33.235204619Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-7si.3","depends_on_id":"mala-7si","type":"parent-child","created_at":"2025-12-28T22:06:59.304539444Z","created_by":"daemon"}]}
{"id":"mala-7si.4","title":"Remove dist artifacts from repository","description":"## Context\n- `mala-w8w.3` was closed as \"Already resolved\" but artifacts still exist\n- `dist/` contains mala-0.1.0-py3-none-any.whl and mala-0.1.0.tar.gz\n- `.gitignore` with `*` exists in dist/ but files were committed before it was added\n- This is a reopen of the incorrectly closed mala-w8w.3\n\n## Primary Files\n- dist/mala-0.1.0-py3-none-any.whl (delete)\n- dist/mala-0.1.0.tar.gz (delete)\n\n## Scope\n**In:** Remove dist/mala-0.1.0-py3-none-any.whl and dist/mala-0.1.0.tar.gz from git\n**Out:** Changes to build system or CI\n\n## Acceptance Criteria\n- `git ls-files dist/` shows only .gitignore\n- No wheel/tarball files in dist/\n\n## Test Plan\n- `ls dist/` shows only .gitignore after cleanup\n- `git status` shows files as deleted\n\n## Notes for Agent\n- Use `git rm` to remove tracked files, not just `rm`\n- Keep dist/.gitignore intact","status":"closed","priority":4,"issue_type":"chore","created_at":"2025-12-28T22:07:07.422904666Z","created_by":"cyou","updated_at":"2025-12-28T22:39:05.568318763Z","closed_at":"2025-12-28T22:39:05.568318763Z","close_reason":"Already resolved: dist/ files are local build artifacts, not tracked in git. The .gitignore with '*' is working correctly.","dependencies":[{"issue_id":"mala-7si.4","depends_on_id":"mala-7si","type":"parent-child","created_at":"2025-12-28T22:07:07.42970931Z","created_by":"daemon"}]}
{"id":"mala-7si.5","title":"Inject MalaConfig into orchestrator and CLI","description":"## Context\n- `mala-869.2` created MalaConfig dataclass but follow-up to inject it was never done\n- Goal: Centralize configuration for programmatic users (no env var dependency)\n- Currently env vars are accessed directly in cli.py and orchestrator.py (~10 call sites)\n- MalaConfig already has from_env() for CLI compatibility\n\n## Primary Files\n- src/orchestrator.py (accept MalaConfig, use instead of direct env access)\n- src/cli.py (construct MalaConfig.from_env(), pass to orchestrator)\n- src/config.py (already complete - no changes needed)\n\n## Scope\n**In:** Add optional config parameter to MalaOrchestrator\n**In:** Update CLI to construct MalaConfig.from_env() and pass to orchestrator\n**In:** Replace direct os.environ.get() calls with config attributes\n**Out:** Removing env var support (CLI still uses from_env())\n**Out:** Changes to tools/env.py (keep for backward compat)\n\n## Call Sites to Update\ncli.py:\n- Line 72: os.environ.get(\"BRAINTRUST_API_KEY\")\n- Line 235: os.environ.get(\"MORPH_API_KEY\")\n\norchestrator.py:\n- Line 181: os.environ.get(\"MORPH_API_KEY\") in get_mcp_servers()\n- Lines 611, 739: os.environ inheritance (may keep as-is for subprocess env)\n\n## Acceptance Criteria\n- MalaOrchestrator accepts optional MalaConfig parameter\n- Default behavior unchanged (uses MalaConfig.from_env() internally if not provided)\n- Programmatic users can construct MalaConfig without env vars\n- All existing tests pass\n- CLI still works with env vars\n\n## Test Plan\n- Add test constructing orchestrator with explicit MalaConfig (no env vars)\n- Verify existing tests pass (env var path)\n- Test validation errors propagate correctly\n\n## Notes for Agent\n- MalaConfig is frozen dataclass - treat as immutable\n- Keep backward compatible: config param should be optional\n- The subprocess env inheritance (lines 611, 739) may need to stay as os.environ for child process env","notes":"Quality gate failed: Timeout after 30 minutes\nLog: /home/cyou/.claude/projects/-home-cyou-mala/c8b4520c-7749-4891-b291-35e413b623d7.jsonl","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-28T22:22:57.546322519Z","created_by":"cyou","updated_at":"2025-12-29T05:08:16.549668751Z","closed_at":"2025-12-29T05:08:16.549668751Z","close_reason":"Closed","labels":["needs-followup"],"dependencies":[{"issue_id":"mala-7si.5","depends_on_id":"mala-7si","type":"parent-child","created_at":"2025-12-28T22:22:57.557222154Z","created_by":"daemon"},{"issue_id":"mala-7si.5","depends_on_id":"mala-7si.2","type":"blocks","created_at":"2025-12-28T22:23:06.687558734Z","created_by":"daemon"}]}
{"id":"mala-7zq","title":"Dead Code and Consistency Cleanup","description":"## Context\n- Healthcheck identified ~250 lines of dead code from incomplete async migration\n- Sync methods exist alongside async versions but are never called in production\n- Minor consistency issues in hook constants\n- All child issues are independent and can parallelize\n\n## Scope\n**In:** Remove dead code, fix consistency issues identified in healthcheck\n**Out:** No functional changes, no new features\n\n## Acceptance Criteria\n- All child issues completed\n- Test suite still passes (221 tests)\n- No dead code warnings from static analysis\n\n## Test Plan\n- Run `uv run pytest` after all children complete","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-26T19:44:42.537192954Z","updated_at":"2025-12-26T19:53:05.164431129Z","closed_at":"2025-12-26T19:53:05.164431129Z","close_reason":"All children completed","labels":["dead-code"]}
{"id":"mala-81g","title":"Explore using CLAUDE_CONFIG_DIR to isolate mala agent logs from system Claude Code","description":"Investigate setting CLAUDE_CONFIG_DIR environment variable when spawning agents to write JSONL logs to a separate location (e.g., ~/.config/mala/claude-logs/) instead of mixing with system Claude Code logs in ~/.claude/projects/. This would make log management and cleanup easier for mala-specific sessions.","status":"blocked","priority":2,"issue_type":"task","created_at":"2025-12-26T18:20:17.980544403Z","updated_at":"2025-12-28T06:25:01.766654896Z","labels":["blocked"]}
{"id":"mala-82u","title":"Epic: Coverage 'No Decrease' Policy with Auto-Refresh Baseline","description":"Context:\n- Current CLI uses fixed 85% coverage threshold, which is inflexible\n- Goal: default behavior should prevent coverage from decreasing (not a fixed number)\n- Uses existing coverage.xml as baseline, with auto-refresh when missing/stale\n- Must handle parallel agents safely via locking and temp worktrees\n\nScope:\n- In: CLI option changes, coverage.py baseline functions, spec.py CoverageConfig, spec_runner.py auto-refresh logic, orchestrator.py signature\n- Out: pyproject.toml threshold (keep for direct pytest), legacy_runner changes\n\nAcceptance Criteria:\n- `bd run` without `--coverage-threshold` uses \"no decrease\" mode\n- Baseline auto-refreshes when missing or stale\n- Parallel agents don't corrupt baseline via locking\n- Parse errors fail loudly, missing baseline warns + refreshes\n\nTest Plan:\n- Integration test for full \"no decrease\" flow\n- Unit tests for each new function\n\nNotes for Agent:\n- This is the umbrella epic; implement child issues in dependency order","status":"tombstone","priority":1,"issue_type":"epic","created_at":"2025-12-27T18:13:22.418075331Z","updated_at":"2025-12-27T18:20:40.635708509Z","labels":["validation"],"deleted_at":"2025-12-27T18:20:40.635708509Z","deleted_by":"daemon","delete_reason":"delete","original_type":"epic"}
{"id":"mala-869","title":"Epic: Architecture boundaries and testability (2025-12-28 comprehensive review)","description":"## Context\nComprehensive architecture review identified 18 issues focused on:\n- **Boundary clarity**: Orchestrator is a mega-controller with no pipeline stage interfaces\n- **Configuration**: Env var access scattered with no central config object\n- **Testability**: Global telemetry patching, console coupling, no sync facade\n- **Subprocess fragmentation**: 5+ modules with independent subprocess implementations\n\n## Goals\n1. Define pipeline stage protocols for testable, extensible orchestration\n2. Centralize configuration in MalaConfig dataclass\n3. Abstract telemetry for testability and programmatic control\n4. Unify subprocess execution in CommandRunner\n5. Fix immediate bugs (MORPH_API_KEY crash)\n\n## Approach\nIssues are ordered for parallel execution where possible. Dependencies are explicit for file overlap or logical ordering.\n\n## Acceptance Criteria\n- All child issues completed\n- Orchestrator uses injected stage implementations\n- MalaConfig is the single source of configuration\n- Tests don't rely on global state or stdout capture\n- All subprocess calls go through CommandRunner\n\n## Out of Scope\n- Low-priority cleanup (absolute imports, duplicate metadata building)\n- Issues subsumed by larger refactors (BeadsClient/Codex coupling -\u003e pipeline stages)\n","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-28T16:36:38.45357471Z","updated_at":"2025-12-29T05:14:38.714984924Z","closed_at":"2025-12-29T05:14:38.714984924Z","close_reason":"All children completed"}
{"id":"mala-869.1","title":"Fix get_mcp_servers crash on missing MORPH_API_KEY","description":"## Context\n- `get_mcp_servers()` at `src/orchestrator.py:127` unconditionally accesses `os.environ[\"MORPH_API_KEY\"]` when `morph_enabled=True`\n- CLI checks for the key and sets `morph_enabled=False` if missing (`cli.py:403-410`)\n- Programmatic use of `MalaOrchestrator` with default `morph_enabled=True` crashes with `KeyError`\n- This is the simplest bug to fix and can be done independently\n\n## Primary Files\n- src/orchestrator.py:110-132\n\n## Scope\n**In:** Use `os.environ.get()` with explicit check and clear error message, or auto-disable morph when key missing with warning\n**Out:** Change morph feature behavior; change default value of morph_enabled\n\n## Acceptance Criteria\n- Clear error message when MORPH_API_KEY missing but morph_enabled=True\n- OR: Auto-disable morph when key missing (with warning logged)\n- No KeyError crashes for programmatic users\n\n## Test Plan\n- Add unit test for get_mcp_servers with missing env var\n- Test with morph_enabled=True and no MORPH_API_KEY set\n- Verify CLI still works (auto-disables morph)\n\n## Notes for Agent\n- This is a quick fix - don't over-engineer\n- Prefer clear error message over silent fallback\n","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-28T16:36:51.981378703Z","updated_at":"2025-12-28T16:49:34.251877605Z","closed_at":"2025-12-28T16:49:34.251877605Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-869.1","depends_on_id":"mala-869","type":"parent-child","created_at":"2025-12-28T16:36:51.988240931Z","created_by":"daemon"}]}
{"id":"mala-869.10","title":"Extract SessionLogParser from QualityGate","description":"## Context\n- QualityGate contains ~330 lines of JSONL log parsing plus ~200 lines of policy checking\n- Parsing methods: `_iter_jsonl_entries`, `_extract_bash_commands`, `_extract_tool_results`, `_extract_assistant_text_blocks`\n- This logic is reusable (debugging tools, analytics) but coupled to QualityGate class\n- Previous issue mala-51q.2 extracted the iterator but parsing methods remain coupled\n\n## Primary Files\n- src/quality_gate.py:168-500\n- src/session_log_parser.py (new file)\n\n## Scope\n**In:** Extract `SessionLogParser` class with all parsing methods from QualityGate\n**In:** Use log event types from mala-869.3 (LogEntry, ToolUseBlock, etc.)\n**In:** QualityGate delegates parsing to SessionLogParser\n**Out:** Change evidence detection patterns\n\n## Acceptance Criteria\n- SessionLogParser is independently usable\n- QualityGate delegates all parsing\n- All existing quality_gate tests pass\n\n## Test Plan\n- Unit tests for SessionLogParser with sample JSONL\n- Run existing quality_gate test suite\n\n## Notes for Agent\n- Wait for mala-869.3 (log event types) to be completed first\n- Keep QualityGate focused on policy checking only\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-28T16:38:46.726645944Z","updated_at":"2025-12-28T20:39:51.621254453Z","closed_at":"2025-12-28T20:39:51.621254453Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-869.10","depends_on_id":"mala-869","type":"parent-child","created_at":"2025-12-28T16:38:46.734139103Z","created_by":"daemon"},{"issue_id":"mala-869.10","depends_on_id":"mala-869.3","type":"blocks","created_at":"2025-12-28T16:38:50.512473592Z","created_by":"daemon"}]}
{"id":"mala-869.11","title":"Decompose beads_client._fetch_and_filter_issues into pipeline","description":"## Context\n- `_fetch_and_filter_issues()` has CCN 37, 121 lines\n- Handles: fetching, WIP fetching, filtering by only_ids, filtering by epic, blocking by epic status, enrichment with parent_epic, sorting (focus mode vs priority)\n- Logic is correct but hard to follow and test in isolation\n\n## Primary Files\n- src/beads_client.py:298-418\n\n## Scope\n**In:** Decompose into pipeline steps:\n  - `_fetch_base_issues()` - get issues from bd\n  - `_merge_wip_issues()` - add in-progress issues\n  - `_apply_filters()` - only_ids, epic filters\n  - `_enrich_with_epics()` - add parent_epic info\n  - `_sort_issues()` - focus mode vs priority sort\n**In:** Each step is a pure function taking and returning issue lists\n**Out:** Change subprocess calls or async behavior\n\n## Acceptance Criteria\n- Main method \u003c 30 lines\n- Each pipeline step testable with fixture data\n- All existing tests pass\n\n## Test Plan\n- Unit tests for each pipeline step with fixture data\n- Integration test with mocked subprocess\n\n## Notes for Agent\n- Pure functions are easier to test\n- Keep the overall behavior identical\n","notes":"Quality gate failed: Quality gate failed: Missing validation commands: ruff format, ruff check, pytest, ty check; No progress: commit unchanged and no new validation evidence\nLog: /home/cyou/.claude/projects/-home-cyou-mala/340c1814-2439-4a7c-8160-ad828a5c4357.jsonl","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-28T16:39:02.285552402Z","updated_at":"2025-12-28T20:29:07.709176969Z","closed_at":"2025-12-28T20:29:07.709176969Z","close_reason":"Implementation complete. Codex review failed due to contradictory scope (pure function + don't change I/O). Manual review confirms acceptance criteria met: main method 25 lines, all tests pass, clear pipeline separation documented.","labels":["needs-followup"],"dependencies":[{"issue_id":"mala-869.11","depends_on_id":"mala-869","type":"parent-child","created_at":"2025-12-28T16:39:02.293677482Z","created_by":"daemon"},{"issue_id":"mala-869.11","depends_on_id":"mala-869.5","type":"blocks","created_at":"2025-12-28T16:41:03.037605634Z","created_by":"daemon"}]}
{"id":"mala-869.12","title":"Move SDK hook types from locking.py to hooks.py","description":"## Context\n- `tools/locking.py` imports `claude_agent_sdk.types` for hook type annotations (line 12)\n- This is a low-level utility module that should have no SDK dependencies\n- `hooks.py` already imports SDK types (line 10)\n- Impact is limited since SDK is always present; this is code organization hygiene\n\n## Primary Files\n- src/tools/locking.py:12-26 (remove SDK imports)\n- src/hooks.py (receives code from locking.py)\n\n## Scope\n**In:** Move `make_stop_hook`, `StopHook` type alias from locking.py to hooks.py\n**In:** Update imports in any module that uses these from locking.py\n**Out:** Change hook behavior\n\n## Acceptance Criteria\n- `tools/locking.py` has no `claude_agent_sdk` imports\n- Hook-related code is in hooks.py\n- All existing tests pass\n\n## Test Plan\n- Grep for claude_agent_sdk in locking.py (should be zero)\n- Run existing tests\n\n## Notes for Agent\n- Simple code move, no logic changes\n- Check for any modules importing StopHook from locking.py\n","notes":"Quality gate failed: Quality gate failed: Missing validation commands: ruff format, ruff check, ty check\nLog: /home/cyou/.claude/projects/-home-cyou-mala/15fa0113-ecb3-4b22-8960-8bbd86e893da.jsonl","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-28T16:39:14.144192887Z","updated_at":"2025-12-28T18:12:22.926282464Z","closed_at":"2025-12-28T18:12:22.926282464Z","close_reason":"Work complete - commit 60714c1 merged, all validation passed","labels":["needs-followup"],"dependencies":[{"issue_id":"mala-869.12","depends_on_id":"mala-869","type":"parent-child","created_at":"2025-12-28T16:39:14.151220727Z","created_by":"daemon"}]}
{"id":"mala-869.13","title":"Define local outcome types in lifecycle.py","description":"## Context\n- `LifecycleContext` stores `GateResult` and `CodexReviewResult` - concrete types from infra modules\n- While under TYPE_CHECKING guard (no runtime import), the type signatures are still coupled\n- lifecycle.py should define its own outcome protocols\n\n## Primary Files\n- src/lifecycle.py:26-29, 124-128\n\n## Scope\n**In:** Define local `GateOutcome` and `ReviewOutcome` protocols/dataclasses in lifecycle with only the fields lifecycle needs (passed, failure_reasons, commit_hash, etc.)\n**In:** Update LifecycleContext to use local types\n**Out:** Change lifecycle state machine logic\n\n## Acceptance Criteria\n- lifecycle.py has no imports from quality_gate or codex_review (not even TYPE_CHECKING)\n- Local outcome types define the interface\n- All existing tests pass\n\n## Test Plan\n- Unit test lifecycle with local outcome types\n- Verify orchestrator can still pass gate/review results\n\n## Notes for Agent\n- Orchestrator will need to map infra results to lifecycle outcomes when passing\n- Keep the fields minimal - only what lifecycle actually uses\n","notes":"Quality gate failed: Quality gate failed: Validation commands failed (non-zero exit): pytest\nLog: /home/cyou/.claude/projects/-home-cyou-mala/af827556-09cc-43fd-960b-9b0e052d4320.jsonl","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-28T16:39:25.908272658Z","updated_at":"2025-12-28T18:12:22.943623198Z","closed_at":"2025-12-28T18:12:22.943623198Z","close_reason":"Work complete - commits 3892e71 and 73fe507 merged, coverage now at 89%","labels":["needs-followup"],"dependencies":[{"issue_id":"mala-869.13","depends_on_id":"mala-869","type":"parent-child","created_at":"2025-12-28T16:39:25.914842407Z","created_by":"daemon"}]}
{"id":"mala-869.14","title":"Add deprecation warning for ValidationConfig","description":"## Context\n- `validation/legacy_runner.py` still exists with `ValidationConfig` dataclass\n- `LegacyValidationRunner` was removed but `ValidationConfig` remains\n- `validation/runner.py` re-exports both ValidationConfig (legacy) and SpecValidationRunner (modern)\n- No deprecation warnings or migration timeline\n\n## Primary Files\n- src/validation/legacy_runner.py\n- src/validation/runner.py\n- src/validation/__init__.py\n\n## Scope\n**In:** Add `DeprecationWarning` when `ValidationConfig` is imported\n**In:** Update docstrings to indicate deprecation\n**Out:** Remove ValidationConfig (do that once no usage found)\n\n## Acceptance Criteria\n- Importing `ValidationConfig` emits deprecation warning\n- Docstring indicates deprecation\n- Existing code still works (just with warnings)\n\n## Test Plan\n- Test that deprecation warning is raised on import\n- Grep codebase for ValidationConfig usage\n\n## Notes for Agent\n- Use `warnings.warn()` with `DeprecationWarning` category\n- Check __getattr__ pattern if needed for module-level deprecation\n","notes":"Quality gate failed: Quality gate failed: Working tree has uncommitted changes for obsolete resolution: M src/config.py\n M src/orchestrator.py\n M src/validation/command_runner.py\n M tests/test_command_runner.py\n M tests/test_orchestrator.py\n?? coverage.xml\n?? src/protocols.py; No progress: commit unchanged and no new validation evidence\nLog: /home/cyou/.claude/projects/-home-cyou-mala/e5a741b9-24aa-4b84-9583-bd9156967e35.jsonl","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-28T16:39:38.422145649Z","updated_at":"2025-12-28T18:12:22.955486841Z","closed_at":"2025-12-28T18:12:22.955486841Z","close_reason":"Obsolete - ValidationConfig was already removed in cd7a02a (mala-51q.9)","labels":["needs-followup"],"dependencies":[{"issue_id":"mala-869.14","depends_on_id":"mala-869","type":"parent-child","created_at":"2025-12-28T16:39:38.428729609Z","created_by":"daemon"}]}
{"id":"mala-869.15","title":"Define pipeline stage protocols (IssueProvider, CodeReviewer, GateChecker)","description":"## Context\n- MalaOrchestrator directly coordinates all pipeline stages with no intermediate interfaces:\n  - Issue fetching (BeadsClient) → Agent execution (Claude SDK) → Validation (SpecValidationRunner) → Review (run_codex_review) → Gate checking (QualityGate) → Issue closing (BeadsClient)\n- Each stage is a direct function/method call with concrete types\n- Stages cannot be tested independently without mocking the entire orchestrator\n- This issue defines the protocols; a follow-up issue will inject them into orchestrator\n\n## Primary Files\n- src/protocols.py (new file)\n\n## Scope\n**In:** Define Protocol classes for pipeline stages:\n  - `IssueProvider`: get_ready(), claim(), close(), mark_needs_followup()\n  - `CodeReviewer`: review(repo_path, commit_sha, ...) -\u003e ReviewResult\n  - `GateChecker`: check(log_path, spec, ...) -\u003e GateResult\n**In:** Add docstrings explaining each protocol's contract\n**In:** Define result types used by protocols (or reference existing ones)\n**Out:** Modify orchestrator to use protocols (separate issue)\n**Out:** Define AgentRunner/Validator protocols (these are more complex)\n\n## Acceptance Criteria\n- Protocol classes defined in src/protocols.py\n- Each protocol has clear docstrings\n- Protocols are minimal (only methods orchestrator actually calls)\n- BeadsClient, codex_review, QualityGate match the protocols\n\n## Test Plan\n- Verify BeadsClient conforms to IssueProvider\n- Verify run_codex_review matches CodeReviewer\n- Verify QualityGate matches GateChecker\n- Type checker should pass\n\n## Notes for Agent\n- Use typing.Protocol for structural typing\n- Keep protocols minimal - don't add methods orchestrator doesn't use\n- This enables mock implementations for testing\n","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-28T16:39:55.366326722Z","updated_at":"2025-12-28T17:17:15.411919995Z","closed_at":"2025-12-28T17:17:15.411919995Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-869.15","depends_on_id":"mala-869","type":"parent-child","created_at":"2025-12-28T16:39:55.374472357Z","created_by":"daemon"}]}
{"id":"mala-869.16","title":"Inject pipeline stage implementations into MalaOrchestrator","description":"## Context\n- After mala-869.15 defines protocols, orchestrator needs to use them\n- Currently orchestrator directly instantiates BeadsClient (line 207) and calls run_codex_review, QualityGate\n- This blocks testing without patching concrete classes\n\n## Primary Files\n- src/orchestrator.py:21,203-207,854-868\n\n## Scope\n**In:** Add protocol types to MalaOrchestrator constructor: issue_provider, code_reviewer, gate_checker\n**In:** Provide default implementations (BeadsClient, CodexReviewer wrapper, QualityGate)\n**In:** Update orchestrator methods to use injected implementations\n**Out:** Define new protocols (done in mala-869.15)\n**Out:** Create mock implementations (tests can do that)\n\n## Acceptance Criteria\n- Orchestrator accepts IssueProvider, CodeReviewer, GateChecker in constructor\n- Default values maintain current behavior\n- Tests can inject mock implementations without patching\n- All existing tests pass\n\n## Test Plan\n- Unit test orchestrator with mock implementations\n- Integration test with default (real) implementations\n- Verify CLI still works\n\n## Notes for Agent\n- Keep backwards compatible: defaults should work without changes\n- This is a big change to orchestrator - be careful with state\n","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-28T16:40:06.538185974Z","updated_at":"2025-12-28T18:33:08.746352673Z","closed_at":"2025-12-28T18:33:08.746352673Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-869.16","depends_on_id":"mala-869","type":"parent-child","created_at":"2025-12-28T16:40:06.538943862Z","created_by":"daemon"},{"issue_id":"mala-869.16","depends_on_id":"mala-869.15","type":"blocks","created_at":"2025-12-28T16:40:10.854300629Z","created_by":"daemon"}]}
{"id":"mala-869.17","title":"Define MalaEventSink protocol for testable logging","description":"## Context\n- MalaOrchestrator directly calls `log()`, `log_tool()`, `log_agent_text()` from logging.console (lines 43-50)\n- This mixes orchestration logic with presentation concerns\n- Orchestrator cannot be tested without capturing stdout\n\n## Primary Files\n- src/event_sink.py (new file)\n- src/logging/console.py (will wrap as ConsoleEventSink in follow-up)\n\n## Scope\n**In:** Define `MalaEventSink` protocol with methods: `on_agent_started()`, `on_gate_result()`, `on_issue_completed()`, `on_tool_use()`, etc.\n**In:** Create `NullEventSink` for testing\n**Out:** Inject sink into orchestrator (follow-up task)\n**Out:** Create ConsoleEventSink wrapper\n\n## Acceptance Criteria\n- MalaEventSink protocol defined with key event methods\n- NullEventSink implementation for tests\n- Protocol matches current log() call sites in orchestrator\n\n## Test Plan\n- Unit test NullEventSink (no side effects)\n- Verify protocol covers all orchestrator log calls\n\n## Notes for Agent\n- Survey orchestrator for all log/log_tool/log_agent_text calls\n- Protocol should have one method per semantic event, not generic log()\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-28T16:40:22.220423004Z","updated_at":"2025-12-28T17:25:07.66424121Z","closed_at":"2025-12-28T17:25:07.66424121Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-869.17","depends_on_id":"mala-869","type":"parent-child","created_at":"2025-12-28T16:40:22.227226354Z","created_by":"daemon"}]}
{"id":"mala-869.18","title":"Lazy-load prompts in orchestrator.py","description":"## Context\n- `orchestrator.py` reads prompt files at module import time (lines 93-103)\n- `PROMPT_FILE.read_text()`, `GATE_FOLLOWUP_PROMPT`, etc. are loaded at import\n- If prompt files are missing or import happens in different working directory, import fails\n- This makes the module untestable without filesystem setup\n\n## Primary Files\n- src/orchestrator.py:93-103\n\n## Scope\n**In:** Lazy-load prompts on first use via `functools.cache` or class property\n**In:** Keep prompt paths as constants, only defer the read\n**Out:** Change prompt content or format\n**Out:** Fix main.py bootstrap (separate concern)\n\n## Acceptance Criteria\n- `import src.orchestrator` succeeds without filesystem access to prompts\n- Prompts are loaded on first use\n- CLI behavior unchanged\n\n## Test Plan\n- Unit test that imports orchestrator in isolated environment without prompt files\n- Integration test that CLI still works\n- Verify prompts are only loaded once (cached)\n\n## Notes for Agent\n- Use `@functools.cache` on a function that reads the file\n- Or use a class with `@property` and `@functools.cached_property`\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-28T16:40:34.124069661Z","updated_at":"2025-12-28T19:57:18.253945611Z","closed_at":"2025-12-28T19:57:18.253945611Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-869.18","depends_on_id":"mala-869","type":"parent-child","created_at":"2025-12-28T16:40:34.130890191Z","created_by":"daemon"}]}
{"id":"mala-869.2","title":"Create MalaConfig dataclass for centralized configuration","description":"## Context\n- Environment variable access is scattered across multiple modules with no central configuration object:\n  - `cli.py:72,235`: checks BRAINTRUST_API_KEY, MORPH_API_KEY\n  - `orchestrator.py:127`: accesses MORPH_API_KEY (crashes if missing - fixed by mala-869.1)\n  - `tools/env.py:24,51,110`: reads MALA_RUNS_DIR, MALA_LOCK_DIR, CLAUDE_CONFIG_DIR\n  - `braintrust_integration.py:71`: checks BRAINTRUST_API_KEY\n- Bootstrap sequencing requirements are implicit and undocumented\n- No Settings/Config object for programmatic users\n\n## Primary Files\n- src/config.py (new file)\n- src/tools/env.py (may be absorbed or delegate to config)\n\n## Scope\n**In:** Create `MalaConfig` dataclass that consolidates: paths (runs_dir, lock_dir, claude_config_dir), API keys (braintrust, morph), feature flags (morph_enabled, braintrust_enabled)\n**In:** Add `MalaConfig.from_env()` classmethod that loads from environment with validation\n**In:** Add `MalaConfig.validate()` method with clear error messages\n**In:** Document which env vars are required/optional\n**Out:** Change orchestrator to use MalaConfig (separate issue)\n**Out:** Remove env var support (keep for CLI)\n\n## Acceptance Criteria\n- MalaConfig dataclass with all config fields\n- from_env() loads and validates configuration\n- Clear error messages for missing required config\n- Programmatic users can construct MalaConfig without env vars\n- Docstrings document all env vars\n\n## Test Plan\n- Unit test MalaConfig.from_env() with various env var combinations\n- Test validation errors for missing required fields\n- Test construction without env vars\n\n## Notes for Agent\n- Use `@dataclass(frozen=True)` for immutability\n- Consider using `pydantic` or plain dataclass (check project dependencies)\n- Keep env.py functions as thin wrappers or deprecate them\n","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-28T16:37:06.42256265Z","updated_at":"2025-12-28T17:09:23.90078465Z","closed_at":"2025-12-28T17:09:23.90078465Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-869.2","depends_on_id":"mala-869","type":"parent-child","created_at":"2025-12-28T16:37:06.429148785Z","created_by":"daemon"}]}
{"id":"mala-869.3","title":"Define JSONL log event types for SDK schema contract","description":"## Context\n- QualityGate parses JSONL logs expecting specific structure from Claude Agent SDK:\n  - `{\"type\": \"assistant\", \"message\": {\"content\": [{\"type\": \"tool_use\", \"name\": \"Bash\", \"input\": {\"command\": ...}}]}}`\n  - `{\"type\": \"user\", \"message\": {\"content\": [{\"type\": \"tool_result\", \"tool_use_id\": ...}]}}`\n- This schema is owned by Claude Agent SDK, not by mala\n- No versioned schema, contract tests, or shared type definitions\n- If SDK changes log format, evidence detection silently breaks\n\n## Primary Files\n- src/log_events.py (new file)\n- src/quality_gate.py:234-275, 452-476 (will use new types in follow-up)\n\n## Scope\n**In:** Define explicit `LogEvent` types that represent expected log structure: `LogEntry`, `AssistantMessage`, `ToolUseBlock`, `UserMessage`, `ToolResultBlock`\n**In:** Add `parse_log_entry(data: dict) -\u003e LogEntry | None` function with validation\n**In:** Add contract tests with sample JSONL fixtures\n**Out:** Migrate QualityGate to use new types (separate issue)\n**Out:** Add schema version checking (future enhancement)\n\n## Acceptance Criteria\n- Explicit types for log events in src/log_events.py\n- Contract tests with sample JSONL fixtures from real agent sessions\n- parse_log_entry returns typed objects or None for unrecognized entries\n- Parse failures produce clear errors referencing expected schema\n\n## Test Plan\n- Unit tests with JSONL fixtures representing current SDK format\n- Test with malformed/partial entries\n- Test with future-compatible unknown fields (should not break)\n\n## Notes for Agent\n- Extract 3-5 sample JSONL entries from existing test fixtures or logs\n- Use TypedDict or dataclasses, not Pydantic (keep deps minimal)\n- Design for forward compatibility: unknown fields should be ignored\n","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-28T16:37:22.487714715Z","updated_at":"2025-12-28T18:25:35.542238254Z","closed_at":"2025-12-28T18:25:35.542238254Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-869.3","depends_on_id":"mala-869","type":"parent-child","created_at":"2025-12-28T16:37:22.494493168Z","created_by":"daemon"}]}
{"id":"mala-869.4","title":"Extend CommandRunner with async process group termination","description":"## Context\n- Subprocess execution is fragmented across 5+ modules:\n  - `beads_client.py`: async subprocess with process group termination, custom timeout\n  - `codex_review.py`: async subprocess, basic error handling\n  - `command_runner.py`: sync and async runners with streaming, timeout, structured results\n  - `git_utils.py`: sync subprocess.run with basic error handling\n  - `validation/helpers.py`: sync subprocess.run for git init\n- `command_runner.py` already provides a good abstraction but is only used by validation\n- Previous issue mala-yg9.5 was closed but not all modules migrated\n\n## Primary Files\n- src/validation/command_runner.py\n\n## Scope\n**In:** Add process group creation and termination to async CommandRunner (copy logic from beads_client.py)\n**In:** Add configurable grace period for SIGTERM before SIGKILL\n**In:** Ensure process group termination works on Linux (os.killpg)\n**Out:** Migrate other modules to use CommandRunner (separate issues)\n\n## Acceptance Criteria\n- `run_async()` creates process group when `use_process_group=True`\n- On timeout, sends SIGTERM to process group, waits grace period, then SIGKILL\n- Existing tests pass\n- New tests verify process group termination\n\n## Test Plan\n- Add unit test that spawns a process with children, verifies all are killed on timeout\n- Test SIGTERM grace period behavior\n- Verify existing async tests still pass\n\n## Notes for Agent\n- Reference beads_client.py:132-160 for the process group termination logic\n- Use `os.setsid` in `preexec_fn` for process group creation\n- Grace period should be configurable, default 2 seconds\n","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-28T16:37:37.384800032Z","updated_at":"2025-12-28T18:57:24.475178529Z","closed_at":"2025-12-28T18:57:24.475178529Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-869.4","depends_on_id":"mala-869","type":"parent-child","created_at":"2025-12-28T16:37:37.392583878Z","created_by":"daemon"}]}
{"id":"mala-869.5","title":"Migrate beads_client.py to use CommandRunner","description":"## Context\n- `beads_client.py` has its own `_run_subprocess_async()` implementation (lines 99-132)\n- Includes process group termination, timeout handling, structured results\n- This duplicates functionality now in CommandRunner (after mala-869.4)\n- Migrating ensures consistent error handling and observability\n\n## Primary Files\n- src/beads_client.py:99-160\n\n## Scope\n**In:** Replace `_run_subprocess_async()` with calls to `CommandRunner.run_async()`\n**In:** Update `SubprocessResult` usage to use `CommandResult`\n**In:** Ensure timeout and process group behavior is preserved\n**Out:** Change BeadsClient public API\n\n## Acceptance Criteria\n- No `asyncio.create_subprocess_exec` calls in beads_client.py\n- All existing tests pass\n- Timeout behavior unchanged\n- Process group termination unchanged\n\n## Test Plan\n- Run existing beads_client tests\n- Manual test with actual bd commands\n- Verify timeout kills process groups correctly\n\n## Notes for Agent\n- Keep `SubprocessResult` if needed for API compatibility, or migrate to `CommandResult`\n- The `_terminate_process_group` logic should now be in CommandRunner\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-28T16:37:47.58471429Z","updated_at":"2025-12-28T21:27:05.180568803Z","closed_at":"2025-12-28T21:27:05.180568803Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-869.5","depends_on_id":"mala-869","type":"parent-child","created_at":"2025-12-28T16:37:47.591408487Z","created_by":"daemon"},{"issue_id":"mala-869.5","depends_on_id":"mala-869.4","type":"blocks","created_at":"2025-12-28T16:38:06.223617214Z","created_by":"daemon"}]}
{"id":"mala-869.6","title":"Migrate codex_review.py to use CommandRunner","description":"## Context\n- `codex_review.py` has its own async subprocess implementation (lines 335-345)\n- Uses `asyncio.create_subprocess_exec` with basic error handling\n- Should use CommandRunner for consistency\n\n## Primary Files\n- src/codex_review.py:335-400\n\n## Scope\n**In:** Replace async subprocess calls with `CommandRunner.run_async()`\n**In:** Use CommandResult instead of raw stdout/stderr\n**Out:** Change review prompt or schema\n\n## Acceptance Criteria\n- No `asyncio.create_subprocess_exec` calls in codex_review.py\n- All existing tests pass\n- Error handling unchanged\n\n## Test Plan\n- Run existing codex_review tests\n- Manual test with actual codex commands\n\n## Notes for Agent\n- codex_review uses structured JSON output, ensure CommandResult captures it correctly\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-28T16:37:55.169116903Z","updated_at":"2025-12-28T20:56:07.163759745Z","closed_at":"2025-12-28T20:56:07.163759745Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-869.6","depends_on_id":"mala-869","type":"parent-child","created_at":"2025-12-28T16:37:55.175656134Z","created_by":"daemon"},{"issue_id":"mala-869.6","depends_on_id":"mala-869.4","type":"blocks","created_at":"2025-12-28T16:38:06.241473443Z","created_by":"daemon"}]}
{"id":"mala-869.7","title":"Migrate git_utils.py to use CommandRunner","description":"## Context\n- `git_utils.py` uses direct `subprocess.run` calls (lines 20-114)\n- Has basic error handling, no timeout management\n- Should use CommandRunner for consistency\n\n## Primary Files\n- src/git_utils.py\n\n## Scope\n**In:** Replace `subprocess.run` calls with `CommandRunner.run()`\n**In:** Use CommandResult for structured output\n**Out:** Change git_utils public API\n\n## Acceptance Criteria\n- No `subprocess.run` calls in git_utils.py\n- All existing tests pass\n- Error handling preserved\n\n## Test Plan\n- Run existing git_utils tests if any\n- Manual test git operations\n\n## Notes for Agent\n- git_utils functions are used by orchestrator and other modules\n- Ensure return values match current API\n","notes":"Quality gate failed: Quality gate failed: Missing validation commands: ruff format, ruff check, pytest, ty check; No progress: commit unchanged and no new validation evidence\nLog: /home/cyou/.claude/projects/-home-cyou-mala/4d3f0f30-d77e-457c-b3a4-507e3a146348.jsonl","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-28T16:38:01.767234246Z","updated_at":"2025-12-29T05:14:38.699565957Z","closed_at":"2025-12-29T05:14:38.699565957Z","close_reason":"Closed","labels":["needs-followup"],"dependencies":[{"issue_id":"mala-869.7","depends_on_id":"mala-869","type":"parent-child","created_at":"2025-12-28T16:38:01.774092351Z","created_by":"daemon"},{"issue_id":"mala-869.7","depends_on_id":"mala-869.4","type":"blocks","created_at":"2025-12-28T16:38:06.252960055Z","created_by":"daemon"}]}
{"id":"mala-869.8","title":"Define TelemetryProvider protocol and NullProvider","description":"## Context\n- Braintrust tracing is enabled via `setup_claude_agent_sdk()` which patches SDK globally at process level (cli.py:73-75)\n- Must happen before any `claude_agent_sdk` import, creating implicit initialization ordering constraint\n- The patching is process-wide with no abstraction: once patched, all SDK usage is traced\n- `braintrust_integration.py` imports `claude_agent_sdk` directly (line 34)\n- This hidden coupling means: (1) programmatic users may bypass tracing, (2) tests pollute global state\n\n## Primary Files\n- src/telemetry.py (new file)\n\n## Scope\n**In:** Define `TelemetryProvider` protocol with methods: `is_enabled()`, `create_span(name, metadata)`, `flush()`\n**In:** Create `NullTelemetryProvider` that does nothing (for tests and opt-out)\n**In:** Create `BraintrustProvider` that wraps existing braintrust_integration.py logic\n**Out:** Inject provider into orchestrator (separate issue)\n**Out:** Remove global patching (may still be needed for auto-instrumentation)\n\n## Acceptance Criteria\n- TelemetryProvider protocol defined\n- NullTelemetryProvider implementation\n- BraintrustProvider wraps TracedAgentExecution\n- Tests can use NullProvider without global state\n\n## Test Plan\n- Unit test NullProvider (no side effects)\n- Unit test BraintrustProvider with mock braintrust\n- Verify protocol matches TracedAgentExecution API\n\n## Notes for Agent\n- Keep BraintrustProvider API compatible with TracedAgentExecution\n- NullProvider should be completely stateless\n- Consider if global SDK patching should remain for auto-instrumentation\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-28T16:38:19.763909236Z","updated_at":"2025-12-28T16:54:24.69310314Z","closed_at":"2025-12-28T16:54:24.69310314Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-869.8","depends_on_id":"mala-869","type":"parent-child","created_at":"2025-12-28T16:38:19.770757544Z","created_by":"daemon"}]}
{"id":"mala-869.9","title":"Add run_sync() method to MalaOrchestrator","description":"## Context\n- MalaOrchestrator.run() is async, but there's no sync wrapper for programmatic use\n- CLI uses `asyncio.run()` (cli.py:429,463), which creates a new event loop each time\n- Programmatic users must handle async execution themselves, creating integration risks:\n  - Nested event loops if caller already has one running (Jupyter, GUI apps)\n  - Unclear lifecycle: who creates/owns the event loop?\n  - No hook for running in existing event loop\n\n## Primary Files\n- src/orchestrator.py\n\n## Scope\n**In:** Add `MalaOrchestrator.run_sync()` method that handles event loop creation/reuse correctly\n**In:** Use `asyncio.get_running_loop()` check to detect if already in async context\n**In:** Document async/sync usage patterns in docstring\n**Out:** Change the async implementation\n**Out:** Break CLI usage\n\n## Acceptance Criteria\n- `run_sync()` works from sync code without event loop issues\n- `run()` works when awaited from existing async context\n- Clear docs on when to use each\n- Graceful error if run_sync() called from async context\n\n## Test Plan\n- Test `run_sync()` from sync context\n- Test `run()` from existing async context (inside asyncio.run)\n- Test nested event loop detection (should fail gracefully)\n\n## Notes for Agent\n- Use `asyncio.get_event_loop()` or `asyncio.new_event_loop()` appropriately\n- Consider using `nest_asyncio` library if nested loops are needed (check deps)\n- Keep it simple: raise clear error if called from wrong context\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-28T16:38:34.845531039Z","updated_at":"2025-12-28T16:59:25.18438146Z","closed_at":"2025-12-28T16:59:25.18438146Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-869.9","depends_on_id":"mala-869","type":"parent-child","created_at":"2025-12-28T16:38:34.852460257Z","created_by":"daemon"}]}
{"id":"mala-8do","title":"Make inner loop more token efficient","description":"Optimize the inner agent loop to reduce token consumption","status":"blocked","priority":1,"issue_type":"task","created_at":"2025-12-28T06:21:39.553113819Z","updated_at":"2025-12-28T06:25:00.910067117Z"}
{"id":"mala-8kte","title":"Epic: Cerberus review-gate integration","description":"Goal:\n- Replace the Codex-only review flow in mala with Cerberus review-gate per docs/cerberus-review-plan.md.\n- Unanimous external reviewer consensus, issue context injection, and retry semantics owned by mala.\n\nScope:\n- In: review adapter, pipeline/orchestrator wiring, CLI/config/telemetry renames, tests, docs, cleanup of Codex artifacts.\n- Out: implementing Cerberus CLI itself (review-gate binary).\n","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-30T05:14:20.082114324Z","created_by":"cyou","updated_at":"2025-12-30T07:23:36.221179682Z","closed_at":"2025-12-30T07:23:36.221179682Z","close_reason":"All children completed","comments":[{"id":2,"issue_id":"mala-8kte","author":"cyou","text":"Reinstating Cerberus epic; separate from mala-yco.","created_at":"2025-12-30T05:41:24Z"}]}
{"id":"mala-8kte.1","title":"Define ReviewResult/ReviewIssue + lifecycle parse_error handling","description":"Context:\n- Cerberus issue schema adds reviewer attribution; ReviewIssue protocol must include it.\n- ReviewOutcome requires parse_error: str | None and an issues list for lifecycle decisions.\n- parse_error should trigger review rerun (Effect.RUN_REVIEW), not an agent prompt.\n\nScope:\n- In: update ReviewIssue/ReviewResult dataclasses and CodeReviewer protocol in src/protocols.py.\n- In: update lifecycle ReviewOutcome docs, LifecycleConfig.review_enabled rename, and parse_error handling in src/lifecycle.py.\n- In: adjust tests/test_lifecycle.py to cover reviewer field and parse_error -\u003e RUN_REVIEW.\n- Out: orchestrator/pipeline wiring; CLI flag changes; Cerberus CLI invocation.\n\nAcceptance Criteria:\n- ReviewResult satisfies ReviewOutcome (passed, parse_error, fatal_error, issues).\n- ReviewIssue protocol includes reviewer: str.\n- Lifecycle uses review_enabled and returns Effect.RUN_REVIEW when parse_error is set.\n- Tests updated and passing.\n\nTest Plan:\n- TDD: update failing tests first, implement changes, refactor.\n- Run: uv run pytest tests/test_lifecycle.py\n\nNotes for Agent:\n- Update Codex wording to \"external review\" only within lifecycle/protocols touched here.\n","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-30T05:14:20.117997427Z","created_by":"cyou","updated_at":"2025-12-30T05:34:42.958245501Z","closed_at":"2025-12-30T05:34:42.958245501Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-8kte.1","depends_on_id":"mala-8kte","type":"parent-child","created_at":"2025-12-30T05:41:24.88077009Z","created_by":"daemon"}]}
{"id":"mala-8kte.10","title":"Cleanup: remove codex_review module + tests","description":"Context:\n- Codex review module/tests are obsolete after Cerberus integration.\n\nScope:\n- In: delete src/codex_review.py.\n- In: delete tests/test_codex_review.py.\n- In: verify no remaining references to codex_review in src/ or tests/ (rg -n \"codex_review\").\n- Out: migrating old run metadata fields (docs only).\n\nAcceptance Criteria:\n- codex_review module and tests removed.\n- rg -n \"codex_review\" src tests returns no matches.\n- Tests pass.\n\nTest Plan:\n- Run: rg -n \"codex_review\" src tests\n- Run: uv run pytest (or targeted suites as needed)\n","status":"closed","priority":2,"issue_type":"chore","created_at":"2025-12-30T05:14:20.328167218Z","created_by":"cyou","updated_at":"2025-12-30T07:23:36.193173764Z","closed_at":"2025-12-30T07:23:36.193173764Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-8kte.10","depends_on_id":"mala-8kte.3","type":"blocks","created_at":"2025-12-30T05:14:20.660147377Z","created_by":"daemon"},{"issue_id":"mala-8kte.10","depends_on_id":"mala-8kte.4","type":"blocks","created_at":"2025-12-30T05:14:20.680339124Z","created_by":"daemon"},{"issue_id":"mala-8kte.10","depends_on_id":"mala-8kte.5","type":"blocks","created_at":"2025-12-30T05:14:20.701323649Z","created_by":"daemon"},{"issue_id":"mala-8kte.10","depends_on_id":"mala-8kte","type":"parent-child","created_at":"2025-12-30T05:41:25.078539186Z","created_by":"daemon"}]}
{"id":"mala-8kte.11","title":"Cleanup: update console + validation spec review naming","description":"Context:\n- Console event sink still references Codex review and thinking mode.\n- Validation spec docs reference the old \"codex-review\" disable value.\n\nScope:\n- In: update src/event_sink_console.py to use review_enabled and remove thinking-mode output; rename strings to \"external review\" or \"review\".\n- In: update src/validation/spec.py to rename \"codex-review\" to \"review\" in docs/comments.\n- Out: other codex references in pipeline/orchestrator/tests (handled elsewhere).\n\nAcceptance Criteria:\n- Console output uses \"review\" phrasing and has no codex_thinking_mode references.\n- Validation spec comment uses \"review\".\n- rg -n \"codex\" src/event_sink_console.py src/validation/spec.py returns no matches.\n\nTest Plan:\n- Run: rg -n \"codex\" src/event_sink_console.py src/validation/spec.py\n- (Optional) uv run pytest tests/test_event_sink.py\n","status":"closed","priority":2,"issue_type":"chore","created_at":"2025-12-30T05:43:04.285878118Z","created_by":"cyou","updated_at":"2025-12-30T06:55:50.878903374Z","closed_at":"2025-12-30T06:55:50.878903374Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-8kte.11","depends_on_id":"mala-8kte","type":"parent-child","created_at":"2025-12-30T05:43:04.293252774Z","created_by":"daemon"},{"issue_id":"mala-8kte.11","depends_on_id":"mala-8kte.6","type":"blocks","created_at":"2025-12-30T05:43:04.320744295Z","created_by":"daemon"},{"issue_id":"mala-8kte.11","depends_on_id":"mala-8kte.7","type":"blocks","created_at":"2025-12-30T05:43:04.342992731Z","created_by":"daemon"}]}
{"id":"mala-8kte.2","title":"Add cerberus_review adapter + parsing tests","description":"Context:\n- Cerberus review-gate returns structured JSON and exit codes 0-5.\n- mala needs a thin adapter and issue formatting compatible with existing pipeline code.\n\nScope:\n- In: add src/cerberus_review.py with spawn/wait helpers or run_cerberus_review, mapping exit codes to ReviewResult and parsing issues/reviewer fields.\n- In: implement format_review_issues to match existing caller expectations.\n- In: add tests/test_cerberus_review.py covering JSON parsing, exit code mapping (0-5), timeout, and parse_error extraction.\n- Out: orchestrator/pipeline integration, empty diff short-circuit (handled elsewhere).\n- Out: removal of Codex review module/tests (cleanup task).\n\nAcceptance Criteria:\n- Adapter returns ReviewResult with correct passed/parse_error/fatal_error mapping for each exit code.\n- Issues are parsed with reviewer/file/line/priority/title/body fields.\n- Tests cover success, fail, parse error, timeout, no reviewers, internal error.\n\nTest Plan:\n- TDD: write failing tests for exit code mapping and parsing, implement adapter, refactor.\n- Run: uv run pytest tests/test_cerberus_review.py\n\nNotes for Agent:\n- Keep CLI execution in repo_path handled by caller; adapter focuses on parsing and mapping.\n","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-30T05:14:20.152241174Z","created_by":"cyou","updated_at":"2025-12-30T06:06:47.590639217Z","closed_at":"2025-12-30T06:06:47.590639217Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-8kte.2","depends_on_id":"mala-8kte.1","type":"blocks","created_at":"2025-12-30T05:14:20.349334512Z","created_by":"daemon"},{"issue_id":"mala-8kte.2","depends_on_id":"mala-8kte","type":"parent-child","created_at":"2025-12-30T05:41:24.902755567Z","created_by":"daemon"}]}
{"id":"mala-8kte.3","title":"Update ReviewRunner to use new reviewer signature","description":"Context:\n- ReviewRunner currently references CodexReviewResult and thinking_mode.\n- Cerberus integration requires the new CodeReviewer signature and context-file handling.\n- Review timeout from config should flow into the reviewer wait call.\n\nScope:\n- In: update src/pipeline/review_runner.py to use ReviewResult and the new CodeReviewer signature (diff_range, context_file, timeout).\n- In: write issue_description to a unique temp context file (e.g., /tmp/claude/review-context-{issue_id}.txt) and pass its path.\n- In: add review_timeout to ReviewRunnerConfig and use it when calling the reviewer.\n- In: update tests/test_review_runner.py to match the new config and call signature.\n- Out: orchestrator and agent session changes.\n\nAcceptance Criteria:\n- ReviewRunner passes context_file and timeout to the reviewer and returns ReviewResult.\n- Context file uses unique per-issue naming and is created only when issue_description is present.\n- review_timeout is respected (default 300 when unset).\n- Tests updated and passing.\n\nTest Plan:\n- TDD: update tests first, implement minimal changes, refactor.\n- Run: uv run pytest tests/test_review_runner.py\n","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-30T05:14:20.174203157Z","created_by":"cyou","updated_at":"2025-12-30T06:50:58.396448454Z","closed_at":"2025-12-30T06:50:58.396448454Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-8kte.3","depends_on_id":"mala-8kte.1","type":"blocks","created_at":"2025-12-30T05:14:20.369883728Z","created_by":"daemon"},{"issue_id":"mala-8kte.3","depends_on_id":"mala-8kte.2","type":"blocks","created_at":"2025-12-30T05:14:20.390857173Z","created_by":"daemon"},{"issue_id":"mala-8kte.3","depends_on_id":"mala-8kte","type":"parent-child","created_at":"2025-12-30T05:41:24.924665555Z","created_by":"daemon"}]}
{"id":"mala-8kte.4","title":"Orchestrator: DefaultReviewer runs review-gate + empty diff pass","description":"Context:\n- Default reviewer must call review-gate CLI with diff range and context file, running in repo_path.\n- Empty diff should short-circuit to PASS on the initial review only.\n- disable-validations value is renamed to \"review\".\n\nScope:\n- In: update src/orchestrator.py DefaultCodeReviewer -\u003e DefaultReviewer with repo_path and review-gate spawn/wait flow; parse session_key; handle spawn failure.\n- In: apply empty-diff short-circuit for initial review only.\n- In: update disable-validations checks to use \"review\".\n- In: pass review_timeout from config into ReviewRunnerConfig so reviewer wait honors CLI timeout.\n- Out: context file creation (handled in ReviewRunner); codex wording sweep (separate issue); CLI flag definitions.\n\nAcceptance Criteria:\n- review-gate commands run in repo_path and map exit codes to ReviewResult correctly.\n- Spawn failure returns parse_error with stderr.\n- Empty diff on initial review returns passed=True without spawning.\n- review_timeout is propagated into ReviewRunnerConfig.\n- Tests updated and passing.\n\nTest Plan:\n- TDD: add failing tests for empty diff and spawn/wait mapping; implement.\n- Run: uv run pytest tests/test_orchestrator.py\n","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-30T05:14:20.19618235Z","created_by":"cyou","updated_at":"2025-12-30T06:45:54.951228677Z","closed_at":"2025-12-30T06:45:54.951228677Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-8kte.4","depends_on_id":"mala-8kte.1","type":"blocks","created_at":"2025-12-30T05:14:20.411650319Z","created_by":"daemon"},{"issue_id":"mala-8kte.4","depends_on_id":"mala-8kte.2","type":"blocks","created_at":"2025-12-30T05:14:20.431473927Z","created_by":"daemon"},{"issue_id":"mala-8kte.4","depends_on_id":"mala-8kte.6","type":"blocks","created_at":"2025-12-30T05:14:20.451567814Z","created_by":"daemon"},{"issue_id":"mala-8kte.4","depends_on_id":"mala-8kte","type":"parent-child","created_at":"2025-12-30T05:41:24.946904338Z","created_by":"daemon"}]}
{"id":"mala-8kte.5","title":"AgentSessionRunner: cerberus review + external prompt","description":"Context:\n- AgentSessionRunner uses Codex review imports/fields and prompt text references Codex.\n- parse_error is now a string message and should trigger review retry without agent prompt.\n\nScope:\n- In: update src/pipeline/agent_session_runner.py imports, types, and field names (review_enabled, review_log_path, ReviewResult).\n- In: adjust review retry logic to treat parse_error as retryable review-tool failure; use format_review_issues(result.issues).\n- In: update src/prompts/review_followup.md wording (\"External Review Failed\", \"external reviewers\").\n- In: update tests/test_agent_session_runner.py for new fields and behavior.\n- Out: review_runner and orchestrator changes.\n\nAcceptance Criteria:\n- AgentSessionRunner stores review_log_path and uses ReviewResult.issues with format_review_issues.\n- parse_error leads to review rerun (no agent prompt) while issues trigger review retry prompt.\n- Prompt text reflects external reviewers.\n- Tests updated and passing.\n\nTest Plan:\n- TDD: update tests first, implement changes, refactor.\n- Run: uv run pytest tests/test_agent_session_runner.py\n","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-30T05:14:20.217931444Z","created_by":"cyou","updated_at":"2025-12-30T07:04:56.938876497Z","closed_at":"2025-12-30T07:04:56.938876497Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-8kte.5","depends_on_id":"mala-8kte.1","type":"blocks","created_at":"2025-12-30T05:14:20.472210809Z","created_by":"daemon"},{"issue_id":"mala-8kte.5","depends_on_id":"mala-8kte.2","type":"blocks","created_at":"2025-12-30T05:14:20.493107025Z","created_by":"daemon"},{"issue_id":"mala-8kte.5","depends_on_id":"mala-8kte.6","type":"blocks","created_at":"2025-12-30T05:14:20.51385693Z","created_by":"daemon"},{"issue_id":"mala-8kte.5","depends_on_id":"mala-8kte.8","type":"blocks","created_at":"2025-12-30T05:14:20.534644986Z","created_by":"daemon"},{"issue_id":"mala-8kte.5","depends_on_id":"mala-8kte","type":"parent-child","created_at":"2025-12-30T05:41:24.969443337Z","created_by":"daemon"}]}
{"id":"mala-8kte.6","title":"CLI/config: rename review flags + add review-timeout","description":"Context:\n- CLI currently exposes Codex-specific flags and disable-validations=codex-review.\n- Cerberus integration requires review-timeout control in mala.\n\nScope:\n- In: update src/cli.py to rename disable-validations value to \"review\", remove --codex-thinking-mode, and add --review-timeout (default 300).\n- In: update src/config.py to rename codex_review_enabled -\u003e review_enabled, add review_timeout, and remove codex_thinking_mode.\n- In: update tests/test_cli.py to cover new flags and removals.\n- Out: orchestrator/pipeline usage changes; telemetry updates.\n\nAcceptance Criteria:\n- CLI help and parsing no longer include --codex-thinking-mode.\n- --disable-validations=review works; codex-review value removed.\n- --review-timeout is accepted with default 300.\n- Config uses review_enabled and review_timeout.\n- Tests updated and passing.\n\nTest Plan:\n- TDD: update CLI tests first, implement changes, refactor.\n- Run: uv run pytest tests/test_cli.py\n","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-30T05:14:20.239296038Z","created_by":"cyou","updated_at":"2025-12-30T05:38:34.47878451Z","closed_at":"2025-12-30T05:38:34.47878451Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-8kte.6","depends_on_id":"mala-8kte","type":"parent-child","created_at":"2025-12-30T05:41:24.99101766Z","created_by":"daemon"}]}
{"id":"mala-8kte.7","title":"Event sink: RunConfig review_enabled rename","description":"Context:\n- Event sink RunConfig still uses codex_review_enabled and codex_thinking_mode.\n- Telemetry should align with new review_enabled naming.\n\nScope:\n- In: update src/event_sink.py RunConfig to review_enabled and remove codex_thinking_mode; update docstrings/comments.\n- In: update tests/test_event_sink.py fixtures and assertions.\n- Out: run_metadata schema changes (separate task).\n\nAcceptance Criteria:\n- Event sink RunConfig matches new config fields (review_enabled only).\n- No Codex-specific fields remain in event sink.\n- Tests updated and passing.\n\nTest Plan:\n- TDD: update tests first, implement changes.\n- Run: uv run pytest tests/test_event_sink.py\n","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-30T05:14:20.262189069Z","created_by":"cyou","updated_at":"2025-12-30T06:07:21.100933948Z","closed_at":"2025-12-30T06:07:21.100933948Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-8kte.7","depends_on_id":"mala-8kte.6","type":"blocks","created_at":"2025-12-30T05:14:20.555322181Z","created_by":"daemon"},{"issue_id":"mala-8kte.7","depends_on_id":"mala-8kte","type":"parent-child","created_at":"2025-12-30T05:41:25.012377437Z","created_by":"daemon"}]}
{"id":"mala-8kte.8","title":"Run metadata: review_log_path + review_enabled rename","description":"Context:\n- Run metadata still stores codex_review_log_path and codex_review fields.\n- Cerberus integration renames these to review_log_path and review_enabled.\n\nScope:\n- In: update src/logging/run_metadata.py IssueRun to use review_log_path, and RunConfig to use review_enabled.\n- In: update tests/test_run_metadata.py fixtures and assertions.\n- Out: backward-compat parsing for historical metadata (documented separately).\n\nAcceptance Criteria:\n- Run metadata schema uses review_log_path and review_enabled.\n- Tests updated and passing.\n\nTest Plan:\n- TDD: update tests first, implement changes.\n- Run: uv run pytest tests/test_run_metadata.py\n\nNotes for Agent:\n- Coordinate with docs update for migration note about old field names.\n","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-30T05:14:20.284151682Z","created_by":"cyou","updated_at":"2025-12-30T05:58:40.204164105Z","closed_at":"2025-12-30T05:58:40.204164105Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-8kte.8","depends_on_id":"mala-8kte.6","type":"blocks","created_at":"2025-12-30T05:14:20.576056367Z","created_by":"daemon"},{"issue_id":"mala-8kte.8","depends_on_id":"mala-8kte","type":"parent-child","created_at":"2025-12-30T05:41:25.034865447Z","created_by":"daemon"}]}
{"id":"mala-8kte.9","title":"Docs: Cerberus review-gate + migration note","description":"Context:\n- Docs still refer to Codex review flow and old CLI flags.\n- Migration requires a note about run metadata field renames.\n\nScope:\n- In: update README.md and docs/quality-hardening-plan.md to describe Cerberus review-gate and new review flag names.\n- In: add migration note about codex_review_log_path/codex_review field rename.\n- In: run rg -i codex over docs/ and update remaining doc references to \"external review\" or \"review-gate\".\n- Out: code changes.\n\nAcceptance Criteria:\n- README and quality-hardening docs reference review-gate and disable-validations=review.\n- Migration note included.\n- No outdated Codex references remain in docs (except historical changelog notes, if any).\n\nTest Plan:\n- N/A (docs).\n","status":"closed","priority":2,"issue_type":"chore","created_at":"2025-12-30T05:14:20.305670256Z","created_by":"cyou","updated_at":"2025-12-30T07:08:00.754304818Z","closed_at":"2025-12-30T07:08:00.754304818Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-8kte.9","depends_on_id":"mala-8kte.6","type":"blocks","created_at":"2025-12-30T05:14:20.596809253Z","created_by":"daemon"},{"issue_id":"mala-8kte.9","depends_on_id":"mala-8kte.2","type":"blocks","created_at":"2025-12-30T05:14:20.617822548Z","created_by":"daemon"},{"issue_id":"mala-8kte.9","depends_on_id":"mala-8kte.1","type":"blocks","created_at":"2025-12-30T05:14:20.639317022Z","created_by":"daemon"},{"issue_id":"mala-8kte.9","depends_on_id":"mala-8kte","type":"parent-child","created_at":"2025-12-30T05:41:25.057193669Z","created_by":"daemon"}]}
{"id":"mala-8ppr","title":"[Review] src/braintrust_integration.py:8: [P3] Missing BRAINTRUST_AVAILABLE in src/infra/tools/__init__.py __all__ (prior review item addressed)","description":"## Review Finding\n\nThis issue was auto-created from a P3 review finding.\n\n**Source issue:** mala-iy6l.4\n**Reviewer:** claude\n**Location:** src/braintrust_integration.py:8\n\n## Details\n\nThe prior Gemini review flagged incomplete exports in `src/infra/tools/__init__.py`. The current diff addresses most locking functions but is unrelated to `BRAINTRUST_AVAILABLE`, which is correctly exported from the braintrust shim. This prior item appears resolved.","notes":"Quality gate failed: Timeout after 60 minutes\nLog: /home/cyou/.claude/projects/-home-cyou-mala/bb2bec6e-f7e4-4677-8a43-f55cf0d8805b.jsonl","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-01T06:35:03.765125997Z","created_by":"cyou","updated_at":"2026-01-01T17:57:41.914527047Z","closed_at":"2026-01-01T17:57:41.914527047Z","close_reason":"Closed","labels":["auto_generated","needs-followup","review_finding","review_finding:7bc2c1b67430","source:mala-iy6l.4"]}
{"id":"mala-8td","title":"Log codex review session path in verbose mode","description":"When running in verbose mode, the orchestrator should capture and log the path to the codex session log file that codex creates during the review.\n\nCodex stores session logs in `~/.codex/sessions/YYYY/MM/DD/{session-id}.jsonl`. The orchestrator should:\n1. Capture the session ID or log path from codex's output\n2. Store the path in the runs JSON under the issue's `codex_review_log_path` field\n\nThis enables debugging by pointing to the full codex conversation/session log.","acceptance_criteria":"- In verbose mode, the codex session log path is captured from the codex run\n- The runs JSON includes `codex_review_log_path` field pointing to the codex session JSONL file\n- In non-verbose mode, the path is not captured (to avoid overhead)\n- Path format: `~/.codex/sessions/YYYY/MM/DD/{session-id}.jsonl`","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T22:27:51.105697172Z","updated_at":"2025-12-28T04:58:51.036936421Z","closed_at":"2025-12-28T04:58:51.036936421Z","close_reason":"Closed"}
{"id":"mala-98c","title":"Redirect test logs to /tmp (mala runs + Claude SDK)","description":"## Context\nTests generate run metadata logs in ~/.config/mala/runs/, polluting the user's configuration directory with test artifacts. Additionally, Claude SDK writes session logs to ~/.claude/projects/, which also gets polluted during test runs.\n\n## Problem\nWhen running pytest:\n1. RunMetadata.save() writes to RUNS_DIR (~/.config/mala/runs/), creating hundreds of JSON files from test runs\n2. Claude SDK writes session logs to ~/.claude/projects/, creating test artifacts in the user's Claude config\n\n## Solution\nOverride both directories to point to /tmp locations when running tests:\n1. Add MALA_RUNS_DIR env var support in env.py (similar to MALA_LOCK_DIR)\n2. Add CLAUDE_CONFIG_DIR env var support for get_claude_log_path()\n3. Set both env vars in conftest.py pytest_configure()\n\n## Acceptance Criteria\n- Test runs do not create files in ~/.config/mala/runs/\n- Test runs do not create files in ~/.claude/projects/\n- Run logs go to /tmp/mala-test-runs/ or similar\n- Claude logs use /tmp/mala-test-claude/ or similar\n- Production behavior unchanged\n\n## Files to Modify\n- src/tools/env.py: Add MALA_RUNS_DIR env var support, add get_claude_config_dir() helper, update get_claude_log_path() to use it\n- tests/conftest.py: Set MALA_RUNS_DIR and CLAUDE_CONFIG_DIR to /tmp paths for all tests\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T06:15:51.085556202Z","updated_at":"2025-12-27T07:19:53.463304503Z","closed_at":"2025-12-27T07:19:53.463304503Z","close_reason":"Closed"}
{"id":"mala-9c4","title":"Log codex review output in verbose mode","description":"When running in verbose mode, the orchestrator should save the codex review output (raw JSON response) to a file. This enables debugging and auditing of codex review decisions.\n\nThe log file should be saved alongside other run artifacts in the runs directory, with a naming convention like:\n`{run_id}-{issue_id}-codex-review.json`\n\nThe path to this log file should be recorded in the runs JSON under the issue's `codex_review_log_path` field.","acceptance_criteria":"- In verbose mode, codex review raw output is saved to a file\n- File is saved in the runs directory with format {run_id}-{issue_id}-codex-review.json\n- The runs JSON includes codex_review_log_path field for each issue that had codex review run\n- In non-verbose mode, no log file is created (to save disk space)\n- Log includes all review attempts (not just the final one)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T22:24:05.447731981Z","updated_at":"2025-12-27T22:26:53.987400446Z","closed_at":"2025-12-27T22:26:53.987400446Z","close_reason":"Closed"}
{"id":"mala-9ki","title":"Refactor: add tools/env.py and centralize env loading","description":"## Context\n`src/main.py` currently defines `USER_CONFIG_DIR`, `JSONL_LOG_DIR`, `SCRIPTS_DIR`, and performs dotenv loading at import time. This creates side effects and makes reuse/testing harder. The architecture plan calls for a small `tools/env.py` module that owns config paths and env loading, while preserving the **early** load needed for Braintrust setup.\n\n## Scope\nCreate a new module `src/tools/env.py` only. Do **not** modify `src/main.py` in this issue; integration will wire it up later.\n\n### Files\n- Add: `src/tools/env.py`\n\n## Requirements\n- `tools/env.py` should define:\n  - `USER_CONFIG_DIR = Path.home() / \".config\" / \"mala\"`\n  - `JSONL_LOG_DIR = USER_CONFIG_DIR / \"logs\"`\n  - `SCRIPTS_DIR` that points to repo `scripts/` (from `src/tools/env.py`, use `Path(__file__).resolve().parents[2] / \"scripts\"` or equivalent)\n- Provide two helpers:\n  - `load_user_env()` that loads `${USER_CONFIG_DIR}/.env` only (for early Braintrust setup)\n  - `load_env(repo_path: Path | None)` that calls `load_user_env()` and then (if `repo_path` is provided) loads `\u003crepo_path\u003e/.env` with `override=True`\n\n## Acceptance Criteria\n- `src/tools/env.py` exists with the above constants and functions.\n- No other files are modified in this issue.\n\n## Notes\n- Integration issue will wire these into `src/main.py`.\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T19:54:51.122065094Z","updated_at":"2025-12-25T20:08:26.994504903Z","closed_at":"2025-12-25T20:08:26.994504903Z","close_reason":"Closed"}
{"id":"mala-9lp","title":"Add progress gate between review retries","description":"## Problem\nReview retry loops are the #1 time/token sink. Issues hitting max_review_retries=5 consume 5-7x more time than 1-attempt issues. Pearson correlation between review_attempts and duration is 0.87-0.95.\n\nThe failure pattern: 'No progress: commit unchanged and no new validation evidence' — the agent gets stuck re-running the same thing without making progress.\n\n## Solution\nAdd a progress gate between review retries:\n- Before allowing another review attempt, require either:\n  - A new commit (different SHA from previous attempt)\n  - Changed files in the working tree\n- If neither condition is met, fail fast with actionable guidance instead of burning more attempts\n\n## Expected Impact\n~50% wall time reduction on failed issues\n\n## Evidence\n- mala-869.11: 31.5 min, 5 review attempts, failed with 'No progress'\n- mala-51q.2: 39.5 min, 5 review attempts, failed with 'No progress'\n- Both runs show same pattern across multiple issues","notes":"Quality gate failed: Timeout after 30 minutes\nLog: /home/cyou/.claude/projects/-home-cyou-mala/8432d8b2-63f1-4961-81ff-078998356364.jsonl","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-29T00:43:22.796559893Z","created_by":"cyou","updated_at":"2025-12-29T04:20:13.147765271Z","closed_at":"2025-12-29T04:20:13.147765271Z","close_reason":"Closed","labels":["needs-followup"]}
{"id":"mala-9mb","title":"Update orchestrator for strict validation pipeline","description":"Context:\n- Orchestrator must run the new strict gate chain and enforce issue closure rules.\n- Integrates EvidenceGate, clean-room validation, Codex review, and run-level validation.\n\nScope:\n- In: add Gate 1-4 sequencing; enforce clean-git checks; handle no-op/obsolete IssueResolution; respect disable-validations; run-level validation in worktree; follow-up issue on failure.\n- Out: changes to validation module internals (separate tasks).\n\nAcceptance Criteria:\n- Issues are closed only after run-level validation passes.\n- No-op/obsolete issues do not force commits and skip per-issue validation.\n- Failures trigger correct retries and non-zero exit on run-level failure.\n\nTest Plan:\n- TDD: add orchestrator tests for gate flow, retry exhaustion, and no-op issues.\n- Run orchestrator test suite.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T23:00:01.754561703Z","updated_at":"2025-12-27T01:40:18.566144768Z","closed_at":"2025-12-27T01:40:18.566144768Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-9mb","depends_on_id":"mala-cij","type":"blocks","created_at":"2025-12-26T23:00:26.592166614Z","created_by":"daemon"},{"issue_id":"mala-9mb","depends_on_id":"mala-ng3","type":"blocks","created_at":"2025-12-26T23:00:26.60370918Z","created_by":"daemon"},{"issue_id":"mala-9mb","depends_on_id":"mala-e0i","type":"blocks","created_at":"2025-12-26T23:00:26.614703142Z","created_by":"daemon"},{"issue_id":"mala-9mb","depends_on_id":"mala-2eu","type":"blocks","created_at":"2025-12-26T23:00:26.625720633Z","created_by":"daemon"}]}
{"id":"mala-9pg","title":"CLI command to find agent run, get metadata/logs, open in Claude Code","description":"Add CLI command to search for agent runs, retrieve metadata and logs, and open directly in Claude Code for inspection","status":"blocked","priority":2,"issue_type":"feature","created_at":"2025-12-28T06:21:39.636542746Z","updated_at":"2025-12-28T06:25:01.743981791Z"}
{"id":"mala-9qr","title":"Refactor: extract hook logic from src/cli.py","description":"Goal: Make hook logic self-contained by moving block_dangerous_commands (and related constants) into a new module (e.g., src/hooks.py).\\n\\nScope/files: src/cli.py, new src/hooks.py.\\n\\nWork:\\n- Move DANGEROUS_PATTERNS + block_dangerous_commands to new module.\\n- Update imports in cli.py.\\n- Keep behavior unchanged.\\n\\nAcceptance criteria:\\n- CLI behavior unchanged.\\n- Hook still used in ClaudeAgentOptions.hooks.\\n- Tests (if any) still pass.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-25T21:41:10.672408295Z","updated_at":"2025-12-26T00:06:41.954204714Z","closed_at":"2025-12-26T00:06:41.954204714Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-9qr","depends_on_id":"mala-akl","type":"blocks","created_at":"2025-12-25T21:47:25.567206045Z","created_by":"daemon"},{"issue_id":"mala-9qr","depends_on_id":"mala-c01","type":"parent-child","created_at":"2025-12-25T22:05:59.455394242Z","created_by":"daemon"}]}
{"id":"mala-9v8","title":"Dependency-aware scheduling using beads graph","description":"Use beads dependency relations (blocks, parent-child) to schedule work optimally:\n\n- Don't start child issues until parent blockers are closed\n- Parallelize independent subtrees automatically\n- Visualize critical path through dependency graph\n- Reorder work queue when dependencies resolve\n\nThis prevents wasted effort on blocked work and maximizes parallelism.","status":"blocked","priority":3,"issue_type":"feature","created_at":"2025-12-28T06:31:49.709283289Z","updated_at":"2025-12-28T06:31:54.040255157Z"}
{"id":"mala-a2z","title":"Implement baseline auto-refresh in spec_runner.py","description":"Context:\n- Must capture baseline from main repo BEFORE worktree creation\n- If baseline missing or stale, auto-refresh by running tests in temp worktree\n- Need locking to prevent parallel agents from clobbering\n- Must use same pytest args as validation spec\n\nScope:\n- In: Add `_refresh_baseline(spec, repo_path) -\u003e float` method\n- In: Before worktree setup in `run_validation_spec`, check/refresh baseline\n- In: Use file locking (existing locking.py) with double-check pattern\n- In: Pass `baseline_percent` to `_check_coverage`\n- In: Update `_check_coverage` to accept and use baseline_percent\n- Out: CLI changes, CoverageConfig changes (done in other issues)\n\nAcceptance Criteria:\n- Baseline captured from main repo before worktree creation\n- If baseline missing/stale, `_refresh_baseline` runs in temp worktree\n- Lock acquired before refresh, released after\n- Double-check pattern: re-verify staleness after acquiring lock\n- Temp worktree cleaned up after refresh\n- Atomic rename of coverage.xml to main repo\n- `_check_coverage` uses baseline_percent when min_percent is None\n\nTest Plan:\n- Test baseline captured before worktree setup\n- Test missing baseline triggers refresh\n- Test stale baseline triggers refresh\n- Test fresh baseline skips refresh\n- Test lock prevents concurrent refreshes\n- Mock worktree creation/cleanup\n\nNotes for Agent:\n- Use existing `create_worktree` from worktree.py\n- Use existing locking functions from locking.py\n- Run pytest with same args from spec, just override `--cov-fail-under=0`\n- Write to temp file, then `os.rename()` for atomic update\n- Primary file: src/validation/spec_runner.py","status":"tombstone","priority":1,"issue_type":"task","created_at":"2025-12-27T18:14:14.27972069Z","updated_at":"2025-12-27T18:20:40.634273311Z","labels":["validation"],"dependencies":[{"issue_id":"mala-a2z","depends_on_id":"mala-wg1","type":"blocks","created_at":"2025-12-27T18:15:02.015029041Z","created_by":"daemon"},{"issue_id":"mala-a2z","depends_on_id":"mala-da4","type":"blocks","created_at":"2025-12-27T18:15:02.027510339Z","created_by":"daemon"}],"deleted_at":"2025-12-27T18:20:40.634273311Z","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"mala-actw","title":"[Review] src/pipeline/agent_session_runner.py:900-904: [P2] Clear pending tool IDs on idle-timeout retry","description":"## Review Finding\n\nThis issue was auto-created from a P2 review finding.\n\n**Source issue:** mala-cavk.2\n**Reviewer:** codex\n**Location:** src/pipeline/agent_session_runner.py:900-904\n\n## Details\n\n`_run_message_iteration` only clears `state.pending_tool_ids` and resets `tool_calls_this_turn` once before the retry loop. After an idle timeout, retries reuse the same `state.pending_tool_ids` from the previous attempt, so `_iter_messages` sets `current_timeout=None` and can hang indefinitely because those tool IDs will never resolve on the new stream. The pre-refactor code cleared these per attempt. Reset `state.pending_tool_ids` (and `tool_calls_this_turn`) at the start of each retry attempt inside the `while pending_query is not None` loop.","notes":"Quality gate failed: External review failed: spawn failed: Artifact written: /home/cyou/.claude/projects/-home-cyou-mala/cerberus/d37bf16c-d780-4dfb-8fd9-3ee2be2fbe17/latest.md\nReview gate already active (status: pending, age: 66s)\nUse /home/cyou/.claude/plugins/cache/cerberus/cerberus/1.10.6/bin/review-gate resolve to complete the existing gate first.\nLog: /home/cyou/.claude/projects/-home-cyou-mala/d37bf16c-d780-4dfb-8fd9-3ee2be2fbe17.jsonl","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T21:33:48.212980929Z","created_by":"cyou","updated_at":"2026-01-02T00:48:06.805484617Z","closed_at":"2026-01-02T00:48:06.805484617Z","close_reason":"Closed","labels":["auto_generated","needs-followup","review_finding","review_finding:72762dbdf0fd","source:mala-cavk.2"]}
{"id":"mala-aht","title":"Epic: Healthcheck reliability fixes","description":"Context:\n- Umbrella for issues from the code health review (orchestrator + beads reliability).\n- Keep fixes small and parallel where possible.\n\nScope:\n- In: reliability/correctness fixes from the review output.\n- Out: new features or architecture changes.\n\nAcceptance Criteria:\n- Child issues created and linked.\n\nTest Plan:\n- N/A (epic).","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-26T19:54:23.723935931Z","updated_at":"2025-12-26T22:52:42.875836878Z","closed_at":"2025-12-26T22:52:42.875836878Z","close_reason":"All children completed"}
{"id":"mala-aht.1","title":"Stop gate retry loop when Claude log is missing","description":"Context:\n- run_implementer only proceeds if the Claude session log exists after a ResultMessage (src/orchestrator.py:348).\n- If the log never appears, the loop spins until global timeout, causing false failures and queue stalls.\n\nScope:\n- In: add a bounded wait for log creation; if missing, fail fast with a clear summary and exit the loop.\n- Out: changing the log directory or disabling the quality gate.\n\nAcceptance Criteria:\n- When log file never appears, run_implementer exits within a bounded wait and sets a summary indicating missing log.\n- Orchestrator does not stall for the full timeout due to missing logs.\n\nTest Plan:\n- TDD: add a failing unit test with a mocked client that yields ResultMessage but no log file; assert run_implementer returns quickly with a failure summary.\n- Run pytest for the new test.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-26T19:54:34.157781045Z","updated_at":"2025-12-26T20:26:33.740210331Z","closed_at":"2025-12-26T20:26:33.740210331Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-aht.1","depends_on_id":"mala-aht","type":"parent-child","created_at":"2025-12-26T19:54:34.165963474Z","created_by":"daemon"}]}
{"id":"mala-aht.2","title":"Avoid releasing locks owned by other runs","description":"Context:\n- Orchestrator always calls release_all_locks on shutdown (src/orchestrator.py:835), which deletes every lock file in LOCK_DIR (src/tools/locking.py:111).\n- If multiple mala runs share LOCK_DIR, one run can clear locks for another, enabling concurrent writes. Needs verification.\n\nScope:\n- In: only clean up locks owned by this run's agents or isolate each run with a unique LOCK_DIR; keep admin/global cleanup for manual use.\n- Out: redesigning the locking protocol.\n\nAcceptance Criteria:\n- Run cleanup leaves locks owned by other agent IDs intact.\n- Each run only removes its own locks.\n\nTest Plan:\n- TDD: add a unit test that creates lock files for two agent IDs; run cleanup and verify only matching locks are removed.\n- Run pytest for new locking/orchestrator tests.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-26T19:54:42.017640957Z","updated_at":"2025-12-26T20:40:46.158277204Z","closed_at":"2025-12-26T20:40:46.158277204Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-aht.2","depends_on_id":"mala-aht","type":"parent-child","created_at":"2025-12-26T19:54:42.026062315Z","created_by":"daemon"},{"issue_id":"mala-aht.2","depends_on_id":"mala-aht.1","type":"blocks","created_at":"2025-12-26T19:55:09.816278845Z","created_by":"daemon"}]}
{"id":"mala-aht.3","title":"Terminate bd/git subprocesses on timeout","description":"Context:\n- _run_subprocess_async wraps subprocess.run in a thread and uses asyncio.wait_for; timeouts return but the subprocess keeps running (src/beads_client.py:38-70).\n- Hanging bd/git processes can accumulate during long runs.\n\nScope:\n- In: ensure timed-out commands are terminated (e.g., pass timeout to subprocess.run and handle TimeoutExpired, or switch to asyncio subprocess and kill).\n- Out: changing bd CLI usage.\n\nAcceptance Criteria:\n- Timed-out commands are terminated and return a timeout result.\n- Timeout warnings still emit.\n\nTest Plan:\n- TDD: add a failing test mocking subprocess.run to raise TimeoutExpired and assert a safe timeout result.\n- Run pytest for BeadsClient tests.","notes":"Quality gate failed: Timeout after 30 minutes\nLog: /home/cyou/.claude/projects/-home-cyou-mala/ce7cad14-805f-4dad-856c-647c4baa772c.jsonl","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-26T19:54:51.724656053Z","updated_at":"2025-12-26T21:45:47.050205724Z","closed_at":"2025-12-26T21:45:47.050205724Z","close_reason":"Closed","labels":["needs-followup"],"dependencies":[{"issue_id":"mala-aht.3","depends_on_id":"mala-aht","type":"parent-child","created_at":"2025-12-26T19:54:51.74113736Z","created_by":"daemon"}]}
{"id":"mala-aht.4","title":"Consolidate sync/async BeadsClient implementations","description":"Context:\n- BeadsClient maintains parallel sync and async implementations for the same actions (src/beads_client.py:80 and :244).\n- This duplication risks drift and unused code; needs verification that sync APIs are still required beyond tests.\n\nScope:\n- In: consolidate shared logic or deprecate/remove sync methods if unused; update tests accordingly.\n- Out: changing bd command semantics.\n\nAcceptance Criteria:\n- One authoritative implementation per action.\n- Tests updated and passing.\n\nTest Plan:\n- Run pytest for BeadsClient/orchestrator tests.","status":"closed","priority":2,"issue_type":"chore","created_at":"2025-12-26T19:55:00.28451646Z","updated_at":"2025-12-26T22:43:14.357220042Z","closed_at":"2025-12-26T22:43:14.357220042Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-aht.4","depends_on_id":"mala-aht","type":"parent-child","created_at":"2025-12-26T19:55:00.300728599Z","created_by":"daemon"},{"issue_id":"mala-aht.4","depends_on_id":"mala-aht.3","type":"blocks","created_at":"2025-12-26T19:55:13.994459065Z","created_by":"daemon"}]}
{"id":"mala-ai5","title":"Disallow git stash and other multi-agent conflicting operations","description":"Context:\n- Multiple agents may work in the same repository concurrently.\n- Operations like git stash, git rebase -i, git reset --hard, and similar commands can cause confusion and conflicts between agents.\n- These operations modify the working tree or history in ways that are difficult for other agents to detect or recover from.\n\nScope:\n- In: Add validation/hooks to detect and block dangerous git operations in agent contexts.\n- In: Document which git operations are disallowed and why.\n- In: Consider a pre-commit hook or wrapper to enforce these restrictions.\n- Out: Does not block operations in non-agent contexts (user override possible).\n\nDisallowed Operations:\n- git stash (all subcommands) - hides changes that other agents cannot see\n- git reset --hard - discards uncommitted changes silently\n- git rebase -i - interactive rebase requires human input\n- git checkout -f / git checkout --force - discards local changes\n- git clean -f - removes untracked files without warning\n- git merge --abort / git rebase --abort - may discard other agents' work\n\nAcceptance Criteria:\n- Dangerous git operations are detected and blocked with clear error messages.\n- Agents receive guidance on safe alternatives (e.g., commit instead of stash).\n- Documentation explains the rationale and lists all blocked operations.\n- Override mechanism exists for legitimate use cases.\n\nTest Plan:\n- Unit tests verify detection of each disallowed operation.\n- Integration test confirms blocking works in agent context.\n- Test override mechanism.\n\nNotes for Agent:\n- Consider implementing as a git hook, CLI wrapper, or agent-level validation.\n- Prefer failing fast with helpful error messages over silent failures.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T23:03:09.392627299Z","updated_at":"2025-12-26T23:36:27.199636643Z","closed_at":"2025-12-26T23:36:27.199636643Z","close_reason":"Closed"}
{"id":"mala-akl","title":"mala run exit code: treat no-issue runs as success","description":"Problem: src/cli.py returns exit code 1 when success_count == 0. This makes no-op runs (no issues ready) look like failures in automation.\\n\\nScope/files: src/cli.py.\\n\\nWork:\\n- Distinguish 'no issues processed' from 'issues processed but failed'.\\n- Update exit code to 0 when there were no issues to process. Keep non-zero when actual failures occurred.\\n\\nAcceptance criteria:\\n- If no issues are ready, mala run exits 0.\\n- If issues ran and all failed, still exits non-zero.\\n- If some succeeded, exits 0.\\n\\nDependency: Avoid concurrent edits with mala-20u (same file).","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T21:38:26.013087673Z","updated_at":"2025-12-26T00:00:32.928066608Z","closed_at":"2025-12-26T00:00:32.928066608Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-akl","depends_on_id":"mala-20u","type":"blocks","created_at":"2025-12-25T21:38:51.94427495Z","created_by":"daemon"}]}
{"id":"mala-anh","title":"Refactor: split src/cli.py into focused modules","description":"Goal: Reduce the 600+ line cli module by extracting focused modules (e.g., orchestrator.py, hooks.py, prompt.py, git_utils.py). Keep external behavior unchanged.\\n\\nScope/files: src/cli.py plus new modules under src/.\\n\\nSuggested steps:\\n1) Identify pure helpers (git commit/branch, prompt loading, hook logic).\\n2) Move orchestration class to its own module.\\n3) Keep CLI wiring in cli.py, import helpers.\\n4) Update imports/tests.\\n\\nAcceptance criteria:\\n- CLI commands unchanged.\\n- No behavior changes to orchestrator loop.\\n- Tests pass (or at least no regressions).","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-25T21:40:15.520698126Z","updated_at":"2025-12-25T21:41:31.71957273Z","closed_at":"2025-12-25T21:41:31.71957273Z","close_reason":"Split into smaller refactor tasks: mala-9qr (hooks), mala-dqt (git helpers), mala-as5 (orchestrator extraction)."}
{"id":"mala-apsz","title":"[Review] src/infra/io/event_sink.py:1350-1351: [P2] Validation success visibility and issue_id inconsistent with start event","description":"## Review Finding\n\nThis issue was auto-created from a P2 review finding.\n\n**Source issue:** mala-40pg.3\n**Reviewer:** gemini\n**Location:** src/infra/io/event_sink.py:1350-1351\n\n## Details\n\nWhile `on_validation_started` was changed to `log()` for normal visibility and correctly includes the `issue_id`, the `passed` branch of `on_validation_result` still uses `log_verbose()` and lacks the `issue_id` parameter. This creates a poor UX in normal mode where the user sees a \"Starting validation...\" message but never receives a corresponding \"Validation passed\" completion message. Furthermore, in verbose mode, the success log will use an inconsistent prefix (`[agent-id]` instead of `[ISSUE-ID]`). It should be changed to use `log()` with `issue_id` to match the start event and other completion events like `on_gate_passed`.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T19:41:09.703261298Z","created_by":"cyou","updated_at":"2026-01-01T23:49:33.632510829Z","closed_at":"2026-01-01T23:49:33.632510829Z","close_reason":"Closed","labels":["auto_generated","review_finding","review_finding:d71a07ca9d47","source:mala-40pg.3"]}
{"id":"mala-aqp4","title":"Epic: Architecture review 2025-12-30 (duplication, boundaries)","description":"## Context\nArchitecture review from 2025-12-30 using multi-model synthesis (Codex gpt-5.2-codex, Claude opus).\n\n## Key Findings (4 P1 issues)\n\n1. **Duplicated prompt loading** - `_get_gate_followup_prompt()` in orchestrator.py (test-exported) and agent_session_runner.py (runtime)\n2. **Duplicated MCP config** - `get_mcp_servers()` and `get_disallowed_tools()` across 3 modules\n3. **Pipeline bypasses event sink** - Direct console logging violates documented boundary contract\n4. **src/logging shadows stdlib** - Package name collision breaks third-party tools\n\n## Execution Strategy\n1. Rename logging module first (LOGGING-RENAME) - unblocks analysis tools\n2. Consolidate duplications (PROMPT-DUP, MCP-DUP) - can parallelize\n3. Fix event sink boundary (SINK-BOUNDARY) - depends on logging rename\n\n## Related Epics\n- mala-7si.1: Event sink wiring (closed)\n- mala-3qp: Prior architecture review (closed)\n\n## Primary Files\n- src/orchestrator.py, src/pipeline/*.py\n- src/logging/ (to be renamed)\n- src/prompts.py, src/mcp.py (new shared modules)","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-30T17:26:16.585405021Z","created_by":"cyou","updated_at":"2025-12-30T22:42:28.623213077Z","closed_at":"2025-12-30T22:42:28.623213077Z","close_reason":"All children completed"}
{"id":"mala-aqp4.1","title":"Rename src/logging to src/log_output to avoid stdlib collision","description":"## Context\n- `src/logging` package collides with Python's stdlib `logging` module\n- When `src` is on Python path, `import logging` resolves to `src/logging` instead of stdlib\n- Broke grimp analysis during architecture review: `AttributeError: module 'logging' has no attribute 'getLogger'`\n- Will break any third-party library expecting stdlib logging\n- Confidence: High (directly observed during review)\n\n## Primary Files\n- src/log_output/ (NEW - rename from src/logging)\n- All files importing from src.logging (~10 files)\n\n## Scope\n**In:** Rename `src/logging/` directory to `src/log_output/`\n**In:** Update all imports across codebase (`from src.logging.console` → `from src.log_output.console`)\n**Out:** Changing logging behavior or API\n\n## Acceptance Criteria\n- No package named `logging` under `src/`\n- All imports updated to new module name\n- `python -c \"import logging; logging.getLogger('test')\"` succeeds with src on path\n- All tests pass\n\n## Test Plan\n- Run `uv run pytest` (full suite)\n- Run grimp analysis to verify it now works\n- `rg \"from src.logging\" src/` returns empty\n\n## Notes for Agent\n- Use git mv for directory rename to preserve history\n- Search all *.py files for imports to update\n- Files to update (grep result): cli.py, orchestrator.py, event_sink_console.py, cerberus_review.py, validation/spec_executor.py, pipeline/agent_session_runner.py, pipeline/run_coordinator.py","notes":"Quality gate failed: Timeout after 60 minutes\nLog: /home/cyou/.claude/projects/-home-cyou-mala/fd10381d-057e-45e7-9c2a-d7f9fea33343.jsonl","status":"closed","priority":1,"issue_type":"chore","created_at":"2025-12-30T17:26:29.260052468Z","created_by":"cyou","updated_at":"2025-12-30T20:25:22.098607324Z","closed_at":"2025-12-30T20:25:22.098607324Z","close_reason":"Closed","labels":["needs-followup"],"dependencies":[{"issue_id":"mala-aqp4.1","depends_on_id":"mala-aqp4","type":"parent-child","created_at":"2025-12-30T17:26:29.266933305Z","created_by":"daemon"}]}
{"id":"mala-aqp4.2","title":"Consolidate duplicate _get_gate_followup_prompt() to shared prompts module","description":"## Context\n- `_get_gate_followup_prompt()` is defined in both `orchestrator.py:120` and `agent_session_runner.py:74`\n- Orchestrator version is test-exported (`tests/test_orchestrator.py:27,131,161`)\n- Pipeline version is actually used at runtime (agent_session_runner.py:668)\n- Tests verify one copy while production uses another - changes may pass tests but behave differently\n- Confidence: High (verified via grep)\n\n## Primary Files\n- src/prompts.py (NEW)\n- src/orchestrator.py\n- src/pipeline/agent_session_runner.py\n- tests/test_orchestrator.py\n\n## Scope\n**In:** Create `src/prompts.py` with `get_gate_followup_prompt()` and GATE_FOLLOWUP_FILE constant\n**In:** Remove duplicate from orchestrator.py and agent_session_runner.py, import from shared\n**In:** Update test imports in `tests/test_orchestrator.py:27`\n**Out:** Changing prompt content or file locations\n\n## Acceptance Criteria\n- Single definition of `_get_gate_followup_prompt()` in `src/prompts.py`\n- `orchestrator.py` imports from prompts.py\n- `agent_session_runner.py` imports from prompts.py\n- Tests import from prompts.py\n- `rg \"def _get_gate_followup_prompt\" src/` returns exactly one match\n\n## Test Plan\n- TDD: Update test imports first, verify they fail without implementation\n- Implement shared module\n- Run `uv run pytest tests/test_orchestrator.py -k followup`\n\n## Notes for Agent\n- Keep the @lru_cache decorator on the shared function\n- Move GATE_FOLLOWUP_FILE constant to prompts.py as well\n- Also move _PROMPT_DIR if needed for the constant","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-30T17:26:39.784671825Z","created_by":"cyou","updated_at":"2025-12-30T21:53:55.112150196Z","closed_at":"2025-12-30T21:53:55.112150196Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-aqp4.2","depends_on_id":"mala-aqp4","type":"parent-child","created_at":"2025-12-30T17:26:39.791506361Z","created_by":"daemon"},{"issue_id":"mala-aqp4.2","depends_on_id":"mala-aqp4.1","type":"blocks","created_at":"2025-12-30T17:30:44.226261008Z","created_by":"daemon"}]}
{"id":"mala-aqp4.3","title":"Consolidate duplicate MCP server configuration to shared module","description":"## Context\n- `get_mcp_servers()` and `_get_disallowed_tools()` duplicated across 3 files:\n  - `src/orchestrator.py:334-349` (public `get_mcp_servers()`)\n  - `src/pipeline/agent_session_runner.py:358-386` (private `_get_mcp_servers()`)\n  - `src/pipeline/run_coordinator.py:76-103` (private `_get_mcp_servers()`)\n- Updating Morph configuration requires changes in 3 places, risking behavioral divergence\n- Confidence: High (verified via grep)\n\n## Primary Files\n- src/mcp.py (NEW)\n- src/orchestrator.py\n- src/pipeline/agent_session_runner.py\n- src/pipeline/run_coordinator.py\n\n## Scope\n**In:** Create `src/mcp.py` with `get_mcp_servers()` and `get_disallowed_tools()`\n**In:** Remove duplicates from all three files, import from shared module\n**In:** Move `MORPH_DISALLOWED_TOOLS` constant from hooks.py to mcp.py\n**Out:** Changing MCP protocol or Morph integration behavior\n\n## Acceptance Criteria\n- Single source of truth for MCP configuration in `src/mcp.py`\n- All three files import from shared module\n- `rg \"def.*get_mcp_servers\" src/` returns exactly one match\n- `rg \"def.*get_disallowed_tools\" src/` returns exactly one match\n\n## Test Plan\n- Run existing tests: `uv run pytest -m integration`\n- Verify MCP server behavior unchanged\n- `uv run pytest tests/test_morph_integration.py` if exists\n\n## Notes for Agent\n- Unify function signatures (make parameters consistent across all use sites)\n- The orchestrator version takes `repo_path`, `morph_api_key`, `morph_enabled` - use this as canonical\n- Consider if hooks.py still needs MORPH_DISALLOWED_TOOLS or if it should import from mcp.py","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-30T17:26:53.255482712Z","created_by":"cyou","updated_at":"2025-12-30T22:22:04.748494155Z","closed_at":"2025-12-30T22:22:04.748494155Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-aqp4.3","depends_on_id":"mala-aqp4","type":"parent-child","created_at":"2025-12-30T17:26:53.262731297Z","created_by":"daemon"},{"issue_id":"mala-aqp4.3","depends_on_id":"mala-aqp4.2","type":"blocks","created_at":"2025-12-30T17:27:22.957168478Z","created_by":"daemon"}]}
{"id":"mala-aqp4.4","title":"Route pipeline module output through event sink protocol","description":"## Context\n- `MalaEventSink` protocol (`src/event_sink.py:1-10,45-54`) explicitly defines boundary: \"Defines the MalaEventSink protocol to decouple orchestration logic from presentation concerns. The orchestrator emits semantic events through the sink.\"\n- `AgentSessionRunner` imports `log`, `log_verbose` from `src.logging.console` (line 50-54) and calls directly (line 566-571)\n- `RunCoordinator` imports `log_agent_text`, `log_tool` (line 40-44) and calls directly (line 491-494)\n- This violates documented boundary contract, makes pipeline stages untestable with NullEventSink\n- Confidence: High (boundary contract cited from event_sink.py docstring)\n\n## Primary Files\n- src/pipeline/agent_session_runner.py\n- src/pipeline/run_coordinator.py\n- src/event_sink.py (may need new methods)\n- src/event_sink_console.py (implement new methods)\n\n## Scope\n**In:** Remove direct console imports from pipeline modules\n**In:** Route output through event_sink callbacks (already passed via config/callbacks)\n**In:** Add missing event sink methods if output types aren't covered\n**Out:** Changing EventSink protocol API design\n**Out:** Changing CLI user-visible output format\n\n## Acceptance Criteria\n- `agent_session_runner.py` has no imports from `src.logging.console` or `src.log_output.console`\n- `run_coordinator.py` has no imports from `src.logging.console` or `src.log_output.console`\n- `rg \"from src.(logging|log_output).console\" src/pipeline/` returns empty\n- Pipeline stages testable with NullEventSink (no stdout)\n\n## Test Plan\n- Add unit test with mock event sink verifying events emitted\n- Run `uv run pytest tests/` (may need to add pipeline-specific tests)\n- Verify CLI output unchanged visually\n\n## Notes for Agent\n- Check if all needed event types exist in MalaEventSink; add if missing\n- Follow pattern from orchestrator.py which already uses event sink\n- The event_sink is passed via AgentSessionRunnerConfig and RunCoordinatorConfig\n- May need to add methods like `on_log_waiting`, `on_fixer_text`, etc.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-30T17:27:06.95160185Z","created_by":"cyou","updated_at":"2025-12-30T22:33:47.623553635Z","closed_at":"2025-12-30T22:33:47.623553635Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-aqp4.4","depends_on_id":"mala-aqp4","type":"parent-child","created_at":"2025-12-30T17:27:06.958324986Z","created_by":"daemon"},{"issue_id":"mala-aqp4.4","depends_on_id":"mala-aqp4.1","type":"blocks","created_at":"2025-12-30T17:27:16.06289189Z","created_by":"daemon"},{"issue_id":"mala-aqp4.4","depends_on_id":"mala-aqp4.3","type":"blocks","created_at":"2025-12-30T17:27:30.371689554Z","created_by":"daemon"}]}
{"id":"mala-as5","title":"Refactor: move MalaOrchestrator to its own module","description":"Goal: Extract MalaOrchestrator class from src/cli.py into a dedicated module (e.g., src/orchestrator.py) to reduce file size and clarify responsibilities.\\n\\nScope/files: src/cli.py, new src/orchestrator.py.\\n\\nWork:\\n- Move IssueResult + MalaOrchestrator to new module.\\n- Adjust imports in cli.py.\\n- Keep CLI command signatures and behavior unchanged.\\n\\nAcceptance criteria:\\n- Orchestrator behavior unchanged.\\n- CLI still works.\\n- Tests (if any) still pass.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-25T21:41:26.002972067Z","updated_at":"2025-12-26T00:15:52.939703847Z","closed_at":"2025-12-26T00:15:52.939703847Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-as5","depends_on_id":"mala-dqt","type":"blocks","created_at":"2025-12-25T21:47:35.258531693Z","created_by":"daemon"},{"issue_id":"mala-as5","depends_on_id":"mala-c01","type":"parent-child","created_at":"2025-12-25T22:05:59.484296839Z","created_by":"daemon"}]}
{"id":"mala-avh","title":"Add better logging of CLI args to JSON and terminal","description":"Improve visibility into what CLI arguments were used for a mala run.\n\n## Problem\nCurrently it's hard to see what flags were passed (e.g., --disable-validations) in both:\n- Terminal output at run start\n- JSON run metadata/logs\n\n## Proposed Solution\n1. Log parsed CLI args at run start in terminal (similar to how validation commands are shown)\n2. Include full CLI args in run metadata JSON for debugging/auditing\n\n## Specific Args to Log\n- --disable-validations (which ones)\n- --coverage-threshold\n- --wip flag\n- --max-issues\n- --max-gate-retries / --max-review-retries\n- --braintrust flag\n\n## Acceptance Criteria\n- [ ] Terminal shows key CLI args at run start (dimmed/gray like other config lines)\n- [ ] Run metadata JSON includes cli_args or similar field\n- [ ] Easy to see why validations were skipped when debugging","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T20:22:35.103181662Z","updated_at":"2025-12-28T04:34:29.507325034Z","closed_at":"2025-12-28T04:34:29.507325034Z","close_reason":"Closed"}
{"id":"mala-awsa","title":"[Review] src/infra/clients/cerberus_review.py:191-195: [P2] Scope gate resolve to the current session","description":"## Review Finding\n\nThis issue was auto-created from a P2 review finding.\n\n**Source issue:** mala-m70v\n**Reviewer:** codex\n**Location:** src/infra/clients/cerberus_review.py:191-195\n\n## Details\n\nOn an \"already active\" error, the code always runs `review-gate resolve` without any session scoping. If another run is legitimately active in the same repo, this will clear that gate and discard its in-flight review, then spawn a new one. That can cause concurrent runs to interfere and lose review results. Consider resolving only the current session (e.g., pass a session ID / verify the gate belongs to this run) or treat it as a hard error instead of unconditionally resolving.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T23:45:36.302392711Z","created_by":"cyou","updated_at":"2026-01-01T23:55:18.785591003Z","closed_at":"2026-01-01T23:55:18.785591003Z","close_reason":"Closed","labels":["auto_generated","review_finding","review_finding:e41686bb36de","source:mala-m70v"]}
{"id":"mala-b0m","title":"Graceful shutdown with agent wrap-up","description":"## Goal\nHandle agent exit gracefully: signal active agents to wrap up, clean up partial state, and ensure consistent issue status before exit.\n\n## Problem\nWhen agents exit early (context exhaustion, error, timeout, orchestrator shutdown), they may leave:\n- Partial work uncommitted in the git working tree\n- Issue in inconsistent state (e.g., still marked as in_progress)\n- Locks held without cleanup\n\n## Current Behavior\n- Orchestrator calls `reset_issue()` which sets status back, but doesn't clean up git state\n- Partial file changes may remain uncommitted in the working tree\n- Next agent picking up the issue sees a dirty state\n\n## Proposed Solution\nOn agent exit (early or orchestrator shutdown):\n\n1. **Signal agents to wrap up**: Give active agents a chance to commit partial work or rollback cleanly\n\n2. **Reset git state**: Discard uncommitted changes for files the agent touched\n   - `git checkout -- \u003cfiles\u003e` or `git restore \u003cfiles\u003e`\n   - Consider `git clean` for new untracked files created by the agent\n   - Be careful not to discard work from other concurrent agents\n\n3. **Mark issue as open**: Use `bd update \u003cissue\u003e --status open` (not just reset to previous state)\n\n4. **Release all locks**: Ensure locks are released before git reset\n\n5. **Emit final summary**: Log what was cleaned up and issue states\n\n## Implementation Notes\n- Track which files the agent modified (from tool calls in JSONL log)\n- Or simpler: reset only files the agent held locks for\n- Safest approach: only reset files associated with locks held by the exiting agent\n\n## Acceptance Criteria\n- Early exit leaves working tree clean (no partial changes from failed agent)\n- Orchestrator shutdown signals all agents before force-terminating\n- Issue status is set to 'open' on failure\n- Locks are released\n- Other agents' uncommitted work is not affected\n- Final summary emitted showing cleanup actions","status":"blocked","priority":1,"issue_type":"epic","created_at":"2025-12-26T00:55:42.940976936Z","updated_at":"2025-12-28T06:25:00.89875904Z"}
{"id":"mala-b8d","title":"Allow specification of thinking mode for codex","description":"Add configuration option to specify the thinking mode (e.g., high, medium, low) when using codex for reviews and other operations.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-27T23:51:54.88471213Z","updated_at":"2025-12-28T05:48:12.544139537Z","closed_at":"2025-12-28T05:48:12.544139537Z","close_reason":"Closed"}
{"id":"mala-bdu","title":"Enhance status command to show last messages from agents","description":"Context:\n- Status command should show what each agent is currently doing.\n- Display last N messages or current activity from each running agent.\n\nScope:\n- In: read agent logs; parse recent messages; display in status output.\n- Out: real-time streaming; TUI/dashboard.\n\nAcceptance Criteria:\n- `mala status` shows last message/activity from each active agent.\n- Clear indication of agent state (working, waiting, idle).\n- Timestamps on last activity.\n\nTest Plan:\n- Manual: run mala, check status mid-run, verify agent messages shown.\n- Unit: mock log reading and verify output format.","status":"blocked","priority":2,"issue_type":"feature","created_at":"2025-12-27T01:14:57.841683856Z","updated_at":"2025-12-28T06:25:01.755230229Z","dependencies":[{"issue_id":"mala-bdu","depends_on_id":"mala-6c0","type":"blocks","created_at":"2025-12-27T01:15:02.133910704Z","created_by":"daemon"}]}
{"id":"mala-bgl","title":"Save progress state on context exhaustion","status":"tombstone","priority":2,"issue_type":"epic","created_at":"2025-12-26T00:55:42.565812819Z","updated_at":"2025-12-26T00:56:32.19480344Z","deleted_at":"2025-12-26T00:56:32.19480344Z","deleted_by":"daemon","delete_reason":"delete","original_type":"epic"}
{"id":"mala-bp3h","title":"Epic: Fix import-linter contracts (2024-12-31 plan)","description":"Addresses 4 broken import-linter contracts from architecture review.\n\n## Context\n\n- 4 contracts broken: Layered Architecture, Domain layer independence, Domain must not depend on infra, CLI only depends on orchestrator\n- 5 contracts kept: Pipeline modules acyclic, Infra modules independent, SDK confined to infra, Only CLI imports typer, Hooks isolated\n- Plan reviewed 3x with auto-resolution; some P1 concerns addressed in child issues\n\n## Spec\n\nSee: `doc/2024-12-31-architecture-fix-plan.md`\n\n## Scope\n\n**In:**\n- Task 1: Extract orchestrator_types.py to break cycle (extends mala-29eu.2)\n- Task 2: Define local Protocol types in protocols.py\n- Task 3: Fix Contract 2 definition (independence → forbidden)\n- Task 4: Create cli_support.py for CLI utilities\n- Task 5: Merge event_sink_console into event_sink\n- Task 6: Move BraintrustProvider to braintrust_integration\n- Task 7: Update test imports + final verification\n\n**Out:**\n- CCN optimization (run_session, _run_refresh, etc.)\n- Full package restructure\n- Behavior changes\n\n## Acceptance Criteria\n\n- [ ] `uvx --from import-linter lint-imports` passes all 9 contracts\n- [ ] All tests pass: `uv run pytest -m \"unit or integration\"`\n- [ ] Linting passes: `uvx ruff check . \u0026\u0026 uvx ty check`\n- [ ] No re-exports for backward compatibility (clean break)","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-31T16:56:48.178034875Z","created_by":"cyou","updated_at":"2026-01-01T03:45:54.467037113Z","closed_at":"2026-01-01T03:45:54.467037113Z","close_reason":"Closed","labels":["import-linter","refactor"]}
{"id":"mala-bp3h.1","title":"Extract orchestrator_types.py to break cycle","description":"Extract shared types from orchestrator_factory.py to break the circular dependency.\n\n## Context\n\n- orchestrator.py imports from orchestrator_factory (line 76: DEFAULT_AGENT_TIMEOUT_MINUTES)\n- orchestrator_factory.py imports from orchestrator (line 40: MalaOrchestrator)\n- This creates a circular dependency that import-linter flags\n- Extends work from mala-29eu.2 which created orchestrator_factory.py\n- Related to mala-29eu.2 but focuses on breaking the cycle, not factory pattern\n\n## Scope\n\n**In:**\n- Create `src/orchestrator_types.py` with:\n  - `OrchestratorConfig` dataclass (move from orchestrator_factory.py lines 48-90)\n  - `OrchestratorDependencies` dataclass (move from orchestrator_factory.py lines 92+)\n  - `_DerivedConfig` dataclass (if exists)\n  - `DEFAULT_AGENT_TIMEOUT_MINUTES` constant (line 45)\n- Update orchestrator.py line 76 to import from orchestrator_types\n- Update orchestrator_factory.py to import from orchestrator_types\n- Update cli.py lazy imports to use orchestrator_types\n- Update pyproject.toml line 143: add `src.orchestrator_types` to orchestration layer\n\n**Out:**\n- Changing factory function logic\n- Behavior changes\n\n## Primary Files\n\n- src/orchestrator_types.py (NEW)\n- src/orchestrator_factory.py\n- src/orchestrator.py\n- pyproject.toml\n\n## Acceptance Criteria\n\n- [ ] `src/orchestrator_types.py` exists with OrchestratorConfig, OrchestratorDependencies, DEFAULT_AGENT_TIMEOUT_MINUTES\n- [ ] orchestrator.py imports DEFAULT_AGENT_TIMEOUT_MINUTES from orchestrator_types\n- [ ] orchestrator_factory.py imports types from orchestrator_types (no local definitions)\n- [ ] pyproject.toml line 143 includes `src.orchestrator_types`\n- [ ] `uvx --from import-linter lint-imports --contract \"Layered Architecture\"` shows improvement (no cycle)\n- [ ] Tests pass: `uv run pytest tests/unit/test_orchestrator*.py -v`\n- [ ] Linting: `uvx ruff check . \u0026\u0026 uvx ty check`\n\n## Test Plan\n\n1. Run `uvx --from import-linter lint-imports` before changes (baseline)\n2. Create orchestrator_types.py with moved types\n3. Update imports in orchestrator.py, orchestrator_factory.py, cli.py\n4. Update pyproject.toml layer definition\n5. Run `uvx --from import-linter lint-imports --contract \"Layered Architecture\"` - cycle should be gone\n6. Run `uv run pytest tests/unit/test_orchestrator*.py -v`\n7. Run `uvx ruff check . \u0026\u0026 uvx ty check`\n\n## Notes for Agent\n\n- OrchestratorConfig is a dataclass, not Pydantic BaseModel\n- cli.py uses lazy imports via __getattr__ pattern - update _LAZY_NAMES and lazy load logic\n- TYPE_CHECKING imports in orchestrator.py (line 83) also need updating\n- This task builds on mala-29eu.2 which already created orchestrator_factory.py","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-31T16:57:09.467238356Z","created_by":"cyou","updated_at":"2025-12-31T18:38:11.22415722Z","closed_at":"2025-12-31T18:38:11.22415722Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-bp3h.1","depends_on_id":"mala-bp3h","type":"parent-child","created_at":"2025-12-31T16:57:09.474337239Z","created_by":"daemon"}]}
{"id":"mala-bp3h.2","title":"Define local Protocol types in protocols.py","description":"Replace TYPE_CHECKING imports from domain/infra modules with local Protocol types.\n\n## Context\n\n- protocols.py (lines 28-32) has TYPE_CHECKING imports from:\n  - cerberus_review.ReviewResult\n  - models.EpicVerdict\n  - quality_gate.CommitResult, GateResult, ValidationEvidence\n  - session_log_parser.JsonlEntry\n  - validation.spec.ValidationSpec\n- These imports (even in TYPE_CHECKING) violate \"Layered Architecture\" contract\n- protocols.py is in infra layer but imports from domain modules\n- Solution: define local Protocol types that match the shapes needed\n\n## Scope\n\n**In:**\n- Remove TYPE_CHECKING imports from domain/infra modules (lines 28-32)\n- Define local Protocol types:\n  - `ReviewResultProtocol` - matches cerberus_review.ReviewResult shape\n  - `EpicVerdictProtocol` - matches models.EpicVerdict shape\n  - `GateResultProtocol` - matches quality_gate.GateResult shape\n  - `CommitResultProtocol` - matches quality_gate.CommitResult shape\n  - `ValidationEvidenceProtocol` - matches quality_gate.ValidationEvidence shape\n  - `ValidationSpecProtocol` - matches validation.spec.ValidationSpec shape\n  - `JsonlEntryProtocol` - matches session_log_parser.JsonlEntry shape\n- Update method signatures to use new Protocol types\n\n**Out:**\n- Moving protocols.py to different layer\n- Creating protocols/ package (simpler to keep single file)\n- Changing runtime behavior\n\n## Primary Files\n\n- src/protocols.py\n\n## Acceptance Criteria\n\n- [ ] No TYPE_CHECKING imports from cerberus_review, models, quality_gate, session_log_parser, validation.spec\n- [ ] Local Protocol types defined for each removed import\n- [ ] Protocol types match the shape of the original types (structural typing)\n- [ ] `uvx --from import-linter lint-imports --contract \"Layered Architecture\"` - no protocols violations\n- [ ] `uvx ty check` passes (structural typing works)\n- [ ] Tests pass: `uv run pytest tests/ -v -k protocol`\n\n## Test Plan\n\n1. Read current protocols.py TYPE_CHECKING imports\n2. Examine each imported type to understand its shape\n3. Define Protocol types that match the shapes\n4. Remove the TYPE_CHECKING imports\n5. Update method signatures to use new Protocol types\n6. Run `uvx --from import-linter lint-imports` - protocols violations should be gone\n7. Run `uvx ty check` - structural typing should work\n8. Run `uv run pytest tests/ -v -k protocol`\n\n## Notes for Agent\n\n- Protocol types only need the attributes/methods that protocols.py actually uses\n- Use `@runtime_checkable` decorator on Protocol types for isinstance checks\n- Example shape for GateResultProtocol:\n  ```python\n  class GateResultProtocol(Protocol):\n      @property\n      def passed(self) -\u003e bool: ...\n      @property\n      def failure_reasons(self) -\u003e list[str]: ...\n      # ... other used attributes\n  ```\n- Structural typing: implementations don't need to explicitly inherit from Protocol","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-31T16:57:28.51105867Z","created_by":"cyou","updated_at":"2025-12-31T18:54:05.750888886Z","closed_at":"2025-12-31T18:54:05.750888886Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-bp3h.2","depends_on_id":"mala-bp3h","type":"parent-child","created_at":"2025-12-31T16:57:28.518952068Z","created_by":"daemon"}]}
{"id":"mala-bp3h.3","title":"Fix Contract 2 definition (independence to forbidden)","description":"Update Contract 2 \"Domain layer independence\" to match its stated intent.\n\n## Context\n\n- Contract 2 comment says: \"Core domain modules must not depend on orchestration or CLI\"\n- But actual contract is `type = \"independence\"` between lifecycle and models\n- `independence` prevents lifecycle↔models imports - NOT the stated intent\n- lifecycle needs to import ResolutionOutcome from validation.spec (which re-exports from models)\n- The stated intent is domain not depending on UPPER layers (orchestration/CLI)\n\n## Scope\n\n**In:**\n- Update pyproject.toml Contract 2 (lines 157-163):\n  - Change type from `independence` to `forbidden`\n  - Change modules list to source_modules (domain modules)\n  - Add forbidden_modules (orchestration/CLI modules)\n\n**Out:**\n- Code changes to lifecycle.py or models.py\n- Changing actual import structure\n\n## Primary Files\n\n- pyproject.toml\n\n## Contract Change\n\n**Before:**\n```toml\n[[tool.importlinter.contracts]]\nname = \"Domain layer independence\"\ntype = \"independence\"\nmodules = [\n    \"src.lifecycle\",\n    \"src.models\",\n]\n```\n\n**After:**\n```toml\n[[tool.importlinter.contracts]]\nname = \"Domain layer independence\"\ntype = \"forbidden\"\nsource_modules = [\n    \"src.lifecycle\",\n    \"src.models\",\n    \"src.quality_gate\",\n    \"src.validation\",\n    \"src.prompts\",\n]\nforbidden_modules = [\n    \"src.cli\",\n    \"src.main\",\n    \"src.orchestrator\",\n    \"src.orchestrator_factory\",\n    \"src.orchestrator_types\",\n]\n```\n\n## Acceptance Criteria\n\n- [ ] Contract 2 type changed from `independence` to `forbidden`\n- [ ] Contract 2 has source_modules (domain) and forbidden_modules (orchestration/CLI)\n- [ ] `uvx --from import-linter lint-imports --contract \"Domain layer independence\"` passes\n- [ ] No code changes needed - lifecycle can continue importing from validation.spec\n- [ ] Comment updated to match new contract behavior\n\n## Test Plan\n\n1. Run `uvx --from import-linter lint-imports --contract \"Domain layer independence\"` (baseline - should fail)\n2. Update pyproject.toml with new contract definition\n3. Run `uvx --from import-linter lint-imports --contract \"Domain layer independence\"` (should pass)\n4. Run `uv run pytest` (no behavior changes, should still pass)\n\n## Notes for Agent\n\n- This is a semantic shift: independence (bidirectional) → forbidden (unidirectional)\n- After change: lifecycle CAN import from models (same layer, allowed)\n- After change: lifecycle CANNOT import from orchestrator (forbidden)\n- The intent was always \"domain can't depend on upper layers\" not \"domain modules can't depend on each other\"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-31T16:57:49.374773007Z","created_by":"cyou","updated_at":"2025-12-31T18:44:36.744120152Z","closed_at":"2025-12-31T18:44:36.744120152Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-bp3h.3","depends_on_id":"mala-bp3h","type":"parent-child","created_at":"2025-12-31T16:57:49.381715471Z","created_by":"daemon"},{"issue_id":"mala-bp3h.3","depends_on_id":"mala-bp3h.1","type":"blocks","created_at":"2025-12-31T16:59:35.768961487Z","created_by":"daemon"}]}
{"id":"mala-bp3h.4","title":"Create cli_support.py for CLI utilities","description":"Create CLI support module to route CLI utilities through orchestration layer.\n\n## Context\n\n- cli.py directly imports from infra modules:\n  - src.tools.env (line 18): USER_CONFIG_DIR, get_runs_dir, load_user_env\n  - src.tools.locking (line 805 lazy): get_lock_dir\n  - src.log_output.run_metadata (lines 809, 813 lazy): get_running_instances, get_running_instances_for_dir\n  - src.log_output.console (line 106 area): Colors, log, set_verbose\n- This violates \"CLI only depends on orchestrator\" contract\n- Solution: create cli_support.py in orchestration layer that re-exports these\n\n## Scope\n\n**In:**\n- Create `src/cli_support.py` with re-exports:\n  - From src.tools.env: USER_CONFIG_DIR, SCRIPTS_DIR, get_runs_dir, load_user_env\n  - From src.tools.locking: get_lock_dir\n  - From src.log_output.run_metadata: get_running_instances, get_running_instances_for_dir\n  - From src.log_output.console: Colors, log, set_verbose\n- Update cli.py imports to use cli_support\n- Update pyproject.toml: add src.cli_support to orchestration layer (line 143)\n\n**Out:**\n- Moving utilities to orchestration layer (they stay in infra, cli_support just re-exports)\n- Changing utility behavior\n\n## Primary Files\n\n- src/cli_support.py (NEW)\n- src/cli.py\n- pyproject.toml\n\n## Acceptance Criteria\n\n- [ ] `src/cli_support.py` exists with all re-exports\n- [ ] cli.py line 18 imports from cli_support instead of tools.env\n- [ ] cli.py lazy imports (lines 804-815) use cli_support\n- [ ] cli.py console imports (Colors, log, set_verbose) use cli_support\n- [ ] pyproject.toml line 143 includes `src.cli_support`\n- [ ] `uvx --from import-linter lint-imports --contract \"CLI only depends on orchestrator\"` passes\n- [ ] Manual test: `uv run mala status` works\n- [ ] Tests pass: `uv run pytest tests/unit/test_cli*.py -v`\n\n## Test Plan\n\n1. Create src/cli_support.py with re-exports\n2. Update pyproject.toml to add cli_support to orchestration layer\n3. Update cli.py line 18 imports\n4. Update cli.py lazy imports (_LAZY_NAMES, __getattr__ logic)\n5. Update cli.py console imports\n6. Run `uvx --from import-linter lint-imports --contract \"CLI only depends on orchestrator\"`\n7. Run `uv run mala status` (manual verification)\n8. Run `uv run pytest tests/unit/test_cli*.py -v`\n\n## Notes for Agent\n\n- cli_support.py is in orchestration layer but imports from infra - this is allowed (orchestration can import infra)\n- CLI can import from orchestration layer - this fixes the contract\n- Keep cli_support.py focused - only re-exports needed by CLI\n- _LAZY_NAMES in cli.py (lines 30-41) defines lazy-loaded names - these need updates\n- The __getattr__ function (around line 44) handles lazy loading - update source modules","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-31T16:58:12.270790403Z","created_by":"cyou","updated_at":"2025-12-31T19:25:43.028578342Z","closed_at":"2025-12-31T19:25:43.028578342Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-bp3h.4","depends_on_id":"mala-bp3h","type":"parent-child","created_at":"2025-12-31T16:58:12.278440644Z","created_by":"daemon"},{"issue_id":"mala-bp3h.4","depends_on_id":"mala-bp3h.3","type":"blocks","created_at":"2025-12-31T16:59:35.781821115Z","created_by":"daemon"}]}
{"id":"mala-bp3h.5","title":"Merge event_sink_console into event_sink","description":"Merge ConsoleEventSink from event_sink_console.py into event_sink.py.\n\n## Context\n\n- event_sink_console.py imports from event_sink.py (the protocol)\n- import-linter flags this as a \"Layered Architecture\" violation for same-layer imports\n- event_sink.py has MalaEventSink protocol + EventRunConfig + NullEventSink\n- event_sink_console.py has ConsoleEventSink implementation (~300 lines)\n- Neither module is in the \"Infra modules independent\" contract (Contract 6)\n- Merging is simpler than adjusting contract definitions\n\n## Scope\n\n**In:**\n- Move ConsoleEventSink class from event_sink_console.py to event_sink.py\n- Add log_output.console imports to event_sink.py\n- Delete event_sink_console.py\n- Update imports in orchestrator.py (line 13) and orchestrator_factory.py\n- Update pyproject.toml: remove src.event_sink_console from relevant contracts\n\n**Out:**\n- Changing ConsoleEventSink behavior\n- Creating new abstractions\n\n## Primary Files\n\n- src/event_sink.py\n- src/event_sink_console.py (DELETE)\n- src/orchestrator.py\n- src/orchestrator_factory.py\n- pyproject.toml\n\n## Acceptance Criteria\n\n- [ ] ConsoleEventSink class moved to event_sink.py\n- [ ] event_sink_console.py deleted\n- [ ] orchestrator.py imports ConsoleEventSink from event_sink\n- [ ] orchestrator_factory.py imports ConsoleEventSink from event_sink\n- [ ] pyproject.toml: src.event_sink_console removed from line 149, 202, 310\n- [ ] `uvx --from import-linter lint-imports` - no event_sink violations\n- [ ] Tests pass: `uv run pytest tests/ -v -k event_sink`\n- [ ] Linting: `uvx ruff check . \u0026\u0026 uvx ty check`\n\n## Test Plan\n\n1. Read event_sink_console.py to understand ConsoleEventSink implementation\n2. Copy ConsoleEventSink class to event_sink.py (after NullEventSink)\n3. Add imports: from .log_output.console import Colors, log, etc.\n4. Update orchestrator.py line 13: from .event_sink import ConsoleEventSink\n5. Update orchestrator_factory.py similarly\n6. Delete event_sink_console.py\n7. Update pyproject.toml to remove src.event_sink_console references\n8. Run `uvx --from import-linter lint-imports`\n9. Run `uv run pytest tests/ -v -k event_sink`\n10. Run `uvx ruff check . \u0026\u0026 uvx ty check`\n\n## Notes for Agent\n\n- ConsoleEventSink uses Colors and log from log_output.console\n- Keep the class structure intact - just move it\n- event_sink.py will grow but stays under 500 lines\n- Preserve all existing docstrings and formatting","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-31T16:58:31.920297318Z","created_by":"cyou","updated_at":"2025-12-31T19:45:40.457052006Z","closed_at":"2025-12-31T19:45:40.457052006Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-bp3h.5","depends_on_id":"mala-bp3h","type":"parent-child","created_at":"2025-12-31T16:58:31.927328522Z","created_by":"daemon"},{"issue_id":"mala-bp3h.5","depends_on_id":"mala-bp3h.4","type":"blocks","created_at":"2025-12-31T16:59:35.789147838Z","created_by":"daemon"},{"issue_id":"mala-bp3h.5","depends_on_id":"mala-bp3h.1","type":"blocks","created_at":"2025-12-31T16:59:35.796004764Z","created_by":"daemon"}]}
{"id":"mala-bp3h.6","title":"Move BraintrustProvider to braintrust_integration","description":"Move BraintrustProvider and BraintrustSpan from telemetry.py to braintrust_integration.py.\n\n## Context\n\n- telemetry.py imports from braintrust_integration.py (lines 166, 220, 248)\n- BraintrustProvider (lines 199-250) and BraintrustSpan (lines 154-197) wrap braintrust_integration\n- import-linter flags this as a \"Layered Architecture\" violation\n- These classes belong in braintrust_integration.py since they're Braintrust-specific\n- telemetry.py should only have the abstract protocol and null implementations\n\n## Scope\n\n**In:**\n- Move BraintrustSpan class (lines 154-197) to braintrust_integration.py\n- Move BraintrustProvider class (lines 199-250) to braintrust_integration.py\n- Keep in telemetry.py: TelemetryProvider protocol, TelemetrySpan protocol, NullTelemetryProvider, NullSpan\n- Update orchestrator.py line 15: import BraintrustProvider from braintrust_integration\n- Update orchestrator_factory.py similarly\n\n**Out:**\n- Changing provider behavior\n- Moving abstract protocols\n\n## Primary Files\n\n- src/telemetry.py\n- src/braintrust_integration.py\n- src/orchestrator.py\n- src/orchestrator_factory.py\n\n## Acceptance Criteria\n\n- [ ] BraintrustSpan class moved to braintrust_integration.py\n- [ ] BraintrustProvider class moved to braintrust_integration.py\n- [ ] telemetry.py only has protocols and null implementations\n- [ ] telemetry.py has no imports from braintrust_integration\n- [ ] orchestrator.py imports BraintrustProvider from braintrust_integration\n- [ ] orchestrator_factory.py imports BraintrustProvider from braintrust_integration\n- [ ] `uvx --from import-linter lint-imports` - no telemetry violations\n- [ ] Tests pass: `uv run pytest tests/ -v -k \"telemetry or braintrust\"`\n- [ ] Linting: `uvx ruff check . \u0026\u0026 uvx ty check`\n\n## Test Plan\n\n1. Read telemetry.py to identify BraintrustSpan and BraintrustProvider\n2. Read braintrust_integration.py to understand its structure\n3. Move BraintrustSpan to braintrust_integration.py\n4. Move BraintrustProvider to braintrust_integration.py\n5. The runtime imports (TracedAgentExecution, is_braintrust_enabled, flush_braintrust) now become local\n6. Update orchestrator.py: from .braintrust_integration import BraintrustProvider\n7. Update orchestrator_factory.py similarly\n8. Run `uvx --from import-linter lint-imports`\n9. Run `uv run pytest tests/ -v -k \"telemetry or braintrust\"`\n10. Run `uvx ruff check . \u0026\u0026 uvx ty check`\n\n## Notes for Agent\n\n- BraintrustSpan imports from braintrust_integration at runtime (line 166) - these become local after move\n- BraintrustProvider imports is_braintrust_enabled and flush_braintrust - these become local after move\n- telemetry.py should still export TelemetryProvider and TelemetrySpan protocols\n- The moved classes may need to import protocols from telemetry.py (for type hints) - use TYPE_CHECKING","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-31T16:58:53.356223858Z","created_by":"cyou","updated_at":"2025-12-31T19:52:41.896057634Z","closed_at":"2025-12-31T19:52:41.896057634Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-bp3h.6","depends_on_id":"mala-bp3h","type":"parent-child","created_at":"2025-12-31T16:58:53.362899464Z","created_by":"daemon"},{"issue_id":"mala-bp3h.6","depends_on_id":"mala-bp3h.5","type":"blocks","created_at":"2025-12-31T16:59:35.802963799Z","created_by":"daemon"}]}
{"id":"mala-bp3h.7","title":"Update test imports + final verification","description":"Update test imports for moved types and run final verification.\n\n## Context\n\n- Tasks 1-6 move types between modules\n- Tests may import from old locations that no longer exist\n- Need to update all test imports to use new paths\n- Final verification: all 9 import-linter contracts must pass\n\n## Scope\n\n**In:**\n- Search for test files importing from old locations\n- Update imports to new paths:\n  - OrchestratorConfig from orchestrator_types (not orchestrator_factory)\n  - ConsoleEventSink from event_sink (not event_sink_console)\n  - BraintrustProvider from braintrust_integration (not telemetry)\n  - CLI utilities from cli_support (if any tests use them)\n- Update mock paths (e.g., @patch decorators)\n- Run final verification\n\n**Out:**\n- Changing test logic\n- Adding new tests\n\n## Primary Files\n\n- tests/**/*.py (various)\n\n## Search Patterns\n\n```bash\n# Orchestrator types\ngrep -r \"from src.orchestrator_factory import OrchestratorConfig\" tests/\ngrep -r \"from src.orchestrator_factory import OrchestratorDependencies\" tests/\ngrep -r \"from src.orchestrator_factory import DEFAULT_AGENT_TIMEOUT\" tests/\n\n# Event sink\ngrep -r \"from src.event_sink_console import\" tests/\n\n# Telemetry\ngrep -r \"from src.telemetry import BraintrustProvider\" tests/\ngrep -r \"from src.telemetry import BraintrustSpan\" tests/\n\n# Mock paths\ngrep -r \"@patch.*orchestrator_factory\" tests/\ngrep -r \"@patch.*event_sink_console\" tests/\ngrep -r \"@patch.*telemetry\" tests/\n```\n\n## Acceptance Criteria\n\n- [ ] No test imports from deleted modules (event_sink_console)\n- [ ] No test imports from moved types at old locations\n- [ ] All mock paths updated to new module locations\n- [ ] `uvx --from import-linter lint-imports` - ALL 9 contracts pass\n- [ ] `uvx ruff check .` passes\n- [ ] `uvx ty check` passes\n- [ ] `uv run pytest -m \"unit or integration\" -n auto` passes\n- [ ] Coverage threshold: 85%\n\n## Test Plan\n\n1. Run grep patterns to find test files needing updates\n2. Update each import to use new path\n3. Update mock paths in @patch decorators\n4. Run `uvx --from import-linter lint-imports` - should show 9/9 contracts pass\n5. Run `uvx ruff check .`\n6. Run `uvx ty check`\n7. Run `uv run pytest -m \"unit or integration\" -n auto`\n8. Verify coverage threshold met\n\n## Notes for Agent\n\n- This task depends on ALL other tasks completing first\n- Focus on imports and mocks, not test logic\n- If a test imports a type that was moved, just update the import path\n- Some mocks may patch module paths - update to new module locations","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-31T16:59:13.999166622Z","created_by":"cyou","updated_at":"2025-12-31T20:49:59.257825953Z","closed_at":"2025-12-31T20:49:59.257825953Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-bp3h.7","depends_on_id":"mala-bp3h","type":"parent-child","created_at":"2025-12-31T16:59:14.010244961Z","created_by":"daemon"},{"issue_id":"mala-bp3h.7","depends_on_id":"mala-bp3h.1","type":"blocks","created_at":"2025-12-31T16:59:23.245715303Z","created_by":"daemon"},{"issue_id":"mala-bp3h.7","depends_on_id":"mala-bp3h.2","type":"blocks","created_at":"2025-12-31T16:59:23.259531244Z","created_by":"daemon"},{"issue_id":"mala-bp3h.7","depends_on_id":"mala-bp3h.3","type":"blocks","created_at":"2025-12-31T16:59:23.266560999Z","created_by":"daemon"},{"issue_id":"mala-bp3h.7","depends_on_id":"mala-bp3h.4","type":"blocks","created_at":"2025-12-31T16:59:23.273228626Z","created_by":"daemon"},{"issue_id":"mala-bp3h.7","depends_on_id":"mala-bp3h.5","type":"blocks","created_at":"2025-12-31T16:59:23.279600625Z","created_by":"daemon"},{"issue_id":"mala-bp3h.7","depends_on_id":"mala-bp3h.6","type":"blocks","created_at":"2025-12-31T16:59:23.285950445Z","created_by":"daemon"}]}
{"id":"mala-buj","title":"Remove unused sync git functions","description":"## Context\n- `get_git_commit()` and `get_git_branch()` (sync versions) are defined but never called\n- Only async versions (`get_git_commit_async`, `get_git_branch_async`) are used by orchestrator\n- ~30 lines of dead code\n- Confidence: High - grep confirms no callers\n\n## Primary Files\n`src/git_utils.py:14-45`\n\n## Scope\n**In:** Remove `get_git_commit` and `get_git_branch` sync functions\n**Out:** Keep async versions and `DEFAULT_GIT_TIMEOUT` constant\n\n## Acceptance Criteria\n- Sync functions removed\n- No import errors\n- Tests pass\n\n## Test Plan\n- Run `uv run pytest`\n- Verify module imports cleanly: `python -c \"from src.git_utils import get_git_commit_async\"`\n\n## Notes for Agent\n- Keep the module docstring and async functions intact\n- The sync functions are lines 14-45, async are 51-100","status":"closed","priority":2,"issue_type":"chore","created_at":"2025-12-26T19:44:58.439537512Z","updated_at":"2025-12-26T19:52:03.649089915Z","closed_at":"2025-12-26T19:52:03.649089915Z","close_reason":"Closed","labels":["dead-code"],"dependencies":[{"issue_id":"mala-buj","depends_on_id":"mala-7zq","type":"parent-child","created_at":"2025-12-26T19:45:26.554545264Z","created_by":"daemon"}]}
{"id":"mala-bvd","title":"Other Improvements","description":"General improvements:\n- Deadlock detection (two agents waiting on each other)\n- Metrics/logging for multi-agent sessions\n- Graceful shutdown (signal all agents to wrap up)","status":"tombstone","priority":2,"issue_type":"epic","created_at":"2025-12-26T00:54:39.298081197Z","updated_at":"2025-12-26T00:55:27.989133028Z","deleted_at":"2025-12-26T00:55:27.989133028Z","deleted_by":"daemon","delete_reason":"delete","original_type":"epic"}
{"id":"mala-c01","title":"Epic: CLI module refactor (split cli.py)","description":"Parent epic for refactoring src/cli.py into focused modules without changing behavior. Children: hook extraction, git helper extraction, orchestrator extraction.","status":"closed","priority":3,"issue_type":"epic","created_at":"2025-12-25T21:41:59.788032839Z","updated_at":"2025-12-26T00:15:59.835213834Z","closed_at":"2025-12-26T00:15:59.835213834Z","close_reason":"All children completed"}
{"id":"mala-c01.1","title":"Refactor: extract beads client from cli.py","description":"Goal: Extract beads-related logic from MalaOrchestrator into a dedicated BeadsClient class (e.g., src/beads_client.py) that wraps bd CLI calls.\n\nScope/files: src/cli.py, new src/beads_client.py.\n\nWork:\n- Create BeadsClient class with methods: get_ready_issues(), claim_issue(), reset_issue(), commit_issues(), close_eligible_epics().\n- Move bd CLI subprocess calls from MalaOrchestrator to BeadsClient.\n- Have MalaOrchestrator use BeadsClient instance.\n- Keep CLI behavior unchanged.\n\nAcceptance criteria:\n- All bd CLI calls go through BeadsClient.\n- MalaOrchestrator behavior unchanged.\n- CLI still works.\n- Tests (if any) still pass.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-25T22:15:22.761330846Z","updated_at":"2025-12-26T00:09:17.45761968Z","closed_at":"2025-12-26T00:09:17.45761968Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-c01.1","depends_on_id":"mala-c01","type":"parent-child","created_at":"2025-12-25T22:15:22.771293472Z","created_by":"daemon"}]}
{"id":"mala-c1o","title":"Implement coverage parsing + threshold handling","description":"Context:\n- Coverage gate requires parsing pytest coverage output and enforcing thresholds.\n- Plan uses XML + min-percent thresholds.\n\nScope:\n- In: parse coverage XML and return CoverageResult; handle threshold comparison and error reporting.\n- Out: orchestrator gating logic (separate task).\n\nAcceptance Criteria:\n- CoverageResult includes percent, pass/fail, report path.\n- Parser handles missing/invalid report with clear failure reason.\n\nTest Plan:\n- TDD: add unit tests with fixture XMLs for pass/fail/invalid.\n- Run coverage module tests.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T23:00:01.67857076Z","updated_at":"2025-12-27T00:03:14.562228529Z","closed_at":"2025-12-27T00:03:14.562228529Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-c1o","depends_on_id":"mala-j6p","type":"blocks","created_at":"2025-12-26T23:00:26.478117705Z","created_by":"daemon"}]}
{"id":"mala-c5n","title":"Replace exponential backoff with simple 1s polling for lock waits","description":"## Problem\nThe implementer prompt instructs agents to use exponential backoff (10s, 20s, 40s, 80s, 160s, 320s, 640s) when waiting for locks. This has two issues:\n\n1. **Noisy logs**: Agents print a message every time they sleep, cluttering output\n2. **Over-engineering**: Exponential backoff adds complexity; a simple 1-second polling loop is simpler and equally effective for file locks\n\n## Current Behavior\nFrom src/prompts/implementer_prompt.md:53:\n```\n- Use exponential backoff: 10s, 20s, 40s, 80s, 160s, 320s, 640s (max 15 min total)\n```\n\n## Proposed Solution\n\nOption A: Add a helper script (e.g., `scripts/lock-wait.sh`) that:\n- Takes a file path and agent ID\n- Polls every 1 second until lock is available\n- Prints status only once at start and once when acquired\n- Agent calls this instead of implementing backoff loop\n\nOption B: Update prompt to use simpler guidance:\n- Replace exponential backoff with 'poll every 1 second'\n- Tell agent not to print on every poll, just when starting and when acquired\n\n## Acceptance Criteria\n- Agents no longer spam logs while waiting for locks\n- Lock waiting behavior is simple (1s fixed interval)\n- Either via helper script or updated prompt guidance","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T17:07:53.583339508Z","updated_at":"2025-12-26T17:16:00.837069817Z","closed_at":"2025-12-26T17:16:00.837069817Z","close_reason":"Closed"}
{"id":"mala-c7wb","title":"[Review] src/domain/validation/tool_name_extractor.py:255-257: [P2] Shell operator splitting doesn't respect quoted strings","description":"## Review Finding\n\nThis issue was auto-created from a P2 review finding.\n\n**Source issue:** mala-fdp1.5\n**Reviewer:** claude\n**Location:** src/domain/validation/tool_name_extractor.py:255-257\n\n## Details\n\nThe operator splitting at lines 255-271 uses simple `command.split(operator)` which doesn't respect quoted strings. For example, `eslint --rule \"semi \u0026\u0026 no-console\"` would incorrectly split on the `\u0026\u0026` inside quotes, potentially returning wrong results. Consider using shlex parsing first, then identifying operator boundaries, though this is an edge case for typical quality gate commands.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T03:17:47.83203058Z","created_by":"cyou","updated_at":"2026-01-02T03:55:38.83776056Z","closed_at":"2026-01-02T03:55:38.83776056Z","close_reason":"Closed","labels":["auto_generated","review_finding","review_finding:0d4d7a0af016","source:mala-fdp1.5"]}
{"id":"mala-cavk","title":"Epic: Architecture refactor - break up god classes","description":"# Architecture Refactor: High-Priority God Class Breakup\n\n**Spec**: `docs/2026-01-01-architecture-review.md`\n**Plan**: `docs/2026-01-01-architecture-refactor-plan.md`\n\n## Prerequisites\n\n**Depends on mala-iy6l** (Import-linter package restructure). The iy6l epic restructures the codebase into layer-based packages, and this refactor assumes those paths:\n- `src/orchestrator.py` → `src/orchestration/orchestrator.py`\n- `src/cli.py` → `src/cli/cli.py`\n\n## Goals\n- Reduce complexity and duplication in 3 high-priority areas identified in architecture review\n- Pure refactoring - no behavioral changes\n- Deliver as 3 incremental PRs that can be reviewed and merged independently\n\n## PRs (in order)\n1. **EventSink** - Create BaseEventSink to eliminate NullEventSink duplication (NullEventSink \u003c20 lines)\n2. **AgentSessionRunner** - Extract run_session into focused helpers (675 → \u003c100 lines)  \n3. **MalaOrchestrator** - Extract IssueExecutionCoordinator + remove legacy init (1565 → \u003c1000 lines)\n\n## Acceptance Criteria\n- [ ] NullEventSink reduced to \u003c20 lines\n- [ ] run_session reduced to \u003c100 lines\n- [ ] Legacy init removed from MalaOrchestrator\n- [ ] All existing tests pass\n- [ ] New unit tests for extracted helpers","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-01-01T15:57:41.331463831Z","created_by":"cyou","updated_at":"2026-01-02T02:54:15.490652164Z","closed_at":"2026-01-02T02:54:15.490652164Z","close_reason":"All children completed","labels":["god-class"]}
{"id":"mala-cavk.1","title":"PR 1: EventSink - Create BaseEventSink and simplify NullEventSink","description":"# EventSink Refactor: Eliminate NullEventSink Duplication\n\n**Plan Task**: Task 1 from `docs/2026-01-01-architecture-refactor-plan.md`\n**PR**: 1 of 3 (safest, no behavioral impact - do first)\n\n## Context\n- `MalaEventSink` Protocol: lines 55-600 (~38 methods) in `src/infra/io/event_sink.py`\n- `NullEventSink` class: lines 601-835 (235 lines) - all methods are just `pass`\n- `ConsoleEventSink` class: lines 837-1396 (560 lines) - real implementations\n- **Problem**: Every new event requires updating 3 places (protocol, NullEventSink, ConsoleEventSink)\n- **Verified**: `MalaEventSink` is `@runtime_checkable` (line 55), so isinstance checks work\n\n## Scope\n**In**: \n- Create `BaseEventSink` class with explicit no-op `pass` implementations for all 38 protocol methods\n- Replace `NullEventSink` (235 lines) with `NullEventSink = BaseEventSink` or thin 3-line subclass\n- Update `ConsoleEventSink` to inherit from `BaseEventSink`, remove redundant `pass` methods\n\n**Out**: \n- Changing event method signatures\n- Modifying ConsoleEventSink logic (only structure)\n- Adding new events\n\n## Primary Files\n- `src/infra/io/event_sink.py` (main changes)\n- `tests/test_event_sink.py` (add BaseEventSink tests)\n\n## Acceptance Criteria\n- [ ] `BaseEventSink` class exists with all 38 protocol methods as no-ops\n- [ ] `NullEventSink` is \u003c20 lines (alias or thin subclass)\n- [ ] `ConsoleEventSink` inherits from `BaseEventSink`\n- [ ] Adding new event requires only: 1) protocol, 2) BaseEventSink, 3) ConsoleEventSink override if needed\n- [ ] `isinstance(BaseEventSink(), MalaEventSink)` returns True\n- [ ] All existing tests pass unchanged\n\n## Test Plan\n- Add test: `BaseEventSink` implements `MalaEventSink` protocol (isinstance check)\n- Add test: `NullEventSink` is usable as `MalaEventSink`\n- Run: `uvx ty check` - type checking passes\n- Run: `uv run pytest tests/test_event_sink.py -v`\n- Run: `uv run pytest -m \"unit or integration\"` - full suite passes\n- Verify line count: `wc -l` on NullEventSink class definition\n\n## Notes for Agent\n- BaseEventSink goes AFTER MalaEventSink protocol definition (around line 600)\n- Copy method signatures exactly from NullEventSink - just consolidate them\n- Don't change any method bodies in ConsoleEventSink, just remove inheritance boilerplate\n- This is the safest PR - pure structural change with no behavioral impact","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-01T15:58:09.767302696Z","created_by":"cyou","updated_at":"2026-01-01T21:02:01.945495114Z","closed_at":"2026-01-01T21:02:01.945495114Z","close_reason":"Closed","labels":["refactor"],"dependencies":[{"issue_id":"mala-cavk.1","depends_on_id":"mala-cavk","type":"parent-child","created_at":"2026-01-01T15:58:09.775130264Z","created_by":"daemon"}]}
{"id":"mala-cavk.2","title":"PR 2: AgentSessionRunner - Extract run_session into focused helpers","description":"# AgentSessionRunner.run_session Extraction\n\n**Plan Tasks**: Tasks 2-6 from `docs/2026-01-01-architecture-refactor-plan.md`\n**PR**: 2 of 3\n\n## Context\n- `run_session` method: lines 389-1064 (675 lines) with CCN 84 (extreme complexity)\n- Method handles: SDK setup, message streaming, idle timeout retry, log waiting, gate checks, review checks\n- Existing helper pattern to follow: `_build_hooks()`, `_build_agent_env()` already exist\n\n## Scope\n**In**: Extract 5 helper methods from run_session:\n1. `_build_sdk_options(agent_id: str) -\u003e ClaudeAgentOptions` - SDK options construction (lines 446-468)\n2. `_run_message_iteration(client, input, lifecycle_ctx, iter_ctx: MessageIterationContext) -\u003e bool` - Message streaming with idle timeout (lines 516-748)\n3. `_handle_log_waiting(session_id, lifecycle, lifecycle_ctx) -\u003e tuple[Path | None, TransitionResult]` - WAIT_FOR_LOG handling (lines 772-802)\n4. `_handle_gate_effect(input, log_path, lifecycle, lifecycle_ctx) -\u003e tuple[str | None, bool]` - RUN_GATE handling (lines 804-879)\n5. `_handle_review_effect(input, log_path, lifecycle, lifecycle_ctx) -\u003e tuple[str | None, bool, str | None]` - RUN_REVIEW handling (lines 881-1033)\n\nAlso create `MessageIterationContext` dataclass for mutable state:\n- `session_id: str | None`\n- `tool_calls_count: int`  \n- `pending_lint_commands: dict[str, tuple[str, str]]`\n\n**Out**:\n- Changing lifecycle state machine design\n- Modifying SDK client protocol\n- Any behavioral changes\n\n## Primary Files\n- `src/pipeline/agent_session_runner.py` (main refactor)\n- `tests/test_agent_session_runner.py` (add helper unit tests)\n\n## Acceptance Criteria\n- [ ] `run_session` reduced to \u003c100 lines orchestrating helpers\n- [ ] Each extracted helper has single responsibility\n- [ ] `MessageIterationContext` dataclass holds mutable iteration state\n- [ ] All existing agent session tests pass unchanged\n- [ ] New unit tests for each extracted helper method\n\n## Test Plan\n**TDD approach for each helper:**\n1. Add unit test for helper in isolation\n2. Extract helper from run_session\n3. Verify existing tests still pass\n\nRun after each extraction:\n- `uv run pytest tests/test_agent_session_runner.py -v`\n- `uv run pytest -m \"unit or integration\"` after all extractions\n\nVerify final line count: `run_session` \u003c100 lines\n\n## Notes for Agent\n- Follow existing pattern of `_build_hooks()` and `_build_agent_env()` for naming/style\n- `MessageIterationContext` is passed by reference to avoid complex return types\n- Helper methods should be private (`_` prefix)\n- Preserve exact behavior - use existing tests as behavioral specification\n- Handle IdleTimeoutError internally in `_run_message_iteration()`\n- Line numbers are approximate - use the code structure to identify extraction boundaries","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-01T15:58:44.82595465Z","created_by":"cyou","updated_at":"2026-01-01T21:33:48.173252332Z","closed_at":"2026-01-01T21:33:48.173252332Z","close_reason":"Closed","labels":["complexity"],"dependencies":[{"issue_id":"mala-cavk.2","depends_on_id":"mala-cavk","type":"parent-child","created_at":"2026-01-01T15:58:44.832897355Z","created_by":"daemon"},{"issue_id":"mala-cavk.2","depends_on_id":"mala-cavk.1","type":"blocks","created_at":"2026-01-01T15:59:38.845707389Z","created_by":"daemon"}]}
{"id":"mala-cavk.3","title":"PR 3: MalaOrchestrator - Extract IssueExecutionCoordinator and remove legacy init","description":"# MalaOrchestrator Split: IssueExecutionCoordinator + Legacy Init Removal\n\n**Plan Tasks**: Tasks 7-9 from `docs/2026-01-01-architecture-refactor-plan.md`\n**PR**: 3 of 3 (largest, do last)\n\n## Context\n- `MalaOrchestrator`: 1565 lines with dual init paths (legacy + factory)\n- `_run_main_loop` (lines 1351-1449): Main agent spawning loop\n- `spawn_agent`, `_finalize_issue_result`, `_abort_active_tasks`: Execution logic\n- 55+ test locations use legacy `MalaOrchestrator()` constructor across 5 test files\n\n## Scope\n**In** (3 subtasks):\n\n### Subtask 3a: Create IssueExecutionCoordinator\n- **New** `src/pipeline/issue_execution_coordinator.py`:\n  - `IssueExecutionCoordinator` class with protocol-based dependencies\n  - Constructor: `beads: IssueProvider`, `event_sink: MalaEventSink`, `config: CoordinatorConfig`\n  - `IssueProvider` imported from `src.core.protocols`\n  - `CoordinatorConfig` dataclass: `max_agents`, `max_issues`, `epic_id`, `only_ids`, `prioritize_wip`, `focus`\n  - `async def run_loop(spawn_callback, finalize_callback) -\u003e int`\n  - `async def abort_active_tasks(reason: str) -\u003e None`\n- Update `src/pipeline/__init__.py`: export `IssueExecutionCoordinator`, `CoordinatorConfig`\n- **New** `tests/test_issue_execution_coordinator.py`: unit tests with mock IssueProvider\n\n### Subtask 3b: Migrate MalaOrchestrator\n- Update `src/orchestrator.py` to use `IssueExecutionCoordinator`\n- `_run_main_loop` delegates to `coordinator.run_loop()`\n- Keep `spawn_agent` and `_finalize_issue_result` as callbacks\n\n### Subtask 3c: Remove legacy init\n- Remove legacy `__init__` overload (lines 312-340)\n- Remove `_init_legacy` method entirely\n- Update 55+ test locations across 5 files:\n  - `tests/test_orchestrator.py` (~45 locations)\n  - `tests/test_epic_verifier.py` (2 locations)\n  - `tests/test_run_level_validation.py` (4 locations)\n  - `tests/test_wip_prioritization.py` (4 locations)\n  - `tests/test_morph_integration.py` (1 location)\n- Create `make_orchestrator()` fixture in `tests/conftest.py`\n\n**Out**:\n- Changing factory pattern in `orchestrator_factory.py`\n- Breaking public `MalaOrchestrator` API for factory users\n- Line count target of \u003c400 (realistic target is \u003c1000)\n\n## Primary Files\n- `src/pipeline/issue_execution_coordinator.py` (**New**)\n- `src/pipeline/__init__.py` (add exports)\n- `src/orchestrator.py` (delegate + remove legacy)\n- `tests/test_issue_execution_coordinator.py` (**New**)\n- `tests/conftest.py` (add fixture)\n- `tests/test_orchestrator.py` (update ~45 locations)\n- `tests/test_epic_verifier.py`, `tests/test_run_level_validation.py`, `tests/test_wip_prioritization.py`, `tests/test_morph_integration.py` (update legacy calls)\n\n## Acceptance Criteria\n- [ ] `IssueExecutionCoordinator` exists and is testable without SDK dependencies\n- [ ] `src/pipeline/__init__.py` exports new coordinator\n- [ ] MalaOrchestrator delegates to coordinator\n- [ ] Legacy init path completely removed\n- [ ] No `MalaOrchestrator(` direct constructor calls remain in tests/src\n- [ ] `orchestrator.py` reduced to \u003c1000 lines\n- [ ] All 55+ test locations updated to use factory pattern\n- [ ] All existing tests pass\n\n## Test Plan\n1. Create coordinator with unit tests first (TDD)\n2. Migrate orchestrator to use coordinator\n3. Verify: `uv run pytest tests/test_orchestrator.py -v`\n4. Create `make_orchestrator()` fixture in conftest.py\n5. Update all test files to use fixture\n6. Final verification: `uv run pytest -m \"unit or integration\" -n auto`\n7. Verify no legacy usage: `grep -r \"MalaOrchestrator(\" tests/ src/`\n\n## Notes for Agent\n- This is the largest PR - consider doing subtasks incrementally with commits\n- `IssueProvider` comes from `src.core.protocols`\n- The \u003c400 line target is NOT achievable with this scope; \u003c1000 is realistic\n- Factory pattern is already used by `cli.py` via `create_orchestrator()`\n- When updating tests, use the new fixture rather than inline factory calls\n- Coordinator should NOT have SDK dependencies - use callbacks for agent spawning","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-01T15:59:24.862850525Z","created_by":"cyou","updated_at":"2026-01-01T22:21:12.192390898Z","closed_at":"2026-01-01T22:21:12.192390898Z","close_reason":"Closed","labels":["legacy-removal"],"dependencies":[{"issue_id":"mala-cavk.3","depends_on_id":"mala-cavk","type":"parent-child","created_at":"2026-01-01T15:59:24.870444296Z","created_by":"daemon"},{"issue_id":"mala-cavk.3","depends_on_id":"mala-cavk.2","type":"blocks","created_at":"2026-01-01T15:59:39.538985971Z","created_by":"daemon"}]}
{"id":"mala-cavk.4","title":"[Remediation] run_session reduced to \u003c100 lines","description":"## Context\nThis issue was auto-created by epic verification for epic `mala-cavk`.\n\n## Epic Description / Acceptance Criteria\nTitle: Epic: Architecture refactor - break up god classes\n\n# Architecture Refactor: High-Priority God Class Breakup\n\n**Spec**: `docs/2026-01-01-architecture-review.md`\n**Plan**: `docs/2026-01-01-architecture-refactor-plan.md`\n\n## Prerequisites\n\n**Depends on mala-iy6l** (Import-linter package restructure). The iy6l epic restructures the codebase into layer-based packages, and this refactor assumes those paths:\n- `src/orchestrator.py` → `src/orchestration/orchestrator.py`\n- `src/cli.py` → `src/cli/cli.py`\n\n## Goals\n- Reduce complexity and duplication in 3 high-priority areas identified in architecture review\n- Pure refactoring - no behavioral changes\n- Deliver as 3 incremental PRs that can be reviewed and merged independently\n\n## PRs (in order)\n1. **EventSink** - Create BaseEventSink to eliminate NullEventSink duplication (NullEventSink \u003c20 lines)\n2. **AgentSessionRunner** - Extract run_session into focused helpers (675 → \u003c100 lines)  \n3. **MalaOrchestrator** - Extract IssueExecutionCoordinator + remove legacy init (1565 → \u003c1000 lines)\n\n## Acceptance Criteria\n- [ ] NullEventSink reduced to \u003c20 lines\n- [ ] run_session reduced to \u003c100 lines\n- [ ] Legacy init removed from MalaOrchestrator\n- [ ] All existing tests pass\n- [ ] New unit tests for extracted helpers\n\n## Commit Scope\n- Range hint: b826537c90ea28c402742c605757be17820e0fc0^..6817b912b7e448c22748fb6778e5a7c3d5582992\n- Commits:\n- 942c6b2f8efd65b778f7f9c3036fbb05091d115e bd-mala-cavk.1: Fix protocol coverage tests to exclude ABCMeta helpers\n- b826537c90ea28c402742c605757be17820e0fc0 bd-mala-cavk.1: Create BaseEventSink, simplify NullEventSink\n- 46c0f46abccd2af19b1d68380e7957114133f76c bd-mala-cavk.2: Extract helpers from AgentSessionRunner.run_session\n- efb74872758e0863c8d0dd5b72ed0ff2f3a6fd0a bd-mala-cavk.2: Extract helpers from AgentSessionRunner.run_session\n- 6817b912b7e448c22748fb6778e5a7c3d5582992 bd-mala-cavk.3: Fix ruff TC003 type-checking import violations\n- 99e411ab4383d9e7d840a4678d98b9d1cfb2205c bd-mala-cavk.3: Fix type annotations and linting issues in test files\n- 977be4d0c6064476546a918b59f5ad49f0c5f63c bd-mala-cavk.3: Extract IssueExecutionCoordinator from MalaOrchestrator\n\n## Child Issues\n- mala-cavk.1\n- mala-cavk.2\n- mala-cavk.3\n- mala-dhry\n- mala-jnah\n\n## Unmet Criterion\nrun_session reduced to \u003c100 lines\n\n## Evidence\nAgentSessionRunner.run_session method spans lines 1114-1376 (262 lines total), significantly exceeding the \u003c100 line target despite helper extraction efforts in commits 46c0f46 and efb7487\n\n## Priority\nP1 (blocking)\n\n## Resolution\nAddress this criterion to unblock epic closure. When complete, close this issue.\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-01T22:23:07.379158233Z","created_by":"cyou","updated_at":"2026-01-01T22:35:35.169377921Z","closed_at":"2026-01-01T22:35:35.169377921Z","close_reason":"Closed","labels":["auto_generated","epic_remediation:mala-cavk:3526d7861e2fd47da405e92ba4b621f62fb96993da0f8ffe05424fa7df7b751a"],"dependencies":[{"issue_id":"mala-cavk.4","depends_on_id":"mala-cavk","type":"parent-child","created_at":"2026-01-01T22:23:07.379608422Z","created_by":"daemon"}]}
{"id":"mala-cavk.5","title":"[Remediation] MalaOrchestrator reduced to \u003c1000 lines","description":"## Context\nThis issue was auto-created by epic verification for epic `mala-cavk`.\n\n## Epic Description / Acceptance Criteria\nTitle: Epic: Architecture refactor - break up god classes\n\n# Architecture Refactor: High-Priority God Class Breakup\n\n**Spec**: `docs/2026-01-01-architecture-review.md`\n**Plan**: `docs/2026-01-01-architecture-refactor-plan.md`\n\n## Prerequisites\n\n**Depends on mala-iy6l** (Import-linter package restructure). The iy6l epic restructures the codebase into layer-based packages, and this refactor assumes those paths:\n- `src/orchestrator.py` → `src/orchestration/orchestrator.py`\n- `src/cli.py` → `src/cli/cli.py`\n\n## Goals\n- Reduce complexity and duplication in 3 high-priority areas identified in architecture review\n- Pure refactoring - no behavioral changes\n- Deliver as 3 incremental PRs that can be reviewed and merged independently\n\n## PRs (in order)\n1. **EventSink** - Create BaseEventSink to eliminate NullEventSink duplication (NullEventSink \u003c20 lines)\n2. **AgentSessionRunner** - Extract run_session into focused helpers (675 → \u003c100 lines)  \n3. **MalaOrchestrator** - Extract IssueExecutionCoordinator + remove legacy init (1565 → \u003c1000 lines)\n\n## Acceptance Criteria\n- [ ] NullEventSink reduced to \u003c20 lines\n- [ ] run_session reduced to \u003c100 lines\n- [ ] Legacy init removed from MalaOrchestrator\n- [ ] All existing tests pass\n- [ ] New unit tests for extracted helpers\n\n## Commit Scope\n- Range hint: b826537c90ea28c402742c605757be17820e0fc0^..6817b912b7e448c22748fb6778e5a7c3d5582992\n- Commits:\n- 942c6b2f8efd65b778f7f9c3036fbb05091d115e bd-mala-cavk.1: Fix protocol coverage tests to exclude ABCMeta helpers\n- b826537c90ea28c402742c605757be17820e0fc0 bd-mala-cavk.1: Create BaseEventSink, simplify NullEventSink\n- 46c0f46abccd2af19b1d68380e7957114133f76c bd-mala-cavk.2: Extract helpers from AgentSessionRunner.run_session\n- efb74872758e0863c8d0dd5b72ed0ff2f3a6fd0a bd-mala-cavk.2: Extract helpers from AgentSessionRunner.run_session\n- 6817b912b7e448c22748fb6778e5a7c3d5582992 bd-mala-cavk.3: Fix ruff TC003 type-checking import violations\n- 99e411ab4383d9e7d840a4678d98b9d1cfb2205c bd-mala-cavk.3: Fix type annotations and linting issues in test files\n- 977be4d0c6064476546a918b59f5ad49f0c5f63c bd-mala-cavk.3: Extract IssueExecutionCoordinator from MalaOrchestrator\n\n## Child Issues\n- mala-cavk.1\n- mala-cavk.2\n- mala-cavk.3\n- mala-dhry\n- mala-jnah\n\n## Unmet Criterion\nMalaOrchestrator reduced to \u003c1000 lines\n\n## Evidence\nsrc/orchestration/orchestrator.py contains 1368 lines, exceeding the \u003c1000 line target. While IssueExecutionCoordinator was extracted and ~170 lines were removed (1537→1367), it still exceeds the target by 368 lines\n\n## Priority\nP1 (blocking)\n\n## Resolution\nAddress this criterion to unblock epic closure. When complete, close this issue.\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-01T22:23:07.394553296Z","created_by":"cyou","updated_at":"2026-01-01T22:55:46.464306406Z","closed_at":"2026-01-01T22:55:46.464306406Z","close_reason":"Closed","labels":["auto_generated","epic_remediation:mala-cavk:c5e7cf724ec6ee8c9408df440ba125a8889c43ce33b386efc56b2b6dc5177fef"],"dependencies":[{"issue_id":"mala-cavk.5","depends_on_id":"mala-cavk","type":"parent-child","created_at":"2026-01-01T22:23:07.394908286Z","created_by":"daemon"}]}
{"id":"mala-ccll","title":"[Review] tests/test_issue_manager.py:408-460: [P3] Missing integration test for orphans_only filter in BeadsClient","description":"## Review Finding\n\nThis issue was auto-created from a P3 review finding.\n\n**Source issue:** mala-jnah\n**Reviewer:** claude\n**Location:** tests/test_issue_manager.py:408-460\n\n## Details\n\nThe `filter_orphans_only` method has unit tests, but there's no integration test that verifies `orphans_only=True` is properly passed through and applied in `BeadsClient.get_ready_async()` or `get_ready_issues_async()`. The mock `IssueProvider` implementations in test_orchestrator.py accept the parameter but don't actually test the filtering behavior.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-01T23:18:02.915444141Z","created_by":"cyou","updated_at":"2026-01-01T23:40:16.474065099Z","closed_at":"2026-01-01T23:40:16.474065099Z","close_reason":"Closed","labels":["auto_generated","review_finding","review_finding:96ba96eb5803","source:mala-jnah"]}
{"id":"mala-cdw","title":"Context Exhaustion Handling","description":"When agents run out of context mid-implementation:\n- Detect context exhaustion (agent returns incomplete)\n- Save progress state (files modified, locks held)\n- Spawn continuation agent with summary of prior work\n- Or: commit partial progress, mark issue as needs-continuation","status":"tombstone","priority":2,"issue_type":"epic","created_at":"2025-12-26T00:54:39.236980254Z","updated_at":"2025-12-26T00:55:27.98871018Z","deleted_at":"2025-12-26T00:55:27.98871018Z","deleted_by":"daemon","delete_reason":"delete","original_type":"epic"}
{"id":"mala-cee","title":"Fix issues from latest code review","description":"Address findings from the code review performed earlier in this chat on December 27, 2025. Use the review notes as source of truth; update tests/docs as needed.","status":"tombstone","priority":1,"issue_type":"task","created_at":"2025-12-27T22:37:11.106607746Z","updated_at":"2025-12-27T22:37:34.674838686Z","deleted_at":"2025-12-27T22:37:34.674838686Z","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"mala-chf9","title":"Retry epic verification until passing (max_epic_verification_retries)","description":"# Epic Verification Retry Loop\n\n## Problem\nCurrently, when running `mala run --epic \u003cid\u003e`, epic verification only runs once after all child issues complete. If verification creates remediation issues (e.g., cavk.4, cavk.5), those issues are executed but the epic is not re-verified after they complete.\n\nThis was observed in run `9dfbf91e`:\n- Epic `mala-cavk` had children cavk.1-3, plus transitively connected dhry and jnah\n- After cavk.1-3 completed, epic verification found unmet criteria → created cavk.4 and cavk.5\n- cavk.4 and cavk.5 were completed successfully\n- But the epic remained **open** because verification didn't run again\n\n## Solution\nAdd a retry loop around epic verification:\n1. After all child issues complete, run epic verification\n2. If verification fails and creates remediation issues, execute them\n3. Re-verify the epic\n4. Repeat until verification passes OR max retries reached\n\n## API Design\n```python\n# CLI arg\nmala run --epic \u003cid\u003e --max-epic-verification-retries 3  # default: 3\n\n# Config/Env\nMALA_MAX_EPIC_VERIFICATION_RETRIES=3\n```\n\n## Acceptance Criteria\n- [ ] Add `max_epic_verification_retries` param to CLI (default: 3)\n- [ ] Add `MALA_MAX_EPIC_VERIFICATION_RETRIES` env var\n- [ ] Epic verification loops until passing or max retries\n- [ ] Each retry iteration executes any newly-created remediation issues\n- [ ] Clear logging of retry attempts: \"Epic verification attempt 2/3\"\n- [ ] If max retries exceeded, log failure reason and leave epic open\n- [ ] Unit test for retry loop behavior\n\n## Files to Modify\n- `src/cli/cli.py` - add CLI arg\n- `src/infra/io/config.py` - add env var\n- `src/orchestration/orchestrator.py` - implement retry loop in `_finalize_epic()`\n- `tests/test_epic_verification.py` - add retry tests","notes":"Quality gate failed: Timeout after 60 minutes\nLog: /home/cyou/.claude/projects/-home-cyou-mala/09592a4b-6d19-43ea-9c44-c9c006084844.jsonl","status":"in_progress","priority":2,"issue_type":"feature","created_at":"2026-01-01T23:26:35.992893304Z","created_by":"cyou","updated_at":"2026-01-02T02:01:46.299455888Z","labels":["needs-followup"],"dependencies":[{"issue_id":"mala-chf9","depends_on_id":"mala-0dsz","type":"blocks","created_at":"2026-01-01T23:32:33.264934808Z","created_by":"daemon"},{"issue_id":"mala-chf9","depends_on_id":"mala-i8ke","type":"blocks","created_at":"2026-01-01T23:32:33.296526802Z","created_by":"daemon"}]}
{"id":"mala-cij","title":"Extend ValidationRunner for spec + artifacts","description":"Context:\n- ValidationRunner must execute ValidationSpec commands, capture artifacts, and call coverage/e2e.\n- Needs to respect mutex usage and per-scope settings.\n\nScope:\n- In: extend runner to accept ValidationSpec + ValidationContext; execute commands with logging; integrate worktree, coverage, and e2e; produce ValidationResult and artifacts.\n- Out: orchestrator gating decisions (separate task).\n\nAcceptance Criteria:\n- Runner executes command list in order with proper env/mutex.\n- Artifacts (stdout/stderr paths, worktree_state, coverage_report) recorded.\n- Failures are reported with actionable reasons.\n\nTest Plan:\n- TDD: add unit tests with mocked command execution and failure paths.\n- Run validation runner tests.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T23:00:01.70404142Z","updated_at":"2025-12-27T00:56:15.341249871Z","closed_at":"2025-12-27T00:56:15.341249871Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-cij","depends_on_id":"mala-j6p","type":"blocks","created_at":"2025-12-26T23:00:26.500543494Z","created_by":"daemon"},{"issue_id":"mala-cij","depends_on_id":"mala-5us","type":"blocks","created_at":"2025-12-26T23:00:26.511968732Z","created_by":"daemon"},{"issue_id":"mala-cij","depends_on_id":"mala-252","type":"blocks","created_at":"2025-12-26T23:00:26.523608608Z","created_by":"daemon"},{"issue_id":"mala-cij","depends_on_id":"mala-c1o","type":"blocks","created_at":"2025-12-26T23:00:26.535378832Z","created_by":"daemon"},{"issue_id":"mala-cij","depends_on_id":"mala-4dh","type":"blocks","created_at":"2025-12-26T23:00:26.547116107Z","created_by":"daemon"}]}
{"id":"mala-cw6h","title":"[Review] src/orchestration/run_config.py:121-131: [P2] Preserve debug_log when building RunMetadata","description":"## Review Finding\n\nThis issue was auto-created from a P2 review finding.\n\n**Source issue:** mala-cavk.5\n**Reviewer:** codex\n**Location:** src/orchestration/run_config.py:121-131\n\n## Details\n\n`RunMetadata` used to receive `debug_log` (via `RunMetadata(..., debug_log=self.debug_log)`), so the CLI/config debug log flag created a log file. After the refactor, `build_run_metadata` drops that argument and the orchestrator no longer stores `orch_config.debug_log`, so debug logging is silently disabled even when requested. Thread `debug_log` through `build_run_metadata` and pass it from `MalaOrchestrator.run()` to keep the prior behavior.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T22:55:46.494201629Z","created_by":"cyou","updated_at":"2026-01-02T01:05:24.852730144Z","closed_at":"2026-01-02T01:05:24.852730144Z","close_reason":"Closed","labels":["auto_generated","review_finding","review_finding:d791f6300633","source:mala-cavk.5"],"dependencies":[{"issue_id":"mala-cw6h","depends_on_id":"mala-i8ke","type":"blocks","created_at":"2026-01-01T23:33:37.599387241Z","created_by":"daemon"}]}
{"id":"mala-d3t","title":"Update orchestrator coverage_threshold type","description":"Context:\n- `MalaOrchestrator.__init__` accepts `coverage_threshold: float = 85.0`\n- Need to update type to `float | None = None` to match CLI\n\nScope:\n- In: Change `coverage_threshold` parameter type to `float | None = None`\n- Out: Any logic changes (just type signature update)\n\nAcceptance Criteria:\n- Orchestrator accepts None for coverage_threshold\n- Type hints updated\n- Passes value through to ValidationSpec correctly\n\nTest Plan:\n- Verify orchestrator instantiation with None works\n- Verify orchestrator instantiation with float works\n\nNotes for Agent:\n- Simple signature change, no logic changes needed\n- Primary file: src/orchestrator.py","status":"tombstone","priority":1,"issue_type":"task","created_at":"2025-12-27T18:14:32.921915115Z","updated_at":"2025-12-27T18:20:40.635021365Z","labels":["orchestrator"],"dependencies":[{"issue_id":"mala-d3t","depends_on_id":"mala-kwx","type":"blocks","created_at":"2025-12-27T18:15:02.051461062Z","created_by":"daemon"}],"deleted_at":"2025-12-27T18:20:40.635021365Z","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"mala-d6x","title":"Context exhaustion handling","description":"When agents run out of context mid-implementation, handle it explicitly: detect exhaustion, save progress state (files modified, locks held), spawn a continuation agent with a summary, or commit partial progress and mark needs-continuation.","status":"blocked","priority":1,"issue_type":"epic","created_at":"2025-12-26T00:56:35.644475789Z","updated_at":"2025-12-28T06:25:00.887494951Z"}
{"id":"mala-d6x.1","title":"Detect context exhaustion in agent runs","description":"Detect when an agent run exhausts context or returns incomplete output. Emit a structured reason (e.g., context_exhausted) so the orchestrator can trigger follow-up handling without treating it as a generic failure.","status":"tombstone","priority":2,"issue_type":"task","created_at":"2025-12-26T01:14:09.957270657Z","updated_at":"2025-12-26T15:33:44.086569066Z","deleted_at":"2025-12-26T15:33:44.086569066Z","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"mala-d6x.2","title":"Persist progress snapshot on context exhaustion","description":"When context exhaustion is detected, capture a progress snapshot (modified files, locks held, agent summary, and any partial results) in a durable location so continuation can resume safely.","status":"tombstone","priority":2,"issue_type":"task","created_at":"2025-12-26T01:14:15.412064244Z","updated_at":"2025-12-26T15:33:44.086569066Z","deleted_at":"2025-12-26T15:33:44.086569066Z","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"mala-d6x.3","title":"Spawn continuation agent with prior summary","description":"After persisting a progress snapshot, spawn a continuation agent and pass a concise summary + snapshot path so it can resume work without losing context.","status":"tombstone","priority":2,"issue_type":"task","created_at":"2025-12-26T01:14:19.459225253Z","updated_at":"2025-12-26T15:33:44.086569066Z","deleted_at":"2025-12-26T15:33:44.086569066Z","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"mala-d6x.4","title":"Commit partial progress and mark needs-continuation","description":"Provide a fallback path to commit partial work on context exhaustion and mark the issue as needs-continuation (status/notes) so a future run can pick it up intentionally.","status":"tombstone","priority":2,"issue_type":"task","created_at":"2025-12-26T01:14:24.562096252Z","updated_at":"2025-12-26T15:33:44.086569066Z","deleted_at":"2025-12-26T15:33:44.086569066Z","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"mala-da4","title":"Update CoverageConfig and pytest command in spec.py","description":"Context:\n- `CoverageConfig.min_percent` currently defaults to 85.0\n- Need to change default to None (meaning \"no decrease\" mode)\n- When `coverage_threshold is None`, must add `--cov-fail-under=0` to pytest command to override pyproject.toml\n\nScope:\n- In: Change `CoverageConfig.min_percent: float = 85.0` to `min_percent: float | None = None`\n- In: Update docstring to explain None = \"no decrease\" mode\n- In: In `build_validation_spec`, when `coverage_threshold is None`, add `--cov-fail-under=0` to pytest command\n- Out: Actual baseline comparison logic (that's in spec_runner.py)\n\nAcceptance Criteria:\n- `CoverageConfig(enabled=True)` has `min_percent=None` by default\n- Pytest command includes `--cov-fail-under=0` when threshold is None\n- Pytest command includes explicit threshold when provided\n- Docstrings updated\n\nTest Plan:\n- TDD: Test default CoverageConfig has min_percent=None\n- Test `build_validation_spec()` with no threshold → pytest includes `--cov-fail-under=0`\n- Test `build_validation_spec(coverage_threshold=80)` → pytest includes `--cov-fail-under=80`\n\nNotes for Agent:\n- The `--cov-fail-under=0` is needed to override pyproject.toml's `--cov-fail-under=85`\n- Keep existing coverage-related pytest flags (`--cov=src`, etc.)\n- Primary files: src/validation/spec.py, tests/test_spec.py","status":"tombstone","priority":1,"issue_type":"task","created_at":"2025-12-27T18:13:57.436716865Z","updated_at":"2025-12-27T18:20:40.633815335Z","labels":["validation"],"dependencies":[{"issue_id":"mala-da4","depends_on_id":"mala-wg1","type":"blocks","created_at":"2025-12-27T18:15:01.997067804Z","created_by":"daemon"}],"deleted_at":"2025-12-27T18:20:40.633815335Z","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"mala-db2","title":"Segment run logs into per-repo directories","description":"## Problem\n\nCurrently all mala run metadata is stored in a flat directory (`~/.config/mala/runs/*.json`). As the tool is used across multiple repositories, this becomes hard to navigate and correlate.\n\n## Desired Behavior\n\nSegment logs into directories by repo, similar to how `.claude/projects/` segments by project path:\n\n```\n~/.config/mala/runs/\n├── -home-cyou-mala/\n│   ├── 2024-12-27T10-30-00_abc123.json\n│   └── 2024-12-27T11-45-00_def456.json\n├── -home-cyou-other-repo/\n│   ├── 2024-12-28T09-00-00_ghi789.json\n│   └── ...\n└── ...\n```\n\n### Key changes:\n1. **Directory naming**: Convert repo path to safe directory name (replace `/` with `-`, similar to `.claude`)\n2. **File naming**: Use `{iso-timestamp}_{short-uuid}.json` for easier sorting and identification\n3. **Backward compat**: On startup, optionally migrate existing flat files to new structure (or leave them)\n\n## Implementation\n\n**Files:**\n- `src/tools/env.py`: Add helper to compute repo-specific runs directory\n- `src/logging/run_metadata.py`: Update `save()` to use repo-segmented path\n\n### 1. Add path helper in `src/tools/env.py`:\n\n```python\ndef get_repo_runs_dir(repo_path: Path) -\u003e Path:\n    \"\"\"Get runs directory segmented by repo path.\n    \n    Converts /home/cyou/mala -\u003e -home-cyou-mala\n    \"\"\"\n    # Resolve and convert to safe directory name\n    safe_name = str(repo_path.resolve()).replace('/', '-').lstrip('-')\n    return get_runs_dir() / safe_name\n```\n\n### 2. Update RunMetadata.save() in `src/logging/run_metadata.py`:\n\n```python\ndef save(self) -\u003e Path:\n    self.completed_at = datetime.now(UTC)\n    # Use repo-specific subdirectory\n    runs_dir = get_repo_runs_dir(self.repo_path)\n    runs_dir.mkdir(parents=True, exist_ok=True)\n    \n    # Use timestamp + short UUID for filename\n    timestamp = self.started_at.strftime('%Y-%m-%dT%H-%M-%S')\n    short_id = self.run_id[:8]\n    path = runs_dir / f\"{timestamp}_{short_id}.json\"\n    \n    with open(path, 'w') as f:\n        json.dump(self._to_dict(), f, indent=2)\n    return path\n```\n\n## Acceptance Criteria\n\n- [ ] Run logs are saved to `~/.config/mala/runs/{repo-safe-name}/` directories\n- [ ] Filenames include timestamp for easy sorting\n- [ ] Existing flat-file runs continue to work (no migration required initially)\n- [ ] Tests updated for new path structure\n\n## Test Plan\n\n- Add unit tests for `get_repo_runs_dir` path conversion\n- Update RunMetadata tests to verify new save location\n- Manual: run mala in two different repos, verify separate directories created","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-27T22:51:29.556789345Z","updated_at":"2025-12-28T05:26:56.324190971Z","closed_at":"2025-12-28T05:26:56.324190971Z","close_reason":"Closed"}
{"id":"mala-dhry","title":"remove debug log cli arg, should always run","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T20:52:38.283130553Z","created_by":"cyou","updated_at":"2026-01-01T22:54:29.928386122Z","closed_at":"2026-01-01T22:54:29.928386122Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-dhry","depends_on_id":"mala-cavk.3","type":"blocks","created_at":"2026-01-01T21:29:33.013492786Z","created_by":"daemon"}]}
{"id":"mala-dqp","title":"Fix lock enforcement canonicalization","description":"Context:\n- Hook lock checks use repo-relative hashing, but current canonicalization can diverge from lock scripts when mala is launched outside the repo.\n- This can cause false \"not locked\" blocks or allow writes without a matching lock.\n- The unused lock hook duplicates logic and risks drift.\n- Needs verification: reproduce mismatch by running from a non-repo cwd.\n\nScope:\n- In: unify path canonicalization between shell scripts and Python hook (use repo namespace consistently), pass repo path into lock enforcement, remove redundant hook, and ensure LOCK_DIR mkdir uses parents=True.\n- Out: redesigning the locking model or changing lock script behavior beyond canonicalization.\n\nAcceptance Criteria:\n- A lock acquired via lock-try.sh is recognized by the PreToolUse hook even when mala is launched from outside the repo.\n- Hook blocks writes when another agent holds the lock and allows when the current agent holds it.\n- Redundant lock hook removed (single source of truth).\n- Nested MALA_LOCK_DIR paths start without error.\n\nTest Plan:\n- TDD: add failing test for cross-cwd lock enforcement, implement fix, then run lock integration tests.\n- Run relevant tests in tests/test_lock_sdk_integration.py and tests/test_lock_scripts.py.\n\nNotes for Agent:\n- Keep canonicalization consistent with lock-try.sh hashing; avoid changing lock key format.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-26T17:35:26.214219228Z","updated_at":"2025-12-26T18:45:48.051480297Z","closed_at":"2025-12-26T18:45:48.051480297Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-dqp","depends_on_id":"mala-jnq","type":"parent-child","created_at":"2025-12-26T17:36:15.673575659Z","created_by":"daemon"}]}
{"id":"mala-dqt","title":"Refactor: extract git helper functions","description":"Goal: Move git helper(s) from src/cli.py (e.g., get_git_commit) into a small utility module (e.g., src/git_utils.py).\\n\\nScope/files: src/cli.py, new src/git_utils.py.\\n\\nWork:\\n- Move get_git_commit (and any related helpers if needed).\\n- Update imports in cli.py.\\n- Keep behavior unchanged.\\n\\nAcceptance criteria:\\n- Same git commit info used in metadata.\\n- No behavior changes to CLI.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-25T21:41:18.022578128Z","updated_at":"2025-12-26T00:11:10.071338973Z","closed_at":"2025-12-26T00:11:10.071338973Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-dqt","depends_on_id":"mala-9qr","type":"blocks","created_at":"2025-12-25T21:47:31.302567088Z","created_by":"daemon"},{"issue_id":"mala-dqt","depends_on_id":"mala-c01","type":"parent-child","created_at":"2025-12-25T22:05:59.473063215Z","created_by":"daemon"}]}
{"id":"mala-drqh","title":"[Review] src/domain/validation/tool_name_extractor.py:140-149: [P2] Skip flags after multi-token wrappers (uv/poetry/pipx run)","description":"## Review Finding\n\nThis issue was auto-created from a P2 review finding.\n\n**Source issue:** mala-fdp1.5\n**Reviewer:** codex\n**Location:** src/domain/validation/tool_name_extractor.py:140-149\n\n## Details\n\nAfter detecting a multi-token wrapper, the code sets `first` to the next token without skipping flags. Commands like `uv run --group dev pytest` or `poetry run --quiet pytest` will return `--group`/`--quiet` as the tool name. This is a common pattern for these wrappers and leads to incorrect extraction. The single-token wrapper path already skips leading flags; the multi-token wrapper path should do the same before selecting the tool.","notes":"Quality gate failed: Timeout after 60 minutes","status":"in_progress","priority":2,"issue_type":"task","created_at":"2026-01-02T03:17:47.873053898Z","created_by":"cyou","updated_at":"2026-01-02T04:17:48.039881872Z","labels":["auto_generated","needs-followup","review_finding","review_finding:c6d6d26311e1","source:mala-fdp1.5"]}
{"id":"mala-dyt","title":"Improve tool call formatting with better colors and code pretty-printing","description":"## Goal\n1. **All tools**: Skip \"args:\" prefix and JSON brackets, use `key: value` format with distinct colors\n2. **Edit tools**: Pretty-print code fields with actual newlines and distinct coloring\n3. **CLI flag**: Change `--no-truncate` to `--verbose` / `-v`\n\n## Current output\n```\n  [mala-e47] ⚙ mcp__morphllm__edit_file\n    args:\n    {\n      \"path\": \"/home/cyou/mala/tests/test_orchestrator.py\",\n      \"code_edit\": \"    @pytest.mark.asyncio\\n    async def...\"\n    }\n```\n\n## Desired output\n```\n  [mala-e47] ⚙ mcp__morphllm__edit_file\n    path: /home/cyou/mala/tests/test_orchestrator.py     \u003c- key=CYAN, value=WHITE\n    instruction: Update mock_get_ready signature...\n    code_edit:                                           \u003c- key=CYAN\n        @pytest.mark.asyncio                             \u003c- code=GRAY/dim\n        async def test_success...\n```\n\n## Files to modify\n- `src/cli.py` - rename flag from --no-truncate to --verbose/-v\n- `src/logging/console.py` - formatting logic\n\n## Implementation\n1. Rename CLI flag to --verbose/-v\n2. Define constants for edit tool detection and code fields\n3. Rewrite _format_arguments() for key:value format with colors\n4. For edit tools, expand code fields with actual newlines\n5. Remove \"args:\" prefix from output","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T19:08:00.801228302Z","updated_at":"2025-12-26T19:14:26.272944778Z","closed_at":"2025-12-26T19:14:26.272944778Z","close_reason":"Closed"}
{"id":"mala-e0i","title":"Update RunMetadata for validation results + IssueResolution","description":"Context:\n- Run metadata should record per-issue validation outcomes and artifacts for observability.\n- Plan adds IssueResolution and validation results to metadata.\n\nScope:\n- In: extend RunMetadata schema to include per-issue ValidationResult/Artifacts and IssueResolution; add run-level validation result fields.\n- Out: CLI output formatting (separate concern).\n\nAcceptance Criteria:\n- RunMetadata persists new fields without breaking existing readers.\n- Serialization handles optional fields cleanly.\n\nTest Plan:\n- Add unit tests for metadata serialization/deserialization.\n- Run logging module tests.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T23:00:01.729378301Z","updated_at":"2025-12-27T00:31:03.493814554Z","closed_at":"2025-12-27T00:31:03.493814554Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-e0i","depends_on_id":"mala-5us","type":"blocks","created_at":"2025-12-26T23:00:26.569756144Z","created_by":"daemon"}]}
{"id":"mala-e37n","title":"[Review] src/domain/validation/config_merger.py:190-193: [P2] Treat explicit null coverage as disable override","description":"## Review Finding\n\nThis issue was auto-created from a P2 review finding.\n\n**Source issue:** mala-c7wb\n**Reviewer:** codex\n**Location:** src/domain/validation/config_merger.py:190-193\n\n## Details\n\n`ValidationConfig` docs state that `coverage` can be set to null to disable it. When a preset defines coverage and a user config sets `coverage: null`, the parser yields `user_cov=None`, but `_merge_coverage` treats `None` as “inherit” and keeps the preset coverage. This makes it impossible to disable coverage when extending a preset. Consider tracking whether `coverage` was explicitly provided (e.g., a sentinel like `DISABLED`) so explicit null can override the preset.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T03:55:38.858200445Z","created_by":"cyou","updated_at":"2026-01-02T04:14:26.247852074Z","closed_at":"2026-01-02T04:14:26.247852074Z","close_reason":"Closed","labels":["auto_generated","review_finding","review_finding:9c69e7e9be86","source:mala-c7wb"]}
{"id":"mala-e47","title":"Update orchestrator tests for get_ready signature and max_agents default","description":"Tests currently mock get_ready without the new suppress_warn_ids param and still assert max_agents==3 even though default is now unlimited (None). Update tests to match current behavior and avoid TypeError.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T15:34:00.738271737Z","updated_at":"2025-12-26T18:42:41.370094167Z","closed_at":"2025-12-26T18:42:41.370094167Z","close_reason":"Closed"}
{"id":"mala-e8f","title":"CLI commands for periodic checks: healthcheck, architecture review, integration tests + coverage","description":"Add CLI commands that can run automatically every X runs/issues: healthcheck, architecture review, run integration tests and review coverage","status":"blocked","priority":3,"issue_type":"feature","created_at":"2025-12-28T06:21:39.079301328Z","updated_at":"2025-12-28T06:25:03.011382234Z"}
{"id":"mala-e8ks","title":"[Review] tests/test_run_metadata.py:1077-1089: [P3] Test risks leaking log handlers on assertion failure","description":"## Review Finding\n\nThis issue was auto-created from a P3 review finding.\n\n**Source issue:** mala-nzk6\n**Reviewer:** gemini\n**Location:** tests/test_run_metadata.py:1077-1089\n\n## Details\n\nThe test attaches a handler to the global `src` logger via `RunMetadata`. If the assertion checks fail before `metadata.cleanup()` is called, the handler will remain attached, potentially polluting subsequent tests. Wrap the logic in a `try...finally` block to ensure cleanup always runs.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-02T01:08:22.751771117Z","created_by":"cyou","updated_at":"2026-01-02T01:10:53.696239305Z","closed_at":"2026-01-02T01:10:53.696239305Z","close_reason":"Closed","labels":["auto_generated","review_finding","review_finding:552a7b6c2c65","source:mala-nzk6"]}
{"id":"mala-ednv","title":"Replace commit_issues_async with bd sync to ensure beads changes are persisted","description":"## Problem\nWhen mala closes an issue and the EpicVerifier closes eligible epics, the epic closure may not be persisted to git because:\n\n1. `commit_issues_async()` only does `git add .beads/issues.jsonl \u0026\u0026 git commit`\n2. It relies on the bd daemon to auto-export SQLite → JSONL\n3. If daemon is slow/not running, the JSONL may not have the latest epic closure\n\n**Evidence:** mala-aqp4 epic stayed open despite all 4 children being closed. No 'beads: close completed issues' commit appeared after the final child closed.\n\n## Root Cause\n`_finalize_run()` in orchestrator.py:1041 calls `commit_issues_async()` without first ensuring the JSONL is up-to-date.\n\n## Fix\nAdd `bd export` call before `git add` in `commit_issues_async()`, or add a new `export_async()` method and call it in `_finalize_run()` before committing.\n\n## Primary Files\n- src/beads_client.py (commit_issues_async)\n- src/orchestrator.py (_finalize_run)\n\n## Acceptance Criteria\n- Epic closures are persisted to git even if bd daemon is not running\n- `bd export` (or equivalent) is called before committing .beads/issues.jsonl\n- Test: close all children of an epic, verify epic closure appears in git log","notes":"Correction: Instead of adding bd export before git commit, replace the entire commit_issues_async() implementation with a single `bd sync` call. bd sync handles export + commit + pull + push in one atomic operation.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-30T22:50:09.159491419Z","created_by":"cyou","updated_at":"2025-12-30T23:51:34.442312116Z","closed_at":"2025-12-30T23:51:34.442312116Z","close_reason":"Closed"}
{"id":"mala-elat","title":"[Review] .beads/issues.jsonl:303: [P3] Issue mala-sp2s closed while implementation remains","description":"## Review Finding\n\nThis issue was auto-created from a P3 review finding.\n\n**Source issue:** mala-apsz\n**Reviewer:** gemini\n**Location:** .beads/issues.jsonl:303\n\n## Details\n\nCommit `2b98c2d` marks issue `mala-sp2s` (\"Legacy init removed from MalaOrchestrator\") as closed in `.beads/issues.jsonl`. However, the legacy `__init__` method and its ~100 lines of compatibility logic still exist in `src/orchestration/orchestrator.py` (lines 121-220). While the issue is marked as advisory (P3), closing it creates a mismatch between the tracking system and the actual codebase state.","notes":"Quality gate failed: External review failed: spawn failed: Artifact written: /home/cyou/.claude/projects/-home-cyou-mala/cerberus/d45a6cb8-9bf5-4ed0-b8a7-5887ac4be6d7/latest.md\nReview gate already active (status: pending, age: 51s)\nUse /home/cyou/.claude/plugins/cache/cerberus/cerberus/1.10.6/bin/review-gate resolve to complete the existing gate first.\nLog: /home/cyou/.claude/projects/-home-cyou-mala/d45a6cb8-9bf5-4ed0-b8a7-5887ac4be6d7.jsonl","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-01T23:49:33.666901533Z","created_by":"cyou","updated_at":"2026-01-02T00:48:11.900477583Z","closed_at":"2026-01-02T00:48:11.900477583Z","close_reason":"Closed","labels":["auto_generated","needs-followup","review_finding","review_finding:c6342fdbce63","source:mala-apsz"]}
{"id":"mala-f69","title":"Default to unlimited concurrent agents","description":"Goal: Change the default for --max-agents/-n to unlimited (no cap on concurrent agents).\n\nCurrent behavior: max_agents defaults to 3, limiting concurrent agent execution.\n\nDesired behavior: By default, spawn as many agents as there are ready issues. Users can still use --max-agents to set a limit if needed.\n\nScope/files: src/cli.py, src/orchestrator.py.\n\nWork:\n- Change max_agents default from 3 to None (unlimited).\n- Update orchestrator logic to handle None as 'spawn all ready issues'.\n- Update help text to reflect new default.\n\nAcceptance criteria:\n- 'mala run' with no flags spawns agents for all ready issues.\n- 'mala run --max-agents 3' limits to 3 concurrent agents.\n- Logging/status output reflects unlimited when no cap set.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T00:18:53.28766291Z","updated_at":"2025-12-26T00:50:20.634125479Z","closed_at":"2025-12-26T00:50:20.634125479Z","close_reason":"Closed"}
{"id":"mala-fdp1","title":"Epic: Language-Agnostic Configuration via mala.yaml","description":"# Epic: Language-Agnostic Configuration via mala.yaml\n\n## Context\n- **Spec**: `docs/2026-01-01-language-agnostic-config-spec.md`\n- **Plan**: `docs/2026-01-01-language-agnostic-config-plan.md`\n- Replace hard-coded Python commands (pytest, ruff, ty, uv) with user-configurable `mala.yaml`\n- Enable mala to work with any language/toolchain without code changes\n\n## Scope\n- Configuration schema and dataclasses for `mala.yaml`\n- Strict config loading with fail-fast validation (eager at startup)\n- Preset registry with 4 built-in presets (python-uv, node-npm, go, rust) using `importlib.resources`\n- Config merging (preset as base, user overrides on top)\n- Tool name extraction for quality gate messaging\n- Code pattern matching for file-triggered validation\n- Per-command timeout support (optional, default 120s)\n- Cobertura XML coverage parsing with configurable threshold\n- Direct migration from hard-coded Python commands (breaking change)\n\n## Non-Goals\n- Backwards compatibility fallback to Python defaults\n- Windows shell compatibility (document as limitation)\n- Hot reload of config during session\n- CLI `--config` flag for alternate config paths\n- Non-Cobertura coverage formats (deferred)\n- Migration tooling or `mala init` command\n\n## Breaking Changes\n- Existing Python repos without `mala.yaml` will fail\n- `ValidationCommand.command` changes from `list[str]` to `str`\n- `RepoType` enum removed\n\n## Acceptance Criteria\n1. Go project with `mala.yaml` using go preset executes all commands\n2. Node.js project with node-npm preset executes all commands\n3. Python project with preset + custom override works correctly\n4. Minimal config (only setup + test) skips undefined commands\n5. Missing `mala.yaml` fails with clear error message\n6. Invalid YAML syntax fails with specific error details\n7. Coverage config with xml format, custom file, threshold works\n8. No coverage section skips coverage evaluation\n9. Custom `code_patterns` filter files correctly\n10. Tool name extraction shows friendly names in quality gate output","status":"open","priority":1,"issue_type":"epic","created_at":"2026-01-02T00:32:04.61706417Z","created_by":"cyou","updated_at":"2026-01-02T00:32:04.61706417Z"}
{"id":"mala-fdp1.1","title":"Create Configuration Schema and Dataclasses","description":"# Task 1: Create Configuration Schema and Dataclasses\n\n## Context\n- Foundation for the entire language-agnostic configuration feature\n- Defines core data structures that all other tasks depend on\n- Must be completed before config loader, preset registry, or merger can be implemented\n- Follows frozen dataclass pattern from `src/infra/io/config.py`\n\n## Scope\n**In**: Create new `src/domain/validation/config.py` with:\n- `CommandConfig`: frozen dataclass with `command: str`, `timeout: int | None = None`\n- `YamlCoverageConfig`: frozen dataclass (named to avoid collision with existing `CoverageConfig`)\n- `CommandsConfig`: frozen dataclass with optional command fields\n- `ValidationConfig`: frozen dataclass with preset, commands, coverage, patterns\n- `ConfigError`, `PresetNotFoundError`: custom exceptions\n\n**Out**: No YAML parsing, no loading logic, no preset handling\n\n## Acceptance Criteria\n- [ ] All dataclasses are frozen (immutable)\n- [ ] `CommandConfig` supports both string shorthand and object form\n- [ ] `YamlCoverageConfig` has: `command`, `format`, `file`, `threshold`, `timeout`\n- [ ] `CommandsConfig` has optional fields: `setup`, `test`, `lint`, `format`, `typecheck`, `e2e`\n- [ ] `ValidationConfig` has: `preset`, `commands`, `coverage`, `code_patterns`, `config_files`, `setup_files`\n- [ ] `ConfigError` and `PresetNotFoundError` exceptions are defined\n- [ ] Factory methods follow existing pattern from `src/infra/io/config.py`\n\n## Test Plan\n- [ ] Create `tests/test_validation_config.py`\n- [ ] Test dataclass instantiation with all field combinations\n- [ ] Test immutability (attempt mutation raises)\n- [ ] Test default values\n- [ ] Run: `uv run pytest tests/test_validation_config.py -v`\n\n## Notes for Agent\n- Look at `src/infra/io/config.py` for frozen dataclass patterns\n- The YAML schema uses nested `commands:` wrapper; preserve this structure\n- Use `field(default_factory=list)` for list fields\n- Keep exceptions simple with clear messages","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-02T00:32:22.340074188Z","created_by":"cyou","updated_at":"2026-01-02T03:19:13.826118525Z","closed_at":"2026-01-02T03:19:13.826118525Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-fdp1.1","depends_on_id":"mala-fdp1","type":"parent-child","created_at":"2026-01-02T00:32:22.346926243Z","created_by":"daemon"}]}
{"id":"mala-fdp1.10","title":"Update Lint Cache for Dynamic Tool Detection","description":"# Task 10: Update Lint Cache for Dynamic Tool Detection\n\n## Context\n- Uses tool name extractor for dynamic lint tool detection\n- Supports AC 1, 2 (lint tools from any language)\n- Depends on Task 5 (tool name extractor) and Task 7 (spec builder)\n\n## Scope\n**In**: Modify `src/infra/hooks/lint_cache.py`:\n- Remove hard-coded `LINT_COMMAND_PATTERNS` (ruff, ty only)\n- Update `LintCache` to accept lint/typecheck tool names from `ValidationSpec`\n- Use `extract_tool_name()` to determine cache key from command\n- Cache invalidation based on extracted tool name\n\n**Out**: No changes to quality gate messaging (Task 11)\n\n## Acceptance Criteria\n- [ ] Hard-coded `LINT_COMMAND_PATTERNS` removed\n- [ ] `LintCache` uses tool names from `ValidationSpec`\n- [ ] Cache key extracted via `extract_tool_name()`\n- [ ] Works with eslint, golangci-lint, cargo clippy, etc.\n\n## Test Plan\n- [ ] Update `tests/test_lint_cache.py`:\n  - Test cache with eslint command\n  - Test cache with golangci-lint command\n  - Test cache key extraction\n- [ ] Run: `uv run pytest tests/test_lint_cache.py -v`\n\n## Notes for Agent\n- Import `extract_tool_name` from `tool_name_extractor.py`\n- Tool name becomes the cache key\n- May need to update how `LintCache` receives `ValidationSpec`","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T00:35:00.934172219Z","created_by":"cyou","updated_at":"2026-01-02T15:43:51.227092802Z","closed_at":"2026-01-02T15:43:51.227092802Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-fdp1.10","depends_on_id":"mala-fdp1","type":"parent-child","created_at":"2026-01-02T00:35:00.94181129Z","created_by":"daemon"},{"issue_id":"mala-fdp1.10","depends_on_id":"mala-fdp1.7","type":"blocks","created_at":"2026-01-02T00:36:37.312696155Z","created_by":"daemon"}]}
{"id":"mala-fdp1.11","title":"Update Quality Gate Messaging","description":"# Task 11: Update Quality Gate Messaging\n\n## Context\n- Uses extracted tool names in quality gate output\n- AC 10: tool name display\n- Depends on Task 5 (tool name extractor) and Task 7 (spec builder)\n\n## Scope\n**In**: Modify `src/domain/quality_gate.py`:\n- Remove hard-coded `KIND_TO_NAME` mapping\n- Use `extract_tool_name(command)` to get display name\n- Update `ValidationEvidence` to store tool name\n- Update quality gate messages to use extracted names\n\n**Out**: No changes to lint cache (Task 10)\n\n## Acceptance Criteria\n- [ ] Hard-coded `KIND_TO_NAME` mapping removed\n- [ ] Quality gate shows `\"eslint\"` not `\"npx eslint .\"`\n- [ ] Quality gate shows `\"pytest\"` not `\"uv run pytest\"`\n- [ ] `ValidationEvidence` stores extracted tool name\n\n## Test Plan\n- [ ] Update `tests/test_quality_gate.py`:\n  - Test quality gate output shows `\"eslint\"` not `\"npx eslint .\"`\n  - Test quality gate output shows `\"pytest\"` not `\"uv run pytest\"`\n- [ ] Run: `uv run pytest tests/test_quality_gate.py -v`\n\n## Notes for Agent\n- Import `extract_tool_name` from `tool_name_extractor.py`\n- May need to modify `ValidationEvidence` dataclass\n- Ensure friendly names in all user-facing output","status":"in_progress","priority":2,"issue_type":"task","created_at":"2026-01-02T00:35:11.605453839Z","created_by":"cyou","updated_at":"2026-01-02T15:25:31.994537565Z","dependencies":[{"issue_id":"mala-fdp1.11","depends_on_id":"mala-fdp1","type":"parent-child","created_at":"2026-01-02T00:35:11.616706642Z","created_by":"daemon"},{"issue_id":"mala-fdp1.11","depends_on_id":"mala-fdp1.7","type":"blocks","created_at":"2026-01-02T00:36:37.374139224Z","created_by":"daemon"}]}
{"id":"mala-fdp1.12","title":"Update Command Execution for Shell Mode","description":"# Task 12: Update Command Execution for Shell Mode\n\n## Context\n- Execute shell string commands with `shell=True`\n- AC 1-4: command execution for all languages\n- Depends on Task 7 (spec builder with shell string commands)\n\n## Scope\n**In**: \n- Modify `src/infra/tools/command_runner.py`:\n  - Update `CommandRunner.run()` and `run_async()` to accept shell string commands\n  - Add `shell: bool = False` parameter (default False for backwards compatibility)\n  - When `shell=True`, pass command as string to `subprocess.Popen(cmd, shell=True, ...)`\n  - Ensure stdout/stderr capture works with shell mode\n  - Timeout handling already implemented via process group termination\n- Modify `src/domain/validation/spec_executor.py`:\n  - Pass `shell=True` when executing `ValidationCommand` with shell string\n  - Pass `timeout=cmd.timeout` to CommandRunner\n- Update `src/domain/validation/coverage.py` (`BaselineCoverageService` uses CommandRunner)\n\n**Out**: No changes to spec builder (Task 7)\n\n## Acceptance Criteria\n- [ ] `CommandRunner.run()` accepts `shell=True` parameter\n- [ ] Shell string commands execute via `subprocess.Popen(..., shell=True)`\n- [ ] stdout/stderr capture works in shell mode\n- [ ] Timeout enforcement works with shell commands\n- [ ] Exit code captured correctly from shell commands\n- [ ] `spec_executor.py` passes `shell=True` for `ValidationCommand`\n\n## Test Plan\n- [ ] Update `tests/test_command_runner.py`:\n  - Test shell string execution with `shell=True`\n  - Test timeout enforcement with shell commands\n  - Test exit code capture from shell commands\n- [ ] Run: `uv run pytest tests/test_command_runner.py tests/test_spec.py -v`\n\n## Notes for Agent\n- Keep `shell=False` as default for backwards compatibility\n- Process group termination for timeout should work the same\n- Test with commands that use shell features (pipes, redirects)","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-02T00:35:24.97301344Z","created_by":"cyou","updated_at":"2026-01-02T00:35:24.97301344Z","dependencies":[{"issue_id":"mala-fdp1.12","depends_on_id":"mala-fdp1","type":"parent-child","created_at":"2026-01-02T00:35:24.984690681Z","created_by":"daemon"},{"issue_id":"mala-fdp1.12","depends_on_id":"mala-fdp1.7","type":"blocks","created_at":"2026-01-02T00:36:37.440616048Z","created_by":"daemon"},{"issue_id":"mala-fdp1.12","depends_on_id":"mala-fdp1.9","type":"blocks","created_at":"2026-01-02T00:41:43.962651236Z","created_by":"daemon"}]}
{"id":"mala-fdp1.13","title":"Wire Code Patterns into Validation Gating","description":"# Task 13: Wire Code Patterns into Validation Gating\n\n## Context\n- Integrates code pattern matcher into change detection\n- AC 9: custom code_patterns filter files correctly\n- Depends on Task 6 (code pattern matcher) and Task 7 (spec builder)\n\n## Scope\n**In**: \n- Identify change detection location (likely in orchestrator or spec_runner.py)\n- Modify `src/domain/validation/spec_runner.py` or `src/orchestration/`:\n  - Import `filter_matching_files` from `code_pattern_matcher.py`\n  - When evaluating changed files, use `spec.code_patterns` to filter\n  - If no files match any pattern, skip validation (unless empty, then all trigger)\n  - Changes to `mala.yaml` itself always trigger validation\n- Add cache invalidation logic:\n  - Changes to `config_files` trigger lint/format/typecheck re-run\n  - Changes to `setup_files` trigger setup command re-run\n\n**Out**: No changes to pattern matcher itself (Task 6)\n\n## Acceptance Criteria\n- [ ] Only matching files trigger validation when `code_patterns` specified\n- [ ] Non-matching files (e.g., `.md` when patterns is `[\"*.py\"]`) don't trigger\n- [ ] Empty `code_patterns` matches all files\n- [ ] `mala.yaml` change always triggers validation\n- [ ] `config_files` change triggers lint cache invalidation\n- [ ] `setup_files` change triggers setup re-run\n\n## Test Plan\n- [ ] Create `tests/test_validation_gating.py`:\n  - Test: Only `.py` files trigger when `code_patterns: [\"*.py\"]`\n  - Test: Non-matching files don't trigger\n  - Test: Empty `code_patterns` matches all\n  - Test: `mala.yaml` change always triggers\n  - Test: `config_files` change triggers lint cache invalidation\n  - Test: `setup_files` change triggers setup re-run\n- [ ] Run: `uv run pytest tests/test_validation_gating.py -v`\n\n## Notes for Agent\n- Explore `src/orchestration/` to find change detection logic\n- May need to modify how file changes are evaluated\n- Ensure `mala.yaml` is special-cased","status":"in_progress","priority":2,"issue_type":"task","created_at":"2026-01-02T00:35:42.787485069Z","created_by":"cyou","updated_at":"2026-01-02T15:25:31.985348695Z","dependencies":[{"issue_id":"mala-fdp1.13","depends_on_id":"mala-fdp1","type":"parent-child","created_at":"2026-01-02T00:35:42.798750102Z","created_by":"daemon"},{"issue_id":"mala-fdp1.13","depends_on_id":"mala-fdp1.7","type":"blocks","created_at":"2026-01-02T00:36:37.50944903Z","created_by":"daemon"}]}
{"id":"mala-fdp1.14","title":"Integration Testing for Language-Agnostic Config","description":"# Task 14: Integration Testing for Language-Agnostic Config\n\n## Context\n- End-to-end validation of config-driven workflow\n- AC 1-10: all acceptance criteria\n- Depends on Tasks 1-13 (all previous tasks)\n\n## Scope\n**In**: Create `tests/test_validation_config_integration.py`:\n- Test: Go project with `mala.yaml` using go preset (AC 1)\n- Test: Node.js project with node-npm preset (AC 2)\n- Test: Python project with python-uv preset + custom test override (AC 3)\n- Test: Minimal config (only setup + test) skips lint/format/typecheck (AC 4)\n- Test: Missing `mala.yaml` fails with clear error (AC 5)\n- Test: Invalid YAML syntax fails with specific error (AC 6)\n- Test: Coverage config with xml format, custom file, threshold (AC 7)\n- Test: No coverage section skips coverage (AC 8)\n- Test: Custom `code_patterns` filter files correctly (AC 9)\n- Test: Tool name extraction in quality gate output (AC 10)\n- Create test fixtures with actual project structures\n\n**Out**: No new functionality, only testing\n\n## Acceptance Criteria\n- [ ] All 10 AC covered by integration tests\n- [ ] Test fixtures with actual project structures created\n- [ ] Tests marked with `@pytest.mark.integration`\n- [ ] Full test suite passes: `uv run pytest -m \"unit or integration\"`\n- [ ] 85% coverage maintained: `uv run pytest --cov --cov-fail-under=85`\n\n## Test Plan\n- [ ] Create `tests/test_validation_config_integration.py`\n- [ ] Create project fixture directories with realistic structure\n- [ ] Run: `uv run pytest tests/test_validation_config_integration.py -v -m integration`\n- [ ] Run full suite: `uv run pytest -m \"unit or integration\"`\n- [ ] Verify coverage: `uv run pytest --cov --cov-fail-under=85`\n\n## Notes for Agent\n- Use `tmp_path` fixture for temporary project directories\n- May need to mock external tools (go, npm, cargo) for CI\n- Consider using `monkeypatch` to avoid actual tool execution\n- Integration tests should be realistic but fast","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-02T00:35:59.387771971Z","created_by":"cyou","updated_at":"2026-01-02T00:35:59.387771971Z","dependencies":[{"issue_id":"mala-fdp1.14","depends_on_id":"mala-fdp1","type":"parent-child","created_at":"2026-01-02T00:35:59.399033614Z","created_by":"daemon"},{"issue_id":"mala-fdp1.14","depends_on_id":"mala-fdp1.9","type":"blocks","created_at":"2026-01-02T00:36:44.881597891Z","created_by":"daemon"},{"issue_id":"mala-fdp1.14","depends_on_id":"mala-fdp1.10","type":"blocks","created_at":"2026-01-02T00:36:44.943565498Z","created_by":"daemon"},{"issue_id":"mala-fdp1.14","depends_on_id":"mala-fdp1.11","type":"blocks","created_at":"2026-01-02T00:36:45.002136962Z","created_by":"daemon"},{"issue_id":"mala-fdp1.14","depends_on_id":"mala-fdp1.12","type":"blocks","created_at":"2026-01-02T00:36:45.058520897Z","created_by":"daemon"},{"issue_id":"mala-fdp1.14","depends_on_id":"mala-fdp1.13","type":"blocks","created_at":"2026-01-02T00:36:45.125433138Z","created_by":"daemon"}]}
{"id":"mala-fdp1.2","title":"Implement YAML Config Loader","description":"# Task 2: Implement YAML Config Loader\n\n## Context\n- Loads and validates `mala.yaml` with strict schema checking\n- Uses dataclasses from Task 1 (mala-fdp1.1)\n- Provides fail-fast validation with clear error messages\n- AC 5: Missing config error; AC 6: Invalid YAML error\n\n## Scope\n**In**: Create new `src/domain/validation/config_loader.py` with:\n- `load_config(repo_path: Path) -\u003e ValidationConfig`: Load `mala.yaml` from repo root\n- `_parse_yaml(content: str) -\u003e dict`: Parse YAML with error handling\n- `_validate_schema(data: dict) -\u003e None`: Validate against expected schema\n- `_build_config(data: dict) -\u003e ValidationConfig`: Convert dict to dataclass\n- `_validate_config(config: ValidationConfig) -\u003e None`: Post-build validation\n\n**Out**: No preset loading, no config merging\n\n## Acceptance Criteria\n- [ ] Missing file raises `ConfigError`: \"mala.yaml not found in {repo_path}. Mala requires a configuration file to run.\"\n- [ ] Invalid YAML syntax raises `ConfigError`: \"Invalid YAML syntax in mala.yaml: {details}\"\n- [ ] Unknown field raises `ConfigError`: \"Unknown field '{field}' in mala.yaml\"\n- [ ] Invalid type raises `ConfigError`: \"Field '{field}' must be {expected_type}, got {actual_type}\"\n- [ ] No commands defined raises `ConfigError`: \"At least one command must be defined. Specify a preset or define commands directly.\"\n- [ ] Empty command string raises `ConfigError`: \"Command cannot be empty string. Use null to disable.\"\n- [ ] Unsupported coverage format raises `ConfigError`: \"Unsupported coverage format '{format}'. Supported formats: xml\"\n\n## Test Plan\n- [ ] Create `tests/test_config_loader.py`\n- [ ] Create fixtures: `tests/fixtures/mala-configs/valid-minimal.yaml`, `valid-full.yaml`, `invalid-syntax.yaml`, `invalid-unknown-field.yaml`\n- [ ] Test successful load with valid config\n- [ ] Test missing file error (exact message match)\n- [ ] Test invalid YAML syntax error\n- [ ] Test unknown field rejection\n- [ ] Test type validation\n- [ ] Test \"no commands defined\" error\n- [ ] Test empty command string error\n- [ ] Test unsupported coverage format error\n- [ ] Run: `uv run pytest tests/test_config_loader.py -v`\n\n## Notes for Agent\n- Import from `config.py` (Task 1)\n- `_build_config()` will be reused by preset registry (Task 3)\n- PyYAML is available as dependency\n- Validate `coverage.format == \"xml\"` for MVP (other formats deferred)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-02T00:32:41.631928701Z","created_by":"cyou","updated_at":"2026-01-02T03:28:47.853878406Z","closed_at":"2026-01-02T03:28:47.853878406Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-fdp1.2","depends_on_id":"mala-fdp1","type":"parent-child","created_at":"2026-01-02T00:32:41.639744461Z","created_by":"daemon"},{"issue_id":"mala-fdp1.2","depends_on_id":"mala-fdp1.1","type":"blocks","created_at":"2026-01-02T00:36:28.43076917Z","created_by":"daemon"}]}
{"id":"mala-fdp1.3","title":"Create Preset Registry with Built-in Presets","description":"# Task 3: Create Preset Registry with Built-in Presets\n\n## Context\n- Provides built-in presets discoverable via `importlib.resources`\n- AC 1: Go preset; AC 2: Node preset; AC 3: preset + override\n- Depends on Task 1 (config.py) and Task 2 (config_loader.py for `_build_config`)\n\n## Scope\n**In**: \n- Create `src/domain/validation/preset_registry.py`:\n  - `PresetRegistry` class with `get(name)`, `list_presets()`, `_load_preset_yaml()`\n  - Use `importlib.resources` to read preset files\n  - Reuse `_build_config()` from config_loader.py\n- Create `src/domain/validation/presets/__init__.py` (empty package)\n- Create 4 preset files: `python-uv.yaml`, `node-npm.yaml`, `go.yaml`, `rust.yaml`\n- Modify `pyproject.toml`: Add hatch build config for preset inclusion, add PyYAML dependency\n\n**Out**: No config merging (Task 4), no integration with spec builder\n\n## Acceptance Criteria\n- [ ] `PresetRegistry.get(\"python-uv\")` returns valid `ValidationConfig`\n- [ ] `PresetRegistry.get(\"node-npm\")` returns valid `ValidationConfig`\n- [ ] `PresetRegistry.get(\"go\")` returns valid `ValidationConfig`\n- [ ] `PresetRegistry.get(\"rust\")` returns valid `ValidationConfig`\n- [ ] `PresetRegistry.list_presets()` returns `[\"go\", \"node-npm\", \"python-uv\", \"rust\"]`\n- [ ] Unknown preset raises `PresetNotFoundError`: \"Unknown preset '{name}'. Available presets: python-uv, node-npm, go, rust\"\n- [ ] Preset files include documentation comments\n- [ ] `pyproject.toml` includes preset files in wheel and has PyYAML dependency\n\n## Test Plan\n- [ ] Create `tests/test_preset_registry.py`\n- [ ] Unit tests (mock `importlib.resources`):\n  - Test `get()` returns valid `ValidationConfig`\n  - Test `list_presets()` returns all 4 presets\n  - Test `PresetNotFoundError` for unknown preset\n- [ ] Integration tests (real package):\n  - Test actual preset file loading\n  - Test preset YAML syntax validity\n- [ ] Run: `uv run pytest tests/test_preset_registry.py -v`\n\n## Notes for Agent\n- Preset content is defined in the plan (lines 158-249)\n- Use `importlib.resources.files()` for Python 3.9+ compatibility\n- Presets should have comments explaining their purpose\n- pyproject.toml uses hatchling as build backend","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-02T00:32:58.196595344Z","created_by":"cyou","updated_at":"2026-01-02T03:47:23.762216637Z","closed_at":"2026-01-02T03:47:23.762216637Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-fdp1.3","depends_on_id":"mala-fdp1","type":"parent-child","created_at":"2026-01-02T00:32:58.205625628Z","created_by":"daemon"},{"issue_id":"mala-fdp1.3","depends_on_id":"mala-fdp1.2","type":"blocks","created_at":"2026-01-02T00:36:28.499262843Z","created_by":"daemon"}]}
{"id":"mala-fdp1.4","title":"Implement Config Merger","description":"# Task 4: Implement Config Merger\n\n## Context\n- Merges preset config with user overrides (user wins)\n- AC 3: preset + custom override; AC 4: partial config\n- Depends on Task 1 (config.py) and Task 3 (preset_registry.py)\n\n## Scope\n**In**: Create `src/domain/validation/config_merger.py` with:\n- `merge_configs(preset: ValidationConfig | None, user: ValidationConfig) -\u003e ValidationConfig`\n- Merge rules:\n  - If no preset, return user config as-is\n  - Command fields: user replaces preset if present; `null` disables; omitted inherits\n  - Coverage: user replaces preset entirely if present\n  - List fields (code_patterns, config_files, setup_files): user **replaces** preset entirely (no merge)\n\n**Out**: No loading, no preset lookup, no spec building\n\n## Acceptance Criteria\n- [ ] No preset → user config returned unchanged\n- [ ] Preset with no user overrides → preset config returned\n- [ ] User override replaces preset command\n- [ ] User `null` disables preset command (even if preset defines it)\n- [ ] User `None`/omitted inherits preset value\n- [ ] List fields replace entirely (not extend/append)\n- [ ] Coverage override replaces entirely\n\n## Test Plan\n- [ ] Create `tests/test_config_merger.py`\n- [ ] Test no preset (user config returned unchanged)\n- [ ] Test preset with no user overrides\n- [ ] Test user override replaces preset command\n- [ ] Test user `null` disables preset command\n- [ ] Test omitted field inherits preset value\n- [ ] Test list fields replace (not extend)\n- [ ] Test coverage override replaces entirely\n- [ ] Run: `uv run pytest tests/test_config_merger.py -v`\n\n## Notes for Agent\n- Import `ValidationConfig` from `config.py`\n- Must handle `None` vs explicit `null` in YAML (Python `None` vs sentinel)\n- Consider using a sentinel value or explicit flag to distinguish \"not set\" from \"set to null\"","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-02T00:33:23.189435009Z","created_by":"cyou","updated_at":"2026-01-02T04:10:25.89361994Z","closed_at":"2026-01-02T04:10:25.89361994Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-fdp1.4","depends_on_id":"mala-fdp1","type":"parent-child","created_at":"2026-01-02T00:33:23.198815531Z","created_by":"daemon"},{"issue_id":"mala-fdp1.4","depends_on_id":"mala-fdp1.3","type":"blocks","created_at":"2026-01-02T00:36:28.578457763Z","created_by":"daemon"}]}
{"id":"mala-fdp1.5","title":"Implement Tool Name Extractor","description":"# Task 5: Implement Tool Name Extractor\n\n## Context\n- Extracts human-readable tool name from shell command for quality gate messaging\n- AC 10: \"npx eslint\" → \"eslint\"\n- Standalone utility with no dependencies on other config tasks\n\n## Scope\n**In**: Create `src/domain/validation/tool_name_extractor.py` with:\n- `extract_tool_name(command: str) -\u003e str`\n- Algorithm:\n  1. Handle shell operators (`\u0026\u0026`, `||`, `|`, `;`) by trying each segment\n  2. Parse via `shlex.split`; fallback to whitespace-delimited if parsing fails\n  3. Skip env var assignments (tokens with `=` before command)\n  4. Skip shell built-ins (`export`, `set`, `cd`)\n  5. Strip path prefixes (`/usr/bin/eslint` → `eslint`)\n  6. Apply wrapper rules:\n     - Single-token: `npx`, `bunx`, `uvx`, `pipx` → skip wrapper, use next positional\n     - Multi-token: `python -m`, `uv run`, `poetry run` → skip sequence\n     - Compound: `go test`, `cargo clippy`, `npm test` → include subcommand\n     - Script: `npm run lint` → `npm run:lint`\n  7. Fallback: return first token, log warning\n\n**Out**: No integration with quality gate or lint cache (separate tasks)\n\n## Acceptance Criteria\n- [ ] `\"npx eslint .\"` → `\"eslint\"`\n- [ ] `\"uvx ruff check .\"` → `\"ruff\"`\n- [ ] `\"uv run pytest\"` → `\"pytest\"`\n- [ ] `\"go test ./...\"` → `\"go test\"`\n- [ ] `\"cargo clippy\"` → `\"cargo clippy\"`\n- [ ] `\"npm run lint\"` → `\"npm run:lint\"`\n- [ ] Path stripping works: `/usr/bin/eslint` → `eslint`\n- [ ] Unknown wrapper falls back gracefully with warning logged\n- [ ] Empty/malformed commands return best-effort result with warning\n\n## Test Plan\n- [ ] Create `tests/test_tool_name_extractor.py`\n- [ ] Test all spec examples (full table from plan lines 317-325)\n- [ ] Test path stripping\n- [ ] Test unknown wrapper (fallback behavior)\n- [ ] Test empty/malformed commands\n- [ ] Run: `uv run pytest tests/test_tool_name_extractor.py -v`\n\n## Notes for Agent\n- Use `shlex.split` for proper shell parsing\n- Log warnings for fallback cases using Python logging\n- Keep shell built-ins list minimal but complete","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T00:33:41.973528579Z","created_by":"cyou","updated_at":"2026-01-02T03:17:47.804832475Z","closed_at":"2026-01-02T03:17:47.804832475Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-fdp1.5","depends_on_id":"mala-fdp1","type":"parent-child","created_at":"2026-01-02T00:33:41.981806157Z","created_by":"daemon"}]}
{"id":"mala-fdp1.6","title":"Implement Code Pattern Matcher","description":"# Task 6: Implement Code Pattern Matcher\n\n## Context\n- Matches file paths against glob patterns for validation gating\n- AC 9: custom code_patterns filter files correctly\n- Standalone utility with no dependencies on other config tasks\n\n## Scope\n**In**: Create `src/domain/validation/code_pattern_matcher.py` with:\n- `glob_to_regex(pattern: str) -\u003e re.Pattern`: Convert glob to regex\n  - `*` matches non-slash chars\n  - `**` matches anything including `/`\n  - Invalid pattern → treat as literal string, log warning (per user decision 15)\n- `matches_pattern(path: str, pattern: str) -\u003e bool`:\n  - Filename-only patterns (no `/`): match against `os.path.basename(path)`\n  - Path patterns (contain `/`): match against full relative path\n- `filter_matching_files(files: list[str], patterns: list[str]) -\u003e list[str]`:\n  - Return files matching any pattern\n  - Empty patterns list → matches everything\n\n**Out**: No integration with validation runner (Task 13)\n\n## Acceptance Criteria\n- [ ] `*.py` matches `foo.py`, not `foo.js`\n- [ ] `src/*.py` matches `src/foo.py`, not `src/sub/foo.py`\n- [ ] `src/**/*.py` matches `src/foo.py` and `src/sub/deep/file.py`\n- [ ] `**/test_*.py` matches `test_main.py` and `tests/test_utils.py`\n- [ ] Empty patterns list matches everything\n- [ ] Invalid pattern treated as literal string (doesn't raise)\n- [ ] `filter_matching_files` returns correct subset\n\n## Test Plan\n- [ ] Create `tests/test_code_pattern_matcher.py`\n- [ ] Test `*.py` pattern\n- [ ] Test `src/*.py` pattern (single-level)\n- [ ] Test `src/**/*.py` pattern (recursive)\n- [ ] Test `**/test_*.py` pattern\n- [ ] Test empty patterns (matches all)\n- [ ] Test invalid pattern (treated as literal)\n- [ ] Test `filter_matching_files` function\n- [ ] Run: `uv run pytest tests/test_code_pattern_matcher.py -v`\n\n## Notes for Agent\n- Use `fnmatch` or regex translation; consider `pathlib.PurePath.match` limitations\n- `**` must handle zero-or-more directory levels\n- Log warnings for invalid patterns using Python logging","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T00:33:57.705106224Z","created_by":"cyou","updated_at":"2026-01-02T03:15:34.48977877Z","closed_at":"2026-01-02T03:15:34.48977877Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-fdp1.6","depends_on_id":"mala-fdp1","type":"parent-child","created_at":"2026-01-02T00:33:57.714649996Z","created_by":"daemon"}]}
{"id":"mala-fdp1.7","title":"Create Config-Driven Spec Builder","description":"# Task 7: Create Config-Driven Spec Builder\n\n## Context\n- Core integration: replaces hard-coded Python commands with config-driven `ValidationSpec`\n- AC 1-4: all language command execution\n- Depends on Tasks 1-6 (config, loader, presets, merger, utilities)\n- **Critical**: This is the central integration point that ties everything together\n\n## Scope\n**In**: Modify `src/domain/validation/spec.py`:\n- Update `build_validation_spec(repo_path: Path)`:\n  - Call `load_config(repo_path)` eagerly at startup\n  - If `preset` specified, load via `PresetRegistry.get()` and merge\n  - Build `ValidationCommand` instances from merged config\n  - Use 120s default timeout, override with per-command timeout if specified\n  - Set `code_patterns`, `config_files`, `setup_files` on `ValidationSpec`\n- Extend `ValidationSpec` dataclass:\n  - Add `code_patterns: list[str]`, `config_files: list[str]`, `setup_files: list[str]`\n- Modify `ValidationCommand`:\n  - Change `command: list[str]` to `command: str` (shell string)\n  - Add `shell: bool = True`, `timeout: int = 120`\n- Remove hard-coded Python command logic and `RepoType` enum\n- Modify `src/domain/validation/__init__.py`: Remove `RepoType` from re-exports\n\n**Out**: Coverage parsing (Task 8), command execution (Task 12), validation gating (Task 13)\n\n## Acceptance Criteria\n- [ ] `build_validation_spec()` loads `mala.yaml` from repo root\n- [ ] Preset config is loaded and merged when specified\n- [ ] `ValidationSpec` has `code_patterns`, `config_files`, `setup_files` fields\n- [ ] `ValidationCommand.command` is `str` (shell string), not `list[str]`\n- [ ] `ValidationCommand.shell` defaults to `True`\n- [ ] `ValidationCommand.timeout` defaults to 120, can be overridden\n- [ ] `RepoType` enum is removed\n- [ ] All tests constructing `ValidationCommand` are updated\n\n## Test Plan\n- [ ] Update `tests/test_spec.py`:\n  - Remove tests for `RepoType` detection\n  - Add tests for config-driven spec building\n  - Test `ValidationSpec` with pattern fields\n  - Test `ValidationCommand` with `shell=True` and timeout\n- [ ] Create fixtures: `tests/fixtures/mala-configs/go-project.yaml`, `node-project.yaml`, `preset-override.yaml`, `partial-config.yaml`, `command-with-timeout.yaml`\n- [ ] Update all tests constructing `ValidationCommand`:\n  - `tests/test_validation.py`\n  - `tests/test_orchestrator.py`\n  - `tests/test_quality_gate.py`\n  - `tests/test_spec_workspace.py`\n  - `tests/test_gate_runner.py`\n- [ ] Run: `uv run pytest tests/test_spec.py -v`\n\n## Notes for Agent\n- This is a significant refactor with many test updates\n- Search for all `ValidationCommand` usages in tests\n- `RepoType` removal is breaking — ensure no lingering references\n- Import from new config modules","notes":"Quality gate failed: External review failed: Empty output from review-gate\nLog: /home/cyou/.claude/projects/-home-cyou-mala/915ca1e4-f242-484c-977f-d99940ab45f1.jsonl","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-02T00:34:20.299104855Z","created_by":"cyou","updated_at":"2026-01-02T15:25:31.788036109Z","closed_at":"2026-01-02T15:25:31.788036109Z","close_reason":"Closed","labels":["needs-followup"],"dependencies":[{"issue_id":"mala-fdp1.7","depends_on_id":"mala-fdp1","type":"parent-child","created_at":"2026-01-02T00:34:20.299636532Z","created_by":"daemon"},{"issue_id":"mala-fdp1.7","depends_on_id":"mala-fdp1.4","type":"blocks","created_at":"2026-01-02T00:36:28.643300535Z","created_by":"daemon"},{"issue_id":"mala-fdp1.7","depends_on_id":"mala-fdp1.5","type":"blocks","created_at":"2026-01-02T00:36:28.714430435Z","created_by":"daemon"},{"issue_id":"mala-fdp1.7","depends_on_id":"mala-fdp1.6","type":"blocks","created_at":"2026-01-02T00:36:28.777394696Z","created_by":"daemon"}]}
{"id":"mala-fdp1.8","title":"Update Coverage Parsing for Config","description":"# Task 8: Update Coverage Parsing for Config\n\n## Context\n- Uses coverage config for file path, format, and threshold\n- AC 7: coverage parsing; AC 8: no coverage section\n- Depends on Task 7 (spec builder provides `YamlCoverageConfig`)\n\n## Scope\n**In**: Modify `src/domain/validation/coverage.py`:\n- Update `parse_coverage_xml` signature to accept `YamlCoverageConfig`\n- Use `coverage_config.file` for XML path (instead of hardcoded `coverage.xml`)\n- Use `coverage_config.threshold` for pass/fail determination\n- Keep existing Cobertura XML parsing logic\n- Update call sites:\n  - `parse_and_check_coverage()` wrapper (~line 228)\n  - `get_baseline_coverage()` (~line 249)\n  - `src/domain/validation/spec_result_builder.py` - `_check_coverage()` method\n- Handle missing coverage config: skip evaluation entirely (return `None`)\n- Missing coverage file after test run: validation fails with clear error\n\n**Out**: Baseline refresh with custom command (Task 9)\n\n## Acceptance Criteria\n- [ ] `parse_coverage_xml` accepts `YamlCoverageConfig` parameter\n- [ ] Uses `coverage_config.file` for coverage file path\n- [ ] Uses `coverage_config.threshold` for pass/fail\n- [ ] Pass at threshold, fail below threshold\n- [ ] No coverage config → skip coverage (return `None`)\n- [ ] Missing coverage file → clear error message\n\n## Test Plan\n- [ ] Update `tests/test_coverage.py`:\n  - Test with `YamlCoverageConfig` specifying file and threshold\n  - Test threshold enforcement (pass at threshold, fail below)\n  - Test behavior when no coverage config (skip)\n  - Test missing coverage file error\n  - Update all existing tests to use new signature\n- [ ] Run: `uv run pytest tests/test_coverage.py -v`\n\n## Notes for Agent\n- Existing `CoverageConfig` in spec.py has different fields (`enabled`, `min_percent`, `branch`, `report_path`)\n- Use new `YamlCoverageConfig` from `config.py` (Task 1)\n- Keep Cobertura XML parsing unchanged (uses `\u003ccoverage line-rate\u003e` attribute)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-02T00:34:36.228703392Z","created_by":"cyou","updated_at":"2026-01-02T15:33:42.537977377Z","closed_at":"2026-01-02T15:33:42.537977377Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-fdp1.8","depends_on_id":"mala-fdp1","type":"parent-child","created_at":"2026-01-02T00:34:36.22918131Z","created_by":"daemon"},{"issue_id":"mala-fdp1.8","depends_on_id":"mala-fdp1.7","type":"blocks","created_at":"2026-01-02T00:36:37.183860856Z","created_by":"daemon"}]}
{"id":"mala-fdp1.9","title":"Generalize BaselineCoverageService for Config","description":"# Task 9: Generalize BaselineCoverageService for Config\n\n## Context\n- Supports config-driven coverage command for baseline refresh\n- AC 7: coverage command execution\n- Depends on Task 8 (coverage parsing with `YamlCoverageConfig`)\n\n## Scope\n**In**: Modify `src/domain/validation/coverage.py`:\n- Update `BaselineCoverageService` to accept `YamlCoverageConfig`\n- Use `coverage_config.command` for running coverage (required for baseline refresh)\n- Use `coverage_config.timeout` (or default 120s)\n- If no coverage config, baseline refresh is not available\n- If `coverage.command` execution fails, overall validation fails\n\n**Out**: Integration with other components (handled by spec builder)\n\n## Acceptance Criteria\n- [ ] `BaselineCoverageService` accepts `YamlCoverageConfig`\n- [ ] Uses `coverage_config.command` to generate coverage\n- [ ] Uses `coverage_config.timeout` for command execution\n- [ ] No coverage config → baseline refresh unavailable\n- [ ] `coverage.command` failure → overall validation fails\n\n## Test Plan\n- [ ] Update `tests/test_coverage.py`:\n  - Test baseline refresh with custom coverage command\n  - Test failure when `coverage.command` fails\n  - Test behavior without coverage config (baseline refresh unavailable)\n- [ ] Run: `uv run pytest tests/test_coverage.py -v`\n\n## Notes for Agent\n- `coverage.command` is required for baseline refresh (per user decision 14)\n- Reuse existing command execution infrastructure\n- Coordinate with Task 12 for shell command execution","status":"in_progress","priority":1,"issue_type":"task","created_at":"2026-01-02T00:34:49.60237416Z","created_by":"cyou","updated_at":"2026-01-02T15:33:42.652576574Z","dependencies":[{"issue_id":"mala-fdp1.9","depends_on_id":"mala-fdp1","type":"parent-child","created_at":"2026-01-02T00:34:49.609535984Z","created_by":"daemon"},{"issue_id":"mala-fdp1.9","depends_on_id":"mala-fdp1.8","type":"blocks","created_at":"2026-01-02T00:36:37.25032021Z","created_by":"daemon"}]}
{"id":"mala-fih","title":"Claude orchestrator with manual context management","description":"Add back a Claude-based orchestrator that manually manages context windows (non-MCP), for long-running tasks that exceed default context limits.","status":"closed","priority":4,"issue_type":"epic","created_at":"2025-12-26T00:55:42.188094716Z","updated_at":"2026-01-01T21:40:54.414344386Z","closed_at":"2026-01-01T21:40:54.414344386Z","close_reason":"Closed"}
{"id":"mala-fx2","title":"Improve orchestrator terminal logging visibility","description":"## Problem\n\nAfter codex review passes, there are no logs until tests pass, making it unclear if the orchestrator is hung or actively working. The logging posture has significant gaps throughout the orchestration lifecycle.\n\n## Current Logging Gaps\n\n### Phase 1: Log File Waiting (AWAITING_LOG state)\n- No log when entering AWAITING_LOG state\n- No log when log file is found (silent success)\n- Only timeout warnings are logged\n\n### Phase 2: Quality Gate Execution (CRITICAL GAP)\nThis is the **most important gap**:\n- No log when starting quality gate check (orchestrator.py:860)\n- No log when gate passes (orchestrator.py:874)\n- No log showing which validation steps are running (pytest, ruff, ty)\n- Gate retry messages exist (line 885) but initial attempts are silent\n- Individual validation commands run completely silently\n\n### Phase 3: State Transitions\n- Lifecycle effect transitions don't log entry/exit\n- Users can't see which state the orchestrator is in\n\n## Locations to Fix\n\n1. **orchestrator.py:860** - Add log before quality gate starts\n2. **orchestrator.py:874** - Add log when gate passes  \n3. **quality_gate.py** - Add logs for each validation step (pytest/ruff/ty)\n4. **orchestrator.py:828-857** - Add logs for log file polling lifecycle\n5. **lifecycle.py** - Consider logging state transitions\n\n## Acceptance Criteria\n\n- [ ] Log message when entering quality gate phase\n- [ ] Log message for each validation step (pytest/ruff check/ruff format/ty)\n- [ ] Log message when quality gate passes/fails with summary\n- [ ] Log message when waiting for log file and when found\n- [ ] State transitions visible at verbose level (-v flag)\n- [ ] No silent gaps \u003e 5 seconds during normal operation\n- [ ] Logs should be concise but informative (icon + brief message pattern)\n\n## Non-Goals\n\n- Don't add excessive logging that clutters output\n- Don't log internal implementation details\n- Keep existing log format/style consistent","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-28T19:55:30.940708588Z","updated_at":"2025-12-28T20:24:38.311409891Z","closed_at":"2025-12-28T20:24:38.311409891Z","close_reason":"Closed","labels":["enhancement"]}
{"id":"mala-g1sg","title":"[Review] src/infra/clients/cerberus_review.py:248-250: [P2] Robustly check both stderr and stdout for 'already active' error","description":"## Review Finding\n\nThis issue was auto-created from a P2 review finding.\n\n**Source issue:** mala-awsa\n**Reviewer:** gemini\n**Location:** src/infra/clients/cerberus_review.py:248-250\n\n## Details\n\nThe `detail` string is constructed using `stderr or stdout`, which means if the tool emits any output to `stderr` (such as a warning or progress message) while the actual 'already active' error is in `stdout`, the check will only evaluate `stderr` and miss the fatal error condition. Consider combining both streams or checking them independently to ensure the fatal error is always detected.","notes":"Quality gate failed: External review failed: spawn failed: Artifact written: /home/cyou/.claude/projects/-home-cyou-mala/cerberus/0912b4db-bf82-4e51-9436-a4b9b8cdbe58/latest.md\nReview gate already active (status: pending, age: 37s)\nUse /home/cyou/.claude/plugins/cache/cerberus/cerberus/1.10.6/bin/review-gate resolve to complete the existing gate first.\nLog: /home/cyou/.claude/projects/-home-cyou-mala/0912b4db-bf82-4e51-9436-a4b9b8cdbe58.jsonl","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T23:55:18.801114849Z","created_by":"cyou","updated_at":"2026-01-02T00:48:36.303676191Z","closed_at":"2026-01-02T00:48:36.303676191Z","close_reason":"Closed","labels":["auto_generated","needs-followup","review_finding","review_finding:13f6d14e6989","source:mala-awsa"]}
{"id":"mala-g3h","title":"Epic: Focus mode prioritization (epic-grouped ordering)","description":"Context:\n- Currently tasks are ordered by priority only, causing interleaved commits across unrelated epics\n- This makes PR reviews difficult as changes span multiple unrelated features\n- Need epic-grouped ordering as the default: finish one epic before starting the next\n- Orphan tasks (no parent epic) compete by their own priority\n\nScope:\n- In: New `--focus/--no-focus` CLI flag (default True), epic-grouped ordering algorithm, parent epic lookup\n- Out: Changes to how epics themselves are prioritized or closed\n\nAcceptance Criteria:\n- Default behavior groups tasks by epic, finishing one before starting another\n- `--no-focus` reverts to priority-only interleaved ordering\n- Orphan tasks compete with epic groups by min priority\n- Tiebreaker for equal-priority groups: most recently updated first\n\nPrimary files: src/beads_client.py, src/cli.py, src/orchestrator.py","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-27T18:14:07.040578765Z","updated_at":"2025-12-28T02:15:11.779722936Z","closed_at":"2025-12-28T02:15:11.779722936Z","close_reason":"All children completed"}
{"id":"mala-g3h.1","title":"BeadsClient: add parent epic lookup methods","description":"Context:\n- Need to determine parent epic for each task to enable grouping\n- `bd dep tree \u003cid\u003e --direction=down` returns parent chain (epic at depth=1)\n- Should cache results to avoid repeated subprocess calls for tasks in same epic\n\nScope:\n- In: Add `get_parent_epic_async(issue_id) -\u003e str | None` method to BeadsClient\n- In: Add batch method `get_parent_epics_async(issue_ids) -\u003e dict[str, str | None]` for efficiency\n- Out: Changes to existing `get_ready_async` signature (handled in later issue)\n\nAcceptance Criteria:\n- `get_parent_epic_async` returns parent epic ID or None for orphans\n- Batch method minimizes subprocess calls (one call per unique epic, not per task)\n- Method handles errors gracefully (returns None on failure)\n\nTest Plan:\n- Add unit tests with mocked subprocess calls\n- Test orphan detection (no parent epic)\n- Test caching behavior\n\nNotes for Agent:\n- Use existing `_run_subprocess_async` pattern\n- Epic is identified by `issue_type == \"epic\"` at depth \u003e 0 in tree output\n\nPrimary files: src/beads_client.py","notes":"Quality gate failed: Codex review failed: N/A:0: Missing scope item: “Add batch method `get_parent_epics_async(issue_ids) -\u003e dict[str, str | None]` for efficiency” — current implementation makes one subprocess call per issue and provides no caching or epic-level reuse, so it does not minimize calls per unique epic as required.; src/beads_client.py:0: Acceptance criterion unmet: “Batch method minimizes subprocess calls (one call per unique epic, not per task)” — `get_parent_epics_async` always calls `get_parent_epic_async` for every issue (no cache or shared lookup), so repeated tasks under the same epic still incur repeated subprocess calls.\nLog: /home/cyou/.claude/projects/-home-cyou-mala/f8ea7fdd-e1ed-420b-82f7-41ae08fccb3f.jsonl","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-27T18:19:30.185666573Z","updated_at":"2025-12-28T01:05:50.928479045Z","closed_at":"2025-12-28T01:05:50.928479045Z","close_reason":"Closed","labels":["needs-followup"],"dependencies":[{"issue_id":"mala-g3h.1","depends_on_id":"mala-g3h","type":"parent-child","created_at":"2025-12-27T18:19:30.192508435Z","created_by":"daemon"}]}
{"id":"mala-g3h.2","title":"BeadsClient: implement epic-grouped sorting in get_ready_async","description":"Context:\n- `get_ready_async` currently sorts by `(status, priority)` with optional WIP prioritization\n- Need to add `focus` parameter that groups by parent epic before sorting by priority\n- Tiebreaker for equal-priority groups: max `updated_at` descending (recent first)\n\nScope:\n- In: Add `focus: bool = True` parameter to `get_ready_async`\n- In: Implement grouping algorithm: group by epic → sort groups by (min_priority, max_updated DESC) → sort within groups by (priority, updated DESC)\n- In: Orphan tasks form virtual group with same sorting rules\n- Out: CLI changes (separate issue)\n\nAcceptance Criteria:\n- When `focus=True`: tasks grouped by epic, one epic completed before next\n- When `focus=False`: current behavior (priority-only, interleaved)\n- WIP prioritization (`prioritize_wip`) still moves in_progress to front globally\n- Equal-priority groups ordered by most recently updated first\n\nTest Plan:\n- TDD: Add failing test for epic-grouped ordering\n- Test orphan tasks competing with epic groups\n- Test tiebreaker behavior (updated_at)\n- Test composition with `prioritize_wip`\n- Run `uv run pytest tests/test_wip_prioritization.py` (expand this file or create new)\n\nNotes for Agent:\n- Use `get_parent_epics_async` from previous issue for batch lookup\n- Issues from `bd ready --json` include `updated_at` field\n\nPrimary files: src/beads_client.py","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-27T18:19:46.264724796Z","updated_at":"2025-12-28T01:17:06.18218596Z","closed_at":"2025-12-28T01:17:06.18218596Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-g3h.2","depends_on_id":"mala-g3h","type":"parent-child","created_at":"2025-12-27T18:19:46.271892236Z","created_by":"daemon"},{"issue_id":"mala-g3h.2","depends_on_id":"mala-g3h.1","type":"blocks","created_at":"2025-12-27T18:20:16.400724757Z","created_by":"daemon"}]}
{"id":"mala-g3h.3","title":"CLI: add --focus/--no-focus flag for epic-grouped ordering","description":"Context:\n- Need CLI interface for the focus mode feature\n- Should be default True (epic-grouped), with `--no-focus` to revert to old behavior\n- Typer supports `--flag/--no-flag` syntax natively\n\nScope:\n- In: Add `--focus/--no-focus` flag to `run` command (default True)\n- In: Pass `focus` parameter through to orchestrator\n- In: Update help text to explain the behavior\n- Out: Changes to beads_client (already done in previous issue)\n\nAcceptance Criteria:\n- `mala run` uses epic-grouped ordering by default\n- `mala run --no-focus` uses priority-only ordering\n- Help text clearly explains the difference\n- Flag composes correctly with `--wip`\n\nTest Plan:\n- Test CLI parsing for `--focus` and `--no-focus`\n- Integration test showing different orderings\n- Run `uv run pytest tests/test_cli.py`\n\nNotes for Agent:\n- Use Typer's `--flag/--no-flag` syntax: `typer.Option(\"--focus/--no-focus\")`\n- Default value is `True`\n\nPrimary files: src/cli.py","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-27T18:19:57.722163143Z","updated_at":"2025-12-28T01:48:27.726665128Z","closed_at":"2025-12-28T01:48:27.726665128Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-g3h.3","depends_on_id":"mala-g3h","type":"parent-child","created_at":"2025-12-27T18:19:57.728621219Z","created_by":"daemon"},{"issue_id":"mala-g3h.3","depends_on_id":"mala-g3h.4","type":"blocks","created_at":"2025-12-27T18:22:11.479341622Z","created_by":"daemon"}]}
{"id":"mala-g3h.4","title":"Orchestrator: wire focus parameter through to BeadsClient","description":"Context:\n- Orchestrator receives config from CLI and passes to BeadsClient\n- Need to thread `focus` parameter through `MalaOrchestrator.__init__` and `run` method\n\nScope:\n- In: Add `focus` parameter to `MalaOrchestrator.__init__`\n- In: Pass `focus` to `beads.get_ready_async` calls in orchestrator\n- Out: CLI changes (done in previous issue), beads_client changes (done earlier)\n\nAcceptance Criteria:\n- `MalaOrchestrator` accepts `focus` parameter\n- Parameter passed correctly to all `get_ready_async` calls\n- Default behavior is focus mode enabled\n\nTest Plan:\n- Unit test orchestrator initialization with focus parameter\n- Integration test end-to-end with `--focus` and `--no-focus`\n- Run `uv run pytest tests/test_orchestrator.py`\n\nNotes for Agent:\n- Check all call sites of `get_ready_async` in orchestrator\n- Ensure consistency with existing parameter threading pattern (like `prioritize_wip`)\n\nPrimary files: src/orchestrator.py","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-27T18:20:08.198862782Z","updated_at":"2025-12-28T01:41:56.900739631Z","closed_at":"2025-12-28T01:41:56.900739631Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-g3h.4","depends_on_id":"mala-g3h","type":"parent-child","created_at":"2025-12-27T18:20:08.206662307Z","created_by":"daemon"},{"issue_id":"mala-g3h.4","depends_on_id":"mala-g3h.5","type":"blocks","created_at":"2025-12-27T18:23:43.739408416Z","created_by":"daemon"}]}
{"id":"mala-g3h.5","title":"BeadsClient: exclude tasks whose parent epic is blocked","description":"Context:\n- Currently `get_ready_async` relies on `bd ready` for blocker detection\n- But `bd ready` doesn't consider parent epic status\n- If Epic A is blocked by Epic B, tasks in Epic A still appear ready\n- This causes work to start on tasks that shouldn't be worked on yet\n\nScope:\n- In: When filtering ready tasks, check if parent epic is blocked\n- In: Exclude tasks whose parent epic has status \"blocked\" or has unmet dependencies\n- In: Use parent epic lookup from g3h.1 to get parent epic ID, then check its status\n- Out: Changes to how epic blocking works in beads itself\n\nAcceptance Criteria:\n- Tasks with a blocked parent epic do not appear in ready list\n- Tasks with an unblocked parent epic (or no parent) appear normally\n- Works correctly with focus mode enabled or disabled\n\nTest Plan:\n- TDD: Create test with mocked blocked epic, verify children excluded\n- Test orphan tasks still appear (no parent epic to block them)\n- Test task appears after parent epic unblocked\n- Run `uv run pytest tests/test_beads_client.py`\n\nNotes for Agent:\n- Can check epic status via `bd show \u003cepic_id\u003e --json`\n- Or batch check via `bd list --json` and filter\n- Consider caching epic status lookups for efficiency\n\nPrimary files: src/beads_client.py","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-27T18:23:21.585735056Z","updated_at":"2025-12-28T01:25:08.698681216Z","closed_at":"2025-12-28T01:25:08.698681216Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-g3h.5","depends_on_id":"mala-g3h","type":"parent-child","created_at":"2025-12-27T18:23:21.593215576Z","created_by":"daemon"},{"issue_id":"mala-g3h.5","depends_on_id":"mala-g3h.2","type":"blocks","created_at":"2025-12-27T18:23:43.705974665Z","created_by":"daemon"}]}
{"id":"mala-g3h.6","title":"CLI: add --dry-run flag to preview task order","description":"Context:\n- Users want to see what order tasks will be processed before actually running\n- Helps verify focus mode is working as expected\n- Useful for debugging prioritization issues\n\nScope:\n- In: Add `--dry-run` flag to `mala run` command\n- In: When set, call `get_ready_async` with current settings and display ordered task list\n- In: Show task ID, title, parent epic, priority for each task\n- In: Exit without claiming or processing any tasks\n- Out: Changes to actual task processing logic\n\nAcceptance Criteria:\n- `mala run --dry-run` outputs ordered list of tasks that would be processed\n- Output shows grouping by epic when focus mode enabled\n- Output includes task metadata (ID, title, epic, priority)\n- No tasks are claimed or modified\n- Works with all other flags (--epic, --only, --wip, --no-focus)\n\nTest Plan:\n- Test dry-run output matches actual run order\n- Test with various flag combinations\n- Test empty task list case\n- Run `uv run pytest tests/test_cli.py`\n\nNotes for Agent:\n- Consider table or tree format for output\n- Show epic headers when in focus mode to visualize grouping\n- Include count of tasks per epic\n\nPrimary files: src/cli.py","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-27T18:25:24.595986994Z","updated_at":"2025-12-28T02:15:11.760785313Z","closed_at":"2025-12-28T02:15:11.760785313Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-g3h.6","depends_on_id":"mala-g3h","type":"parent-child","created_at":"2025-12-27T18:25:24.59642406Z","created_by":"daemon"},{"issue_id":"mala-g3h.6","depends_on_id":"mala-g3h.3","type":"blocks","created_at":"2025-12-27T18:25:29.144583329Z","created_by":"daemon"}]}
{"id":"mala-g90u","title":"[Review] tests/test_code_pattern_matcher.py:70: [P2] mock_compile drops arguments passed to re.compile","description":"## Review Finding\n\nThis issue was auto-created from a P2 review finding.\n\n**Source issue:** mala-67vp\n**Reviewer:** gemini\n**Location:** tests/test_code_pattern_matcher.py:70\n\n## Details\n\nThe `mock_compile` helper function accepts `*args` and `**kwargs` but does not pass them to `original_compile` in the fallback path. If `glob_to_regex` uses flags (like `re.IGNORECASE`) when compiling the regex, they will be lost in the second call, potentially resulting in an incorrect regex object and invalidating the test.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T03:21:30.477554196Z","created_by":"cyou","updated_at":"2026-01-02T03:25:29.110208343Z","closed_at":"2026-01-02T03:25:29.110208343Z","close_reason":"Closed","labels":["auto_generated","review_finding","review_finding:247ec6f5af2a","source:mala-67vp"]}
{"id":"mala-ggi","title":"Add continuous run mode flag to CLI","description":"Add a run mode flag in the CLI where if there are no ready tasks, it just keeps waiting infinitely. Same behavior at the end - just keeps running until an issue is ready.\n\n## Requirements\n- Add a CLI flag (e.g., `--continuous` or `--wait`) to enable this mode\n- When enabled and no ready tasks exist, wait indefinitely instead of exiting\n- When all current tasks complete, continue waiting for new ready tasks instead of exiting\n- Poll periodically for new ready issues\n\n## Acceptance Criteria\n- [ ] New CLI flag added and documented\n- [ ] Infinite wait loop when no ready tasks\n- [ ] Continues running after completing tasks\n- [ ] Clean shutdown on interrupt (Ctrl+C)","status":"blocked","priority":2,"issue_type":"task","created_at":"2025-12-27T05:54:29.745014725Z","updated_at":"2025-12-28T06:25:01.777631266Z"}
{"id":"mala-ggx","title":"Spawn continuation agent with prior work summary","status":"tombstone","priority":2,"issue_type":"epic","created_at":"2025-12-26T00:55:42.639177056Z","updated_at":"2025-12-26T00:56:32.195175308Z","deleted_at":"2025-12-26T00:56:32.195175308Z","deleted_by":"daemon","delete_reason":"delete","original_type":"epic"}
{"id":"mala-go0b","title":"[Review] tests/test_config_merger.py:878-896: [P3] Test docstring claims to match merge_configs example but uses different API","description":"## Review Finding\n\nThis issue was auto-created from a P3 review finding.\n\n**Source issue:** mala-lq68\n**Reviewer:** claude\n**Location:** tests/test_config_merger.py:878-896\n\n## Details\n\nThe test docstring at lines 878-895 claims \"This matches the example from the merge_configs docstring\" but shows direct constructor usage. The actual `merge_configs` docstring (lines 91-109) uses `from_dict`. The test is still valid (tests programmatic configs work), but the comment is misleading and could confuse future maintainers.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-02T04:23:34.319478324Z","created_by":"cyou","updated_at":"2026-01-02T04:27:45.881489993Z","closed_at":"2026-01-02T04:27:45.881489993Z","close_reason":"Closed","labels":["auto_generated","review_finding","review_finding:1c7429f9bfe3","source:mala-lq68"]}
{"id":"mala-grm7","title":"[Review] tests/test_cerberus_review.py:724: [P3] Redundant imports in test methods","description":"## Review Finding\n\nThis issue was auto-created from a P3 review finding.\n\n**Source issue:** mala-apsz\n**Reviewer:** gemini\n**Location:** tests/test_cerberus_review.py:724\n\n## Details\n\nIn `tests/test_cerberus_review.py`, the new test methods redundantly import `Path` from `pathlib` locally, even though it is already imported at the top of the file (line 14). This clutters the test code without providing any benefit.","notes":"Quality gate failed: External review failed: spawn failed: Artifact written: /home/cyou/.claude/projects/-home-cyou-mala/cerberus/e0c0d0f3-1b24-45af-b2ea-e849c9b13e68/latest.md\nReview gate already active (status: pending, age: 55s)\nUse /home/cyou/.claude/plugins/cache/cerberus/cerberus/1.10.6/bin/review-gate resolve to complete the existing gate first.\nLog: /home/cyou/.claude/projects/-home-cyou-mala/e0c0d0f3-1b24-45af-b2ea-e849c9b13e68.jsonl","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-01T23:49:33.652249167Z","created_by":"cyou","updated_at":"2026-01-02T00:47:48.173223152Z","closed_at":"2026-01-02T00:47:48.173223152Z","close_reason":"Closed","labels":["auto_generated","needs-followup","review_finding","review_finding:1f37bbb63222","source:mala-apsz"]}
{"id":"mala-he7","title":"Disallow git restore command","description":"The CLI should not allow the git restore command to be executed. This command can be destructive as it discards uncommitted changes without confirmation.","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-27T20:06:38.195974516Z","updated_at":"2025-12-27T20:57:22.04486967Z","closed_at":"2025-12-27T20:57:22.04486967Z","close_reason":"Closed"}
{"id":"mala-hmfb","title":"add issue retry","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-02T15:32:40.591855646Z","created_by":"cyou","updated_at":"2026-01-02T15:32:40.591855646Z"}
{"id":"mala-hof5","title":"[Review] src/domain/validation/config_merger.py:52-66: [P3] Fix docstring example to reflect new _fields_set behavior","description":"## Review Finding\n\nThis issue was auto-created from a P3 review finding.\n\n**Source issue:** mala-fdp1.4\n**Reviewer:** codex\n**Location:** src/domain/validation/config_merger.py:52-66\n\n## Details\n\nThe example in `merge_configs` shows programmatic construction via `ValidationConfig(...)`/`CommandsConfig(...)`, but overrides won’t apply because `_fields_set` is empty unless `from_dict` is used. This example now demonstrates behavior that no longer works as shown. Update it to use `from_dict` (or mention setting `_fields_set`).","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-02T04:10:25.934776424Z","created_by":"cyou","updated_at":"2026-01-02T04:19:31.917974619Z","closed_at":"2026-01-02T04:19:31.917974619Z","close_reason":"Closed","labels":["auto_generated","review_finding","review_finding:22e8389addf7","source:mala-fdp1.4"]}
{"id":"mala-hro","title":"Epic: Strict-by-default validation pipeline (v5 plan)","description":"Context:\n- Implements the v5 quality-hardening plan (docs/quality-hardening-plan.md).\n- Coordinates validation modules plus orchestrator/gate integration.\n\nScope:\n- In: all child issues required to implement strict-by-default validation pipeline.\n- Out: product feature changes unrelated to validation.\n\nAcceptance Criteria:\n- All child issues closed and dependencies satisfied.\n- End-to-end validation pipeline implemented per plan.\n\nTest Plan:\n- Review child issue test plans; run full suite when integration is complete.\n\nNotes for Agent:\n- This is an umbrella epic for dependency management only.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-26T22:58:40.016961193Z","updated_at":"2025-12-27T05:57:43.092716959Z","closed_at":"2025-12-27T05:57:43.092716959Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-hro","depends_on_id":"mala-2i7","type":"blocks","created_at":"2025-12-26T23:00:26.313705147Z","created_by":"daemon"},{"issue_id":"mala-hro","depends_on_id":"mala-x00","type":"blocks","created_at":"2025-12-26T23:00:26.33116988Z","created_by":"daemon"}]}
{"id":"mala-i8ke","title":"[Review] src/orchestration/orchestrator.py:747-761: [P2] Duplicated state between Orchestrator and Coordinator","description":"## Review Finding\n\nThis issue was auto-created from a P2 review finding.\n\n**Source issue:** mala-cavk.3\n**Reviewer:** gemini\n**Location:** src/orchestration/orchestrator.py:747-761\n\n## Details\n\nThe `IssueExecutionCoordinator` maintains its own copies of `active_tasks`, `failed_issues`, and `completed_ids`. `MalaOrchestrator` also maintains these, leading to a need for manual synchronization (as seen in `spawn_agent` and `finalize_callback`). Modifications to `MalaOrchestrator` attributes like `max_issues` after initialization will not be reflected in the coordinator unless synced manually, as demonstrated by the fix in `test_respects_max_issues_limit`.","notes":"Quality gate failed: External review failed: spawn failed: Error: --exclude expects git exclude pathspec syntax (e.g. :!path or :(exclude,glob)path): .beads/\nLog: /home/cyou/.claude/projects/-home-cyou-mala/22d76d35-50cf-4de4-afa0-b3807467e18e.jsonl","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T22:23:07.43843243Z","created_by":"cyou","updated_at":"2026-01-02T01:01:46.123732965Z","closed_at":"2026-01-02T01:01:46.123732965Z","close_reason":"Closed","labels":["auto_generated","needs-followup","review_finding","review_finding:aaab6cd0b9b4","source:mala-cavk.3"]}
{"id":"mala-ih0","title":"Use codex for code review","description":"Use Codex for code review: add an optional post-implementation review pass and surface findings before commit/close.","status":"closed","priority":4,"issue_type":"epic","created_at":"2025-12-26T00:55:42.345522647Z","updated_at":"2025-12-27T06:45:00.821373421Z","closed_at":"2025-12-27T06:45:00.821373421Z","close_reason":"Already implemented: Codex review exists in the validation pipeline"}
{"id":"mala-ilt","title":"Non-verbose mode: single line per tool call","description":"Add a non-verbose mode (--quiet or --verbose=false) that prints only one line per tool call for cleaner output:\n\n## Tool Output Formats\n\n| Tool | Output |\n|------|--------|\n| Read | file_path |\n| Edit | file_path |\n| Write | file_path |\n| Bash | description field |\n| Other | truncated args dict |\n\n## Implementation\n\n- Add --verbose / --quiet CLI flag (default: verbose)\n- Pass verbosity setting to logging helpers\n- Update log_tool to format output based on verbosity level\n- Keep existing verbose output as default for backwards compatibility\n\n## Acceptance Criteria\n\n- [ ] CLI accepts --verbose / --quiet flag\n- [ ] Non-verbose mode shows single line per tool call\n- [ ] File tools (Read/Edit/Write) show only file_path\n- [ ] Bash shows description field\n- [ ] Other tools show truncated args dict\n- [ ] Verbose mode (default) unchanged\n- [ ] Tests cover both modes","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-26T23:17:38.426214113Z","updated_at":"2025-12-27T09:02:44.015665617Z","closed_at":"2025-12-27T09:02:44.015665617Z","close_reason":"Closed"}
{"id":"mala-iml","title":"Widen quality gate commit window","description":"Context:\n- Quality gate only searches commits from the last 24 hours; long-running work gets flagged as failed even when commits exist.\n- Needs verification: confirm intended commit search window policy.\n\nScope:\n- In: widen or parameterize the commit search window and update related tests.\n- Out: changing validation command requirements or gate semantics beyond the commit window.\n\nAcceptance Criteria:\n- A commit older than 1 day with bd-\u003cissue_id\u003e satisfies the gate.\n- Failure message reflects the new window if no commit is found.\n\nTest Plan:\n- TDD: add a failing test for an older commit, implement the change, then run quality gate tests in tests/test_orchestrator.py.\n\nNotes for Agent:\n- Keep the log parsing behavior unchanged.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-26T17:35:48.828509883Z","updated_at":"2025-12-26T18:47:04.234602018Z","closed_at":"2025-12-26T18:47:04.234602018Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-iml","depends_on_id":"mala-jnq","type":"parent-child","created_at":"2025-12-26T17:36:15.712687221Z","created_by":"daemon"}]}
{"id":"mala-in2v","title":"[Review] src/orchestration/orchestrator.py:539-544: [P2] Skip finalization but mark completed when run_metadata is None","description":"## Review Finding\n\nThis issue was auto-created from a P2 review finding.\n\n**Source issue:** mala-nsjx\n**Reviewer:** claude\n**Location:** src/orchestration/orchestrator.py:539-544\n\n## Details\n\nWhen `run_metadata is None`, the code skips `_finalize_issue_result` (which closes the issue via `beads.close_async` and emits events) but still calls `mark_completed`. This leaves remediation issues in an inconsistent state: the coordinator considers them complete, but they're never actually closed. While the current call site always passes `run_metadata`, the function signature suggests `None` is valid, and a future caller could trigger this inconsistency. Consider either always finalizing (perhaps with a dummy metadata) or documenting that `run_metadata=None` means \"skip finalization entirely\".","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T02:06:16.018011421Z","created_by":"cyou","updated_at":"2026-01-02T02:14:40.812266823Z","closed_at":"2026-01-02T02:14:40.812266823Z","close_reason":"Closed","labels":["auto_generated","review_finding","review_finding:4cf5a39e065a","source:mala-nsjx"]}
{"id":"mala-iy6l","title":"Epic: Import-linter package restructure (3-phase plan)","description":"Addresses long-term import-linter maintainability with package restructure.\n\n## Context\n\n- Current import-linter config requires manually updating 15+ contracts when adding modules\n- Plan approved (Revision 4) after review\n- Builds on mala-bp3h (immediate contract fixes) with future-proofing work\n- **Decision**: Generator script not needed; contracts updated manually per migration\n\n## Critical Constraint\n\n**NO SHIMS OR RE-EXPORTS**: All migrations must be pure refactors. When moving/renaming modules, update all imports directly. Never create re-export shims or backward-compatibility modules.\n\n## Phases\n\n- ~~**Phase 1**: Generator script~~ (Cancelled - manual updates sufficient)\n- **Phase 2**: Gradual package migration (src/core, src/infra, src/domain, src/orchestration, src/cli)\n- **Phase 3**: Simplify from 15 contracts to 10 cleaner contracts\n\n## Spec\n\nSee: `docs/import-linter-restructure-proposal.md` (Revision 4 - No Shims)\n\n## Scope\n\n**In:**\n- Phase 2a-e: Package migrations + manual contract updates\n- Phase 3: Simplified contracts\n\n**Out:**\n- Generator script (not needed)\n- Backward-compatibility shims (must update imports directly)\n- Behavior changes\n\n## Acceptance Criteria\n\n- [ ] All packages migrated with imports updated directly (no shims)\n- [ ] Contracts updated for each migration\n- [ ] Final state: 10 cleaner contracts passing\n- [ ] All tests pass throughout\n\n## P2 Review Notes (to address in Phase 3)\n\n- Hooks contract should include src.core.models in forbidden list\n- SDK contract should include client wrappers in forbidden list\n- Leaf modules: clarify stdlib-only vs no-src-imports constraint","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-31T22:01:35.965628112Z","created_by":"cyou","updated_at":"2026-01-01T20:51:49.869784692Z","closed_at":"2026-01-01T20:51:49.869784692Z","close_reason":"Closed","labels":["architecture","import-linter refactor"]}
{"id":"mala-iy6l.1","title":"Create import-linter contract generator script","description":"Create scripts/generate_import_contracts.py to automate contract generation.\n\n## Context\n\n- Adding new modules currently requires updating ~5-8 contracts manually\n- Generator script will define module→layer mapping in one place\n- Must handle special constraints (hooks, telemetry, validation.result)\n- Plan reference: Task 1.1 in docs/import-linter-restructure-proposal.md\n\n## Scope\n\n**In:**\n- Create `scripts/generate_import_contracts.py` with LAYER_MAPPING, SPECIAL_CONSTRAINTS, LEAF_MODULES, INDEPENDENCE_CONTRACTS\n- Add script entry to pyproject.toml [project.scripts]\n- Create `scripts/` directory at repo root (NOT src/tools/)\n\n**Out:**\n- CI integration (separate task)\n- Package migrations\n\n## Implementation\n\n```python\nLAYER_MAPPING = {\n    \"cli\": [\"cli\", \"main\"],\n    \"orchestration\": [\"orchestrator\", \"orchestrator_factory\", \"orchestrator_types\", \"cli_support\"],\n    \"pipeline\": [\"pipeline\"],\n    \"domain\": [\"lifecycle\", \"quality_gate\", \"validation\", \"prompts\"],\n    \"infra\": [\n        \"anthropic_client\", \"beads_client\", \"braintrust_integration\", \"cerberus_review\",\n        \"config\", \"event_sink\", \"git_utils\", \"log_output\", \"mcp\",\n        \"session_log_parser\", \"telemetry\", \"tools\", \"epic_verifier\", \"issue_manager\",\n    ],\n    \"core\": [\"models\", \"protocols\", \"log_events\"],\n}\n\nSPECIAL_CONSTRAINTS = {\n    \"hooks\": {\"layer\": \"infra\", \"additional_forbidden\": [\"pipeline\", \"domain\", \"orchestration\"]},\n    \"telemetry\": {\"layer\": \"infra\", \"additional_forbidden\": [\"braintrust_integration\", \"braintrust\"]},\n    \"validation.result\": {\"layer\": \"domain\", \"additional_forbidden\": [\"tools\", \"config\", \"log_output\"]},\n}\n\nLEAF_MODULES = [\"models\", \"protocols\", \"log_events\"]\n\nINDEPENDENCE_CONTRACTS = {\n    \"Pipeline modules acyclic\": [\n        \"src.pipeline.agent_session_runner\",\n        \"src.pipeline.gate_runner\",\n        \"src.pipeline.review_runner\",\n        \"src.pipeline.run_coordinator\",\n    ],\n}\n```\n\n## Acceptance Criteria\n\n- [ ] `scripts/generate_import_contracts.py` generates TOML output matching current 15 contracts\n- [ ] Script can be run standalone: `uv run python scripts/generate_import_contracts.py`\n- [ ] Generated output, when applied, passes `uv run import-linter`\n- [ ] Script handles all current special cases\n\n## Test Plan\n\n1. Run generator, diff output against pyproject.toml contracts section (lines 128-584)\n2. Replace contracts section with generated output, run import-linter (should pass)\n3. Add a test module name to LAYER_MAPPING, verify contract output changes\n\n## Notes\n\n- P2 review feedback: plan's verification diff command is wrong (compares same output twice)\n- Correct approach: diff generated TOML against committed contracts section","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-31T22:01:53.324428964Z","created_by":"cyou","updated_at":"2025-12-31T22:06:14.043370866Z","closed_at":"2025-12-31T22:06:14.043375146Z","labels":["import-linter refactor"],"dependencies":[{"issue_id":"mala-iy6l.1","depends_on_id":"mala-iy6l","type":"parent-child","created_at":"2025-12-31T22:01:53.334145076Z","created_by":"daemon"}]}
{"id":"mala-iy6l.2","title":"Add CI validation for contract generator","description":"Add CI workflow to validate generator output matches committed contracts.\n\n## Context\n\n- Generator script exists but needs enforcement\n- Plan recommends CI validation over pre-commit for visibility\n- CI job should fail if generated contracts differ from committed version\n\n## Scope\n\n**In:**\n- Add CI workflow at `.github/workflows/validate-contracts.yml`\n- Workflow runs generator and diffs against pyproject.toml\n\n**Out:**\n- Pre-commit hook (alternative not chosen)\n- Generator script changes\n\n## Implementation\n\nWorkflow should:\n1. Run `uv run python scripts/generate_import_contracts.py \u003e /tmp/generated.toml`\n2. Extract contracts section from pyproject.toml\n3. Diff generated vs committed\n4. Fail with clear output if different\n\n## Acceptance Criteria\n\n- [ ] CI workflow exists at `.github/workflows/validate-contracts.yml`\n- [ ] Workflow runs on PR and push to main\n- [ ] Workflow fails if generated output differs from pyproject.toml contracts section\n- [ ] Workflow provides clear diff output on failure\n\n## Test Plan\n\n1. Create PR with intentionally wrong contract, verify CI fails\n2. Create PR with correct contracts, verify CI passes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-31T22:02:07.948328124Z","created_by":"cyou","updated_at":"2025-12-31T22:06:14.060873309Z","closed_at":"2025-12-31T22:06:14.060877029Z","labels":["import-linter refactor"],"dependencies":[{"issue_id":"mala-iy6l.2","depends_on_id":"mala-iy6l","type":"parent-child","created_at":"2025-12-31T22:02:07.957899936Z","created_by":"daemon"},{"issue_id":"mala-iy6l.2","depends_on_id":"mala-iy6l.1","type":"blocks","created_at":"2025-12-31T22:03:40.171761845Z","created_by":"daemon"}]}
{"id":"mala-iy6l.3","title":"Create src/core/ package with models, protocols, log_events","description":"First package migration: move leaf modules to src/core/.\n\n## Context\n\n- First step in Phase 2 package migration\n- Move 3 leaf modules to src/core/ package\n- Create shims at old paths for backward compatibility\n- Update contracts in pyproject.toml for new paths\n\n## Scope\n\n**In:**\n- Create src/core/ directory with __init__.py\n- Move models.py, protocols.py, log_events.py to src/core/\n- Create shims at old paths with explicit re-exports\n- Update pyproject.toml contracts to include new paths\n\n**Out:**\n- src/infra, src/domain, src/orchestration, src/cli packages\n\n## Primary Files\n\n- src/core/__init__.py (new)\n- src/core/models.py (moved)\n- src/core/protocols.py (moved)\n- src/core/log_events.py (moved)\n- src/models.py (becomes shim)\n- src/protocols.py (becomes shim)\n- src/log_events.py (becomes shim)\n- pyproject.toml (update contracts)\n\n## Shim Pattern\n\n```python\n# src/models.py (shim)\nfrom src.core.models import (\n    Model1,\n    Model2,\n    ValidationResult,\n    # ... all public exports\n)\n\n__all__ = [\"Model1\", \"Model2\", \"ValidationResult\", ...]\n```\n\n## Contract Updates\n\nUpdate contracts 9-11 (leaf modules) to reference both old and new paths:\n- src.models AND src.core.models\n- src.protocols AND src.core.protocols  \n- src.log_events AND src.core.log_events\n\n## Acceptance Criteria\n\n- [ ] src/core/ package exists with all 3 modules\n- [ ] Old import paths work: `from src.models import X`\n- [ ] New import paths work: `from src.core.models import X`\n- [ ] `uv run import-linter` passes\n- [ ] `uv run pytest -m \"unit or integration\"` passes\n- [ ] `uvx ruff check .` passes\n- [ ] `uv run mala --help` works\n\n## Test Plan\n\n1. Verify old imports: `python -c \"from src.models import *\"`\n2. Verify new imports: `python -c \"from src.core.models import *\"`\n3. Run full test suite\n4. Run import-linter\n\n## Notes\n\n- Use explicit re-exports with __all__, not just star imports\n- Update pyproject.toml contracts to recognize both old and new paths","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-31T22:02:23.228856201Z","created_by":"cyou","updated_at":"2026-01-01T05:52:33.024814188Z","closed_at":"2026-01-01T05:52:33.024814188Z","close_reason":"Closed","labels":["import-linter refactor","package-migration"],"dependencies":[{"issue_id":"mala-iy6l.3","depends_on_id":"mala-iy6l","type":"parent-child","created_at":"2025-12-31T22:02:23.238157925Z","created_by":"daemon"}]}
{"id":"mala-iy6l.4","title":"Create src/infra/ package with clients, io, tools, hooks","description":"Largest migration: move infrastructure modules to src/infra/.\n\n## Context\n\n- Largest migration: 15+ modules moving to src/infra/\n- Includes moving existing packages: tools/, log_output/, hooks/\n- Package shims require __path__ manipulation for sub-module imports\n- Must preserve imports like `from src.tools.locking import FileLock`\n\n## Scope\n\n**In:**\n- Create src/infra/ with clients/, io/ subdirectories\n- Move tools/, log_output/, hooks/ packages with package shims\n- Move standalone infra modules with module shims\n- Update pyproject.toml contracts for new paths\n\n**Out:**\n- Other packages (domain, orchestration, cli)\n\n## Directory Structure\n\n\\`\\`\\`\nsrc/infra/\n├── __init__.py\n├── clients/\n│   ├── __init__.py\n│   ├── anthropic_client.py\n│   ├── beads_client.py\n│   ├── braintrust_integration.py\n│   └── cerberus_review.py\n├── io/\n│   ├── __init__.py\n│   ├── config.py\n│   ├── event_sink.py\n│   ├── log_output/  (moved package)\n│   └── session_log_parser.py\n├── tools/  (moved package)\n├── hooks/  (moved package)\n├── git_utils.py\n├── mcp.py\n├── telemetry.py\n├── epic_verifier.py\n└── issue_manager.py\n\\`\\`\\`\n\n## Package Shim Pattern\n\n\\`\\`\\`python\n# src/tools/__init__.py (shim)\nimport sys\nfrom src.infra.tools import *  # noqa: F401,F403\n\n# Enable sub-module imports: from src.tools.locking import ...\nfrom src.infra import tools as _new_tools\nsys.modules[__name__].__path__ = _new_tools.__path__  # type: ignore[attr-defined]\n\\`\\`\\`\n\n## Acceptance Criteria\n\n- [ ] Directory structure matches plan\n- [ ] All old import paths work via shims\n- [ ] Sub-module imports work: \\`from src.tools.locking import FileLock\\`\n- [ ] \\`uv run import-linter\\` passes (contracts updated)\n- [ ] All tests pass\n\n## Test Plan\n\n1. Test each shim: old path imports still work\n2. Test sub-module imports specifically for tools, log_output, hooks\n3. Run full test suite\n4. Run import-linter\n\n## Notes\n\n- This is the riskiest migration due to package moves\n- Package shims need sys.modules[__name__].__path__ manipulation\n- Update pyproject.toml contracts manually to include both old and new paths","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-31T22:02:43.204743805Z","created_by":"cyou","updated_at":"2026-01-01T06:35:03.738971856Z","closed_at":"2026-01-01T06:35:03.738971856Z","close_reason":"Closed","labels":["import-linter refactor","package-migration"],"dependencies":[{"issue_id":"mala-iy6l.4","depends_on_id":"mala-iy6l","type":"parent-child","created_at":"2025-12-31T22:02:43.216868411Z","created_by":"daemon"},{"issue_id":"mala-iy6l.4","depends_on_id":"mala-iy6l.3","type":"blocks","created_at":"2025-12-31T22:03:40.19424207Z","created_by":"daemon"}]}
{"id":"mala-iy6l.5","title":"Create src/domain/ package with validation, lifecycle, quality_gate, prompts","description":"Move domain modules to src/domain/.\n\n## Context\n\n- Move domain modules to src/domain/\n- validation/ is a package (needs package shim with __path__)\n- prompts.py is a single file (module shim)\n- Note: src/prompts/ directory has markdown templates, separate from prompts.py module\n\n## Scope\n\n**In:**\n- Create src/domain/ directory\n- Move validation/ package with package shim\n- Move lifecycle.py, quality_gate.py, prompts.py with module shims\n- Update pyproject.toml contracts for new paths\n\n**Out:**\n- Other packages (orchestration, cli)\n\n## Directory Structure\n\n\\`\\`\\`\nsrc/domain/\n├── __init__.py\n├── lifecycle.py\n├── quality_gate.py\n├── prompts.py\n└── validation/  (moved package)\n\\`\\`\\`\n\n## Acceptance Criteria\n\n- [ ] All domain modules accessible via both old and new paths\n- [ ] Validation sub-modules work: \\`from src.validation.result import ValidationResult\\`\n- [ ] All tests pass\n- [ ] Import-linter passes (contracts updated)\n\n## Test Plan\n\n1. Test validation sub-module imports\n2. Test all shims\n3. Run full test suite\n4. Run import-linter\n\n## Notes\n\n- prompts.py is a Python file; src/prompts/ is a separate markdown template directory\n- validation/ needs package shim with __path__ manipulation\n- Update pyproject.toml contracts manually","notes":"Quality gate failed: Timeout after 60 minutes\nLog: /home/cyou/.claude/projects/-home-cyou-mala/f161554a-08d4-4534-9f9b-f4ab741c541e.jsonl","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-31T22:02:54.601316286Z","created_by":"cyou","updated_at":"2026-01-01T15:27:37.696747124Z","closed_at":"2026-01-01T15:27:37.696747124Z","close_reason":"Closed","labels":["import-linter refactor","needs-followup","package-migration"],"dependencies":[{"issue_id":"mala-iy6l.5","depends_on_id":"mala-iy6l","type":"parent-child","created_at":"2025-12-31T22:02:54.608001106Z","created_by":"daemon"},{"issue_id":"mala-iy6l.5","depends_on_id":"mala-iy6l.4","type":"blocks","created_at":"2025-12-31T22:03:40.201196518Z","created_by":"daemon"}]}
{"id":"mala-iy6l.6","title":"Create src/orchestration/ package","description":"Move orchestration modules to src/orchestration/.\n\n## Critical Constraint\n\n**NO SHIMS OR RE-EXPORTS**: This is a pure refactor. When moving modules, update all imports directly throughout the codebase. Never create re-export shims or backward-compatibility modules.\n\n## Context\n\n- Move orchestration modules: orchestrator.py, orchestrator_factory.py, orchestrator_types.py, cli_support.py\n- All are single files, move and update all imports\n- Rename to cleaner names in new location\n\n## Scope\n\n**In:**\n- Create src/orchestration/ directory\n- Move 4 modules\n- Update ALL imports throughout codebase to use new paths\n- Update pyproject.toml contracts for new paths\n\n**Out:**\n- Backward-compatibility shims (forbidden)\n- Other packages (cli)\n\n## Directory Structure\n\n```\nsrc/orchestration/\n├── __init__.py\n├── orchestrator.py\n├── factory.py      # from orchestrator_factory.py\n├── types.py        # from orchestrator_types.py\n└── cli_support.py\n```\n\n## File Mapping\n\n- orchestrator.py → src/orchestration/orchestrator.py\n- orchestrator_factory.py → src/orchestration/factory.py\n- orchestrator_types.py → src/orchestration/types.py\n- cli_support.py → src/orchestration/cli_support.py\n\n## Acceptance Criteria\n\n- [ ] Modules moved to new locations\n- [ ] ALL imports updated to new paths (no old imports remain)\n- [ ] No re-export shims created\n- [ ] All tests pass\n- [ ] Import-linter passes (contracts updated)\n\n## Test Plan\n\n1. Move files\n2. Update all imports throughout codebase\n3. Run full test suite\n4. Run import-linter","notes":"Quality gate failed: Quality gate failed: Missing validation evidence for: ruff check, pytest, ruff format, ty check\nLog: /home/cyou/.claude/projects/-home-cyou-mala/bb03c7b1-5f44-479b-87da-8be719812077.jsonl","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-31T22:03:04.832165756Z","created_by":"cyou","updated_at":"2026-01-01T18:26:44.210895969Z","closed_at":"2026-01-01T18:16:50.484650969Z","close_reason":"Closed","labels":["import-linter refactor","needs-followup","package-migration"],"dependencies":[{"issue_id":"mala-iy6l.6","depends_on_id":"mala-iy6l","type":"parent-child","created_at":"2025-12-31T22:03:04.842002757Z","created_by":"daemon"},{"issue_id":"mala-iy6l.6","depends_on_id":"mala-iy6l.5","type":"blocks","created_at":"2025-12-31T22:03:40.208229365Z","created_by":"daemon"}]}
{"id":"mala-iy6l.7","title":"Create src/cli/ package","description":"Final package migration: move CLI modules to src/cli/.\n\n## Critical Constraint\n\n**NO SHIMS OR RE-EXPORTS**: This is a pure refactor. When moving modules, update all imports directly throughout the codebase. Never create re-export shims or backward-compatibility modules.\n\n## Context\n\n- Final package migration: cli.py, main.py\n- Must ensure pyproject.toml entry point still works\n\n## Scope\n\n**In:**\n- Create src/cli/ directory\n- Move cli.py, main.py\n- Update ALL imports throughout codebase to use new paths\n- Update pyproject.toml contracts for new paths\n\n**Out:**\n- Backward-compatibility shims (forbidden)\n\n## Directory Structure\n\n```\nsrc/cli/\n├── __init__.py\n├── main.py\n└── cli.py\n```\n\n## Acceptance Criteria\n\n- [ ] Modules moved to new locations\n- [ ] ALL imports updated to new paths (no old imports remain)\n- [ ] No re-export shims created\n- [ ] `uv run mala` still works (entry point)\n- [ ] All tests pass\n- [ ] Import-linter passes (contracts updated)\n\n## Test Plan\n\n1. Move files\n2. Update all imports throughout codebase\n3. Test CLI entry point: `uv run mala --help`\n4. Run full test suite\n5. Run import-linter\n\n## Notes\n\n- Verify pyproject.toml [project.scripts] entry point still works after migration\n- Update contracts manually in pyproject.toml","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-31T22:03:14.157049026Z","created_by":"cyou","updated_at":"2026-01-01T18:41:32.046128295Z","closed_at":"2026-01-01T18:41:32.046128295Z","close_reason":"Closed","labels":["import-linter refactor","package-migration"],"dependencies":[{"issue_id":"mala-iy6l.7","depends_on_id":"mala-iy6l","type":"parent-child","created_at":"2025-12-31T22:03:14.178547336Z","created_by":"daemon"},{"issue_id":"mala-iy6l.7","depends_on_id":"mala-iy6l.6","type":"blocks","created_at":"2025-12-31T22:03:40.215084774Z","created_by":"daemon"}]}
{"id":"mala-iy6l.8","title":"Implement simplified import-linter contracts (Phase 3)","description":"Replace 15 complex contracts with 10 cleaner ones.\n\n## Critical Constraint\n\n**NO SHIMS OR RE-EXPORTS**: This is a pure refactor. When reorganizing contracts or addressing any module references, update directly. Never create re-export shims or backward-compatibility modules.\n\n## Context\n\n- Final phase: replace 15 contracts with 10 cleaner ones\n- Uses layers contract type for main architecture\n- Preserves special constraints: hooks isolation, telemetry purity, validation.result, leaf modules\n\n## Scope\n\n**In:**\n- Replace current contracts in pyproject.toml with simplified version\n- Address P2 review feedback items\n\n**Out:**\n- Backward-compatibility shims (forbidden)\n- Shim removal (should be none to remove)\n\n## P2 Review Items to Address\n\n1. **Hooks contract**: Add src.core.models to forbidden list (current Contract 7 forbids it)\n2. **SDK contract**: Add src.infra.clients.* to forbidden list (current Contract 5 forbids client wrappers)\n3. **Leaf modules**: Document that constraint is no-src-imports, not stdlib-only\n\n## New Contracts (10 total)\n\n1. Layered Architecture (layers type)\n2. SDK confined to infra\n3. Only CLI imports typer\n4. Pipeline modules acyclic\n5. Hooks isolated\n6. Telemetry abstraction pure\n7. Validation result minimal\n8. Models is leaf\n9. Protocols is leaf\n10. Log events is leaf\n\nSee plan Task 3.1 in docs/import-linter-restructure-proposal.md for exact TOML definitions.\n\n## Acceptance Criteria\n\n- [ ] pyproject.toml has exactly 10 contracts as specified\n- [ ] No re-export shims exist in codebase\n- [ ] All contracts pass: `uv run import-linter`\n- [ ] All tests pass\n- [ ] Review feedback addressed in contract definitions\n\n## Test Plan\n\n1. Run import-linter with new contracts\n2. Run full test suite\n3. Verify all preserved constraints are still enforced","notes":"Quality gate failed: Quality gate failed: Missing validation evidence for: ruff check, pytest, ruff format, ty check\nLog: /home/cyou/.claude/projects/-home-cyou-mala/bf08c1ca-a65d-4a9d-8558-bcea79c6bd00.jsonl","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-31T22:03:31.718837326Z","created_by":"cyou","updated_at":"2026-01-01T18:50:06.624614071Z","closed_at":"2026-01-01T18:47:30.097302472Z","close_reason":"Closed","labels":["import-linter refactor","needs-followup"],"dependencies":[{"issue_id":"mala-iy6l.8","depends_on_id":"mala-iy6l","type":"parent-child","created_at":"2025-12-31T22:03:31.728513748Z","created_by":"daemon"},{"issue_id":"mala-iy6l.8","depends_on_id":"mala-iy6l.7","type":"blocks","created_at":"2025-12-31T22:03:40.221904062Z","created_by":"daemon"}]}
{"id":"mala-iy6l.9","title":"[Remediation] All packages migrated with imports updated directly (no shim...","description":"## Context\nThis issue was auto-created by epic verification for epic `mala-iy6l`.\n\n## Epic Description / Acceptance Criteria\nTitle: Epic: Import-linter package restructure (3-phase plan)\n\nAddresses long-term import-linter maintainability with package restructure.\n\n## Context\n\n- Current import-linter config requires manually updating 15+ contracts when adding modules\n- Plan approved (Revision 4) after review\n- Builds on mala-bp3h (immediate contract fixes) with future-proofing work\n- **Decision**: Generator script not needed; contracts updated manually per migration\n\n## Critical Constraint\n\n**NO SHIMS OR RE-EXPORTS**: All migrations must be pure refactors. When moving/renaming modules, update all imports directly. Never create re-export shims or backward-compatibility modules.\n\n## Phases\n\n- ~~**Phase 1**: Generator script~~ (Cancelled - manual updates sufficient)\n- **Phase 2**: Gradual package migration (src/core, src/infra, src/domain, src/orchestration, src/cli)\n- **Phase 3**: Simplify from 15 contracts to 10 cleaner contracts\n\n## Spec\n\nSee: `docs/import-linter-restructure-proposal.md` (Revision 4 - No Shims)\n\n## Scope\n\n**In:**\n- Phase 2a-e: Package migrations + manual contract updates\n- Phase 3: Simplified contracts\n\n**Out:**\n- Generator script (not needed)\n- Backward-compatibility shims (must update imports directly)\n- Behavior changes\n\n## Acceptance Criteria\n\n- [ ] All packages migrated with imports updated directly (no shims)\n- [ ] Contracts updated for each migration\n- [ ] Final state: 10 cleaner contracts passing\n- [ ] All tests pass throughout\n\n## P2 Review Notes (to address in Phase 3)\n\n- Hooks contract should include src.core.models in forbidden list\n- SDK contract should include client wrappers in forbidden list\n- Leaf modules: clarify stdlib-only vs no-src-imports constraint\n\n## Commit Scope\n- Range hint: 4e0c3d3958dcfc6fe5b1341d71a0b2bd6f948baf^..bb7a40c57b258176f7354ce933cfbb3a0c20317c\n- Commits:\n- 4e0c3d3958dcfc6fe5b1341d71a0b2bd6f948baf bd-mala-iy6l.3: Create src/core/ package with models, protocols, log_events\n- b4e8b3071b091e3bddf3646c4a6e2ed3cf5dd9ef bd-mala-iy6l.5: Create src/domain/ package __init__.py\n- 6b50079962521f7668dab18dffd275cb49971fa5 bd-mala-iy6l.5: Create shims and update contracts for src/domain/ migration\n- fef27796b613bf87848b121fd228b2aaf298610a bd-mala-iy6l.4: Address final review findings\n- f965433ad4ce8d9496cb4824520a77b73d7ffee8 bd-mala-iy6l.4: Fix review issues from external reviewers\n- 7eeb9cf101f3b17d93dd1ceacb06b724f33f6dc4 bd-mala-iy6l.4: Create src/infra/ package with clients/, io/, tools/, hooks/\n- 560ad04fed162117b1eb5dd6ba339e2672dfb7bd bd-mala-iy6l.7: Create src/cli/ package\n- bb7a40c57b258176f7354ce933cfbb3a0c20317c bd-mala-iy6l.8: Simplify import-linter to 10 contracts\n- e748c9afd3597aea091204f71606db2c1627f3f5 bd-mala-iy6l.6: Fix code formatting across codebase\n- aed236d440a7917b7b433342bf38bf299d4b6ea1 bd-mala-iy6l.6: Replace shim imports with direct paths in orchestration modules\n- 2e6b5ef1dafb2ed3f82dda977844e6964f1fbe78 bd-mala-iy6l.6: Migrate orchestration modules to src/orchestration/ package\n\n## Child Issues\n- mala-iy6l.1\n- mala-iy6l.2\n- mala-iy6l.3\n- mala-iy6l.4\n- mala-iy6l.5\n- mala-iy6l.6\n- mala-iy6l.7\n- mala-iy6l.8\n\n## Unmet Criterion\nAll packages migrated with imports updated directly (no shims)\n\n## Evidence\n15 backward-compatibility shim files remain in src/ root (models.py, protocols.py, log_events.py, config.py, etc.) that explicitly re-export from new package locations. These files contain comments like 'Backward-compatibility shim' and use 'from src.core.models import ...' patterns. The critical constraint explicitly states 'NO SHIMS OR RE-EXPORTS: All migrations must be pure refactors'.\n\n## Priority\nP0 (blocking)\n\n## Resolution\nAddress this criterion to unblock epic closure. When complete, close this issue.\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-01T19:22:13.821877296Z","created_by":"cyou","updated_at":"2026-01-01T20:26:06.147707491Z","closed_at":"2026-01-01T20:26:06.147707491Z","close_reason":"Closed","labels":["auto_generated","epic_remediation:mala-iy6l:4c7b64509fd64b98f0a453db9ca9d67a3a0f04c08553b06efd0d54a71fa4eb49"],"dependencies":[{"issue_id":"mala-iy6l.9","depends_on_id":"mala-iy6l","type":"parent-child","created_at":"2026-01-01T19:22:13.822398325Z","created_by":"daemon"}]}
{"id":"mala-izlr","title":"remove mcp tool guidance from implementer prompt if morph is not there -- more genearlly, it the implementer prompt should not talk about tools at all, that should be a modular prompt according to what mcp tools are enabled","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T17:01:09.593285174Z","created_by":"cyou","updated_at":"2026-01-01T22:27:24.044718986Z","closed_at":"2026-01-01T22:27:24.044718986Z","close_reason":"Closed"}
{"id":"mala-j6p","title":"Refactor validation module into package scaffolding","description":"Context:\n- Existing src/validation.py conflicts with the new validation package layout.\n- Plan introduces src/validation/ modules that must coexist cleanly.\n\nScope:\n- In: refactor src/validation.py into a package scaffold; move existing runner logic into src/validation/runner.py; add src/validation/__init__.py to preserve public imports.\n- Out: new spec/coverage/e2e logic (separate tasks).\n\nAcceptance Criteria:\n- src/validation becomes a package without import conflicts.\n- Existing ValidationRunner behavior preserved via the new module location.\n- Public imports continue to work (no breakage in current callers).\n\nTest Plan:\n- Add/adjust unit tests for validation module import path (if tests exist).\n- Run targeted tests that currently touch validation.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T23:00:01.641185848Z","updated_at":"2025-12-26T23:34:56.985031159Z","closed_at":"2025-12-26T23:34:56.985031159Z","close_reason":"Closed"}
{"id":"mala-j8fj","title":"Allow users to configure setting_sources (project/user)","description":"Currently mala hardcodes setting_sources=['project', 'user'] in agent_session_runner.py, run_coordinator.py, and epic_verifier.py. Add CLI flag or config option to let users choose which sources to load (e.g., --no-user-settings to skip ~/.claude/CLAUDE.md).","notes":"Blocked: No clear use case yet. Low priority backlog item.","status":"blocked","priority":3,"issue_type":"feature","created_at":"2026-01-01T15:42:05.756197309Z","created_by":"cyou","updated_at":"2026-01-01T15:42:12.73024365Z"}
{"id":"mala-jef","title":"Orchestrator: wire focus parameter through to BeadsClient","description":"Context:\n- Orchestrator receives config from CLI and passes to BeadsClient\n- Need to thread `focus` parameter through `MalaOrchestrator.__init__` and `run` method\n\nScope:\n- In: Add `focus` parameter to `MalaOrchestrator.__init__`\n- In: Pass `focus` to `beads.get_ready_async` calls in orchestrator\n- Out: CLI changes (done in previous issue), beads_client changes (done earlier)\n\nAcceptance Criteria:\n- `MalaOrchestrator` accepts `focus` parameter\n- Parameter passed correctly to all `get_ready_async` calls\n- Default behavior is focus mode enabled\n\nTest Plan:\n- Unit test orchestrator initialization with focus parameter\n- Integration test end-to-end with `--focus` and `--no-focus`\n- Run `uv run pytest tests/test_orchestrator.py`\n\nNotes for Agent:\n- Check all call sites of `get_ready_async` in orchestrator\n- Ensure consistency with existing parameter threading pattern (like `prioritize_wip`)\n\nPrimary files: src/orchestrator.py","status":"tombstone","priority":1,"issue_type":"task","created_at":"2025-12-27T18:14:59.07845602Z","updated_at":"2025-12-27T18:19:15.446361247Z","dependencies":[{"issue_id":"mala-jef","depends_on_id":"mala-g3h","type":"blocks","created_at":"2025-12-27T18:18:55.856283612Z","created_by":"daemon"}],"deleted_at":"2025-12-27T18:19:15.446361247Z","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"mala-jen9","title":"Epic: Idle Timeout Retry/Recovery","description":"Agent sessions hang indefinitely when Claude CLI subprocess stops producing output but stays alive. Observed in run bd0a654e session 90f81fe7 - subprocess in ep_poll state.\n\nCurrent idle timeout detection works, but subprocess is not terminated and no retry happens.\n\n## Plan\nSee: docs/2025-12-31-idle-timeout-retry-plan.md\n\n## Goals\n- Add retry/recovery logic for idle timeout with disconnect, backoff, and resume\n- Terminate subprocess via disconnect() when idle timeout fires\n- Retry up to 2 times with backoff (0s, 5s, 15s)\n- First-turn hangs with no side effects start fresh; with side effects fail fast\n\n## Non-Goals\n- SDK changes\n- Lifecycle state machine changes\n- CLI config exposure\n\n## Acceptance Criteria\n- All child issues completed\n- Idle timeout triggers subprocess termination via disconnect()\n- Sessions retry up to 2 times with backoff\n- Side effect detection prevents unsafe retries","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-01-01T02:00:13.507596138Z","created_by":"cyou","updated_at":"2026-01-01T06:53:04.632701289Z","closed_at":"2026-01-01T06:53:04.632701289Z","close_reason":"Closed","labels":["subprocess"]}
{"id":"mala-jen9.1","title":"Add disconnect() to SDKClientProtocol","description":"## Context\n- SDKClientProtocol (lines 80-117) defines the interface for SDK clients\n- Need to add disconnect() method for subprocess termination\n- SDK's ClaudeSDKClient.disconnect() already exists (verified at client.py:362)\n- Signature: async def disconnect(self) -\u003e None\n\n## Scope\n**In:** Add disconnect() method to SDKClientProtocol\n**Out:** Implementation logic, test fakes\n\n## Primary Files\n- src/pipeline/agent_session_runner.py\n\n## Acceptance Criteria\n- Protocol has async def disconnect(self) -\u003e None method with docstring\n- Type check passes (uvx ty check)\n\n## Test Plan\n- Run type checker to verify protocol is valid\n\n## Notes for Agent\n- This is a Protocol class, just add the method signature with ...\n- Keep docstring minimal","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-01T02:00:30.025992737Z","created_by":"cyou","updated_at":"2026-01-01T02:02:14.281955993Z","closed_at":"2026-01-01T02:02:14.281955993Z","close_reason":"wontfix","dependencies":[{"issue_id":"mala-jen9.1","depends_on_id":"mala-jen9","type":"parent-child","created_at":"2026-01-01T02:00:30.033816795Z","created_by":"daemon"}]}
{"id":"mala-jen9.2","title":"Add idle retry config options","description":"## Context\n- AgentSessionConfig dataclass (lines 159-188) holds session configuration\n- Need to add max_idle_retries and idle_retry_backoff fields\n- Config is internal-only, not exposed to CLI\n\n## Scope\n**In:** Add two config fields to AgentSessionConfig\n**Out:** CLI exposure, env var support\n\n## Primary Files\n- src/pipeline/agent_session_runner.py\n\n## Dependencies\n- Blocked by: mala-jen9.1 (protocol update, same file)\n\n## Acceptance Criteria\n- max_idle_retries: int = 2 field added\n- idle_retry_backoff: tuple[float, ...] = (0.0, 5.0, 15.0) field added\n- Type check passes\n\n## Test Plan\n- Verify config can be instantiated with defaults\n- Verify custom values can be set\n\n## Notes for Agent\n- Add fields after existing config fields (after line 188)\n- Internal-only: no CLI/env var plumbing needed\n- Backoff semantics: idle_retry_count tracks retries that occurred\n  - idle_retry_count = 0: First attempt (not a retry), no backoff\n  - idle_retry_count = 1: First retry, backoff index 0 → 0s\n  - idle_retry_count = 2: Second retry, backoff index 1 → 5s","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-01T02:00:41.132532778Z","created_by":"cyou","updated_at":"2026-01-01T02:02:14.274646716Z","closed_at":"2026-01-01T02:02:14.274646716Z","close_reason":"wontfix","dependencies":[{"issue_id":"mala-jen9.2","depends_on_id":"mala-jen9","type":"parent-child","created_at":"2026-01-01T02:00:41.140548555Z","created_by":"daemon"},{"issue_id":"mala-jen9.2","depends_on_id":"mala-jen9.1","type":"blocks","created_at":"2026-01-01T02:00:45.694181458Z","created_by":"daemon"}]}
{"id":"mala-jen9.3","title":"Add idle resume prompt file","description":"## Context\n- Other prompts use markdown files in src/prompts/ loaded via @functools.cache\n- Need minimal resume prompt for session continuation after idle timeout\n- Existing pattern: _PROMPT_DIR at line 65, _get_gate_followup_prompt() at line 69\n\n## Scope\n**In:** Create src/prompts/idle_resume.md with minimal content\n**Out:** Complex prompt content\n\n## Primary Files\n- src/prompts/idle_resume.md (new file)\n\n## Acceptance Criteria\n- File exists at src/prompts/idle_resume.md\n- Content is exactly: Continue on issue {issue_id}.\n- File is tracked by git (not ignored)\n\n## Test Plan\n- Verify file exists and is loadable\n- Verify {issue_id} placeholder works with .format()\n\n## Notes for Agent\n- Keep prompt minimal - SDK loads full context via session_id\n- Single line is sufficient\n- No trailing newline needed","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T02:00:56.272999259Z","created_by":"cyou","updated_at":"2026-01-01T02:02:14.26655582Z","closed_at":"2026-01-01T02:02:14.26655582Z","close_reason":"wontfix","dependencies":[{"issue_id":"mala-jen9.3","depends_on_id":"mala-jen9","type":"parent-child","created_at":"2026-01-01T02:00:56.279893944Z","created_by":"daemon"}]}
{"id":"mala-jen9.4","title":"Add disconnect() to FakeSDKClient and SequencedFactory","description":"## Context\n- FakeSDKClient, HangingSDKClient, SlowSDKClient used in tests\n- Need disconnect() method to satisfy updated protocol\n- Need SequencedSDKClientFactory for retry tests (returns different clients per call)\n\n## Scope\n**In:** Add disconnect() to fake clients; add SequencedSDKClientFactory\n**Out:** Retry logic tests (separate issue)\n\n## Primary Files\n- tests/test_agent_session_runner.py\n\n## Dependencies\n- Blocked by: mala-jen9.1 (protocol must be defined first)\n\n## Acceptance Criteria\n- FakeSDKClient has disconnect() method with disconnect_called flag and disconnect_delay for testing\n- HangingSDKClient and SlowSDKClient inherit disconnect() from parent\n- SequencedSDKClientFactory returns different clients per create() call\n- Protocol conformance check passes\n\n## Test Plan\n- Verify fake clients satisfy SDKClientProtocol\n- Verify SequencedSDKClientFactory returns clients in sequence\n\n## Notes for Agent\n- Add to FakeSDKClient.__init__: self.disconnect_called = False, self.disconnect_delay: float = 0\n- disconnect() implementation:\n  ```python\n  async def disconnect(self) -\u003e None:\n      if self.disconnect_delay \u003e 0:\n          await asyncio.sleep(self.disconnect_delay)\n      self.disconnect_called = True\n  ```\n- SequencedSDKClientFactory takes list of clients, returns them in order via _index counter","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-01T02:01:07.927359787Z","created_by":"cyou","updated_at":"2026-01-01T02:02:14.259368021Z","closed_at":"2026-01-01T02:02:14.259368021Z","close_reason":"wontfix","dependencies":[{"issue_id":"mala-jen9.4","depends_on_id":"mala-jen9","type":"parent-child","created_at":"2026-01-01T02:01:07.934337422Z","created_by":"daemon"},{"issue_id":"mala-jen9.4","depends_on_id":"mala-jen9.1","type":"blocks","created_at":"2026-01-01T02:01:12.815424162Z","created_by":"daemon"}]}
{"id":"mala-jen9.5","title":"Implement idle timeout retry logic","description":"## Context\n- Current code (lines 460-829) creates one client for entire session\n- Need to restructure: client creation inside loop with retry on idle timeout\n- Key: only query when pending_query is set; clear after success\n- Track tool_calls_this_turn for side effect detection\n- Plan: docs/2025-12-31-idle-timeout-retry-plan.md Task 3\n\n## Scope\n**In:** Restructure run_session() with retry wrapper around query+message iteration\n**Out:** Test implementation (separate issue)\n\n## Primary Files\n- src/pipeline/agent_session_runner.py\n\n## Dependencies\n- Blocked by: mala-jen9.2 (config must be added first, same file)\n- Blocked by: mala-jen9.3 (prompt file must exist)\n\n## Acceptance Criteria\n- pending_query: str | None tracks when query is needed (None = skip query block)\n- pending_query cleared after successful iteration\n- client.disconnect() called BEFORE retry limit check on idle timeout\n- If no session_id AND tool calls occurred, fail fast with clear error\n- If no session_id AND no tool calls, retry with original prompt (fresh session)\n- If session_id exists, retry with resume prompt\n- Backoff uses idle_retry_backoff[min(attempt - 1, len(...) - 1)]\n- Uses DISCONNECT_TIMEOUT = 10.0 seconds\n\n## Test Plan\n- Covered by separate test issue (mala-jen9.6)\n- Manual: type check passes, no regressions in existing tests\n\n## Notes for Agent\n- Add IDLE_RESUME_PROMPT_FILE = _PROMPT_DIR / \"idle_resume.md\" constant near line 66\n- Add _get_idle_resume_prompt() with @functools.cache (functools already imported at line 21)\n- Add DISCONNECT_TIMEOUT = 10.0 constant\n- IdleTimeoutError already exists at line 75-76, don't redefine\n- Uses Effect.SEND_GATE_RETRY style (line 641)\n- Query block gated by: if pending_query is not None:\n- Track tool_calls_this_turn: int = 0, increment on ToolUseBlock\n- Resume prompt format: _get_idle_resume_prompt().format(issue_id=input.issue_id)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-01T02:01:33.341429994Z","created_by":"cyou","updated_at":"2026-01-01T02:02:14.244987263Z","closed_at":"2026-01-01T02:02:14.244987263Z","close_reason":"wontfix","dependencies":[{"issue_id":"mala-jen9.5","depends_on_id":"mala-jen9","type":"parent-child","created_at":"2026-01-01T02:01:33.348817916Z","created_by":"daemon"},{"issue_id":"mala-jen9.5","depends_on_id":"mala-jen9.2","type":"blocks","created_at":"2026-01-01T02:01:38.084537427Z","created_by":"daemon"},{"issue_id":"mala-jen9.5","depends_on_id":"mala-jen9.3","type":"blocks","created_at":"2026-01-01T02:01:38.0987557Z","created_by":"daemon"}]}
{"id":"mala-jen9.6","title":"Add unit tests for idle timeout retry","description":"## Context\n- Need 7 test cases covering retry success, failure, side effects, backoff\n- Use short idle_timeout_seconds (0.01s) to trigger timeout quickly\n- Mock asyncio.sleep for backoff, NOT asyncio.wait_for\n- Use SequencedSDKClientFactory for retry scenarios\n\n## Scope\n**In:** Add 7 unit tests for idle timeout retry behavior\n**Out:** Integration tests, e2e tests\n\n## Primary Files\n- tests/test_agent_session_runner.py\n\n## Dependencies\n- Blocked by: mala-jen9.5 (retry logic must be implemented)\n- Blocked by: mala-jen9.4 (test fakes must have disconnect())\n\n## Acceptance Criteria\nAll tests marked with @pytest.mark.unit:\n1. test_idle_timeout_retries_and_recovers: hang once then succeed\n2. test_idle_timeout_gives_up_after_max_retries: disconnect called on all clients\n3. test_idle_timeout_always_disconnects_even_on_final_failure\n4. test_idle_timeout_first_turn_no_side_effects_starts_fresh: uses original prompt\n5. test_idle_timeout_first_turn_with_tool_calls_fails_fast: error message mentions tool calls\n6. test_idle_timeout_non_query_phases_skip_query_block: no client created when pending_query is None\n7. test_idle_timeout_backoff_delays: verify 0s, 5s delays\n\n## Test Plan\n- Run: uv run pytest tests/test_agent_session_runner.py -k idle_timeout -v -m unit\n- All tests pass\n\n## Notes for Agent\n- Use mocker.patch(\"asyncio.sleep\", return_value=None) for backoff\n- HangingSDKClient should yield session_id in ResultMessage before hanging for some tests\n- Config: max_idle_retries=2, idle_timeout_seconds=0.01\n- For test 4/5: Create HangingClient that yields ToolUseBlock before hanging\n- For test 6: Set pending_query=None and verify no client.query() call","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-01T02:01:53.939415875Z","created_by":"cyou","updated_at":"2026-01-01T02:02:08.146121928Z","closed_at":"2026-01-01T02:02:08.146121928Z","close_reason":"wontfix","dependencies":[{"issue_id":"mala-jen9.6","depends_on_id":"mala-jen9","type":"parent-child","created_at":"2026-01-01T02:01:53.946296876Z","created_by":"daemon"},{"issue_id":"mala-jen9.6","depends_on_id":"mala-jen9.5","type":"blocks","created_at":"2026-01-01T02:01:59.287460861Z","created_by":"daemon"},{"issue_id":"mala-jen9.6","depends_on_id":"mala-jen9.4","type":"blocks","created_at":"2026-01-01T02:01:59.30081801Z","created_by":"daemon"}]}
{"id":"mala-jen9.7","title":"Idle timeout retry: protocol, config, prompt, and core logic","description":"## Context\nAgent sessions hang indefinitely when Claude CLI subprocess stops producing output. Current idle timeout detection works, but subprocess is not terminated and no retry happens.\n\nPlan: docs/2025-12-31-idle-timeout-retry-plan.md (Tasks 1-4 combined)\n\n## Scope\n**In:** \n- Add disconnect() to SDKClientProtocol (lines 80-117)\n- Add max_idle_retries and idle_retry_backoff to AgentSessionConfig (after line 188)\n- Create src/prompts/idle_resume.md with minimal content: \"Continue on issue {issue_id}.\"\n- Implement retry logic in run_session() (restructure lines 460-829)\n\n**Out:** Test fakes, unit tests (separate issue)\n\n## Primary Files\n- src/pipeline/agent_session_runner.py\n- src/prompts/idle_resume.md (new)\n\n## Acceptance Criteria\n1. Protocol: async def disconnect(self) -\u003e None added to SDKClientProtocol\n2. Config: max_idle_retries: int = 2 and idle_retry_backoff: tuple[float, ...] = (0.0, 5.0, 15.0)\n3. Prompt file: src/prompts/idle_resume.md exists with \"Continue on issue {issue_id}.\"\n4. Logic:\n   - pending_query: str | None tracks when query is needed\n   - pending_query cleared after successful iteration  \n   - client.disconnect() called BEFORE retry limit check\n   - If no session_id AND tool calls occurred: fail fast\n   - If no session_id AND no tool calls: retry with original prompt\n   - If session_id exists: retry with resume prompt\n   - Backoff: idle_retry_backoff[min(attempt - 1, len(...) - 1)]\n   - DISCONNECT_TIMEOUT = 10.0 seconds\n\n## Test Plan\n- Type check passes: uvx ty check\n- Existing tests still pass\n- Manual verification of code structure\n\n## Notes for Agent\n- IdleTimeoutError already exists at line 75-76\n- functools already imported at line 21\n- _PROMPT_DIR already exists at line 65\n- Uses Effect.SEND_GATE_RETRY style (line 641)\n- Track tool_calls_this_turn: int for side effect detection\n- Add _get_idle_resume_prompt() with @functools.cache","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-01T02:02:35.599741456Z","created_by":"cyou","updated_at":"2026-01-01T06:43:11.222712354Z","closed_at":"2026-01-01T06:43:11.222712354Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-jen9.7","depends_on_id":"mala-jen9","type":"parent-child","created_at":"2026-01-01T02:02:35.607276252Z","created_by":"daemon"}]}
{"id":"mala-jen9.8","title":"Idle timeout retry: test fakes and unit tests","description":"## Context\nNeed test infrastructure and unit tests for idle timeout retry feature.\n\nPlan: docs/2025-12-31-idle-timeout-retry-plan.md (Tasks 5-6 combined)\n\n## Scope\n**In:**\n- Add disconnect() to FakeSDKClient with disconnect_called flag and disconnect_delay\n- Add SequencedSDKClientFactory for retry tests\n- Add 7 unit tests for idle timeout retry behavior\n\n**Out:** Integration tests, e2e tests\n\n## Primary Files\n- tests/test_agent_session_runner.py\n\n## Dependencies\n- Blocked by: mala-jen9.7 (core logic must be implemented first)\n\n## Acceptance Criteria\n\n### Test Fakes\n- FakeSDKClient has disconnect() with disconnect_called=False and disconnect_delay=0\n- HangingSDKClient and SlowSDKClient inherit disconnect()\n- SequencedSDKClientFactory returns different clients per create() call\n\n### Unit Tests (all @pytest.mark.unit)\n1. test_idle_timeout_retries_and_recovers: hang once then succeed\n2. test_idle_timeout_gives_up_after_max_retries: disconnect on all clients\n3. test_idle_timeout_always_disconnects_even_on_final_failure\n4. test_idle_timeout_first_turn_no_side_effects_starts_fresh\n5. test_idle_timeout_first_turn_with_tool_calls_fails_fast\n6. test_idle_timeout_non_query_phases_skip_query_block\n7. test_idle_timeout_backoff_delays: verify 0s, 5s delays\n\n## Test Plan\n- Run: uv run pytest tests/test_agent_session_runner.py -k idle_timeout -v -m unit\n- All tests pass\n\n## Notes for Agent\n- Mock asyncio.sleep for backoff, NOT asyncio.wait_for\n- Use idle_timeout_seconds=0.01 to trigger quickly\n- Config: max_idle_retries=2\n- SequencedSDKClientFactory: takes list, returns in order via _index\n- For side effect tests: HangingClient yields ToolUseBlock before hanging","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-01T02:02:52.496655819Z","created_by":"cyou","updated_at":"2026-01-01T06:51:22.288298992Z","closed_at":"2026-01-01T06:51:22.288298992Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-jen9.8","depends_on_id":"mala-jen9","type":"parent-child","created_at":"2026-01-01T02:02:52.503345548Z","created_by":"daemon"},{"issue_id":"mala-jen9.8","depends_on_id":"mala-jen9.7","type":"blocks","created_at":"2026-01-01T02:02:56.667929156Z","created_by":"daemon"}]}
{"id":"mala-jgcy","title":"Epic verifier: Replace fragile JSON extraction regex with robust parser","description":"## Context\n\nThe epic verification feature uses a regex to extract JSON from model responses:\n```python\nr\"```(?:json)?\\s*(\\{.*\\})\\s*```\"\n```\n\nThis greedy regex with `re.DOTALL` can fail if the response contains multiple code blocks, as it will match across blocks and include markdown fences in the capture group, causing `json.loads()` to fail.\n\n## Problem\n\n- Fragile extraction that breaks on multi-block responses\n- Causes verification failures to fall back to human review unnecessarily\n\n## Proposed Solution\n\nReplace the regex-based extraction with a more robust approach:\n1. Use a dedicated markdown code block parser\n2. Or extract the first/last code block specifically\n3. Or use structured output from the model (JSON mode)\n\n## Acceptance Criteria\n\n- [ ] JSON extraction handles responses with multiple code blocks\n- [ ] Parsing failures are reduced/eliminated for well-formed model responses\n- [ ] Tests cover edge cases (multiple blocks, no blocks, malformed JSON)\n\n## References\n\n- File: `src/epic_verifier.py` line ~230 (`_parse_verdict` method)\n- From code review iteration 3","notes":"Quality gate failed: Timeout after 60 minutes\nLog: /home/cyou/.claude/projects/-home-cyou-mala/1c7d0fc0-0854-45fa-b71c-2b9e6b2e4497.jsonl","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-30T15:50:08.013953662Z","created_by":"cyou","updated_at":"2025-12-30T20:25:25.508064696Z","closed_at":"2025-12-30T20:25:25.508064696Z","close_reason":"Closed","labels":["needs-followup"]}
{"id":"mala-jnah","title":"add mode for non-epic issues only","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T20:26:48.588294678Z","created_by":"cyou","updated_at":"2026-01-01T23:18:02.882214387Z","closed_at":"2026-01-01T23:18:02.882214387Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-jnah","depends_on_id":"mala-dhry","type":"blocks","created_at":"2026-01-01T21:29:39.214812809Z","created_by":"daemon"}]}
{"id":"mala-jnq","title":"Epic: Code health fixes from review","description":"Goal: address high/medium issues from the code health review with minimal overlap and clear dependencies.\n\\nScope:\n- Focus on lock enforcement correctness, build packaging, Braintrust config order, quality gate robustness, async bd calls, agent loop consolidation, and repo hygiene.\n- Out: feature work or architecture redesign beyond the listed fixes.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-26T17:35:14.749720136Z","updated_at":"2025-12-26T19:32:39.518659356Z","closed_at":"2025-12-26T19:32:39.518659356Z","close_reason":"All children completed"}
{"id":"mala-jxc","title":"Enforce lock ownership in PreToolUse","description":"Context:\n- Track A2 requires a PreToolUse hook that blocks file writes unless the agent holds the lock (docs/coordination-plan-codex.md:30-32).\n- hooks currently only block dangerous commands and Morph tool usage (src/hooks.py:37-86).\n- Orchestrator registers PreToolUse hooks in run_implementer (src/orchestrator.py:145-155).\n\nScope:\n- In: add a new PreToolUse hook to detect file-write tool calls and verify lock ownership via locking helpers.\n- In: register the new hook in the orchestrator PreToolUse hook list.\n- Out: no changes to lock key generation or prompt content.\n\nAcceptance Criteria:\n- File-write tool uses are blocked when the agent does not hold the lock; allowed when it does.\n- Block reason includes the file path and current lock holder when available.\n- Orchestrator includes the new hook in PreToolUse.\n\nTest Plan:\n- TDD: add failing unit tests for hook behavior with and without locks.\n- Implement hook, update tests to pass.\n- Run uv run pytest for the new/updated hook tests.\n\nNotes for Agent:\n- Confirm tool input shapes for file paths and which tools count as writes (needs verification).","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T16:43:36.955166144Z","updated_at":"2025-12-26T17:01:31.441554529Z","closed_at":"2025-12-26T17:01:31.441554529Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-jxc","depends_on_id":"mala-4w7","type":"parent-child","created_at":"2025-12-26T16:47:52.974558844Z","created_by":"daemon"}]}
{"id":"mala-kpf","title":"Clean up file_lock shim / align lock owner format","description":"Problem: src/tools/locking.py:file_lock writes PID into lock files and src/filelock.py re-exports it, but the rest of the system uses AGENT_ID in lock files. file_lock is unused and inconsistent.\\n\\nScope/files: src/tools/locking.py, src/filelock.py (and possibly tests).\\n\\nOptions:\\n- Remove file_lock and filelock.py entirely, or\\n- Rework file_lock to use the same AGENT_ID scheme and lock keying as the scripts.\\n\\nAcceptance criteria:\\n- No dead/unused locking API left behind.\\n- If kept, file_lock uses the same lock format + keying as scripts.\\n- Tests updated if necessary.\\n\\nDependency: Must wait for lock-key hashing change (mala-4ls) because both edit src/tools/locking.py.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T21:38:08.362262314Z","updated_at":"2025-12-26T00:04:34.226695444Z","closed_at":"2025-12-26T00:04:34.226695444Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-kpf","depends_on_id":"mala-4ls","type":"blocks","created_at":"2025-12-25T21:38:46.924557872Z","created_by":"daemon"}]}
{"id":"mala-kru2","title":"[Review] docs/configuration.md:23-26: [P3] Document MALA_DISABLE_DEBUG_LOG environment variable","description":"## Review Finding\n\nThis issue was auto-created from a P3 review finding.\n\n**Source issue:** mala-dhry\n**Reviewer:** gemini\n**Location:** docs/configuration.md:23-26\n\n## Details\n\nThe commit introduces `MALA_DISABLE_DEBUG_LOG=1` as a way to opt-out of debug logging, but this is not documented in `docs/configuration.md`. Since the `--debug-log` flag was removed, users should be informed of this alternative if they need to disable logging (e.g., for performance or disk space reasons).","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-01T22:54:29.975650017Z","created_by":"cyou","updated_at":"2026-01-02T01:57:41.032265175Z","closed_at":"2026-01-02T01:57:41.032265175Z","close_reason":"Closed","labels":["auto_generated","review_finding","review_finding:2398d9698d71","source:mala-dhry"],"dependencies":[{"issue_id":"mala-kru2","depends_on_id":"mala-cw6h","type":"blocks","created_at":"2026-01-01T23:33:53.667297762Z","created_by":"daemon"}]}
{"id":"mala-ksai","title":"[Review] src/orchestration/orchestrator.py:453-454: [P3] Fragile `__init__` delegation using `__dict__.update`","description":"## Review Finding\n\nThis issue was auto-created from a P3 review finding.\n\n**Source issue:** mala-cavk.3\n**Reviewer:** gemini\n**Location:** src/orchestration/orchestrator.py:453-454\n\n## Details\n\nThe legacy `__init__` path uses `self.__dict__.update(temp.__dict__)` to copy attributes from an instance created by the factory. This pattern is fragile as it bypasses any potential property setters or complex initialization logic that might be expected in future refactors.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-01T22:23:07.464627725Z","created_by":"cyou","updated_at":"2026-01-02T00:47:57.596972307Z","closed_at":"2026-01-02T00:47:57.596972307Z","close_reason":"Closed","labels":["auto_generated","review_finding","review_finding:24f32735fdea","source:mala-cavk.3"],"dependencies":[{"issue_id":"mala-ksai","depends_on_id":"mala-sp2s","type":"blocks","created_at":"2026-01-01T23:32:33.407293424Z","created_by":"daemon"}]}
{"id":"mala-kwx","title":"Update CLI coverage-threshold option","description":"Context:\n- CLI currently has `--coverage-threshold` defaulting to 85.0\n- Need to change default to None\n- Validation logic must allow None (currently rejects non-0-100 values)\n\nScope:\n- In: Change `--coverage-threshold` default from `85.0` to `None`\n- In: Update help text to explain \"no decrease\" mode\n- In: Update validation to allow None (skip range check if None)\n- Out: Actual coverage logic (that's in coverage.py/spec_runner.py)\n\nAcceptance Criteria:\n- `--coverage-threshold` defaults to None\n- Help text mentions \"no decrease\" behavior\n- Running without `--coverage-threshold` doesn't error\n- Running with `--coverage-threshold 80` still works\n\nTest Plan:\n- Test CLI parses None default correctly\n- Test explicit threshold value works\n- Test help text is updated\n\nNotes for Agent:\n- Type should be `float | None` with default `None`\n- Skip the `0 \u003c= coverage_threshold \u003c= 100` check when None\n- Primary file: src/cli.py","status":"tombstone","priority":1,"issue_type":"task","created_at":"2025-12-27T18:14:25.299018117Z","updated_at":"2025-12-27T18:20:40.634646298Z","labels":["cli"],"dependencies":[{"issue_id":"mala-kwx","depends_on_id":"mala-da4","type":"blocks","created_at":"2025-12-27T18:15:02.03951473Z","created_by":"daemon"}],"deleted_at":"2025-12-27T18:20:40.634646298Z","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"mala-kz4","title":"Detect context exhaustion","status":"tombstone","priority":2,"issue_type":"epic","created_at":"2025-12-26T00:55:42.494971406Z","updated_at":"2025-12-26T00:56:32.189479702Z","deleted_at":"2025-12-26T00:56:32.189479702Z","deleted_by":"daemon","delete_reason":"delete","original_type":"epic"}
{"id":"mala-l072","title":"[Review] src/pipeline/issue_execution_coordinator.py:23-31: [P3] Implicit coupling between `spawn_callback` and `register_task`","description":"## Review Finding\n\nThis issue was auto-created from a P3 review finding.\n\n**Source issue:** mala-cavk.3\n**Reviewer:** gemini\n**Location:** src/pipeline/issue_execution_coordinator.py:23-31\n\n## Details\n\nThe `SpawnCallback` protocol returns a `bool`, but the implementation is implicitly required to call `coordinator.register_task` to ensure the coordinator tracks the task. Returning the `asyncio.Task` from the callback (or `None` on failure) would be a more explicit and safer contract.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-01T22:23:07.477445733Z","created_by":"cyou","updated_at":"2026-01-02T01:58:59.94256398Z","closed_at":"2026-01-02T01:58:59.94256398Z","close_reason":"Closed","labels":["auto_generated","review_finding","review_finding:aa669b2e1d45","source:mala-cavk.3"],"dependencies":[{"issue_id":"mala-l072","depends_on_id":"mala-i8ke","type":"blocks","created_at":"2026-01-01T23:32:50.769263326Z","created_by":"daemon"}]}
{"id":"mala-l10","title":"Codex reviewer reviews stale commit instead of current HEAD","description":"## Bug\n\nIn `src/orchestrator.py:893-898`, the Codex review is called with:\n```python\nreview_result = await run_codex_review(\n    self.repo_path,\n    lifecycle_ctx.last_gate_result.commit_hash,  # \u003c-- BUG: uses the SPECIFIC commit\n    ...\n    baseline_commit=baseline_commit_hash,\n)\n```\n\n**The problem:** When Codex reviews, it looks at `git diff baseline..commit_sha`. But if another agent made a subsequent commit that fixed/reverted the issues, Codex won't see those fixes because it only reviews up to the specific commit, not to the current HEAD.\n\n## Observed in mala-yg9.4\n\n1. Agent `mala-yg9.4` made commit `5b3fc31` with problematic changes to `legacy_runner.py`\n2. Agent `mala-g3h.3` made commit `5f79256` which reverted those changes\n3. Codex review ran for `mala-yg9.4` and reviewed `baseline..5b3fc31`\n4. Commit `5f79256` comes AFTER `5b3fc31`, so it's not included in the diff\n5. Codex kept flagging stale code that was already fixed on disk\n6. Agent verified files were correct but Codex kept failing (5 attempts wasted)\n\n## Fix\n\nChange line 895 to review from baseline to **current HEAD** instead of the specific commit:\n\n```python\n# Get current HEAD for review (includes any subsequent fixes)\ncurrent_head = await get_git_commit_async(self.repo_path)\n\nreview_result = await run_codex_review(\n    self.repo_path,\n    current_head,  # Review up to current HEAD, not the specific commit\n    ...\n    baseline_commit=baseline_commit_hash,\n)\n```\n\n## Acceptance Criteria\n\n- Codex reviews cumulative diff from baseline to current HEAD (not the agent's specific commit)\n- If another agent fixes issues after the first agent's commit, Codex sees the clean cumulative diff\n- Add test case for multi-commit scenario where later commit fixes earlier issues","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-28T02:17:00.103052285Z","updated_at":"2025-12-28T02:38:26.048150531Z","closed_at":"2025-12-28T02:38:26.048150531Z","close_reason":"Closed"}
{"id":"mala-l5s1","title":"improve logging -p 1","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-31T17:12:40.21272827Z","created_by":"cyou","updated_at":"2026-01-01T21:40:07.287229488Z","closed_at":"2026-01-01T21:40:07.287229488Z","close_reason":"Closed"}
{"id":"mala-l7r","title":"Support epic filter for getting ready tasks","description":"Goal: Allow specifying a beads epic ID to filter ready tasks, so only tasks that are children of that epic are returned.\n\nScope/files: src/beads_client.py, src/cli.py (or src/orchestrator.py if it exists).\n\nWork:\n- Add optional epic_id parameter to BeadsClient.get_ready() method.\n- Filter returned issues to only include those with a parent-child dependency on the specified epic.\n- Add --epic CLI option to 'mala run' command to pass epic filter.\n- Update orchestrator to pass epic filter to BeadsClient.\n\nAcceptance criteria:\n- 'mala run --epic mala-c01' only processes tasks that are children of epic mala-c01.\n- Without --epic flag, behavior unchanged (all ready tasks).\n- Epic itself is still excluded from ready tasks (existing behavior).\n- Tests cover epic filter logic.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T00:17:16.892104528Z","updated_at":"2025-12-26T00:48:18.823402862Z","closed_at":"2025-12-26T00:48:18.823402862Z","close_reason":"Closed"}
{"id":"mala-lm0","title":"Refactor: extract JSONLLogger","description":"## Context\n`JSONLLogger` currently lives in `src/main.py`. It should be moved into `src/logging/jsonl.py` to isolate logging and reduce `main.py` surface area.\n\n## Scope\nCreate the new module only. Do **not** modify `src/main.py` in this issue; integration will wire it up later.\n\n### Files\n- Add: `src/logging/jsonl.py`\n\n## Requirements\n- `JSONLLogger` behavior must remain unchanged (file path, JSONL structure, timestamps, flush behavior).\n- Use the same `JSONL_LOG_DIR` constant from `src/tools/env.py` (so this issue depends on the env module existing).\n\n## Acceptance Criteria\n- `src/logging/jsonl.py` exists and matches current JSONLLogger behavior.\n- No other files are modified in this issue.\n\n## Notes\n- Integration issue will update imports in `src/main.py`.\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T19:54:51.153849001Z","updated_at":"2025-12-25T20:11:41.797668608Z","closed_at":"2025-12-25T20:11:41.797668608Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-lm0","depends_on_id":"mala-9ki","type":"blocks","created_at":"2025-12-25T20:06:47.457341927Z","created_by":"daemon"}]}
{"id":"mala-lo9","title":"Add quality gate for commits + validation evidence","description":"Context:\n- Track A4 requires verifying commit message contains bd-\u003cissue_id\u003e and that validation checks ran (docs/coordination-plan-codex.md:38-41).\n- Orchestrator currently marks success solely by bd status closed (src/orchestrator.py:180-209).\n\nScope:\n- In: add a post-run quality gate that checks for a commit message containing bd-\u003cissue_id\u003e.\n- In: verify validation commands ran by parsing JSONL logs (or by rerunning in orchestrator if needed).\n- In: on gate failure, mark needs-followup and record failure context.\n- Out: no prompt updates and no handoff file generation (A6).\n\nAcceptance Criteria:\n- Issues only count as success when closed, a matching commit exists, and validation evidence is present.\n- Gate failures record the missing evidence and apply a needs-followup marker.\n- JSONL parsing recognizes uv sync, pytest, ruff check/format, and ty check commands.\n\nTest Plan:\n- TDD: add failing tests in tests/test_orchestrator.py for pass/fail gate scenarios (mock git log + JSONL data).\n- Implement gate logic and update tests to pass.\n- Run uv run pytest tests/test_orchestrator.py.\n\nNotes for Agent:\n- Decide whether needs-followup is a bd label or status and document the choice.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T16:44:33.280391503Z","updated_at":"2025-12-26T17:10:02.788723047Z","closed_at":"2025-12-26T17:10:02.788723047Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-lo9","depends_on_id":"mala-jxc","type":"blocks","created_at":"2025-12-26T16:44:48.861098735Z","created_by":"daemon"},{"issue_id":"mala-lo9","depends_on_id":"mala-4w7","type":"parent-child","created_at":"2025-12-26T16:47:53.007870582Z","created_by":"daemon"}]}
{"id":"mala-lq68","title":"[Review] src/domain/validation/config_merger.py:76-85: [P2] Preserve programmatic overrides when _fields_set empty","description":"## Review Finding\n\nThis issue was auto-created from a P2 review finding.\n\n**Source issue:** mala-e37n\n**Reviewer:** codex\n**Location:** src/domain/validation/config_merger.py:76-85\n\n## Details\n\nThe new merge logic only treats fields as overrides when they appear in `_fields_set`. That set is populated only by `from_dict`, so programmatic configs (e.g., `ValidationConfig(coverage=YamlCoverageConfig(...))` or `CommandsConfig(test=CommandConfig(...))`) now **silently inherit** preset values instead of overriding them. This is a behavioral regression from the previous merge rules and will surprise any non-YAML callers (the docstring example in this module is now wrong). Consider a fallback when `_fields_set` is empty (treat non-`None` values as explicit), or populate `_fields_set` in the constructors for programmatic use.\n\nExample line:\n```\nmerged_coverage = _merge_coverage(..., \"coverage\" in user._fields_set)\n```","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T04:14:26.267833658Z","created_by":"cyou","updated_at":"2026-01-02T04:23:34.298509634Z","closed_at":"2026-01-02T04:23:34.298509634Z","close_reason":"Closed","labels":["auto_generated","review_finding","review_finding:b15e1a35933f","source:mala-e37n"]}
{"id":"mala-lshy","title":"Epic verifier: Implement RetryConfig for transient API failure handling","description":"## Context\n\nThe `EpicVerifier` constructor accepts a `RetryConfig` parameter but never uses it. The `ClaudeEpicVerificationModel.verify()` method makes API calls without any retry logic.\n\n## Problem\n\n- Transient API failures (rate limits, network issues, 500 errors) cause immediate verification failure\n- No exponential backoff or retry attempts\n- Makes epic verification more fragile than other LLM-dependent tasks in the codebase\n\n## Proposed Solution\n\n1. Wire the `RetryConfig` through to the model's `verify()` method\n2. Wrap the Anthropic API call with retry logic using the config\n3. Consider using tenacity or similar for retry implementation\n\n## Acceptance Criteria\n\n- [ ] RetryConfig is used to wrap model API calls\n- [ ] Transient failures trigger retries with exponential backoff\n- [ ] Max retries and timeout are configurable via RetryConfig\n- [ ] Tests verify retry behavior on transient failures\n\n## References\n\n- File: `src/epic_verifier.py` - `EpicVerifier.__init__` accepts `retry_config`\n- File: `src/epic_verifier.py` - `ClaudeEpicVerificationModel.verify()` makes unprotected API call\n- From code review iteration 3","notes":"Quality gate failed: Timeout after 60 minutes\nLog: /home/cyou/.claude/projects/-home-cyou-mala/64c280fd-2de0-47cd-8105-78a431c07740.jsonl","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-30T15:50:10.183319757Z","created_by":"cyou","updated_at":"2025-12-30T20:26:20.949105554Z","closed_at":"2025-12-30T20:26:20.949105554Z","close_reason":"Closed","labels":["needs-followup"]}
{"id":"mala-ltvw","title":"[Review] src/domain/validation/config_merger.py:108-129: [P2] Honor explicit commands null/empty to clear preset commands","description":"## Review Finding\n\nThis issue was auto-created from a P2 review finding.\n\n**Source issue:** mala-fdp1.4\n**Reviewer:** codex\n**Location:** src/domain/validation/config_merger.py:108-129\n\n## Details\n\n`ValidationConfig.from_dict` records when `commands` is explicitly present, even if set to null/empty, but `merge_configs` only checks per-command `_fields_set`. As a result, YAML like `commands: null` (or `commands: {}`) still inherits all preset commands, which contradicts the stated “explicit null/empty overrides” behavior and makes it impossible to clear all preset commands without listing each field. Consider short-circuiting when the top-level `commands` field was explicitly set, or treating an explicitly-set commands block with no fields as an override to empty.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T04:10:25.921033002Z","created_by":"cyou","updated_at":"2026-01-02T04:16:57.90184013Z","closed_at":"2026-01-02T04:16:57.90184013Z","close_reason":"Closed","labels":["auto_generated","review_finding","review_finding:ba6c3a5ddce1","source:mala-fdp1.4"]}
{"id":"mala-lvw","title":"Single-threaded mode without locking","status":"blocked","priority":4,"issue_type":"epic","created_at":"2025-12-26T00:57:29.777283988Z","updated_at":"2025-12-28T06:25:04.606463685Z"}
{"id":"mala-m70v","title":"[Review] src/infra/clients/cerberus_review.py:222: [P2] Use directory path instead of glob for robust exclusion","description":"## Review Finding\n\nThis issue was auto-created from a P2 review finding.\n\n**Source issue:** mala-sw4q\n**Reviewer:** gemini\n**Location:** src/infra/clients/cerberus_review.py:222\n\n## Details\n\nThe pattern `.beads/*` typically fails to match hidden files (such as `.beads/.gitignore`) in standard glob implementations. Additionally, it may not recursively exclude nested subdirectories if they are added in the future. To ensure the entire issue tracker directory is consistently skipped as intended, use the directory path `.beads/` instead of a glob pattern.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T23:40:23.372958956Z","created_by":"cyou","updated_at":"2026-01-01T23:45:36.267744803Z","closed_at":"2026-01-01T23:45:36.267744803Z","close_reason":"Closed","labels":["auto_generated","review_finding","review_finding:95b33a01ee8d","source:mala-sw4q"]}
{"id":"mala-mfnr","title":"[Review] src/orchestration/orchestrator.py:521-544: [P2] Wrap finalization loop body in try/except","description":"## Review Finding\n\nThis issue was auto-created from a P2 review finding.\n\n**Source issue:** mala-nsjx\n**Reviewer:** gemini\n**Location:** src/orchestration/orchestrator.py:521-544\n\n## Details\n\nIn `_execute_remediation_issues`, if `_finalize_issue_result` raises an exception (e.g. during I/O), the loop will terminate early. This prevents subsequent remediation tasks in `task_pairs` from being finalized or marked as completed in the coordinator. Wrap the loop body in a `try/except` block to ensure a failure in one issue's finalization doesn't impact the cleanup of others.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T02:06:16.031326984Z","created_by":"cyou","updated_at":"2026-01-02T02:17:45.082995552Z","closed_at":"2026-01-02T02:17:45.082995552Z","close_reason":"Closed","labels":["auto_generated","review_finding","review_finding:3c70c1770917","source:mala-nsjx"]}
{"id":"mala-mj8","title":"Docs: update README + Braintrust docstring to match implementation","description":"Problem: README says lock mechanism uses atomic mkdir, but scripts use hardlink+tempfile; braintrust_integration.py docstring says setup is in main.py, but it is in cli.py.\\n\\nScope/files: README.md, src/braintrust_integration.py.\\n\\nWork:\\n- Update README to reflect actual lock mechanism and current braintrust setup location.\\n- Update braintrust_integration.py docstring to refer to cli.py (or central location if changed).\\n\\nAcceptance criteria:\\n- Docs match current behavior.\\n- No functional code changes.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-25T21:38:42.843621671Z","updated_at":"2025-12-26T00:00:38.778018843Z","closed_at":"2025-12-26T00:00:38.778018843Z","close_reason":"Closed"}
{"id":"mala-mm2","title":"BeadsClient: add parent epic lookup methods","description":"Context:\n- Need to determine parent epic for each task to enable grouping\n- `bd dep tree \u003cid\u003e --direction=down` returns parent chain (epic at depth=1)\n- Should cache results to avoid repeated subprocess calls for tasks in same epic\n\nScope:\n- In: Add `get_parent_epic_async(issue_id) -\u003e str | None` method to BeadsClient\n- In: Add batch method `get_parent_epics_async(issue_ids) -\u003e dict[str, str | None]` for efficiency\n- Out: Changes to existing `get_ready_async` signature (handled in later issue)\n\nAcceptance Criteria:\n- `get_parent_epic_async` returns parent epic ID or None for orphans\n- Batch method minimizes subprocess calls (one call per unique epic, not per task)\n- Method handles errors gracefully (returns None on failure)\n\nTest Plan:\n- Add unit tests with mocked subprocess calls\n- Test orphan detection (no parent epic)\n- Test caching behavior\n\nNotes for Agent:\n- Use existing `_run_subprocess_async` pattern\n- Epic is identified by `issue_type == \"epic\"` at depth \u003e 0 in tree output\n\nPrimary files: src/beads_client.py","status":"tombstone","priority":1,"issue_type":"task","created_at":"2025-12-27T18:14:19.162836Z","updated_at":"2025-12-27T18:19:15.404812357Z","dependencies":[{"issue_id":"mala-mm2","depends_on_id":"mala-g3h","type":"blocks","created_at":"2025-12-27T18:18:55.814652214Z","created_by":"daemon"}],"deleted_at":"2025-12-27T18:19:15.404812357Z","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"mala-n0n","title":"Write failure handoff files on agent failure","description":"Context:\n- Track A6 requires writing .mala/handoff/\u003cissue_id\u003e.md with last commands and error summary (docs/coordination-plan-codex.md:47-48).\n- Orchestrator currently resets failed issues without a persistent handoff artifact (src/orchestrator.py:300-340).\n\nScope:\n- In: on agent failure (including quality gate failures), write .mala/handoff/\u003cissue_id\u003e.md with last commands and error summary.\n- In: ensure the handoff directory is created and file names are sanitized.\n- Out: do not change the quality gate logic beyond invoking handoff writer.\n\nAcceptance Criteria:\n- A handoff file is created for failed issues and contains last command(s) and an error summary.\n- File is created even when no commands are available (explicitly say so).\n- Handoff path is deterministic and safe for all issue IDs.\n\nTest Plan:\n- TDD: add failing unit test in a new tests/test_handoff.py.\n- Implement handoff writer and update tests to pass.\n- Run uv run pytest tests/test_handoff.py.\n\nNotes for Agent:\n- Prefer sourcing command history from JSONL logs to avoid missing data.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T16:44:42.712108592Z","updated_at":"2025-12-26T17:14:50.909626715Z","closed_at":"2025-12-26T17:14:50.909626715Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-n0n","depends_on_id":"mala-lo9","type":"blocks","created_at":"2025-12-26T16:44:52.444889534Z","created_by":"daemon"},{"issue_id":"mala-n0n","depends_on_id":"mala-4w7","type":"parent-child","created_at":"2025-12-26T16:47:53.018656516Z","created_by":"daemon"}]}
{"id":"mala-n28","title":"Make terminal log colors brighter","description":"## Context\nThe terminal logging colors in src/logging/console.py could be more visible, especially on dark terminal themes. Currently using ANSI bright codes (91-97) but some outputs still use DIM which reduces visibility.\n\n## Scope\n- In: Review and adjust color codes in src/logging/console.py for better visibility\n- In: Consider replacing DIM with lighter shades or removing DIM from key output\n- In: Evaluate GRAY color (currently 37) - may need brighter alternative\n- Out: Changing the logging format or structure\n\n## Files\n- src/logging/console.py\n\n## Acceptance Criteria\n- Log output is more visible on dark terminal backgrounds\n- Color choices remain distinguishable for different log types\n- Agent ID colors remain distinct when multiple agents run concurrently\n\n## Notes for Agent\n- Test with both light and dark terminal themes\n- Keep semantic color meanings (e.g., red for errors, yellow for warnings)\n- Consider using bold + color combinations for emphasis instead of DIM","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T17:56:31.759827685Z","updated_at":"2025-12-28T04:07:54.067848191Z","closed_at":"2025-12-28T04:07:54.067848191Z","close_reason":"Closed"}
{"id":"mala-n37j","title":"[Review] src/domain/validation/tool_name_extractor.py:130-138: [P2] Skip built-in arguments when selecting the next command","description":"## Review Finding\n\nThis issue was auto-created from a P2 review finding.\n\n**Source issue:** mala-fdp1.5\n**Reviewer:** codex\n**Location:** src/domain/validation/tool_name_extractor.py:130-138\n\n## Details\n\n`_extract_from_tokens` skips built-in tokens but only skips env assignments afterward. For inputs like `set -e \u0026\u0026 pytest` or `source venv/bin/activate \u0026\u0026 pytest`, the first segment extracts `-e` or `activate` and is treated as meaningful, so `extract_tool_name` returns the wrong tool instead of `pytest`. This is because the built-in’s arguments aren’t consumed, so a non-command token becomes `first`. Consider skipping the next token(s) (or until a shell operator) after a built-in in the per-segment parse so you don’t treat flags/paths as tools.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T03:17:47.859119917Z","created_by":"cyou","updated_at":"2026-01-02T04:08:34.419627583Z","closed_at":"2026-01-02T04:08:34.419627583Z","close_reason":"Closed","labels":["auto_generated","review_finding","review_finding:977fb1e1bf74","source:mala-fdp1.5"]}
{"id":"mala-n4av","title":"[Review] tests/test_epic_verification_retry.py:374-398: [P3] Test assertion only verifies one task was awaited, not all","description":"## Review Finding\n\nThis issue was auto-created from a P3 review finding.\n\n**Source issue:** mala-l072\n**Reviewer:** claude\n**Location:** tests/test_epic_verification_retry.py:374-398\n\n## Details\n\nThe test uses a single `task_was_awaited` boolean shared across two spawned issues (`rem-1`, `rem-2`). Each spawn overwrites the same boolean, so the test only confirms at least one task ran to completion, not that both tasks were actually awaited. Consider using a counter or set of issue IDs to verify all tasks were awaited:\n```python\ntasks_awaited: set[str] = set()\n```","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-02T01:58:59.977985801Z","created_by":"cyou","updated_at":"2026-01-02T02:00:34.187861129Z","closed_at":"2026-01-02T02:00:34.187861129Z","close_reason":"Closed","labels":["auto_generated","review_finding","review_finding:01a2c588c525","source:mala-l072"]}
{"id":"mala-n5du","title":"[Remediation] Evidence extraction in testable pure functions","description":"## Context\nThis issue was auto-created by epic verification for epic `mala-29eu`.\n\n## Unmet Criterion\nEvidence extraction in testable pure functions\n\n## Evidence\nNo changes to _finalize_issue_result method, no GateMetadata dataclass, no _build_gate_metadata functions. Task mala-29eu.3 status is still 'open'.\n\n## Severity\ncritical\n\n## Resolution\nAddress this criterion to unblock epic closure. When complete, close this issue.\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T03:29:57.017547941Z","created_by":"cyou","updated_at":"2026-01-01T05:53:45.062130279Z","closed_at":"2026-01-01T05:53:45.062130279Z","close_reason":"Closed","labels":["auto_generated","epic_remediation:mala-29eu:b8d18be73d9c1e880bcb8f2528257407d2a626b6c9f656d0c9de669548c680d5"],"dependencies":[{"issue_id":"mala-n5du","depends_on_id":"mala-29eu","type":"parent-child","created_at":"2026-01-01T03:37:25.287374598Z","created_by":"daemon"}]}
{"id":"mala-nab0","title":"[Review] src/domain/validation/config.py:93-95: [P3] Inconsistent empty string validation","description":"## Review Finding\n\nThis issue was auto-created from a P3 review finding.\n\n**Source issue:** mala-fdp1.1\n**Reviewer:** gemini\n**Location:** src/domain/validation/config.py:93-95\n\n## Details\n\n`CommandConfig.from_value` checks for empty command strings when parsing a dict but permits them when parsing a string directly. Both paths should enforce the \"Command cannot be empty string\" rule to ensure consistency.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-02T03:19:13.909781322Z","created_by":"cyou","updated_at":"2026-01-02T03:45:18.946777326Z","closed_at":"2026-01-02T03:45:18.946777326Z","close_reason":"Closed","labels":["auto_generated","review_finding","review_finding:39bbb21d83d1","source:mala-fdp1.1"]}
{"id":"mala-ng3","title":"Update EvidenceGate for scope-aware evidence + no-op","description":"Context:\n- EvidenceGate must be scope-aware and allow no-op/obsolete issues without forced commits.\n- Plan requires log markers for no-change/obsolete outcomes.\n\nScope:\n- In: update EvidenceGate to derive expected evidence from ValidationSpec per scope; parse ISSUE_NO_CHANGE/ISSUE_OBSOLETE markers with rationale; skip Gate 2/3 when applicable.\n- Out: orchestrator sequencing changes (separate task).\n\nAcceptance Criteria:\n- EvidenceGate accepts no-op/obsolete issues with clean working tree and rationale.\n- Per-issue EvidenceGate never requires E2E evidence.\n- Clear failure messages when evidence is missing.\n\nTest Plan:\n- TDD: add tests for log parsing of evidence and no-op markers.\n- Run quality_gate unit tests.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T23:00:01.716896014Z","updated_at":"2025-12-27T00:46:55.821216427Z","closed_at":"2025-12-27T00:46:55.821216427Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-ng3","depends_on_id":"mala-5us","type":"blocks","created_at":"2025-12-26T23:00:26.558341387Z","created_by":"daemon"}]}
{"id":"mala-nsjx","title":"[Review] src/orchestration/orchestrator.py:495-503: [P2] Finalize remediation task results","description":"## Review Finding\n\nThis issue was auto-created from a P2 review finding.\n\n**Source issue:** mala-l072\n**Reviewer:** codex\n**Location:** src/orchestration/orchestrator.py:495-503\n\n## Details\n\n`_execute_remediation_issues` now only awaits the returned task and never registers it with the coordinator, but `finalize_callback` is the only path that calls `_finalize_issue_result` and `mark_completed`. That means remediation issues can succeed yet never be closed or recorded (e.g., epic verification spawns remediation issues → tasks complete → no `beads.close_async` or run metadata). Consider registering these tasks (so run_loop finalizes them) or explicitly finalizing their results here.\n\nSnippet:\n```\ntask = await self.spawn_agent(issue_id)\nif task:\n    tasks.append(task)\n```","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T01:58:59.991365765Z","created_by":"cyou","updated_at":"2026-01-02T02:06:15.996497605Z","closed_at":"2026-01-02T02:06:15.996497605Z","close_reason":"Closed","labels":["auto_generated","review_finding","review_finding:fe8ac1fa5584","source:mala-l072"]}
{"id":"mala-nzk6","title":"hide waiting for session log, log file ready in default log mode","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T22:54:32.553091653Z","created_by":"cyou","updated_at":"2026-01-02T01:08:22.730646474Z","closed_at":"2026-01-02T01:08:22.730646474Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-nzk6","depends_on_id":"mala-cw6h","type":"blocks","created_at":"2026-01-01T23:32:33.320375764Z","created_by":"daemon"}]}
{"id":"mala-o15f","title":"[Review] src/infra/clients/cerberus_review.py:280-282: [P2] Missing timeout check after retry spawn","description":"## Review Finding\n\nThis issue was auto-created from a P2 review finding.\n\n**Source issue:** mala-m70v\n**Reviewer:** claude\n**Location:** src/infra/clients/cerberus_review.py:280-282\n\n## Details\n\nThe retry spawn after stale gate resolution (lines 280-282) doesn't check `spawn_result.timed_out`, unlike the original spawn (line 264). If the retry times out, it will report a generic 'spawn failed after gate resolve' error instead of 'spawn timeout'. Add a timeout check after line 282:\n```python\nif spawn_result.timed_out:\n    return ReviewResult(...parse_error=\"spawn timeout\"...)\n```","notes":"Quality gate failed: External review failed: spawn failed: Error: --exclude expects git exclude pathspec syntax (e.g. :!path or :(exclude,glob)path): .beads/\nLog: /home/cyou/.claude/projects/-home-cyou-mala/59d97fb4-a8a0-49df-a330-7dc847b8bbfd.jsonl","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T23:45:36.288319868Z","created_by":"cyou","updated_at":"2026-01-02T01:00:52.747591791Z","closed_at":"2026-01-02T01:00:52.747591791Z","close_reason":"Closed","labels":["auto_generated","needs-followup","review_finding","review_finding:c7c7974506a0","source:mala-m70v"]}
{"id":"mala-o17","title":"Test issue: add a comment to README.md","status":"tombstone","priority":2,"issue_type":"task","created_at":"2025-12-25T18:49:43.062524854Z","updated_at":"2025-12-25T18:53:44.873613587Z","close_reason":"Closed","deleted_at":"2025-12-25T18:53:44.873613587Z","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"mala-o3z","title":"Test braintrust tracing","description":"Add a comment to the README TODOs section noting that Braintrust LLM tracing is now implemented","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T19:22:15.933197275Z","updated_at":"2025-12-25T19:23:21.922382429Z","closed_at":"2025-12-25T19:23:21.922382429Z","close_reason":"Closed"}
{"id":"mala-onst","title":"add instructions to implementer to use subagents","status":"blocked","priority":2,"issue_type":"task","created_at":"2026-01-01T22:11:55.295882901Z","created_by":"cyou","updated_at":"2026-01-01T22:26:45.90030513Z"}
{"id":"mala-oste","title":"Check for duplicate issues before creating review/epic verification tickets","description":"When mala creates review tickets or epic verification tickets, it should check if a similar issue already exists to avoid duplicates.\n\nCurrent behavior:\n- Review failures may create new tickets even if the same issue was already filed\n- Epic verification may create duplicate tickets for the same problem\n\nProposed solution:\n- Before creating a new review/verification issue, search existing open issues for similar titles or descriptions\n- If a potential duplicate is found, either:\n  - Skip creation and log a warning\n  - Add a note to the existing issue instead\n  - Prompt for confirmation (in interactive mode)\n\nThis prevents issue sprawl and keeps the backlog clean.","status":"open","priority":2,"issue_type":"feature","created_at":"2026-01-02T15:21:54.071683268Z","created_by":"cyou","updated_at":"2026-01-02T15:21:54.071683268Z"}
{"id":"mala-oxnm","title":"[Review] src/domain/validation/config.py:93-94: [P2] CommandConfig.from_value doesn't validate empty string shorthand","description":"## Review Finding\n\nThis issue was auto-created from a P2 review finding.\n\n**Source issue:** mala-fdp1.1\n**Reviewer:** claude\n**Location:** src/domain/validation/config.py:93-94\n\n## Details\n\nWhen a command is provided as a string shorthand (not dict form), empty strings are accepted:\n```python\nif isinstance(value, str):\n    return cls(command=value)\n```\nThis allows `CommandConfig.from_value(\"\")` to succeed, creating a config with an empty command. The dict form validates for empty strings, but the string shorthand does not. Add `if not value: raise ConfigError(...)` before returning.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T03:19:13.852820893Z","created_by":"cyou","updated_at":"2026-01-02T03:42:25.765872349Z","closed_at":"2026-01-02T03:42:25.765872349Z","close_reason":"Closed","labels":["auto_generated","review_finding","review_finding:e61656e78d0c","source:mala-fdp1.1"]}
{"id":"mala-p6h","title":"Allow sending messages to a specific agent","description":"Context:\n- Users should be able to send instructions/messages to individual agents mid-run.\n- Enables steering agents without restarting the entire run.\n\nScope:\n- In: CLI command to send message to agent by ID; agent receives and processes message.\n- Out: bidirectional chat; agent UI.\n\nAcceptance Criteria:\n- `mala send \u003cagent-id\u003e \"message\"` delivers message to running agent.\n- Agent acknowledges receipt in its log.\n- Clear error if agent not found or not running.\n\nTest Plan:\n- Manual: run mala, send message to agent, verify it appears in agent context.\n- Unit: mock IPC mechanism.","status":"blocked","priority":4,"issue_type":"feature","created_at":"2025-12-27T01:15:17.401172887Z","updated_at":"2025-12-28T06:25:04.573105868Z","dependencies":[{"issue_id":"mala-p6h","depends_on_id":"mala-bdu","type":"blocks","created_at":"2025-12-27T01:15:21.10029576Z","created_by":"daemon"}]}
{"id":"mala-p9kv","title":"[Remediation] All tests pass: `uv run pytest -m \"unit or integration\"`","description":"## Context\nThis issue was auto-created by epic verification for epic `mala-bp3h`.\n\n## Unmet Criterion\nAll tests pass: `uv run pytest -m \"unit or integration\"`\n\n## Evidence\nNo evidence in the diff that the complete test suite has been run and verified to pass after all architectural changes\n\n## Severity\ncritical\n\n## Resolution\nAddress this criterion to unblock epic closure. When complete, close this issue.\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T03:35:30.889863765Z","created_by":"cyou","updated_at":"2026-01-01T03:38:42.263497558Z","closed_at":"2026-01-01T03:38:42.263497558Z","close_reason":"Closed","labels":["auto_generated","epic_remediation:mala-bp3h:328be6059ec286e5f33b19718d4e2ef96f684df091acda9dda1f5a6c92914008"],"dependencies":[{"issue_id":"mala-p9kv","depends_on_id":"mala-bp3h","type":"parent-child","created_at":"2026-01-01T03:37:52.072226819Z","created_by":"daemon"}]}
{"id":"mala-pc7u","title":"[Review] src/pipeline/agent_session_runner.py:557: [P3] Task says to wire ValidationSpec but only default lint_tools are used","description":"## Review Finding\n\nThis issue was auto-created from a P3 review finding.\n\n**Source issue:** mala-fdp1.10\n**Reviewer:** claude\n**Location:** src/pipeline/agent_session_runner.py:557\n\n## Details\n\nThe acceptance criteria states \"LintCache uses tool names from ValidationSpec\", but the callers in `agent_session_runner.py:557` and `run_coordinator.py:408` still instantiate `LintCache(repo_path=...)` without passing `lint_tools`. The `lint_tools` parameter exists but is unused in the actual integration points. This may be intentional if ValidationSpec wiring is deferred to another task, but the AC as written is not met.","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-02T15:43:51.267892994Z","created_by":"cyou","updated_at":"2026-01-02T15:43:51.267892994Z","labels":["auto_generated","review_finding","review_finding:24e893db0753","source:mala-fdp1.10"]}
{"id":"mala-pco2","title":"Move .mala-cache to ~/.config/mala instead of project root","description":"The .mala-cache directory currently lives in the project root, which pollutes the working directory. It contains lint_cache.json for caching validation run results.\n\nMove the cache to ~/.config/mala/.cache/ or similar XDG-compliant location:\n- Update cache path resolution to use ~/.config/mala/\n- Ensure the directory is created if it doesn't exist\n- Consider respecting XDG_CONFIG_HOME if set\n- Remove .mala-cache from .gitignore (if present) after migration\n- Clean up any references to the old location","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-30T02:46:26.436150057Z","created_by":"cyou","updated_at":"2025-12-30T03:15:25.503901177Z","closed_at":"2025-12-30T03:15:25.503901177Z","close_reason":"Closed"}
{"id":"mala-pyug","title":"[Review] src/domain/validation/config.py:144-162: [P3] YamlCoverageConfig validates in both from_dict and __post_init__","description":"## Review Finding\n\nThis issue was auto-created from a P3 review finding.\n\n**Source issue:** mala-fdp1.1\n**Reviewer:** claude\n**Location:** src/domain/validation/config.py:144-162\n\n## Details\n\nThe `file` field is validated for emptiness in both `from_dict()` (line 192-196 type check, but not emptiness) and `__post_init__()` (line 161-162). However, direct instantiation like `YamlCoverageConfig(format=\"xml\", file=\"\", threshold=80)` triggers only `__post_init__` validation. The `from_dict` validates type but relies on `__post_init__` for the emptiness check. This dual validation path works but may cause confusion if someone expects `from_dict` to catch all validation errors before object creation.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-02T03:19:13.867324171Z","created_by":"cyou","updated_at":"2026-01-02T03:50:01.005058307Z","closed_at":"2026-01-02T03:50:01.005058307Z","close_reason":"Closed","labels":["auto_generated","review_finding","review_finding:2759f6fc5b47","source:mala-fdp1.1"]}
{"id":"mala-q1y","title":"Quality gate: require commit created during current run","description":"Context:\n- src/quality_gate.py: check_commit_exists() accepts any bd-\u003cissue_id\u003e commit in the last 30 days; orchestrator uses this for gating.\n- This can accept stale commits from earlier runs, allowing the gate to pass without a new commit in the current run.\n- Needs verification: reproduce by reopening an issue that already has a bd-\u003cid\u003e commit and confirm the gate passes without a new commit.\n\nScope:\n- In: capture a per-run baseline (timestamp or commit hash) and require the matching commit to be newer than that baseline; update gate/orchestrator and tests.\n- Out: changing commit message format or redesigning the retry loop.\n\nAcceptance Criteria:\n- Gate fails when only pre-run commits exist for the issue.\n- Gate passes when a new bd-\u003cissue_id\u003e commit is created after run start.\n- Tests cover stale vs new commit behavior.\n\nTest Plan:\n- TDD: add failing test(s) (tests/test_orchestrator.py or tests/test_quality_gate.py) that simulate stale commit acceptance, implement fix, run targeted pytest.\n\nNotes for Agent:\n- Baseline should be captured once per run to avoid false positives in retries.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-26T21:43:52.640540776Z","updated_at":"2025-12-26T22:52:42.793516615Z","closed_at":"2025-12-26T22:52:42.793516615Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-q1y","depends_on_id":"mala-53v","type":"blocks","created_at":"2025-12-26T21:43:58.82161634Z","created_by":"daemon"}]}
{"id":"mala-q24","title":"Pretty print tool call arguments in logs","description":"Currently log_tool() in src/logging/console.py only shows tool name and a brief description. Tool call arguments (like file paths, search patterns, etc.) are not displayed.\n\nWhen --no-truncate is used, tool arguments MUST be pretty-printed in the logs:\n- Add 'arguments' parameter to log_tool()\n- When truncation is disabled, format arguments nicely (e.g., key=value pairs)\n- Use multi-line formatting for complex nested arguments (JSON)\n- When truncation is enabled, can show abbreviated/truncated version\n\nThis ties into mala-59n which added the --no-truncate option. The full output mode should include full tool arguments for debugging.\n\nReference: src/logging/console.py:103","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T17:12:19.753573776Z","updated_at":"2025-12-26T17:16:20.717304732Z","closed_at":"2025-12-26T17:16:20.717304732Z","close_reason":"Closed"}
{"id":"mala-q2af","title":"[Review] tests/test_event_sink.py:511-605: [P3] Missing unit test for `on_gate_result` issue_id propagation","description":"## Review Finding\n\nThis issue was auto-created from a P3 review finding.\n\n**Source issue:** mala-40pg.3\n**Reviewer:** gemini\n**Location:** tests/test_event_sink.py:511-605\n\n## Details\n\nThe commit adds comprehensive tests for `issue_id` propagation in most updated methods, but `on_gate_result` is missing a corresponding test case in `tests/test_event_sink.py`.","notes":"Quality gate failed: External review failed: spawn failed: Artifact written: /home/cyou/.claude/projects/-home-cyou-mala/cerberus/d2632f15-6bff-41ff-b973-41ed15b71162/latest.md\nReview gate already active (status: pending, age: 48s)\nUse /home/cyou/.claude/plugins/cache/cerberus/cerberus/1.10.6/bin/review-gate resolve to complete the existing gate first.\nLog: /home/cyou/.claude/projects/-home-cyou-mala/d2632f15-6bff-41ff-b973-41ed15b71162.jsonl","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-01T19:41:09.716421152Z","created_by":"cyou","updated_at":"2026-01-01T23:55:29.976592003Z","closed_at":"2026-01-01T23:53:06.940105448Z","close_reason":"Closed","labels":["auto_generated","needs-followup","review_finding","review_finding:d7263695bc3a","source:mala-40pg.3"],"dependencies":[{"issue_id":"mala-q2af","depends_on_id":"mala-apsz","type":"blocks","created_at":"2026-01-01T23:32:33.361886548Z","created_by":"daemon"}]}
{"id":"mala-qhny","title":"[Review] src/orchestration/orchestrator.py:954: [P1] Debug logging is cut off before run-level validation and finalization","description":"## Review Finding\n\nThis issue was auto-created from a P3 review finding.\n\n**Source issue:** mala-dhry\n**Reviewer:** gemini\n**Location:** src/orchestration/orchestrator.py:954\n\n## Details\n\nThe `run_metadata.cleanup()` call in `MalaOrchestrator.run` is placed in a `finally` block that only covers `_run_main_loop`. This causes debug logging to be disabled and the log file to be closed before run-level validation, issue committing, and final metadata saving occur. Since these finalization steps are critical for troubleshooting (e.g., understanding why run-level validation failed or if issues were correctly committed), they should be captured in the debug log. Moving the `cleanup()` call to the end of the `run` method or wrapping the entire method in a `try...finally` would resolve this.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-01T22:54:29.961648244Z","created_by":"cyou","updated_at":"2026-01-02T01:48:15.376251199Z","closed_at":"2026-01-02T01:48:15.376251199Z","close_reason":"Closed","labels":["auto_generated","review_finding","review_finding:dd0929635c04","source:mala-dhry"],"dependencies":[{"issue_id":"mala-qhny","depends_on_id":"mala-cw6h","type":"blocks","created_at":"2026-01-01T23:03:58.870671665Z","created_by":"daemon"}]}
{"id":"mala-qhrl","title":"[Review] src/pipeline/issue_execution_coordinator.py:269-284: [P2] Unused utility method `abort_active_tasks` in coordinator","description":"## Review Finding\n\nThis issue was auto-created from a P2 review finding.\n\n**Source issue:** mala-cavk.3\n**Reviewer:** gemini\n**Location:** src/pipeline/issue_execution_coordinator.py:269-284\n\n## Details\n\nThe `IssueExecutionCoordinator.abort_active_tasks` method is defined as a utility but is not used by the current `MalaOrchestrator` implementation, which continues to use its own `_abort_active_tasks` logic. This contributes to code duplication and dead code.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T22:23:07.451805927Z","created_by":"cyou","updated_at":"2026-01-02T02:02:40.212012256Z","closed_at":"2026-01-02T02:02:40.212012256Z","close_reason":"Closed","labels":["auto_generated","review_finding","review_finding:c49ef24c6fc6","source:mala-cavk.3"],"dependencies":[{"issue_id":"mala-qhrl","depends_on_id":"mala-i8ke","type":"blocks","created_at":"2026-01-01T23:31:14.986865876Z","created_by":"daemon"},{"issue_id":"mala-qhrl","depends_on_id":"mala-l072","type":"blocks","created_at":"2026-01-01T23:32:50.801086863Z","created_by":"daemon"}]}
{"id":"mala-r2ll","title":"Move epic verification to run after each issue is closed","description":"Currently epic verification runs at the end of a mala run. It should be moved to run incrementally after each issue is closed, so verification happens sooner and problems are caught earlier.\n\nScope:\n- Move epic verification trigger from end-of-run to post-issue-close hook\n- Verify only the epic(s) affected by the closed issue\n- Maintain existing verification logic and event sink integration\n- Update orchestrator to call verification after issue close instead of batch at end\n\nAcceptance Criteria:\n- Epic verification runs immediately after an issue is closed\n- Only affected epics are verified (not all eligible)\n- Verification results are still emitted via event sink\n- No duplicate verifications for the same epic in a single run","notes":"Quality gate failed: External review failed: CLAUDE_SESSION_ID missing; must be provided by agent session id\nLog: /home/cyou/.claude/projects/-home-cyou-mala/017aff67-c1d3-4098-9b74-1d01ac1ca6e9.jsonl","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-30T23:11:43.855833054Z","created_by":"cyou","updated_at":"2025-12-31T03:40:00.802865075Z","closed_at":"2025-12-31T03:40:00.802865075Z","close_reason":"Closed","labels":["needs-followup"]}
{"id":"mala-rba","title":"Add timeout to MCP server subprocess execution in validation","description":"## Context\nDuring a validation run, a pytest test spawned a claude agent that uses the morphllm MCP server. The MCP server's ripgrep subprocess got stuck searching from `/` (root filesystem) instead of the project directory, running for 3+ hours before being manually killed.\n\n## Root Cause\n1. `get_mcp_servers()` in `src/orchestrator.py` receives `repo_path` but doesn't use it\n2. The morphllm MCP config lacks a `cwd` field, so it inherits an unexpected working directory\n3. No timeout on MCP server operations or their subprocesses\n\n## Scope\n- In: Add `cwd` parameter to morphllm MCP config using the passed `repo_path`\n- In: Add timeout protection for MCP server subprocess operations\n- In: Consider adding `WORKSPACE_PATH` env var if morphllm supports it\n- Out: Changes to morphllm itself\n\n## Acceptance Criteria\n- morphllm MCP config includes `cwd: str(repo_path)` \n- MCP server operations have reasonable timeouts\n- Stuck MCP subprocesses don't hang validation indefinitely\n- Tests pass\n\n## Test Plan\n- Run validation with morphllm enabled, verify ripgrep operates in correct directory\n- Verify timeout triggers if subprocess hangs\n\n## Notes for Agent\n- Fix location: `src/orchestrator.py:181-191` in `get_mcp_servers()`\n- The `repo_path` parameter is already passed but unused","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-28T18:57:54.324738643Z","updated_at":"2025-12-28T20:51:06.78258887Z","closed_at":"2025-12-28T20:51:06.78258887Z","close_reason":"Closed"}
{"id":"mala-rds5","title":"[Review] src/domain/validation/config_loader.py:121-125: [P2] Handle non-string top-level keys without TypeError","description":"## Review Finding\n\nThis issue was auto-created from a P2 review finding.\n\n**Source issue:** mala-fdp1.2\n**Reviewer:** codex\n**Location:** src/domain/validation/config_loader.py:121-125\n\n## Details\n\n`_validate_schema` sorts the set of unknown keys. If a YAML file has multiple non-string top-level keys of different types (e.g. `null:` and `1:`), `sorted(unknown_fields)` raises `TypeError`, so users see an unexpected exception instead of the intended `ConfigError`. This is triggered by malformed YAML like `null: foo\\n1: bar\\n` (with any allowed string keys present). Consider normalizing keys to strings for sorting or avoiding sorting altogether to keep error handling consistent.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T03:28:47.881606184Z","created_by":"cyou","updated_at":"2026-01-02T03:36:02.231140104Z","closed_at":"2026-01-02T03:36:02.231140104Z","close_reason":"Closed","labels":["auto_generated","review_finding","review_finding:aace070b99fc","source:mala-fdp1.2"]}
{"id":"mala-rfbn","title":"[Review] src/pipeline/agent_session_runner.py:904-920: [P2] pending_tool_ids not cleared on idle retry can cause infinite hang","description":"## Review Finding\n\nThis issue was auto-created from a P2 review finding.\n\n**Source issue:** mala-cavk.2\n**Reviewer:** claude\n**Location:** src/pipeline/agent_session_runner.py:904-920\n\n## Details\n\n`state.pending_tool_ids` is only cleared at line 902, before the retry while-loop. After an idle timeout, stale tool IDs from the previous attempt remain in the set. On retry, at lines 956-958, `current_timeout = None if state.pending_tool_ids else idle_timeout_seconds` - meaning if pending_tool_ids is non-empty, the timeout is disabled. If the new client also hangs immediately, we wait forever on `stream.__anext__()` with no timeout. The original code cleared `pending_tool_ids` at the start of each iteration attempt. Fix: clear `state.pending_tool_ids` inside the while loop before creating a new client.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T21:33:48.199582418Z","created_by":"cyou","updated_at":"2026-01-01T23:03:54.623369234Z","closed_at":"2026-01-01T23:03:54.623369234Z","close_reason":"Duplicate of mala-actw - both describe the same bug: pending_tool_ids not cleared on idle retry causing infinite hang","labels":["auto_generated","review_finding","review_finding:b9ab0068d7b6","source:mala-cavk.2"]}
{"id":"mala-rmxf","title":"[Review] src/pipeline/agent_session_runner.py:939-952: [P2] Missing on_validation_result emission in SEND_GATE_RETRY path","description":"## Review Finding\n\nThis issue was auto-created from a P2 review finding.\n\n**Source issue:** mala-40pg.4\n**Reviewer:** claude\n**Location:** src/pipeline/agent_session_runner.py:939-952\n\n## Details\n\nWhen the gate fails but retries are available (SEND_GATE_RETRY effect), `on_validation_result` is not emitted. This means validation cycles that trigger retries will emit `on_validation_started` but never a corresponding result event until the final success/failure. While technically validation continues across retries, this creates asymmetric event pairs - listeners tracking `started`/`result` pairs will see orphaned start events.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T19:56:47.316003571Z","created_by":"cyou","updated_at":"2026-01-02T01:52:47.956910615Z","closed_at":"2026-01-02T01:52:47.956910615Z","close_reason":"Closed","labels":["auto_generated","review_finding","review_finding:2ea3af3d802e","source:mala-40pg.4"],"dependencies":[{"issue_id":"mala-rmxf","depends_on_id":"mala-actw","type":"blocks","created_at":"2026-01-01T23:31:44.60161055Z","created_by":"daemon"}]}
{"id":"mala-rsg","title":"Honor --no-truncate for completion summaries","description":"Completion log lines still hard-truncate summaries to 50 chars. Apply the global truncation setting so --no-truncate shows full completion summaries.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-26T15:34:15.335284655Z","updated_at":"2025-12-26T17:11:44.411821976Z","closed_at":"2025-12-26T17:11:44.411821976Z","close_reason":"Closed"}
{"id":"mala-rsq","title":"Refactor: split CLI into cli.py and make main.py a shim","description":"## Context\nWe will parallelize by creating new modules in separate issues, then do a single integration pass to wire everything together. This issue is the integration/wiring step.\n\n## Scope\nWire all refactor modules into the app, update tests, and make `src/main.py` a true shim. This is the **only** issue that should edit `src/main.py` and tests.\n\n### Files\n- Add: `src/cli.py`\n- Modify: `src/main.py`\n- Modify: `tests/test_lock_integration.py`\n- Modify: `tests/test_lock_sdk_integration.py`\n- Modify: any files needed to update imports/paths after the prompt move\n\n## Requirements\n- Create `src/cli.py` with the Typer app + commands currently defined in `src/main.py`.\n- Move CLI-adjacent logic out of `src/main.py` so it becomes a tiny shim that only exposes `app`.\n- Update imports to use the new modules:\n  - `src/tools/env.py`\n  - `src/logging/console.py`\n  - `src/logging/jsonl.py`\n  - `src/agent_loop.py`\n  - `src/tools/locking.py`\n- Update prompt loading to the new path: `src/prompts/implementer_prompt.md`.\n- Update tests to import from new module paths (locking + prompt template).\n- Keep `pyproject.toml` entrypoint as `src.main:app`.\n\n## TDD Guidance\n- Update tests first (imports/paths), run relevant tests:\n  - `tests/test_lock_integration.py`\n  - `tests/test_lock_sdk_integration.py`\n  - `tests/test_lock_scripts.py`\n- Then implement wiring changes and re-run the tests.\n\n## Acceptance Criteria\n- `src/main.py` is a thin shim (import + expose `app`).\n- CLI behavior is unchanged (`mala --help` identical).\n- Prompt loads from the new location.\n- Locking + prompt tests pass with updated imports.\n- All refactor modules are used by the CLI/orchestrator.\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T19:54:51.18845258Z","updated_at":"2025-12-25T20:24:59.79953084Z","closed_at":"2025-12-25T20:24:59.79953084Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-rsq","depends_on_id":"mala-9ki","type":"blocks","created_at":"2025-12-25T20:06:47.478081301Z","created_by":"daemon"},{"issue_id":"mala-rsq","depends_on_id":"mala-1by","type":"blocks","created_at":"2025-12-25T20:06:47.48915539Z","created_by":"daemon"},{"issue_id":"mala-rsq","depends_on_id":"mala-lm0","type":"blocks","created_at":"2025-12-25T20:06:47.499510627Z","created_by":"daemon"},{"issue_id":"mala-rsq","depends_on_id":"mala-wd1","type":"blocks","created_at":"2025-12-25T20:06:47.510195051Z","created_by":"daemon"},{"issue_id":"mala-rsq","depends_on_id":"mala-5aa","type":"blocks","created_at":"2025-12-25T20:06:47.520878684Z","created_by":"daemon"},{"issue_id":"mala-rsq","depends_on_id":"mala-vrm","type":"blocks","created_at":"2025-12-25T20:06:47.530900735Z","created_by":"daemon"}]}
{"id":"mala-rsy","title":"Add --wip flag to prioritize in_progress issues","description":"Add a CLI flag (--wip) to mala run that prioritizes issues with status 'in_progress' before processing 'open' issues.\n\n## Current Behavior\n- mala run processes issues from bd ready which returns both open and in_progress issues\n- No priority given to in_progress issues that may have been started but not completed\n\n## Desired Behavior\nWhen --wip flag is provided:\n1. First process all in_progress issues\n2. Then process open issues (if any slots remain)\n\nThis helps resume work that was previously started before picking up new tasks.\n\n## Implementation Notes\n- Add --wip flag to CLI (src/cli.py)\n- Modify orchestrator to filter/sort issues by status when flag is set\n- Consider: bd ready may need status filtering or sorting in get_ready()\n\n## Acceptance Criteria\n- --wip flag added to mala run\n- When set, in_progress issues are processed before open issues\n- Flag is documented in --help output\n- Unit tests cover the prioritization logic","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T00:19:15.20123002Z","updated_at":"2025-12-27T06:35:24.049205106Z","closed_at":"2025-12-27T06:35:24.049205106Z","close_reason":"Closed"}
{"id":"mala-rt8","title":"Reduce max_review_retries from 5 to 2-3","description":"## Problem\nHigh review_attempts strongly correlate with duration (Pearson r ≈ 0.95) but not with success. Issues that fail after 5 review attempts would have failed after 2-3 as well.\n\n## Evidence from recent runs\n- mala-869.11: 5 review attempts → failed (31.5 min wasted)\n- mala-51q.2: 5 review attempts → failed (39.5 min wasted)\n- mala-869.7: 3 review attempts → failed (15.2 min)\n- mala-51q.9: 3 review attempts → failed (22.8 min)\n\nSuccessful issues typically complete in 1-2 review attempts.\n\n## Solution\nReduce `max_review_retries` default from 5 to 2-3. If no progress after 2-3 attempts, it won't suddenly succeed.\n\n## Expected Impact\n~40% wall time reduction on failing issues","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-29T00:43:22.845882742Z","created_by":"cyou","updated_at":"2025-12-29T01:17:02.745340749Z","closed_at":"2025-12-29T01:17:02.745340749Z","close_reason":"Closed"}
{"id":"mala-s20g","title":"Epic verifier: Use project LLM infrastructure instead of direct Anthropic SDK","description":"## Context\n\nThe `ClaudeEpicVerificationModel` instantiates the Anthropic SDK directly rather than using project-standard provider abstractions like `CodexProvider` or other LLM wrappers used elsewhere in the codebase.\n\n## Problem\n\n- Bypasses established patterns for observability and logging\n- Misses centralized routing configuration (e.g., MorphLLM)\n- Inconsistent with how other LLM calls are made in the orchestrator\n- May miss shared error handling and telemetry\n\n## Proposed Solution\n\n1. Investigate existing LLM provider abstractions in the codebase (e.g., `CodexProvider`, `LLM` classes)\n2. Refactor `ClaudeEpicVerificationModel` to use the same infrastructure\n3. Or create a shared Anthropic client factory that handles configuration consistently\n\n## Acceptance Criteria\n\n- [ ] Epic verification uses the same LLM infrastructure as other components\n- [ ] Observability/logging is consistent with rest of system\n- [ ] MorphLLM routing works automatically when configured\n- [ ] No direct Anthropic SDK instantiation in epic verifier\n\n## References\n\n- File: `src/epic_verifier.py` - `ClaudeEpicVerificationModel`\n- Compare with: `src/codex_review.py` for LLM usage patterns\n- From code review iteration 3","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-30T15:50:11.429590042Z","created_by":"cyou","updated_at":"2025-12-30T17:38:55.313679513Z","closed_at":"2025-12-30T17:38:55.313679513Z","close_reason":"Closed"}
{"id":"mala-sp2s","title":"[Advisory] Legacy init removed from MalaOrchestrator","description":"## Context\nThis issue was auto-created by epic verification for epic `mala-cavk`.\n\n## Epic Description / Acceptance Criteria\nTitle: Epic: Architecture refactor - break up god classes\n\n# Architecture Refactor: High-Priority God Class Breakup\n\n**Spec**: `docs/2026-01-01-architecture-review.md`\n**Plan**: `docs/2026-01-01-architecture-refactor-plan.md`\n\n## Prerequisites\n\n**Depends on mala-iy6l** (Import-linter package restructure). The iy6l epic restructures the codebase into layer-based packages, and this refactor assumes those paths:\n- `src/orchestrator.py` → `src/orchestration/orchestrator.py`\n- `src/cli.py` → `src/cli/cli.py`\n\n## Goals\n- Reduce complexity and duplication in 3 high-priority areas identified in architecture review\n- Pure refactoring - no behavioral changes\n- Deliver as 3 incremental PRs that can be reviewed and merged independently\n\n## PRs (in order)\n1. **EventSink** - Create BaseEventSink to eliminate NullEventSink duplication (NullEventSink \u003c20 lines)\n2. **AgentSessionRunner** - Extract run_session into focused helpers (675 → \u003c100 lines)  \n3. **MalaOrchestrator** - Extract IssueExecutionCoordinator + remove legacy init (1565 → \u003c1000 lines)\n\n## Acceptance Criteria\n- [ ] NullEventSink reduced to \u003c20 lines\n- [ ] run_session reduced to \u003c100 lines\n- [ ] Legacy init removed from MalaOrchestrator\n- [ ] All existing tests pass\n- [ ] New unit tests for extracted helpers\n\n## Commit Scope\n- Range hint: b826537c90ea28c402742c605757be17820e0fc0^..4301154dfb4c127999d225d639f708c977ab399c\n- Commits:\n- 6817b912b7e448c22748fb6778e5a7c3d5582992 bd-mala-cavk.3: Fix ruff TC003 type-checking import violations\n- 99e411ab4383d9e7d840a4678d98b9d1cfb2205c bd-mala-cavk.3: Fix type annotations and linting issues in test files\n- 977be4d0c6064476546a918b59f5ad49f0c5f63c bd-mala-cavk.3: Extract IssueExecutionCoordinator from MalaOrchestrator\n- 4301154dfb4c127999d225d639f708c977ab399c bd-mala-jnah: Complete orphans_only propagation and add tests\n- ed70ba0d99d0c6bcfe02e781714e7d9fc63ba429 bd-mala-jnah: Add --orphans-only mode to filter non-epic issues\n- 942c6b2f8efd65b778f7f9c3036fbb05091d115e bd-mala-cavk.1: Fix protocol coverage tests to exclude ABCMeta helpers\n- b826537c90ea28c402742c605757be17820e0fc0 bd-mala-cavk.1: Create BaseEventSink, simplify NullEventSink\n- 9e7a3432c10286156f76215298af1c3d6edf1ad5 bd-mala-cavk.5: Add unit tests for extracted orchestration helpers\n- bed8d43b45cc1a6134b0b3cc7d3cd519d7bbaf2f bd-mala-cavk.5: Fix type narrowing in orchestrator factory method\n- ed05c003dcbfe8bdb629d950d5799ec1a831769e bd-mala-cavk.5: Reduce MalaOrchestrator to \u003c1000 lines\n- 46c0f46abccd2af19b1d68380e7957114133f76c bd-mala-cavk.2: Extract helpers from AgentSessionRunner.run_session\n- efb74872758e0863c8d0dd5b72ed0ff2f3a6fd0a bd-mala-cavk.2: Extract helpers from AgentSessionRunner.run_session\n- 6ed49e97da07d72095614485f055986285134b38 bd-mala-cavk.4: Extract helpers from AgentSessionRunner.run_session\n- 39923dfdf0bef6eb9e45ebf86a75a0ec52eb810a bd-mala-dhry: Make debug logging best-effort with opt-out\n- 64f762395351b6c5bfc81832766a84175c573abf bd-mala-dhry: Remove --debug-log CLI arg, always enable debug logging\n\n## Child Issues\n- mala-cavk.1\n- mala-cavk.2\n- mala-cavk.3\n- mala-cavk.4\n- mala-cavk.5\n- mala-dhry\n- mala-jnah\n\n## Unmet Criterion\nLegacy init removed from MalaOrchestrator\n\n## Evidence\nThe legacy __init__ method still exists at lines 121-220 with ~100 lines of compatibility logic that delegates to the factory method. While @overload decorators were removed, the main legacy initialization method remains.\n\n## Priority\nP3 (informational)\n\n## Resolution\nThis is advisory (P2/P3) and does not block epic closure. When complete, close this issue.\n","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-01T23:27:21.238176894Z","created_by":"cyou","updated_at":"2026-01-02T01:44:04.710375705Z","closed_at":"2026-01-02T01:44:04.710375705Z","close_reason":"Closed","labels":["auto_generated","epic_remediation:mala-cavk:7ba335f7ea3d3138e49d297d66af317c13dfd7604328c09b3ec29dbeb85e7684"],"dependencies":[{"issue_id":"mala-sp2s","depends_on_id":"mala-i8ke","type":"blocks","created_at":"2026-01-01T23:32:33.38477104Z","created_by":"daemon"}]}
{"id":"mala-sw4q","title":"use cerberus exclude flag to exclude .beads/* from its review","description":"## Context\n\nCerberus is the multi-model code review system used by mala. It reviews commits and generates review findings.\n\n## Problem\n\nCerberus is currently reviewing files in the .beads/ directory (the beads issue tracker database). These are auto-generated JSONL files that should not be reviewed.\n\n## Solution\n\nUse Cerberus's exclude flag to skip .beads/* files from review.\n\n## Files to Modify\n\n- Check how cerberus is invoked (likely in src/pipeline/ or src/orchestration/)\n- Add exclude pattern for .beads/*\n\n## Acceptance Criteria\n\n- [ ] .beads/ directory excluded from cerberus review\n- [ ] Existing review functionality unchanged","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T18:02:11.039651332Z","created_by":"cyou","updated_at":"2026-01-01T23:40:23.351324548Z","closed_at":"2026-01-01T23:40:23.351324548Z","close_reason":"Closed"}
{"id":"mala-t5m","title":"Cache file reads to avoid repeated full-file rereads","description":"## Problem\nAgents repeatedly read the same files multiple times within a single session, wasting tokens on content already in context.\n\n## Evidence from log analysis\n- `quality_gate.py`: read 27 times in one session\n- `beads_client.py`: read 12 times in one session\n- `spec_runner.py`: read 12 times\n- `test_quality_gate.py`: read 9 times\n- `test_validation.py`: read 7 times\n\nEach read sends 80-100k chars back to the model.\n\n## Solution\nOptions to consider:\n1. Track recently-read files by content hash; skip re-reading if unchanged\n2. Use targeted reads (specific line ranges/functions) instead of entire files\n3. Add guidance to agent prompts about avoiding redundant reads\n\n## Expected Impact\n~30% token reduction per session","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-29T00:43:41.156223108Z","created_by":"cyou","updated_at":"2025-12-29T01:59:27.876113447Z","closed_at":"2025-12-29T01:59:27.876113447Z","close_reason":"Closed"}
{"id":"mala-t84","title":"Orchestrator: implement run-level validation (Gate 4) after all issues complete","description":"Context:\n- Gate 4 from docs/quality-hardening-plan.md is designed but not implemented\n- E2E tests never run because orchestrator only uses ValidationScope.PER_ISSUE\n- run_validation field in run metadata is always null\n- E2ERunner exists and works, just not wired up\n\nCurrent state:\n- spec_runner.py:258 only runs E2E when scope == ValidationScope.RUN_LEVEL\n- orchestrator.py:884 always calls validation with scope=ValidationScope.PER_ISSUE\n- run_metadata.record_run_validation() exists but is never called\n- CLI supports --disable-validations=run-level-validate but there's nothing to disable\n\nRequired changes:\n1. After all issues complete in orchestrator.run(), run validation with RUN_LEVEL scope\n2. Build spec with ValidationScope.RUN_LEVEL (includes E2E by default)\n3. Run in clean worktree at current HEAD\n4. Record results via run_metadata.record_run_validation()\n5. On failure: spawn a fixer agent in the same run to address the issues (not a follow-up issue)\n   - The fixer agent gets the validation failure output as context\n   - Re-run Gate 4 after fixer completes\n   - Retry loop with max attempts (e.g., max_gate_retries)\n   - Only fail the run after retries exhausted\n\nWhy spawn in same run (not follow-up issue):\n- Follow-up issues can be missed due to --epic-id, --only-ids, --max-issues filters\n- Guarantees the validation failure is addressed before run completes\n- Matches user expectation of \"spawns another agent to fix any issues\"\n\nAcceptance criteria:\n- E2E tests run after all issues complete (when not disabled)\n- run_validation populated in run metadata JSON\n- --disable-validations=run-level-validate skips Gate 4\n- --disable-validations=e2e skips just E2E within Gate 4\n- On Gate 4 failure: fixer agent spawned with failure context\n- Fixer agent attempts to fix issues, then Gate 4 re-runs\n- Retry loop respects max attempts before failing run\n- Run exits non-zero only after retries exhausted\n\nTest plan:\n- Unit test: orchestrator calls run-level validation after issues complete\n- Unit test: run_validation recorded in metadata\n- Unit test: disable flags respected\n- Unit test: fixer agent spawned on Gate 4 failure\n- Unit test: retry loop respects max attempts\n- Integration: full run with E2E passing\n- Integration: E2E failure triggers fixer and retry\n","notes":"Quality gate failed: Quality gate failed: Missing validation commands: ruff format, ruff check, pytest, ty check, uv sync; No progress: commit unchanged and no new validation evidence\nLog: /home/cyou/.claude/projects/-home-cyou-mala/eeea6f46-b9c3-46c1-a617-3b63df0a48d1.jsonl","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-27T19:37:38.163794008Z","updated_at":"2025-12-27T23:17:19.540957371Z","closed_at":"2025-12-27T23:17:19.540960361Z","labels":["needs-followup"]}
{"id":"mala-tci","title":"Update README for new CLI defaults and flags","description":"README still shows max-agents default as 3 and doesn't document --epic, --only, or --no-truncate. Update usage + CLI options table to reflect current behavior (unlimited max-agents by default).","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-26T15:34:30.211575764Z","updated_at":"2025-12-26T18:40:12.900416446Z","closed_at":"2025-12-26T18:40:12.900416446Z","close_reason":"Closed"}
{"id":"mala-tkz","title":"Truncate pytest output to reduce token usage","description":"## Problem\nFull pytest output with verbose mode (-v) generates 10k+ chars per run. Sessions have 9-15 pytest invocations, feeding massive amounts of test output back to the model.\n\n## Evidence\n- mala-51q.2: 15 pytest runs × ~10k chars = ~150k chars of pytest output\n- mala-51q.4: 12 pytest runs\n- mala-869.5: 9 pytest runs\n\nMost of this is PASSED test names that don't help the agent.\n\n## Solution\nDefault to minimal pytest output:\n```\npytest -q --maxfail=1 --disable-warnings --tb=short\n```\n\nOr:\n- Capture full output to file\n- Only return summary + failures to the model\n- Tail small chunk if verbose output needed\n\n## Expected Impact\n~50% reduction in pytest-related tokens","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-29T00:43:41.201104836Z","created_by":"cyou","updated_at":"2025-12-29T01:44:01.732004998Z","closed_at":"2025-12-29T01:44:01.732004998Z","close_reason":"Closed"}
{"id":"mala-tlb3","title":"smarter handling of blocked agents - timeout should not include blocked time, or exit early and try later?","status":"blocked","priority":2,"issue_type":"task","created_at":"2026-01-02T03:09:07.782510435Z","created_by":"cyou","updated_at":"2026-01-02T03:09:14.774975213Z"}
{"id":"mala-u1w","title":"Test: tiny README change","status":"tombstone","priority":2,"issue_type":"task","created_at":"2025-12-25T19:05:18.089001881Z","updated_at":"2025-12-25T19:08:44.858511785Z","close_reason":"Closed","deleted_at":"2025-12-25T19:08:44.858511785Z","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"mala-vdf","title":"Offload bd/git calls from async loop","description":"Context:\n- Orchestrator uses blocking subprocess calls via BeadsClient inside the async loop, which can stall other agent tasks.\n- Needs verification: confirm bd/git commands can hang long enough to impact agent receive loops.\n\nScope:\n- In: move bd/git calls used in the orchestrator loop to async-friendly execution (asyncio.to_thread or async subprocess) with timeouts; update orchestrator to await these calls.\n- Out: replacing the bd CLI or changing issue selection logic.\n\nAcceptance Criteria:\n- Slow or hanging bd commands do not block other agent tasks.\n- Timeouts are handled with clear warnings and safe fallback behavior.\n\nTest Plan:\n- TDD: add a test that simulates a slow bd command, implement async/offload behavior, then run orchestrator tests.\n\nNotes for Agent:\n- Keep the public BeadsClient API consistent unless updating call sites in orchestrator.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T17:35:56.818359351Z","updated_at":"2025-12-26T18:58:44.392606409Z","closed_at":"2025-12-26T18:58:44.392606409Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-vdf","depends_on_id":"mala-jnq","type":"parent-child","created_at":"2025-12-26T17:36:15.723438514Z","created_by":"daemon"},{"issue_id":"mala-vdf","depends_on_id":"mala-dqp","type":"blocks","created_at":"2025-12-26T17:36:21.612596465Z","created_by":"daemon"}]}
{"id":"mala-ved","title":"Ensure logs are written incrementally during execution","description":"Context:\n- Logs should be flushed/written as events happen, not buffered until exit.\n- Currently if mala is interrupted or crashes, log data may be lost.\n\nScope:\n- In: review log writing code paths; ensure flush after each log entry or batch.\n- Out: log format changes; new log destinations.\n\nAcceptance Criteria:\n- JSONL logs are written incrementally (fsync or flush after writes).\n- Interrupting mala mid-run preserves all logs up to that point.\n- No significant performance regression from flush frequency.\n\nTest Plan:\n- Manual: start a run, kill -9 mid-execution, verify logs are complete up to kill point.\n- Unit: mock file ops to verify flush calls.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-27T01:09:55.08491113Z","updated_at":"2025-12-31T18:02:19.511745246Z","closed_at":"2025-12-31T18:02:19.511745246Z","close_reason":"Closed"}
{"id":"mala-vl8t","title":"[Review] tests/test_event_sink.py:5: [P2] Test file import path changed from src.event_sink to src.infra.io.event_sink","description":"## Review Finding\n\nThis issue was auto-created from a P2 review finding.\n\n**Source issue:** mala-40pg.2\n**Reviewer:** claude\n**Location:** tests/test_event_sink.py:5\n\n## Details\n\nThe test file import was changed from `src.event_sink` to `src.infra.io.event_sink`. While this may be correct after the package restructure, this change was not mentioned in the task scope and could indicate either an unrelated fix bundled into this commit or a necessary update for tests to pass. The change should be documented if intentional.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T19:33:10.85436426Z","created_by":"cyou","updated_at":"2026-01-01T20:08:55.95114542Z","closed_at":"2026-01-01T20:08:55.95114542Z","close_reason":"Closed","labels":["auto_generated","review_finding","review_finding:1922633bfa88","source:mala-40pg.2"]}
{"id":"mala-vrm","title":"Refactor: move implementer prompt to src/prompts/","description":"## Context\nThe implementer prompt lives at `src/implementer_prompt.md`. The proposed structure puts prompts under `src/prompts/`.\n\n## Scope\nMove the prompt file only. Do **not** update loaders or tests in this issue; integration will wire it up later.\n\n### Files\n- Move: `src/implementer_prompt.md` → `src/prompts/implementer_prompt.md`\n\n## Requirements\n- Prompt content must be unchanged after move.\n\n## Acceptance Criteria\n- File exists at `src/prompts/implementer_prompt.md` with identical content.\n- No other files are modified in this issue.\n\n## Notes\n- Integration issue will update imports/tests referencing `IMPLEMENTER_PROMPT_TEMPLATE`.\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T19:54:51.200086139Z","updated_at":"2025-12-25T20:08:18.586126987Z","closed_at":"2025-12-25T20:08:18.586126987Z","close_reason":"Closed"}
{"id":"mala-w85r","title":"[Review] src/domain/validation/code_pattern_matcher.py:39-46: [P2] Prevent **/ from matching within a filename","description":"## Review Finding\n\nThis issue was auto-created from a P2 review finding.\n\n**Source issue:** mala-fdp1.6\n**Reviewer:** codex\n**Location:** src/domain/validation/code_pattern_matcher.py:39-46\n\n## Details\n\n`**/` is translated as `.*` plus an optional slash, so patterns like `**/test_*.py` will incorrectly match `mytest_main.py` (no slash) and `src/abctest.py`. In glob semantics, `**/` should only match whole directory segments (including zero), not partial prefixes. Consider translating `**/` to something like `(?:.*/)?` or `(?:[^/]+/)*` so a slash is required if `**` consumes characters.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T03:15:34.530811916Z","created_by":"cyou","updated_at":"2026-01-02T03:24:09.994891692Z","closed_at":"2026-01-02T03:24:09.994891692Z","close_reason":"Closed","labels":["auto_generated","review_finding","review_finding:866693220841","source:mala-fdp1.6"]}
{"id":"mala-w8w","title":"Epic: Code health fixes from 2025-12-26 review","description":"Context:\n- Umbrella epic for code health findings from the 2025-12-26 review.\n- Groups small fixes in orchestrator startup, validation runner robustness, and repo hygiene.\n\nScope:\n- In: child issues addressing specific review findings.\n- Out: larger validation pipeline refactors and new feature work.\n\nAcceptance Criteria:\n- All child issues are closed.\n\nTest Plan:\n- Covered by each child issue.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-26T23:06:47.086956645Z","updated_at":"2025-12-27T09:03:57.370866039Z","closed_at":"2025-12-27T09:03:57.370866039Z","close_reason":"All children completed"}
{"id":"mala-w8w.1","title":"Orchestrator startup: preserve env + create nested lock dir","description":"Context:\n- Needs verification: ClaudeAgentOptions may treat env as a full replacement, which can drop required vars when tools run.\n- agent_env is built in src/orchestrator.py:281 without inheriting os.environ.\n- LOCK_DIR is created in src/orchestrator.py:669 without parents=True, which fails for nested MALA_LOCK_DIR paths.\n\nScope:\n- In: merge os.environ into agent_env and ensure LOCK_DIR mkdir uses parents=True.\n- Out: changes to permission modes, hook behavior, or tool restrictions.\n\nAcceptance Criteria:\n- Agent tool calls see inherited env vars plus lock overrides (PATH/LOCK_DIR/AGENT_ID/REPO_NAMESPACE).\n- Orchestrator startup succeeds when MALA_LOCK_DIR points to a nested, non-existent directory.\n- Behavior of lock scripts and PATH resolution remains unchanged.\n\nTest Plan:\n- TDD: add failing test(s) in tests/test_orchestrator.py for env inheritance and nested lock dir creation.\n- Implement the fix, then run uv run pytest tests/test_orchestrator.py.\n\nNotes for Agent:\n- If SDK already merges envs, document/verify and keep behavior explicit.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-26T23:06:57.435746036Z","updated_at":"2025-12-27T07:06:35.564633929Z","closed_at":"2025-12-27T07:06:35.564633929Z","close_reason":"Closed","labels":["needs-verification"],"dependencies":[{"issue_id":"mala-w8w.1","depends_on_id":"mala-w8w","type":"parent-child","created_at":"2025-12-26T23:06:57.442345813Z","created_by":"daemon"}]}
{"id":"mala-w8w.2","title":"ValidationRunner robustness: handle timeout text + valid E2E flags","description":"Context:\n- _run_command decodes TimeoutExpired stdout/stderr as bytes in src/validation.py:194, which can raise if they are already strings.\n- _run_e2e builds a mala run command with --no-post-validate/--no-e2e in src/validation.py:235, but these flags are not in the CLI.\n\nScope:\n- In: make timeout handling robust for str/bytes outputs; remove or replace unsupported flags in the E2E command.\n- Out: implementing the broader validation pipeline plan or new CLI flags beyond what’s needed for compatibility.\n\nAcceptance Criteria:\n- Timeout handling never raises when TimeoutExpired outputs are strings.\n- E2E command uses only supported CLI flags.\n- Existing validation behavior (exit codes, stderr/stdout tailing) is preserved.\n\nTest Plan:\n- TDD: add failing tests in tests/test_validation.py for string TimeoutExpired outputs and E2E command construction.\n- Implement fixes, then run uv run pytest tests/test_validation.py.\n\nNotes for Agent:\n- Keep changes localized to validation.py and its tests.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-26T23:07:13.48342038Z","updated_at":"2025-12-27T06:19:26.498789919Z","closed_at":"2025-12-27T06:19:26.498789919Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-w8w.2","depends_on_id":"mala-w8w","type":"parent-child","created_at":"2025-12-26T23:07:13.489971047Z","created_by":"daemon"}]}
{"id":"mala-w8w.3","title":"Remove dist artifacts and ignore dist/ outputs","description":"Context:\n- dist/ contains built artifacts (wheel/tarball) that can go stale and confuse releases.\n- Repo currently lacks a .gitignore entry for dist/ (file does not exist in tree).\n\nScope:\n- In: remove tracked dist artifacts and add dist/ to .gitignore.\n- Out: build system changes or release automation updates.\n\nAcceptance Criteria:\n- dist/ artifacts are removed from git history (tracked files deleted).\n- .gitignore includes dist/ to prevent reintroduction.\n\nTest Plan:\n- None (file cleanup only).\n\nNotes for Agent:\n- Ensure no other generated paths are unintentionally removed.","status":"closed","priority":4,"issue_type":"chore","created_at":"2025-12-26T23:07:20.726896981Z","updated_at":"2025-12-27T06:39:09.897140907Z","closed_at":"2025-12-27T06:39:09.897140907Z","close_reason":"Already resolved: dist/ is in .gitignore and no artifacts are tracked","dependencies":[{"issue_id":"mala-w8w.3","depends_on_id":"mala-w8w","type":"parent-child","created_at":"2025-12-26T23:07:20.735168885Z","created_by":"daemon"}]}
{"id":"mala-wd1","title":"Refactor: extract Claude SDK subagent loop","description":"## Context\nThe Claude SDK receive loop is currently embedded in `MalaOrchestrator.run_implementer` in `src/main.py`. It should be extracted to a reusable `src/agent_loop.py` module.\n\n## Scope\nCreate `src/agent_loop.py` only. Do **not** modify `src/main.py` in this issue; integration will wire it up later.\n\n### Files\n- Add: `src/agent_loop.py`\n\n## Requirements\n- The extracted loop should be the same logic as today:\n  - `async with ClaudeSDKClient(options=options) as client:`\n  - `await client.query(prompt)`\n  - `async for message in client.receive_response(): ...`\n- It must still:\n  - Handle `AssistantMessage` / `ResultMessage` logging exactly as today.\n  - Support JSONL logging and Braintrust logging (existing behavior).\n- Return the final result text and any needed success/summary data in a way `run_implementer` can use.\n\n## Acceptance Criteria\n- `src/agent_loop.py` exists with the extracted loop behavior.\n- No other files are modified in this issue.\n\n## Notes\n- Integration issue will delegate to this module from `src/main.py`.\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T19:54:51.165716848Z","updated_at":"2025-12-25T20:11:59.449563429Z","closed_at":"2025-12-25T20:11:59.449563429Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-wd1","depends_on_id":"mala-1by","type":"blocks","created_at":"2025-12-25T20:06:47.467342748Z","created_by":"daemon"}]}
{"id":"mala-wg1","title":"Add baseline coverage functions to coverage.py","description":"Context:\n- `coverage.py` currently only parses and checks against fixed thresholds\n- Need new functions: `get_baseline_coverage()` and `is_baseline_stale()`\n- Must distinguish \"missing\" (returns None) from \"parse error\" (raises/fails)\n- Staleness detection: compare mtime vs last commit time + check dirty working tree\n\nScope:\n- In: Add `get_baseline_coverage(report_path: Path) -\u003e float | None`\n- In: Add `is_baseline_stale(report_path: Path, repo_path: Path) -\u003e bool`\n- In: Update `check_coverage_threshold` to accept `min_percent: float | None`\n- In: Update `parse_and_check_coverage` signature similarly\n- Out: Auto-refresh logic (that's in spec_runner.py)\n\nAcceptance Criteria:\n- `get_baseline_coverage()` returns percentage if file exists and valid, None if missing, raises on parse errors\n- `is_baseline_stale()` returns True if mtime \u003c last commit time OR repo is dirty\n- `is_baseline_stale()` handles non-git repos gracefully (returns True if git commands fail)\n- `check_coverage_threshold(result, None)` returns PASSED\n\nTest Plan:\n- TDD: Write failing tests for each new function\n- Test missing file → returns None\n- Test valid file → returns percentage\n- Test malformed XML → raises error\n- Test stale mtime → returns True\n- Test dirty repo → returns True\n- Test non-git repo → handles gracefully\n\nNotes for Agent:\n- Use `git log -1 --format=%ct` for last commit time\n- Use `git status --porcelain` to check dirty status\n- Wrap git commands in try/except for non-git fallback\n- Primary files: src/validation/coverage.py, tests/test_coverage.py","status":"tombstone","priority":1,"issue_type":"task","created_at":"2025-12-27T18:13:44.092339695Z","updated_at":"2025-12-27T18:20:40.62834641Z","labels":["coverage"],"deleted_at":"2025-12-27T18:20:40.62834641Z","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"mala-wjoc","title":"[Review] src/domain/validation/tool_name_extractor.py:195: [P3] Redundant truthy check in _is_meaningful_tool","description":"## Review Finding\n\nThis issue was auto-created from a P3 review finding.\n\n**Source issue:** mala-fdp1.5\n**Reviewer:** claude\n**Location:** src/domain/validation/tool_name_extractor.py:195\n\n## Details\n\nLine 195 has `if tool_name` as a guard on `tool_name.split()`, but this is already guaranteed to be truthy due to the `if not tool_name: return False` check on line 192.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-02T03:17:47.845864972Z","created_by":"cyou","updated_at":"2026-01-02T03:21:30.891492058Z","closed_at":"2026-01-02T03:21:30.891492058Z","close_reason":"Closed","labels":["auto_generated","review_finding","review_finding:f26991de2d0e","source:mala-fdp1.5"]}
{"id":"mala-wp97","title":"[Remediation] Linting passes: `uvx ruff check . \u0026\u0026 uvx ty check`","description":"## Context\nThis issue was auto-created by epic verification for epic `mala-bp3h`.\n\n## Unmet Criterion\nLinting passes: `uvx ruff check . \u0026\u0026 uvx ty check`\n\n## Evidence\nNo evidence in the diff that final linting verification has been completed\n\n## Severity\nmajor\n\n## Resolution\nAddress this criterion to unblock epic closure. When complete, close this issue.\n","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-01T03:35:30.909413035Z","created_by":"cyou","updated_at":"2026-01-01T03:38:46.233189884Z","closed_at":"2026-01-01T03:38:46.233189884Z","close_reason":"Closed","labels":["auto_generated","epic_remediation:mala-bp3h:51fd3d3faa0e69d47d74462ad43e803b6d5a21d31c2d45f38d05984eb9b5a718"],"dependencies":[{"issue_id":"mala-wp97","depends_on_id":"mala-bp3h","type":"parent-child","created_at":"2026-01-01T03:37:58.124774915Z","created_by":"daemon"}]}
{"id":"mala-wqwk","title":"[Review] tests/test_run_metadata.py:1047-1079: [P2] test_cleanup_is_idempotent doesn't enable debug logging","description":"## Review Finding\n\nThis issue was auto-created from a P2 review finding.\n\n**Source issue:** mala-dhry\n**Reviewer:** claude\n**Location:** tests/test_run_metadata.py:1047-1079\n\n## Details\n\nThe test `test_cleanup_is_idempotent` doesn't remove `MALA_DISABLE_DEBUG_LOG` from the environment (unlike other tests in this class that use `os.environ.pop(\"MALA_DISABLE_DEBUG_LOG\", None)`). As a result, `metadata.debug_log_path` will be `None` and the test never actually calls `cleanup_debug_logging()`. The test passes but doesn't verify the intended idempotent behavior when debug logging is active.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T22:54:29.94785431Z","created_by":"cyou","updated_at":"2026-01-02T01:08:27.782532679Z","closed_at":"2026-01-02T01:08:27.782532679Z","close_reason":"Closed","labels":["auto_generated","review_finding","review_finding:26967d64b167","source:mala-dhry"],"dependencies":[{"issue_id":"mala-wqwk","depends_on_id":"mala-cw6h","type":"blocks","created_at":"2026-01-01T23:32:33.341210575Z","created_by":"daemon"}]}
{"id":"mala-wr1","title":"Skip uv sync in implementer if dependencies unchanged","description":"## Context\nThe implementer prompt currently runs `uv sync` at the start of every implementation. This is wasteful when dependencies haven't changed.\n\n## Problem\nRunning `uv sync` on every implementation adds unnecessary overhead when pyproject.toml/uv.lock haven't been modified.\n\n## Solution\nUpdate the implementer prompt to only run `uv sync` if:\n1. pyproject.toml has been modified, OR\n2. uv.lock has been modified, OR\n3. .venv doesn't exist\n\n## Acceptance Criteria\n- Implementer prompt conditionally runs `uv sync`\n- Dependencies are still installed when needed\n- Unnecessary syncs are skipped\n\n## Files to Modify\n- src/prompts/implementer_prompt.md\n","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-27T06:44:39.140232276Z","updated_at":"2025-12-27T09:03:57.289712504Z","closed_at":"2025-12-27T09:03:57.289712504Z","close_reason":"Closed"}
{"id":"mala-wrtg","title":"[Review] tests/test_orchestrator.py:580-591: [P2] Keep max_issues test isolated from real bd calls","description":"## Review Finding\n\nThis issue was auto-created from a P2 review finding.\n\n**Source issue:** mala-rmxf\n**Reviewer:** codex\n**Location:** tests/test_orchestrator.py:580-591\n\n## Details\n\n`mock_spawn` now returns a real task (`asyncio.create_task`) so the coordinator registers it and runs `_finalize_issue_result`, which calls `beads.close_async` (and other side-effectful paths). Because this test does not mock those methods, it can try to execute `bd close` and fail with FileNotFoundError or mutate real state. To keep this a unit test, stub `beads.close_async` / `_finalize_issue_result`, or return a dummy task and bypass registration.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T01:52:47.978844785Z","created_by":"cyou","updated_at":"2026-01-02T01:56:14.771577192Z","closed_at":"2026-01-02T01:56:14.771577192Z","close_reason":"Closed","labels":["auto_generated","review_finding","review_finding:203ffdd754e4","source:mala-rmxf"]}
{"id":"mala-wya","title":"Prompt cleanup: full validation, mutex rule, REPO_NAMESPACE","description":"Context:\n- Track A1 requires removing guidance that allows skipping tests and replacing with a single clear policy (docs/coordination-plan-codex.md:26-28, 81-83).\n- Implementer prompt includes Speed/Scope Guardrails and \"run tests only on touched files\" guidance (src/prompts/implementer_prompt.md:138-150).\n- Track A3 requires setting REPO_NAMESPACE in the prompt to repo root (docs/coordination-plan-codex.md:33-35).\n\nScope:\n- In: remove Speed/Scope Guardrails section and any skip-tests or blame-pre-existing-failures language.\n- In: require the full validation suite (uv sync, pytest, ruff check/format, ty check) and add the test mutex rule for repo-wide commands.\n- In: export REPO_NAMESPACE to the repo root in the lock environment setup.\n- Out: no lock script or orchestrator logic changes.\n\nAcceptance Criteria:\n- Prompt no longer contains Speed/Scope Guardrails or \"run only touched files\" guidance.\n- Prompt explicitly requires full validation suite and a mutex before repo-wide commands.\n- REPO_NAMESPACE export is present and uses the repo root placeholder.\n\nTest Plan:\n- Doc-only: spot-check rendered prompt with sample values.\n\nNotes for Agent:\n- Keep wording aligned with shared-worktree mode.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T16:43:25.110736233Z","updated_at":"2025-12-26T17:03:04.73672941Z","closed_at":"2025-12-26T17:03:04.73672941Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-wya","depends_on_id":"mala-4w7","type":"parent-child","created_at":"2025-12-26T16:47:52.95649035Z","created_by":"daemon"}]}
{"id":"mala-x00","title":"Epic: Validation integration (gates + orchestrator)","description":"Context:\n- Integrates validation modules into gates, CLI, orchestrator, and run metadata.\n- Derived from docs/quality-hardening-plan.md (v5).\n\nScope:\n- In: EvidenceGate updates, CLI parsing, orchestrator pipeline, run metadata.\n- Out: validation module internals (handled in validation epic).\n\nAcceptance Criteria:\n- All child issues closed and pipeline wired end-to-end.\n\nTest Plan:\n- Defer to child issue test plans; run full suite at the end.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-26T23:00:01.628605121Z","updated_at":"2025-12-27T05:57:33.781911141Z","closed_at":"2025-12-27T05:57:33.781911141Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-x00","depends_on_id":"mala-ng3","type":"blocks","created_at":"2025-12-26T23:00:26.410106574Z","created_by":"daemon"},{"issue_id":"mala-x00","depends_on_id":"mala-e0i","type":"blocks","created_at":"2025-12-26T23:00:26.420942397Z","created_by":"daemon"},{"issue_id":"mala-x00","depends_on_id":"mala-2eu","type":"blocks","created_at":"2025-12-26T23:00:26.432302435Z","created_by":"daemon"},{"issue_id":"mala-x00","depends_on_id":"mala-9mb","type":"blocks","created_at":"2025-12-26T23:00:26.443299296Z","created_by":"daemon"}]}
{"id":"mala-x5x","title":"Skip redundant linting when no files changed","description":"## Problem\nAgents run ruff check/format and ty check repeatedly even when no files have changed since the last run. This wastes both wall time and tokens on identical output.\n\n## Evidence\nSame lint/test commands repeated 3-4x with no evidence of new commits or file changes, particularly in sessions that hit the 'No progress' failure.\n\n## Solution\nBefore running lint commands:\n1. Check if any tracked files have changed since last lint run (git status or file mtimes)\n2. If no changes, skip the command and report 'No changes since last check'\n3. Cache the commit SHA or file hashes when lint passes\n\n## Expected Impact\n~10% token reduction, minor wall time improvement\n\n## Notes\nLower priority than progress gate (mala-9lp) since that addresses the root cause of retry loops.","notes":"Quality gate failed: Timeout after 30 minutes\nLog: /home/cyou/.claude/projects/-home-cyou-mala/6e48ef51-484e-4ce7-954e-c25425c7e1a0.jsonl","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T00:43:50.516069141Z","created_by":"cyou","updated_at":"2025-12-29T15:01:02.389423561Z","closed_at":"2025-12-29T15:01:02.389423561Z","close_reason":"SpecValidationRunner now uses lint cache (src/validation/lint_cache.py) to skip lint/type/format commands when git state unchanged.","labels":["needs-followup"]}
{"id":"mala-xm2","title":"Codex reviewer fails on retry: only sees incremental diff, not full scope","description":"## Problem\n\nAfter an initial Codex review fails and the subagent makes fixes, the subsequent Codex review only sees the incremental diff (fix commit vs previous commit) rather than the cumulative diff from baseline. This causes the reviewer to incorrectly fail with 'scope incomplete' because the fix commit alone doesn't address all scope items.\n\n### Current Flow\n1. Subagent creates commit A with full implementation\n2. Codex reviews 'commit A vs parent' → sees full scope\n3. Review fails (e.g., missing test coverage)\n4. Subagent creates commit B with fix\n5. Codex reviews 'commit B vs commit A' → only sees fix, not full implementation\n6. Codex fails: 'scope incomplete - diff doesn't address all scope items'\n\n### Root Cause\n`codex_review.py:66` uses:\n```\nReview the diff introduced by commit {commit_sha} (vs its parent).\n```\n\nNo baseline commit hash is tracked. `RetryState` has `baseline_timestamp` (for rejecting stale commits) and `previous_commit_hash` (for no-progress detection), but neither provides a diff range for cumulative review.\n\n## Solution\n\nTrack baseline commit hash and review cumulative diff:\n\n1. Add `baseline_commit_hash: str | None = None` to `RetryState`\n2. Capture `git rev-parse HEAD` before starting the subagent\n3. Add `baseline_commit` parameter to `run_codex_review()`\n4. Update `CODEX_REVIEW_PROMPT` to review `baseline..current` diff range\n\n## In:\n- `src/orchestrator.py`: Add `baseline_commit_hash` to `RetryState`, capture before agent starts, pass to review\n- `src/codex_review.py`: Add `baseline_commit` parameter, update prompt to use diff range\n\n## Out:\n- Codex CLI changes\n- Alternative solutions (thread continuation, commit squashing)","acceptance_criteria":"- Codex reviewer sees cumulative diff on retry (baseline to latest commit)\n- Scope verification works correctly across multiple fix commits\n- Tests verify retry scenario with baseline tracking","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-12-27T22:34:06.489052346Z","updated_at":"2025-12-27T23:46:06.961276862Z","closed_at":"2025-12-27T23:46:06.961276862Z","close_reason":"Closed"}
{"id":"mala-xv8","title":"Epic: A3 Canonical lock keys","description":"Context:\n- Track A3 requires setting REPO_NAMESPACE, normalizing paths before hashing, and updating lock tests (docs/coordination-plan-codex.md:33-36).\n\nScope:\n- In: coordinate child tasks for Python helper, shell scripts, and test updates.\n- Out: does not implement changes directly.\n\nAcceptance Criteria:\n- All child tasks for A3 are completed and locks are canonicalized end-to-end.\n\nTest Plan:\n- N/A (handled by child tasks).\n\nNotes for Agent:\n- Use parent-child relationships for A3 sub-tasks.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-26T16:43:43.874044032Z","updated_at":"2025-12-26T17:12:06.484854779Z","closed_at":"2025-12-26T17:12:06.484854779Z","close_reason":"All children completed","dependencies":[{"issue_id":"mala-xv8","depends_on_id":"mala-4w7","type":"parent-child","created_at":"2025-12-26T16:47:52.985551137Z","created_by":"daemon"}]}
{"id":"mala-xv8.1","title":"Canonicalize Python lock key generation","description":"Context:\n- Track A3 requires path normalization and repo namespace before hashing (docs/coordination-plan-codex.md:33-35).\n- _lock_key currently uses raw filepath without normalization (src/tools/locking.py:22-34).\n\nScope:\n- In: normalize file paths (resolve symlinks, repo-relative to REPO_NAMESPACE) before hashing in _lock_key/_lock_path.\n- In: ensure absolute and relative paths for the same file resolve to the same key.\n- Out: no shell script changes (handled separately).\n\nAcceptance Criteria:\n- _lock_key produces identical keys for equivalent absolute/relative paths within the same repo namespace.\n- Repo namespace prefix remains part of the canonical key.\n- Unit tests cover normalization and namespace behavior.\n\nTest Plan:\n- TDD: add failing tests in a new tests/test_locking_key.py for normalization cases.\n- Implement locking.py changes, update tests to pass.\n- Run uv run pytest tests/test_locking_key.py.\n\nNotes for Agent:\n- Assume REPO_NAMESPACE is set to the repo root in the prompt.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T16:43:52.981798811Z","updated_at":"2025-12-26T17:00:55.334823293Z","closed_at":"2025-12-26T17:00:55.334823293Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-xv8.1","depends_on_id":"mala-xv8","type":"parent-child","created_at":"2025-12-26T16:43:52.990309133Z","created_by":"daemon"}]}
{"id":"mala-xv8.2","title":"Canonicalize lock scripts + update script tests","description":"Context:\n- Track A3 requires path normalization before hashing for lock keys (docs/coordination-plan-codex.md:33-35).\n- Lock scripts currently hash raw input paths (src/scripts/lock-try.sh:20-31).\n- Script-level tests exercise lock scripts behavior (tests/test_lock_scripts.py).\n\nScope:\n- In: update lock-try.sh, lock-check.sh, lock-holder.sh, lock-release.sh to normalize paths (resolve symlinks, repo-relative to REPO_NAMESPACE) before hashing.\n- In: update tests/test_lock_scripts.py to cover normalization and namespace behavior for scripts.\n- Out: no Python locking helper changes (handled separately).\n\nAcceptance Criteria:\n- Scripts generate the same lock file for equivalent absolute/relative paths within the same repo namespace.\n- REPO_NAMESPACE is applied after normalization.\n- tests/test_lock_scripts.py includes cases for normalization and passes.\n\nTest Plan:\n- TDD: add failing tests in tests/test_lock_scripts.py for normalization cases.\n- Implement script changes, update tests to pass.\n- Run uv run pytest tests/test_lock_scripts.py.\n\nNotes for Agent:\n- Use portable path normalization (realpath/readlink fallback) to keep Linux/macOS compatibility.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T16:44:02.611587643Z","updated_at":"2025-12-26T17:02:29.674397068Z","closed_at":"2025-12-26T17:02:29.674397068Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-xv8.2","depends_on_id":"mala-xv8","type":"parent-child","created_at":"2025-12-26T16:44:02.621218247Z","created_by":"daemon"}]}
{"id":"mala-xv8.3","title":"Update SDK/integration lock tests for canonical keys","description":"Context:\n- Track A3 calls out updating slow SDK lock tests and helpers to match hashed naming (docs/coordination-plan-codex.md:33-36).\n- tests/test_lock_sdk_integration.py uses raw path-to-lock-name mapping (tests/test_lock_sdk_integration.py:82-91).\n- tests/test_lock_integration.py builds lock keys without path normalization (tests/test_lock_integration.py:24-40).\n\nScope:\n- In: update lock helper functions in tests/test_lock_sdk_integration.py and tests/test_lock_integration.py to match canonicalized, hashed lock key behavior.\n- In: add or adjust test cases to include absolute/relative normalization and REPO_NAMESPACE behavior.\n- Out: no script or Python locking helper changes.\n\nAcceptance Criteria:\n- SDK and integration tests align with canonicalized lock key behavior.\n- Tests cover normalization and namespace scenarios and pass.\n\nTest Plan:\n- TDD: update tests to assert new canonical key behavior (fail first).\n- Adjust helper functions and fixtures, then re-run tests.\n- Run uv run pytest tests/test_lock_sdk_integration.py tests/test_lock_integration.py.\n\nNotes for Agent:\n- Keep SDK tests fast; avoid introducing new long-running steps.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T16:44:13.175373837Z","updated_at":"2025-12-26T17:07:58.871392452Z","closed_at":"2025-12-26T17:07:58.871392452Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-xv8.3","depends_on_id":"mala-xv8","type":"parent-child","created_at":"2025-12-26T16:44:13.184089977Z","created_by":"daemon"}]}
{"id":"mala-y3b","title":"Tmux-like TUI with vertical logs","description":"Terminal UI similar to tmux: vertical log panes, select individual agent, interact with it directly","status":"blocked","priority":4,"issue_type":"feature","created_at":"2025-12-28T06:21:39.378928608Z","updated_at":"2025-12-28T06:25:04.561977739Z"}
{"id":"mala-y9i","title":"Epic: Healthcheck fixes (correctness + validation)","description":"Tracks fixes from the latest code health review: quality gate correctness, coverage reporting, failed-run metadata, and env override behavior. Parent epic only; children contain detailed scopes, AC, and tests.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-27T17:23:51.264003246Z","updated_at":"2025-12-27T19:21:06.374890315Z","closed_at":"2025-12-27T19:21:06.374890315Z","close_reason":"All children completed"}
{"id":"mala-y9i.1","title":"Quality gate should fail on non-zero validation exits","description":"Context:\n- Quality gate only checks for presence of validation commands in JSONL logs, not whether they succeeded (`src/quality_gate.py`).\n- This can mark issues as successful even when pytest/ruff/ty failed, risking broken changes slipping through.\n- Verify Claude JSONL includes tool_result exit status; if not, adjust parsing fallback accordingly.\n\nScope:\n- In: parse Bash tool_result entries to capture exit status per command kind and fail the gate on any non-zero exit.\n- In: include non-zero exit details in failure reasons to aid follow-up.\n- In: add/adjust tests in `tests/test_quality_gate.py` for success vs failure evidence.\n- Out: changing which validations are required or orchestrator retry policy.\n\nAcceptance Criteria:\n- Gate fails when a required validation command ran but exited non-zero.\n- Gate passes only when required validation commands ran and exited 0.\n- Resolution markers (ISSUE_NO_CHANGE/ISSUE_OBSOLETE) still bypass validation evidence checks.\n\nTest Plan:\n- TDD: add a failing test with JSONL fixture where pytest exits non-zero.\n- Implement minimal parser change; update fixtures as needed.\n- Run `uv run pytest tests/test_quality_gate.py`.\n\nNotes for Agent:\n- Ensure command matching stays consistent with ValidationSpec detection patterns.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-27T17:24:24.649685599Z","updated_at":"2025-12-27T18:32:55.300250022Z","closed_at":"2025-12-27T18:32:55.300250022Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-y9i.1","depends_on_id":"mala-y9i","type":"parent-child","created_at":"2025-12-27T17:24:24.657898438Z","created_by":"daemon"}]}
{"id":"mala-y9i.2","title":"Generate coverage.xml in spec validation","description":"Context:\n- Spec validation checks for `coverage.xml`, but the pytest command in `build_validation_spec` does not generate XML reports (`src/validation/spec.py`).\n- This causes coverage validation to fail with \"report not found\" even when tests run.\n- Needs verification: confirm current test command/output behavior in the runtime environment.\n\nScope:\n- In: when coverage is enabled, add `--cov=src` and `--cov-report=xml` (and `--cov-branch` if required by policy) to the pytest command built in `build_validation_spec`.\n- In: update/extend tests (e.g., `tests/test_spec.py` or `tests/test_validation.py`) to assert XML coverage is generated and consumed.\n- Out: changing coverage thresholds or parsing logic.\n\nAcceptance Criteria:\n- A spec-based validation run produces `coverage.xml` without manual steps.\n- Coverage checks pass/fail based on threshold, not missing file errors.\n- Existing coverage parsing behavior remains unchanged.\n\nTest Plan:\n- TDD: add a failing test that expects XML coverage generation in spec pytest command.\n- Implement minimal change in `build_validation_spec`.\n- Run `uv run pytest tests/test_spec.py` (and any updated coverage tests).\n\nNotes for Agent:\n- Keep the change scoped to spec-based validation to avoid touching legacy runner behavior unless necessary.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-27T17:24:35.528673696Z","updated_at":"2025-12-27T18:18:03.600116003Z","closed_at":"2025-12-27T18:18:03.600116003Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-y9i.2","depends_on_id":"mala-y9i","type":"parent-child","created_at":"2025-12-27T17:24:35.536611666Z","created_by":"daemon"}]}
{"id":"mala-y9i.3","title":"Record quality-gate evidence for failed runs","description":"Context:\n- Failed runs never populate `quality_gate` in run metadata because the failure branch is nested under the success path (`src/orchestrator.py`).\n- This loses evidence and reasons needed for troubleshooting and follow-up triage.\n\nScope:\n- In: refactor result handling so failures always record `quality_gate` evidence/reasons when a log path exists.\n- In: add/adjust tests in `tests/test_orchestrator.py` to assert `quality_gate` is present for failed runs.\n- Out: changing how issues are closed/marked in Beads or altering retry logic.\n\nAcceptance Criteria:\n- Run metadata includes `quality_gate` details for failed runs with logs.\n- Successful runs continue to record `quality_gate` as before.\n- No change to success/failure outcomes or retry behavior.\n\nTest Plan:\n- TDD: add a failing test for failed-run metadata population.\n- Implement the minimal control-flow fix.\n- Run `uv run pytest tests/test_orchestrator.py`.\n\nNotes for Agent:\n- Keep evidence parsing consistent with existing QualityGate helpers.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-27T17:24:44.528665141Z","updated_at":"2025-12-27T18:37:24.657045092Z","closed_at":"2025-12-27T18:37:24.657045092Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-y9i.3","depends_on_id":"mala-y9i","type":"parent-child","created_at":"2025-12-27T17:24:44.537115188Z","created_by":"daemon"}]}
{"id":"mala-y9i.4","title":"Respect MALA_RUNS_DIR/MALA_LOCK_DIR from user .env","description":"Context:\n- `RUNS_DIR` and `LOCK_DIR` are computed at import time before `.env` is loaded, so `MALA_RUNS_DIR`/`MALA_LOCK_DIR` in `~/.config/mala/.env` are ignored (`src/tools/env.py`, `src/cli.py`).\n- This makes configuration overrides appear to have no effect.\n- Needs verification: confirm behavior in a clean shell where only `.env` sets these variables.\n\nScope:\n- In: defer directory resolution until after `load_user_env()` (e.g., replace module-level constants with getters or re-evaluate post-load).\n- In: add/adjust tests (likely `tests/test_cli.py` or a new env test) to confirm overrides are respected.\n- Out: changing default directories or env var names.\n\nAcceptance Criteria:\n- Setting `MALA_RUNS_DIR` and `MALA_LOCK_DIR` in `~/.config/mala/.env` changes runtime paths.\n- Defaults remain unchanged when env vars are not set.\n\nTest Plan:\n- TDD: add a failing test that loads env and asserts the resolved dirs use overrides.\n- Implement minimal refactor to delay evaluation.\n- Run `uv run pytest tests/test_cli.py` (or relevant env test file).\n\nNotes for Agent:\n- Ensure any refactor doesn’t break existing imports that expect constants.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T17:24:55.184682777Z","updated_at":"2025-12-27T19:21:06.3556664Z","closed_at":"2025-12-27T19:21:06.3556664Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-y9i.4","depends_on_id":"mala-y9i","type":"parent-child","created_at":"2025-12-27T17:24:55.193409852Z","created_by":"daemon"}]}
{"id":"mala-ychu","title":"[Test] epic verifier output check","description":"temp issue to inspect --silent output","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-01T01:53:21.275463227Z","created_by":"cyou","updated_at":"2026-01-01T01:55:09.963716222Z","closed_at":"2026-01-01T01:55:09.963716222Z","close_reason":"Closed","labels":["auto_generated","epic_remediation:test"]}
{"id":"mala-yco","title":"Make code review generic, not specific to Codex","description":"Make mala language-agnostic:\n\n1. **Code review**: Pluggable review backends beyond Codex (different models, approaches)\n2. **Validation specs**: Add ValidationSpec support for non-Python languages:\n   - JavaScript/TypeScript (eslint, prettier, tsc, jest/vitest)\n   - Go (go vet, gofmt, go test)\n   - Rust (clippy, rustfmt, cargo test)\n   - Generic (user-defined commands in config)\n\nThis enables mala to orchestrate agents across polyglot codebases.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T06:45:46.864991081Z","updated_at":"2026-01-01T21:40:37.46505543Z","closed_at":"2026-01-01T21:40:37.46505543Z","close_reason":"Closed","labels":["polyglot"]}
{"id":"mala-yco.1","title":"Cleanup: update console + validation spec review naming","description":"Context:\n- Console event sink still references Codex review and thinking mode.\n- Validation spec docs reference the old \"codex-review\" disable value.\n\nScope:\n- In: update src/event_sink_console.py to use review_enabled and remove thinking-mode output; rename strings to \"external review\" or \"review\".\n- In: update src/validation/spec.py to rename \"codex-review\" to \"review\" in docs/comments.\n- Out: other codex references in pipeline/orchestrator/tests (handled elsewhere).\n\nAcceptance Criteria:\n- Console output uses \"review\" phrasing and has no codex_thinking_mode references.\n- Validation spec comment uses \"review\".\n- rg -n \"codex\" src/event_sink_console.py src/validation/spec.py returns no matches.\n\nTest Plan:\n- Run: rg -n \"codex\" src/event_sink_console.py src/validation/spec.py\n- (Optional) uv run pytest tests/test_event_sink.py\n","status":"tombstone","priority":2,"issue_type":"chore","created_at":"2025-12-30T05:23:44.834411601Z","created_by":"cyou","updated_at":"2025-12-30T05:41:25.140647449Z","dependencies":[{"issue_id":"mala-yco.1","depends_on_id":"mala-yco","type":"parent-child","created_at":"2025-12-30T05:23:44.83478146Z","created_by":"daemon"},{"issue_id":"mala-yco.1","depends_on_id":"mala-8kte.6","type":"blocks","created_at":"2025-12-30T05:23:44.855351606Z","created_by":"daemon"},{"issue_id":"mala-yco.1","depends_on_id":"mala-8kte.7","type":"blocks","created_at":"2025-12-30T05:23:44.877129379Z","created_by":"daemon"}],"deleted_at":"2025-12-30T05:41:25.140647449Z","deleted_by":"daemon","delete_reason":"delete","original_type":"chore"}
{"id":"mala-yg9","title":"Epic: Architecture refactor follow-ups (2025-12-27 review)","description":"Scope: Follow-up work from docs/architecture-check-2025-12-27.md. Tracks orchestrator + validation refactors to improve boundary clarity and testability.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-27T06:13:21.897889922Z","updated_at":"2025-12-28T05:29:33.825890471Z","closed_at":"2025-12-28T05:29:33.825890471Z","close_reason":"All children completed"}
{"id":"mala-yg9.1","title":"Epic: Orchestrator lifecycle \u0026 gate flow","description":"Scope: Orchestrator lifecycle policy, gate flow concurrency, and metadata recording improvements from the 2025-12-27 architecture review.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-27T06:13:27.609461567Z","updated_at":"2025-12-27T09:03:57.376513213Z","closed_at":"2025-12-27T09:03:57.376513213Z","close_reason":"All children completed","dependencies":[{"issue_id":"mala-yg9.1","depends_on_id":"mala-yg9","type":"parent-child","created_at":"2025-12-27T06:13:27.618446169Z","created_by":"daemon"}]}
{"id":"mala-yg9.1.1","title":"Record resolution markers in run metadata","description":"Context:\n- Needs verification: _run_quality_gate uses check_with_resolution, so ISSUE_NO_CHANGE/ISSUE_OBSOLETE can pass, but IssueRun.resolution is never set (src/orchestrator.py:884-897, src/logging/run_metadata.py:57-140).\n- Downstream tooling cannot distinguish a normal commit pass from a no-change/obsolete resolution.\n\nScope:\n- In: propagate gate_result.resolution into IssueRun and persist it via RunMetadata.\n- Out: changing marker syntax or commit requirements for normal flows.\n\nAcceptance Criteria:\n- Run metadata records resolution outcome + rationale when markers are used.\n- Non-resolution flows remain unchanged.\n\nTest Plan:\n- TDD: add a failing test for resolution recording, implement fix, refactor.\n- Run: uv run pytest tests/test_quality_gate.py tests/test_orchestrator.py\n\nNotes for Agent:\n- Consider surfacing resolution in logs for visibility (optional).","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T06:15:29.583791182Z","updated_at":"2025-12-27T08:18:08.136749502Z","closed_at":"2025-12-27T08:18:08.136749502Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-yg9.1.1","depends_on_id":"mala-yg9.1","type":"parent-child","created_at":"2025-12-27T06:15:29.592643786Z","created_by":"daemon"},{"issue_id":"mala-yg9.1.1","depends_on_id":"mala-yg9.2.4","type":"blocks","created_at":"2025-12-27T06:16:03.215759211Z","created_by":"daemon"}]}
{"id":"mala-yg9.1.2","title":"Make quality gate checks non-blocking in orchestrator loop","description":"Context:\n- Needs verification: _run_quality_gate is called from the async response loop but uses blocking subprocess/file I/O (src/orchestrator.py:217-433).\n- This can stall the event loop when multiple agents run concurrently.\n\nScope:\n- In: move gate checks to asyncio.to_thread (or equivalent) so the event loop stays responsive.\n- Out: changing gate semantics or evidence requirements.\n\nAcceptance Criteria:\n- Gate checks do not block the event loop (structurally enforced via to_thread/async).\n- Orchestrator can continue servicing other agents while a gate runs.\n\nTest Plan:\n- TDD: add/adjust a test that asserts gate checks are invoked via to_thread or async path, implement change, refactor.\n- Run: uv run pytest tests/test_orchestrator.py\n\nNotes for Agent:\n- Keep logging behavior the same; only adjust execution context.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T06:15:38.057191895Z","updated_at":"2025-12-27T08:26:45.183237829Z","closed_at":"2025-12-27T08:26:45.183237829Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-yg9.1.2","depends_on_id":"mala-yg9.1","type":"parent-child","created_at":"2025-12-27T06:15:38.073339276Z","created_by":"daemon"},{"issue_id":"mala-yg9.1.2","depends_on_id":"mala-yg9.1.1","type":"blocks","created_at":"2025-12-27T06:16:03.227763694Z","created_by":"daemon"}]}
{"id":"mala-yg9.1.3","title":"Extract run_implementer lifecycle state machine","description":"Context:\n- run_implementer mixes SDK IO, streaming output, gate checks, retry policy, Codex review, and cleanup in one long loop (src/orchestrator.py:286-520, 760-923).\n- This coupling makes policy changes risky and unit tests hard to write.\n\nScope:\n- In: extract a pure state machine for retry/gate/review transitions (data-in/data-out) and isolate side effects behind small interfaces.\n- Out: changing user-visible CLI behavior or prompt contents.\n\nAcceptance Criteria:\n- Core retry/gate/review policy is testable without Claude SDK or subprocesses.\n- run_implementer is reduced to orchestration with explicit dependencies.\n\nTest Plan:\n- TDD: add unit tests for state transitions, implement refactor, refactor orchestration.\n- Run: uv run pytest tests/test_orchestrator.py\n\nNotes for Agent:\n- Prefer additive refactor with compatibility shims to limit churn.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-27T06:15:45.890888837Z","updated_at":"2025-12-27T08:52:11.379698431Z","closed_at":"2025-12-27T08:52:11.379698431Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-yg9.1.3","depends_on_id":"mala-yg9.1","type":"parent-child","created_at":"2025-12-27T06:15:45.899578351Z","created_by":"daemon"},{"issue_id":"mala-yg9.1.3","depends_on_id":"mala-yg9.1.2","type":"blocks","created_at":"2025-12-27T06:16:03.239560506Z","created_by":"daemon"}]}
{"id":"mala-yg9.2","title":"Epic: Validation system alignment","description":"Scope: Validation spec enforcement, runner alignment, E2E fixture dedup, and gate evidence consistency from the 2025-12-27 architecture review.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-27T06:13:32.616096867Z","updated_at":"2025-12-27T09:03:57.3770263Z","closed_at":"2025-12-27T09:03:57.3770263Z","close_reason":"All children completed","dependencies":[{"issue_id":"mala-yg9.2","depends_on_id":"mala-yg9","type":"parent-child","created_at":"2025-12-27T06:13:32.624829179Z","created_by":"daemon"}]}
{"id":"mala-yg9.2.1","title":"Normalize log parsing offsets in QualityGate","description":"Context:\n- Needs verification: retry offset semantics are inconsistent between binary and text log parsing (see src/quality_gate.py:188-360 and orchestrator usage at src/orchestrator.py:255-275).\n- parse_issue_resolution_from_offset reads bytes while parse_validation_evidence_from_offset reads text, but offsets are reused across both.\n\nScope:\n- In: introduce a single cursor/offset contract for both resolution + evidence parsing (shared binary reader or explicit separate offsets).\n- Out: changing JSONL log format or Claude SDK logging behavior.\n\nAcceptance Criteria:\n- Offsets are byte-based and consistent across both parsers.\n- Retry-scoped evidence and resolution detection are deterministic across attempts.\n\nTest Plan:\n- TDD: add a failing unit test with synthetic JSONL logs spanning multiple attempts, implement fix, refactor.\n- Run: uv run pytest tests/test_quality_gate.py\n\nNotes for Agent:\n- Keep the public QualityGate API stable if possible; prefer internal refactor.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T06:14:23.231600538Z","updated_at":"2025-12-27T06:50:38.683075107Z","closed_at":"2025-12-27T06:50:38.683075107Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-yg9.2.1","depends_on_id":"mala-yg9.2","type":"parent-child","created_at":"2025-12-27T06:14:23.238427532Z","created_by":"daemon"}]}
{"id":"mala-yg9.2.2","title":"Drive gate evidence parsing from ValidationSpec commands","description":"Context:\n- Needs verification: ValidationSpec defines commands, but QualityGate uses a separate regex map for evidence (src/validation/spec.py:310-360 vs src/quality_gate.py:151-158).\n- This duplication risks false failures when commands change.\n\nScope:\n- In: define a single authoritative command definition (e.g., command IDs or detection patterns on ValidationCommand) and reuse it in QualityGate evidence parsing.\n- Out: changing the actual validation commands or their ordering.\n\nAcceptance Criteria:\n- Evidence parsing is driven from spec command definitions.\n- Updating spec commands automatically updates gate expectations.\n\nTest Plan:\n- TDD: add/adjust a unit test that fails when spec commands change but evidence parsing does not, then implement fix.\n- Run: uv run pytest tests/test_quality_gate.py\n\nNotes for Agent:\n- Prefer minimal API changes; add optional fields to ValidationCommand if needed.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T06:14:32.366184084Z","updated_at":"2025-12-27T07:11:43.246105111Z","closed_at":"2025-12-27T07:11:43.246105111Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-yg9.2.2","depends_on_id":"mala-yg9.2","type":"parent-child","created_at":"2025-12-27T06:14:32.374848132Z","created_by":"daemon"},{"issue_id":"mala-yg9.2.2","depends_on_id":"mala-yg9.2.1","type":"blocks","created_at":"2025-12-27T06:16:03.124875688Z","created_by":"daemon"}]}
{"id":"mala-yg9.2.3","title":"Remove deprecated validation flags and use disable-validations=codex-review","description":"Context:\n- CLI flags --lint-only-for-docs and --skip-e2e-if-no-keys should be removed entirely.\n- Codex review toggling should use --disable-validations=codex-review and replace the --codex-review/--no-codex-review flag (src/cli.py:125-163).\n- Orchestrator currently stores lint_only_for_docs + skip_e2e_if_no_keys and uses codex_review directly (src/orchestrator.py:155-187, 435-520).\n\nScope:\n- In: remove --lint-only-for-docs and --skip-e2e-if-no-keys from CLI and plumbing (cli/orchestrator/spec inputs).\n- In: remove --codex-review/--no-codex-review flag and wire codex review enablement to disable_validations containing \"codex-review\".\n- Out: changing validation command defaults or quality gate semantics.\n\nAcceptance Criteria:\n- CLI help/output no longer includes --lint-only-for-docs or --skip-e2e-if-no-keys.\n- CLI help/output no longer includes --codex-review/--no-codex-review.\n- Codex review is enabled by default and disabled when disable_validations includes \"codex-review\".\n\nTest Plan:\n- TDD: update failing CLI parsing tests to remove deprecated flags and validate codex-review disable path, implement code changes, refactor.\n- Run: uv run pytest tests/test_cli.py tests/test_orchestrator.py\n\nNotes for Agent:\n- Keep behavior backward-compatible only via disable-validations; do not add new flags.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-27T06:14:41.186302644Z","updated_at":"2025-12-27T07:20:37.057790616Z","closed_at":"2025-12-27T07:20:37.057790616Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-yg9.2.3","depends_on_id":"mala-yg9.2","type":"parent-child","created_at":"2025-12-27T06:14:41.194971161Z","created_by":"daemon"},{"issue_id":"mala-yg9.2.3","depends_on_id":"mala-yg9.2.2","type":"blocks","created_at":"2025-12-27T06:16:03.143821949Z","created_by":"daemon"}]}
{"id":"mala-yg9.2.4","title":"Integrate spec-based validation execution into orchestrator metadata","description":"Context:\n- Needs verification: ValidationRunner.run_spec exists but is unused; orchestrator relies on log parsing for pass/fail (src/validation/runner.py:294-540, src/orchestrator.py:822-897).\n- Run metadata has validation fields that are never populated (src/logging/run_metadata.py:57-140).\n\nScope:\n- In: invoke ValidationRunner.run_spec after commit detection and record ValidationResult in RunMetadata/IshueRun.\n- Out: changing validation commands or CLI flags.\n\nAcceptance Criteria:\n- Exactly one validation execution path is used during runs.\n- Run metadata includes validation results when validation runs.\n\nTest Plan:\n- TDD: add/adjust an orchestrator test that asserts validation execution + metadata population, implement fix, refactor.\n- Run: uv run pytest tests/test_orchestrator.py tests/test_validation.py\n\nNotes for Agent:\n- Keep log-parsing gate evidence intact unless explicitly replaced by run_spec.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-27T06:14:50.057484108Z","updated_at":"2025-12-27T07:47:41.275020049Z","closed_at":"2025-12-27T07:47:41.275020049Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-yg9.2.4","depends_on_id":"mala-yg9.2","type":"parent-child","created_at":"2025-12-27T06:14:50.066001705Z","created_by":"daemon"},{"issue_id":"mala-yg9.2.4","depends_on_id":"mala-yg9.2.3","type":"blocks","created_at":"2025-12-27T06:16:03.1558436Z","created_by":"daemon"}],"comments":[{"id":1,"issue_id":"mala-yg9.2.4","author":"cyou","text":"Additional context from type error incident (2025-12-27):\n\nRoot cause: Agents gaming validation by running `uvx ty check src/specific_file.py` instead of full `uvx ty check`. QualityGate's regex-based log parsing accepted this because it only checks if `ty check` was mentioned, not:\n- Whether it ran on full codebase\n- Whether it passed (exit code 0)\n\nEvidence: Commit 0328a6e logs show agent ran:\n- `uvx ty check 2\u003e\u00261 | head -20` (truncated)\n- `uvx ty check src/orchestrator.py` (file-specific)\n\nResult: 62 type errors accumulated in test files, required manual fix in 8c0dc74.\n\nThis confirms the urgency of wiring up ValidationRunner.run_spec() which actually runs full validation in a clean worktree and checks exit codes.","created_at":"2025-12-27T06:36:30Z"}]}
{"id":"mala-yg9.2.5","title":"Split ValidationRunner legacy vs spec APIs","description":"Context:\n- Needs verification: ValidationRunner houses both legacy ValidationConfig flow and new ValidationSpec flow in one class (src/validation/runner.py:1-120, 294-540).\n- This coupling makes deprecating legacy paths risky and tests harder to isolate.\n\nScope:\n- In: split into LegacyValidationRunner + SpecValidationRunner (or an adapter), with shared helpers extracted.\n- Out: changing validation behavior or CLI flags.\n\nAcceptance Criteria:\n- Each runner has a single responsibility and isolated config surface.\n- Tests are updated to use the appropriate runner class.\n\nTest Plan:\n- TDD: update a failing test to target the new runner class, implement refactor, refactor tests.\n- Run: uv run pytest tests/test_validation.py\n\nNotes for Agent:\n- Prefer small module moves; keep public API stable where possible.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T06:14:58.49336286Z","updated_at":"2025-12-27T08:09:26.87856065Z","closed_at":"2025-12-27T08:09:26.87856065Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-yg9.2.5","depends_on_id":"mala-yg9.2","type":"parent-child","created_at":"2025-12-27T06:14:58.502255715Z","created_by":"daemon"},{"issue_id":"mala-yg9.2.5","depends_on_id":"mala-yg9.2.4","type":"blocks","created_at":"2025-12-27T06:16:03.167592633Z","created_by":"daemon"}]}
{"id":"mala-yg9.2.6","title":"Deduplicate E2E fixture logic","description":"Context:\n- E2E fixture creation/prereq checks are duplicated between validation/runner.py and validation/e2e.py (src/validation/runner.py:686-789, src/validation/e2e.py:348-473).\n- This duplication risks drift and inconsistent behavior across legacy/spec flows.\n\nScope:\n- In: centralize fixture creation + prereq checks in E2ERunner and delegate from ValidationRunner.\n- In: remove duplicate helpers from validation.__init__ if they are no longer needed.\n- Out: changing fixture content or mala invocation.\n- Out: any CLI flag changes (handled elsewhere).\n\nAcceptance Criteria:\n- Only one fixture/prereq implementation exists.\n- ValidationRunner delegates E2E execution to E2ERunner for both legacy and spec flows.\n- Duplicate helper exports are removed from validation.__init__ if unused.\n\nTest Plan:\n- TDD: add/adjust a failing E2E-related unit test, implement dedup, refactor.\n- Run: uv run pytest tests/test_e2e.py tests/test_validation.py\n\nNotes for Agent:\n- Keep fixture content identical; change plumbing only.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T06:15:10.06348597Z","updated_at":"2025-12-27T08:21:18.084178254Z","closed_at":"2025-12-27T08:21:18.084178254Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-yg9.2.6","depends_on_id":"mala-yg9.2","type":"parent-child","created_at":"2025-12-27T06:15:10.072149386Z","created_by":"daemon"},{"issue_id":"mala-yg9.2.6","depends_on_id":"mala-yg9.2.5","type":"blocks","created_at":"2025-12-27T06:16:03.179392406Z","created_by":"daemon"}]}
{"id":"mala-yg9.2.7","title":"Standardize subprocess execution via shared CommandRunner","description":"Context:\n- Needs verification: subprocess handling is inconsistent across modules, with different timeout/kill semantics and duplicated output tailing (e.g., src/beads_client.py:45-140, src/quality_gate.py:260-430, src/validation/runner.py:108-240, src/validation/e2e.py:200-420, src/validation/worktree.py:110-200).\n- This increases maintenance burden and inconsistent failure modes.\n\nScope:\n- In: introduce a shared CommandRunner (sync + async) with standardized timeouts, process-group termination, and output capture.\n- In: migrate quality_gate + validation (runner/e2e/worktree) to the shared runner; add beads_client only if needed for consistency.\n- Out: changing which commands run or their ordering.\n\nAcceptance Criteria:\n- CommandRunner exists and is used by quality_gate and validation paths.\n- Duplicate _tail helpers are removed or consolidated.\n\nTest Plan:\n- TDD: add a failing unit test for CommandRunner timeout/kill behavior, implement runner, refactor call sites.\n- Run: uv run pytest tests/test_validation.py tests/test_quality_gate.py\n\nNotes for Agent:\n- Keep API minimal; prefer incremental migration to avoid churn.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T06:15:20.286094712Z","updated_at":"2025-12-27T08:59:29.472484025Z","closed_at":"2025-12-27T08:59:29.472484025Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-yg9.2.7","depends_on_id":"mala-yg9.2","type":"parent-child","created_at":"2025-12-27T06:15:20.295235806Z","created_by":"daemon"},{"issue_id":"mala-yg9.2.7","depends_on_id":"mala-yg9.2.6","type":"blocks","created_at":"2025-12-27T06:16:03.191495098Z","created_by":"daemon"},{"issue_id":"mala-yg9.2.7","depends_on_id":"mala-yg9.2.2","type":"blocks","created_at":"2025-12-27T06:16:03.20365412Z","created_by":"daemon"}]}
{"id":"mala-yg9.3","title":"Orchestrator: drive implementer flow via ImplementerLifecycle","description":"## Context\nFrom architecture review docs/architecture-check-2025-12-27.md issue #4:\n- `src/orchestrator.py:303-644` contains `run_implementer` as a 342-line monolithic method\n- Gate/review retry policy, SDK session management, streaming, and lock cleanup are all mixed together\n- This coupling makes policy changes risky and unit testing difficult without the full SDK runtime\n\n## Current State (after mala-yg9.1.3)\n- `src/lifecycle.py` (470 lines) already implements `ImplementerLifecycle` as a pure state machine\n- `tests/test_lifecycle.py` (630 lines) has 31 tests with 97% coverage\n- Bridge functions exist: `from_orchestrator_retry_state()`, `to_orchestrator_retry_state_fields()`\n- **However**: `ImplementerLifecycle` is NOT imported or used anywhere in `orchestrator.py`\n- The orchestrator still has its own inline retry/gate/review logic duplicating the lifecycle\n\n## Scope\n- In: Refactor `run_implementer` to use `ImplementerLifecycle` for policy decisions\n- In: Orchestrator handles I/O (SDK calls, logs, hooks) based on `Effect` returns from lifecycle\n- In: Remove inline retry/gate/review branches from orchestrator\n- Out: Change retry semantics, Claude SDK integration, or lifecycle state machine design\n\n## Acceptance Criteria\n- `run_implementer` delegates policy decisions to `ImplementerLifecycle`\n- Inline gate/review retry branches are removed from orchestrator (reducing ~200 lines)\n- Lifecycle transitions drive the flow: INITIAL → PROCESSING → AWAITING_LOG → RUNNING_GATE → etc.\n- All existing orchestrator integration tests still pass\n- No SDK mocking required to test policy logic (already covered by lifecycle tests)\n\n## Test Plan\n- TDD: Verify lifecycle is called in orchestrator flow\n- Existing lifecycle tests (31 tests) already cover policy transitions\n- `uv run pytest tests/test_orchestrator.py tests/test_lifecycle.py`\n\n## Notes for Agent\n- Use the existing bridge functions to convert between orchestrator's `RetryState` and lifecycle's `LifecycleContext`\n- Effects returned by lifecycle transitions tell orchestrator what I/O to perform\n- Keep I/O (SDK, logs, hooks) in orchestrator; lifecycle remains pure data-in/data-out\n- Reference lifecycle.py module docstring for design rationale","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-27T17:15:08.120064423Z","updated_at":"2025-12-28T00:56:10.391191905Z","closed_at":"2025-12-28T00:56:10.391191905Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-yg9.3","depends_on_id":"mala-yg9","type":"parent-child","created_at":"2025-12-27T17:15:08.120492531Z","created_by":"daemon"}]}
{"id":"mala-yg9.4","title":"Validation pipeline: make SpecValidationRunner primary and isolate legacy facade","description":"Context:\n- Orchestrator uses the `ValidationRunner` facade to run spec validation (`src/orchestrator.py:880-918`).\n- `ValidationRunner` wraps both legacy and spec flows (`src/validation/runner.py:57-113`).\n- Legacy command definitions remain in `src/validation/legacy_runner.py:134-154`, risking drift from spec.\n\nScope:\n- In: Update orchestrator to use `SpecValidationRunner` directly (or a thin spec-only adapter).\n- In: Reduce `ValidationRunner` to a compatibility wrapper; clearly document legacy path.\n- Out: Remove legacy API entirely or change validation command semantics.\n\nAcceptance Criteria:\n- Orchestrator no longer instantiates `ValidationRunner` for spec-based runs.\n- Legacy runner remains available for backward compatibility but is not used in orchestrator.\n- Validation command definitions are single-sourced (no duplicate lists used by orchestrator).\n\nTest Plan:\n- TDD: add a failing test that exercises spec validation via the new orchestration path.\n- `uv run pytest` (target validation runner/spec tests).\n\nNotes for Agent:\n- Keep the public legacy API working; deprecate via docs/comments only if needed.","notes":"Quality gate failed: Quality gate failed: Missing validation commands: ruff check, ruff format, pytest, ty check; No progress: commit unchanged and no new validation evidence\nLog: /home/cyou/.claude/projects/-home-cyou-mala/64499301-0bf0-46e8-9116-32b267336192.jsonl","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-27T17:15:18.339547533Z","updated_at":"2025-12-28T02:17:09.185278293Z","closed_at":"2025-12-28T02:17:09.185278293Z","close_reason":"Closed","labels":["needs-followup"],"dependencies":[{"issue_id":"mala-yg9.4","depends_on_id":"mala-yg9","type":"parent-child","created_at":"2025-12-27T17:15:18.348894746Z","created_by":"daemon"},{"issue_id":"mala-yg9.4","depends_on_id":"mala-yg9.3","type":"blocks","created_at":"2025-12-27T17:16:03.096258868Z","created_by":"daemon"}]}
{"id":"mala-yg9.5","title":"Subprocess handling: centralize execution and timeouts","description":"## Context\nFrom architecture review docs/architecture-check-2025-12-27.md issue #7:\n- Subprocess logic is duplicated with different timeout/termination semantics\n- Only `BeadsClient` reliably kills process groups\n- Duplicate `_tail` helpers increase maintenance burden\n\n## Current State (after mala-yg9.2.7)\n`src/validation/command_runner.py` was created with:\n- Unified sync/async execution (`run()` and `run_async()`)\n- Configurable timeouts with process-group termination (SIGTERM → grace → SIGKILL)\n- `CommandResult` dataclass with `stdout_tail()`/`stderr_tail()` methods\n\n**Successfully migrated:**\n- `src/validation/spec_runner.py` - uses CommandRunner for all validation commands\n- `src/validation/legacy_runner.py` - uses CommandRunner for validation steps\n- `src/validation/e2e.py` - uses CommandRunner for mala invocation\n\n**NOT migrated (still use direct subprocess.run):**\n- `src/quality_gate.py:291` - `check_working_tree_clean()` uses subprocess.run for `git status`\n- `src/quality_gate.py:663` - `check_commit_exists()` uses subprocess.run for `git log`\n- `src/validation/worktree.py:191,238,267,318,341` - Multiple subprocess.run calls for git operations\n\n**Independent implementation:**\n- `src/beads_client.py` has its own `_run_subprocess_async()` with similar semantics (predates CommandRunner)\n\n## Scope\n- In: Migrate `quality_gate.py` subprocess calls to use CommandRunner\n- In: Migrate `worktree.py` subprocess calls to use CommandRunner\n- In: Consider whether `beads_client.py` should also use CommandRunner (or keep independent)\n- Out: Change CLI command flags or alter validation policies\n\n## Acceptance Criteria\n- `quality_gate.py` uses CommandRunner for git subprocess calls\n- `worktree.py` uses CommandRunner for git subprocess calls\n- Timeout and process-group termination behavior is consistent across all call sites\n- Error messages remain structured and actionable\n- All existing tests pass\n\n## Test Plan\n- Add/adjust unit tests for subprocess calls in quality_gate and worktree\n- `uv run pytest tests/test_quality_gate.py tests/test_validation.py`\n\n## Notes for Agent\n- CommandRunner is in `src/validation/command_runner.py`\n- For git commands, consider whether they need timeout handling or can use simpler wrappers\n- Preserve stdout/stderr tailing behavior; do not increase log noise\n- BeadsClient migration is optional - evaluate whether unifying is worth the churn","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-27T17:15:27.857841446Z","updated_at":"2025-12-28T03:09:46.316507839Z","closed_at":"2025-12-28T03:09:46.316507839Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-yg9.5","depends_on_id":"mala-yg9","type":"parent-child","created_at":"2025-12-27T17:15:27.877588866Z","created_by":"daemon"},{"issue_id":"mala-yg9.5","depends_on_id":"mala-yg9.7","type":"blocks","created_at":"2025-12-27T17:16:07.830176685Z","created_by":"daemon"}]}
{"id":"mala-yg9.6","title":"Env config: compute RUNS_DIR/LOCK_DIR after .env load","description":"Context:\n- `RUNS_DIR` and `LOCK_DIR` are computed at import time (`src/tools/env.py:18-29`).\n- `.env` is loaded later in CLI startup (`src/cli.py:17-21`), so overrides are ignored.\n- Needs verification: confirm expected behavior for `MALA_RUNS_DIR`/`MALA_LOCK_DIR` overrides.\n\nScope:\n- In: Replace import-time constants with accessors or a Settings object loaded after `load_user_env()`.\n- In: Update CLI (and any other callers) to use the new access path.\n- Out: Change environment variable names or default paths.\n\nAcceptance Criteria:\n- `.env` overrides for runs/locks apply consistently.\n- No module depends on import-time config constants for these paths.\n- Unit test demonstrates `.env` override behavior.\n\nTest Plan:\n- Add a test that sets env vars or loads a test `.env`, then asserts resolved paths.\n- `uv run pytest` (target env/config tests).\n\nNotes for Agent:\n- Keep `load_user_env()` as the single production entry for env loading.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T17:15:37.761209754Z","updated_at":"2025-12-28T01:13:53.981259155Z","closed_at":"2025-12-28T01:13:53.981259155Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-yg9.6","depends_on_id":"mala-yg9","type":"parent-child","created_at":"2025-12-27T17:15:37.780801225Z","created_by":"daemon"}]}
{"id":"mala-yg9.7","title":"QualityGate: derive evidence requirements from ValidationSpec","description":"## Context\nFrom architecture review docs/architecture-check-2025-12-27.md issue #8:\n- Validation commands defined in `ValidationSpec` but evidence detection used separate regex map in `QualityGate`\n- Changing commands in spec could silently desync evidence detection\n\n## Current State (after mala-yg9.2.2)\n**Spec-driven path implemented and working:**\n- `ValidationCommand` in `spec.py:174-198` includes `detection_pattern` field\n- `build_validation_spec()` creates commands with compiled regex patterns\n- `parse_validation_evidence_with_spec()` in `quality_gate.py:493` derives patterns FROM spec\n- `check_with_resolution()` accepts optional `spec` parameter and uses spec-driven parsing\n- Orchestrator passes spec to gate: `quality_gate.check_with_resolution(..., spec=spec)`\n- Tests verify spec-driven patterns work (TestSpecDrivenEvidencePatterns)\n\n**Remaining cleanup (optional):**\n- `VALIDATION_PATTERNS` hardcoded map still exists in `quality_gate.py:151-158` as fallback\n- Legacy `check()` method and `parse_validation_evidence_from_offset()` still use hardcoded patterns\n- These are only used when no spec is provided (backward compatibility)\n\n## Scope\n- In: Remove `VALIDATION_PATTERNS` hardcoded map if no longer needed\n- In: Update legacy `check()` method to require spec or remove entirely\n- In: Ensure `parse_validation_evidence_from_offset()` is only used as fallback\n- Out: Change which validations are required or their CLI flags\n\n## Acceptance Criteria\n- Hardcoded `VALIDATION_PATTERNS` map is removed or clearly marked as deprecated fallback\n- All production code paths use spec-driven evidence parsing\n- Tests verify that updating spec commands automatically updates evidence expectations\n- Legacy paths (if kept) are clearly documented as deprecated\n\n## Test Plan\n- Verify no production code calls legacy methods without spec\n- Add test that spec command changes propagate to evidence detection\n- `uv run pytest tests/test_quality_gate.py`\n\n## Notes for Agent\n- The core fix is already implemented - this is cleanup work\n- Check if any callers use `check()` or `parse_validation_evidence_from_offset()` without spec\n- If legacy methods have no callers, they can be removed\n- If they have callers, update callers to pass spec or deprecate with warnings","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T17:15:46.833421374Z","updated_at":"2025-12-28T02:51:05.590472175Z","closed_at":"2025-12-28T02:51:05.590472175Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-yg9.7","depends_on_id":"mala-yg9","type":"parent-child","created_at":"2025-12-27T17:15:46.853067905Z","created_by":"daemon"}]}
{"id":"mala-yg9.8","title":"CLI bootstrap: move Braintrust/env side effects into explicit init","description":"Context:\n- `src/cli.py` loads `.env` and applies Braintrust setup at import time (`src/cli.py:12-33`).\n- Import-time side effects make tests and reuse harder.\n- Needs verification: confirm other modules rely on current import-time behavior.\n\nScope:\n- In: Add a `bootstrap()` function to handle env loading and Braintrust patching.\n- In: Ensure entrypoint (`src/main.py`) calls bootstrap before using the SDK.\n- Out: Change CLI commands or Braintrust configuration semantics.\n\nAcceptance Criteria:\n- Importing `src.cli` does not perform env loading or Braintrust setup.\n- CLI still boots with Braintrust enabled when `BRAINTRUST_API_KEY` is set.\n- Unit test (or smoke test) validates import safety.\n\nTest Plan:\n- Add an import-only test that asserts no side effects.\n- `mala --help` and `mala run --help` smoke checks.\n\nNotes for Agent:\n- Keep SDK import ordering safe: bootstrap must run before claude_agent_sdk usage.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T17:15:56.854726584Z","updated_at":"2025-12-28T03:14:44.785670206Z","closed_at":"2025-12-28T03:14:44.785670206Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-yg9.8","depends_on_id":"mala-yg9","type":"parent-child","created_at":"2025-12-27T17:15:56.874255915Z","created_by":"daemon"},{"issue_id":"mala-yg9.8","depends_on_id":"mala-yg9.6","type":"blocks","created_at":"2025-12-27T17:16:12.147876459Z","created_by":"daemon"}]}
{"id":"mala-yg9.9","title":"Remove private helpers from validation __all__ export","description":"## Context\nFrom architecture review docs/architecture-check-2025-12-27.md issue #11:\n- Private helpers (`_tail`, `_format_step_output`, `_check_e2e_prereqs`) are included in `src/validation/__init__.py`'s `__all__` export list (lines 110-112)\n- This makes them part of the public API surface, increasing coupling and making refactors risky\n\n## Current State\n```python\n# In src/validation/__init__.py lines 110-112\n# Backwards compatibility (private)\n\"_check_e2e_prereqs\",\n\"_format_step_output\",\n\"_tail\",\n```\n\nThese are re-exported from `runner.py` (lines 42-47) as underscore-prefixed aliases of the helpers in `helpers.py`.\n\n## Scope\n- In: Remove `_tail`, `_format_step_output`, `_check_e2e_prereqs` from `__all__` in `src/validation/__init__.py`\n- In: Remove the re-export aliases from `src/validation/runner.py`\n- In: Search for external callers and update them to use the public `helpers.py` exports if needed\n- Out: Changing the helper implementations themselves\n\n## Acceptance Criteria\n- Only intended public API symbols are exported from `validation.__init__`\n- No external code breaks (verify via grep for imports of these private symbols)\n- Tests still pass\n\n## Test Plan\n- `uv run pytest tests/test_validation.py` to catch import breakage\n- `grep -r \"from.*validation.*import.*_tail\" src/ tests/` to find any callers\n\n## Notes for Agent\n- These helpers are consolidated in `helpers.py` - the public versions (`tail`, `format_step_output`, `check_e2e_prereqs`) should be used instead\n- If external callers exist, update them to import from `validation.helpers` directly","status":"closed","priority":3,"issue_type":"chore","created_at":"2025-12-27T18:41:56.00236732Z","updated_at":"2025-12-28T05:29:33.807896933Z","closed_at":"2025-12-28T05:29:33.807896933Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-yg9.9","depends_on_id":"mala-yg9","type":"parent-child","created_at":"2025-12-27T18:41:56.009743695Z","created_by":"daemon"}]}
{"id":"mala-ysua","title":"[Remediation] `uvx --from import-linter lint-imports` passes all 9 contrac...","description":"## Context\nThis issue was auto-created by epic verification for epic `mala-bp3h`.\n\n## Unmet Criterion\n`uvx --from import-linter lint-imports` passes all 9 contracts\n\n## Evidence\nTask 7 (Update test imports + final verification) shows status 'open', indicating final import-linter verification has not been completed\n\n## Severity\ncritical\n\n## Resolution\nAddress this criterion to unblock epic closure. When complete, close this issue.\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T03:35:30.851465508Z","created_by":"cyou","updated_at":"2026-01-01T03:40:59.737909176Z","closed_at":"2026-01-01T03:40:59.737909176Z","close_reason":"Closed","labels":["auto_generated","epic_remediation:mala-bp3h:22184a20fcacd9f09674855b80540e702cb1b12b2176513db933ec83abf8ebd0"],"dependencies":[{"issue_id":"mala-ysua","depends_on_id":"mala-bp3h","type":"parent-child","created_at":"2026-01-01T03:37:47.084128985Z","created_by":"daemon"}]}
{"id":"mala-yt3b","title":"[Review] tests/test_orchestrator.py:556-558: [P2] Config duplication requires test workaround for max_issues","description":"## Review Finding\n\nThis issue was auto-created from a P2 review finding.\n\n**Source issue:** mala-cavk.3\n**Reviewer:** claude\n**Location:** tests/test_orchestrator.py:556-558\n\n## Details\n\nWhen `orchestrator.max_issues` is changed after construction, the test had to also update `orchestrator.issue_coordinator.config.max_issues` because the coordinator has a copy of the config values. This workaround at `tests/test_orchestrator.py:557-558` is required for the test to pass, but indicates a design issue: callers who modify `orchestrator.max_issues` at runtime won't affect the coordinator unless they know about this internal implementation detail. Consider either sharing config or documenting that these attributes are set-once.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T22:23:07.412280655Z","created_by":"cyou","updated_at":"2026-01-02T01:02:47.604238482Z","closed_at":"2026-01-02T01:02:47.604238482Z","close_reason":"Closed","labels":["auto_generated","review_finding","review_finding:7b23e8ffedb5","source:mala-cavk.3"],"dependencies":[{"issue_id":"mala-yt3b","depends_on_id":"mala-i8ke","type":"blocks","created_at":"2026-01-01T23:03:58.848147044Z","created_by":"daemon"}]}
{"id":"mala-ytn","title":"Make tooling language/package-manager agnostic","description":"## Context\nCurrently the codebase is tightly coupled to Python + uv + ruff + ty. Validation commands, quality gate parsing, and prompts all assume this specific toolchain.\n\n## Goal\nMake mala usable with other language/toolchain combinations (e.g., TypeScript/npm, Rust/cargo, Go, etc.) by abstracting the toolchain layer.\n\n## Areas Affected\n\n### Validation Commands (src/validation/)\n- Hardcoded commands: `uv sync`, `uv run pytest`, `uvx ruff check`, `uvx ruff format`, `uvx ty check`\n- Need to support equivalent commands for other ecosystems (npm install, npm test, eslint, tsc, etc.)\n\n### Quality Gate Parsing (src/quality_gate.py)\n- Parses output patterns specific to pytest, ruff, ty\n- Needs configurable or pluggable pattern matching\n\n### Prompts (src/prompts/implementer_prompt.md)\n- References specific tools and commands\n- Should be templated or configurable per project\n\n### CLAUDE.md\n- Project-specific instructions currently assumed to follow Python conventions\n- Should be the source of truth for project toolchain\n\n## Approach Options\n\n1. **Config-driven**: Define toolchain in pyproject.toml/mala.toml with command mappings\n2. **Auto-detect**: Detect toolchain from project files (package.json, Cargo.toml, go.mod, etc.)\n3. **Plugin system**: Allow custom validation plugins per language\n\n## Acceptance Criteria\n- mala can run on a TypeScript project with npm/eslint/tsc\n- Toolchain commands are configurable, not hardcoded\n- Quality gate can parse outputs from multiple test/lint frameworks\n- Documentation covers how to configure for different languages\n\n## Out of Scope (for now)\n- IDE integration changes\n- Language-specific code generation\n- Multi-language monorepos","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-26T23:35:50.333488526Z","updated_at":"2025-12-27T20:57:22.064580719Z","closed_at":"2025-12-27T20:57:22.064580719Z","close_reason":"All children completed"}
{"id":"mala-z9z4","title":"[Review] src/orchestration/orchestrator.py:491-492: [P3] Comment says 'completed or failed' but only checks failed_issues","description":"## Review Finding\n\nThis issue was auto-created from a P3 review finding.\n\n**Source issue:** mala-l072\n**Reviewer:** claude\n**Location:** src/orchestration/orchestrator.py:491-492\n\n## Details\n\nThe comment at line 491 states \"Skip if already completed or failed\" but the code only checks `self.failed_issues`. If the intent is to also skip completed issues, the check should include `self.completed` or a completed issues set. If the intent is only to skip failed issues, update the comment to match the code. Since remediation issues come from `verify_and_close_epic` which creates new issues, they shouldn't already be completed, so this is likely just a misleading comment.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-02T01:58:59.964142341Z","created_by":"cyou","updated_at":"2026-01-02T02:04:43.055534247Z","closed_at":"2026-01-02T02:04:43.055534247Z","close_reason":"Closed","labels":["auto_generated","review_finding","review_finding:952071bdf21e","source:mala-l072"]}
{"id":"mala-za5","title":"Honor repo .env for Braintrust setup","description":"Context:\n- Braintrust setup runs before repo .env is loaded, so BRAINTRUST_API_KEY in the repo is ignored.\n- README suggests repo .env overrides user config, which currently isn’t true for Braintrust.\n\nScope:\n- In: delay Braintrust setup until after load_env(repo_path) or re-run setup if key becomes available.\n- Out: changes to tracing semantics or Braintrust SDK usage beyond setup timing.\n\nAcceptance Criteria:\n- When only repo .env contains BRAINTRUST_API_KEY, `mala run` reports Braintrust enabled.\n- When no key is present, behavior remains unchanged.\n\nTest Plan:\n- TDD: add a test that simulates repo-only BRAINTRUST_API_KEY, implement fix, and run CLI-related tests.\n\nNotes for Agent:\n- Avoid importing claude_agent_sdk before the wrapper is applied.","status":"tombstone","priority":2,"issue_type":"task","created_at":"2025-12-26T17:35:42.430757121Z","updated_at":"2025-12-26T17:39:58.002809862Z","deleted_at":"2025-12-26T17:39:58.002809862Z","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"mala-zbe","title":"CLI flag to disable MorphLLM","description":"Add a command-line flag (e.g., --no-morph or --disable-morph) to disable MorphLLM model routing. This allows users to bypass MorphLLM and use models directly when needed for debugging, cost control, or when MorphLLM is unavailable.\n\nAcceptance criteria:\n- Add --no-morph flag to CLI argument parsing\n- When set, skip MorphLLM routing and use the model directly\n- Update help text to document the flag","status":"tombstone","priority":2,"issue_type":"task","created_at":"2025-12-29T00:00:00Z","updated_at":"2025-12-29T02:02:50.346077611Z","deleted_at":"2025-12-29T02:02:50.346077611Z","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"mala-zfh","title":"QA agent for end of epic verification","description":"Before auto-closing epics, run QA agent to verify everything is actually done and complete\n\nSee docs/epic-verification-agent.md for detailed specification.\n\n[Added Context]\n- Treat this issue as the umbrella epic for the Epic Verification Agent rollout.\n- Verification runs after issue close and before epic auto-close, using scoped diffs from child issue commits (bd dep tree + commit prefix).\n- Unmet criteria create remediation issues (deduped by epic_remediation:\u003cepic_id\u003e:\u003ccriterion_hash\u003e) and block the epic; missing criteria/low confidence/no commits/timeouts require human review issues.\n- Large diffs use tiered truncation (100KB default) with file-summary/file-list fallbacks.\n- Human override via --epic-override \u003cepic_id\u003e bypasses verification when explicitly requested.","status":"closed","priority":3,"issue_type":"epic","created_at":"2025-12-28T06:21:39.224777024Z","updated_at":"2025-12-30T06:22:14.690129106Z","closed_at":"2025-12-30T06:22:14.690129106Z","close_reason":"All children completed"}
{"id":"mala-zfh.1","title":"Add epic verification types + protocol","description":"Context:\n- Epic Verification Agent spec requires shared dataclasses and a model protocol before implementation.\n- Types should live in src/models.py to avoid circular imports with protocols/epic verifier.\n- The protocol enables swapping verification model implementations.\n\nScope:\n- In: add UnmetCriterion, EpicVerdict, EpicVerificationResult, RetryConfig dataclasses to src/models.py; add EpicVerificationModel protocol to src/protocols.py with verify(...) -\u003e EpicVerdict signature.\n- Out: no EpicVerifier implementation or orchestrator/CLI changes.\n\nAcceptance Criteria:\n- Types exist with fields and types matching docs/epic-verification-agent.md.\n- EpicVerificationModel protocol imports from src.models without circular import.\n- ty type check passes for new annotations.\n\nTest Plan:\n- Run `uvx ty check`.\n\nNotes for Agent:\n- Keep models.py domain-agnostic; avoid importing EpicVerifier or Claude SDK here.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-30T05:17:31.839848586Z","created_by":"cyou","updated_at":"2025-12-30T05:30:53.024694371Z","closed_at":"2025-12-30T05:30:53.024694371Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-zfh.1","depends_on_id":"mala-zfh","type":"parent-child","created_at":"2025-12-30T05:17:31.840381665Z","created_by":"daemon"}]}
{"id":"mala-zfh.2","title":"Implement EpicVerifier core + unit tests","description":"Context:\n- Epic verification runs after issue closure and before epic auto-close, using scoped diffs of child issue commits.\n- Spec requires diff scoping (bd dep tree + commit prefix), spec path parsing, large diff handling, and remediation/human review flows.\n- Implementation lives in new src/epic_verifier.py and uses Claude SDK via EpicVerificationModel.\n\nScope:\n- In: implement EpicVerifier + ClaudeEpicVerificationModel with verify_epic/verify_and_close_eligible, including scoped diff computation from child commits (skip merge commits; include all commits per issue; handle no commits). Add prompt template in src/prompts/epic_verification.md and load it.\n- In: implement spec path extraction (regex patterns from docs) and large diff handling tiers (100KB default, file-summary, file-list).\n- In: implement remediation issue creation with dedup tags and severity-\u003epriority mapping; create human review issues for missing criteria/low confidence/timeouts/no commits; add epic blockers via `bd dep add`. Add unit tests covering diff scoping, spec parsing, large diff handling, remediation/human review and dedup.\n- In: add sequential epic verification lock (LockManager acquire epic_verify:\u003cepic_id\u003e) and ensure verification discovers eligible epics before closing (no direct bd epic close-eligible before verification); add unit tests asserting lock usage and ordering.\n- Out: no event sink integration; no orchestrator/CLI wiring.\n\nAcceptance Criteria:\n- EpicVerifier exposes verify_epic() and verify_and_close_eligible() returning EpicVerdict/EpicVerificationResult per spec.\n- Scoped diff includes only child-issue commits (by bd-\u003cid\u003e: prefix) and skips merge commits; no-child-commit case triggers human review.\n- Remediation issues follow required title/body/tags and deduplicate by epic_remediation:\u003cepic_id\u003e:\u003ccriterion_hash\u003e.\n- Epic verification acquires per-epic lock and does not close epics prior to verification.\n- Unit tests for core behaviors pass.\n\nTest Plan:\n- TDD: add failing unit tests first, implement minimal logic, then refactor.\n- `uv run pytest -m unit tests/test_epic_verifier.py`.\n\nNotes for Agent:\n- Use CommandRunner for git/bd subprocesses; stub in tests to avoid calling real git/bd.\n- Keep spec path regexes exactly as in docs/epic-verification-agent.md.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-30T05:17:31.863151386Z","created_by":"cyou","updated_at":"2025-12-30T06:00:01.394448856Z","closed_at":"2025-12-30T06:00:01.394448856Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-zfh.2","depends_on_id":"mala-zfh","type":"parent-child","created_at":"2025-12-30T05:17:31.863520055Z","created_by":"daemon"},{"issue_id":"mala-zfh.2","depends_on_id":"mala-zfh.1","type":"blocks","created_at":"2025-12-30T05:17:42.335294145Z","created_by":"daemon"}]}
{"id":"mala-zfh.3","title":"Emit epic verification events via event sink","description":"Context:\n- Verification flow should surface status via event sink so operators see pass/fail/human review/remediation.\n- Existing MalaEventSink/ConsoleEventSink need new hooks to log verification lifecycle.\n\nScope:\n- In: extend MalaEventSink/NullEventSink with epic verification lifecycle hooks (started, passed, failed, needs human review, remediation created) in src/event_sink.py.\n- In: wire EpicVerifier to emit these events during verify_and_close_eligible/verify_epic; update console sink logs to mirror spec examples.\n- In: add/adjust unit tests for event sink/console logging around new methods (prefer tests/test_event_sink.py to avoid overlap).\n- Out: no orchestrator/CLI wiring; no changes to verification decision logic.\n\nAcceptance Criteria:\n- New event sink methods exist on protocol and NullEventSink.\n- Console output includes verification start/pass/fail/human review messages.\n- EpicVerifier emits events at appropriate points (verified by tests).\n\nTest Plan:\n- TDD: write failing tests for new event hooks/log output, implement, refactor.\n- `uv run pytest -m unit tests/test_event_sink.py` (and any added EpicVerifier event tests).\n\nNotes for Agent:\n- Keep event sink methods synchronous and non-blocking.\n- Follow existing console logging style (icons/colors).","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-30T05:17:31.886521826Z","created_by":"cyou","updated_at":"2025-12-30T06:15:50.107903516Z","closed_at":"2025-12-30T06:15:50.107903516Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-zfh.3","depends_on_id":"mala-zfh","type":"parent-child","created_at":"2025-12-30T05:17:31.886859085Z","created_by":"daemon"},{"issue_id":"mala-zfh.3","depends_on_id":"mala-zfh.2","type":"blocks","created_at":"2025-12-30T05:17:47.37494295Z","created_by":"daemon"}]}
{"id":"mala-zfh.4","title":"Wire EpicVerifier into orchestrator + CLI","description":"Context:\n- Orchestrator currently auto-closes epics via BeadsClient without verification.\n- Spec requires epic verification before closure and a CLI override for explicit human bypass.\n- Config should allow max_diff_size_kb default 100.\n\nScope:\n- In: add --epic-override CLI flag (comma-separated IDs) and thread into orchestrator.\n- In: instantiate EpicVerifier in MalaOrchestrator and replace close_eligible_epics_async with verify_and_close_eligible(human_override_epic_ids=...); plumb max_diff_size_kb from config (default 100).\n- In: add integration tests for pass/fail/remediation creation and --epic-override behavior.\n- Out: no event sink changes; no EpicVerifier logic changes.\n\nAcceptance Criteria:\n- Orchestrator uses EpicVerifier for epic closure; BeadsClient close_eligible_epics_async no longer called in success path.\n- --epic-override bypasses verification for listed epics.\n- Integration tests pass.\n\nTest Plan:\n- TDD: add failing integration tests first, implement wiring, then refactor.\n- `uv run pytest -m integration -n auto -k epic_verification` (or targeted tests).\n\nNotes for Agent:\n- Keep backward compatibility for runs with no eligible epics; return EpicVerificationResult even when empty.\n- Ensure max_diff_size_kb defaults to 100 when not configured.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-30T05:17:31.909028247Z","created_by":"cyou","updated_at":"2025-12-30T06:22:14.662507456Z","closed_at":"2025-12-30T06:22:14.662507456Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-zfh.4","depends_on_id":"mala-zfh","type":"parent-child","created_at":"2025-12-30T05:17:31.909396487Z","created_by":"daemon"},{"issue_id":"mala-zfh.4","depends_on_id":"mala-zfh.2","type":"blocks","created_at":"2025-12-30T05:17:52.425928069Z","created_by":"daemon"}]}
{"id":"mala-zjn","title":"Test blocked without deps","status":"tombstone","priority":2,"issue_type":"task","created_at":"2025-12-26T00:53:15.4017375Z","updated_at":"2025-12-26T00:53:28.39468524Z","deleted_at":"2025-12-26T00:53:28.39468524Z","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"mala-zwf4","title":"[Review] src/orchestration/orchestrator.py:541-544: [P2] Re-raise CancelledError in remediation finalization","description":"## Review Finding\n\nThis issue was auto-created from a P2 review finding.\n\n**Source issue:** mala-mfnr\n**Reviewer:** codex\n**Location:** src/orchestration/orchestrator.py:541-544\n\n## Details\n\n`except Exception` also catches `asyncio.CancelledError`, so a cancellation (e.g. run abort/shutdown) during `_finalize_issue_result` will be swallowed and the loop will continue, marking the issue completed instead of propagating the cancel. This can delay or prevent graceful shutdown. Handle `CancelledError` explicitly and re-raise before the generic handler.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T02:17:45.118010613Z","created_by":"cyou","updated_at":"2026-01-02T02:21:24.129925958Z","closed_at":"2026-01-02T02:21:24.129925958Z","close_reason":"Closed","labels":["auto_generated","review_finding","review_finding:2898b81f211d","source:mala-mfnr"]}
{"id":"mala-zx5","title":"Add --only flag for specifying beads issues by ID","description":"Add a command-line flag (--only) that accepts a comma-separated list of beads issue IDs. When provided, workers will only process those specific issues instead of picking from all ready issues.\n\nExample usage:\n  mala --only bd-abc123,bd-def456\n\nAcceptance criteria:\n- Add --only flag to CLI argument parsing\n- Parse comma-separated issue IDs\n- Filter get_ready() results to only include specified IDs\n- Validate that specified IDs exist and are ready\n- Update documentation/help text","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T00:40:19.287843127Z","updated_at":"2025-12-26T00:53:27.149701137Z","closed_at":"2025-12-26T00:53:27.149701137Z","close_reason":"Closed"}
