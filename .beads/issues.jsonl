{"id":"mala-01s","title":"Refactor: consolidate lock config + env in one place","description":"Goal: Centralize LOCK_DIR and SCRIPTS_DIR configuration (currently defined in multiple modules). Allow override via env/config where appropriate.\\n\\nScope/files: src/tools/env.py, src/tools/locking.py, any imports that need adjustment.\\n\\nNotes:\\n- Consider single source of truth in tools/env.py.\\n- Keep behavior unchanged unless explicit override is set.\\n\\nAcceptance criteria:\\n- No duplicate definitions for LOCK_DIR/SCRIPTS_DIR.\\n- Locking and scripts continue to work.\\n- Minimal, well-contained changes.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-25T21:40:20.871689769Z","updated_at":"2025-12-26T00:08:19.981435611Z","closed_at":"2025-12-26T00:08:19.981435611Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-01s","depends_on_id":"mala-kpf","type":"blocks","created_at":"2025-12-25T21:47:40.701482404Z","created_by":"daemon"}]}
{"id":"mala-1by","title":"Refactor: extract console logging helpers","description":"## Context\nConsole logging helpers (`Colors`, `log`, `log_tool`, `log_result`) live in `src/main.py`. They should move to `src/logging/console.py` to reduce CLI/orchestrator coupling.\n\n## Scope\nCreate the new module only. Do **not** modify `src/main.py` in this issue; integration will wire it up later.\n\n### Files\n- Add: `src/logging/console.py`\n\n## Requirements\n- Move `Colors`, `log`, `log_tool`, and `log_result` into `src/logging/console.py`.\n- Behavior and output formatting must remain identical.\n\n## Acceptance Criteria\n- `src/logging/console.py` contains the logging helpers with identical behavior.\n- No other files are modified in this issue.\n\n## Notes\n- Integration issue will update imports in `src/main.py` and any other modules.\n- Keep ASCII-only files.\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T19:54:51.142161242Z","updated_at":"2025-12-25T20:09:18.911369058Z","closed_at":"2025-12-25T20:09:18.911369058Z","close_reason":"Closed"}
{"id":"mala-1l2","title":"Make morphllm optional","status":"blocked","priority":2,"issue_type":"epic","created_at":"2025-12-26T00:55:42.42123181Z","updated_at":"2025-12-26T00:55:50.96657054Z"}
{"id":"mala-20u","title":"Harden PreToolUse hook: robust tool-name matching + tests","description":"Problem: block_dangerous_commands in src/cli.py only checks tool_name == 'Bash'. If SDK uses 'bash' or other names, the safety hook is bypassed.\\n\\nScope/files: src/cli.py, tests (new or existing).\\n\\nWork:\\n- Confirm/assume tool names may vary; make matching robust (case-insensitive set, or accept multiple known names).\\n- Add unit tests for block_dangerous_commands covering allowed/blocked and tool name variations.\\n\\nAcceptance criteria:\\n- Hook blocks dangerous patterns regardless of tool name casing.\\n- Tests cover at least 1 allowed and 1 blocked command for multiple tool names.\\n\\nTDD: Write tests first, then update implementation.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-25T21:38:16.919383816Z","updated_at":"2025-12-25T23:59:03.895437001Z","closed_at":"2025-12-25T23:59:03.895437001Z","close_reason":"Closed"}
{"id":"mala-2ez","title":"Agent mail using filesystem","status":"blocked","priority":2,"issue_type":"epic","created_at":"2025-12-26T00:55:42.268473542Z","updated_at":"2025-12-26T00:55:50.944125866Z"}
{"id":"mala-3m7","title":"Deadlock detection between agents","status":"blocked","priority":2,"issue_type":"epic","created_at":"2025-12-26T00:55:42.798438926Z","updated_at":"2025-12-26T00:55:51.019136623Z"}
{"id":"mala-3z2","title":"Test: tiny edit","status":"tombstone","priority":2,"issue_type":"task","created_at":"2025-12-25T19:08:44.86959643Z","updated_at":"2025-12-25T19:12:41.579812812Z","deleted_at":"2025-12-25T19:12:41.579812812Z","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"mala-46q","title":"Add orchestrator unit tests (mock bd + SDK)","description":"Problem: Tests focus on lock scripts/SDK integration, but MalaOrchestrator control flow is untested (bd ready/claim/reset, timeout handling, exit code semantics).\\n\\nScope/files: tests/ (new test module), can mock subprocess.run and ClaudeSDKClient to avoid network. Avoid modifying src/cli.py unless absolutely required; if refactor is needed, document why.\\n\\nSuggested tests:\\n- get_ready_issues handles bd JSON and errors.\\n- claim_issue/reset_issue invoked appropriately.\\n- run() handles no ready issues and stops cleanly.\\n- On failed task, resets issue status.\\n\\nAcceptance criteria:\\n- Tests run without network and without actual bd CLI.\\n- Minimal mocking surface; focus on orchestrator state transitions.\\n\\nTDD: Write tests first, then adjust code if needed.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T21:38:34.899307031Z","updated_at":"2025-12-25T23:59:05.389010652Z","closed_at":"2025-12-25T23:59:05.389010652Z","close_reason":"Closed"}
{"id":"mala-4ls","title":"Lock key: hash canonical paths + repo namespace","description":"Problem: Lock filenames are derived by replacing '/' with '_' (scripts + src/tools/locking.py). This causes collisions (e.g., 'a/b' vs 'a_b') and cross-repo contention. Fix by hashing a canonical path (absolute or repo-root+relative) and namespacing locks per repo/cwd.\\n\\nScope/files: scripts/lock-try.sh, lock-check.sh, lock-holder.sh, lock-release.sh, lock-release-all.sh, src/tools/locking.py, tests in tests/test_lock_scripts.py and tests/test_lock_integration.py (and any necessary updates). Consider also centralizing LOCK_DIR/SCRIPTS_DIR if needed.\\n\\nAcceptance criteria:\\n- Lock key is collision-resistant (e.g., sha256 of canonical path).\\n- Locks for different repos/paths do not collide.\\n- Lock holder and cleanup continue to work with AGENT_ID.\\n- Tests updated/added to cover collision case and repo namespace case.\\n\\nTDD: Add/adjust tests first to demonstrate collision and then pass after change.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-25T21:37:59.249680035Z","updated_at":"2025-12-26T00:01:08.029869568Z","closed_at":"2025-12-26T00:01:08.029869568Z","close_reason":"Closed"}
{"id":"mala-4o4","title":"Commit partial progress and mark needs-continuation","status":"tombstone","priority":2,"issue_type":"epic","created_at":"2025-12-26T00:55:42.724613481Z","updated_at":"2025-12-26T00:56:32.195455786Z","deleted_at":"2025-12-26T00:56:32.195455786Z","deleted_by":"daemon","delete_reason":"delete","original_type":"epic"}
{"id":"mala-4ov","title":"Metrics and logging for multi-agent sessions","status":"blocked","priority":2,"issue_type":"epic","created_at":"2025-12-26T00:55:42.866840213Z","updated_at":"2025-12-26T00:55:51.029273122Z"}
{"id":"mala-59n","title":"Fix log indentation and add no-truncation option","description":"## Problem\nLog output has inconsistent indentation and lines are truncated:\n```\n00:43:23 ◌ Waiting for 1 agent(s)...\n  [mala-l7r] ⚙ Bash {'command': 'bd show mala-l7r', 'description': 'Vi\n    [mala-l7r] Now let me understand the codebase structure...\n  [mala-l7r] ⚙ Bash {'command': 'ls -la /home/cyou/mala/src/', 'descri\n```\n\nIssues:\n1. **Inconsistent indentation**: Some lines have 2-space indent, others have 4-space indent before `[agent-id]`\n2. **Truncation**: Lines are cut off (e.g., `'Vi`, `'descri`) without option to see full content\n\n## Scope/files\n- `src/logging/console.py` or equivalent logging module\n- `src/cli.py` or `src/orchestrator.py` for CLI flag\n\n## Work\n1. Fix indentation to be consistent (likely all agent output should have same base indent)\n2. Add `--no-truncate` or `--verbose` CLI flag to disable line truncation\n3. Consider making truncation width configurable\n\n## Acceptance criteria\n- All agent log lines have consistent indentation\n- New flag allows viewing full log lines without truncation\n- Default behavior (truncated) still works","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T00:47:13.094441264Z","updated_at":"2025-12-26T00:57:22.727412832Z","closed_at":"2025-12-26T00:57:22.727412832Z","close_reason":"Closed"}
{"id":"mala-5aa","title":"Refactor: consolidate locking into tools/locking.py","description":"## Context\nLocking behavior is split between `src/filelock.py` and shell scripts in `scripts/`. `src/main.py` directly imports `LOCK_DIR` and `release_all_locks` from `filelock.py` and also defines `make_stop_hook` which relies on lock scripts. The plan is to consolidate locking into `src/tools/locking.py`.\n\n## Scope\nCreate `src/tools/locking.py` only. Do **not** modify `src/main.py` or tests in this issue; integration will wire it up later.\n\n### Files\n- Add: `src/tools/locking.py`\n- (Optional) Modify or remove: `src/filelock.py`\n\n## Requirements\n- `tools/locking.py` should export:\n  - `LOCK_DIR`\n  - `release_all_locks()` (existing behavior)\n  - `cleanup_agent_locks(agent_id)` (existing behavior from `MalaOrchestrator`)\n  - `make_stop_hook(agent_id)` (existing behavior)\n- Decide one:\n  - Keep `src/filelock.py` as a thin re-export for backward compatibility, OR\n  - Remove `src/filelock.py` and update all imports (handled later in integration).\n\n## TDD Guidance\n- If you touch tests in this issue, stop and defer them to integration (tests should be updated there).\n\n## Acceptance Criteria\n- `src/tools/locking.py` exists with the required exports.\n- No other files are modified in this issue (except optional `src/filelock.py`).\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T19:54:51.176735691Z","updated_at":"2025-12-25T20:10:14.682614354Z","closed_at":"2025-12-25T20:10:14.682614354Z","close_reason":"Closed"}
{"id":"mala-6iv","title":"Test: add hello comment to pyproject.toml","status":"tombstone","priority":2,"issue_type":"task","created_at":"2025-12-25T19:03:17.354821017Z","updated_at":"2025-12-25T19:05:18.077405908Z","close_reason":"Closed","deleted_at":"2025-12-25T19:05:18.077405908Z","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"mala-784","title":"Ideas: Future improvements","description":"Brainstorm ideas needing grooming:\n- Add back claude orchestrator, manually managing context\n- Agent mail using filesystem?\n- Use codex for code review?\n- Make morphllm optional","status":"tombstone","priority":2,"issue_type":"epic","created_at":"2025-12-26T00:54:39.176848025Z","updated_at":"2025-12-26T00:55:27.983470092Z","deleted_at":"2025-12-26T00:55:27.983470092Z","deleted_by":"daemon","delete_reason":"delete","original_type":"epic"}
{"id":"mala-9ki","title":"Refactor: add tools/env.py and centralize env loading","description":"## Context\n`src/main.py` currently defines `USER_CONFIG_DIR`, `JSONL_LOG_DIR`, `SCRIPTS_DIR`, and performs dotenv loading at import time. This creates side effects and makes reuse/testing harder. The architecture plan calls for a small `tools/env.py` module that owns config paths and env loading, while preserving the **early** load needed for Braintrust setup.\n\n## Scope\nCreate a new module `src/tools/env.py` only. Do **not** modify `src/main.py` in this issue; integration will wire it up later.\n\n### Files\n- Add: `src/tools/env.py`\n\n## Requirements\n- `tools/env.py` should define:\n  - `USER_CONFIG_DIR = Path.home() / \".config\" / \"mala\"`\n  - `JSONL_LOG_DIR = USER_CONFIG_DIR / \"logs\"`\n  - `SCRIPTS_DIR` that points to repo `scripts/` (from `src/tools/env.py`, use `Path(__file__).resolve().parents[2] / \"scripts\"` or equivalent)\n- Provide two helpers:\n  - `load_user_env()` that loads `${USER_CONFIG_DIR}/.env` only (for early Braintrust setup)\n  - `load_env(repo_path: Path | None)` that calls `load_user_env()` and then (if `repo_path` is provided) loads `\u003crepo_path\u003e/.env` with `override=True`\n\n## Acceptance Criteria\n- `src/tools/env.py` exists with the above constants and functions.\n- No other files are modified in this issue.\n\n## Notes\n- Integration issue will wire these into `src/main.py`.\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T19:54:51.122065094Z","updated_at":"2025-12-25T20:08:26.994504903Z","closed_at":"2025-12-25T20:08:26.994504903Z","close_reason":"Closed"}
{"id":"mala-9qr","title":"Refactor: extract hook logic from src/cli.py","description":"Goal: Make hook logic self-contained by moving block_dangerous_commands (and related constants) into a new module (e.g., src/hooks.py).\\n\\nScope/files: src/cli.py, new src/hooks.py.\\n\\nWork:\\n- Move DANGEROUS_PATTERNS + block_dangerous_commands to new module.\\n- Update imports in cli.py.\\n- Keep behavior unchanged.\\n\\nAcceptance criteria:\\n- CLI behavior unchanged.\\n- Hook still used in ClaudeAgentOptions.hooks.\\n- Tests (if any) still pass.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-25T21:41:10.672408295Z","updated_at":"2025-12-26T00:06:41.954204714Z","closed_at":"2025-12-26T00:06:41.954204714Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-9qr","depends_on_id":"mala-akl","type":"blocks","created_at":"2025-12-25T21:47:25.567206045Z","created_by":"daemon"},{"issue_id":"mala-9qr","depends_on_id":"mala-c01","type":"parent-child","created_at":"2025-12-25T22:05:59.455394242Z","created_by":"daemon"}]}
{"id":"mala-akl","title":"mala run exit code: treat no-issue runs as success","description":"Problem: src/cli.py returns exit code 1 when success_count == 0. This makes no-op runs (no issues ready) look like failures in automation.\\n\\nScope/files: src/cli.py.\\n\\nWork:\\n- Distinguish 'no issues processed' from 'issues processed but failed'.\\n- Update exit code to 0 when there were no issues to process. Keep non-zero when actual failures occurred.\\n\\nAcceptance criteria:\\n- If no issues are ready, mala run exits 0.\\n- If issues ran and all failed, still exits non-zero.\\n- If some succeeded, exits 0.\\n\\nDependency: Avoid concurrent edits with mala-20u (same file).","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T21:38:26.013087673Z","updated_at":"2025-12-26T00:00:32.928066608Z","closed_at":"2025-12-26T00:00:32.928066608Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-akl","depends_on_id":"mala-20u","type":"blocks","created_at":"2025-12-25T21:38:51.94427495Z","created_by":"daemon"}]}
{"id":"mala-anh","title":"Refactor: split src/cli.py into focused modules","description":"Goal: Reduce the 600+ line cli module by extracting focused modules (e.g., orchestrator.py, hooks.py, prompt.py, git_utils.py). Keep external behavior unchanged.\\n\\nScope/files: src/cli.py plus new modules under src/.\\n\\nSuggested steps:\\n1) Identify pure helpers (git commit/branch, prompt loading, hook logic).\\n2) Move orchestration class to its own module.\\n3) Keep CLI wiring in cli.py, import helpers.\\n4) Update imports/tests.\\n\\nAcceptance criteria:\\n- CLI commands unchanged.\\n- No behavior changes to orchestrator loop.\\n- Tests pass (or at least no regressions).","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-25T21:40:15.520698126Z","updated_at":"2025-12-25T21:41:31.71957273Z","closed_at":"2025-12-25T21:41:31.71957273Z","close_reason":"Split into smaller refactor tasks: mala-9qr (hooks), mala-dqt (git helpers), mala-as5 (orchestrator extraction)."}
{"id":"mala-as5","title":"Refactor: move MalaOrchestrator to its own module","description":"Goal: Extract MalaOrchestrator class from src/cli.py into a dedicated module (e.g., src/orchestrator.py) to reduce file size and clarify responsibilities.\\n\\nScope/files: src/cli.py, new src/orchestrator.py.\\n\\nWork:\\n- Move IssueResult + MalaOrchestrator to new module.\\n- Adjust imports in cli.py.\\n- Keep CLI command signatures and behavior unchanged.\\n\\nAcceptance criteria:\\n- Orchestrator behavior unchanged.\\n- CLI still works.\\n- Tests (if any) still pass.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-25T21:41:26.002972067Z","updated_at":"2025-12-26T00:15:52.939703847Z","closed_at":"2025-12-26T00:15:52.939703847Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-as5","depends_on_id":"mala-dqt","type":"blocks","created_at":"2025-12-25T21:47:35.258531693Z","created_by":"daemon"},{"issue_id":"mala-as5","depends_on_id":"mala-c01","type":"parent-child","created_at":"2025-12-25T22:05:59.484296839Z","created_by":"daemon"}]}
{"id":"mala-b0m","title":"Graceful shutdown with agent wrap-up","status":"blocked","priority":2,"issue_type":"epic","created_at":"2025-12-26T00:55:42.940976936Z","updated_at":"2025-12-26T00:55:51.03948493Z"}
{"id":"mala-bgl","title":"Save progress state on context exhaustion","status":"tombstone","priority":2,"issue_type":"epic","created_at":"2025-12-26T00:55:42.565812819Z","updated_at":"2025-12-26T00:56:32.19480344Z","deleted_at":"2025-12-26T00:56:32.19480344Z","deleted_by":"daemon","delete_reason":"delete","original_type":"epic"}
{"id":"mala-bvd","title":"Other Improvements","description":"General improvements:\n- Deadlock detection (two agents waiting on each other)\n- Metrics/logging for multi-agent sessions\n- Graceful shutdown (signal all agents to wrap up)","status":"tombstone","priority":2,"issue_type":"epic","created_at":"2025-12-26T00:54:39.298081197Z","updated_at":"2025-12-26T00:55:27.989133028Z","deleted_at":"2025-12-26T00:55:27.989133028Z","deleted_by":"daemon","delete_reason":"delete","original_type":"epic"}
{"id":"mala-c01","title":"Epic: CLI module refactor (split cli.py)","description":"Parent epic for refactoring src/cli.py into focused modules without changing behavior. Children: hook extraction, git helper extraction, orchestrator extraction.","status":"closed","priority":3,"issue_type":"epic","created_at":"2025-12-25T21:41:59.788032839Z","updated_at":"2025-12-26T00:15:59.835213834Z","closed_at":"2025-12-26T00:15:59.835213834Z","close_reason":"All children completed"}
{"id":"mala-c01.1","title":"Refactor: extract beads client from cli.py","description":"Goal: Extract beads-related logic from MalaOrchestrator into a dedicated BeadsClient class (e.g., src/beads_client.py) that wraps bd CLI calls.\n\nScope/files: src/cli.py, new src/beads_client.py.\n\nWork:\n- Create BeadsClient class with methods: get_ready_issues(), claim_issue(), reset_issue(), commit_issues(), close_eligible_epics().\n- Move bd CLI subprocess calls from MalaOrchestrator to BeadsClient.\n- Have MalaOrchestrator use BeadsClient instance.\n- Keep CLI behavior unchanged.\n\nAcceptance criteria:\n- All bd CLI calls go through BeadsClient.\n- MalaOrchestrator behavior unchanged.\n- CLI still works.\n- Tests (if any) still pass.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-25T22:15:22.761330846Z","updated_at":"2025-12-26T00:09:17.45761968Z","closed_at":"2025-12-26T00:09:17.45761968Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-c01.1","depends_on_id":"mala-c01","type":"parent-child","created_at":"2025-12-25T22:15:22.771293472Z","created_by":"daemon"}]}
{"id":"mala-cdw","title":"Context Exhaustion Handling","description":"When agents run out of context mid-implementation:\n- Detect context exhaustion (agent returns incomplete)\n- Save progress state (files modified, locks held)\n- Spawn continuation agent with summary of prior work\n- Or: commit partial progress, mark issue as needs-continuation","status":"tombstone","priority":2,"issue_type":"epic","created_at":"2025-12-26T00:54:39.236980254Z","updated_at":"2025-12-26T00:55:27.98871018Z","deleted_at":"2025-12-26T00:55:27.98871018Z","deleted_by":"daemon","delete_reason":"delete","original_type":"epic"}
{"id":"mala-d6x","title":"Context exhaustion handling","status":"blocked","priority":2,"issue_type":"epic","created_at":"2025-12-26T00:56:35.644475789Z","updated_at":"2025-12-26T00:56:39.062877661Z"}
{"id":"mala-dqt","title":"Refactor: extract git helper functions","description":"Goal: Move git helper(s) from src/cli.py (e.g., get_git_commit) into a small utility module (e.g., src/git_utils.py).\\n\\nScope/files: src/cli.py, new src/git_utils.py.\\n\\nWork:\\n- Move get_git_commit (and any related helpers if needed).\\n- Update imports in cli.py.\\n- Keep behavior unchanged.\\n\\nAcceptance criteria:\\n- Same git commit info used in metadata.\\n- No behavior changes to CLI.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-25T21:41:18.022578128Z","updated_at":"2025-12-26T00:11:10.071338973Z","closed_at":"2025-12-26T00:11:10.071338973Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-dqt","depends_on_id":"mala-9qr","type":"blocks","created_at":"2025-12-25T21:47:31.302567088Z","created_by":"daemon"},{"issue_id":"mala-dqt","depends_on_id":"mala-c01","type":"parent-child","created_at":"2025-12-25T22:05:59.473063215Z","created_by":"daemon"}]}
{"id":"mala-f69","title":"Default to unlimited concurrent agents","description":"Goal: Change the default for --max-agents/-n to unlimited (no cap on concurrent agents).\n\nCurrent behavior: max_agents defaults to 3, limiting concurrent agent execution.\n\nDesired behavior: By default, spawn as many agents as there are ready issues. Users can still use --max-agents to set a limit if needed.\n\nScope/files: src/cli.py, src/orchestrator.py.\n\nWork:\n- Change max_agents default from 3 to None (unlimited).\n- Update orchestrator logic to handle None as 'spawn all ready issues'.\n- Update help text to reflect new default.\n\nAcceptance criteria:\n- 'mala run' with no flags spawns agents for all ready issues.\n- 'mala run --max-agents 3' limits to 3 concurrent agents.\n- Logging/status output reflects unlimited when no cap set.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T00:18:53.28766291Z","updated_at":"2025-12-26T00:50:20.634125479Z","closed_at":"2025-12-26T00:50:20.634125479Z","close_reason":"Closed"}
{"id":"mala-fih","title":"Claude orchestrator with manual context management","status":"blocked","priority":2,"issue_type":"epic","created_at":"2025-12-26T00:55:42.188094716Z","updated_at":"2025-12-26T00:55:50.927636805Z"}
{"id":"mala-ggx","title":"Spawn continuation agent with prior work summary","status":"tombstone","priority":2,"issue_type":"epic","created_at":"2025-12-26T00:55:42.639177056Z","updated_at":"2025-12-26T00:56:32.195175308Z","deleted_at":"2025-12-26T00:56:32.195175308Z","deleted_by":"daemon","delete_reason":"delete","original_type":"epic"}
{"id":"mala-ih0","title":"Use codex for code review","status":"blocked","priority":2,"issue_type":"epic","created_at":"2025-12-26T00:55:42.345522647Z","updated_at":"2025-12-26T00:55:50.955654696Z"}
{"id":"mala-kpf","title":"Clean up file_lock shim / align lock owner format","description":"Problem: src/tools/locking.py:file_lock writes PID into lock files and src/filelock.py re-exports it, but the rest of the system uses AGENT_ID in lock files. file_lock is unused and inconsistent.\\n\\nScope/files: src/tools/locking.py, src/filelock.py (and possibly tests).\\n\\nOptions:\\n- Remove file_lock and filelock.py entirely, or\\n- Rework file_lock to use the same AGENT_ID scheme and lock keying as the scripts.\\n\\nAcceptance criteria:\\n- No dead/unused locking API left behind.\\n- If kept, file_lock uses the same lock format + keying as scripts.\\n- Tests updated if necessary.\\n\\nDependency: Must wait for lock-key hashing change (mala-4ls) because both edit src/tools/locking.py.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T21:38:08.362262314Z","updated_at":"2025-12-26T00:04:34.226695444Z","closed_at":"2025-12-26T00:04:34.226695444Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-kpf","depends_on_id":"mala-4ls","type":"blocks","created_at":"2025-12-25T21:38:46.924557872Z","created_by":"daemon"}]}
{"id":"mala-kz4","title":"Detect context exhaustion","status":"tombstone","priority":2,"issue_type":"epic","created_at":"2025-12-26T00:55:42.494971406Z","updated_at":"2025-12-26T00:56:32.189479702Z","deleted_at":"2025-12-26T00:56:32.189479702Z","deleted_by":"daemon","delete_reason":"delete","original_type":"epic"}
{"id":"mala-l7r","title":"Support epic filter for getting ready tasks","description":"Goal: Allow specifying a beads epic ID to filter ready tasks, so only tasks that are children of that epic are returned.\n\nScope/files: src/beads_client.py, src/cli.py (or src/orchestrator.py if it exists).\n\nWork:\n- Add optional epic_id parameter to BeadsClient.get_ready() method.\n- Filter returned issues to only include those with a parent-child dependency on the specified epic.\n- Add --epic CLI option to 'mala run' command to pass epic filter.\n- Update orchestrator to pass epic filter to BeadsClient.\n\nAcceptance criteria:\n- 'mala run --epic mala-c01' only processes tasks that are children of epic mala-c01.\n- Without --epic flag, behavior unchanged (all ready tasks).\n- Epic itself is still excluded from ready tasks (existing behavior).\n- Tests cover epic filter logic.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T00:17:16.892104528Z","updated_at":"2025-12-26T00:48:18.823402862Z","closed_at":"2025-12-26T00:48:18.823402862Z","close_reason":"Closed"}
{"id":"mala-lm0","title":"Refactor: extract JSONLLogger","description":"## Context\n`JSONLLogger` currently lives in `src/main.py`. It should be moved into `src/logging/jsonl.py` to isolate logging and reduce `main.py` surface area.\n\n## Scope\nCreate the new module only. Do **not** modify `src/main.py` in this issue; integration will wire it up later.\n\n### Files\n- Add: `src/logging/jsonl.py`\n\n## Requirements\n- `JSONLLogger` behavior must remain unchanged (file path, JSONL structure, timestamps, flush behavior).\n- Use the same `JSONL_LOG_DIR` constant from `src/tools/env.py` (so this issue depends on the env module existing).\n\n## Acceptance Criteria\n- `src/logging/jsonl.py` exists and matches current JSONLLogger behavior.\n- No other files are modified in this issue.\n\n## Notes\n- Integration issue will update imports in `src/main.py`.\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T19:54:51.153849001Z","updated_at":"2025-12-25T20:11:41.797668608Z","closed_at":"2025-12-25T20:11:41.797668608Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-lm0","depends_on_id":"mala-9ki","type":"blocks","created_at":"2025-12-25T20:06:47.457341927Z","created_by":"daemon"}]}
{"id":"mala-lvw","title":"Single-threaded mode without locking","status":"blocked","priority":2,"issue_type":"epic","created_at":"2025-12-26T00:57:29.777283988Z","updated_at":"2025-12-26T00:57:33.554106261Z"}
{"id":"mala-mj8","title":"Docs: update README + Braintrust docstring to match implementation","description":"Problem: README says lock mechanism uses atomic mkdir, but scripts use hardlink+tempfile; braintrust_integration.py docstring says setup is in main.py, but it is in cli.py.\\n\\nScope/files: README.md, src/braintrust_integration.py.\\n\\nWork:\\n- Update README to reflect actual lock mechanism and current braintrust setup location.\\n- Update braintrust_integration.py docstring to refer to cli.py (or central location if changed).\\n\\nAcceptance criteria:\\n- Docs match current behavior.\\n- No functional code changes.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-25T21:38:42.843621671Z","updated_at":"2025-12-26T00:00:38.778018843Z","closed_at":"2025-12-26T00:00:38.778018843Z","close_reason":"Closed"}
{"id":"mala-o17","title":"Test issue: add a comment to README.md","status":"tombstone","priority":2,"issue_type":"task","created_at":"2025-12-25T18:49:43.062524854Z","updated_at":"2025-12-25T18:53:44.873613587Z","close_reason":"Closed","deleted_at":"2025-12-25T18:53:44.873613587Z","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"mala-o3z","title":"Test braintrust tracing","description":"Add a comment to the README TODOs section noting that Braintrust LLM tracing is now implemented","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T19:22:15.933197275Z","updated_at":"2025-12-25T19:23:21.922382429Z","closed_at":"2025-12-25T19:23:21.922382429Z","close_reason":"Closed"}
{"id":"mala-rsq","title":"Refactor: split CLI into cli.py and make main.py a shim","description":"## Context\nWe will parallelize by creating new modules in separate issues, then do a single integration pass to wire everything together. This issue is the integration/wiring step.\n\n## Scope\nWire all refactor modules into the app, update tests, and make `src/main.py` a true shim. This is the **only** issue that should edit `src/main.py` and tests.\n\n### Files\n- Add: `src/cli.py`\n- Modify: `src/main.py`\n- Modify: `tests/test_lock_integration.py`\n- Modify: `tests/test_lock_sdk_integration.py`\n- Modify: any files needed to update imports/paths after the prompt move\n\n## Requirements\n- Create `src/cli.py` with the Typer app + commands currently defined in `src/main.py`.\n- Move CLI-adjacent logic out of `src/main.py` so it becomes a tiny shim that only exposes `app`.\n- Update imports to use the new modules:\n  - `src/tools/env.py`\n  - `src/logging/console.py`\n  - `src/logging/jsonl.py`\n  - `src/agent_loop.py`\n  - `src/tools/locking.py`\n- Update prompt loading to the new path: `src/prompts/implementer_prompt.md`.\n- Update tests to import from new module paths (locking + prompt template).\n- Keep `pyproject.toml` entrypoint as `src.main:app`.\n\n## TDD Guidance\n- Update tests first (imports/paths), run relevant tests:\n  - `tests/test_lock_integration.py`\n  - `tests/test_lock_sdk_integration.py`\n  - `tests/test_lock_scripts.py`\n- Then implement wiring changes and re-run the tests.\n\n## Acceptance Criteria\n- `src/main.py` is a thin shim (import + expose `app`).\n- CLI behavior is unchanged (`mala --help` identical).\n- Prompt loads from the new location.\n- Locking + prompt tests pass with updated imports.\n- All refactor modules are used by the CLI/orchestrator.\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T19:54:51.18845258Z","updated_at":"2025-12-25T20:24:59.79953084Z","closed_at":"2025-12-25T20:24:59.79953084Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-rsq","depends_on_id":"mala-9ki","type":"blocks","created_at":"2025-12-25T20:06:47.478081301Z","created_by":"daemon"},{"issue_id":"mala-rsq","depends_on_id":"mala-1by","type":"blocks","created_at":"2025-12-25T20:06:47.48915539Z","created_by":"daemon"},{"issue_id":"mala-rsq","depends_on_id":"mala-lm0","type":"blocks","created_at":"2025-12-25T20:06:47.499510627Z","created_by":"daemon"},{"issue_id":"mala-rsq","depends_on_id":"mala-wd1","type":"blocks","created_at":"2025-12-25T20:06:47.510195051Z","created_by":"daemon"},{"issue_id":"mala-rsq","depends_on_id":"mala-5aa","type":"blocks","created_at":"2025-12-25T20:06:47.520878684Z","created_by":"daemon"},{"issue_id":"mala-rsq","depends_on_id":"mala-vrm","type":"blocks","created_at":"2025-12-25T20:06:47.530900735Z","created_by":"daemon"}]}
{"id":"mala-u1w","title":"Test: tiny README change","status":"tombstone","priority":2,"issue_type":"task","created_at":"2025-12-25T19:05:18.089001881Z","updated_at":"2025-12-25T19:08:44.858511785Z","close_reason":"Closed","deleted_at":"2025-12-25T19:08:44.858511785Z","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"mala-vrm","title":"Refactor: move implementer prompt to src/prompts/","description":"## Context\nThe implementer prompt lives at `src/implementer_prompt.md`. The proposed structure puts prompts under `src/prompts/`.\n\n## Scope\nMove the prompt file only. Do **not** update loaders or tests in this issue; integration will wire it up later.\n\n### Files\n- Move: `src/implementer_prompt.md` → `src/prompts/implementer_prompt.md`\n\n## Requirements\n- Prompt content must be unchanged after move.\n\n## Acceptance Criteria\n- File exists at `src/prompts/implementer_prompt.md` with identical content.\n- No other files are modified in this issue.\n\n## Notes\n- Integration issue will update imports/tests referencing `IMPLEMENTER_PROMPT_TEMPLATE`.\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T19:54:51.200086139Z","updated_at":"2025-12-25T20:08:18.586126987Z","closed_at":"2025-12-25T20:08:18.586126987Z","close_reason":"Closed"}
{"id":"mala-wd1","title":"Refactor: extract Claude SDK subagent loop","description":"## Context\nThe Claude SDK receive loop is currently embedded in `MalaOrchestrator.run_implementer` in `src/main.py`. It should be extracted to a reusable `src/agent_loop.py` module.\n\n## Scope\nCreate `src/agent_loop.py` only. Do **not** modify `src/main.py` in this issue; integration will wire it up later.\n\n### Files\n- Add: `src/agent_loop.py`\n\n## Requirements\n- The extracted loop should be the same logic as today:\n  - `async with ClaudeSDKClient(options=options) as client:`\n  - `await client.query(prompt)`\n  - `async for message in client.receive_response(): ...`\n- It must still:\n  - Handle `AssistantMessage` / `ResultMessage` logging exactly as today.\n  - Support JSONL logging and Braintrust logging (existing behavior).\n- Return the final result text and any needed success/summary data in a way `run_implementer` can use.\n\n## Acceptance Criteria\n- `src/agent_loop.py` exists with the extracted loop behavior.\n- No other files are modified in this issue.\n\n## Notes\n- Integration issue will delegate to this module from `src/main.py`.\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T19:54:51.165716848Z","updated_at":"2025-12-25T20:11:59.449563429Z","closed_at":"2025-12-25T20:11:59.449563429Z","close_reason":"Closed","dependencies":[{"issue_id":"mala-wd1","depends_on_id":"mala-1by","type":"blocks","created_at":"2025-12-25T20:06:47.467342748Z","created_by":"daemon"}]}
{"id":"mala-zjn","title":"Test blocked without deps","status":"tombstone","priority":2,"issue_type":"task","created_at":"2025-12-26T00:53:15.4017375Z","updated_at":"2025-12-26T00:53:28.39468524Z","deleted_at":"2025-12-26T00:53:28.39468524Z","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"mala-zx5","title":"Add --only flag for specifying beads issues by ID","description":"Add a command-line flag (--only) that accepts a comma-separated list of beads issue IDs. When provided, workers will only process those specific issues instead of picking from all ready issues.\n\nExample usage:\n  mala --only bd-abc123,bd-def456\n\nAcceptance criteria:\n- Add --only flag to CLI argument parsing\n- Parse comma-separated issue IDs\n- Filter get_ready() results to only include specified IDs\n- Validate that specified IDs exist and are ready\n- Update documentation/help text","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T00:40:19.287843127Z","updated_at":"2025-12-26T00:53:27.149701137Z","closed_at":"2025-12-26T00:53:27.149701137Z","close_reason":"Closed"}
